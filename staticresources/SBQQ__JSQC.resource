"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck2(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a;}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r);},p,p.exports,r,e,n,t);}return n[i].exports;}for(var u="function"==typeof require&&require,i=0;i<t.length;i++){o(t[i]);}return o;}return r;})()({1:[function(require,module,exports){module.exports.toApexDate=toApexDate;module.exports.toApexDateTime=toApexDateTime;module.exports.toUTCDateString=toUTCDateString;module.exports.monthsBetween=monthsBetween;module.exports.monthsBetweenRoundPartialUp=monthsBetweenRoundPartialUp;module.exports.daysBetween=daysBetween;module.exports.daysBetweenIgnoringLeapYearDays=daysBetweenIgnoringLeapYearDays;module.exports.distinguishDateFromDateTime=distinguishDateFromDateTime;module.exports.addMonths=addMonths;module.exports.addDays=addDays;function toApexDate(date){var dateIso=date.toISOString();return dateIso.replace(new RegExp('[Tt].*'),"");}function toApexDateTime(dateTime){var dateIso=dateTime.toISOString();return dateIso.slice(0,dateIso.length-1)+"+0000";}function toUTCDateString(date){var timezone=date.getTimezoneOffset();return new Date(date.setMinutes(date.getMinutes()+parseInt(timezone))).toLocaleDateString();}function distinguishDateFromDateTime(dateString){var dateRegex=new RegExp('\\d{4}-\\d{2}-\\d{2}');var dateTimeRegex=new RegExp('\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}.\\d{3}(Z|(\\+\\d{4}))');if(dateRegex.test(dateString)&&dateString.length==10){return'date';}else if(dateTimeRegex.test(dateString)&&(dateString.length==24||dateString.length==28)){return'datetime';}return'none';}function monthsBetween(startDate,endDate){if(startDate>endDate){return-1*monthsBetween(endDate,startDate);}var result=0;result+=(endDate.getUTCFullYear()-startDate.getUTCFullYear())*12;result+=endDate.getUTCMonth()-startDate.getUTCMonth();return result;}function monthsBetweenRoundPartialUp(startDate,endDate){if(startDate>endDate){return-1*monthsBetweenRoundPartialUp(endDate,startDate);}var result=monthsBetween(startDate,endDate);var date=new Date(startDate.getTime());addMonths(date,result);if(date<endDate){result+=1;}return result;}function daysBetween(startDate,endDate){if(startDate>endDate){return-1*daysBetween(endDate,startDate);}var msDiff=endDate.getTime()-startDate.getTime();var dayInUnix=86400000;return Math.round(msDiff/dayInUnix);}function addMonths(startDate,numMonths){var currentMonth=startDate.getUTCMonth();startDate.setUTCMonth(startDate.getUTCMonth()+numMonths);var trueMonth=currentMonth+numMonths;trueMonth=trueMonth<0?trueMonth+12:trueMonth;if(startDate.getUTCMonth()!=trueMonth%12){startDate.setUTCDate(0);}return startDate;}function addDays(startDate,numDays){startDate.setUTCDate(startDate.getUTCDate()+numDays);return startDate;}function daysBetweenIgnoringLeapYearDays(startDate,endDate){var numLeapDays=0;var startYear=startDate.getUTCFullYear();var endYear=endDate.getUTCFullYear();for(var i=startYear,j=endYear;i<=j;i++){if(!isLeapYear(i))continue;var leapDay=new Date(i,1,29);if(startDate<leapDay&&endDate>leapDay){numLeapDays++;}}return daysBetween(startDate,endDate)-numLeapDays;}function isLeapYear(year){return!(year%4)&&year%100||!(year%400);}},{}],2:[function(require,module,exports){module.exports.setScale=setScale;function setScale(num,scale){var exp=Math.pow(10,scale);num*=exp;var res=Math.round(+num.toFixed(scale));res/=exp;return res;}},{}],3:[function(require,module,exports){var MetaDataUtils=require("./Utils/MetaDataUtils.js");var ModelUtils=require("./Utils/ModelUtils.js");var AccountModel=function(){function AccountModel(data,settings){_classCallCheck2(this,AccountModel);this.settings=settings;this.assetSummariesByProductId=data.summariesByProductId||{};this.subSummariesByProductId=data.subSummariesByProductId||{};}_createClass(AccountModel,[{key:"getAssetPriorQuantity",value:function getAssetPriorQuantity(ids,constraintField,quoteConstraintField,constraintValue){var summaries=getSummaries(ids,this.assetSummariesByProductId);return getPriorQuantityGeneric(summaries,"asset",constraintField,quoteConstraintField,constraintValue,this.settings);}},{key:"getSubscriptionPriorQuantity",value:function getSubscriptionPriorQuantity(ids,constraintField,quoteConstraintField,constraintValue){var summaries=getSummaries(ids,this.subSummariesByProductId);return getPriorQuantityGeneric(summaries,"subscription",constraintField,quoteConstraintField,constraintValue,this.settings);}}]);return AccountModel;}();function getSummaries(ids,sumMap){var summaries=[];ids.forEach(function(id){if(sumMap[id]!=null){summaries.push(sumMap[id]);}});return summaries;}function getPriorQuantityGeneric(summaries,summaryType,constraintField,quoteConstraintField,constraintValue,settings){var priorQuantity=0;var summaryConstraintField=MetaDataUtils.getField(summaryType,constraintField,settings.devPrefix);summaries.forEach(function(summary){priorQuantity+=calculatePriorQuantity(summary,constraintField,quoteConstraintField,summaryConstraintField,constraintValue);});return priorQuantity;}function calculatePriorQuantity(summary,constraintField,quoteConstraintField,summaryConstraintField,constraintValue){if(constraintField!=null&&quoteConstraintField!=null&&summaryConstraintField!=null){var constraintQuantity=getConstraintQuantity(summary,constraintField,constraintValue);return constraintQuantity||0;}else{return summary.quantity;}}function getConstraintQuantity(summary,field,value){var cs=summary.constraintMap[field];if(cs==null){return null;}else{return cs.quantityMap[value];}}module.exports=AccountModel;},{"./Utils/MetaDataUtils.js":33,"./Utils/ModelUtils.js":34}],4:[function(require,module,exports){var QuoteHandler=require('../QuoteHandler.js');var QuoteSummarizer=require('../QuoteSummarizer.js');var SettingsModel=require('../SettingsModel.js');var ApexUtils=require('../Utils/ApexUtils.js');var QuoteModel=require('../QuoteModel2.js');var counter;var QuoteDAO=function(){function QuoteDAO(prefix,connection,settings){_classCallCheck2(this,QuoteDAO);this.prefix=prefix;this.conn=connection;this.apex=ApexUtils(connection);this.apex.setOptions({escape:false,buffer:false,timeout:120000});this.settings=settings;}_createClass(QuoteDAO,[{key:"loadQuote",value:function loadQuote(quoteId){var initialLoadPromise=this.fragmentLoad(quoteId);var getQuoteLineIdsPromise=this.buildQuoteLineIdsPromise(quoteId);var promiseArray=[];promiseArray.push(initialLoadPromise);promiseArray.push(getQuoteLineIdsPromise);return Promise.all(promiseArray).then(function(result){var partialQuote=result[0];var allQuoteLineRecordsWithOnlyIds=result[1];this.devPrefix=this.settings.developerPrefix;var partialLineItemCount=partialQuote.lineItems.length;var totalLineCount=partialQuote.record[this.devPrefix+'LineItemCount__c'];var batchSize=this.settings.quoteBatchSize;if(totalLineCount>partialLineItemCount){var promiseCount=Math.ceil((totalLineCount-partialLineItemCount)/batchSize);allQuoteLineRecordsWithOnlyIds.splice(0,batchSize);var loadQuotePromises=this.createLoadQuotePromises(quoteId,promiseCount,batchSize,allQuoteLineRecordsWithOnlyIds);return Promise.all(loadQuotePromises).then(function(quoteFragments){var completeQuote=buildQuote(partialQuote,quoteFragments,this.settings);return Promise.resolve({quote:completeQuote.quote,settings:this.settings,linesByKey:completeQuote.linesByKey,linesById:completeQuote.linesById});}.bind(this));}else{var completeQuote=buildQuote(partialQuote,null,this.settings);return Promise.resolve({quote:completeQuote.quote,settings:this.settings,linesByKey:completeQuote.linesByKey,linesById:completeQuote.linesById});}}.bind(this));}},{key:"loadEditorModel",value:function loadEditorModel(quoteId){var initialLoadPromise=this.fragmentLoad(quoteId,true);var getQuoteLineIdsPromise=this.buildQuoteLineIdsPromise(quoteId);var promiseArray=[];promiseArray.push(initialLoadPromise);promiseArray.push(getQuoteLineIdsPromise);return Promise.all(promiseArray).then(function(result){if(result[0]=='Incomplete'){return Promise.resolve(result[0]);}var editorModel=result[0];var allQuoteLineRecordsWithOnlyIds=result[1];this.settings=editorModel.settings;var settingsModel=new SettingsModel(this.settings);this.devPrefix=this.settings.developerPrefix;var partialQuote=editorModel.quote;var partialLineItemCount=partialQuote.lineItems.length;var totalLineCount=partialQuote.record[this.devPrefix+'LineItemCount__c'];var batchSize=this.settings.quoteBatchSize;if(totalLineCount>partialLineItemCount){var promiseCount=Math.ceil((totalLineCount-partialLineItemCount)/batchSize);allQuoteLineRecordsWithOnlyIds.splice(0,batchSize);var loadQuotePromises=this.createLoadQuotePromises(quoteId,promiseCount,batchSize,allQuoteLineRecordsWithOnlyIds);return Promise.all(loadQuotePromises).then(function(quoteFragments){editorModel.quote=buildQuote(partialQuote,quoteFragments,this.settings).quote;var quoteModel=new QuoteModel(settingsModel,editorModel.quote);QuoteSummarizer.summarize([quoteModel],settingsModel);return Promise.resolve(editorModel);}.bind(this));}else{editorModel.quote=buildQuote(partialQuote,null,this.settings).quote;var quoteModel=new QuoteModel(settingsModel,editorModel.quote);QuoteSummarizer.summarize([quoteModel],settingsModel);return Promise.resolve(editorModel);}}.bind(this));}},{key:"fragmentLoad",value:function fragmentLoad(quoteId,loadEditorModel,quoteLineIds){var loader='QuoteLineEditorServiceProvider.'+(loadEditorModel?'LoadFragmentedEditorModel':'LoadQuoteFragments');var context={quoteLineIds:quoteLineIds,quoteId:quoteId};if(!quoteLineIds){counter=0;console.log('Processing initial load lines.');}else{var currentCount=counter;counter+=quoteLineIds.length;console.log('Processing - loading '+currentCount+' to '+counter+' additional lines.');}return this.apex.load(this.prefix,loader,null,context);}},{key:"createLoadQuotePromises",value:function createLoadQuotePromises(quoteId,promiseCount,batchSize,allQuoteLineRecordsWithOnlyIds){var promises=[];for(var i=0;i<promiseCount;i++){var quoteLineRecordBatch=allQuoteLineRecordsWithOnlyIds.splice(0,batchSize);var quoteLineIdBatch=[];for(var j=0,k=quoteLineRecordBatch.length;j<k;j++){quoteLineIdBatch.push(quoteLineRecordBatch[j].Id);}promises.push(this.fragmentLoad(quoteId,false,quoteLineIdBatch));}return promises;}},{key:"buildQuoteLineIdsPromise",value:function buildQuoteLineIdsPromise(quoteId){var prefix=this.prefix?this.prefix+'__':'';var queryText="SELECT Id FROM "+prefix+"QuoteLine__c WHERE "+prefix+"Quote__c = '"+quoteId+"' ORDER BY "+prefix+"Number__c ASC, "+prefix+"SegmentIndex__c ASC, CreatedDate ASC";return this.apex.query(queryText).then(function(result){this.apex.clear('SOQL',queryText);if(result.done){return result.records;}else{return this.queryMoreLines(result);}}.bind(this));}},{key:"queryMoreLines",value:function queryMoreLines(queryResult){var records=queryResult.records;var queryMore=function(queryLocator){return this.apex.queryMore(queryLocator).then(function(result){records=records.concat(result.records);if(result.done){return Promise.resolve(records);}else{return queryMore(result.nextRecordsUrl);}});}.bind(this);return queryMore(queryResult.nextRecordsUrl);}},{key:"saveQuote",value:function saveQuote(quoteVO){var self=this;var lineRecords=[];var groupRecords=[];var groupsByKey={};var lineVOsByKey={};self.devPrefix=this.settings.developerPrefix;return this.callout('SaveQuoteRecord',quoteVO.record).then(function(){console.log('Processing - saving groups ');for(var i=0,l=quoteVO.lineItemGroups.length;i<l;i++){var groupVO=quoteVO.lineItemGroups[i];groupVO.record[self.devPrefix+"Quote__c"]=quoteVO.record.Id;groupRecords.push(groupVO.record);}if(quoteVO.deletedGroupIds.length>0){return self.callout('DeleteGroupRecords',quoteVO.deletedGroupIds);}return Promise.resolve();}).then(function(){return self.callout('SaveGroupRecords',groupRecords);}).then(function(savedGroupRecordIds){if(savedGroupRecordIds.length>0){var len=quoteVO.lineItemGroups.length;for(var j=0;j<len;j++){quoteVO.lineItemGroups[j].record.Id=savedGroupRecordIds[j];groupsByKey[quoteVO.lineItemGroups[j].key]=quoteVO.lineItemGroups[j];}}for(var i=0,l=quoteVO.lineItems.length;i<l;i++){var lineVO=quoteVO.lineItems[i];lineVO.record[self.devPrefix+"Quote__c"]=quoteVO.record.Id;lineVO.record[self.devPrefix+"Group__c"]=groupsByKey[lineVO.parentGroupKey]?groupsByKey[lineVO.parentGroupKey].record.Id:null;lineRecords.push(lineVO.record);}if(quoteVO.deletedLineIds.length>0){return self.callout('DeleteLineRecords',quoteVO.deletedLineIds);}return Promise.resolve();}).then(function(){var promiseData=self.buildPromiseData('SaveLineRecords',lineRecords);return self.executeQuoteLinePromises(promiseData);}).then(function(quoteLineIds){var lineItemLength=quoteVO.lineItems.length;for(var i=0,l=lineItemLength;i<l;i++){var line=quoteVO.lineItems[i];line.record.Id=quoteLineIds[i];lineVOsByKey[line.key]=line;}var lineRecordsWithHierarchy=[];for(var ii=0,ll=quoteVO.lineItems.length;ii<ll;ii++){var line=quoteVO.lineItems[ii];var changed=false;var oldParentId=line.record[self.devPrefix+"RequiredBy__c"];var newParentId=lineVOsByKey[line.parentItemKey]?lineVOsByKey[line.parentItemKey].record.Id:null;if(oldParentId!=newParentId){line.record[self.devPrefix+"RequiredBy__c"]=newParentId;changed=true;}if(changed){lineRecordsWithHierarchy.push(line.record);}}var promiseDataWithHierarchy=self.buildPromiseData('SaveLineRecords',lineRecordsWithHierarchy);return self.executeQuoteLinePromises(promiseDataWithHierarchy);}).then(function(){var rateCards=[];quoteVO.lineItems.forEach(function(line){if(line.rateCards&&line.rateCards.length>0){line.rateCards.forEach(function(rateCard){rateCard[self.devPrefix+'QuoteLine__c']=line.record.Id;rateCards.push(rateCard);});}});var promiseDataForRateCards=self.buildPromiseData('UsageRateCardDAO.UsageRateCardSaver',rateCards);return self.executeUsageRateCardPromises(promiseDataForRateCards);}).then(function(savedRateCards){var rateCardCount=0;quoteVO.lineItems.forEach(function(line){if(line.rateCards&&line.rateCards.length>0){line.rateCards=savedRateCards.slice(rateCardCount,rateCardCount+line.rateCards.length);rateCardCount+=line.rateCards.length;}});return Promise.resolve(quoteVO);});}},{key:"callout",value:function callout(saver,records,useSaverDirectly){if(!records||records.length===0){return Promise.resolve([]);}var trueSaver=useSaverDirectly?saver:'QuoteLineEditorServiceProvider.'+saver;return this.apex.save(this.prefix,trueSaver,records,null,true);}},{key:"executeQuoteLinePromises",value:function executeQuoteLinePromises(promises){this.quoteLineIds=[];if(promises.length===0){return Promise.resolve();}var promiseExecutor=function(promises){console.log('Processing - saving lines '+promises[0].recordBatch.length);return this.callout(promises[0].saver,promises[0].recordBatch).then(function(result){this.quoteLineIds=this.quoteLineIds.concat(result);promises.splice(0,1);if(promises.length===0){return Promise.resolve(this.quoteLineIds);}else{return promiseExecutor(promises);}}.bind(this));}.bind(this);return promiseExecutor(promises);}},{key:"executeUsageRateCardPromises",value:function executeUsageRateCardPromises(promises){var _this3=this;var savedRateCards=[];if(promises.length===0){return Promise.resolve();}var promiseExecutor=function promiseExecutor(promises){console.log('Processing - saving rate cards '+promises[0].recordBatch.length);return _this3.callout(promises[0].saver,promises[0].recordBatch,true).then(function(result){savedRateCards=savedRateCards.concat(result);promises.splice(0,1);if(promises.length===0){return Promise.resolve(savedRateCards);}else{return promiseExecutor(promises);}});};return promiseExecutor(promises);}},{key:"buildPromiseData",value:function buildPromiseData(saver,records){var promiseData=[];var quoteBatchSize=this.settings.quoteBatchSize;for(var i=0,length=records.length;i<length;i+=quoteBatchSize){var recordBatch=records.slice(i,i+quoteBatchSize);promiseData.push({saver:saver,recordBatch:recordBatch});}return promiseData;}}]);return QuoteDAO;}();function buildQuote(partialQuote,quoteFragments,settings){var completeQuote={quote:partialQuote,linesByKey:{},linesById:{}};var key=2;for(var i=0,l=partialQuote.lineItems.length;i<l;i++){var line=partialQuote.lineItems[i];completeQuote.linesByKey[line.key]=line;completeQuote.linesById[line.record.Id]=line;line.key=key++;}if(quoteFragments){for(var ii=0,ll=quoteFragments.length;ii<ll;ii++){var fragment=quoteFragments[ii];for(var iii=0,lll=fragment.lineItems.length;iii<lll;iii++){var item=fragment.lineItems[iii];completeQuote.quote.lineItems.push(item);completeQuote.linesByKey[item.key]=item;completeQuote.linesById[item.record.Id]=item;item.key=key++;}}}completeQuote.quote.nextKey=key;QuoteHandler.addComponents(completeQuote.quote,settings,completeQuote.linesById);QuoteHandler.renumber(completeQuote.quote,settings);return completeQuote;}module.exports=QuoteDAO;},{"../QuoteHandler.js":18,"../QuoteModel2.js":22,"../QuoteSummarizer.js":25,"../SettingsModel.js":27,"../Utils/ApexUtils.js":30}],5:[function(require,module,exports){"use strict";var DiscountTierListModel=require("./DiscountTierListModel.js");var NumberUtils=require("../Utils/NumberUtils.js");var IdUtils=require("./Utils/IdUtils.js");var DiscountScheduleModel=function(){function DiscountScheduleModel(record,productIds,settings){_classCallCheck2(this,DiscountScheduleModel);this.record=record;this.settings=settings;this.prefix=settings.devPrefix;var prefix=this.prefix;if(record[prefix+"DiscountTiers__r"]!=null){this.tiersModel=new DiscountTierListModel(record,settings);}if(productIds&&productIds.length>0){this.productIds=productIds;}else if(record[prefix+"Products__r"]!=null){this.productIds=[];record[prefix+"Products__r"].records.forEach(function(p){this.productIds.push(p["Id"]);},this);}this.tiersByQuantityCache={};this.discountCache={};this.constraintField=this.record[this.prefix+"ConstraintField__c"];this.discountUnitPercent=record[this.prefix+"DiscountUnit__c"]==null||record[this.prefix+"DiscountUnit__c"].toLowerCase()==="percent";}_createClass(DiscountScheduleModel,[{key:"isPricebookIdExcluded",value:function isPricebookIdExcluded(pricebookId){var custom=this.settings.discountsUseCustomExclusionField?"Custom":"";var excludedIds=this.record[this.prefix+custom+"ExcludedPricebookIds__c"];if(excludedIds!=null){if(this.excludedPricebookIds==null){this.excludedPricebookIds={};excludedIds.split(",").forEach(function(pbId){this.excludedPricebookIds[IdUtils.convertTo18(pbId.trim(),this.settings)]=true;},this);}return this.excludedPricebookIds[IdUtils.convertTo18(pricebookId,this.settings)]===true;}return false;}},{key:"isCrossOrder",value:function isCrossOrder(){return this.record[this.prefix+"CrossOrders__c"]===true;}},{key:"usesCustomQuantity",value:function usesCustomQuantity(){var customField=this.record[this.prefix+"QuoteLineQuantityField__c"];return customField!=null&&customField!="Quantity";}},{key:"isCrossProduct",value:function isCrossProduct(){return this.record[this.prefix+"CrossProducts__c"]===true;}},{key:"isDiscountTypeSlab",value:function isDiscountTypeSlab(){return this.getType()=="Slab";}},{key:"isIncludeBundled",value:function isIncludeBundled(){return this.record[this.prefix+"IncludeBundledProducts__c"]===true;}},{key:"getId",value:function getId(){return this.record["Id"];}},{key:"getType",value:function getType(){return this.record[this.prefix+"Type__c"];}},{key:"getTierIdForQuantity",value:function getTierIdForQuantity(quantity,currencyCode){if(quantity!=null||this.getType()==="Range"){var row=getTierRow(quantity,this);if(row!=null){var tier=row.getTier(currencyCode);return tier!=null?tier["Id"]:null;}}return null;}},{key:"isAggregatedWithinGroup",value:function isAggregatedWithinGroup(){var agScope=this.record[this.prefix+"AggregationScope__c"];return agScope!=null&&agScope.toLowerCase()==="group";}},{key:"isAggregatedWithinQuote",value:function isAggregatedWithinQuote(){var agScope=this.record[this.prefix+"AggregationScope__c"];return agScope!=null&&agScope.toLowerCase()==="quote";}},{key:"isDiscountUnitAmount",value:function isDiscountUnitAmount(){return this.record[this.prefix+"DiscountUnit__c"]==="Amount";}},{key:"hasTiers",value:function hasTiers(){return this.tiersModel!=null&&this.tiersModel.getTierRows()!=null&&this.tiersModel.getTierRows().length!==0;}},{key:"getLowestBound",value:function getLowestBound(currencyCode){var tierRows=this.tiersModel.getTierRows();var lower=tierRows[0].getTier(currencyCode)[this.prefix+"LowerBound__c"]||0;return lower;}},{key:"computeDiscount",value:function computeDiscount(qty,lineQty,price,currencyCode){if(qty==null||price==null){return null;}if(lineQty==null){lineQty=qty;}var cacheKey=qty+":"+lineQty+""+price+""+currencyCode;var discount=this.discountCache[cacheKey];if(discount==null){if(this.getType()==="Range"){var tRow=getTierRow(qty,this);if(tRow!=null){var tier=tRow.getTier(currencyCode);if(tier!=null){var discountPercentage=tier[this.prefix+"Discount__c"]||0;var discountAmount=tier[this.prefix+"DiscountAmount__c"]||0;discount=this.discountUnitPercent?price*discountPercentage/100.0:discountAmount;discount=NumberUtils.setScale(discount,getPriceScale(this));}this.discountCache[cacheKey]=discount;return discount;}}else if(this.getType()==="Slab"){if(this.tiersModel==null){return 0;}var _discount=this.tiersModel.getTierRows().reduce(function(acc,row){return acc+row.getDiscountAmount(qty,lineQty,price,currencyCode,this.discountUnitPercent);}.bind(this),0);this.discountCache[cacheKey]=_discount;return _discount;}}return discount;}}]);return DiscountScheduleModel;}();function getTierRow(quantity,ds){if(ds.tiersByQuantityCache[quantity]==null){if(ds.tiersModel==null){return null;}var rows=ds.tiersModel.getTierRows();var rowCount=rows.length;for(var i=0;i<rowCount;i++){var row=rows[i];if(row.isInRange(quantity)){ds.tiersByQuantityCache[quantity]=row;return row;}}}return ds.tiersByQuantityCache[quantity];}function getPriceScale(ds){return Math.floor(ds.record[ds.prefix+"PriceScale__c"]||2);}module.exports=DiscountScheduleModel;},{"../Utils/NumberUtils.js":2,"./DiscountTierListModel.js":6,"./Utils/IdUtils.js":31}],6:[function(require,module,exports){"use strict";var DiscountTierListModel=function(){function DiscountTierListModel(dsRecord,settings){_classCallCheck2(this,DiscountTierListModel);this.schedule=dsRecord;this.settings=settings;this.prefix=settings.devPrefix;this.unitPriceScale=settings.unitPriceScale;this.rows=[];this.multiTierRow=settings.isMultiCurrencyOrg&&dsRecord[this.prefix+"DiscountUnit__c"]=="Amount";this.columnHeadings=[settings.currencySymbol];if(this.multiTierRow){this.columnHeadings=settings.currencyIsoCodes;}var lowerBounds={};var tiersByKey={};dsRecord[this.prefix+"DiscountTiers__r"].records.forEach(function(tier){tiersByKey[createKey(tier,this)]=tier;lowerBounds[tier[this.prefix+"LowerBound__c"]]=true;},this);var lowerBoundsArray=[];for(var x in lowerBounds){lowerBoundsArray.push(Number(x));}lowerBoundsArray.sort(function(a,b){return a-b;});lowerBoundsArray.forEach(function(lb){var row=new TierRow(this,getNextRowId(),[],this.settings);if(this.multiTierRow){this.columnHeadings.forEach(function(currencyCode){var key=lb+currencyCode;var discountTier=tiersByKey[key];if(discountTier==null){discountTier={"Schedule__c":dsRecord.Id,"CurrencyIsoCode":currencyCode};}row.addTier(new Tier(discountTier,this.uniPriceScale));},this);}else{var tier=tiersByKey[lb];if(tier==null){throw new Error(settings.getLabelByKey('msg_js_err_null_discount_tier'));}row.tiers.push(new Tier(tier,this.unitPriceScale));}this.rows.push(row);},this);}_createClass(DiscountTierListModel,[{key:"getTierRows",value:function getTierRows(){return this.rows;}}]);return DiscountTierListModel;}();var ROW_ID=0;function createKey(tier,listModel){var key=String(tier[listModel.prefix+"LowerBound__c"]);if(listModel.multiTierRow){key+=tier["CurrencyIsoCode"];}return key;}function getNextRowId(){ROW_ID++;return String(ROW_ID);}var TierRow=function(){function TierRow(parentModel,id,tiers,settings){_classCallCheck2(this,TierRow);this.id=id;this.index=0;this.tiers=tiers;this.schedule=parentModel.schedule;this.settings=settings;this.prefix=settings.devPrefix;}_createClass(TierRow,[{key:"getTemplate",value:function getTemplate(){return this.masterTier||this.tiers[0].record;}},{key:"isInRange",value:function isInRange(quantity){var template=this.getTemplate();if(template[this.prefix+"UpperBound__c"]==null){return quantity>=template[this.prefix+"LowerBound__c"];}else{return quantity>=template[this.prefix+"LowerBound__c"]&&quantity<template[this.prefix+"UpperBound__c"];}}},{key:"isInSlab",value:function isInSlab(quantity){if(this.isInRange(quantity)){return true;}return quantity>=this.getTemplate()[this.prefix+"LowerBound__c"];}},{key:"addTier",value:function addTier(tier){var record=tier.record;if(record[this.prefix+"LowerBound__c"]!=null){this.masterTier=record;}this.tiers.push(tier);}},{key:"getTier",value:function getTier(currencyCode){var dUnit=this.schedule[this.prefix+"DiscountUnit__c"];if(dUnit==null||dUnit.toLowerCase()==="percent"||!this.settings.isMultiCurrencyOrg){return this.tiers[0].record;}var tierNum=this.tiers.length;for(var i=0;i<tierNum;i++){var tier=this.tiers[i];if(tier.record['CurrencyIsoCode']===currencyCode){return tier.record;}}return null;}},{key:"getDiscountAmount",value:function getDiscountAmount(quantity,lineQty,price,currencyCode,isPercent){var record=this.getTier(currencyCode);var lower=record[this.prefix+"LowerBound__c"]||1;var upper=record[this.prefix+"UpperBound__c"]||quantity+1;var discountPercentage=record[this.prefix+"Discount__c"]||0;var discountAmount=record[this.prefix+"DiscountAmount__c"]||0;var itemsInRange=Math.max(0,Math.min(upper-1,quantity)-Math.max(lower-1,quantity-lineQty));var discountPerItem=isPercent?discountPercentage*price*.01:discountAmount;return itemsInRange*discountPerItem;}}]);return TierRow;}();var Tier=function Tier(tier,unitPriceScale){_classCallCheck2(this,Tier);this.record=tier;this.unitPriceScale=unitPriceScale;};module.exports=DiscountTierListModel;},{}],7:[function(require,module,exports){module.exports=function(data){var fieldMetadata={};data.forEach(function(d){if(d!=null&&d.fullName!=null){fieldMetadata[d.fullName]=d;}});function getMetadataForField(objectType,fieldName){return fieldMetadata[objectType+'.'+fieldName];}function getAllFieldNamesOnObject(desiredType){var results=[];for(var fullName in fieldMetadata){var splitName=fullName.split('.');if(splitName[0]===desiredType){results.push(splitName[1]);}}return results;}return{fieldMetadata:fieldMetadata,getAllFieldNamesOnObject:getAllFieldNamesOnObject,getMetadataForField:getMetadataForField};};},{}],8:[function(require,module,exports){"use strict";var IdUtils=require("./Utils/IdUtils.js");var esprima=require('esprima');var MetaDataUtils=require("./Utils/MetaDataUtils.js");var NumberUtils=require("../Utils/NumberUtils.js");var DateUtils=require('../Utils/DateUtils.js');var FormulaFieldCalculator=function(){function FormulaFieldCalculator(settings){_classCallCheck2(this,FormulaFieldCalculator);this.quoteRecord={};this.fieldMetadata={};this.evaluatedFields={};this.settings=settings;this.quantityFields=getQuantityFields(this.settings.devPrefix);}_createClass(FormulaFieldCalculator,[{key:"setMetadata",value:function setMetadata(dataIndex){this.fieldMetadata=dataIndex.fieldMetadata;}},{key:"getMetadataForField",value:function getMetadataForField(objectType,fieldName){return this.fieldMetadata[objectType+'.'+fieldName];}},{key:"resetEvaluatedFields",value:function resetEvaluatedFields(){this.evaluatedFields={};}},{key:"fieldIsEvaluated",value:function fieldIsEvaluated(fieldName){return this.evaluatedFields[fieldName]==true;}},{key:"markFieldEvaluated",value:function markFieldEvaluated(fieldName){this.evaluatedFields[fieldName]=true;}},{key:"calculateFormulaFieldsOnObjects",value:function calculateFormulaFieldsOnObjects(objects){var metaMap=this.fieldMetadata;var messagesByCause={};objects.forEach(function(object){this.resetEvaluatedFields();var scaledFields=[];for(var fieldName in metaMap){var fieldOwner=fieldName.split(".")[0];var shortName=fieldName.split(".")[1];if(metaMap.hasOwnProperty(fieldName)&&fieldOwner==MetaDataUtils.getObjectType(object)){try{this.calculateField(shortName,object.record,'Formula Field');if(object.record[shortName]!=null){var fullName=MetaDataUtils.getRecordType(object.record)+"."+shortName;var meta=this.fieldMetadata[fullName];var resultType=meta.type.toLowerCase();if(fieldIsCalculated(object.record,meta,'Formula Field',shortName)&&(resultType==='currency'||resultType==='number'||resultType==='percent')){scaledFields.push({fieldName:shortName,meta:meta});}}}catch(e){if(e.problemField!=null&&messagesByCause[e.problemField]==null){messagesByCause[e.problemField]=e.message;}else if(e.problemField==null&&messagesByCause[fieldName]==null){messagesByCause[fieldName]="Field '"+fieldName+"' threw the following exception: "+e.message;}}}}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=scaledFields[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var field=_step.value;var scale=!this.quantityFields.has(field.fieldName)?field.meta.scale:object.productQuantityScale?object.productQuantityScale:this.settings.quantityScale;object.record[field.fieldName]=NumberUtils.setScale(object.record[field.fieldName],scale);}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}},this);for(var pf in messagesByCause){if(console){console.warn(messagesByCause[pf]);}}}},{key:"calculateField",value:function calculateField(fieldName,record,formulaSource){var fullName=MetaDataUtils.getRecordType(record)+"."+fieldName;var meta=this.fieldMetadata[fullName];if(meta==null){var errorText=this.settings.getLabelByKey('msg_js_err_no_metadata').replace('{0}',fullName);var e=new Error(errorText);e.problemField=fullName;throw e;}var result;if(!this.fieldIsEvaluated(fullName)||formulaSource.indexOf('Member Expression')!=-1){if(fieldIsCalculated(record,meta,formulaSource,fieldName)){var formula=meta.formula||meta.defaultValue;formula=replaceBadCharacters(formula);var ast=esprima.parse(formula);result=this.processAST(ast,record,meta,formulaSource);var resultType=meta.type.toLowerCase();if(result!=null){if(resultType=='text'&&meta.length!=null){result=result.slice(0,meta.length);}else if(resultType=='percent'){result=result*100;}else if(resultType=='date'&&result instanceof Date){result=DateUtils.toApexDate(result);}else if(resultType=='datetime'&&result instanceof Date){result=DateUtils.toApexDateTime(result);}}}else{result=record[fieldName];}if(result==undefined){result=null;}else if(meta.type!=null&&meta.type.toLowerCase()=='checkbox'&&typeof result=='string'){if(result.toLowerCase()==='true'){result=true;}else if(result.toLowerCase()==='false'){result=false;}}record[fieldName]=result;if(formulaSource.indexOf('Member Expression')==-1){this.markFieldEvaluated(fullName);}}return record[fieldName];}},{key:"processAST",value:function processAST(ast,record,metadata,src){var isFormulaComponent=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;switch(ast.type){case"Program":return this.processAST(ast.body[0],record,metadata,src);case"ExpressionStatement":return this.processAST(ast.expression,record,metadata,src);case"CallExpression":return this.processCallExpression(ast,record,metadata,src,true);case"UnaryExpression":var arg=this.processAST(ast.argument,record,metadata,src);return processUnaryExpression(ast.operator,arg,metadata,this.settings);case"LogicalExpression":case"BinaryExpression":var operator=ast.operator;var left=this.processAST(ast.left,record,metadata,src,true);var right=this.processAST(ast.right,record,metadata,src,true);return processBinaryOp(operator,left,right,metadata,this.settings);case"Literal":return ast.value;case"Identifier":if(ast.name.toLowerCase()==="true"){return true;}else if(ast.name.toLowerCase()==="false"){return false;}else if(ast.name.toLowerCase()==='null'){return null;}var value=this.calculateField(ast.name,record,src);var fieldMeta=this.getMetadataForField(MetaDataUtils.getRecordType(record),ast.name);return this.postProcessCalculatedValue(value,metadata,fieldMeta);case"MemberExpression":return this.handleMemberExpression(ast,record,metadata,src);default:var astErrorText=this.settings.getLabelByKey("msg_js_err_unexpected_ast").replace("{0}",metadata.fullName);var compError=new Error(astErrorText);compError.problemField=metadata.fullName;throw compError;}}},{key:"handleMemberExpression",value:function handleMemberExpression(ast,record,metadata,formulaSource){var property=ast.property.name;var referencedRecord;if(ast.object.type=='Identifier'){var object=ast.object.name;if(object.indexOf('$')==0){var globalVarError=this.settings.getLabelByKey('msg_js_err_unsupported_global').replace("{0}",metadata.fullName).replace("{1}",object).replace("{2}",property);var gve=new Error(globalVarError);gve.problemField=metadata.fullName;throw gve;}referencedRecord=record[object];}else if(ast.object.type=='MemberExpression'){referencedRecord=this.handleMemberExpression(ast.object,record,metadata,formulaSource);}if(referencedRecord==null){return null;}if(property.indexOf('__r')==property.length-3){return referencedRecord[property];}var value=this.calculateField(property,referencedRecord,formulaSource+' Member Expression');var referencedFieldMeta=this.getMetadataForField(MetaDataUtils.getRecordType(referencedRecord),property);return this.postProcessCalculatedValue(value,metadata,referencedFieldMeta);}},{key:"postProcessCalculatedValue",value:function postProcessCalculatedValue(value,metadata,fieldMeta){if(fieldMeta==null||fieldMeta.type==null){return value;}var fieldType=fieldMeta.type.toLowerCase();if(value==null){var referenceIsNumCurrOrPercent=fieldType=="number"||fieldType=="currency"||fieldType=="percent";var blanksAsZero=metadata.formulaTreatBlanksAs=='BlankAsZero';if(referenceIsNumCurrOrPercent&&blanksAsZero){return 0;}if(fieldType=='text'){return"";}return null;}if(fieldType=='date'){var attrs=value.split('-');var year=attrs[0];var month=attrs[1]-1;var day=attrs[2];value=new Date(Date.UTC(year,month,day));}else if(fieldType=='datetime'){value=new Date(value);}else if(fieldType=='percent'){value=value/100;}return value;}},{key:"parseRuleFormula",value:function parseRuleFormula(formula,record,quoteRecord,fieldName){if(quoteRecord){this.quoteRecord=quoteRecord;}formula=replaceBadCharacters(formula);var ast=esprima.parse(formula);var metadata=fieldName?this.getMetadataForField(MetaDataUtils.getRecordType(record),fieldName):{};var result=this.processAST(ast,record,metadata,"Price Rule");if(fieldName){result=convertFormulaResultIntoSerializableValue(result,metadata);}return result;}},{key:"processCallExpression",value:function processCallExpression(ast,record,metadata,src){var name=ast.callee.name.toUpperCase();var args=ast["arguments"];switch(name){case"ABS":var arg=this.processAST(args[0],record,metadata,src);return arg>0?arg:-arg;case"AND":for(var i=0;i<args.length;i++){arg=this.processAST(args[i],record,metadata,src);if(!arg){return false;}}return true;case"BEGINS":var string=this.processAST(args[0],record,metadata,src);if(string==null)return false;var substring=this.processAST(args[1],record,metadata,src);return string.indexOf(substring)===0;case"BLANKVALUE":var test=this.processAST(args[0],record,metadata,src);var replacement=this.processAST(args[1],record,metadata,src);var testIsBlank=test==null||test=="";return testIsBlank?replacement:test;case"BR":return"<br>";case"CASE":var condition=this.processAST(args[0],record,metadata,src);var length=args.length;for(i=1;i<length-1;i+=2){arg=this.processAST(args[i],record,metadata,src);if(arg===condition){return this.processAST(args[i+1],record,metadata,src);}}return this.processAST(args[length-1],record,metadata,src);case"CASESAFEID":var id=this.processAST(args[0],record,metadata,src);return IdUtils.convertTo18(id,this.settings);case"CEILING":var num=this.processAST(args[0],record,metadata,src);return num>0?Math.ceil(num):Math.floor(num);case"CONTAINS":string=this.processAST(args[0],record,metadata,src);if(string==null)return false;substring=this.processAST(args[1],record,metadata,src);return string.indexOf(substring)!=-1;case"DATE":var year=this.processAST(args[0],record,metadata,src);var month=this.processAST(args[1],record,metadata,src)-1;var day=this.processAST(args[2],record,metadata,src);res=new Date(Date.UTC(year,month,day));if(res.getUTCFullYear()!=year||res.getUTCDate()!=day||res.getUTCMonth()!=month){throw new Error("Invalid date");}return res;case"DATEVALUE":var dateString=this.processAST(args[0],record,metadata,src);return new Date(dateString);case"DATETIMEVALUE":dateString=this.processAST(args[0],record,metadata,src);return new Date(dateString);case"DAY":arg=this.processAST(args[0],record,metadata,src);return arg.getUTCDate();case"DISTANCE":var distanceErrorText=this.settings.getLabelByKey("msg_js_err_unsupported_formula").replace("{0}",metadata.fullName).replace("{1}","DISTANCE()");var distanceError=new Error(distanceErrorText);distanceError.problemField=metadata.fullName;throw distanceError;case"EXP":return Math.exp(this.processAST(args[0],record,metadata,src));case"FIND":string=this.processAST(args[1],record,metadata,src);if(string==null)return 0;substring=this.processAST(args[0],record,metadata,src);var startPoint=args.length==3?this.processAST(args[2],record,metadata,src):0;return string.indexOf(substring,startPoint||0)+1;case"FLOOR":num=this.processAST(args[0],record,metadata,src);return num>0?Math.floor(num):Math.ceil(num);case"GEOLOCATION":var geolocErrorText=this.settings.getLabelByKey("msg_js_err_unsupported_formula").replace("{0}",metadata.fullName).replace("{1}","GEOLOCATION()");var geolocError=new Error(geolocErrorText);geolocError.problemField=metadata.fullName;throw geolocError;case"GETSESSIONID":var sessionIdErrorText=this.settings.getLabelByKey("msg_js_err_unsupported_formula").replace("{0}",metadata.fullName).replace("{1}","GETSESSIONID()");var sessionIdError=new Error(sessionIdErrorText);sessionIdError.problemField=metadata.fullName;throw sessionIdError;case"HYPERLINK":var url=this.processAST(args[0],record,metadata,src);url=url.replace(/={2}/g,"=");var friendlyName=this.processAST(args[1],record,metadata,src);target=args.length==3?this.processAST(args[2],record,metadata,src):"_blank";return"<a href=\""+url+"\" target=\""+target+"\">"+friendlyName+"</a>";case"IF":condition=this.processAST(args[0],record,metadata,src);return condition?this.processAST(args[1],record,metadata,src):this.processAST(args[2],record,metadata,src);case"IMAGE":url=this.processAST(args[0],record,metadata,src);url=url.replace(/={2}/g,"=");url=url.replace(/&amp;/g,"&");var altText=this.processAST(args[1],record,metadata,src);var img="<img src=\""+url+"\" alt=\""+altText;if(args.length>2){img+="\" height=\""+this.processAST(args[2],record,metadata,src);}if(args.length>3){img+="\" width=\""+this.processAST(args[3],record,metadata,src);}img+="\" border=\"0\">";return img;case"INCLUDES":var choices=this.processAST(args[0],record,metadata,src).split(";");var option=this.processAST(args[1],record,metadata,src);return choices.some(function(element){return element===option;});case"ISBLANK":var field=this.processAST(args[0],record,metadata,src);return field==null||field==="";case"ISNULL":field=this.processAST(args[0],record,metadata,src);return field==null;case"ISNUMBER":num=Number(this.processAST(args[0],record,metadata,src));return num==num;case"ISPICKVAL":var value=this.processAST(args[0],record,metadata,src);var literal=this.processAST(args[1],record,metadata,src);if(literal==''&&value==null){return true;}return value==literal;case"LEFT":string=this.processAST(args[0],record,metadata,src);if(string==null)return'';var count=this.processAST(args[1],record,metadata,src);return string.slice(0,count);case"LEN":string=this.processAST(args[0],record,metadata,src);return string!=null?string.length:0;case"LN":return Math.log(this.processAST(args[0],record,metadata,src));case"LOG":return Math.log(this.processAST(args[0],record,metadata,src))/Math.LN10;case"LOWER":return this.processAST(args[0],record,metadata,src).toLowerCase();case"LPAD":string=this.processAST(args[0],record,metadata,src);if(string==null)return'';length=this.processAST(args[1],record,metadata,src);var padString=args.length==3?this.processAST(args[2],record,metadata,src):" ";padString=padString!=null?padString:'';if(string.length>length){return string.slice(0,length);}else if(string.length==length){return string;}else{var diff=length-string.length;var fullCount=Math.floor(diff/padString.length);var partialCount=diff%padString.length;var adjusted="";for(i=0;i<fullCount;i++){adjusted+=padString;}adjusted+=padString.slice(0,partialCount);return adjusted+string;}case"MAX":var res=Number.NEGATIVE_INFINITY;for(i=0;i<args.length;i++){arg=this.processAST(args[i],record,metadata,src);res=res>arg?res:arg;}return res;case"MID":string=this.processAST(args[0],record,metadata,src);startPoint=this.processAST(args[1],record,metadata,src);count=this.processAST(args[2],record,metadata,src);return string.slice(startPoint-1,startPoint-1+count);case"MIN":res=Number.POSITIVE_INFINITY;for(i=0;i<args.length;i++){arg=this.processAST(args[i],record,metadata,src);res=res<arg?res:arg;}return res;case"MOD":return this.processAST(args[0],record,metadata,src)%this.processAST(args[1],record,metadata,src);case"MONTH":arg=this.processAST(args[0],record,metadata,src);return arg.getUTCMonth()+1;case"NOT":return!this.processAST(args[0],record,metadata,src);case"NOW":return new Date(Date.now());case"NULLVALUE":test=this.processAST(args[0],record,metadata,src);replacement=this.processAST(args[1],record,metadata,src);return test==null?replacement:test;case"OR":for(i=0;i<args.length;i++){arg=this.processAST(args[i],record,metadata,src);if(arg){return true;}}return false;case"RIGHT":string=this.processAST(args[0],record,metadata,src);if(string==null)return'';count=this.processAST(args[1],record,metadata,src);if(count>=string.length){return string;}else{return string.slice(string.length-count,string.length);}case"ROUND":var number=this.processAST(args[0],record,metadata,src);var placeCount=this.processAST(args[1],record,metadata,src);var multiplier=Math.pow(10,placeCount);number*=multiplier;if(number>0){res=Math.round(number);}else{res=-Math.round(-number);}res/=multiplier;return res;case"RPAD":string=this.processAST(args[0],record,metadata,src);if(string==null)return'';length=this.processAST(args[1],record,metadata,src);padString=args.length==3?this.processAST(args[2],record,metadata,src):" ";padString=padString!=null?padString:'';if(string.length>length){return string.slice(0,length);}else if(string.length===length){return string;}else{diff=length-string.length;fullCount=Math.floor(diff/padString.length);partialCount=diff%padString.length;adjusted="";for(i=0;i<fullCount;i++){adjusted+=padString;}adjusted+=padString.slice(0,partialCount);return string+adjusted;}case"SQRT":return Math.sqrt(this.processAST(args[0],record,metadata,src));case"SUBSTITUTE":string=this.processAST(args[0],record,metadata,src);if(string==null)return'';var regexSourceString=this.processAST(args[1],record,metadata,src);regexSourceString=regexSourceString!=null?regexSourceString:'';regexSourceString=regexSourceString.replace(/\{/g,'\\{');regexSourceString=regexSourceString.replace(/\}/g,'\\}');regexSourceString=regexSourceString.replace(/\[/g,'\\[');regexSourceString=regexSourceString.replace(/\]/g,'\\]');var target=new RegExp(regexSourceString,"g");replacement=this.processAST(args[2],record,metadata,src);return string.replace(target,replacement);case"TEXT":var res=this.processAST(args[0],record,metadata,src);if(res instanceof Date){res=DateUtils.toUTCDateString(res);}return res==null?'':String(res);case"TODAY":var today=new Date();return new Date(Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate()));case"TRIM":return this.processAST(args[0],record,metadata,src).trim().replace(/[ ]+/g," ");case"UPPER":return this.processAST(args[0],record,metadata,src).toUpperCase();case"VALUE":return Number(this.processAST(args[0],record,metadata,src))||"#Error!";case"YEAR":arg=this.processAST(args[0],record,metadata,src);if(arg instanceof Date){return arg.getUTCFullYear();}return arg.split("-")[0];default:var unimplementedErrorText=this.settings.getLabelByKey("msg_js_err_unsupported_formula").replace("{0}",metadata.fullName).replace("{1}",name);throw new Error(unimplementedErrorText);}}}]);return FormulaFieldCalculator;}();function fieldIsCalculated(record,metadata,formulaSource,fieldName){if(formulaSource.indexOf('Price Rule')!=-1){return false;}var type=MetaDataUtils.getRecordType(record);switch(type){case'SBQQ__Quote__c':case'Quote__c':case'SBQQ__QuoteLineGroup__c':case'QuoteLineGroup__c':case'SBQQ__QuoteLine__c':case'QuoteLine__c':return needsFormulaCalculation(record,metadata,fieldName);default:return false;}}function needsFormulaCalculation(record,metadata,fieldName){if(record.relatedRecord){return false;}else if(metadata.formula!=null||metadata.defaultValue!=null&&record[fieldName]===undefined&&record.Id==null){return true;}return false;}function getQuantityFields(prefix){return new Set([prefix+'AdditionalQuantity__c',prefix+'BatchQuantity__c',prefix+'BundledQuantity__c',prefix+'EffectiveQuantity__c',prefix+'PriorQuantity__c',prefix+'Quantity__c',prefix+'UpgradedQuantity__c']);}function replaceBadCharacters(formula){formula=formula.replace(/&lt;/g,'<');formula=formula.replace(/&gt;/g,'>');formula=formula.replace(/&amp;/g,'&');formula=formula.replace(/&quot;/g,'"');formula=formula.replace(/&#(\d+);/g,function(match,dec){return String.fromCharCode(dec);});formula=formula.replace(/=+/g,'==');formula=formula.replace(/<=+/g,"<=");formula=formula.replace(/>=+/g,">=");formula=formula.replace(/!=+/g,"!=");formula=formula.replace(/<>/g,"!=");formula=formula.replace(/[Ii][Ff][\s]*[(]/g,"IF(");return formula;}function convertFormulaResultIntoSerializableValue(formulaValue,metadata){var result=formulaValue;var resultType=metadata.type.toLowerCase();if(formulaValue!=null){if(resultType==='text'&&metadata.length){result=formulaValue.slice(0,metadata.length);}else if(resultType==='date'&&result instanceof Date){result=DateUtils.toApexDate(result);}else if(resultType==='datetime'&&result instanceof Date){result=DateUtils.toApexDateTime(result);}}if(result==undefined){result=null;}if(metadata.type!=null&&metadata.type.toLowerCase()==='checkbox'&&typeof result==='string'){if(result.toLowerCase()==='true'){result=true;}else if(result.toLowerCase()==='false'){result=false;}}return result;}function processUnaryExpression(operator,argument,metadata,settings){switch(operator){case"-":return argument*-1;case"!":return!argument;default:var unsupportedUnaryText=settings.getLabelByKey("msg_js_err_unsupported_unary").replace("{0}",metadata.fullName).replace("{1}",operator);throw new Error(unsupportedUnaryText);}}function processBinaryOp(operator,left,right,metadata,settings){switch(operator){case"+":if(left==null||right==null){return null;}if(left instanceof Date){left.setUTCDate(left.getUTCDate()+right);return left;}return left+right;case"-":if(left==null||right==null){return null;}if(left instanceof Date){if(right instanceof Date){return Math.round((left-right)/86400000);}else{left.setUTCDate(left.getUTCDate()-right);return left;}}return left-right;case"*":return left*right;case"/":if(!right||right==0){return null;}return left/right;case"^":return Math.pow(left,right);case"==":if(left instanceof Date&&right instanceof Date){return left.getFullYear()==right.getFullYear()&&left.getMonth()==right.getMonth()&&left.getDate()==right.getDate();}return left===right;case"!=":if(left instanceof Date&&right instanceof Date){return!(left.getFullYear()==right.getFullYear()&&left.getMonth()==right.getMonth()&&left.getDate()==right.getDate());}return left!==right;case"<":return left<right;case">":return left>right;case"<=":return left<=right;case">=":return left>=right;case"&&":return left&&right;case"||":return left||right;case"&":return left+right;default:var unsupportedBinaryText=settings.getLabelByKey("msg_js_err_unsupported_binary").replace("{0}",metadata.fullName).replace("{1}",operator);throw new Error(unsupportedBinaryText);}}module.exports=FormulaFieldCalculator;},{"../Utils/DateUtils.js":1,"../Utils/NumberUtils.js":2,"./Utils/IdUtils.js":31,"./Utils/MetaDataUtils.js":33,"esprima":56}],9:[function(require,module,exports){var ApexUtils=require('./Utils/ApexUtils.js');var JSQCPrecacher=function(){function JSQCPrecacher(){_classCallCheck2(this,JSQCPrecacher);this.apex=ApexUtils();}_createClass(JSQCPrecacher,[{key:"precacheValue",value:function precacheValue(provider,uid,res){this.apex.precache(provider,uid,res);}}]);return JSQCPrecacher;}();module.exports=JSQCPrecacher;},{"./Utils/ApexUtils.js":30}],10:[function(require,module,exports){"use strict";var numberUtils=require("../Utils/NumberUtils.js");var constants=require("./Utils/JSQCConstants.js");var dateUtils=require('../Utils/DateUtils.js');var metaDataUtils=require("./Utils/MetaDataUtils.js");var IdUtils=require("./Utils/IdUtils.js");var LineCalculator=function(){function LineCalculator(quoteCalculator,lineItem,settings){_classCallCheck2(this,LineCalculator);this.parent=quoteCalculator;this.line=lineItem;this.settings=settings;this.line.listProductTotal=0;this.line.customerProductTotal=0;this.line.netProductTotal=0;this.line.regularProductTotal=0;this.line.currentQtyListTotal=0;this.line.currentQtyCustomerTotal=0;this.line.currentQtyNetTotal=0;this.line.currentQtyRegularTotal=0;this.specialDiscountRate=0;this.prorateMultiplier=1;this.prefix=settings.devPrefix;this.unitPriceScale=numberUtils.setScale(settings.unitPriceScale,0);this.subscription=lineItem.isSubscription;this.dynamicSubscription=this.subscription?this.line.isDynamicSubscription:false;this.pricingMethod=lineItem.PricingMethod__c;this.partnerDiscountable=lineItem.isPartnerDiscountable;this.bundled=lineItem.Bundled__c;this.contractedPriceId=lineItem.ContractedPrice__c;this.specialPriceType=lineItem.SpecialPriceType__c;}_createClass(LineCalculator,[{key:"calculate",value:function calculate(){var parent=this.parent;var line=this.line;line.customerTotal=line.netTotal=line.listTotal=line.regularTotal=line.grossProfitAmount=line.listTotalForParent=0;line.record[this.prefix+"NetTotal__c"]=0;line.record[this.prefix+"PartnerTotal__c"]=0;line.record[this.prefix+"ListTotal__c"]=0;line.record[this.prefix+"CustomerTotal__c"]=0;line.record[this.prefix+"RegularTotal__c"]=0;var blockPriced=this.pricingMethod===constants.PRICING_METHOD_BLOCK;if(blockPriced){setBlockPrice(this);}if(line.ListPrice__c==null){return;}if(line.MinimumPrice__c!=null&&line.ListPrice__c<line.MinimumPrice__c){line.currentQtyListPrice=line.ListPrice__c=line.MinimumPrice__c;}else if(line.MaximumPrice__c!=null&&line.ListPrice__c>line.MaximumPrice__c){line.currentQtyListPrice=line.ListPrice__c=line.MaximumPrice__c;}if(line.parentQuote.isAmendment&&line.MinimumPrice__c==line.ListPrice__c&&line.PriorQuantity__c==line.Quantity__c){line.currentQtyListPrice=line.ListPrice__c=0;}if(line.currentQtyListPrice==null){line.currentQtyListPrice=line.ListPrice__c;}var dimType=line.dimType;if(dimType===constants.TYPE_YEARLY_DIMENSION||dimType===constants.TYPE_QUARTERLY_DIMENSION||dimType===constants.TYPE_MONTHLY_DIMENSION){line.StartDate__c=line.effectiveStartDate;line.EndDate__c=line.effectiveEndDate;}if(this.subscription){calculateProrateMultiplier(this);}var proratedListPrice=line.ListPrice__c*this.prorateMultiplier;proratedListPrice=numberUtils.setScale(proratedListPrice,this.unitPriceScale);line.ProratedListPrice__c=proratedListPrice;var currentQtyProratedListPrice=line.currentQtyListPrice*this.prorateMultiplier;currentQtyProratedListPrice=numberUtils.setScale(currentQtyProratedListPrice,this.unitPriceScale);line.currentQtyProratedListPrice=currentQtyProratedListPrice;if(line.hasCostSchedule){var cSchedule=parent.getDiscountScheduleById(line.costScheduleId);computeAndSetPriorQuantity(cSchedule,this);applyCostSchedule(this);}if(line.isVolumeDiscounted){var dSchedule=parent.getDiscountScheduleById(line.DiscountSchedule__c);computeAndSetPriorQuantity(dSchedule,this);}if(line.parentQuote.applyPartnerDiscountFirst){applyPartnerDiscount(this);calculateSpecialPrice(this);applyProration(this);applyDiscountSchedule(this);applyUplift(this);applyAdditionalDiscount(this);applyDistributorDiscount(this);}else{calculateSpecialPrice(this);applyProration(this);applyDiscountSchedule(this);applyUplift(this);if(line.parentQuote.applyAdditionalDiscountLast){applyPartnerDiscount(this);applyDistributorDiscount(this);applyAdditionalDiscount(this);}else{applyAdditionalDiscount(this);applyPartnerDiscount(this);applyDistributorDiscount(this);}}if(line.Renewal__c&&!(line.Existing__c||line.CarryoverLine__c)&&line.PriorQuantity__c==null){line.listTotal=line.ListTotal__c=line.regularTotal=line.RegularTotal__c=line.partnerTotal=line.PartnerTotal__c=line.customerTotal=line.CustomerTotal__c=line.netTotal=line.NetTotal__c=0;}else{if(this.bundled){line.listTotal=line.ListTotal__c=0;}else{line.listTotal=line.ListTotal__c=line.listTotalForParent=numberUtils.setScale(line.effectiveListQuantity*line.ProratedListPrice__c,2);}var effectiveQty=line.effectiveQuantity;line.customerTotal=line.CustomerTotal__c=numberUtils.setScale(effectiveQty*line.CustomerPrice__c,2);line.regularTotal=line.RegularTotal__c=numberUtils.setScale(effectiveQty*line.RegularPrice__c,2);line.partnerTotal=line.PartnerTotal__c=numberUtils.setScale(effectiveQty*line.PartnerPrice__c,2);line.netTotal=line.NetTotal__c=numberUtils.setScale(effectiveQty*line.NetPrice__c,2);if(!blockPriced){var cost=line.UnitCost__c;line.grossProfitAmount=cost==null?null:(line.NetPrice__c-cost)*line.Quantity__c;}}if((!this.subscription||line.isIncludedInMaintenance)&&!this.bundled){var effectivePoTQty=line.effectiveQuantityForPercentOfTotalBase;var shouldUseCurrentQtyPrice=line.parentQuote.isRenewal&&line.isPricingMethodBlock&&this.settings.isIncludePriorBPAssetRenewal;line.netProductTotal=effectivePoTQty*(shouldUseCurrentQtyPrice?line.currentQtyNetPrice:line.NetPrice__c);line.customerProductTotal=effectivePoTQty*(shouldUseCurrentQtyPrice!=null?line.currentQtyCustomerPrice:line.CustomerPrice__c);line.regularProductTotal=effectivePoTQty*(shouldUseCurrentQtyPrice!=null?line.currentQtyRegularPrice:line.RegularPrice__c);var listProductPrice=line.SubscriptionTargetPrice__c!=null?line.SubscriptionTargetPrice__c*this.prorateMultiplier:shouldUseCurrentQtyPrice!=null?line.currentQtyProratedListPrice:line.ProratedListPrice__c;line.listProductTotal=line.effectiveListQuantityForPercentOfTotalBase*listProductPrice;if(this.subscription){var linePM=line.ProrateMultiplier__c;if(linePM!=null&&linePM!==0){line.listProductTotal/=linePM;line.customerProductTotal/=linePM;line.netProductTotal/=linePM;line.regularProductTotal/=linePM;}}}line.record[this.prefix+"GrossProfit__c"]=calculateGrossProfit(this);}}]);return LineCalculator;}();function calculateGrossProfit(lc){var line=lc.line;var costQuantity=line.Quantity__c;if(lc.bundled||line.parentQuote.isRenewal||line.UnitCost__c==null){return null;}else{if(line.hasCostSchedule&&lc.parent.discountScheduleMap[line.costScheduleId].isDiscountTypeSlab()){if(line.actualQuantity==0||line.Quantity__c==0&&line.parentQuote.isRenewal){costQuantity=0;}else{costQuantity=1;}}else if(line.Existing__c||line.CarryoverLine__c){if(!line.isSubscription&&line.actualQuantity<0){costQuantity=0;}else if(line.isDynamicSubscription&&line.ListPrice__c!=0&&line.actualQuantity>=0){costQuantity=line.Quantity__c;}else{costQuantity=line.actualQuantity;}}}return line.NetPrice__c*line.effectiveQuantity-line.UnitCost__c*costQuantity;}function setBlockPrice(lc){var line=lc.line;var isIncludePriorBPAssetRenewal=lc.settings.isIncludePriorBPAssetRenewal;if(line.blockPricingField!=null&&line.blockPricingField!='Quantity'){var blockPricingFieldName=metaDataUtils.getField(metaDataUtils.getObjectType(line),line.blockPricingField,lc.prefix);var customQuantity=line.record[blockPricingFieldName];line.currentQtyListPrice=line.ListPrice__c=calculateBlockPrice(line,customQuantity,true);}else if(line.parentQuote.isAmendment||line.parentQuote.isRenewal&&isIncludePriorBPAssetRenewal){var priorBlockPrice=calculateBlockPrice(line,line.PriorQuantity__c,false)||0;var currentQuantity=line.parentQuote.isAmendment?line.preUpgradeQuantity:line.Quantity__c;if(line.Quantity__c>0){var currentBlockPrice=calculateBlockPrice(line,currentQuantity,true);line.currentQtyListPrice=line.ListPrice__c=currentBlockPrice-priorBlockPrice;if(line.parentQuote.isRenewal&&currentBlockPrice>=priorBlockPrice){line.currentQtyListPrice=currentBlockPrice;}}else{line.currentQtyListPrice=line.ListPrice__c=priorBlockPrice*-1;}}else{var blockPrice=calculateBlockPrice(line,line.Quantity__c,true);if(blockPrice==null){var errorText=lc.settings.getLabelByKey('msg_no_block_price_for_quantity').replace("{0}",line.Product__c);throw new Error(errorText);}line.currentQtyListPrice=line.ListPrice__c=blockPrice;}}function calculateBlockPrice(line,quantity,setBlockPriceId){if(line.Product__r!=null){var currencyCode=line.settings.isMultiCurrencyOrg?line.parentQuote.record["CurrencyIsoCode"]:null;var isVolumeDiscounted=line.isVolumeDiscounted;var bPrice=line.getBlockPriceByQuantity(quantity,currencyCode,isVolumeDiscounted);if(bPrice!=null){var overage=0;var overageField=line.settings.overageRateFieldName;var overageRate=overageField!=null?bPrice[overageField]:null;if(overageRate!=null){overage=overageRate*(quantity-bPrice[line.prefix+"LowerBound__c"]);}if(setBlockPriceId===true){line.BlockPrice__c=bPrice.Id;}return bPrice[line.prefix+"Price__c"]+overage;}}return null;}function calculateProrateMultiplier(lc){if(lc.line.calculateFullTermPrice){lc.prorateMultiplier=1;return;}if(lc.subscription){var startDate=lc.line.effectiveStartDate;var endDate=lc.line.effectiveEndDate;var dividend;var divisor;if(startDate!=null&&endDate!=null){var fullTermEndDate=new Date(startDate.getTime());if(lc.settings.subscriptionTermUnitIsDay){fullTermEndDate.setUTCDate(fullTermEndDate.getUTCDate()+Math.floor(lc.line.defaultTerm));}else{fullTermEndDate.setUTCMonth(fullTermEndDate.getUTCMonth()+Math.floor(lc.line.defaultTerm));}endDate.setUTCDate(endDate.getUTCDate()+1);var divByZeroMsg=lc.settings.getLabelByKey("msg_js_err_prorate_divide_by_zero");if(lc.settings.subscriptionProratePrecision==="month"){dividend=dateUtils.monthsBetweenRoundPartialUp(startDate,endDate);divisor=lc.settings.subscriptionTermUnitIsDay?dateUtils.monthsBetween(startDate,fullTermEndDate):Math.floor(lc.line.defaultTerm);if(divisor!==0){lc.prorateMultiplier=dividend/divisor;}else{throw new Error(divByZeroMsg);}}else if(lc.settings.subscriptionProratePrecision==="month+day"){var monthsBetween=dateUtils.monthsBetween(startDate,endDate);var endDateRounded=dateUtils.addMonths(new Date(startDate),monthsBetween);if(endDateRounded>endDate){monthsBetween--;endDateRounded=dateUtils.addMonths(new Date(startDate),monthsBetween);}var remainder=dateUtils.daysBetween(endDateRounded,endDate);remainder=remainder/(365.0/12.0);dividend=monthsBetween+remainder;divisor=lc.settings.subscriptionTermUnitIsDay?dateUtils.monthsBetween(startDate,fullTermEndDate):Math.floor(lc.line.defaultTerm);if(divisor!==0){lc.prorateMultiplier=dividend/divisor;}else{throw new Error(divByZeroMsg);}}else{dividend=lc.settings.ignoreLeapYearDays?dateUtils.daysBetweenIgnoringLeapYearDays(startDate,endDate):dateUtils.daysBetween(startDate,endDate);divisor=lc.settings.ignoreLeapYearDays&&!lc.settings.subscriptionTermUnitIsDay?dateUtils.daysBetweenIgnoringLeapYearDays(startDate,fullTermEndDate):dateUtils.daysBetween(startDate,fullTermEndDate);if(divisor!==0){lc.prorateMultiplier=dividend/divisor;}else{throw new Error(divByZeroMsg);}}}else{var lineTerm=lc.line.effectiveSubscriptionTerm;if(lineTerm!=null){lc.prorateMultiplier=lineTerm/lc.line.defaultTerm;}}}}function calculateSpecialPrice(lc){var line=lc.line;if(lc.bundled){line.SpecialPrice__c=0;return;}if(line.isPricingMethodCost){var cost=line.UnitCost__c;if(cost==null){cost=0;}line.currentQtySpecialPrice=line.SpecialPrice__c=cost+calculateMarkup(line);}else{if((lc.contractedPriceId!=null||lc.specialPriceType!=null)&&line.SpecialPrice__c!=null){var listPrice=line.ListPrice__c;lc.specialDiscountRate=listPrice!=null&&listPrice!=0&&line.SpecialPrice__c!=null?1-line.SpecialPrice__c/listPrice:0;return;}var specialPrice=line.parentQuote.applyPartnerDiscountFirst?line.PartnerPrice__c:line.ListPrice__c;line.SpecialPrice__c=calculateOptionSpecialPrice(specialPrice,lc);var currentQtySpecialPrice=line.parentQuote.applyPartnerDiscountFirst?line.PartnerPrice__c:line.currentQtyListPrice;line.currentQtySpecialPrice=calculateOptionSpecialPrice(currentQtySpecialPrice,lc);}}function calculateOptionSpecialPrice(specialPrice,lc){var line=lc.line;if(specialPrice!=null&&lc.contractedPriceId==null){if(line.OptionDiscount__c!=null){specialPrice*=1-line.OptionDiscount__c/100;}else if(line.OptionDiscountAmount__c!=null){specialPrice-=line.OptionDiscountAmount__c;}}return specialPrice;}function calculateMarkup(line){if(line.MarkupAmount__c!=null){return line.MarkupAmount__c;}var cost=line.UnitCost__c!=null?line.UnitCost__c:0;var rate=line.parentQuote.MarkupRate__c!=null?line.parentQuote.MarkupRate__c:0;if(line.parentGroup!=null&&line.parentGroup.record[line.prefix+"MarkupRate__c"]!=null){rate=line.parentGroup.record[line.prefix+"MarkupRate__c"];}rate=line.MarkupRate__c!=null?line.MarkupRate__c:rate;return cost*(rate/100);}function applyProration(lc){var line=lc.line;var proratedPrice=null;if(line.parentQuote.applyPartnerDiscountFirst===true){proratedPrice=numberUtils.setScale(line.PartnerPrice__c*(1-lc.specialDiscountRate),lc.unitPriceScale);}else{proratedPrice=numberUtils.setScale(line.SpecialPrice__c*lc.prorateMultiplier,lc.unitPriceScale);}line.ProratedPrice__c=proratedPrice;if(line.renewalPrice!=null){lc.proratedRenewalPrice=numberUtils.setScale(line.renewalPrice*lc.prorateMultiplier,lc.unitPriceScale);}line.ProrateMultiplier__c=lc.prorateMultiplier;}function computeAndSetPriorQuantity(dSchedule,lc){var line=lc.line;var quoteModel=line.parentQuote;if(!(quoteModel.isAmendment||quoteModel.isChangeQuote)&&!line.RenewedAsset__c){line.PriorQuantity__c=null;}if((!quoteModel.isAmendment||line.PriorQuantity__c==null)&&dSchedule.isCrossOrder()&&line.RenewedAsset__c==null&&(!lc.subscription||!quoteModel.isRenewal)){var accountModel=lc.parent.getAccountById(quoteModel.Account__c);if(accountModel!=null){var constraintField=dSchedule.constraintField;var quoteConstraintField=metaDataUtils.getField(metaDataUtils.getObjectType(quoteModel),constraintField,lc.prefix);var constraintValue=constraintField==null?null:quoteModel.record[constraintField];if(constraintValue==null){constraintValue='';}var apq;var spq;if(dSchedule.isCrossProduct()){var pIds=dSchedule.productIds||[];apq=accountModel.getAssetPriorQuantity(pIds,constraintField,quoteConstraintField,constraintValue);spq=accountModel.getSubscriptionPriorQuantity(pIds,constraintField,quoteConstraintField,constraintValue);line.PriorQuantity__c=apq+spq;}else{apq=accountModel.getAssetPriorQuantity([line.Product__c],constraintField,quoteConstraintField,constraintValue);spq=accountModel.getSubscriptionPriorQuantity([line.Product__c],constraintField,quoteConstraintField,constraintValue);line.PriorQuantity__c=apq+spq;}}}}function retrieveLocalQuantity(schedule,line){var lineQuantity;var fieldName=schedule.record[line.settings.devPrefix+"QuoteLineQuantityField__c"];if(fieldName!=null&&fieldName.toLowerCase()!='quantity'){var field=metaDataUtils.getField(metaDataUtils.getObjectType(line),fieldName,line.settings.devPrefix);lineQuantity=line.record[field];}else{lineQuantity=line.Quantity__c;}return lineQuantity;}function retrieveGlobalQuantity(schedule,overrideQSI,lc){var line=lc.line;var qsi;if(overrideQSI!=null){qsi=overrideQSI;}else if(schedule.isIncludeBundled()){qsi=lc.parent.quantitySumIndexIncludingBundled;}else{qsi=lc.parent.quantitySumIndex;}var quoteModel=line.parentQuote;var key;var qid=quoteModel.Id;var sid=IdUtils.convertTo18(schedule.getId(),lc.settings);var pid=IdUtils.convertTo18(line.Product__c,lc.settings);if(schedule.isAggregatedWithinGroup()&&line.parentGroup!=null){var gsik=qid+"_"+line.parentGroup.key+"_"+sid;var gspk=gsik+"_"+pid;key=schedule.isCrossProduct()?gsik:gspk;return qsi[key]||0;}else if(schedule.isAggregatedWithinQuote()||schedule.isAggregatedWithinGroup()){var sik=qid+"_"+sid;var spk=sik+"_"+pid;key=schedule.isCrossProduct()?sik:spk;return qsi[key]||0;}}function retrieveNonAmendmentPrice(schedule,lc,price,isCostSchedule){var result;var blockPriced=lc.pricingMethod===constants.PRICING_METHOD_BLOCK;var line=lc.line;var quoteModel=line.parentQuote;var lineQuantity=retrieveLocalQuantity(schedule,line)||0;var totalQty=line.Optional__c===true?null:isCostSchedule?retrieveGlobalQuantity(schedule,lc.parent.quantitySumIndexForCostSchedules,lc):retrieveGlobalQuantity(schedule,null,lc);totalQty=totalQty||lineQuantity;var volumeQty;if(schedule.usesCustomQuantity()){volumeQty=totalQty;}else{volumeQty=totalQty+(line.PriorQuantity__c||0)+(line.AdditionalQuantity__c||0);}if(quoteModel.isRenewal&&!line.isSubscription&&line.Existing__c===true){volumeQty=lineQuantity;}var vDiscount;if(!lc.bundled){if(!blockPriced){vDiscount=schedule.computeDiscount(volumeQty,lineQuantity,price,quoteModel.CurrencyIsoCode);if(vDiscount!=null&&schedule.isDiscountUnitAmount()){vDiscount=numberUtils.setScale(vDiscount*lc.prorateMultiplier,lc.unitPriceScale);}result=schedule.isDiscountTypeSlab()?price*lineQuantity:price;result=result-(vDiscount||0);}else if(!isCostSchedule){var spilloverQty=spilloverQuantity(schedule,line,true);var proratedOriginalPrice=line.DiscountScheduleType__c=="Slab"&&schedule.isDiscountUnitAmount()&&line.PriorQuantity__c!=null?line.OriginalPrice__c:numberUtils.setScale(line.OriginalPrice__c*lc.prorateMultiplier,lc.unitPriceScale);if(spilloverQty>0){if((line.PriorQuantity__c||0)==0){vDiscount=schedule.computeDiscount(volumeQty,lineQuantity,proratedOriginalPrice,quoteModel.CurrencyIsoCode);}else{vDiscount=schedule.computeDiscount(volumeQty,spilloverQty,proratedOriginalPrice,quoteModel.CurrencyIsoCode);}}else{if(blockPriced){vDiscount=schedule.computeDiscount(lineQuantity,lineQuantity,price,quoteModel.CurrencyIsoCode);}else{vDiscount=schedule.computeDiscount(volumeQty,lineQuantity,price,quoteModel.CurrencyIsoCode);}}vDiscount=vDiscount||0;if(vDiscount!=null&&schedule.isDiscountUnitAmount()){vDiscount=numberUtils.setScale(vDiscount*lc.prorateMultiplier,lc.unitPriceScale);}if(spilloverQty>0&&schedule.isDiscountTypeSlab()&&(line.PriorQuantity__c||0)==0){result=price+spilloverQty*proratedOriginalPrice-vDiscount;}else if(spilloverQty>0&&!schedule.isDiscountTypeSlab()){result=price+spilloverQty*(proratedOriginalPrice-vDiscount);}else{result=price-vDiscount;}}}else{result=0;vDiscount=0;}if(!isCostSchedule){line.DiscountTier__c=schedule.getTierIdForQuantity(volumeQty,quoteModel.CurrencyIsoCode);line.VolumeDiscount__c=vDiscount;}return result;}function spilloverQuantity(schedule,line,isCurrentQuantity){var priorQuantity=line.PriorQuantity__c||0;var lineQuantity=line.Quantity__c;var isAmendment=line.parentQuote.isAmendment;var priorBlockPriceUpperBound;var isPriorQuantityBeyondBlockTiers;var isActualQuantityPositive=line.actualQuantity>=0;var isCrossOrder=schedule.isCrossOrder();var nonAmendmentQuantity=lineQuantity+priorQuantity;var result=0;var priorBlockPrice=line.getBlockPriceByQuantity(priorQuantity,line.parentQuote.CurrencyIsoCode,true);if(priorBlockPrice!=null){priorBlockPriceUpperBound=priorBlockPrice[line.prefix+"UpperBound__c"];isPriorQuantityBeyondBlockTiers=priorQuantity>=priorBlockPrice[line.prefix+"UpperBound__c"];}var nowBlockPriceQuantity=isAmendment?lineQuantity:nonAmendmentQuantity;var nowBlockPrice=line.getBlockPriceByQuantity(nowBlockPriceQuantity,line.parentQuote.CurrencyIsoCode,true);if(nowBlockPrice!=null){var isLineQuantityBeyondBlockTiers=lineQuantity>=nowBlockPrice[line.prefix+"UpperBound__c"];var nowBlockPriceUpperBound=nowBlockPrice[line.prefix+"UpperBound__c"];var isTotalQuantityBeyondBlockTiers=nonAmendmentQuantity>=nowBlockPrice[line.prefix+"UpperBound__c"];if(!isAmendment&&!isTotalQuantityBeyondBlockTiers||isAmendment&&line.actualQuantity==0||nowBlockPriceUpperBound==null){result=0;}else if(isActualQuantityPositive){if(isAmendment&&!isCrossOrder&&isLineQuantityBeyondBlockTiers&&isPriorQuantityBeyondBlockTiers){result=lineQuantity-priorQuantity;}else if(isLineQuantityBeyondBlockTiers&&isCurrentQuantity){result=lineQuantity-nowBlockPriceUpperBound+1;}else if(priorBlockPrice!=null&&isPriorQuantityBeyondBlockTiers&&isLineQuantityBeyondBlockTiers){result=priorQuantity-nowBlockPriceUpperBound+1;}}else{if(isLineQuantityBeyondBlockTiers&&isCurrentQuantity){result=lineQuantity-priorBlockPriceUpperBound+1;}else if(isPriorQuantityBeyondBlockTiers&&!isCurrentQuantity){result=priorQuantity-priorBlockPriceUpperBound+1;}}}if(isAmendment&&lineQuantity==0&&isPriorQuantityBeyondBlockTiers&&!isCurrentQuantity){result=priorQuantity-priorBlockPriceUpperBound+1;}return result;}function computeAmendmentVolumeQuantity(schedule,line,lc){var volumeQty;var quoteLineQuantityFieldName=schedule.record[schedule.prefix+'QuoteLineQuantityField__c'];var quoteLineQuantityField=metaDataUtils.getField(metaDataUtils.getObjectType(line),quoteLineQuantityFieldName,schedule.prefix);if(quoteLineQuantityField!=null&&quoteLineQuantityField!==schedule.prefix+'Quantity__c'){volumeQty=schedule.isCrossProduct()?retrieveGlobalQuantity(schedule,null,lc):line.record[quoteLineQuantityField];}else if(line.actualQuantity<0){volumeQty=schedule.isCrossProduct()?retrieveGlobalQuantity(schedule,lc.parent.priorQuantitySumIndex,lc):line.PriorQuantity__c;}else if(schedule.isCrossOrder()){volumeQty=schedule.isCrossProduct()?retrieveGlobalQuantity(schedule,null,lc):line.Quantity__c;}else{volumeQty=schedule.isCrossProduct()?retrieveGlobalQuantity(schedule,lc.parent.actualQuantitySumIndex,lc):line.actualQuantity;}return volumeQty;}function retrieveSlabAmendmentScheduleInfo(schedule,price,lc){var line=lc.line;var priorQuantity=line.PriorQuantity__c||0;var priorDiscount;var priorPrice;var nowQuantity=line.preUpgradeQuantity||0;var nowDiscount;var nowPrice;var amendmentScheduleInfo={};var currencyCode=line.parentQuote.CurrencyIsoCode;var blockPriced=lc.pricingMethod===constants.PRICING_METHOD_BLOCK;var proratedOriginalPrice=numberUtils.setScale(line.OriginalPrice__c*lc.prorateMultiplier,lc.unitPriceScale);var lowestBound=schedule.getLowestBound(currencyCode);var priorSpilloverQuantity;var nowSpilloverQuantity;if(!lc.bundled){if(blockPriced){priorSpilloverQuantity=spilloverQuantity(schedule,line,false);nowSpilloverQuantity=spilloverQuantity(schedule,line,true);}if(!line.isSubscription&&nowQuantity==0&&!blockPriced){priorDiscount=schedule.computeDiscount(line.PriorQuantity__c,line.PriorQuantity__c,price,currencyCode);priorPrice=price*line.PriorQuantity__c-priorDiscount;amendmentScheduleInfo['tierId']=schedule.getTierIdForQuantity(line.PriorQuantity__c,currencyCode);amendmentScheduleInfo['discount']=priorDiscount;amendmentScheduleInfo['price']=-priorPrice;}else if(schedule.isCrossOrder()||line.actualQuantity<=0){priorDiscount=schedule.computeDiscount(line.PriorQuantity__c,line.PriorQuantity__c,price,currencyCode)||0;nowDiscount=schedule.computeDiscount(nowQuantity,nowQuantity,price,line.parentQuote.CurrencyIsoCode)||0;var prorateAdj=0.0;if(schedule.isDiscountUnitAmount()){prorateAdj=(nowDiscount-priorDiscount)*line.ProrateMultiplier__c;}if(blockPriced){if(line.PriorQuantity__c>=lowestBound&&priorSpilloverQuantity>0){priorDiscount=schedule.computeDiscount(line.PriorQuantity__c,line.PriorQuantity__c,proratedOriginalPrice,currencyCode)||0;}if(nowQuantity>=lowestBound&&nowSpilloverQuantity>0){nowDiscount=schedule.computeDiscount(nowQuantity,nowQuantity,proratedOriginalPrice,line.parentQuote.CurrencyIsoCode)||0;}priorPrice=proratedOriginalPrice*priorSpilloverQuantity-priorDiscount;nowPrice=line.actualQuantity!=0?proratedOriginalPrice*nowSpilloverQuantity-nowDiscount:0;}else{priorPrice=price*priorQuantity;nowPrice=price*nowQuantity;if(!schedule.isDiscountUnitAmount()){priorPrice-=priorDiscount;nowPrice-=nowDiscount;}}nowPrice=blockPriced?nowPrice+price:nowPrice;amendmentScheduleInfo['nowPrice']=nowPrice;nowPrice=line.actualQuantity!=0?nowPrice:0;amendmentScheduleInfo['tierId']=schedule.getTierIdForQuantity(nowQuantity,currencyCode);amendmentScheduleInfo['discount']=nowDiscount;amendmentScheduleInfo['price']=line.actualQuantity!=0?nowPrice-priorPrice-prorateAdj:nowPrice;}else{nowDiscount=schedule.computeDiscount(line.actualQuantity,line.actualQuantity,price,line.parentQuote.CurrencyIsoCode)||0;if(blockPriced){if(line.actualQuantity>=lowestBound&&nowSpilloverQuantity>0){nowDiscount=schedule.computeDiscount(line.actualQuantity,line.actualQuantity,proratedOriginalPrice,line.parentQuote.CurrencyIsoCode)||0;}else if(line.actualQuantity<lowestBound){nowDiscount=0;}nowPrice=proratedOriginalPrice*nowSpilloverQuantity-nowDiscount+price;}else{nowPrice=price*line.actualQuantity-nowDiscount;}amendmentScheduleInfo['tierId']=schedule.getTierIdForQuantity(line.Quantity__c,currencyCode);amendmentScheduleInfo['discount']=nowDiscount;amendmentScheduleInfo['price']=nowPrice;}}else{amendmentScheduleInfo['tierId']=schedule.getTierIdForQuantity(line.Quantity__c,currencyCode);amendmentScheduleInfo['discount']=0;amendmentScheduleInfo['price']=0;}return amendmentScheduleInfo;}function applyCostSchedule(lc){var line=lc.line;var cSchedule=lc.parent.getDiscountScheduleById(line.costScheduleId);var quoteModel=line.parentQuote;var costDiscount;var originalUnitCost=line.OriginalUnitCost__c||0;if(!quoteModel.isAmendment){line.UnitCost__c=retrieveNonAmendmentPrice(cSchedule,lc,originalUnitCost,true);}else if(quoteModel.isAmendment&&!cSchedule.isDiscountTypeSlab()){var volumeQty=computeAmendmentVolumeQuantity(cSchedule,line,lc);costDiscount=cSchedule.computeDiscount(volumeQty,line.actualQuantity,originalUnitCost,quoteModel.CurrencyIsoCode);line.UnitCost__c=originalUnitCost-costDiscount;}else if(quoteModel.isAmendment&&cSchedule.isDiscountTypeSlab()){costDiscount=retrieveSlabAmendmentScheduleInfo(cSchedule,originalUnitCost,lc)["price"];line.UnitCost__c=costDiscount;}}function applyDiscountSchedule(lc){var line=lc.line;var quoteModel=line.parentQuote;var price=0,currentQtyRegularPrice;if(line.ProratedPrice__c){price=line.ProratedPrice__c;}var currencyCode=quoteModel.CurrencyIsoCode;currentQtyRegularPrice=line.currentQtyProratedListPrice;line.RegularPrice__c=price;if(line.CompoundDiscountRate__c!=null){var qty=line.Quantity__c||0;price*=1/Math.pow(qty,line.CompoundDiscountRate__c/100);currentQtyRegularPrice*=1/Math.pow(qty,line.CompoundDiscountRate__c/100);}else if(line.isVolumeDiscounted){price=applyVolumeDiscount(lc,price);currentQtyRegularPrice=applyVolumeDiscount(lc,currentQtyRegularPrice);}if(lc.subscription&&line.isTermDiscounted){var tSchedule=lc.parent.getDiscountScheduleById(line.TermDiscountSchedule__c);if(!tSchedule.isPricebookIdExcluded(line.parentQuote.PricebookId__c)){var termLevel=line.termDiscountLevel||'Line';var term=null;if(termLevel.toLowerCase()==="group"&&line.parentGroup!=null){term=line.parentGroup.calculatedSubscriptionTerm;}else if(termLevel.toLowerCase()==="quote"){term=line.parentQuote.calculatedSubscriptionTerm;}if(term==null){term=line.effectiveSubscriptionTerm;}line.TermDiscountTier__c=tSchedule.getTierIdForQuantity(term,currencyCode);line.TermDiscount__c=tSchedule.computeDiscount(term,null,price,currencyCode);if(line.TermDiscount__c!=null&&tSchedule.isDiscountUnitAmount()){line.TermDiscount__c=line.TermDiscount__c*lc.prorateMultiplier;}if(price!=null&&line.TermDiscount__c!=null){price-=line.TermDiscount__c;currentQtyRegularPrice-=line.TermDiscount__c;}}}line.RegularPrice__c=price||0;line.currentQtyRegularPrice=currentQtyRegularPrice||0;}function applyVolumeDiscount(lc,price){var line=lc.line;var quoteModel=line.parentQuote;var currencyCode=quoteModel.CurrencyIsoCode;var blockPriced=lc.pricingMethod===constants.PRICING_METHOD_BLOCK;var priorSpilloverQuantity=0;var nowSpilloverQuantity=0;var dSchedule=lc.parent.getDiscountScheduleById(line.DiscountSchedule__c);if(blockPriced){priorSpilloverQuantity=spilloverQuantity(dSchedule,line,false);nowSpilloverQuantity=spilloverQuantity(dSchedule,line,true);}if(dSchedule!=null&&!dSchedule.isPricebookIdExcluded(line.parentQuote.PricebookId__c)){if(!dSchedule.hasTiers()){return price;}var vDiscount=0;var volumeQty;line.DiscountScheduleType__c=dSchedule.getType();if(!quoteModel.isAmendment||quoteModel.isAmendment&&line.Existing__c===false&&line.CarryoverLine__c===false){price=retrieveNonAmendmentPrice(dSchedule,lc,price,false);}else if(line.DiscountScheduleType__c==="Slab"&&quoteModel.isAmendment){var scheduleInfo=retrieveSlabAmendmentScheduleInfo(dSchedule,price,lc);line.DiscountTier__c=scheduleInfo["tierId"];line.VolumeDiscount__c=scheduleInfo["discount"];line.amendedSlabFullRegularPrice=scheduleInfo['nowPrice'];price=scheduleInfo["price"];}else if(line.DiscountScheduleType__c==="Range"&&quoteModel.isAmendment){var lowestBound=dSchedule.getLowestBound(currencyCode);volumeQty=computeAmendmentVolumeQuantity(dSchedule,line,lc);vDiscount=dSchedule.computeDiscount(volumeQty,line.actualQuantity,price,currencyCode);var priorSpilloverDiscount;var nowSpilloverDiscount;var proratedOriginalPrice=numberUtils.setScale(line.OriginalPrice__c*lc.prorateMultiplier,lc.unitPriceScale);if(!lc.bundled){if(blockPriced&&line.actualQuantity!=0){if(line.PriorQuantity__c>=lowestBound&&priorSpilloverQuantity>0){priorSpilloverDiscount=dSchedule.computeDiscount(volumeQty,priorSpilloverQuantity,proratedOriginalPrice,currencyCode);}if(line.Quantity__c>=lowestBound&&nowSpilloverQuantity>0){nowSpilloverDiscount=dSchedule.computeDiscount(volumeQty,nowSpilloverQuantity,proratedOriginalPrice,currencyCode);}}line.VolumeDiscount__c=vDiscount;if(dSchedule.isDiscountUnitAmount()){vDiscount=vDiscount!=null?numberUtils.setScale(vDiscount*lc.prorateMultiplier,lc.unitPriceScale):vDiscount;priorSpilloverDiscount=priorSpilloverDiscount!=null?numberUtils.setScale(priorSpilloverDiscount*lc.prorateMultiplier,lc.unitPriceScale):priorSpilloverDiscount;nowSpilloverDiscount=nowSpilloverDiscount!=null?numberUtils.setScale(nowSpilloverDiscount*lc.prorateMultiplier,lc.unitPriceScale):nowSpilloverDiscount;}line.DiscountTier__c=dSchedule.getTierIdForQuantity(volumeQty,currencyCode);var nowPrice;var priorPrice;if(blockPriced&&(nowSpilloverQuantity!=0||priorSpilloverQuantity!=0)){if(dSchedule.isCrossOrder()||line.actualQuantity<0){nowPrice=(proratedOriginalPrice-(nowSpilloverDiscount||0))*nowSpilloverQuantity;priorPrice=(proratedOriginalPrice-(priorSpilloverDiscount||0))*priorSpilloverQuantity;price=nowPrice-priorPrice+price;}else{price=(proratedOriginalPrice-(nowSpilloverDiscount||0))*nowSpilloverQuantity+price;}}else{price=price-(vDiscount||0);}}else{price=0;vDiscount=0;}}if(blockPriced){price=line.actualQuantity!=0?price:0;priorSpilloverQuantity=(dSchedule.isCrossOrder()||line.actualQuantity<0)&&quoteModel.isAmendment?priorSpilloverQuantity:0;line.ListPrice__c=line.ListPrice__c+line.OriginalPrice__c*(nowSpilloverQuantity-priorSpilloverQuantity);line.currentQtyListPrice=line.currentQtyListPrice+line.OriginalPrice__c*(nowSpilloverQuantity-priorSpilloverQuantity);}}return price;}function applyUplift(lc){var line=lc.line;var upliftRate=line.effectiveUplift||0;var prevSegUplift=line.PreviousSegmentUplift__c||null;var prevSegPrice=line.PreviousSegmentPrice__c||null;if(prevSegUplift==null||prevSegPrice==null){line.parentQuote.lineItems.forEach(function(otherLine){var sameDimId=otherLine.Dimension__c!=null&&IdUtils.compareIds(line.Dimension__c,otherLine.Dimension__c,lc.settings);var sameKey=otherLine.SegmentKey__c===line.SegmentKey__c;var previousIndex=otherLine.SegmentIndex__c===line.SegmentIndex__c-1;if(sameDimId&&sameKey&&previousIndex){if(prevSegUplift==null){prevSegUplift=otherLine.UpliftAmount__c;}if(prevSegPrice==null){prevSegPrice=otherLine.RegularPrice__c;}}},this);}if(prevSegUplift==null){prevSegUplift=0;}if(prevSegPrice==null||prevSegPrice==0){line.Uplift__c=upliftRate;line.UpliftAmount__c=0;return;}prevSegUplift=prevSegUplift*(line.RegularPrice__c/(prevSegPrice-prevSegUplift));if(line.isTimeBasedSegment){var upliftedPrice=upliftRate/100*(line.RegularPrice__c+prevSegUplift)+line.RegularPrice__c+prevSegUplift;var currentQtyUpliftedPrice=upliftRate/100*(line.currentQtyRegularPrice+prevSegUplift)+line.currentQtyRegularPrice+prevSegUplift;var amendedSlabFullUpliftedPrice=upliftRate/100*(line.amendedSlabFullRegularPrice+prevSegUplift)+line.amendedSlabFullRegularPrice+prevSegUplift;line.Uplift__c=upliftRate;var upliftAmount=numberUtils.setScale(upliftedPrice,lc.unitPriceScale)-line.RegularPrice__c;upliftAmount=numberUtils.setScale(upliftAmount,lc.unitPriceScale);line.UpliftAmount__c=upliftAmount;line.RegularPrice__c=numberUtils.setScale(upliftedPrice,lc.unitPriceScale);line.amendedSlabFullRegularPrice=numberUtils.setScale(amendedSlabFullUpliftedPrice,lc.unitPriceScale);}else{line.Uplift__c=upliftRate;}}function applyAdditionalDiscount(lc){if(lc.pricingMethod===constants.PRICING_METHOD_CUSTOM){return;}var line=lc.line;var price=void 0,currentQtyCustomerPrice=void 0,amendedSlabFullCustomerPrice=void 0;if(line.parentQuote.applyAdditionalDiscountLast&&!line.parentQuote.applyPartnerDiscountFirst){price=line.NetPrice__c;currentQtyCustomerPrice=line.currentQtyNetPrice;amendedSlabFullCustomerPrice=line.amendedSlabFullNetPrice;}else{price=line.RegularPrice__c;currentQtyCustomerPrice=line.currentQtyRegularPrice;amendedSlabFullCustomerPrice=line.amendedSlabFullRegularPrice;}if(line.targetCustomerAmount!=null){line.AdditionalDiscountAmount__c=price-line.targetCustomerAmount;}else if(line.targetCustomerTotal!=null){line.AdditionalDiscountAmount__c=price-line.targetCustomerTotal/line.effectiveQuantity;}if(line.amountDiscountProrated&&(line.targetCustomerAmount||line.targetCustomerTotal)){line.AdditionalDiscountAmount__c/=lc.prorateMultiplier;line.AdditionalDiscountAmount__c=numberUtils.setScale(line.AdditionalDiscountAmount__c,lc.unitPriceScale);}if(line.renewalPrice!=null&&!line.isDynamicSubscription){if(line.amountDiscountProrated&&line.isSubscription){line.AdditionalDiscountAmount__c=line.RegularPrice__c/lc.prorateMultiplier-line.renewalPrice;}else{line.AdditionalDiscountAmount__c=line.RegularPrice__c-lc.proratedRenewalPrice;}if(line.AdditionalDiscountAmount__c===0){line.AdditionalDiscountAmount__c=null;}else{line.Discount__c=null;}}var discount=0;var amendedSlabDiscount=0;if(line.isDiscountable){if(line.AdditionalDiscountAmount__c!=null){discount=numberUtils.setScale(line.AdditionalDiscountAmount__c,lc.unitPriceScale)*(line.amountDiscountProrated?lc.prorateMultiplier:1);}else{var rate=null;if(line.parentItem!=null&&line.isComponentDiscountedByPackage){rate=line.parentItem.effectiveAdditionalDiscountRate;line.Discount__c=rate;}else{rate=line.effectiveAdditionalDiscountRate;}discount=rate==null?0:price*(rate/100);amendedSlabDiscount=rate==null?0:amendedSlabFullCustomerPrice*(rate/100);}}line.renewalPrice=null;line.CustomerPrice__c=numberUtils.setScale((price||0)-(discount||0),lc.unitPriceScale);line.currentQtyCustomerPrice=numberUtils.setScale((currentQtyCustomerPrice||0)-(discount||0),lc.unitPriceScale);line.amendedSlabFullCustomerPrice=numberUtils.setScale((amendedSlabFullCustomerPrice||0)-(amendedSlabDiscount||0),lc.unitPriceScale);}function applyDistributorDiscount(lc){var line=lc.line;var parent=line.parentQuote;var price=void 0,currentQtyNetPrice=void 0,amendedSlabFullNetPrice=void 0;if(parent.applyPartnerDiscountFirst){price=line.CustomerPrice__c;currentQtyNetPrice=line.currentQtyCustomerPrice;amendedSlabFullNetPrice=line.amendedSlabFullCustomerPrice;}else if(parent.channelDiscountsOffList){price=line.ProratedListPrice__c;currentQtyNetPrice=line.currentQtyProratedListPrice;}else{price=line.PartnerPrice__c;currentQtyNetPrice=line.currentQtyPartnerPrice;amendedSlabFullNetPrice=line.amendedSlabFullPartnerPrice;}var rate=0;if(lc.partnerDiscountable===true){rate=parent.DistributorDiscount__c!=null?parent.DistributorDiscount__c:0;rate=line.DistributorDiscount__c!=null?line.DistributorDiscount__c:rate;}line.currentQtyNetPrice=numberUtils.setScale(currentQtyNetPrice*(1-rate/100),lc.unitPriceScale);line.amendedSlabFullNetPrice=numberUtils.setScale(amendedSlabFullNetPrice*(1-rate/100),lc.unitPriceScale);if(!parent.channelDiscountsOffList){line.NetPrice__c=numberUtils.setScale(price*(1-rate/100),lc.unitPriceScale);}else{var distributorDiscountAmountOffList=price*(rate/100);line.NetPrice__c=numberUtils.setScale(line.PartnerPrice__c-distributorDiscountAmountOffList,lc.unitPriceScale);}}function applyPartnerDiscount(lc){var line=lc.line;var parent=line.parentQuote;var price=void 0,currentQtyPartnerPrice=void 0,amendedSlabFullPartnerPrice=void 0;if(parent.applyPartnerDiscountFirst||parent.channelDiscountsOffList){price=line.ProratedListPrice__c;currentQtyPartnerPrice=line.currentQtyProratedListPrice;}else if(parent.applyAdditionalDiscountLast){price=line.RegularPrice__c;currentQtyPartnerPrice=line.currentQtyRegularPrice;amendedSlabFullPartnerPrice=line.amendedSlabFullRegularPrice;}else{price=line.CustomerPrice__c;currentQtyPartnerPrice=line.currentQtyCustomerPrice;amendedSlabFullPartnerPrice=line.amendedSlabFullCustomerPrice;}var rate=0;if(lc.partnerDiscountable===true){rate=parent.PartnerDiscount__c!=null?parent.PartnerDiscount__c:0;rate=line.PartnerDiscount__c!=null?line.PartnerDiscount__c:rate;}if(parent.applyPartnerDiscountFirst&&lc.bundled){price=0;}line.currentQtyPartnerPrice=numberUtils.setScale(currentQtyPartnerPrice*(1-rate/100),lc.unitPriceScale);line.amendedSlabFullPartnerPrice=numberUtils.setScale(amendedSlabFullPartnerPrice*(1-rate/100),lc.unitPriceScale);if(!parent.channelDiscountsOffList){line.PartnerPrice__c=numberUtils.setScale(price*(1-rate/100),lc.unitPriceScale);}else{var partnerDiscountAmountOffList=price*(rate/100);line.PartnerPrice__c=numberUtils.setScale(line.CustomerPrice__c-partnerDiscountAmountOffList,lc.unitPriceScale);}}module.exports=LineCalculator;},{"../Utils/DateUtils.js":1,"../Utils/NumberUtils.js":2,"./Utils/IdUtils.js":31,"./Utils/JSQCConstants.js":32,"./Utils/MetaDataUtils.js":33}],11:[function(require,module,exports){var CONSTANTS=require("./Utils/JSQCConstants.js");var OperatorsUtils=require("./Utils/OperatorsUtils.js");var MetaDataUtils=require('./Utils/MetaDataUtils.js');var LookupTableMap=function(){function LookupTableMap(rulesToExecute,quote,metadataIndex){_classCallCheck2(this,LookupTableMap);this.tableInfoByName={};if(rulesToExecute==null&&quote==null&&metadataIndex==null){return;}for(var ruleId in rulesToExecute){var rule=rulesToExecute[ruleId].rule;var targets=rulesToExecute[ruleId].targets;if(rule.lookupObject&&rule.queries.length!=0){var lookupObject=rule.lookupObject;var lookupInfo=this.tableInfoByName[lookupObject]||new TableInfo(lookupObject,metadataIndex);lookupInfo._addRuleConstraints(rule,targets,quote);this.tableInfoByName[lookupObject]=lookupInfo;}}}_createClass(LookupTableMap,[{key:"toJson",value:function toJson(){var tableJson={};for(var tableName in this.tableInfoByName){var table=this.tableInfoByName[tableName];if(table.tableHasSatisfiableConstraintSets){tableJson[tableName]=table._toJson();}}return{tableInfoByName:tableJson};}},{key:"returnTablesWithConstraintsNotCoveredBy",value:function returnTablesWithConstraintsNotCoveredBy(priorQueryMap){var uncachedTableInfoByName={};for(var tableName in this.tableInfoByName){var priorQueriesOnTable=priorQueryMap[tableName];if(priorQueriesOnTable==null||priorQueriesOnTable.length==0){uncachedTableInfoByName[tableName]=this.tableInfoByName[tableName];}else{var filteredTable=this.tableInfoByName[tableName]._returnCopyWithoutSubsetsOf(priorQueriesOnTable);if(filteredTable.tableHasSatisfiableConstraintSets){uncachedTableInfoByName[tableName]=filteredTable;}}}var uncachedTableMap=new LookupTableMap();uncachedTableMap.tableInfoByName=uncachedTableInfoByName;return uncachedTableMap;}},{key:"containsSatisfiableTables",get:function get(){for(var tableName in this.tableInfoByName){if(this.tableInfoByName[tableName].tableHasSatisfiableConstraintSets){return true;}}return false;}}]);return LookupTableMap;}();var TableInfo=function(){function TableInfo(lookupObject,metadataIndex){_classCallCheck2(this,TableInfo);this.constraintSetsByRuleId={};this.tableHasSatisfiableConstraintSets=false;this.referencedFields=[];if(lookupObject&&metadataIndex){this.referencedFields=metadataIndex.getAllFieldNamesOnObject(lookupObject);}}_createClass(TableInfo,[{key:"_addRuleConstraints",value:function _addRuleConstraints(rule,targets,quote){var ruleId=rule.id;var newConstraints=new FieldConstraintSetForOneRule(rule.queries,targets,quote);if(!newConstraints.globallyUnsatisfiable){this.constraintSetsByRuleId[ruleId]=newConstraints;this.tableHasSatisfiableConstraintSets=true;}}},{key:"_toJson",value:function _toJson(){if(this.tableHasSatisfiableConstraintSets){var constraintSetJsons={};for(var ruleId in this.constraintSetsByRuleId){constraintSetJsons[ruleId]=this.constraintSetsByRuleId[ruleId]._toJson();}return{referencedFields:this.referencedFields,constraintSetsByRuleId:constraintSetJsons};}else{return{};}}},{key:"_returnCopyWithoutSubsetsOf",value:function _returnCopyWithoutSubsetsOf(priorConstraintList){var filteredConstraintSets={};var someConstraintsNotSubsets=false;for(var ruleId in this.constraintSetsByRuleId){var copiedRuleConstraint=this.constraintSetsByRuleId[ruleId]._removeSubsetsOfPriorConstraints(priorConstraintList);if(!copiedRuleConstraint.globallyUnsatisfiable){someConstraintsNotSubsets=true;filteredConstraintSets[ruleId]=copiedRuleConstraint;}}var copiedTable=new TableInfo();copiedTable.referencedFields=this.referencedFields;copiedTable.constraintSetsByRuleId=filteredConstraintSets;copiedTable.tableHasSatisfiableConstraintSets=someConstraintsNotSubsets;return copiedTable;}},{key:"_constraintSetList",get:function get(){var constraintList=[];for(var ruleId in this.constraintSetsByRuleId){var combinedSetMap=this.constraintSetsByRuleId[ruleId].combinedConstraintSetsByKey;for(var lineKey in combinedSetMap){constraintList.push(combinedSetMap[lineKey]);}}return constraintList;}}]);return TableInfo;}();var FieldConstraintSetForOneRule=function(){function FieldConstraintSetForOneRule(queries,targets,quote){_classCallCheck2(this,FieldConstraintSetForOneRule);this.globalConstraintsByField={};this.lineConstraintsByFieldByKey={};this.globallyUnsatisfiable=false;this.combinedConstraintSetsByKey={};if(queries==null&&targets==null&&quote==null){return;}var globalConstraintsExist=false;var queryCount=queries.length;var lineQueries=[];for(var i=0;i<queryCount;i++){var query=queries[i];var matchType=query.matchType.toLowerCase();var matchIsGlobal=matchType==='static value'||matchType==='field value'&&query.testedObject.toLowerCase()==='quote';if(matchIsGlobal){var globalLookupField=query.lookupField;var existingGlobalConstraint=this.globalConstraintsByField[globalLookupField]||new FieldConstraint();var testedGlobalValue;if(matchType==='static value'){testedGlobalValue=query.testedValue;}else{var testedQuoteField=MetaDataUtils.getField('quote',query.testedField,quote.prefix);if(testedQuoteField!=null){testedGlobalValue=quote.record[testedQuoteField];}}if(testedGlobalValue!=null){var globalOperator=OperatorsUtils.getInverseInstance(query.operator);existingGlobalConstraint._addConstraint(globalOperator.opType,testedGlobalValue);if(existingGlobalConstraint.cannotReturnRows){this.globallyUnsatisfiable=true;return;}globalConstraintsExist=true;this.globalConstraintsByField[globalLookupField]=existingGlobalConstraint;}}else{lineQueries.push(query);}}var lineQueryCount=lineQueries.length;var lineCount=targets.length;if(lineQueryCount===0){if(globalConstraintsExist){this.combinedConstraintSetsByKey['GLOBAL']=this.globalConstraintsByField;}else{this.globallyUnsatisfiable=true;return;}}else{var noLinesSatisfiable=true;for(var j=0;j<lineCount;j++){var line=targets[j];var lineKey=line.key;var lineConstraintsByField={};var lineSatisfiable=true;for(var k=0;k<lineQueryCount;k++){var lineQuery=lineQueries[k];var lineLookupField=lineQuery.lookupField;var existingLineConstraint=lineConstraintsByField[lineLookupField]||new FieldConstraint();var testedLineField=MetaDataUtils.getField('quote line',lineQuery.testedField,line.prefix);var testedLineValue;if(testedLineField!=null){testedLineValue=line.record[testedLineField];}var lineOperator=OperatorsUtils.getInverseInstance(lineQuery.operator);existingLineConstraint._addConstraint(lineOperator.opType,testedLineValue);if(existingLineConstraint.cannotReturnRows){lineSatisfiable=false;break;}lineConstraintsByField[lineLookupField]=existingLineConstraint;}if(lineSatisfiable){var combinedConstraints={};for(var globalField in this.globalConstraintsByField){combinedConstraints[globalField]=new FieldConstraint(this.globalConstraintsByField[globalField]);}var combinationIsSatisfiable=true;for(var lineFieldName in lineConstraintsByField){if(combinedConstraints[lineFieldName]){var lineGlobalCombination=lineConstraintsByField[lineFieldName]._combineWith(combinedConstraints[lineFieldName]);if(lineGlobalCombination.cannotReturnRows){combinationIsSatisfiable=false;break;}else{combinedConstraints[lineFieldName]=lineGlobalCombination;}}else{combinedConstraints[lineFieldName]=lineConstraintsByField[lineFieldName];}}if(combinationIsSatisfiable){this.combinedConstraintSetsByKey[lineKey]=combinedConstraints;this.lineConstraintsByFieldByKey[lineKey]=lineConstraintsByField;noLinesSatisfiable=false;}}}this.globallyUnsatisfiable=noLinesSatisfiable;}}_createClass(FieldConstraintSetForOneRule,[{key:"_toJson",value:function _toJson(){if(this.globallyUnsatisfiable){return{};}else{var jsonGlobalConstraints={};for(var globalField in this.globalConstraintsByField){jsonGlobalConstraints[globalField]=this.globalConstraintsByField[globalField]._toJson();}var jsonLineByFieldByKey={};for(var lineKey in this.lineConstraintsByFieldByKey){var lineConstraintsByField=this.lineConstraintsByFieldByKey[lineKey];var jsonLineByField={};for(var lineField in lineConstraintsByField){jsonLineByField[lineField]=lineConstraintsByField[lineField]._toJson();}jsonLineByFieldByKey[lineKey]=jsonLineByField;}return{globalConstraintsByField:jsonGlobalConstraints,lineConstraintsByFieldByKey:jsonLineByFieldByKey};}}},{key:"_removeSubsetsOfPriorConstraints",value:function _removeSubsetsOfPriorConstraints(priorConstraintList){var filteredGlobals=this.globalConstraintsByField;var filteredLines={};var filteredCombined={};var filteredHasNothing=true;if(this.combinedConstraintSetsByKey['GLOBAL']){if(!isMapContainedByPriorConstraints(this.combinedConstraintSetsByKey['GLOBAL'])){filteredCombined=this.combinedConstraintSetsByKey;filteredHasNothing=false;}}else{for(var lineKey in this.combinedConstraintSetsByKey){var lineConstraintMap=this.combinedConstraintSetsByKey[lineKey];if(!isMapContainedByPriorConstraints(lineConstraintMap)){filteredLines[lineKey]=this.lineConstraintsByFieldByKey[lineKey];filteredCombined[lineKey]=lineConstraintMap;filteredHasNothing=false;}}}var filteredConstraintSet=new FieldConstraintSetForOneRule();filteredConstraintSet.globalConstraintsByField=filteredGlobals;filteredConstraintSet.lineConstraintsByFieldByKey=filteredLines;filteredConstraintSet.combinedConstraintSetsByKey=filteredCombined;filteredConstraintSet.globallyUnsatisfiable=filteredHasNothing;return filteredConstraintSet;function isMapContainedByPriorConstraints(m){var priorConstraintCount=priorConstraintList.length;for(var i=0;i<priorConstraintCount;i++){var priorConstraint=priorConstraintList[i];if(isMap1SubsetOfMap2(m,priorConstraint)){return true;}}return false;}function isMap1SubsetOfMap2(map1,map2){for(var fieldName in map2){var map2Constraint=map2[fieldName];var map1Constraint=map1[fieldName];if(map1Constraint==null||!map1Constraint._isSubsetOf(map2Constraint)){return false;}}return true;}}}]);return FieldConstraintSetForOneRule;}();var FieldConstraint=function(){function FieldConstraint(originalConstraint){_classCallCheck2(this,FieldConstraint);this.eq=originalConstraint?originalConstraint.eq:null;this.neq=[];if(originalConstraint&&originalConstraint.neq.length!=0){var originalNeqCount=originalConstraint.neq.length;for(var i=0;i<originalNeqCount;i++){this.neq.push(originalConstraint.neq[i]);}}this.lt=originalConstraint?originalConstraint.lt:null;this.lte=originalConstraint?originalConstraint.lte:null;this.gt=originalConstraint?originalConstraint.gt:null;this.gte=originalConstraint?originalConstraint.gte:null;this.cannotReturnRows=false;}_createClass(FieldConstraint,[{key:"_toJson",value:function _toJson(){return{eq:this.eq,neq:this.neq,lt:this.lt,lte:this.lte,gt:this.gt,gte:this.gte};}},{key:"_addConstraint",value:function _addConstraint(opType,value){if(this.cannotReturnRows||value==null){this.cannotReturnRows=true;return;}switch(opType){case CONSTANTS.OP_EQ:if(this.eq!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_NEQ).evaluate(this.eq,value)){this.cannotReturnRows=true;return;}if(this.neq.length!=0){var neqCount=this.neq.length;for(var i=0;i<neqCount;i++){if(OperatorsUtils.getInstance(CONSTANTS.OP_EQ).evaluate(this.neq[i],value)){this.cannotReturnRows=true;return;}}}this.eq=value;this.cannotReturnRows=this._boundsAreViolated;return;case CONSTANTS.OP_NEQ:var conflictsWithTrueEquals=this.eq!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_EQ).evaluate(this.eq,value);var conflictsWithImpliedEquals=this._lteEqualsGte&&OperatorsUtils.getInstance(CONSTANTS.OP_EQ).evaluate(this.lte,value);this.neq.push(value);this.cannotReturnRows=conflictsWithTrueEquals||conflictsWithImpliedEquals;return;case CONSTANTS.OP_LT:if(this.lt!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_LTE).evaluate(this.lt,value)){return;}else if(this.lte!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_LT).evaluate(this.lte,value)){return;}this.lt=value;this.lte=null;this.cannotReturnRows=this._boundsAreViolated;return;case CONSTANTS.OP_LTE:var effectiveUpperBound=this.lt!=null?this.lt:this.lte;if(effectiveUpperBound!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_LT).evaluate(effectiveUpperBound,value)){return;}this.lt=null;this.lte=value;this.cannotReturnRows=this._boundsAreViolated;return;case CONSTANTS.OP_GT:if(this.gt!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_GTE).evaluate(this.gt,value)){return;}else if(this.gte!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_GT).evaluate(this.gte,value)){return;}this.gt=value;this.gte=null;this.cannotReturnRows=this._boundsAreViolated;return;case CONSTANTS.OP_GTE:var effectiveLowerBound=this.gt!=null?this.gt:this.gte;if(effectiveLowerBound!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_GT).evaluate(effectiveLowerBound,value)){return;}this.gt=null;this.gte=value;this.cannotReturnRows=this._boundsAreViolated;return;default:throw new Error();}}},{key:"_combineWith",value:function _combineWith(otherConstraint){var combination=new FieldConstraint(otherConstraint);if(this.eq!=null){combination._addConstraint(CONSTANTS.OP_EQ,this.eq);}if(this.neq.length!=0){this.neq.forEach(function(n){combination._addConstraint(CONSTANTS.OP_NEQ,n);});}if(this.lt!=null){combination._addConstraint(CONSTANTS.OP_LT,this.lt);}if(this.lte!=null){combination._addConstraint(CONSTANTS.OP_LTE,this.lte);}if(this.gt!=null){combination._addConstraint(CONSTANTS.OP_GT,this.gt);}if(this.gte!=null){combination._addConstraint(CONSTANTS.OP_GTE,this.gte);}return combination;}},{key:"_isSubsetOf",value:function _isSubsetOf(otherConstraint){if(otherConstraint.eq!=null){var sharedEquals=this.eq!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_EQ).evaluate(this.eq,otherConstraint.eq);var sharedLte=this.lte!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_EQ).evaluate(this.lte,otherConstraint.eq);var sharedGte=this.gte!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_EQ).evaluate(this.gte,otherConstraint.eq);if(!sharedEquals&&(!sharedLte||!sharedGte)){return false;}}if(otherConstraint.neq.length!=0){if(this.neq.length<otherConstraint.neq.length){return false;}var neqMap={};this.neq.forEach(function(n){neqMap[n]=true;});var otherNeqCount=otherConstraint.neq.length;for(var i=0;i<otherNeqCount;i++){var otherN=otherConstraint.neq[i];if(!neqMap[otherN]){return false;}}}if(otherConstraint.lt!=null){var myLtIsBigger=this.lt==null||OperatorsUtils.getInstance(CONSTANTS.OP_GT).evaluate(this.lt,otherConstraint.lt);var myLteNotSmaller=this.lte==null||OperatorsUtils.getInstance(CONSTANTS.OP_GTE).evaluate(this.lte,otherConstraint.lt);var myEqNotSmaller=this.eq==null||OperatorsUtils.getInstance(CONSTANTS.OP_GTE).evaluate(this.eq,otherConstraint.lt);if(myLtIsBigger&&myLteNotSmaller&&myEqNotSmaller){return false;}}if(otherConstraint.lte!=null){var upperBound=this.lt!=null?this.lt:this.lte;var upperBoundIsSmaller=upperBound!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_LTE).evaluate(upperBound,otherConstraint.lte);var myEqBelowUpperBound=this.eq!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_LTE).evaluate(this.eq,otherConstraint.lte);if(!upperBoundIsSmaller&&!myEqBelowUpperBound){return false;}}if(otherConstraint.gt!=null){var myGtIsSmaller=this.gt==null||OperatorsUtils.getInstance(CONSTANTS.OP_LT).evaluate(this.gt,otherConstraint.gt);var myGteNotBigger=this.gte==null||OperatorsUtils.getInstance(CONSTANTS.OP_LTE).evaluate(this.gte,otherConstraint.gt);var myEqNotBigger=this.eq==null||OperatorsUtils.getInstance(CONSTANTS.OP_LTE).evaluate(this.eq,otherConstraint.gt);if(myGtIsSmaller&&myGteNotBigger&&myEqNotBigger){return false;}}if(otherConstraint.gte!=null){var lowerBound=this.gt!=null?this.gt:this.gte;var lowerBoundIsGreater=lowerBound!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_GTE).evaluate(lowerBound,otherConstraint.gte);var myEqAboveLowerBound=this.eq!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_GTE).evaluate(this.eq,otherConstraint.gte);if(!lowerBoundIsGreater&&!myEqAboveLowerBound){return false;}}return true;}},{key:"_lteEqualsGte",get:function get(){return this.lte!=null&&this.gte!=null&&OperatorsUtils.getInstance(CONSTANTS.OP_EQ).evaluate(this.lte,this.gte);}},{key:"_boundsAreViolated",get:function get(){var effectiveUpperBound=this.lt!=null?this.lt:this.lte;var upperIsInclusive=this.lt==null&&effectiveUpperBound!=null;var effectiveLowerBound=this.gt!=null?this.gt:this.gte;var lowerIsInclusive=this.gt==null&&effectiveLowerBound!=null;if(effectiveUpperBound!=null){if(effectiveLowerBound!=null){var bothInclusive=upperIsInclusive&&lowerIsInclusive;var boundComparator=OperatorsUtils.getInstance(bothInclusive?CONSTANTS.OP_LTE:CONSTANTS.OP_LT);if(!boundComparator.evaluate(effectiveLowerBound,effectiveUpperBound)){return true;}}if(this.eq!=null){var upperEqComparator=OperatorsUtils.getInstance(upperIsInclusive?CONSTANTS.OP_LTE:CONSTANTS.OP_LT);if(!upperEqComparator.evaluate(this.eq,effectiveUpperBound)){return true;}}}if(effectiveLowerBound!=null&&this.eq!=null){var lowerEqComparator=OperatorsUtils.getInstance(lowerIsInclusive?CONSTANTS.OP_LTE:CONSTANTS.OP_LT);if(!lowerEqComparator.evaluate(effectiveLowerBound,this.eq)){return true;}}return false;}}]);return FieldConstraint;}();module.exports=LookupTableMap;},{"./Utils/JSQCConstants.js":32,"./Utils/MetaDataUtils.js":33,"./Utils/OperatorsUtils.js":36}],12:[function(require,module,exports){"use strict";var DateUtils=require('../Utils/DateUtils.js');var MDQSegmentHelper=function(){function MDQSegmentHelper(quote,settings){_classCallCheck2(this,MDQSegmentHelper);this.MONTHLY_DIM='Month';this.YEARLY_DIM='Year';this.QUARTERLY_DIM='Quarter';this.quote=quote;this.settings=settings;this.prefix=settings.developerPrefix;this.START_DATE_FIELD=this.prefix+'StartDate__c';this.END_DATE_FIELD=this.prefix+'EndDate__c';this.SUBSCRIPTION_TERM_FIELD=this.prefix+'SubscriptionTerm__c';this.LINES_GROUPED_FIELD=this.prefix+'LineItemsGrouped__c';this.SEGMENT_KEY_FIELD=this.prefix+'SegmentKey__c';this.SEGMENT_INDEX_FIELD=this.prefix+'SegmentIndex__c';this.SEGMENT_LABEL_FIELD=this.prefix+'SegmentLabel__c';this.FIRST_SEGMENT_END_DATE_FIELD=this.prefix+'FirstSegmentTermEndDate__c';this.TYPE_FIELD=this.prefix+'Type__c';this.EXISTING_FIELD=this.prefix+'Existing__c';}_createClass(MDQSegmentHelper,[{key:"updateSegments",value:function updateSegments(){var quote=this.quote;if(this._hasMultiSegmentLines(quote)){if(quote.grouped||quote.record[this.LINES_GROUPED_FIELD]){quote.lineItemGroups.forEach(function(group){this._adjustSegments(quote,group);},this);}else{this._adjustSegments(quote,null);}}}},{key:"_hasMultiSegmentLines",value:function _hasMultiSegmentLines(obj){var lineCount=obj.lineItems.length;for(var i=0;i<lineCount;i++){if(obj.lineItems[i].record[this.SEGMENT_KEY_FIELD]!=null){return true;}}return false;}},{key:"_adjustSegments",value:function _adjustSegments(quote,group){var term=this._calculateSubscriptionTerm(quote,group);var lines=group?quote.lineItems.filter(function(line){return line.parentGroupKey===group.key;}.bind(this)):quote.lineItems;this._calculateSegmentDeltasAndModifySegments(quote,group,lines,term,this.YEARLY_DIM);this._calculateSegmentDeltasAndModifySegments(quote,group,lines,term,this.MONTHLY_DIM);this._calculateSegmentDeltasAndModifySegments(quote,group,lines,term,this.QUARTERLY_DIM);}},{key:"_calculateSubscriptionTerm",value:function _calculateSubscriptionTerm(quote,group){var startDateFieldValue=group?group.record[this.START_DATE_FIELD]||quote.record[this.START_DATE_FIELD]:quote.record[this.START_DATE_FIELD];var endDateFieldValue=group?group.record[this.END_DATE_FIELD]||quote.record[this.END_DATE_FIELD]:quote.record[this.END_DATE_FIELD];var subscriptionTermValue=group&&group.record[this.SUBSCRIPTION_TERM_FIELD]!=null?group.record[this.SUBSCRIPTION_TERM_FIELD]:quote.record[this.SUBSCRIPTION_TERM_FIELD];var startDate=startDateFieldValue?new Date(startDateFieldValue):null;var endDate=endDateFieldValue?new Date(endDateFieldValue):null;var firstSegEndDateFieldValue=quote.record[this.FIRST_SEGMENT_END_DATE_FIELD];var firstSegEndDate=firstSegEndDateFieldValue?new Date(firstSegEndDateFieldValue):null;if(firstSegEndDate){startDate=startDate?startDate:new Date();if(!endDate){endDate=new Date(startDate.getTime());if(this.settings.subscriptionTermUnitIsDay){endDate.setUTCDate(endDate.getUTCDate()+subscriptionTermValue-1);}else{DateUtils.addMonths(endDate,subscriptionTermValue);endDate.setUTCDate(endDate.getUTCDate()-1);}}var firstSegPlusOneDay=new Date(firstSegEndDate.getTime());firstSegPlusOneDay.setUTCDate(firstSegPlusOneDay.getUTCDate()+1);endDate.setDate(endDate.getDate()+1);if(this.settings.subscriptionTermUnitIsDay){return DateUtils.daysBetween(firstSegPlusOneDay,endDate);}else{return DateUtils.monthsBetweenRoundPartialUp(firstSegPlusOneDay,endDate);}}else if(startDate&&endDate){endDate.setDate(endDate.getDate()+1);if(this.settings.subscriptionTermUnitIsDay){return DateUtils.daysBetween(startDate,endDate);}else{return DateUtils.monthsBetweenRoundPartialUp(startDate,endDate);}}else{return subscriptionTermValue;}}},{key:"_calculateSegmentDeltasAndModifySegments",value:function _calculateSegmentDeltasAndModifySegments(quote,group,lines,term,dimType){var segmentDeltasBySegmentKey=this._calculateSegmentDeltas(quote,lines,term,dimType);if(segmentDeltasBySegmentKey.size!=0){this._modifySegmentsBasedOnDelta(quote,group,segmentDeltasBySegmentKey,dimType);}}},{key:"_calculateSegmentDeltas",value:function _calculateSegmentDeltas(quote,lines,term,dimType){var termIsDay=this.settings.subscriptionTermUnitIsDay;term=term==null?termIsDay?365:12:term;var segmentCountsBySegmentKey=mapSegmentCountsBySegmentKeys.bind(this)();var trueSegmentCount=determineDesiredNumberOfSegments.bind(this)();var segmentDeltasBySegmentKey=new Map();segmentCountsBySegmentKey.forEach(function(currentSegCount,segKey){segmentDeltasBySegmentKey.set(segKey,trueSegmentCount-currentSegCount);});return segmentDeltasBySegmentKey;function mapSegmentCountsBySegmentKeys(){var segmentCountsBySegmentKey=new Map();var lineCount=lines.length;for(var i=0;i<lineCount;i++){var line=lines[i];if(line.dimensionType==dimType){var lineSegKey=line.record[this.SEGMENT_KEY_FIELD];var currentSegCount=segmentCountsBySegmentKey.get(lineSegKey)||0;segmentCountsBySegmentKey.set(lineSegKey,currentSegCount+1);}}return segmentCountsBySegmentKey;}function determineDesiredNumberOfSegments(){var trueSegmentCount=0;var firstSegEndDateFieldValue=quote.record[this.FIRST_SEGMENT_END_DATE_FIELD];var firstSegEndDate=firstSegEndDateFieldValue?new Date(firstSegEndDateFieldValue):null;if(firstSegEndDate){trueSegmentCount=1;var firstSegPlusOneDay=new Date(firstSegEndDate.getTime());firstSegPlusOneDay.setUTCDate(firstSegPlusOneDay.getUTCDate()+1);}if(termIsDay){var termStartDate=firstSegPlusOneDay?firstSegPlusOneDay:new Date(this.quote.record[this.START_DATE_FIELD]);var quoteEndDate=this.quote.record[this.END_DATE_FIELD]?new Date(this.quote.record[this.END_DATE_FIELD]):new Date(termStartDate.setUTCDate(termStartDate.getUTCDate()+term));term=DateUtils.monthsBetween(termStartDate,quoteEndDate);termStartDate.setUTCMonth(termStartDate.getUTCMonth()+term);termStartDate.setUTCDate(termStartDate.getUTCDate()-1);if(termStartDate<quoteEndDate){term+=1;}}switch(dimType){case this.YEARLY_DIM:trueSegmentCount+=Math.ceil(term/12);break;case this.QUARTERLY_DIM:trueSegmentCount+=Math.ceil(term/3);break;case this.MONTHLY_DIM:trueSegmentCount+=term;}return trueSegmentCount;}}},{key:"_modifySegmentsBasedOnDelta",value:function _modifySegmentsBasedOnDelta(quote,group,deltaMap,dimType){deltaMap.forEach(function(delta,segmentKey){var lastSegment=this._getLastSegmentFromQuote(quote,segmentKey,dimType);var noDelta=delta===0;var amendmentLine=quote.record[this.TYPE_FIELD]==='Amendment'&&lastSegment.record[this.EXISTING_FIELD];var lastSegStartDateFieldValue=lastSegment.record[this.START_DATE_FIELD];var lastSegEndDateFieldValue=lastSegment.record[this.END_DATE_FIELD];var lastSegStartDate=lastSegStartDateFieldValue?new Date(lastSegStartDateFieldValue):null;var lastSegEndDate=lastSegEndDateFieldValue?new Date(lastSegEndDateFieldValue):null;var startDateBeforeEndDate=lastSegEndDate>=lastSegStartDate;if(noDelta||amendmentLine){return;}else if(delta>0&&startDateBeforeEndDate){for(var i=1;i<=delta;i++){var newSegmentVO=this._createNewSegment(quote,lastSegment,i);quote.lineItems.push(newSegmentVO);}}else if(delta<0){for(var i=0;i>delta;i--){var lastSegment=this._getLastSegmentFromQuote(quote,segmentKey,dimType);this._removeSegment(quote,lastSegment);}}},this);}},{key:"_getLastSegmentFromQuote",value:function _getLastSegmentFromQuote(quote,segmentKey,dimType){var lineItem=null;var maxIndex=null;quote.lineItems.forEach(function(line){if(line.record[this.SEGMENT_KEY_FIELD]===segmentKey&&line.dimensionType===dimType){var index=line.record[this.SEGMENT_INDEX_FIELD];if(index!=null&&(maxIndex==null||maxIndex<index)){maxIndex=index;lineItem=line;}}},this);return lineItem;}},{key:"_createNewSegment",value:function _createNewSegment(quote,sourceSegment,offset){var _this4=this;var clone=JSON.parse(JSON.stringify(sourceSegment));clone.key=++quote.nextKey;clone.record.Id=null;clone.record[this.SEGMENT_KEY_FIELD]=sourceSegment.record[this.SEGMENT_KEY_FIELD];clone.record[this.SEGMENT_INDEX_FIELD]=sourceSegment.record[this.SEGMENT_INDEX_FIELD]+offset;var whitespace=clone.record[this.SEGMENT_INDEX_FIELD]<10?'  ':' ';clone.record[this.SEGMENT_LABEL_FIELD]=sourceSegment.dimensionType+whitespace+clone.record[this.SEGMENT_INDEX_FIELD];if(clone.rateCards&&clone.rateCards.length>0){clone.rateCards.forEach(function(card){card.Id=null;card[_this4.prefix+"QuoteLine__c"]=null;var rates=card[_this4.prefix+'UsageRates__r'];if(rates&&rates.records.length>0){rates.records.forEach(function(rate){rate.Id=null;rate[_this4.prefix+"UsageRateCard__c"]=null;});}});}return clone;}},{key:"_removeSegment",value:function _removeSegment(quote,segmentToRemove){var lineCount=quote.lineItems.length;for(var i=0;i<lineCount;i++){var line=quote.lineItems[i];if(line.key===segmentToRemove.key){quote.lineItems=quote.lineItems.slice(0,i).concat(quote.lineItems.slice(i+1,lineCount));if(quote.deletedLineIds&&line.record&&line.record.Id){quote.deletedLineIds.push(line.record.Id);}return;}}}}]);return MDQSegmentHelper;}();module.exports=MDQSegmentHelper;},{"../Utils/DateUtils.js":1}],13:[function(require,module,exports){var ModelNotifierManager=function(){function ModelNotifierManager(jsqcNotifier){_classCallCheck2(this,ModelNotifierManager);this.notifier=jsqcNotifier;this.watchedFieldNames=this.notifier.fieldNameSet;this.watchedPropertyNames=this.notifier.propertyNameSet;}_createClass(ModelNotifierManager,[{key:"recordOriginalValues",value:function recordOriginalValues(quoteModel){this._recordOriginalValues([quoteModel],'QuoteModel');if(quoteModel.grouped){this._recordOriginalValues(quoteModel.groups,'QuoteLineGroupModel');}this._recordOriginalValues(quoteModel.lineItems,'QuoteLineModel');}},{key:"_recordOriginalValues",value:function _recordOriginalValues(objects,root){objects.forEach(function(obj){this.watchedFieldNames.forEach(function(fieldName){var originalValue=obj.record[fieldName];this.notifier.notify(root,'record.'+fieldName,undefined,obj,originalValue);},this);this.watchedPropertyNames.forEach(function(propertyName){var originalValue=obj[propertyName];this.notifier.notify(root,propertyName,undefined,obj,originalValue);},this);},this);}},{key:"recordCurrentValues",value:function recordCurrentValues(quoteModel){this._recordCurrentValues([quoteModel],'QuoteModel');if(quoteModel.grouped){this._recordCurrentValues(quoteModel.groups,'QuoteLineGroupModel');}this._recordCurrentValues(quoteModel.lineItems,'QuoteLineModel');}},{key:"_recordCurrentValues",value:function _recordCurrentValues(objects,root){objects.forEach(function(obj){this.watchedFieldNames.forEach(function(fieldName){var finalValue=obj.record[fieldName];this.notifier.notify(root,'record.'+fieldName,finalValue,obj,undefined);},this);this.watchedPropertyNames.forEach(function(propertyName){var finalValue=obj[propertyName];this.notifier.notify(root,propertyName,finalValue,obj,undefined);},this);},this);}}]);return ModelNotifierManager;}();module.exports=ModelNotifierManager;},{}],14:[function(require,module,exports){module.exports={createProxy:proxyFactory};function proxyFactory(innerModel,outerModel,root,notifier){if(typeof Proxy!=='undefined'&&notifier){var recordHandler={set:function set(rec,field,val){var oldVal=rec[field];rec[field]=val;notifier.notify(root,'record.'+field,val,outerModel,oldVal);return true;}};var recordProxy=new Proxy(innerModel.record,recordHandler);var modelHandler={get:function get(target,prop){return prop==='record'?recordProxy:target[prop];},set:function set(obj,prop,val){var oldVal=obj[prop];obj[prop]=val;notifier.notify(root,prop,val,outerModel,oldVal);return true;}};return new Proxy(innerModel,modelHandler);}else{return innerModel;}}},{}],15:[function(require,module,exports){'use strict';try{require("systemjs");}catch(err){if(typeof window!=='undefined'&&window)console.log("Could not load SystemJS through 'require' call. This is only a problem if not in the browser.");}var logger=require('js-logger').logger.getLogger("JSQC");module.exports=function(prefix,plugin,orgId,settings){var pluginModule;var pluginId;function loadPlugin(apex){if(plugin){var metricsService,id;return _loadMetricsService().then(function(ms){if(ms){metricsService=new ms.MetricsService();id=metricsService.startServiceRequest("ApexUtils query");}return queryCode(apex,plugin.name).then(function(results){if(metricsService)metricsService.stopServiceRequest(id);if(results.records.length>0){var records=results.records;pluginId=records[0].Id;if(records.length>1){console.warn(records.length+' plugins share the name '+plugin.name+'. Using ['+records[0].Id+'].');}return replaceFillerTextWithModuleId(results.records[0][prefix+'TranspiledCode__c'],plugin.pid);}else{return Promise.reject('No plugin named '+plugin.name+' exists.');}}).then(function(transpiledCode){return registerAndImportModule(transpiledCode,plugin.pid);}).then(function(module){pluginModule=module;});});}else{return Promise.resolve();}}function _loadMetricsService(){var inBrowser=typeof window!=='undefined';if(inBrowser){return System.import('perfMetrics/MetricsService.js');}return Promise.resolve();}function logPluginStart(action){if(orgId){logger.info('Org: ',orgId,'. Plugin: ',pluginId,'. Starting Action: ',action);}}function logPluginFinish(action,time){if(orgId){logger.info('Org: ',orgId,'. Plugin: ',pluginId,'. Finished Action: ',action,' after ',time,' ms');}}function queryCode(apex,name){if(apex!=null){var queryText="SELECT Id, "+prefix+"TranspiledCode__c FROM "+prefix+"CustomScript__c WHERE Name = '"+name+"'";return apex.query(queryText);}else{return Promise.reject('Error: No JSForce connection exists with which to load the plugin');}}function replaceFillerTextWithModuleId(sourceCode,pluginId){return sourceCode.replace('____UIDFiller____',pluginId);}function registerAndImportModule(sourceCode,pluginId){try{var action='registration eval()';logPluginStart(action);var startTime=Date.now();eval(sourceCode);logPluginFinish(action,Date.now()-startTime);}catch(err){return Promise.reject('Error: SystemJS failed to import the plugin module');}return System.import('QCPlugin'+pluginId);}function pluginHasMethod(methodName){return pluginModule&&methodName&&pluginModule[methodName]&&typeof pluginModule[methodName]==='function';}function callPluginMethod(methodName,argumentArray){if(pluginHasMethod(methodName)){var startTime=Date.now();logPluginStart(methodName);var result=void 0;try{result=pluginModule[methodName].apply(pluginModule,argumentArray);}catch(e){throw new Error(settings.getLabelByKey('lbl_plugin_error')+' ('+methodName+')'+' - '+e.message);}if(result&&result.then){return result.then(function(){logPluginFinish(methodName,Date.now()-startTime);});}else{throw new Error(settings.getLabelByKey('lbl_plugin_error')+' ('+methodName+')'+' - '+settings.getLabelByKey('msg_js_err_missing_promise_in_plugin'));}}else{return Promise.resolve();}}function callPageSecurityPluginMethod(methodName,argumentArray){if(pluginHasMethod(methodName)){return pluginModule[methodName].apply(pluginModule,argumentArray);}else{return null;}}function unloadPlugin(){if(pluginModule){logPluginStart('plugin deletion');var startTime=Date.now();System.delete('QCPlugin'+plugin.pid);logPluginFinish('plugin deletion',Date.now()-startTime);}}return{loadPlugin:loadPlugin,unloadPlugin:unloadPlugin,pluginHasMethod:pluginHasMethod,callPageSecurityPluginMethod:callPageSecurityPluginMethod,callPluginMethod:callPluginMethod};};},{"js-logger":96,"systemjs":48}],16:[function(require,module,exports){"use strict";var ApexUtils=require("./Utils/ApexUtils.js");var OAuthUtils=require("./Utils/OAuthUtils.js");var NumberUtils=require("../Utils/NumberUtils.js");var IdUtils=require("./Utils/IdUtils.js");var TargetCalculator2=require("./TargetCalculator2.js");var LineCalculator=require("./LineCalculator.js");var QuoteLinePriceRuleEvaluator=require("./QuoteLinePriceRuleEvaluator.js");var MetaDataUtils=require("./Utils/MetaDataUtils.js");var FieldMetadataIndex=require("./FieldMetadataIndex.js");var FormulaFieldEngine=require("./FormulaFieldCalculator.js");var QuoteSummarizer=require("./QuoteSummarizer.js");var JSForce=require("jsforce");var PluginManager=require("./PluginManager.js");var DiscountScheduleModel=require("./DiscountScheduleModel.js");var AccountModel=require("./AccountModel.js");var jsLogger=require("js-logger").logger.getLogger('JSQC');var QuoteCalculator=function(){function QuoteCalculator(quote,settings){_classCallCheck2(this,QuoteCalculator);this.quote=quote;this.settings=settings;this.prefix=settings.devPrefix;this.quantitySumIndex={};this.quantitySumIndexForCostSchedules={};this.discountScheduleMap={};this.accountMap={};this.quantitySumIndexIncludingBundled={};this.formulaFieldEngine=new FormulaFieldEngine(settings);this.priorQuantitySumIndex={};this.actualQuantitySumIndex={};this.metadataIndex={};this.logger=jsLogger;}_createClass(QuoteCalculator,[{key:"initConnection",value:function initConnection(accessToken,orgPrefix){this.conn=OAuthUtils(accessToken,orgPrefix).getConnection();}},{key:"initConnections",value:function initConnections(accessToken,orgPrefix){this.conn=OAuthUtils(accessToken,orgPrefix).getConnection();this.customerOnlyConn=OAuthUtils(accessToken,orgPrefix).getConnection();}},{key:"setConnection",value:function setConnection(conn){this.conn=conn;}},{key:"setCustomerOnlyConnection",value:function setCustomerOnlyConnection(conn){this.customerOnlyConn=conn;}},{key:"setApex",value:function setApex(apex){this.apex=apex;}},{key:"newApex",value:function newApex(conn){return ApexUtils(conn);}},{key:"loadProductAndOptionRecords",value:function loadProductAndOptionRecords(){var self=this;var prefix=this.settings.devPrefix===""?"":"SBQQ";var productToLineMap={};var productIdList=[];var optionToLineMap={};var optionIdList=[];var pricebookFilter=[];var currencyFilter=[];this.quote.lineItems.forEach(function(line){var pid=line.Product__c;if(productToLineMap[pid]==null){productToLineMap[pid]=[];productIdList.push(pid);}productToLineMap[pid].push(line);var oid=line.ProductOption__c;if(oid!=null){if(optionToLineMap[oid]==null){optionToLineMap[oid]=[];optionIdList.push(oid);}optionToLineMap[oid].push(line);}});var productRequiredFields=this.settings.referencedFieldMap['Product2']||[];var optionRequiredFields=this.settings.referencedFieldMap[this.prefix+'ProductOption__c']||[];if(this.quote.record[this.prefix+'PricebookId__c']){pricebookFilter.push(this.quote.record[this.prefix+'PricebookId__c']);}if(this.quote.record['CurrencyIsoCode']){currencyFilter.push(this.quote.record['CurrencyIsoCode']);}var productContext={'requiredIds':productIdList,'productFields':productRequiredFields,'pricebookFilter':pricebookFilter,'currencyFilter':currencyFilter};var optionContext={'requiredIds':optionIdList,'requiredFields':optionRequiredFields};return this.loadDataFromProvider(prefix,'ProductServiceProvider.ProductLoader','Product__r','AllProducts',productContext,productToLineMap).then(function(){return self.loadDataFromProvider(prefix,'ProductOptionServiceProvider.ProductOptionLoader','ProductOption__r','AllOptions',optionContext,optionToLineMap);});}},{key:"loadDataFromProvider",value:function loadDataFromProvider(prefix,provider,attribute,uid,context,lineMap){var self=this;var allRecords;this.apex.setOptions({escape:false,timeout:120000});return this.apex.load(prefix,provider,uid,context).then(function(allResults){allRecords=allResults;var missingKeys=[];context['requiredIds'].forEach(function(key){if(allResults[key]!=null){lineMap[key].forEach(function(line){line[attribute]=allResults[key];},this);}else{missingKeys.push(key);}},this);context['requiredIds']=missingKeys;return missingKeys.length===0?Promise.resolve({}):self.apex.load(prefix,provider,null,context);}).then(function(missingResults){context['requiredIds'].forEach(function(key){lineMap[key].forEach(function(line){line[attribute]=missingResults[key];},this);try{allRecords[key]=missingResults[key];}catch(e){}},this);});}},{key:"loadAllRelatedRecords",value:function loadAllRelatedRecords(){var self=this;var prefix=this.prefix===""?"":"SBQQ";var idUsageMap={};var context={'queryInfo':{}};addLookupsToIdMapAndUpdateContext(this.settings.quoteLookups,[self.quote]);addLookupsToIdMapAndUpdateContext(this.settings.groupLookups,self.quote.groups);addLookupsToIdMapAndUpdateContext(this.settings.nonstandardLineLookups,self.quote.lineItems);var hoistedResults;return this.apex.load(prefix,'JSQCLookupFieldServiceProvider.JSQCLookupFieldLoader','AllAdditionalLookups',context).then(function(results){return assignIdsToObjectsAndQueryMissingRecords(results);});function assignIdsToObjectsAndQueryMissingRecords(results){for(var index in results){results[index].relatedRecord=true;}if(hoistedResults){try{for(var queriedId in results){hoistedResults[queriedId]=results[queriedId];}}catch(e){}}else{hoistedResults=results;}var secondContext={'queryInfo':{}};var missingIds=[];for(var id in idUsageMap){if(hoistedResults[id]!=null){idUsageMap[id].usageList.forEach(function(usage){var record=usage.record;var relationshipName=usage.fieldName.substring(0,usage.fieldName.length-1)+'r';if(record[relationshipName]!=null&&IdUtils.compareIds(id,record[relationshipName]['Id'],self.settings)){for(var existingKey in record[relationshipName]){hoistedResults[id][existingKey]=record[relationshipName][existingKey];}}record[relationshipName]=hoistedResults[id];},self);}else{missingIds.push(id);var typeOfMissing=idUsageMap[id].objectType;if(secondContext.queryInfo[typeOfMissing]==null){secondContext.queryInfo[typeOfMissing]=context.queryInfo[typeOfMissing];secondContext.queryInfo[typeOfMissing].requiredIds=[];}secondContext.queryInfo[typeOfMissing].requiredIds.push(id);}}if(missingIds.length===0){return Promise.resolve();}else{return self.apex.load(prefix,'JSQCLookupFieldServiceProvider.JSQCLookupFieldLoader',null,secondContext).then(function(results){return assignIdsToObjectsAndQueryMissingRecords(results);});}}function addLookupsToIdMapAndUpdateContext(lookupFields,models){if(lookupFields!=null&&models!=null&&models.length!=0){for(var key in lookupFields){if(lookupFields.hasOwnProperty(key)){var targetType=lookupFields[key];var aliasTargetType=MetaDataUtils.getAliasTargetType(targetType);models.forEach(function(model){var id=model.record[key];if(id){var convertedId=IdUtils.convertTo18(id,self.settings);if(idUsageMap[convertedId]==null){idUsageMap[convertedId]={'objectType':targetType,'usageList':[]};}var usageList=idUsageMap[convertedId].usageList;usageList.push({'fieldName':key,'record':model.record});if(!context.queryInfo[targetType]){context.queryInfo[targetType]={'referencedFields':self.settings.referencedFieldMap[aliasTargetType],'referencedIds':[id]};}else{context.queryInfo[targetType]['referencedIds'].push(id);}}});}}}}}},{key:"calculate",value:function calculate(){var metricsService,id,self;self=this;return _loadMetricsService().then(function(ms){if(ms){metricsService=new ms.MetricsService();id=metricsService.startServiceRequest("QuoteCalculator calculate");}self.conn=self.conn||new JSForce.Connection({accessToken:sfSessionId});self.customerOnlyConn=self.customerOnlyConn||new JSForce.Connection({accessToken:sfSessionId});var pluginManager=PluginManager(self.prefix,self.quote.plugin,self.orgId,self.settings);self.apex=self.apex||ApexUtils(self.conn);return self.loadProductAndOptionRecords().then(function(){return self.loadAllRelatedRecords();}).then(function(){return retrieveMetadata(self);}).then(function(){return evaluatePriceRules(self,'On Initialization');}).then(function(){return pluginManager.loadPlugin(self.apex);}).then(function(){return pluginManager.callPluginMethod('onInit',[self.quote.lineItems,self.customerOnlyConn]);}).then(function(){return self.loadAllRelatedRecords();}).then(function(){self.formulaFieldEngine.calculateFormulaFieldsOnObjects(self.quote.lineItems);self.formulaFieldEngine.calculateFormulaFieldsOnObjects([self.quote]);if(self.quote.grouped){self.formulaFieldEngine.calculateFormulaFieldsOnObjects(self.quote.groups);}return evaluatePriceRules(self,'Before Calculate');}).then(function(){return pluginManager.callPluginMethod('onBeforeCalculate',[self.quote,self.quote.lineItems,self.customerOnlyConn]);}).then(function(){return self.loadAllRelatedRecords();}).then(function(){calculateQuantitiesAndCarryoverQuantities(self.quote);if(self.quote.isAmendment){calculateUpgradedQuantities(self.quote);}}).then(function(){return pluginManager.callPluginMethod('onBeforePriceRules',[self.quote,self.quote.lineItems,self.customerOnlyConn]);}).then(function(){return evaluatePriceRules(self,'On Calculate');}).then(function(){return pluginManager.callPluginMethod('onAfterPriceRules',[self.quote,self.quote.lineItems,self.customerOnlyConn]);}).then(function(){return self.loadAllRelatedRecords();}).then(function(){return loadDiscountsAndAccountSummaries(self);}).then(function(){indexQuantitiesForDiscountSchedules(self.quote,self);targetCalculatorResetsDiscounts(self);resetTotals(self.quote);calculateFixedItems(self,self.quote);calculateDynamicItems(self,self.quote);calculateTotals(self.quote);targetCalculatorAppliesDiscounts(self);rollupComponents(self.quote);return evaluatePriceRules(self,'After Calculate');}).then(function(){return pluginManager.callPluginMethod('onAfterCalculate',[self.quote,self.quote.lineItems,self.customerOnlyConn]);}).then(function(){return self.loadAllRelatedRecords();}).then(function(){self.formulaFieldEngine.calculateFormulaFieldsOnObjects(self.quote.lineItems);self.formulaFieldEngine.calculateFormulaFieldsOnObjects([self.quote]);if(self.quote.grouped){self.formulaFieldEngine.calculateFormulaFieldsOnObjects(self.quote.groups);}resetTotals(self.quote);calculateTotals(self.quote);QuoteSummarizer.summarize([self.quote],self.settings);return self.loadAllRelatedRecords();}).then(function(){return secureFieldsUsingPlugin(self.quote,pluginManager,self.customerOnlyConn);}).then(function(){return pluginManager.unloadPlugin();}).then(function(){if(metricsService)metricsService.stopServiceRequest(id);});});}},{key:"secureFields",value:function secureFields(){this.conn=this.conn||new JSForce.Connection({accessToken:sfSessionId});this.customerOnlyConn=this.customerOnlyConn||new JSForce.Connection({accessToken:sfSessionId});this.apex=this.apex||ApexUtils(this.conn);var self=this;var pluginManager=PluginManager(this.prefix,this.quote.plugin);return pluginManager.loadPlugin(this.apex).then(function(){return secureFieldsUsingPlugin(self.quote,pluginManager,self.customerOnlyConn);}).then(function(){pluginManager.unloadPlugin();});}},{key:"getDiscountScheduleById",value:function getDiscountScheduleById(sid){return this.discountScheduleMap[IdUtils.convertTo18(sid,this.settings)];}},{key:"getAccountById",value:function getAccountById(id){return this.accountMap[id];}}]);return QuoteCalculator;}();function _loadMetricsService(){var inBrowser=typeof window!=='undefined';if(inBrowser){return System.import('perfMetrics/MetricsService.js');}return Promise.resolve();}function secureFieldsUsingPlugin(quote,pluginManager,customerConn){if(typeof window==='undefined'){return Promise.resolve();}var hasVisibilityMethod=pluginManager.pluginHasMethod('isFieldVisible');var hasEditabilityMethod=pluginManager.pluginHasMethod('isFieldEditable');if(hasVisibilityMethod||hasEditabilityMethod){quote.lineItems.forEach(function(line){var vis={},edt={};for(var key in line.record){if(line.record.hasOwnProperty(key)&&key!='attributes'){if(hasVisibilityMethod){vis[key]=pluginManager.callPageSecurityPluginMethod('isFieldVisible',[key,line.record,customerConn]);}if(hasEditabilityMethod){edt[key]=pluginManager.callPageSecurityPluginMethod('isFieldEditable',[key,line.record,customerConn]);}}}line.fieldVisibility=vis;line.fieldEditability=edt;});}return Promise.resolve();}function loadDiscountsAndAccountSummaries(qc){var scheduleMap=qc.quote.scheduleMap;if(Object.keys(scheduleMap).length!=0){var overriddenMap=qc.quote.overriddenScheduleMap;var context={'schedules':scheduleMap,'overrides':overriddenMap,'account':qc.quote.Account__c};var startTime=new Date();var resultStorage;return getDiscountsAndAccountSummariesFromServer(qc.apex,'AllDiscountsAndAccounts',context,qc.prefix).then(function(results){resultStorage=results;var resultObj=typeof results==='string'?JSON.parse(results):results;if(!mapsAreIdentical(context.schedules,resultObj.schedules)||!mapsAreIdentical(context.overrides,resultObj.overrides)){return getDiscountsAndAccountSummariesFromServer(qc.apex,null,context,qc.prefix);}else{return Promise.resolve(results);}}).then(function(newResults){resultStorage=newResults;var resultObj=typeof newResults==='string'?JSON.parse(newResults):newResults;setDiscountAndSummaryObjects(qc,resultObj);});}else{return Promise.resolve();}function mapsAreIdentical(map1,map2){for(var key in map1){if(map2[key]!=null){var sameEntryForThisKey=map2[key].every(function(valueFromMap2){return map1[key].some(function(valueFromMap1){return valueFromMap1===valueFromMap2;});});if(!sameEntryForThisKey){return false;}}else{return false;}}return true;}}function getDiscountsAndAccountSummariesFromServer(apex,uid,context,prefix){var calloutPrefix=prefix==""?"":"SBQQ";return apex.load(calloutPrefix,'DiscountAndAccountCallout',uid,context);}function setDiscountAndSummaryObjects(qc,results){qc.discountScheduleMap={};var dsMap=results.scheduleRecords;for(var id in dsMap){var dsRecord=dsMap[id];var productIds;if(results.productsByDiscountSchedule)productIds=results.productsByDiscountSchedule[id];qc.discountScheduleMap[IdUtils.convertTo18(id,qc.settings)]=new DiscountScheduleModel(dsRecord,productIds,qc.settings);}qc.accountMap={};for(var acId in results.accounts){var accountVO=results.accounts[acId];qc.accountMap[IdUtils.convertTo18(acId,qc.settings)]=new AccountModel(accountVO,qc.settings);}}function retrieveMetadata(qc){var apex=qc.apex;var fullNames=determineMetadataFullNames(qc);if(fullNames.length==0){return Promise.resolve();}var prefix=qc.prefix===""?"":"SBQQ";return apex.md('CustomField',fullNames,prefix).then(function(dataArray){qc.metadataIndex=new FieldMetadataIndex(dataArray);qc.formulaFieldEngine.setMetadata(qc.metadataIndex);});}function targetCalculatorResetsDiscounts(qc){var tc=new TargetCalculator2(qc.settings);if(qc.quote.TargetCustomerAmount__c!=null){tc.resetDiscounts(qc.quote);}}function targetCalculatorAppliesDiscounts(qc){var tc=new TargetCalculator2(qc.settings);qc.quote.groups.forEach(function(group){if(group.TargetCustomerAmount__c!=null){tc.resetDiscounts(qc.quote,group);tc.calculate(qc.quote,group);resetTotals(qc.quote);calculateFixedItems(qc,qc.quote);calculateDynamicItems(qc,qc.quote);calculateTotals(qc.quote);if(group.hasDynamicLineItems&&group.TargetCustomerAmount__c!=group.record[qc.prefix+"CustomerTotal__c"]){tc.adjustDynamicItems(qc.quote,group);calculateDynamicItems(qc,qc.quote);resetTotals(qc.quote);calculateTotals(qc.quote);}}},qc);if(qc.quote.TargetCustomerAmount__c!=null){tc.calculate(qc.quote);resetTotals(qc.quote);calculateFixedItems(qc,qc.quote);calculateDynamicItems(qc,qc.quote);calculateTotals(qc.quote);if(qc.quote.hasDynamicLineItems&&qc.quote.TargetCustomerAmount__c!=qc.quote.customerTotal){tc.adjustDynamicItems(qc.quote);calculateDynamicItems(qc,qc.quote);resetTotals(qc.quote);calculateTotals(qc.quote);}}}function determineMetadataFullNames(calculator){var referencedFieldMap=calculator.settings.referencedFieldMap;if(referencedFieldMap==null){return[];}var fullNames=[];var lineType=calculator.prefix+"QuoteLine__c";var quoteType=calculator.prefix+"Quote__c";var groupType=calculator.prefix+"QuoteLineGroup__c";for(var key in referencedFieldMap){var typeName=key==='Quote Line'?lineType:key==='Group'?groupType:key==='Quote'?quoteType:key;if(referencedFieldMap.hasOwnProperty(key)){referencedFieldMap[key].forEach(function(apiName){fullNames.push(typeName+'.'+apiName);});}}return fullNames;}function calculateQuantitiesAndCarryoverQuantities(quote){var defaultQuantityScale=quote.settings.quantityScale;quote.lineItems.forEach(function(line){line.Quantity__c=calculateQuantity(line);if(line.Quantity__c!=null){var quantityScale=line.productQuantityScale;if(quantityScale==null){quantityScale=defaultQuantityScale;}line.Quantity__c=NumberUtils.setScale(line.Quantity__c,quantityScale);}});quote.lineItems.forEach(function(line){line.PriorQuantity__c=line.carryoverQuantity;});}function calculateUpgradedQuantities(quote){var existingLinesByAssetId={};var carryoverLinesByAssetId={};var upgradeLinesByAssetId={};var defaultQuantityScale=quote.settings.quantityScale;quote.lineItems.forEach(function(line){if(line.UpgradedAsset__c){var aid=line.UpgradedAsset__c;if(line.Existing__c){existingLinesByAssetId[aid]=line;}else if(line.CarryoverLine__c){var currentCarryoverList=carryoverLinesByAssetId[aid]||[];currentCarryoverList.push(line);carryoverLinesByAssetId[aid]=currentCarryoverList;}else{var currentUpgradeList=upgradeLinesByAssetId[aid]||[];currentUpgradeList.push(line);upgradeLinesByAssetId[aid]=currentUpgradeList;}}});for(var assetId in existingLinesByAssetId){var existingLine=existingLinesByAssetId[assetId];var upgradedQuantity=0;if(carryoverLinesByAssetId[assetId]){carryoverLinesByAssetId[assetId].forEach(function(carryoverLine){upgradedQuantity+=carryoverLine.PriorQuantity__c;});}if(upgradeLinesByAssetId[assetId]){upgradeLinesByAssetId[assetId].forEach(function(upgradeLine){if(existingLine.parentItemKey==upgradeLine.parentItemKey){upgradedQuantity+=upgradeLine.expressQuantityInTermsOfSourceProduct(existingLine.Product__c);}});}var quantityScale=existingLine.productQuantityScale;quantityScale=quantityScale==null?defaultQuantityScale:quantityScale;existingLine.UpgradedQuantity__c=NumberUtils.setScale(upgradedQuantity,quantityScale);}for(var assetId in carryoverLinesByAssetId){var carryoverLines=carryoverLinesByAssetId[assetId];carryoverLines.forEach(function(carryoverLine){var upgradedQuantity=0;if(upgradeLinesByAssetId[assetId]){upgradeLinesByAssetId[assetId].forEach(function(upgradeLine){if(carryoverLine.parentItemKey==upgradeLine.parentItemKey){upgradedQuantity+=upgradeLine.expressQuantityInTermsOfSourceProduct(carryoverLine.Product__c);}});}var quantityScale=carryoverLine.productQuantityScale;quantityScale=quantityScale==null?defaultQuantityScale:quantityScale;carryoverLine.UpgradedQuantity__c=NumberUtils.setScale(upgradedQuantity,quantityScale);});}}function indexQuantitiesForDiscountSchedules(quote,calculator){quote.lineItems.forEach(function(line){if(line.isVolumeDiscounted&&(!quote.isRenewal||line.RenewedAsset__c==null)){calculateDiscountedQuantities(line,calculator,false);}if(line.hasCostSchedule&&(!quote.isRenewal||line.RenewedAsset__c==null)){calculateDiscountedQuantities(line,calculator,true);}});}function calculateDiscountedQuantities(line,calculator,isCostSchedule){var scheduleId;var qsi;var qsiIncludeBundled=calculator.quantitySumIndexIncludingBundled;var qsiPriorQty=calculator.priorQuantitySumIndex;var qsiActualQty=calculator.actualQuantitySumIndex;if(!isCostSchedule){scheduleId=line.DiscountSchedule__c;qsi=calculator.quantitySumIndex;}else if(isCostSchedule){scheduleId=line.costScheduleId;qsi=calculator.quantitySumIndexForCostSchedules;}var qid=IdUtils.convertTo18(line.quoteId,line.settings);var sid=IdUtils.convertTo18(scheduleId,line.settings);var pid=line.Product__c;var scheduleIdKey=qid+"_"+sid;var scheduleProductKey=scheduleIdKey+"_"+pid;var groupSchedIdKey=line.parentGroup!=null?qid+"_"+line.parentGroup.key+"_"+sid:null;var groupSchedProdKey=line.parentGroup!=null?groupSchedIdKey+"_"+pid:null;var sum=0;var lineQuantity;var linePriorQuantity=line.PriorQuantity__c||0;var lineActualQuantity=line.ActualQuantity__c||0;if(scheduleId!=null){var ds=calculator.getDiscountScheduleById(IdUtils.convertTo18(scheduleId,line.settings));var quoteLineQuantityFieldName=ds.record[calculator.prefix+"QuoteLineQuantityField__c"];if(quoteLineQuantityFieldName!=null){var quoteLineQuantityField=MetaDataUtils.getField(MetaDataUtils.getObjectType(line),quoteLineQuantityFieldName,calculator.prefix);lineQuantity=line.record[quoteLineQuantityField];}}if(lineQuantity==null){lineQuantity=line.Quantity__c;}if(!line.Optional__c&&!line.Bundled__c){sum=qsi[scheduleIdKey]||0;qsi[scheduleIdKey]=sum+lineQuantity;sum=qsi[scheduleProductKey]||0;qsi[scheduleProductKey]=sum+lineQuantity;sum=qsiPriorQty[scheduleIdKey]||0;qsiPriorQty[scheduleIdKey]=sum+linePriorQuantity;sum=qsiPriorQty[scheduleProductKey]||0;qsiPriorQty[scheduleProductKey]=sum+linePriorQuantity;sum=qsiActualQty[scheduleIdKey]||0;qsiActualQty[scheduleIdKey]=sum+lineActualQuantity;sum=qsiActualQty[scheduleProductKey]||0;qsiActualQty[scheduleProductKey]=sum+lineActualQuantity;}if(line.parentGroup!=null&&(!line.Optional__c||line.parentGroup.Optional__c)&&!line.Bundled__c){sum=qsi[groupSchedIdKey]||0;qsi[groupSchedIdKey]=sum+lineQuantity;sum=qsi[groupSchedProdKey]||0;qsi[groupSchedProdKey]=sum+lineQuantity;sum=qsiPriorQty[groupSchedIdKey]||0;qsiPriorQty[groupSchedIdKey]=sum+linePriorQuantity;sum=qsiPriorQty[groupSchedProdKey]||0;qsiPriorQty[groupSchedProdKey]=sum+linePriorQuantity;sum=qsiActualQty[groupSchedIdKey]||0;qsiActualQty[groupSchedIdKey]=sum+lineActualQuantity;sum=qsiActualQty[groupSchedProdKey]||0;qsiActualQty[groupSchedProdKey]=sum+lineActualQuantity;}if(!line.Optional__c){sum=qsiIncludeBundled[scheduleIdKey]||0;qsiIncludeBundled[scheduleIdKey]=sum+lineQuantity;sum=qsiIncludeBundled[scheduleProductKey]||0;qsiIncludeBundled[scheduleProductKey]=sum+lineQuantity;}if(line.parentGroup!=null&&(!line.Optional__c||line.parentGroup.Optional__c)){sum=qsiIncludeBundled[groupSchedIdKey]||0;qsiIncludeBundled[groupSchedIdKey]=sum+lineQuantity;sum=qsiIncludeBundled[groupSchedProdKey]||0;qsiIncludeBundled[groupSchedProdKey]=sum+lineQuantity;}}function calculateQuantity(line){if(line.parentQuote.isAmendment&&line.parentItem!=null&&calculateQuantity(line.parentItem)===0){return 0;}var originalQty=line.BundledQuantity__c;if(originalQty!=null){var parentQty=line.parentItem==null||line.isDynamicSubscription||line.isOptionTypeAccessory?1:calculateQuantity(line.parentItem);var batchQty=line.BatchQuantity__c;var qty=originalQty;if(batchQty!=null&&batchQty!=0){qty=Math.ceil(originalQty/parseFloat(batchQty));}return qty*parentQty;}return line.Quantity__c;}function evaluatePriceRules(qc,eventPeriod){var quote=qc.quote;var metadataIndex=qc.metadataIndex;var ffe=qc.formulaFieldEngine;var apex=qc.apex;var conn=qc.conn;if(quote.Id!=null&&qc.settings.hasQuotePriceRules){var qlprEvaluator=new QuoteLinePriceRuleEvaluator(quote,metadataIndex,ffe,qc.settings);if(conn){qlprEvaluator.setConnection(conn);}if(apex){qlprEvaluator.setApex(apex);}return qlprEvaluator.evaluate(quote,eventPeriod);}else{return Promise.resolve();}}function resetTotals(quote){var prefix=quote.prefix;quote.listProductTotal=0;quote.customerProductTotal=0;quote.netProductTotal=0;quote.regularProductTotal=0;quote.netTotal=0;quote.customerTotal=0;quote.regularTotal=0;quote.listTotal=0;var groupCount=quote.groups.length;for(var i=0;i<groupCount;i++){var group=quote.groups[i];group.listProductTotal=0;group.customerProductTotal=0;group.netProductTotal=0;group.regularProductTotal=0;group.ListTotal__c=0;group.CustomerTotal__c=0;group.NetTotal__c=0;}}function calculateFixedItems(qc,quote){var lineCount=quote.lineItems.length;for(var i=0;i<lineCount;i++){var line=quote.lineItems[i];if(!line.isDynamic){var lCalc=new LineCalculator(qc,line,qc.settings);lCalc.calculate();if(!line.Optional__c){if(!line.isExcludedFromMaintenance){quote.listProductTotal+=line.listProductTotal;quote.customerProductTotal+=line.customerProductTotal;quote.netProductTotal+=line.netProductTotal;quote.regularProductTotal+=line.regularProductTotal;}}if(line.parentGroup!=null){if(!line.Optional__c||line.parentGroup.record[qc.prefix+"Optional__c"]===true){if(!line.isExcludedFromMaintenance){line.parentGroup.listProductTotal+=line.listProductTotal;line.parentGroup.customerProductTotal+=line.customerProductTotal;line.parentGroup.netProductTotal+=line.netProductTotal;line.parentGroup.regularProductTotal+=line.regularProductTotal;}}}}}}function calculateDynamicItems(qc,quote){var lines=quote.lineItems;var lineCount=lines.length;var qty;for(var i=0;i<lineCount;i++){var line=lines[i];if(!line.isDynamic){continue;}var lcalc=new LineCalculator(qc,line,qc.settings);var subPercent=line.SubscriptionPercent__c||0;var productTotal=0;quote.getLinesCoveredBySubscription(line).forEach(function(coveredLine){if(!coveredLine.isCountedByDynamicSubscription(line)){return;}var subTermRatio=coveredLine.isSubscription?line.defaultTerm/coveredLine.defaultTerm:1;var prorateMultiplier=coveredLine.ProrateMultiplier__c!=null?coveredLine.ProrateMultiplier__c:1;if(line.parentQuote.isAmendment&&!line.Existing__c){qty=coveredLine.isPricingMethodBlock||coveredLine.DiscountScheduleType__c==='Slab'&&!line.isSubscriptionBaseList?1:coveredLine.Quantity__c;if(line.isSubscriptionBaseList&&coveredLine.ListPrice__c!=null&&!coveredLine.Bundled__c){productTotal+=coveredLine.ListPrice__c*qty;}else{var isExistingSlabNonBlock=coveredLine.countsAsExisting&&coveredLine.DiscountScheduleType__c==='Slab'&&!coveredLine.isPricingMethodBlock;var coveredPrice=0;if(line.isSubscriptionBaseNet){coveredPrice=isExistingSlabNonBlock?coveredLine.amendedSlabFullNetPrice:coveredLine.NetPrice__c;}else if(line.isSubscriptionBaseCustomer){coveredPrice=isExistingSlabNonBlock?coveredLine.amendedSlabFullCustomerPrice:coveredLine.CustomerPrice__c;}else if(line.isSubscriptionBaseRegular){coveredPrice=isExistingSlabNonBlock?coveredLine.amendedSlabFullRegularPrice:coveredLine.RegularPrice__c;}productTotal+=coveredPrice*qty*subTermRatio/prorateMultiplier;}}else if(line.actualQuantity>=0||!line.parentQuote.isAmendment){if(line.isSubscriptionBaseList){productTotal+=coveredLine.listProductTotal;}else{var _coveredPrice=0;if(line.isSubscriptionBaseNet){_coveredPrice=coveredLine.netProductTotal;}else if(line.isSubscriptionBaseCustomer){_coveredPrice=coveredLine.customerProductTotal;}else if(line.isSubscriptionBaseRegular){_coveredPrice=coveredLine.regularProductTotal;}productTotal+=_coveredPrice*subTermRatio;}}else if(line.parentQuote.isAmendment&&line.actualQuantity<0&&coveredLine.Existing__c){qty=coveredLine.isPricingMethodBlock||coveredLine.DiscountScheduleType__c==="Slab"?-1:coveredLine.PriorQuantity__c;if(line.isSubscriptionBaseNet){productTotal+=coveredLine.NetPrice__c*qty*subTermRatio/prorateMultiplier;}else if(line.isSubscriptionBaseCustomer){productTotal+=coveredLine.CustomerPrice__c*qty*subTermRatio/prorateMultiplier;}else if(line.isSubscriptionBaseRegular){productTotal+=coveredLine.RegularPrice__c*qty*subTermRatio/prorateMultiplier;}else if(coveredLine.ListPrice__c!=null){productTotal+=coveredLine.ListPrice__c*qty;}}});line.ListPrice__c=productTotal*(subPercent/100);var dynamicSubContractedDiscount=null;if(lcalc.contractedPriceId!=null){dynamicSubContractedDiscount=line.SpecialPrice__c;var discountedSubPercent=subPercent*(100-dynamicSubContractedDiscount)/100;line.SpecialPrice__c=productTotal*(discountedSubPercent/100);}lcalc.calculate();if(dynamicSubContractedDiscount!=null){line.SpecialPrice__c=dynamicSubContractedDiscount;}}}function calculateTotals(quote){quote.lineItems.forEach(function(line){if(!line.Optional__c){quote.netTotal+=line.NetTotal__c;quote.customerTotal+=line.CustomerTotal__c;quote.listTotal+=line.ListTotal__c;quote.partnerTotal+=line.PartnerTotal__c;quote.regularTotal+=line.RegularTotal__c;}if(line.parentGroup!=null){if(!line.Optional__c||line.parentGroup.Optional__c){line.parentGroup.ListTotal__c=line.parentGroup.ListTotal__c+line.ListTotal__c;line.parentGroup.CustomerTotal__c=line.parentGroup.CustomerTotal__c+line.CustomerTotal__c;line.parentGroup.NetTotal__c=line.parentGroup.NetTotal__c+line.NetTotal__c;}}});quote.netTotal=NumberUtils.setScale(quote.netTotal,2);quote.customerTotal=NumberUtils.setScale(quote.customerTotal,2);quote.listTotal=NumberUtils.setScale(quote.listTotal,2);quote.regularTotal=NumberUtils.setScale(quote.regularTotal,2);quote.NetAmount__c=quote.netTotal;quote.ListAmount__c=quote.listTotal;quote.CustomerAmount__c=quote.customerTotal;quote.RegularAmount__c=quote.regularTotal;quote.LineItemCount__c=quote.lineItems.length;quote.groups.forEach(function(group){group.ListTotal__c=NumberUtils.setScale(group.ListTotal__c,2);group.CustomerTotal__c=NumberUtils.setScale(group.CustomerTotal__c,2);group.NetTotal__c=NumberUtils.setScale(group.NetTotal__c,2);});}function rollupComponents(quote){quote.lineItems.forEach(function(line){var pkg=line.hasComponents;line.ComponentTotal__c=pkg?0:null;line.ComponentListTotal__c=pkg?0:null;line.ComponentCost__c=pkg?0:null;if(pkg){rollupLine(line);}});}function rollupLine(parent){var netTotal=0;var listTotal=0;var cost=0;parent.components.forEach(function(line){if(!line.Optional__c||line.parentGroup!=null&&line.parentGroup.Optional__c){netTotal+=line.netTotal;listTotal+=line.listTotalForParent;cost+=(line.Quantity__c||0)*(line.UnitCost__c||0);}if(line.hasComponents){rollupLine(line);netTotal+=line.ComponentTotal__c;listTotal+=line.ComponentListTotal__c;cost+=line.ComponentCost__c;}line.PackageTotal__c=line.netTotal;});parent.ComponentTotal__c=netTotal;parent.ComponentListTotal__c=listTotal;parent.ComponentCost__c=cost;parent.PackageTotal__c=netTotal+parent.netTotal;}module.exports=QuoteCalculator;},{"../Utils/NumberUtils.js":2,"./AccountModel.js":3,"./DiscountScheduleModel.js":5,"./FieldMetadataIndex.js":7,"./FormulaFieldCalculator.js":8,"./LineCalculator.js":10,"./PluginManager.js":15,"./QuoteLinePriceRuleEvaluator.js":21,"./QuoteSummarizer.js":25,"./TargetCalculator2.js":29,"./Utils/ApexUtils.js":30,"./Utils/IdUtils.js":31,"./Utils/MetaDataUtils.js":33,"./Utils/OAuthUtils.js":35,"js-logger":96,"jsforce":112}],17:[function(require,module,exports){"use strict";var QuoteHandler=require("./QuoteHandler.js");var MDQSegmentHelper=require("./MDQSegmentHelper.js");var QuoteOpportunitySynchronizer=require('./QuoteOpportunitySynchronizer.js');var QuotePriceHandler=require('./QuotePriceHandler.js');var QuoteChangesProcessor=function(){function QuoteChangesProcessor(settings,connection,prefix){_classCallCheck2(this,QuoteChangesProcessor);this.settings=settings;this.devPrefix=settings.developerPrefix;this.conn=connection;this.prefix=prefix;}_createClass(QuoteChangesProcessor,[{key:"process",value:function process(quoteVO,quoteChanges){this.quoteVO=quoteVO;this.quoteChanges=quoteChanges;var self=this;return this.refreshPrices().then(function(){if(self.isNewlyGrouped)QuoteHandler.groupQuote(self.quoteVO,self.settings);if(self.isNewlyUngrouped)QuoteHandler.ungroupQuote(self.quoteVO,self.devPrefix);if(self.isChangedTerm)new MDQSegmentHelper(self.quoteVO,self.settings).updateSegments();return Promise.resolve();});}},{key:"refreshPrices",value:function refreshPrices(){if(this.hasPricebookChanges)return new QuotePriceHandler(this.settings,this.conn,this.prefix).refresh(this.quoteVO);return Promise.resolve();}},{key:"hasPricebookChanges",get:function get(){return this.quoteChanges.pricebookChanges.quoteIds.indexOf(this.quoteVO.record.Id.substring(0,15))!=-1||this.quoteChanges.pricebookChanges.quoteIds.indexOf(this.quoteVO.record.Id)!=-1;}},{key:"isNewlyPrimary",get:function get(){return this.quoteChanges.newlyPrimary.quoteIds.indexOf(this.quoteVO.record.Id.substring(0,15))!=-1||this.quoteChanges.newlyPrimary.quoteIds.indexOf(this.quoteVO.record.Id)!=-1;}},{key:"isNewlyGrouped",get:function get(){return this.quoteChanges.newlyGrouped.quoteIds.indexOf(this.quoteVO.record.Id.substring(0,15))!=-1||this.quoteChanges.newlyGrouped.quoteIds.indexOf(this.quoteVO.record.Id)!=-1;}},{key:"isNewlyUngrouped",get:function get(){return this.quoteChanges.newlyUngrouped.quoteIds.indexOf(this.quoteVO.record.Id.substring(0,15))!=-1||this.quoteChanges.newlyUngrouped.quoteIds.indexOf(this.quoteVO.record.Id)!=-1;}},{key:"isChangedTerm",get:function get(){return this.quoteChanges.changedTerm.quoteIds.indexOf(this.quoteVO.record.Id.substring(0,15))!=-1||this.quoteChanges.changedTerm.quoteIds.indexOf(this.quoteVO.record.Id)!=-1;}},{key:"needsRecalc",get:function get(){return this.quoteChanges.calcQuoteIds.indexOf(this.quoteVO.record.Id.substring(0,15))!=-1||this.quoteChanges.calcQuoteIds.indexOf(this.quoteVO.record.Id)!=-1;}}]);return QuoteChangesProcessor;}();module.exports=QuoteChangesProcessor;},{"./MDQSegmentHelper.js":12,"./QuoteHandler.js":18,"./QuoteOpportunitySynchronizer.js":23,"./QuotePriceHandler.js":24}],18:[function(require,module,exports){"use strict";module.exports.groupQuote=groupQuote;module.exports.ungroupQuote=ungroupQuote;module.exports.addComponents=addComponents;module.exports.buildOptionAndProductIds=buildOptionAndProductIds;module.exports.renumber=renumber;function groupQuote(quote,settings){var prefix=settings.developerPrefix;if(quote.lineItemGroups.length>0)return;quote.record[prefix+'LineItemsGrouped__c']=true;var defaultName=settings.jsqcLabels['lbl_default_group_name'];var value=quote.record[prefix+'DefaultGroupName__c'];if(value)defaultName=value;var groupRecord={Name:defaultName};groupRecord[prefix+'Number__c']=1;groupRecord[prefix+'Account__c']=quote.record[prefix+'Account__c'];var groupVO={key:++quote.nextKey,record:groupRecord,multiSegmentColumns:{},localizedMultiSegmentColumns:{},lineItems:[]};quote.lineItemGroups.push(groupVO);for(var i=0,l=quote.lineItems.length;i<l;i++){var line=quote.lineItems[i];line.parentGroupKey=groupVO.key;quote.lineItemGroups[0].lineItems.push(line);}}function ungroupQuote(quote,prefix){if(quote.lineItemGroups.length==0)return;for(var i=0,l=quote.lineItemGroups.length;i<l;i++){var grp=quote.lineItemGroups[i];if(grp.record.Id){quote.deletedGroupIds.push(grp.record.Id);}}quote.lineItemGroups=[];quote.record[prefix+'LineItemsGrouped__c']=false;for(var ii=0,ll=quote.lineItems.length;ii<ll;ii++){var line=quote.lineItems[ii];line.parentGroupKey=null;line.record[prefix+'Group__c']=null;}}function addComponents(quote,settings,linesById){var prefix=settings.developerPrefix;for(var i=0,l=quote.lineItems.length;i<l;i++){var item=quote.lineItems[i];if(item.record[prefix+"RequiredBy__c"]){var parentItem=linesById[item.record[prefix+"RequiredBy__c"]];item.parentItemKey=parentItem.key;parentItem.record[prefix+'Bundle__c']=true;item.requiredByMessage=settings.msgRequiredBy.replace('{0}',parentItem.record[prefix+'ProductName__c']);if(!item.subscriptionExists&&item.record[prefix+"SubscriptionPricing__c"]){item.subscriptionExists=true;}}if(item.record[prefix+'Favorite__c']){quote.favoriteIds.push(item.record[prefix+'Favorite__c']);}}}function buildOptionAndProductIds(lines,prefix){var optionAndProductIds={optionIds:[],productIds:[]};for(var i=0,l=lines.length;i<l;i++){var line=lines[i];var optionId=line.record[prefix+'ProductOption__c'];var productId=line.record[prefix+'Product__c'];if(optionId&&optionAndProductIds.optionIds.indexOf(optionId)==-1){optionAndProductIds.optionIds.push(optionId);}if(productId&&optionAndProductIds.productIds.indexOf(productId)==-1){optionAndProductIds.productIds.push(productId);}}return optionAndProductIds;}function renumber(quote,settings){var lineItems=quote.lineItems;var prefix=settings.developerPrefix;var segmentKeyToNumberMap={};var idx=1;var invisibleIdx=3000;for(var i=0,l=lineItems.length;i<l;i++){var line=lineItems[i];if(isLineVisibleInEditor(line,settings,prefix)){if(line.record[prefix+'SegmentKey__c']!=null){if(segmentKeyToNumberMap[line.record[prefix+'SegmentKey__c']]){line.record[prefix+'Number__c']=segmentKeyToNumberMap[line.record[prefix+'SegmentKey__c']];}else{line.record[prefix+'Number__c']=idx;segmentKeyToNumberMap[line.record[prefix+'SegmentKey__c']]=idx;idx++;}}else{if(line.record[prefix+'Number__c']!=idx){line.record[prefix+'Number__c']=idx;}idx++;}}else if(line.record[prefix+'Number__c']==null){if(line.record[prefix+'Number__c']!=invisibleIdx){line.record[prefix+'Number__c']=invisibleIdx;}invisibleIdx++;}}}function isLineVisibleInEditor(line,settings,prefix){var visible=line.componentVisibility==null||line.componentVisibility==''||line.componentVisibility=='Always'||line.componentVisibility=='Editor Only';if(visible&&line.record[prefix+'RenewedAsset__c']!=null&&settings.renewedAssetsHiddenWhenEditing){return false;}return visible;}},{}],19:[function(require,module,exports){"use strict";var DateUtils=require('../Utils/DateUtils.js');var ModelUtils=require("./Utils/ModelUtils.js");var QuoteLineModel=require("./QuoteLineModel.js");var ModelProxyFactory=require("./ModelProxyFactory.js");var PROTOTYPE_INITIALIZED=false;var FIELDS=["StartDate__c","EndDate__c","ListTotal__c","NetTotal__c","CustomerTotal__c","Optional__c","SubscriptionTerm__c","TargetCustomerAmount__c","AdditionalDiscountRate__c","CurrencyIsoCode","Quote__c","Id"];function defineGetAndSet(field){var getter;var setter;var sysField=false;switch(field){case'StartDate__c':case'EndDate__c':getter=ModelUtils.dateGetter;setter=ModelUtils.dateSetter;break;case'Id':case'CreatedById':case'LastModifiedById':getter=ModelUtils.idGetter;setter=ModelUtils.invalidSetter;sysField=true;break;case'CreatedDate':case'LastModifiedDate':getter=ModelUtils.dateGetter;setter=ModelUtils.invalidSetter;sysField=true;break;case"CurrencyIsoCode":getter=ModelUtils.standardGetter;setter=ModelUtils.invalidSetter;sysField=true;break;case'Quote__c':getter=ModelUtils.idGetter;setter=ModelUtils.standardSetter;break;default:getter=ModelUtils.standardGetter;setter=ModelUtils.standardSetter;}Object.defineProperty(QuoteLineGroupModel.prototype,field,{get:function get(){var prefix=sysField?'':this.prefix;return getter(prefix+field,this.record,this.settings);},set:function set(v){var prefix=sysField?'':this.prefix;setter(v,prefix+field,this.record);}});}function defineAllGetsAndSets(fields){if(PROTOTYPE_INITIALIZED){return;}var l=fields.length;for(var i=0;i<l;i++){defineGetAndSet(fields[i]);}PROTOTYPE_INITIALIZED=true;}var QuoteLineGroupModel=function(){function QuoteLineGroupModel(quote,data,settings,notifier){_classCallCheck2(this,QuoteLineGroupModel);this._innerModel=ModelProxyFactory.createProxy(data,this,'QuoteLineGroupModel',notifier);this._unproxiedModel=data;this.settings=settings;this.notifier=notifier;this.lineItems=[];this.quote=quote;this.prefix=settings.devPrefix;if(settings.isMultiCurrencyOrg){this.record["CurrencyIsoCode"]=quote.record["CurrencyIsoCode"];}this.listProductTotal=null;this.customerProductTotal=null;this.netProductTotal=null;this.regularProductTotal=null;this.record[this.prefix+"Quote__r"]=quote.record;defineAllGetsAndSets(FIELDS);}_createClass(QuoteLineGroupModel,[{key:"addLineItem",value:function addLineItem(item){this.lineItems.push(item);item.group=this;if(this.Optional__c){item.record[this.prefix+"Optional__c"]=true;}return item;}},{key:"removeLineItem",value:function removeLineItem(item){for(var i=0;i<this.lineItems.length;i++){if(this.lineItems[i].key==item.key){this.lineItems=this.lineItems.slice(0,i).concat(this.lineItems.slice(i+1,this.lineItems.length));return;}}}},{key:"set",value:function set(path,value){this._innerModel[path]=value;}},{key:"record",get:function get(){return this._innerModel.record;}},{key:"listProductTotal",get:function get(){return this._innerModel.listProductTotal;},set:function set(v){this.set('listProductTotal',v);}},{key:"customerProductTotal",get:function get(){return this._innerModel.customerProductTotal;},set:function set(v){this.set('customerProductTotal',v);}},{key:"regularProductTotal",get:function get(){return this._innerModel.regularProductTotal;},set:function set(v){this.set('regularProductTotal',v);}},{key:"netProductTotal",get:function get(){return this._innerModel.netProductTotal;},set:function set(v){this.set('netProductTotal',v);}},{key:"key",get:function get(){return this._innerModel.key;}},{key:"summaries",get:function get(){return this._innerModel.summaries;},set:function set(v){this.set('summaries',v);}},{key:"multiSegmentKeys",get:function get(){return this._innerModel.multiSegmentKeys;},set:function set(v){this.set('multiSegmentKeys',v);}},{key:"multiSegmentColumns",get:function get(){return this._innerModel.multiSegmentColumns;},set:function set(v){this.set('multiSegmentColumns',v);}},{key:"multiSegmentColumnTotals",get:function get(){return this._innerModel.multiSegmentColumnTotals;},set:function set(v){this.set('multiSegmentColumnTotals',v);}},{key:"localizedMultiSegmentColumns",get:function get(){return this._innerModel.localizedMultiSegmentColumns;},set:function set(v){this.set('localizedMultiSegmentColumns',v);}},{key:"multiSegmentRowTotals",get:function get(){return this._innerModel.multiSegmentRowTotals;},set:function set(v){this.set('multiSegmentRowTotals',v);}},{key:"netMultiSegmentTotal",get:function get(){return this._innerModel.netMultiSegmentTotal;},set:function set(v){this.set('netMultiSegmentTotal',v);}},{key:"netNonSegmentTotal",get:function get(){return this._innerModel.netNonSegmentTotal;},set:function set(v){this.set('netNonSegmentTotal',v);}},{key:"hasMultiSegmentLines",get:function get(){return this._innerModel.hasMultiSegmentLines;},set:function set(v){this.set('hasMultiSegmentLines',v);}},{key:"lineItemRowCount",get:function get(){return this._innerModel.lineItemRowCount;},set:function set(v){this.set('lineItemRowCount',v);}},{key:"lineNumberOffset",get:function get(){return this._innerModel.lineItemOffset;},set:function set(v){this.set('lineItemOffset',v);}},{key:"hasDynamicLineItems",get:function get(){var lineCount=this.lineItems.length;for(var i=0;i<lineCount;i++){if(this.lineItems[i].isDynamic){return true;}}return false;}},{key:"effectiveSubscriptionTerm",get:function get(){var term=this.SubscriptionTerm__c;return term!=null?term:this.quote.SubscriptionTerm__c;}},{key:"calculatedSubscriptionTerm",get:function get(){var groupTerm=null;var startDate=this.effectiveStartDate;var endDate=this.effectiveEndDate;if(startDate!=null&&endDate!=null){endDate.setDate(endDate.getDate()+1);if(this.settings.subscriptionTermUnitIsDay){return DateUtils.daysBetween(startDate,endDate);}else{return DateUtils.monthsBetween(startDate,endDate);}}else{return this.effectiveSubscriptionTerm;}}},{key:"effectiveStartDate",get:function get(){return this.StartDate__c||this.quote.StartDate__c;}},{key:"effectiveEndDate",get:function get(){return this.EndDate__c||this.quote.EndDate__c;}},{key:"calculatedEndDate",get:function get(){if(this.effectiveSubscriptionTerm!=null&&this.effectiveStartDate!=null){var endDate=this.effectiveStartDate;var term=Math.floor(this.effectiveSubscriptionTerm);if(this.settings.subscriptionTermUnitIsDay){endDate.setUTCDate(endDate.getUTCDate()+term-1);}else{endDate.setUTCMonth(endDate.getUTCMonth()+term);endDate.setUTCDate(endDate.getUTCDate()-1);}return endDate;}return this.effectiveEndDate;}}]);return QuoteLineGroupModel;}();module.exports=QuoteLineGroupModel;},{"../Utils/DateUtils.js":1,"./ModelProxyFactory.js":14,"./QuoteLineModel.js":20,"./Utils/ModelUtils.js":34}],20:[function(require,module,exports){"use strict";var Constants=require("./Utils/JSQCConstants.js");var DateUtils=require('../Utils/DateUtils.js');var ModelUtils=require("./Utils/ModelUtils.js");var ModelProxyFactory=require("./ModelProxyFactory.js");var PROTOTYPE_INITIALIZED=false;var FIELDS=["Id","OptionType__c","DiscountSchedule__c","TermDiscountSchedule__c","ProductName__c","ProductCode__c","Dimension__c","Dimension__r","ComponentVisibility__c","Bundled__c","Optional__c","NonDiscountable__c","ComponentUpliftedByPackage__c","ComponentDiscountedByPackage__c","NonPartnerDiscountable__c","Existing__c","CarryoverLine__c","Renewal__c","DiscountScheduleType__c","VolumeDiscount__c","TermDiscount__c","DiscountTier__c","TermDiscountTier__c","Quantity__c","PriorQuantity__c","AdditionalQuantity__c","SubscribedAssetIds__c","ComponentSubscriptionScope__c","SubscriptionScope__c","SubscriptionCategory__c","BundledQuantity__c","BatchQuantity__c","BillingFrequency__c","SubscriptionPricing__c","SubscriptionTargetPrice__c","SubscriptionBase__c","Product__c","Number__c","RenewedAsset__c","PricingMethod__c","Discount__c","PartnerDiscount__c","DistributorDiscount__c","AdditionalDiscountAmount__c","PartnerPrice__c","PartnerTotal__c","NetPrice__c","NetTotal__c","UpgradedAsset__c","UpgradedAsset__r","RegularPrice__c","RegularTotal__c","ComponentTotal__c","ComponentListTotal__c","ComponentCost__c","PackageTotal__c","RequiredBy__r","RequiredBy__c","ContractedPrice__c","SpecialPriceType__c","SpecialPrice__c","UnitCost__c","OriginalUnitCost__c","OptionDiscount__c","OptionDiscountAmount__c","ListPrice__c","ListTotal__c","OriginalPrice__c","UpliftAmount__c","Uplift__c","PreviousSegmentUplift__c","PreviousSegmentPrice__c","BlockPrice__c","MaximumPrice__c","MinimumPrice__c","SegmentIndex__c","SegmentLabel__c","SegmentKey__c","MarkupAmount__c","MarkupRate__c","CompoundDiscountRate__c","ProratedPrice__c","ProratedListPrice__c","SubscriptionTerm__c","DefaultSubscriptionTerm__c","SubscriptionPercent__c","ProrateMultiplier__c","StartDate__c","EndDate__c","Group__r","Quote__r","Product__r","ProductOption__c","ProductOption__r","AllowAssetRefund__c","UpgradedQuantity__c","CustomerTotal__c","UpgradedSubscription__c","UpgradedSubscription__r"];function defineGetAndSet(field){var getter;var setter;var sysField=false;switch(field){case'StartDate__c':case'EndDate__c':getter=ModelUtils.dateGetter;setter=ModelUtils.dateSetter;break;case'DiscountSchedule__c':case'TermDiscountSchedule__c':case'RequiredBy__c':case'RenewedAsset__c':case'Product__c':case'BlockPrice__c':case'Dimension__c':case"ContractedPrice__c":case"DiscountTier__c":case"TermDiscountTier__c":case"UpgradedAsset__c":case"UpgradedSubscription__c":getter=ModelUtils.idGetter;setter=ModelUtils.standardSetter;break;case'Id':case'CreatedById':case'LastModifiedById':getter=ModelUtils.idGetter;setter=ModelUtils.invalidSetter;sysField=true;break;case'CreatedDate':case'LastModifiedDate':getter=ModelUtils.dateGetter;setter=ModelUtils.invalidSetter;sysField=true;break;default:getter=ModelUtils.standardGetter;setter=ModelUtils.standardSetter;}Object.defineProperty(QuoteLineModel.prototype,field,{get:function get(){var prefix=sysField?'':this.prefix;return getter(prefix+field,this.record,this.settings);},set:function set(v){var prefix=sysField?'':this.prefix;setter(v,prefix+field,this.record);}});}function defineAllGetsAndSets(fields){if(PROTOTYPE_INITIALIZED){return;}var l=fields.length;for(var i=0;i<l;i++){defineGetAndSet(fields[i]);}Object.defineProperty(QuoteLineModel.prototype,'CustomerPrice__c',{get:function get(){if(this.record[this.prefix+"CustomerPrice__c"]==null&&this.isPricingMethodCustom){this.record[this.prefix+"CustomerPrice__c"]=this.ListPrice__c;}return this.record[this.prefix+"CustomerPrice__c"];},set:function set(v){this.record[this.prefix+"CustomerPrice__c"]=v;}});PROTOTYPE_INITIALIZED=true;}var QuoteLineModel=function(){function QuoteLineModel(parentQuote,parentGroup,data,settings,notifier){_classCallCheck2(this,QuoteLineModel);this._innerModel=ModelProxyFactory.createProxy(data,this,'QuoteLineModel',notifier);this._unproxiedModel=data;this.settings=settings;this.notifier=notifier;this.prefix=settings.devPrefix;defineAllGetsAndSets(FIELDS);this.parentQuote=parentQuote;this.parentGroup=parentGroup;this.listProductTotal=null;this.customerProductTotal=null;this.netProductTotal=null;this.regularProductTotal=null;this.amendedSlabFullRegularPrice=null;this.amendedSlabFullCustomerPrice=null;this.amendedSlabFullPartnerPrice=null;this.amendedSlabFullNetPrice=null;this.parentItem=null;this.components=[];this.componentsById=null;this.componentsByKey=null;if(this.DiscountSchedule__c!=null){this.originalVolumeSchedule=this.DiscountSchedule__c;}if(this.TermDiscountSchedule__c!=null){this.originalTermSchedule=this.TermDiscountSchedule__c;}this.record[this.prefix+"Quote__r"]=parentQuote.record;if(parentGroup!=null){this.record[this.prefix+"Group__r"]=parentGroup.record;}if(data!=null){this.calculateFullTermPrice=data.calculateFullTermPrice;}}_createClass(QuoteLineModel,[{key:"_effectiveQuantity",value:function _effectiveQuantity(slabTreatedAsBlock,useFullQtyOnRenewal){var countsAsExisting=this.countsAsExisting&&(!useFullQtyOnRenewal||this.parentQuote.isAmendment);var netQuantityChange=this.Quantity__c-this.PriorQuantity__c+this.UpgradedQuantity__c;var isRefundable=this.isSubscription||this.AllowAssetRefund__c;if(this.isPricingMethodBlock||slabTreatedAsBlock&&this.DiscountScheduleType__c==='Slab'){var newLineWithZeroQuantity=!countsAsExisting&&this.Quantity__c===0;if(newLineWithZeroQuantity||countsAsExisting&&(netQuantityChange==0||netQuantityChange<0&&!isRefundable)){return 0;}else{return 1;}}else if(!countsAsExisting){return this.Quantity__c;}else if(netQuantityChange>=0){return this.isDynamicSubscription?this.Quantity__c:netQuantityChange;}else{return isRefundable?netQuantityChange:0;}}},{key:"addComponent",value:function addComponent(component){if(this.componentsByKey==null){this.initComponentIndex;}this.components.push(component);this.componentsByKey[component.key]=component;component.parentItem=this;component.parentItemKey=this.key;component.RequiredBy__c=this.Id;component.RequiredBy__r=this.record;var parentProduct="Bundle";if(this.ProductName__c!=null){parentProduct=this.ProductName__c;}component.requiredByMessage=this.settings.requiredByMessage.replace("{0}",parentProduct);return component;}},{key:"removeComponent",value:function removeComponent(component){if(this.componentsByKey==null){this.initComponentIndex();}for(var i=this.components.length-1;i>=0;i--){if(this.components[i].key===component.key){delete this.componentsByKey[component.key];this.components=this.components.slice(0,i).concat(this.components.slice(i+1,this.components.length));return;}}}},{key:"isCountedByDynamicSubscription",value:function isCountedByDynamicSubscription(subLine){if(!this.Optional__c){return true;}if(this.parentGroup!=null&&this.parentGroup===subLine.parentGroup&&this.parentGroup.Optional__c){return true;}return this.SegmentLabel__c!=null&&subLine.Optional__c&&subLine.SegmentLabel__c===this.SegmentLabel__c;}},{key:"getBlockPriceByQuantity",value:function getBlockPriceByQuantity(quantity,currencyCode,hasDiscountSchedule){if(quantity==null){return null;}var endPrice;var blockPriceRelationship=this.Product__r[this.prefix+"BlockPrices__r"];if(blockPriceRelationship!=null){var blockPrices=blockPriceRelationship['records'];var blockPricesWithoutPriceBooks=[];var blockPricesWithPriceBooks=[];var bpCount=blockPrices.length;for(var i=0;i<bpCount;i++){if(blockPrices[i][this.prefix+"PriceBook2__c"]!=null){blockPricesWithPriceBooks.push(blockPrices[i]);}else{blockPricesWithoutPriceBooks.push(blockPrices[i]);}}blockPrices=blockPricesWithPriceBooks.length>0?blockPricesWithPriceBooks:blockPricesWithoutPriceBooks;var newbpCount=blockPrices.length;for(var i=0;i<newbpCount;i++){var bp=blockPrices[i];if(this.settings.isMultiCurrencyOrg){var code=bp["CurrencyIsoCode"];if(code!==currencyCode){continue;}}if(quantity>=bp[this.prefix+"LowerBound__c"]&&quantity<bp[this.prefix+"UpperBound__c"]){return bp;}if(quantity<bp[this.prefix+"LowerBound__c"]&&hasDiscountSchedule){return null;}endPrice=quantity<0?null:bp;}}return endPrice!=null&&(endPrice[this.prefix+"UpperBound__c"]==null||hasDiscountSchedule)?endPrice:null;}},{key:"set",value:function set(path,value){this._innerModel[path]=value;}},{key:"expressQuantityInTermsOfSourceProduct",value:function expressQuantityInTermsOfSourceProduct(sourceProductId){var convertedQty=this.Quantity__c;if(this._innerModel.upgradeSourcesBySourceProductId){var correspondingSource=this._innerModel.upgradeSourcesBySourceProductId[sourceProductId];if(correspondingSource&&correspondingSource[this.prefix+'UpgradeConversionRate__c']){var ratioPieces=correspondingSource[this.prefix+'UpgradeConversionRate__c'].split(':');var sourceRate=ratioPieces[0];var targetRate=ratioPieces[1];convertedQty/=targetRate;convertedQty*=sourceRate;}}return convertedQty;}},{key:"record",get:function get(){return this._innerModel.record;}},{key:"listProductTotal",get:function get(){return this._innerModel.listProductTotal;},set:function set(v){this.set('listProductTotal',v);}},{key:"customerProductTotal",get:function get(){return this._innerModel.customerProductTotal;},set:function set(v){this.set('customerProductTotal',v);}},{key:"regularProductTotal",get:function get(){return this._innerModel.regularProductTotal;},set:function set(v){this.set('regularProductTotal',v);}},{key:"netProductTotal",get:function get(){return this._innerModel.netProductTotal;},set:function set(v){this.set('netProductTotal',v);}},{key:"listTotal",get:function get(){return this._innerModel.listTotal;},set:function set(v){this.set('listTotal',v);}},{key:"customerTotal",get:function get(){return this._innerModel.customerTotal;},set:function set(v){this.set('customerTotal',v);}},{key:"partnerTotal",get:function get(){return this._innerModel.partnerTotal;},set:function set(v){this.set('partnerTotal',v);}},{key:"regularTotal",get:function get(){return this._innerModel.regularTotal;},set:function set(v){this.set('regularTotal',v);}},{key:"netTotal",get:function get(){return this._innerModel.netTotal;},set:function set(v){this.set('netTotal',v);}},{key:"currentQtyListPrice",get:function get(){return this._innerModel.currentQtyListPrice;},set:function set(v){this.set('currentQtyListPrice',v);}},{key:"currentQtySpecialPrice",get:function get(){return this._innerModel.currentQtySpecialPrice;},set:function set(v){this.set('currentQtySpecialPrice',v);}},{key:"currentQtyProratedListPrice",get:function get(){return this._innerModel.currentQtyProratedListPrice;},set:function set(v){this.set('currentQtyProratedListPrice',v);}},{key:"currentQtyListTotal",set:function set(v){this.set('currentQtyListTotal',v);},get:function get(){return this._innerModel.currentQtyListTotal;}},{key:"currentQtyRegularPrice",get:function get(){return this._innerModel.currentQtyRegularPrice;},set:function set(v){this.set('currentQtyRegularPrice',v);}},{key:"currentQtyRegularTotal",get:function get(){return this._innerModel.currentQtyRegularTotal;},set:function set(v){this.set('currentQtyRegularTotal',v);}},{key:"currentQtyCustomerPrice",get:function get(){return this._innerModel.currentQtyCustomerPrice;},set:function set(v){this.set('currentQtyCustomerPrice',v);}},{key:"currentQtyPartnerPrice",get:function get(){return this._innerModel.currentQtyPartnerPrice;},set:function set(v){this.set('currentQtyPartnerPrice',v);}},{key:"currentQtyCustomerTotal",get:function get(){return this._innerModel.currentQtyCustomerTotal;},set:function set(v){this.set('currentQtyCustomerTotal',v);}},{key:"currentQtyNetPrice",get:function get(){return this._innerModel.currentQtyNetPrice;},set:function set(v){this.set('currentQtyNetPrice',v);}},{key:"currentQtyNetTotal",get:function get(){return this._innerModel.currentQtyNetTotal;},set:function set(v){this.set('currentQtyNetTotal',v);}},{key:"grossProfitAmount",get:function get(){return this._innerModel.grossProfitAmount;},set:function set(v){this.set('grossProfitAmount',v);}},{key:"productQuantityScale",get:function get(){return this._innerModel.productQuantityScale;}},{key:"renewalPrice",get:function get(){return this._innerModel.renewalPrice;},set:function set(v){this._innerModel.renewalPrice=v;}},{key:"targetCustomerAmount",get:function get(){if(this._innerModel.targetCustomerAmount!=null){return this._innerModel.targetCustomerAmount;}else{return this._innerModel.record.UnitOverride;}}},{key:"targetCustomerTotal",get:function get(){if(this._innerModel.targetCustomerTotal!=null){return this._innerModel.targetCustomerTotal;}else{return this._innerModel.record.TotalOverride;}}},{key:"renewedSubscriptionDiscounts",get:function get(){return this._innerModel.renewedSubscriptionDiscounts;}},{key:"key",get:function get(){return this._innerModel.key;}},{key:"requiredByMessage",get:function get(){return this._innerModel.requiredByMessage;},set:function set(v){this.set('requiredByMessage',v);}},{key:"parentItemKey",get:function get(){return this._innerModel.parentItemKey;},set:function set(v){this.set('parentItemKey',v);}},{key:"parentGroupKey",get:function get(){return this._innerModel.parentGroupKey;}},{key:"fieldVisibility",get:function get(){return this._innerModel.fieldVisibility;},set:function set(v){this.set('fieldVisibility',v);}},{key:"fieldEditability",get:function get(){return this._innerModel.fieldEditability;},set:function set(v){this.set('fieldEditability',v);}},{key:"amountDiscountProrated",get:function get(){var fieldName=this.settings.prorateAmountDiscountFieldName;this._innerModel.amountDiscountProrated=fieldName&&this.record[fieldName]!=0;return this._innerModel.amountDiscountProrated;}},{key:"defaultDiscountRate",get:function get(){var fieldName=this.settings.defaultAdditionalDiscountFieldName;if(fieldName){this._innerModel.defaultDiscountRate=this.record[fieldName];}return this._innerModel.defaultDiscountRate;}},{key:"isTimeBasedSegment",get:function get(){var dType=this.dimType;return dType===Constants.TYPE_YEARLY_DIMENSION||dType===Constants.TYPE_MONTHLY_DIMENSION||dType===Constants.TYPE_QUARTERLY_DIMENSION||dType===Constants.TYPE_CUSTOM_DIMENSION;}},{key:"blockPricingField",get:function get(){if(this.Product__r==null){return null;}return this.Product__r[this.prefix+"BlockPricingField__c"];}},{key:"quoteId",get:function get(){return this.parentQuote.Id;}},{key:"initComponentIndex",get:function get(){this.componentsByKey={};this.componentsById={};var componentCount=this.components.length;for(var i=0;i<componentCount;i++){var component=this.components[i];this.componentsById[component.Id]=component;this.componentsByKey[component.key]=component;}}},{key:"isDynamicSubscription",get:function get(){return this.isSubscription&&this.isDynamic;}},{key:"isDynamicAsset",get:function get(){return!this.isSubscription&&this.isDynamic;}},{key:"isDynamic",get:function get(){var pm=this.PricingMethod__c;var sp=this.SubscriptionPricing__c;return pm!=null&&pm.toLowerCase()===Constants.PRICING_METHOD_PERCENT_OF_TOTAL||sp!=null&&sp.toLowerCase()===Constants.PRICING_METHOD_PERCENT_OF_TOTAL;}},{key:"isYearlyDimension",get:function get(){return this.dimType===Constants.TYPE_YEARLY_DIMENSION;}},{key:"isCustomDimension",get:function get(){return this.dimType===Constants.TYPE_CUSTOM_DIMENSION;}},{key:"isVolumeDiscounted",get:function get(){return this.DiscountSchedule__c!=null;}},{key:"isTermDiscounted",get:function get(){return this.Bundled__c!=true&&this.TermDiscountSchedule__c!=null;}},{key:"isOptionTypeComponent",get:function get(){return this.OptionType__c!=null&&this.OptionType__c.toLowerCase()==='component';}},{key:"isOptionTypeAccessory",get:function get(){return this.OptionType__c!=null&&this.OptionType__c.toLowerCase()==='accessory';}},{key:"isExcludedFromMaintenance",get:function get(){return this.Product__c!=null&&this.Product__r!=null&&this.Product__r[this.prefix+"ExcludeFromMaintenance__c"]===true;}},{key:"isIncludedInMaintenance",get:function get(){return this.Product__c!=null&&this.Product__r!=null&&this.Product__r[this.prefix+"IncludeInMaintenance__c"]===true;}},{key:"isDiscountable",get:function get(){return!this.Bundled__c&&!this.NonDiscountable__c&&!this.isPricingMethodCustom;}},{key:"isSubscriptionBaseNet",get:function get(){return this.SubscriptionBase__c!=null&&this.SubscriptionBase__c.toLowerCase()==='net';}},{key:"isSubscriptionBaseCustomer",get:function get(){return this.SubscriptionBase__c!=null&&this.SubscriptionBase__c.toLowerCase()==='customer';}},{key:"isSubscriptionBaseRegular",get:function get(){return this.SubscriptionBase__c!=null&&this.SubscriptionBase__c.toLowerCase()==="regular";}},{key:"isSubscriptionBaseList",get:function get(){return this.SubscriptionBase__c!=null&&this.SubscriptionBase__c.toLowerCase()==="list";}},{key:"isPricingMethodCustom",get:function get(){return this.PricingMethod__c===Constants.PRICING_METHOD_CUSTOM;}},{key:"isPricingMethodCost",get:function get(){return this.PricingMethod__c===Constants.PRICING_METHOD_COST;}},{key:"isPricingMethodBlock",get:function get(){return this.PricingMethod__c===Constants.PRICING_METHOD_BLOCK;}},{key:"isTargetDiscountable",get:function get(){return!this.Optional__c&&!this.Bundled__c&&this.isDiscountable;}},{key:"isComponent",get:function get(){return this.RequiredBy__c!=null||this.parentItemKey!=null;}},{key:"isComponentSubscriptionScopePackage",get:function get(){return this.ComponentSubscriptionScope__c==='Package';}},{key:"isComponentSubscriptionScopeComponents",get:function get(){return this.ComponentSubscriptionScope__c==='Components';}},{key:"isComponentSubscriptionScopeBoth",get:function get(){return this.ComponentSubscriptionScope__c==='Both';}},{key:"isComponentSubscriptionScopeParentPackage",get:function get(){return this.ComponentSubscriptionScope__c==='Parent Package';}},{key:"isComponentSubscriptionScopeParentComponents",get:function get(){return this.ComponentSubscriptionScope__c==='Parent Components';}},{key:"isComponentSubscriptionScopeParentBoth",get:function get(){return this.ComponentSubscriptionScope__c==='Parent Both';}},{key:"isSubscriptionScopeGroup",get:function get(){return this.SubscriptionScope__c==='Group';}},{key:"isComponentUpliftedByPackage",get:function get(){return this.ComponentUpliftedByPackage__c===true;}},{key:"isComponentDiscountedByPackage",get:function get(){return this.ComponentDiscountedByPackage__c===true;}},{key:"isSubscription",get:function get(){return this.SubscriptionPricing__c!=null;}},{key:"isPartnerDiscountable",get:function get(){return!this.Bundled__c&&!(this.NonPartnerDiscountable__c===true);}},{key:"hasComponents",get:function get(){return this.components!=null&&this.components.length>0;}},{key:"hasCostSchedule",get:function get(){return this.Product__r!=null&&this.Product__r[this.prefix+"CostSchedule__c"]!=null;}},{key:"costScheduleId",get:function get(){return this.Product__r==null?null:this.Product__r[this.prefix+"CostSchedule__c"];}},{key:"termDiscountLevel",get:function get(){return this.Product__r==null?null:this.Product__r[this.prefix+"TermDiscountLevel__c"];}},{key:"countsAsExisting",get:function get(){return this.Existing__c||this.CarryoverLine__c;}},{key:"effectiveQuantity",get:function get(){return this._effectiveQuantity(true,false);}},{key:"effectiveListQuantity",get:function get(){return this._effectiveQuantity(false,false);}},{key:"effectiveQuantityForPercentOfTotalBase",get:function get(){return this._effectiveQuantity(true,true);}},{key:"effectiveListQuantityForPercentOfTotalBase",get:function get(){return this._effectiveQuantity(false,true);}},{key:"preUpgradeQuantity",get:function get(){return this.Quantity__c+this.UpgradedQuantity__c;}},{key:"sourceLineKey",get:function get(){return this._innerModel.sourceLineKey;}},{key:"priorBundledQuantity",get:function get(){var prior=this.PriorQuantity__c;var parentPrior=this.parentItem?this.parentItem.PriorQuantity__c:null;if(parentPrior!=null&&prior!=null&&this.isOptionTypeComponent){return prior/parentPrior;}else{return prior;}}},{key:"carryoverQuantity",get:function get(){var carryoverQuantity=this.PriorQuantity__c;if(this.CarryoverLine__c&&this.sourceLineKey!=null){var sourceLine=this.parentQuote.lineItemsByKey[this.sourceLineKey];if(sourceLine){carryoverQuantity=sourceLine.priorBundledQuantity;if(this.isOptionTypeComponent){carryoverQuantity*=this.parentItem.Quantity__c;}}}return carryoverQuantity;}},{key:"effectiveAdditionalDiscountRate",get:function get(){if(this.Discount__c==null){var isDiscountedComponent=this.isComponent&&this.isComponentDiscountedByPackage;var parentHasDiscount=this.parentItem!=null&&this.parentItem.effectiveAdditionalDiscountRate!=null;if(isDiscountedComponent&&parentHasDiscount){return this.parentItem.effectiveAdditionalDiscountRate;}else if(this.defaultDiscountRate!=null){return this.defaultDiscountRate;}else if(this.parentGroup!=null&&this.parentGroup.AdditionalDiscountRate__c!=null){return this.parentGroup.AdditionalDiscountRate__c;}else{return this.parentQuote.CustomerDiscount__c;}}return this.Discount__c;}},{key:"effectiveUplift",get:function get(){if(this.isComponent&&this.isComponentUpliftedByPackage&&this.parentItem!=null&&(this.SegmentIndex__c>1||this.parentQuote.isRenewal)){return this.parentItem.effectiveUplift;}else if(this.Uplift__c==null){return 0;}return this.Uplift__c;}},{key:"actualQuantity",get:function get(){return(this.Existing__c||this.CarryoverLine__c)&&this.PriorQuantity__c!=null?this.Quantity__c-this.PriorQuantity__c+this.UpgradedQuantity__c:this.Quantity__c;}},{key:"dimType",get:function get(){if(this.Dimension__c!=null){if(this._innerModel.dimensionType!=null){return this._innerModel.dimensionType;}else if(this._innerModel.record[this.prefix+'Dimension__r']!=null){return this._innerModel.record[this.prefix+'Dimension__r'][this.prefix+'Type__c'];}}}},{key:"defaultTerm",get:function get(){return this.DefaultSubscriptionTerm__c==null?12:this.DefaultSubscriptionTerm__c;}},{key:"subscriptionTerm",get:function get(){if(this.SubscriptionTerm__c!=null){return this.SubscriptionTerm__c;}else if(this.parentGroup!=null&&this.parentGroup.SubscriptionTerm__c!=null){return this.parentGroup.SubscriptionTerm__c;}else{return this.parentQuote.SubscriptionTerm__c;}}},{key:"effectiveSubscriptionTerm",get:function get(){var lineTerm=null;var startDate=this.effectiveStartDate;var endDate=this.effectiveEndDate;if(startDate!=null&&endDate!=null){endDate.setDate(endDate.getDate()+1);return this.settings.subscriptionTermUnitIsDay?DateUtils.daysBetween(startDate,endDate):DateUtils.monthsBetween(startDate,endDate);}return this.subscriptionTerm!=null?this.subscriptionTerm:this.DefaultSubscriptionTerm__c;}},{key:"effectiveStartDate",get:function get(){var quote=this.parentQuote;var group=this.parentGroup;if(this.dimType==Constants.TYPE_YEARLY_DIMENSION){if(this.SegmentIndex__c>1&&quote.FirstSegmentTermEndDate__c!=null){var fsed=quote.FirstSegmentTermEndDate__c;fsed.setUTCDate(fsed.getUTCDate()+1);fsed.setUTCFullYear(fsed.getUTCFullYear()+this.SegmentIndex__c-2);return fsed;}var date=(group!=null?group.StartDate__c:null)||quote.StartDate__c||new Date();date.setUTCFullYear(date.getUTCFullYear()+this.SegmentIndex__c-1);return date;}else if(this.dimType==Constants.TYPE_QUARTERLY_DIMENSION||this.dimType==Constants.TYPE_MONTHLY_DIMENSION){var multiplier=this.dimType==Constants.TYPE_QUARTERLY_DIMENSION?3:1;if(this.SegmentIndex__c>1&&quote.FirstSegmentTermEndDate__c!=null){var fsed=quote.FirstSegmentTermEndDate__c;fsed.setUTCDate(fsed.getUTCDate()+1);if(!this.settings.subscriptionTermUnitIsDay){fsed.setUTCMonth(fsed.getUTCMonth()+(this.SegmentIndex__c-2)*multiplier);}else{fsed.setUTCDate(fsed.getUTCDate()+(this.SegmentIndex__c-2)*30*multiplier);}return fsed;}date=quote.StartDate__c||new Date();if(!this.settings.subscriptionTermUnitIsDay){date.setUTCMonth(date.getUTCMonth()+(this.SegmentIndex__c-1)*multiplier);}else{date.setUTCDate(date.getUTCDate()+(this.SegmentIndex__c-1)*30*multiplier);}return date;}return this.StartDate__c||(group!=null?group.StartDate__c:null)||quote.StartDate__c;}},{key:"effectiveEndDate",get:function get(){var quote=this.parentQuote;var group=this.parentGroup;var isFixedTimeSegment=this.isTimeBasedSegment&&this.dimType!=Constants.TYPE_CUSTOM_DIMENSION;if(isFixedTimeSegment&&this.effectiveStartDate!=null){if(this.SegmentIndex__c==1&&quote.FirstSegmentTermEndDate__c!=null){return quote.FirstSegmentTermEndDate__c;}var fullTermEndDate=this.effectiveStartDate;if(this.dimType==Constants.TYPE_YEARLY_DIMENSION){fullTermEndDate.setUTCFullYear(fullTermEndDate.getUTCFullYear()+1);}else{var multiplier=this.dimType==Constants.TYPE_QUARTERLY_DIMENSION?3:1;if(!this.settings.subscriptionTermUnitIsDay){fullTermEndDate.setUTCMonth(fullTermEndDate.getUTCMonth()+multiplier);}else{fullTermEndDate.setUTCDate(fullTermEndDate.getUTCDate()+30*multiplier);}}fullTermEndDate.setUTCDate(fullTermEndDate.getUTCDate()-1);var quoteEndDate=group==null?quote.effectiveEndDate:group.effectiveEndDate||group.calculatedEndDate;return quoteEndDate!=null&&quoteEndDate<fullTermEndDate?quoteEndDate:fullTermEndDate;}return this.EndDate__c||(group!=null?group.EndDate__c:null)||quote.EndDate__c;}},{key:"isVisibleInLineEditor",get:function get(){var vis=this.ComponentVisibility__c;var visAlwaysOrEditor=vis!=null&&(vis.toLowerCase()=='always'||vis.toLowerCase()=='editor only');if(visAlwaysOrEditor&&this.RenewedAsset__c!=null&&this.settings.isRenewedAssetsHiddenWhenEditing){return false;}return visAlwaysOrEditor;}},{key:"displayedSubtotalField",get:function get(){var fieldName=this.settings.lineEditorSubtotalsField;if(fieldName!=null&&fieldName.toLowerCase()!='donotdisplay'&&fieldName.toLowerCase()!='default'){return this.record[fieldName];}else{return this.parentQuote.applyAdditionalDiscountLast?this.CustomerPrice__c:this.NetPrice__c;}}}]);return QuoteLineModel;}();module.exports=QuoteLineModel;},{"../Utils/DateUtils.js":1,"./ModelProxyFactory.js":14,"./Utils/JSQCConstants.js":32,"./Utils/ModelUtils.js":34}],21:[function(require,module,exports){"use strict";var SummaryVariableCalculator=require("./SummaryVariableCalculator.js");var ApexUtils=require("./Utils/ApexUtils.js");var MetaDataUtils=require("./Utils/MetaDataUtils.js");var OperatorsUtils=require("./Utils/OperatorsUtils.js");var LookupTableMap=require('./LookupTableMap.js');var jsforce=require("jsforce");var Esprima=require("esprima");var QuoteLinePriceRuleEvaluator=function(){function QuoteLinePriceRuleEvaluator(quote,metadataIndex,formulaFieldEngine,settings){_classCallCheck2(this,QuoteLinePriceRuleEvaluator);this.quote=quote;this.quoteLines=quote.lineItems;this.accountId=quote.Account__c;this.settings=settings;this.prefix=settings.devPrefix;this.initialized=false;this.metadataIndex=metadataIndex;this.formulaFieldEngine=formulaFieldEngine;}_createClass(QuoteLinePriceRuleEvaluator,[{key:"initialize",value:function initialize(){if(this.initialized){return Promise.resolve();}var self=this;return this.loadPriceRules().then(function(results){self.priceRules=results.map(function(rule){return new PriceRule(rule,self.settings);});return self.loadSummaryVariables();}).then(function(results){self.referencedVariables=results;return self.loadAssetsAndSubs();}).then(function(results){self.assetsAndSubs=results;self.initialized=true;});}},{key:"loadPriceRules",value:function loadPriceRules(){var prefix=this.prefix==""?"":"SBQQ";return this.getApex().read(prefix,'PriceRuleServiceProvider.PriceRuleReader','PriceRules');}},{key:"loadSummaryVariables",value:function loadSummaryVariables(){var prefix=this.prefix==""?"":"SBQQ";var neededSumVarIds=[];this.priceRules.forEach(function(rule){neededSumVarIds=neededSumVarIds.concat(rule.getSumVarIds());},this);var svContext={'svIds':neededSumVarIds};return this.getApex().load(prefix,'SummaryVariableServiceProvider.SummaryVariableLoader','SummaryVariables',svContext);}},{key:"loadAssetsAndSubs",value:function loadAssetsAndSubs(){if(this.accountId==null){return Promise.resolve([]);}var prefix=this.prefix;var calloutPrefix=prefix==""?"":"SBQQ";var assetFields=[];var subscriptionFields=[];for(var svId in this.referencedVariables){if(this.referencedVariables.hasOwnProperty(svId)){var sv=this.referencedVariables[svId];if(sv[prefix+"TargetObject__c"]=='Asset'){if(sv[prefix+"FilterField__c"]!=null){assetFields.push(sv[prefix+"FilterField__c"]);}if(sv[prefix+"ConstraintField__c"]!=null){assetFields.push(sv[prefix+"ConstraintField__c"]);}if(sv[prefix+"AggregateField__c"]!=null){assetFields.push(sv[prefix+"AggregateField__c"]);}}else if(sv[prefix+"TargetObject__c"]=='Subscription'){if(sv[prefix+"FilterField__c"]!=null){subscriptionFields.push(sv[prefix+"FilterField__c"]);}if(sv[prefix+"ConstraintField__c"]!=null){subscriptionFields.push(sv[prefix+"ConstraintField__c"]);}if(sv[prefix+"AggregateField__c"]!=null){subscriptionFields.push(sv[prefix+"AggregateField__c"]);}}}}var context={'accountId':this.accountId,'assetFields':assetFields,'subscriptionFields':subscriptionFields};return this.getApex().load(calloutPrefix,'AssetAndSubscriptionServiceProvider.AssetAndSubLoader','AssetsAndSubs',context);}},{key:"setConnection",value:function setConnection(conn){this.conn=conn;}},{key:"setApex",value:function setApex(apex){this.apex=apex;}},{key:"getApex",value:function getApex(){if(this.apex)return this.apex;var conn=this.conn||new jsforce.Connection({accessToken:sfSessionId});return ApexUtils(conn);}},{key:"buildSummaryVariableTargets",value:function buildSummaryVariableTargets(){var result=[];this.quoteLines.forEach(function(line){result.push(line.record);},this);if(this.accountId!=null){result=result.concat(this.assetsAndSubs||[]);}return result;}},{key:"evaluate",value:function evaluate(quote,eventPeriod){var self=this;return this.initialize().then(function(){self.variableCalculator=new SummaryVariableCalculator(self.referencedVariables,self.settings);self.variableCalculator.calculate(self.quote,self.buildSummaryVariableTargets());var rulesToExecute={};var orderedRuleIds=[];self.priceRules.forEach(function(rule){if(ruleHasCurrentEvaluationEvent(rule,eventPeriod)){var resultObject=self.isRuleSatisfied(rule);if(resultObject['result']==true){orderedRuleIds.push(rule.id);rulesToExecute[rule.id]={rule:rule,targets:resultObject['lines']};}}},this);var tableMap=new LookupTableMap(rulesToExecute,quote,self.metadataIndex);var cachedCalloutNeeded=tableMap.containsSatisfiableTables;if(cachedCalloutNeeded){var startTime=new Date();return self.getLookupRecords(tableMap).then(function(results){var cacheEndTime=new Date();console.log('time using cache = '+(cacheEndTime.getTime()-startTime.getTime()));self.lookupData=typeof results==='string'?JSON.parse(results):results;self.executePriceActions(rulesToExecute,orderedRuleIds);});}else{self.executePriceActions(rulesToExecute,orderedRuleIds);return Promise.resolve();}});}},{key:"executePriceActions",value:function executePriceActions(rulesToExecute,ruleIds){ruleIds.forEach(function(rId){var pRule=rulesToExecute[rId].rule;var targets=rulesToExecute[rId].targets;if(pRule.lookupObject!=null&&pRule.queries.length!=0){if(pRule.hasQuoteActions){var lastLineRows=this.getQueryResult(pRule,targets[targets.length-1]);}pRule.actions.forEach(function(action){if(action.targetObject=='Quote'){if(lastLineRows.length!=0){this.applyActionToTarget(action,this.quote,lastLineRows);}}else{targets.forEach(function(target){var rows=this.getQueryResult(pRule,target);if(rows.length!=0){this.applyActionToTarget(action,target,rows);}},this);}},this);}else{pRule.actions.forEach(function(action){if(action.targetObject=='Quote'){this.applyActionToTarget(action,this.quote,null);}else{targets.forEach(function(target){this.applyActionToTarget(action,target,null);},this);}},this);}},this);}},{key:"applyActionToTarget",value:function applyActionToTarget(action,target,lookupData){if(this.quote.priceRuleTargetFieldsToIgnore!=null&&this.quote.priceRuleTargetFieldsToIgnore.indexOf(action.targetField)>=0)return;var targetField=MetaDataUtils.getField(MetaDataUtils.getObjectType(target),action.targetField,this.prefix);if(targetField!=null){var fieldMD=this.metadataIndex.getMetadataForField(MetaDataUtils.getObjectType(target),targetField);var value;if(action.sourceLookupField!=null){if(!lookupData)throw new Error(this.settings.getLabelByKey("lbl_source_lookup_field_requires_query").replace("{0}",action.rule));value=lookupData[0][action.sourceLookupField];if(value==null){this.set(target,targetField,null);}else{switch(fieldMD.type){case'Number':case'Currency':this.set(target,targetField,Number(value).valueOf());break;case'Checkbox':this.set(target,targetField,convertStringToBoolean(value));break;default:this.set(target,targetField,value);}}}else if(action.sourceField!=null){value=target.record[action.sourceField];if(value===undefined){var warningString=this.settings.getLabelByKey("msg_js_warn_src_action_field_null").replace("{0}",action.id).replace("{1}",MetaDataUtils.getObjectType(target)+"."+action.sourceField);console.warn(warningString);this.set(target,targetField,null);}else{this.set(target,targetField,value);}}else if(action.sourceVariable!=null){value=this.variableCalculator.getResult(action.sourceVariable);value=value==null?null:value;this.set(target,targetField,value);}else if(action.formula!=null){value=this.formulaFieldEngine.parseRuleFormula(action.formula,target.record,this.quote.record,targetField);value=value==null?null:value;this.set(target,targetField,value);}else{value=action.actionValue;if(value==null){this.set(target,targetField,null);}else{switch(fieldMD.type){case'Number':case'Currency':this.set(target,targetField,Number(value).valueOf());break;case'Checkbox':this.set(target,targetField,convertStringToBoolean(value));break;default:this.set(target,targetField,value);}}}}}},{key:"set",value:function set(target,targetField,value){target.record[targetField]=value;}},{key:"getLookupRecords",value:function getLookupRecords(tableMap){var prefix=this.prefix==""?"":"SBQQ";return this.getApex().loadLookupTables(prefix,tableMap);}},{key:"isRuleSatisfied",value:function isRuleSatisfied(rule){if(!rule.hasConditions){return conditionResultFactory(true,this.quote.lineItems);}var resultMap={};var len;if(rule.quoteConditions.length!=0){var quoteConds=rule.quoteConditions;len=quoteConds.length;for(var i=0;i<len;i++){var quoteCond=quoteConds[i];var targetType=quoteCond.testedField!=null?'field':'formula';var result=this.evaluateCondition(quoteCond,this.quote.record,targetType);if(rule.resultAllowsShortCircuit(result)){return conditionResultFactory(result,this.quote.lineItems);}resultMap[quoteCond.conditionNum]=result;}}if(rule.sumVarConditions.length!=0){var svConds=rule.sumVarConditions;len=svConds.length;for(var i=0;i<len;i++){var svCond=svConds[i];var result=this.evaluateCondition(svCond,svCond.testedVariableId,'summary variable');if(rule.resultAllowsShortCircuit(result)){return conditionResultFactory(result,this.quote.lineItems);}resultMap[svCond.conditionNum]=result;}}if(rule.quoteLineConditions.length==0){return conditionResultFactory(handleFinalResult(rule,resultMap),this.quote.lineItems);}else{var lineConditions=rule.quoteLineConditions;len=lineConditions.length;var lineCount=this.quoteLines.length;var satisfyingLines=[];if(lineCount==0){if(rule.resultAllowsShortCircuit(false)){return conditionResultFactory(false,[]);}else{return conditionResultFactory(handleFinalResult(rule,resultMap),[]);}}for(var i=0;i<lineCount;i++){var line=this.quoteLines[i];var exitedEarly=false;for(var j=0;j<len;j++){var lineCond=lineConditions[j];var targetType=lineCond.testedField!=null?'field':'formula';var result=this.evaluateCondition(lineCond,line.record,targetType);if(rule.resultAllowsShortCircuit(result)){if(result==true){satisfyingLines.push(line);}exitedEarly=true;break;}resultMap[lineCond.conditionNum]=result;}if(!exitedEarly&&handleFinalResult(rule,resultMap)){satisfyingLines.push(line);}}return conditionResultFactory(satisfyingLines.length!=0,satisfyingLines);}}},{key:"evaluateCondition",value:function evaluateCondition(condition,target,targetType){var testedValue=null;if(targetType==='summary variable'){testedValue=this.variableCalculator.getResult(target);}else if(targetType=='field'){var testedField=condition.testedField;var field=MetaDataUtils.getField(condition.testedObject,testedField,this.prefix);if(field!=null){testedValue=target[field];}if(testedValue===undefined){var warningString=this.settings.getLabelByKey('msg_js_warn_condition_field_undefined').replace("{0}",condition.id).replace("{1}",MetaDataUtils.getRecordType(target)+"."+condition.testedField);console.warn(warningString);}}else if(targetType=='formula'){if(condition.testedFormula==null){throw Error('Error: Price Condition ['+condition.id+'] must test against a summary variable, field, or formula.');}testedValue=this.formulaFieldEngine.parseRuleFormula(condition.testedFormula,target,this.quote.record,null);}else{var targetMsg=this.settings.getLabelByKey("msg_js_err_condition_target_object").replace("{0}",condition.id);throw new Error(targetMsg);}var filterValue=null;if(condition.filterType=="Value"){filterValue=condition.filterValue;}else if(condition.filterType=="Variable"){filterValue=this.variableCalculator.getResult(condition.filterVariableId);}else if(condition.filterType=="Formula"){if(condition.filterFormula==null){throw Error('Error: Price Condition ['+condition.id+'] has a Filter Type of "Formula", but has no Filter Formula.');}filterValue=this.formulaFieldEngine.parseRuleFormula(condition.filterFormula,target,this.quote.record,null);}var op=OperatorsUtils.getInstance(condition.operator);if(op==null){var invalidOpMsg=this.settings.getLabelByKey("msg_js_err_invalid_op_price_condition").replace("{0}",condition.operator).replace("{1}",condition.id);throw new Error(invalidOpMsg);}return op.evaluate(testedValue,filterValue);}},{key:"getQueryResult",value:function getQueryResult(rule,target){var values=[];var fields=[];var ops=[];rule.queries.forEach(function(query){var testedValue=null;if(query.matchType=='Static Value'&&query.testedValue!=null){testedValue=query.testedValue;}else if(query.matchType=='Field Value'&&query.testedField!=null){var queryTarget=query.testedObject=='Quote'?this.quote:target;if(queryTarget==null){return[];}if(query.testedField.indexOf('.')>-1){}else{var field=MetaDataUtils.getField(query.testedObject,query.testedField,this.prefix);if(field!=null){testedValue=queryTarget.record[field];}}}if(query.lookupField!=null){values.push(testedValue);fields.push(query.lookupField);var op=OperatorsUtils.getInstance(query.operator);if(op==null){var invalidOpMsg=this.settings.getLabelByKey("msg_js_err_invalid_lookup_operator").replace("{0}",query.operator).replace("{1}",query.id);throw new Error(invalidOpMsg);}ops.push(query.operator);}},this);if(this.lookupData!=null){var lookupDataRowsById=this.lookupData[rule.lookupObject];var results=this.evaluateQuery(lookupDataRowsById,fields,values,ops);if(results.length>1){var multipleResultMsg=this.settings.getLabelByKey("msg_multiple_lookup_results").replace("{0}",rule.id);throw new Error(multipleResultMsg);}return results;}else{return[];}}},{key:"evaluateQuery",value:function evaluateQuery(rowsById,fields,values,ops){var results=[];if(rowsById==null){return results;}for(var rowId in rowsById){var row=rowsById[rowId];var match=false;for(var i=0;i<fields.length;i++){var op=OperatorsUtils.getInverseInstance(ops[i]);if(values[i]==null){match=false;break;}if(op.evaluate(row[fields[i]],values[i])){match=true;}else{match=false;break;}}if(match){results.push(row);}}return results;}}]);return QuoteLinePriceRuleEvaluator;}();function ruleHasCurrentEvaluationEvent(rule,currentEvent){var ruleEvents=rule.evaluationEvent;if(currentEvent==='On Calculate'){return!ruleEvents||ruleEvents===''||ruleEvents.indexOf(currentEvent)!==-1;}else if(currentEvent==='Before Calculate'){return ruleEvents&&(ruleEvents.indexOf('On Load')!==-1||ruleEvents.indexOf('Before Calculate')!==-1);}else{return ruleEvents&&ruleEvents.indexOf(currentEvent)!==-1;}}function conditionResultFactory(result,satisfyingLines){return{'result':result,'lines':satisfyingLines};}function handleFinalResult(rule,resultMap){if(rule.conditionsMet=='All'){return true;}else if(rule.conditionsMet=='Any'){return false;}else if(rule.conditionsMet=='Custom'){return evaluateAdvancedCondition(rule,resultMap);}}function evaluateAdvancedCondition(rule,resultMap){var conditionString=rule.advancedCondition;if(conditionString==null){var noConditionMsg=rule.settings.getLabelByKey("msg_js_err_no_advanced_condition").replace("{0}",rule.id);throw Error(noConditionMsg);}try{conditionString=conditionString.toUpperCase();conditionString=conditionString.replace(/OR/g,"||");conditionString=conditionString.replace(/AND/g,"&&");var ruleTree=Esprima.parse(conditionString);return evaluateAST(ruleTree,resultMap);}catch(e){var badConditionMsg=rule.settings.getLabelByKey('msg_js_err_bad_advanced_condition').replace("{0}",rule.id);throw Error(badConditionMsg);}}function evaluateAST(tree,conditionMap){switch(tree.type){case"Program":return evaluateAST(tree.body[0],conditionMap);case"ExpressionStatement":return evaluateAST(tree.expression,conditionMap);case"LogicalExpression":if(tree.operator==="||"){return evaluateAST(tree.left,conditionMap)||evaluateAST(tree.right,conditionMap);}else{return evaluateAST(tree.left,conditionMap)&&evaluateAST(tree.right,conditionMap);}case"Literal":var conditionNumber=tree.raw;return conditionMap[conditionNumber]||false;default:throw Error();}}function convertStringToBoolean(str){if(typeof str==='boolean'){return str;}var s=str.toLowerCase();if(s=='true'){return true;}else if(s=="false"){return false;}else if(Number(s)===1){return true;}else if(Number(s)===0){return false;}else{return null;}}var PriceRule=function(){function PriceRule(record,settings){_classCallCheck2(this,PriceRule);this.record=record;this.id=record.Id;this.settings=settings;var prefix=settings.devPrefix;this.prefix=prefix;this.evaluationEvent=record[prefix+'EvaluationEvent__c'];this.conditionsMet=record[prefix+'ConditionsMet__c'];this.targetObject=record[prefix+'TargetObject__c'];this.lookupObject=record[prefix+'LookupObject__c'];this.advancedCondition=record[prefix+"AdvancedCondition__c"];this.hasConditions=false;this.quoteConditions=[];this.quoteLineConditions=[];this.sumVarConditions=[];this.queries=[];this.actions=[];this.hasQuoteActions=false;if(record[prefix+"PriceActions__r"]!=null){record[prefix+'PriceActions__r'].records.forEach(function(action){var actionObj=new PriceAction(action,prefix);this.actions.push(actionObj);if(actionObj.targetObject=='Quote'){this.hasQuoteActions=true;}},this);}if(record[prefix+"PriceConditions__r"]!=null){record[prefix+'PriceConditions__r'].records.forEach(function(condition){var cond=new PriceCondition(condition,prefix);this.hasConditions=true;if(cond.testedField!=null||cond.testedFormula!=null){(cond.testedObject=='Quote'?this.quoteConditions:this.quoteLineConditions).push(cond);}else if(cond.testedVariableId!=null||cond.testedObject=='Summary Variable'){this.sumVarConditions.push(cond);}},this);}if(record[prefix+'PriceRuleLookupQueries__r']!=null){record[prefix+'PriceRuleLookupQueries__r'].records.forEach(function(query){this.queries.push(new PriceQuery(query,prefix));},this);}}_createClass(PriceRule,[{key:"resultAllowsShortCircuit",value:function resultAllowsShortCircuit(result){return this.conditionsMet=='All'&&!result||this.conditionsMet=='Any'&&result;}},{key:"getSumVarIds",value:function getSumVarIds(){var svIds=[];var condIdGetter=function condIdGetter(condition){if(condition.filterVariableId!=null){svIds.push(condition.filterVariableId);}if(condition.testedVariableId!=null){svIds.push(condition.testedVariableId);}};var actionIdGetter=function actionIdGetter(action){if(action.sourceVariable!=null){svIds.push(action.sourceVariable);}};if(this.hasConditions){this.quoteConditions.forEach(condIdGetter);this.quoteLineConditions.forEach(condIdGetter);this.sumVarConditions.forEach(condIdGetter);}this.actions.forEach(actionIdGetter);return svIds;}}]);return PriceRule;}();var PriceAction=function PriceAction(action,prefix){_classCallCheck2(this,PriceAction);this.id=action.Id;this.targetField=action[prefix+'Field__c'];this.targetObject=action[prefix+'TargetObject__c'];this.sourceField=action[prefix+'ValueField__c'];this.sourceLookupField=action[prefix+'SourceLookupField__c'];this.sourceVariable=action[prefix+'SourceVariable__c'];this.actionValue=action[prefix+'Value__c'];this.formula=action[prefix+'Formula__c'];this.rule=action[prefix+'Rule__c'];};var PriceCondition=function PriceCondition(condition,prefix){_classCallCheck2(this,PriceCondition);this.id=condition.Id;this.conditionNum=condition[prefix+"Index__c"];this.testedObject=condition[prefix+'Object__c']||'Quote';this.testedField=condition[prefix+'Field__c'];this.testedVariableId=condition[prefix+'TestedVariable__c'];this.testedFormula=condition[prefix+'TestedFormula__c'];this.operator=condition[prefix+'Operator__c'];this.filterType=condition[prefix+'FilterType__c'];this.filterValue=condition[prefix+'Value__c'];this.filterVariableId=condition[prefix+'FilterVariable__c'];this.filterFormula=condition[prefix+'FilterFormula__c'];};var PriceQuery=function PriceQuery(query,prefix){_classCallCheck2(this,PriceQuery);this.id=query.Id;this.matchType=query[prefix+'MatchType__c'];this.testedObject=query[prefix+'TestedObject__c']||'Quote Line';this.testedField=query[prefix+'TestedField__c'];this.testedValue=query[prefix+'TestedValue__c'];this.operator=query[prefix+'Operator__c'];this.lookupField=query[prefix+'LookupField__c'];};module.exports=QuoteLinePriceRuleEvaluator;},{"./LookupTableMap.js":11,"./SummaryVariableCalculator.js":28,"./Utils/ApexUtils.js":30,"./Utils/MetaDataUtils.js":33,"./Utils/OperatorsUtils.js":36,"esprima":56,"jsforce":112}],22:[function(require,module,exports){"use strict";var DateUtils=require('../Utils/DateUtils.js');var JSQCConstants=require("./Utils/JSQCConstants.js");var ModelUtils=require("./Utils/ModelUtils.js");var IdUtils=require("./Utils/IdUtils.js");var QuoteLineModel=require("./QuoteLineModel.js");var QuoteLineGroupModel=require("./QuoteLineGroupModel.js");var QuoteSummaryModel=require("./QuoteSummaryModel.js");var ShortId=require('shortid');var ModelProxyFactory=require("./ModelProxyFactory.js");var PROTOTYPE_INITIALIZED=false;var FIELDS=["Opportunity2__r","Account__r","NetAmount__c","LineItemsGrouped__c","Type__c","TargetCustomerAmount__c","Id","Account__c","CustomerDiscount__c","SubscriptionTerm__c","StartDate__c","PricebookId__c","CurrencyIsoCode","DistributorDiscount__c","PartnerDiscount__c","MarkupRate__c","EndDate__c","FirstSegmentTermEndDate__c","ListAmount__c","CustomerAmount__c","RegularAmount__c","LineItemCount__c"];function defineGetAndSet(field){var getter;var setter;var sysField=false;switch(field){case'StartDate__c':case'EndDate__c':case"FirstSegmentTermEndDate__c":getter=ModelUtils.dateGetter;setter=ModelUtils.dateSetter;break;case'Account__c':case"PricebookId__c":getter=ModelUtils.opportunityLookupGetter;setter=ModelUtils.invalidSetter;break;case'Id':case'CreatedById':case'LastModifiedById':getter=ModelUtils.idGetter;setter=ModelUtils.invalidSetter;sysField=true;break;case'CreatedDate':case'LastModifiedDate':getter=ModelUtils.dateGetter;setter=ModelUtils.invalidSetter;sysField=true;break;case"CurrencyIsoCode":getter=ModelUtils.standardGetter;setter=ModelUtils.invalidSetter;sysField=true;break;default:getter=ModelUtils.standardGetter;setter=ModelUtils.standardSetter;}Object.defineProperty(QuoteModel2.prototype,field,{get:function get(){var prefix=sysField?'':this.prefix;return getter(prefix+field,this.record,this.settings);},set:function set(v){var prefix=sysField?'':this.prefix;setter(v,prefix+field,this.record);}});}function defineAllGetsAndSets(fields){if(PROTOTYPE_INITIALIZED){return;}var l=fields.length;for(var i=0;i<l;i++){defineGetAndSet(fields[i]);}PROTOTYPE_INITIALIZED=true;}var QuoteModel2=function(){function QuoteModel2(settings,data,notifier){_classCallCheck2(this,QuoteModel2);this._innerModel=ModelProxyFactory.createProxy(data,this,'QuoteModel',notifier);this._unproxiedModel=data;this.settings=settings;this.notifier=notifier;this.plugin=settings.plugin?{name:settings.plugin,pid:ShortId.generate()}:null;this.prefix=settings.devPrefix;defineAllGetsAndSets(FIELDS);var qModel=this;this.listProductTotal=null;this.customerProductTotal=null;this.netProductTotal=null;this.regularProductTotal=null;this.customerTotal=data.record[this.prefix+"CustomerAmount__c"];this.netTotal=data.record[this.prefix+"NetAmount__c"];this.groupsByKey={};this.groups=[];this.grouped=data.record[this.prefix+"LineItemsGrouped__c"];if(this.grouped){data.lineItemGroups.forEach(function(itemGroup){var groupModel=new QuoteLineGroupModel(qModel,itemGroup,settings,this.notifier);groupModel.Quote__c=this.Id;this.groupsByKey[itemGroup.key]=groupModel;this.groups.push(groupModel);groupModel.summaryLine=new QuoteSummaryModel(qModel,{record:groupModel.summaries});},this);}this.lineItemsByKey={};this.lineItems=[];this.priceRuleTargetFieldsToIgnore=data.priceRuleTargetFieldsToIgnore;data.lineItems.forEach(function(line){var itemGroup=this.groupsByKey[line.parentGroupKey];var item=new QuoteLineModel(qModel,itemGroup,line,settings,this.notifier);this.lineItemsByKey[item.key]=item;this.lineItems.push(item);if(itemGroup!=null){item.parentGroup=itemGroup;}},this);this.lineItems.forEach(function(line){if(line.isComponent){var parentLine=this.lineItemsByKey[line.parentItemKey];if(parentLine!=null){parentLine.addComponent(line);}}},this);this.groups.forEach(function(group){group.parentQuote=this;group.record[this.prefix+"Quote__r"]=this.record;},this);this.lineItems.forEach(function(line){var itemGroup=this.groupsByKey[line.parentGroupKey];if(itemGroup!=null){itemGroup.addLineItem(line);}},this);}_createClass(QuoteModel2,[{key:"getLinesCoveredBySubscription",value:function getLinesCoveredBySubscription(sub){var result=[];var value=sub.SubscribedAssetIds__c;var assetIds=null;if(!(value==null||value.trim().length===0)){assetIds=value.split(',');}var items=sub.parentQuote.lineItems;var renewalModel=this.accountRenewalModel;var includeNetNew=this.settings.isIncludeNetNewInMaintenanceEnabled;if(sub.ComponentSubscriptionScope__c!=null&&sub.parentItem!=null){items=[];if(sub.isComponentSubscriptionScopePackage||sub.isComponentSubscriptionScopeBoth){items.push(sub.parentItem);}else if(sub.isComponentSubscriptionScopeParentPackage||sub.isComponentSubscriptionScopeParentBoth){if(sub.parentItem.parentItem!=null){items.push(sub.parentItem.parentItem);}}if(sub.isComponentSubscriptionScopeComponents||sub.isComponentSubscriptionScopeBoth){sub.parentItem.components.forEach(function(l){items.push(l);});}else if(sub.isComponentSubscriptionScopeParentComponents||sub.isComponentSubscriptionScopeParentBoth){if(sub.parentItem.parentItem!=null){sub.parentItem.parentItem.components.forEach(function(l){items.push(l);});}}}else if(sub.parentGroup!=null&&sub.isSubscriptionScopeGroup){items=sub.parentGroup.lineItems;}var subCategory=sub.SubscriptionCategory__c;var coveredItemIDs=[];items.forEach(function(line){var isExcluded=line.isExcludedFromMaintenance;var shouldInclude=!(line.isSubscription||line.isDynamicAsset)||line.isIncludedInMaintenance;var labelNull=sub.SegmentLabel__c==null||line.SegmentLabel__c==null;var labelSame=sub.SegmentLabel__c===line.SegmentLabel__c;if(!isExcluded&&shouldInclude&&(labelNull||labelSame)){if(renewalModel.toLowerCase()=='asset based'&&(line.parentQuote.isRenewal||line.parentQuote.isAmendment)&&includeNetNew&&!sub.isComponent){if(assetIds!=null&&assetIds.indexOf(line.RenewedAsset__c)!=-1){result.push(line);coveredItemIDs.push(line.Id);}else if(assetIds==null&&line.UpgradedAsset__c==null&&line.RenewedAsset__c==null){result.push(item);coveredItemIDs.push(line.Id);}}else if(assetIds!=null&&(!includeNetNew||line.countsAsExisting)&&!line.isSubscription){if(assetIds.indexOf(line.RenewedAsset__c)!=-1||(line.parentQuote.isAmendment||line.parentQuote.isChangeQuote)&&assetIds.indexOf(line.UpgradedAsset__c)!=-1){result.push(line);coveredItemIDs.push(line.Id);}}else if(subCategory!=null){if(line.SubscriptionCategory__c===subCategory){result.push(line);coveredItemIDs.push(line.Id);}}else{result.push(line);coveredItemIDs.push(line.Id);}}});if(renewalModel.toLowerCase()=='asset based'&&includeNetNew&&!sub.isComponent){items.forEach(function(line){if(line.parentQuote.isRenewal||line.parentQuote.isAmendment){var isExcluded=line.isExcludedFromMaintenance;var shouldInclude=!line.isSubscription||line.isIncludedInMaintenance;var labelNull=sub.SegmentLabel__c==null||line.SegmentLabel__c==null;var labelSame=sub.SegmentLabel__c===line.SegmentLabel__c;if(!isExcluded&&shouldInclude&&(labelNull||labelSame)){if(!line.hasComponents&&!line.isComponent&&coveredItemIDs.indexOf(line.Id)==-1){result.push(line);}}}});}return result;}},{key:"getLastSegment",value:function getLastSegment(key,type){var lineItem=null;var max=null;this.lineItems.forEach(function(line){if(line.SegmentKey__c==key&&line.dimType==type){var index=line.SegmentIndex__c;if(index!=null&&(max==null||max<index)){max=index;lineItem=line;}}});return lineItem;}},{key:"removeLineItem",value:function removeLineItem(line){for(var i=0;i<this.lineItems.length;i++){if(this.lineItems[i]==line){this.lineItems=this.lineItems.slice(0,i).concat(this.lineItems.slice(i+1,this.lineItems.length));if(this.deletedLineIds!=null&&line.record!=null&&line.record.Id!=null){this.deletedLineIds.push(line.record.Id);}line.parentQuote=null;if(line.hasComponents){line.components.forEach(function(line){if(this.grouped){line.parentGroup.removeLineItem(line);}this.removeLineItem(line);},this);}return;}}}},{key:"set",value:function set(path,value){this._innerModel[path]=value;}},{key:"record",get:function get(){return this._innerModel.record;}},{key:"listProductTotal",get:function get(){return this._innerModel.listProductTotal;},set:function set(v){this.set('listProductTotal',v);}},{key:"customerProductTotal",get:function get(){return this._innerModel.customerProductTotal;},set:function set(v){this.set('customerProductTotal',v);}},{key:"regularProductTotal",get:function get(){return this._innerModel.regularProductTotal;},set:function set(v){this.set('regularProductTotal',v);}},{key:"netProductTotal",get:function get(){return this._innerModel.netProductTotal;},set:function set(v){this.set('netProductTotal',v);}},{key:"customerTotal",get:function get(){return this._innerModel.customerTotal;},set:function set(v){this.set('customerTotal',v);}},{key:"netTotal",get:function get(){return this._innerModel.netTotal;},set:function set(v){this.set('netTotal',v);}},{key:"grouped",get:function get(){return this._innerModel.grouped;},set:function set(v){this.set('grouped',v);}},{key:"summaries",get:function get(){return this._innerModel.summaries;},set:function set(v){this.set('summaries',v);}},{key:"multiSegmentKeys",get:function get(){return this._innerModel.multiSegmentKeys;},set:function set(v){this.set('multiSegmentKeys',v);}},{key:"multiSegmentColumns",get:function get(){return this._innerModel.multiSegmentColumns;},set:function set(v){this.set('multiSegmentColumns',v);}},{key:"localizedMultiSegmentColumns",get:function get(){return this._innerModel.localizedMultiSegmentColumns;},set:function set(v){this.set('localizedMultiSegmentColumns',v);}},{key:"multiSegmentColumnTotals",get:function get(){return this._innerModel.multiSegmentColumnTotals;},set:function set(v){this.set('multiSegmentColumnTotals',v);}},{key:"multiSegmentRowTotals",get:function get(){return this._innerModel.multiSegmentRowTotals;},set:function set(v){this.set('multiSegmentRowTotals',v);}},{key:"netMultiSegmentTotal",get:function get(){return this._innerModel.netMultiSegmentTotal;},set:function set(v){this.set('netMultiSegmentTotal',v);}},{key:"netNonSegmentTotal",get:function get(){return this._innerModel.netNonSegmentTotal;},set:function set(v){this.set('netNonSegmentTotal',v);}},{key:"hasMultiSegmentLines",get:function get(){return this._innerModel.hasMultiSegmentLines;},set:function set(v){this.set('hasMultiSegmentLines',v);}},{key:"lineItemRowCount",get:function get(){return this._innerModel.lineItemRowCount;},set:function set(v){this.set('lineItemRowCount',v);}},{key:"multiSegmentRowExpanded",get:function get(){return this._innerModel.multiSegmentRowExpanded;},set:function set(v){this.set('multiSegmentRowExpanded',v);}},{key:"applyPartnerDiscountFirst",get:function get(){if(this.settings.quoteMagicFieldApiNamesByAlias!=null){var fieldName=this.settings.quoteMagicFieldApiNamesByAlias.ApplyPartnerDiscountFirst__c;this._innerModel.applyPartnerDiscountFirst=fieldName!=null&&!!this.record[fieldName];}return this._innerModel.applyPartnerDiscountFirst;}},{key:"applyAdditionalDiscountLast",get:function get(){if(this.settings.quoteMagicFieldApiNamesByAlias!=null){var fieldName=this.settings.quoteMagicFieldApiNamesByAlias.ApplyAdditionalDiscountLast__c;this._innerModel.applyAdditionalDiscountLast=fieldName!=null&&!!this.record[fieldName];}return this._innerModel.applyAdditionalDiscountLast;}},{key:"channelDiscountsOffList",get:function get(){if(this.settings.quoteMagicFieldApiNamesByAlias!=null){var fieldName=this.settings.quoteMagicFieldApiNamesByAlias.ChannelDiscountsOffList__c;this._innerModel.channelDiscountsOffList=fieldName!=null&&!!this.record[fieldName];}return this._innerModel.channelDiscountsOffList;}},{key:"localizationByFieldByDimensionId",get:function get(){return this._innerModel.localizationByFieldByDimensionId;}},{key:"isChangeQuote",get:function get(){return this.Type__c===JSQCConstants.TYPE_CHANGEQUOTE;}},{key:"isRenewal",get:function get(){return this.Type__c===JSQCConstants.TYPE_RENEWAL;}},{key:"isAmendment",get:function get(){return this.Type__c===JSQCConstants.TYPE_AMENDMENT;}},{key:"hasDynamicLineItems",get:function get(){var lineCount=this.lineItems.length;for(var i=0;i<lineCount;i++){if(this.lineItems[i].isDynamic){return true;}}return false;}},{key:"scheduleMap",get:function get(){var scheduleMap={};this.lineItems.forEach(function(line){var vid=line.DiscountSchedule__c;var tid=line.TermDiscountSchedule__c;var cid=line.costScheduleId;if(vid!=null){if(scheduleMap[vid]==null){scheduleMap[vid]=[];}scheduleMap[vid].push(line.Product__c);}if(tid!=null){if(scheduleMap[tid]==null){scheduleMap[tid]=[];}scheduleMap[tid].push(line.Product__c);}if(cid!=null){if(scheduleMap[IdUtils.convertTo18(cid,line.settings)]==null){scheduleMap[IdUtils.convertTo18(cid,line.settings)]=[];}scheduleMap[IdUtils.convertTo18(cid,line.settings)].push(line.Product__c);}});return scheduleMap;}},{key:"overriddenScheduleMap",get:function get(){var overrideMap={};this.lineItems.forEach(function(line){var originalVolume=line.originalVolumeSchedule;var originalTerm=line.originalTermSchedule;var currentVolume=line.DiscountSchedule__c;var currentTerm=line.TermDiscountSchedule__c;var volumeOverridden=originalVolume!=null&&!IdUtils.compareIds(originalVolume,currentVolume,line.settings);var termOverridden=originalTerm!=null&&!IdUtils.compareIds(originalTerm,currentTerm,line.settings);if(volumeOverridden){if(overrideMap[originalVolume]==null){overrideMap[originalVolume]=[];}overrideMap[originalVolume].push(line.Product__c);}if(termOverridden){if(overrideMap[originalTerm]==null){overrideMap[originalTerm]=[];}overrideMap[originalTerm].push(line.Product__c);}},this);return overrideMap;}},{key:"targetLineItems",get:function get(){var targetLines=[];this.lineItems.forEach(function(line){if(line.parentGroup==null||line.parentGroup.TargetCustomerAmount__c==null){targetLines.push(line);}});return targetLines;}},{key:"calculatedSubscriptionTerm",get:function get(){var startDate=this.StartDate__c;var endDate=this.EndDate__c;if(startDate!=null&&endDate!=null){endDate.setDate(endDate.getDate()+1);if(this.settings.subscriptionTermUnitIsDay){return DateUtils.daysBetween(startDate,endDate);}else{return DateUtils.monthsBetween(startDate,endDate);}}return this.SubscriptionTerm__c;}},{key:"effectiveEndDate",get:function get(){return this.EndDate__c||this.calculatedEndDate;}},{key:"calculatedEndDate",get:function get(){if(this.SubscriptionTerm__c!=null&&this.StartDate__c!=null){var endDate=this.StartDate__c;if(this.settings.subscriptionTermUnitIsDay){endDate.setUTCDate(endDate.getUTCDate()+this.SubscriptionTerm__c-1);}else{endDate.setUTCMonth(endDate.getUTCMonth()+this.SubscriptionTerm__c);endDate.setUTCDate(endDate.getUTCDate()-1);}return endDate;}return this.EndDate__c;}},{key:"accountRenewalModel",get:function get(){if(this.Account__r!=null&&this.Account__r[this.prefix+"RenewalModel__c"]!=null){return this.Account__r[this.prefix+"RenewalModel__c"];}return'contract based';}}]);return QuoteModel2;}();module.exports=QuoteModel2;},{"../Utils/DateUtils.js":1,"./ModelProxyFactory.js":14,"./QuoteLineGroupModel.js":19,"./QuoteLineModel.js":20,"./QuoteSummaryModel.js":26,"./Utils/IdUtils.js":31,"./Utils/JSQCConstants.js":32,"./Utils/ModelUtils.js":34,"shortid":178}],23:[function(require,module,exports){"use strict";var MetaDataUtils=require('./Utils/MetaDataUtils.js');var QuoteHandler=require('./QuoteHandler.js');var fragmentCount=200;var QuoteOpportunitySynchronizer=function(){function QuoteOpportunitySynchronizer(settings,conn,prefix){_classCallCheck2(this,QuoteOpportunitySynchronizer);this.settings=settings;this.devPrefix=settings.developerPrefix;this.prefix=prefix;this.conn=conn;this.conn.bulk.pollTimeout=600000;this.baseUrl=(this.prefix?'/'+this.prefix:'')+'/ServiceRouter?oik='+this.conn.oik;}_createClass(QuoteOpportunitySynchronizer,[{key:"loadOpportunityLineItems",value:function loadOpportunityLineItems(oppId,loadUnitPrice){var queryText="SELECT Id, OpportunityId, Quantity, "+this.devPrefix+"QuoteLine__c, Opportunity.Pricebook2Id, Product2Id";if(loadUnitPrice){queryText+=", UnitPrice";}queryText+=" FROM OpportunityLineItem WHERE OpportunityId="+"'"+oppId+"'";return this.conn.query(queryText,function(err,res){return!err?Promise.resolve(res.records):Promise.reject(err.message||err);});}},{key:"updateOpportunityProducts",value:function updateOpportunityProducts(quote){var self=this;var oppId;var lineItems;if(quote.record[self.devPrefix+'Primary__c']&&quote.record[self.devPrefix+'Opportunity2__c']){oppId=quote.record[self.devPrefix+'Opportunity2__c'];}if(!oppId){return Promise.resolve(quote);}var productIds=QuoteHandler.buildOptionAndProductIds(quote.lineItems,self.devPrefix).productIds;var promises=this.createLoadProductPromises(quote,productIds);return Promise.all(promises).then(function(productsByIdFragments){var productsById=createProductsById(productsByIdFragments);lineItems=self.extractEligibleLineItems(quote,productsById);return self.loadOpportunityLineItems(oppId,false);}).then(function(oppLineItems){return self.upsertAndDelOpportunityLineItems(lineItems,oppLineItems,quote);});}},{key:"upsertAndDelOpportunityLineItems",value:function upsertAndDelOpportunityLineItems(lines,existingOppLineItems,quote){var oppLineItemsByQuoteLineId={};var existingOppLineItemsById={};var self=this;for(var i=0,l=existingOppLineItems.length;i<l;i++){var oppLineItem=existingOppLineItems[i];var quoteLineIdOnOppLineItem=oppLineItem[this.devPrefix+'QuoteLine__c'];if(quoteLineIdOnOppLineItem){oppLineItemsByQuoteLineId[quoteLineIdOnOppLineItem]=oppLineItem;}existingOppLineItemsById[oppLineItem.Id]=oppLineItem;}return this.upsertOpportunityLineItems(lines,quote,existingOppLineItemsById,oppLineItemsByQuoteLineId).then(function(existingOppLineItemsId){if(existingOppLineItemsId.length>0){return self.delete('OpportunityLineItem',existingOppLineItemsId);}return Promise.resolve();});}},{key:"upsertOpportunityLineItems",value:function upsertOpportunityLineItems(lines,quote,existingOppLineItemsById,oppLineItemsByQuoteLineId){if(lines.length==0)return Promise.resolve(getObjectValues(existingOppLineItemsById));var self=this;var optionAndProductIds=QuoteHandler.buildOptionAndProductIds(lines,this.devPrefix);var productIds=optionAndProductIds.productIds;var promises=[];promises.push(this.loadIndexPricebookEntries(quote,productIds));promises.push(this.loadMappableSrcFields());promises.push(this.loadMetaData(this.createMdPromises(this.devPrefix,this.conn)));return Promise.all(promises).then(function(results){var pricebookEntriesByKey=results[0];var mappableFields=results[1];this.md=createMdMap(results[2]);var oppLineItemBatchToUpsert=[];var oppLineItemBatchToInsert=[];var oppId=quote.record[this.devPrefix+'Opportunity2__c'];var quoteCurrency=quote.record.CurrencyIsoCode||null;for(var i=0,l=lines.length;i<l;i++){var line=lines[i];var quoteLineId=line.record.Id;var key=line.record[this.devPrefix+'Product__c']+':'+quoteCurrency;var pricebookEntry=pricebookEntriesByKey[key];var oppLineItem=undefined;if(!pricebookEntry)line.validPricebookEntryExists=false;if(quoteLineId&&oppLineItemsByQuoteLineId[quoteLineId]){oppLineItem=oppLineItemsByQuoteLineId[quoteLineId];delete existingOppLineItemsById[oppLineItem.Id];line.opportunityLineItemExists=true;}else if(pricebookEntry){oppLineItem={OpportunityId:oppId,PricebookEntryId:pricebookEntry.Id};oppLineItemsByQuoteLineId[quoteLineId]=oppLineItem;}if(oppLineItem){oppLineItem[this.devPrefix+'QuoteLine__c']=quoteLineId;oppLineItem.Quantity=getOpportunityLineItemQuantity(line,this.devPrefix);var isAmendment=quote.record[this.devPrefix+'Type__c']=='Amendment',unitPriceScale=this.settings.priceScale,fieldName;if(!quote.applyAdditionalDiscountLast){fieldName=isAmendment?'NetTotal__c':'NetPrice__c';}else{fieldName=isAmendment?'CustomerTotal__c':'CustomerPrice__c';}if(isAmendment){oppLineItem.TotalPrice=line.record[this.devPrefix+fieldName]||0;}else{oppLineItem.UnitPrice=(line.record[this.devPrefix+fieldName]||0).toFixed(unitPriceScale);}mapCustomFields(line,oppLineItem,mappableFields);if(oppLineItem.Quantity===0){if(oppLineItem.Id){existingOppLineItemsById[oppLineItem.Id]=oppLineItem;}}else{if(oppLineItem.Id){oppLineItemBatchToUpsert.push(oppLineItem);}else{oppLineItemBatchToInsert.push(oppLineItem);}}}}if(oppLineItemBatchToUpsert.length===0&&oppLineItemBatchToInsert.length===0){return Promise.resolve([]);}else{removeNonUpdateableFields('OpportunityLineItem',oppLineItemBatchToUpsert,this.md,true);var insertPromise=this.insert('OpportunityLineItem',oppLineItemBatchToInsert);var upsertPromise=this.upsert('OpportunityLineItem',oppLineItemBatchToUpsert);var promises=[insertPromise,upsertPromise];return Promise.all(promises).then(function(oppLineItems){var insertedOppLineItems=oppLineItems[0];var oppLineItemBatch=[];for(var i=0,l=oppLineItemBatchToInsert.length;i<l;i++){if(oppLineItemBatchToInsert[i].Id!=insertedOppLineItems[i].id){oppLineItemBatchToInsert[i].Id=insertedOppLineItems[i].id;}}for(var ii=0,ll=lines.length;ii<ll;ii++){var item=lines[ii];var oli=oppLineItemsByQuoteLineId[item.record.Id];if(oli&&oli.Quantity!==0){var parentOppLineItem=oppLineItemsByQuoteLineId[item.record[self.devPrefix+'RequiredBy__c']];var oldParentId=oli[self.devPrefix+'ParentID__c'];var newParentId=parentOppLineItem?parentOppLineItem.Id:null;if(oldParentId!=newParentId){oli[self.devPrefix+'ParentID__c']=newParentId;oppLineItemBatch.push(oli);}}}if(oppLineItemBatch.length==0){return Promise.resolve();}removeNonUpdateableFields('OpportunityLineItem',oppLineItemBatch,this.md,false);return self.upsert('OpportunityLineItem',oppLineItemBatch);}.bind(this)).then(function(){return Promise.resolve(getObjectValues(existingOppLineItemsById));});}}.bind(this));}},{key:"delete",value:function _delete(objectName,records){if(records.length===0){return Promise.resolve();}return this.conn.sobject(objectName).deleteBulk(records,function(err,res){return!err?Promise.resolve(res):Promise.reject(err);}).then(function(results){return Promise.resolve(_checkRecordErrors(results));});}},{key:"upsert",value:function upsert(objectName,records){if(records.length===0){return Promise.resolve();}return this.conn.sobject(objectName).upsertBulk(records,'Id',function(err,res){return!err?Promise.resolve(res):Promise.reject(err);}).then(function(results){return Promise.resolve(_checkRecordErrors(results));});}},{key:"insert",value:function insert(objectName,records){if(records.length===0){return Promise.resolve();}return this.conn.sobject(objectName).insertBulk(records,function(err,res){return!err?Promise.resolve(res):Promise.reject(err);}).then(function(results){return Promise.resolve(_checkRecordErrors(results));});}},{key:"createLoadProductPromises",value:function createLoadProductPromises(quote,productIds){var promises=[];var promiseCount=Math.ceil(productIds.length/fragmentCount);for(var i=0;i<promiseCount;i++){promises.push(this.loadProducts(quote,productIds.splice(0,fragmentCount)));}return promises;}},{key:"loadProducts",value:function loadProducts(quote,productIds){if(productIds.length===0){return Promise.resolve([]);}var pricebookFilter=[];var currencyFilter=[];var productRequiredFields=[this.devPrefix+'ExcludeFromOpportunity__c'];if(quote.record[this.devPrefix+'PricebookId__c']){pricebookFilter.push(quote.record[this.devPrefix+'PricebookId__c']);}if(quote.record['CurrencyIsoCode']){currencyFilter.push(quote.record['CurrencyIsoCode']);}var productContext={context:JSON.stringify({'requiredIds':productIds,'productFields':productRequiredFields,'pricebookFilter':pricebookFilter,'currencyFilter':currencyFilter})};var url=this.baseUrl+'&loader=ProductServiceProvider.ProductLoader&uid='+'AllProducts';return this.conn.apex.patch(url,productContext).then(function(products){return Promise.resolve(JSON.parse(products));}.bind(this));}},{key:"loadIndexPricebookEntries",value:function loadIndexPricebookEntries(quote,productIds){if(productIds.length===0){return Promise.resolve([]);}var pricebookId=quote.record[this.devPrefix+'PricebookId__c'];var currencyCode=quote.record.CurrencyIsoCode;var context={context:JSON.stringify({productIds:productIds,pricebookId:pricebookId,currencyCode:currencyCode})};var url=this.baseUrl+'&loader=ProductServiceProvider.PricebookEntryLoader&uid='+'AllPricebooks';return this.conn.apex.patch(url,context).then(function(entries){return Promise.resolve(JSON.parse(entries));}.bind(this));}},{key:"loadMappableSrcFields",value:function loadMappableSrcFields(){var url=this.baseUrl+'&loader=QuoteLineEditorServiceProvider.GetMappableSrcFields';return this.conn.apex.patch(url,{}).then(function(mappableFields){return Promise.resolve(JSON.parse(mappableFields));}.bind(this));}},{key:"extractEligibleLineItems",value:function extractEligibleLineItems(quote,productsById){var eligibleLineItems=[];for(var i=0,l=quote.lineItems.length;i<l;i++){var line=quote.lineItems[i];var record=line.record;var productId=record[this.devPrefix+'Product__c'];var isExcluded=productsById[productId][this.devPrefix+'ExcludeFromOpportunity__c'];if(!record[this.devPrefix+'Optional__c']&&!isExcluded&&!(record[this.devPrefix+'Renewal__c']&&!record[this.devPrefix+'Existing__c']&&record[this.devPrefix+'PriorQuantity__c']==null)){if(!record[this.devPrefix+'Renewal__c']){eligibleLineItems.push(line);}else if(!record[this.devPrefix+'SubscriptionPricing__c']){eligibleLineItems.push(line);}else if(record[this.devPrefix+'SubscriptionPricing__c']&&getActualQuantity(line,this.devPrefix)){eligibleLineItems.push(line);}}}return eligibleLineItems;}},{key:"loadMetaData",value:function loadMetaData(promises){return Promise.all(promises).then(function(md){return Promise.resolve(md);}.bind(this));}},{key:"createMdPromises",value:function createMdPromises(developerPrefix,conn){var objectNames=[developerPrefix+"Quote__c",developerPrefix+"QuoteLineGroup__c",developerPrefix+"QuoteLine__c","OpportunityLineItem"];var promises=[];objectNames.forEach(function(objectName){promises.push(describe(objectName,conn));});return promises;}}]);return QuoteOpportunitySynchronizer;}();function _checkRecordErrors(records){for(var i=0,l=records.length;i<l;i++){if(records[i].errors.length>0){throw Error(records[i].errors.join(', '));}}return records;}function mapCustomFields(line,oppLineItem,mappableFields){for(var i=0,l=mappableFields.length;i<l;i++){var field=mappableFields[i];oppLineItem[field]=line.record[field];}}function describe(objectName,conn){return conn.describe(objectName,function(err,meta){return!err?Promise.resolve(meta):Promise.reject(err);});}function createMdMap(md){var mdMap={};md.forEach(function(objectMd){mdMap[objectMd.name]={};objectMd.fields.forEach(function(field){mdMap[objectMd.name][field.name]=field;});});return mdMap;}function createProductsById(productsByIdFragments){var result={};for(var i=0,l=productsByIdFragments.length;i<l;i++){var fragment=productsByIdFragments[i];for(var productId in fragment){result[productId]=fragment[productId];}}return result;}function getActualQuantity(line,prefix){var priorQty=line.record[prefix+'PriorQuantity__c']||0;var upgradedQty=line.record[prefix+'UpgradedQuantity__c']||0;var isExisting=line.record[prefix+'Existing__c'];var isCarryOverLine=line.record[prefix+'CarryoverLine__c'];var quantity=line.record[prefix+'Quantity__c'];return isExisting||isCarryOverLine?quantity-priorQty+upgradedQty:quantity;}function getOpportunityLineItemQuantity(line,prefix){var isExisting=line.record[prefix+'Existing__c'];var isDynamicSub=isDynamicSubscription(line,prefix);var listPrice=line.record[prefix+'ListPrice__c'];var priorQty=line.record[prefix+'PriorQuantity__c']||0;var quantity=line.record[prefix+'Quantity__c'];var assetEffectiveQuantity=getAssetEffectiveQuantity(line,prefix);var isPricingMethodBlock=line.record[prefix+'PricingMethod__c']==='Block';var isSlabType=line.record[prefix+'DiscountScheduleType__c']==='Slab';if(isExisting&&isDynamicSub&&listPrice!==0&&assetEffectiveQuantity===0){return quantity;}else if((isPricingMethodBlock||isSlabType)&&isExisting&&priorQty!==0&&quantity-priorQty===0){return 0;}else if((isPricingMethodBlock||isSlabType)&&quantity!==0){return 1;}else{return assetEffectiveQuantity;}}function isDynamicSubscription(line,prefix){var isSubscription=line.record[prefix+'SubscriptionPricing__c']!==null;var isDynamic=isDynamicQuoteLine(line,prefix);return isSubscription&&isDynamic;}function isDynamicQuoteLine(line,prefix){var isPercentOfTotal=line.record[prefix+'PricingMethod__c']==='Percent Of Total';var isSubscriptionPricing=line.record[prefix+'SubscriptionPricing__c']==='Percent Of Total';return isPercentOfTotal||isSubscriptionPricing;}function getAssetEffectiveQuantity(line,prefix){var isExisting=line.record[prefix+'Existing__c'];var quantity=line.record[prefix+'Quantity__c'];var priorQty=line.record[prefix+'PriorQuantity__c']||0;if(!isExisting){return quantity;}else{return quantity-priorQty;}}function removeNonUpdateableFields(objectName,records,md,keepPricebookEntryId){for(var i=0,l=records.length;i<l;i++){var record=records[i];for(var key in record){if(key=='Id'||key=='OpportunityId'||keepPricebookEntryId&&key=='PricebookEntryId')continue;var fieldMd=md[objectName][key];if(key==='Opportunity'||key.includes('__r')){delete record[key];}else if(fieldMd&&!fieldMd.updateable){delete record[key];}}}}function getObjectValues(obj){var vals=[];for(var key in obj){if(obj.hasOwnProperty(key)){vals.push(obj[key]);}}return vals;}module.exports=QuoteOpportunitySynchronizer;},{"./QuoteHandler.js":18,"./Utils/MetaDataUtils.js":33}],24:[function(require,module,exports){var QuoteHandler=require('./QuoteHandler.js');var fragmentCount=200;var QuotePriceHandler=function(){function QuotePriceHandler(settings,connection,prefix){_classCallCheck2(this,QuotePriceHandler);this.conn=connection;this.settings=settings;this.devPrefix=settings.developerPrefix;this.prefix=prefix;this.baseUrl=(this.prefix?'/'+this.prefix:'')+'/ServiceRouter?oik='+this.conn.oik;}_createClass(QuotePriceHandler,[{key:"refresh",value:function refresh(quote){if(!quote.record[this.devPrefix+'PricebookId__c']){return Promise.resolve();}if(quote.record[this.devPrefix+'Opportunity2__r']){quote.record[this.devPrefix+'PricebookId__c']=quote.record[this.devPrefix+'Opportunity2__r'].Pricebook2Id;}if(quote.lineItems.length===0){return Promise.resolve();}var optionAndProductIds=QuoteHandler.buildOptionAndProductIds(quote.lineItems,this.devPrefix);var optionIds=optionAndProductIds.optionIds;var productIds=optionAndProductIds.productIds;var productsById;var promises=[];promises.push(this.loadOptions(quote,optionIds));promises.push(this.loadIndexPricebookEntries(quote,productIds));var productPromises=this.createLoadProductPromises(quote,productIds);return Promise.all(productPromises).then(function(productsByIdFragments){productsById=createProductsById(productsByIdFragments);return Promise.all(promises);}).then(function(results){var optionsById=results[0];var indexByKey=results[1];var quoteCurrency=quote.record.CurrencyIsoCode;for(var i=0,l=quote.lineItems.length;i<l;i++){var line=quote.lineItems[i];var key=line.record[this.devPrefix+'Product__c']+':'+quoteCurrency;line.validPricebookEntryExists=indexByKey[key]?true:false;if(line.validPricebookEntryExists){var oldPrice=line.record[this.devPrefix+'ListPrice__c'];var optionId=line.record[this.devPrefix+'ProductOption__c'];if(optionId&&optionsById&&optionsById[optionId]&&optionsById[optionId][this.prefix+'UnitPrice__c']){line.record[this.devPrefix+'ListPrice__c']=optionsById[optionId][this.prefix+'UnitPrice__c'];line.record[this.devPrefix+'OriginalPrice__c']=optionsById[optionId][this.prefix+'UnitPrice__c'];}else{line.record[this.devPrefix+'ListPrice__c']=indexByKey[key].UnitPrice;line.record[this.devPrefix+'OriginalPrice__c']=indexByKey[key].UnitPrice;line.record[this.devPrefix+'PricebookEntryId__c']=indexByKey[key].Id;}if(oldPrice!==line.record[this.devPrefix+'ListPrice__c']){line.dirty=true;}}this.refreshProductPricingFields(line,productsById[line.record[this.devPrefix+'Product__c']]);}return Promise.resolve();}.bind(this));}},{key:"refreshProductPricingFields",value:function refreshProductPricingFields(line,product){if(line.record[this.devPrefix+'SubscriptionPercent__c']!==product[this.devPrefix+'SubscriptionPercent__c']){line.record[this.devPrefix+'SubscriptionPercent__c']=product[this.devPrefix+'SubscriptionPercent__c'];line.dirty=true;}}},{key:"loadIndexPricebookEntries",value:function loadIndexPricebookEntries(quote,productIds){if(productIds.length===0){return Promise.resolve([]);}var pricebookId=quote.record[this.devPrefix+'PricebookId__c'];var currencyCode=quote.record.CurrencyIsoCode;var context={context:JSON.stringify({productIds:productIds,pricebookId:pricebookId,currencyCode:currencyCode})};var url=this.baseUrl+'&loader=ProductServiceProvider.PricebookEntryLoader&uid='+'AllPricebooks';return this.conn.apex.patch(url,context).then(function(entries){return Promise.resolve(JSON.parse(entries));});}},{key:"createLoadProductPromises",value:function createLoadProductPromises(quote,productIds){var promises=[];var promiseCount=Math.ceil(productIds.length/fragmentCount);for(var i=0;i<promiseCount;i++){promises.push(this.loadProducts(quote,productIds.splice(0,fragmentCount)));}return promises;}},{key:"loadProducts",value:function loadProducts(quote,productIds){if(productIds.length===0){return Promise.resolve();}var pricebookFilter=[];var currencyFilter=[];var productRequiredFields=['SubscriptionPercent__c'];if(quote.record[this.devPrefix+'PricebookId__c']){pricebookFilter.push(quote.record[this.devPrefix+'PricebookId__c']);}if(quote.record['CurrencyIsoCode']){currencyFilter.push(quote.record['CurrencyIsoCode']);}var productContext={context:JSON.stringify({'requiredIds':productIds,'productFields':productRequiredFields,'pricebookFilter':pricebookFilter,'currencyFilter':currencyFilter})};var url=this.baseUrl+'&loader=ProductServiceProvider.ProductLoader&uid='+'AllProducts';return this.conn.apex.patch(url,productContext).then(function(products){return Promise.resolve(JSON.parse(products));});}},{key:"loadOptions",value:function loadOptions(quote,optionIds){if(optionIds.length===0){return Promise.resolve([]);}return this.conn.sobject(this.devPrefix+'ProductOption__c').select(this.devPrefix+'UnitPrice__c').where({Id:optionIds}).execute(function(err,records){if(err){return Promise.reject(err);}var optionsByKey={};for(var i=0,l=records.length;i<l;i++){var record=records[i];optionsByKey[record.Id]=record;}return Promise.resolve(optionsByKey);});}}]);return QuotePriceHandler;}();function createProductsById(productsByIdFragments){var result={};for(var i=0,l=productsByIdFragments.length;i<l;i++){var fragment=productsByIdFragments[i];for(var productId in fragment){if(fragment.hasOwnProperty(productId)){result[productId]=fragment[productId];}}}return result;}module.exports=QuotePriceHandler;},{"./QuoteHandler.js":18}],25:[function(require,module,exports){"use strict";var MetaDataUtils=require("./Utils/MetaDataUtils.js");var NumberUtils=require("../Utils/NumberUtils.js");module.exports.summarize=summarize;var LOC_BY_FIELD_BY_DIM;function summarize(quotes,settings){quotes.forEach(function(quote){LOC_BY_FIELD_BY_DIM=quote.localizationByFieldByDimensionId;if(!quote.lineItems.length==0){var lineType=MetaDataUtils.getObjectType(quote.lineItems[0]);var summaryFields=settings.getSummaryFieldsByLineType(lineType);if(quote.grouped){var nextOffset=0;quote.groups.forEach(function(group){var localizedColumns={};group.summaries=summarizeLines(group.lineItems,summaryFields,group.Optional__c);group.multiSegmentKeys=computeMultiSegmentKeys(group.lineItems);group.multiSegmentColumns=computeMultiSegmentColumnNames(group.lineItems,group.multiSegmentKeys,localizedColumns,settings);group.localizedMultiSegmentColumns=localizedColumns;group.multiSegmentColumnTotals=computeMultiSegmentColumnTotals(group.lineItems,group.multiSegmentColumns,group.multiSegmentKeys,settings);group.multiSegmentRowTotals=computeMultiSegmentRowTotals(group.lineItems,settings);group.netMultiSegmentTotal=computeMultiSegmentTotal(group.lineItems);group.netNonSegmentTotal=computeNonSegmentTotal(group.lineItems);group.hasMultiSegmentLines=Object.keys(group.multiSegmentColumns).length>0;group.lineItemRowCount=computeRowCount(group.lineItems);group.lineNumberOffset=nextOffset;nextOffset+=group.lineItemRowCount;},this);}var localizedColumns={};quote.summaries=summarizeLines(quote.lineItems,summaryFields,false);quote.multiSegmentKeys=computeMultiSegmentKeys(quote.lineItems);quote.multiSegmentColumns=computeMultiSegmentColumnNames(quote.lineItems,quote.multiSegmentKeys,localizedColumns,settings);quote.localizedMultiSegmentColumns=localizedColumns;quote.multiSegmentColumnTotals=computeMultiSegmentColumnTotals(quote.lineItems,quote.multiSegmentColumns,quote.multiSegmentKeys,settings);quote.multiSegmentRowTotals=computeMultiSegmentRowTotals(quote.lineItems,settings);quote.netMultiSegmentTotal=computeMultiSegmentTotal(quote.lineItems);quote.netNonSegmentTotal=computeNonSegmentTotal(quote.lineItems);quote.hasMultiSegmentLines=Object.keys(quote.multiSegmentColumns).length>0;quote.lineItemRowCount=computeRowCount(quote.lineItems);if(quote.multiSegmentRowExpanded==null){quote.multiSegmentRowExpanded={};}for(var key in quote.multiSegmentRowTotals){if(quote.multiSegmentRowExpanded[key]!=true){quote.multiSegmentRowExpanded[key]=false;}}}},this);LOC_BY_FIELD_BY_DIM=null;}function summarizeLines(lines,summaryFields,countOptional){var result={};if(lines!=null){lines.forEach(function(line){if((countOptional||!line.Optional__c)&&summaryFields!=null){summaryFields.forEach(function(field){var value=line.record[field];if(value!=null&&typeof value=="number"){if(result[field.toLowerCase()]!=null){result[field.toLowerCase()]+=value;}else{result[field.toLowerCase()]=value;}}},this);}},this);}return result;}function computeMultiSegmentKeys(lines){var groupTypesBySegmentKey={};if(lines!=null){lines.forEach(function(line){if(line.isTimeBasedSegment){groupTypesBySegmentKey[line.SegmentKey__c]=line.dimType;}});}return groupTypesBySegmentKey;}function computeMultiSegmentColumnNames(lines,groupTypesBySegmentKey,localizedColumns,settings){var allColumnsMap={};var allColumnsSetMap={};var groupLinesBySegmentKey={};if(lines!=null){lines.forEach(function(line){if(line.SegmentKey__c!=null&&groupLinesBySegmentKey[line.SegmentKey__c]===undefined){groupLinesBySegmentKey[line.SegmentKey__c]=[line];}else if(line.SegmentKey__c!=null){groupLinesBySegmentKey[line.SegmentKey__c].push(line);}});for(var key in groupLinesBySegmentKey){var thisType=groupTypesBySegmentKey[key];if(allColumnsMap[thisType]===undefined){allColumnsMap[thisType]=[];allColumnsSetMap[thisType]={};localizedColumns[thisType]=[];}var thisTypeColumnsSet=allColumnsSetMap[thisType];var thisTypeColumns=allColumnsMap[thisType];var thisTypeColumnsLocalized=localizedColumns[thisType];groupLinesBySegmentKey[key].forEach(function(line){if(thisTypeColumnsSet[line.SegmentLabel__c]===undefined){var segLabel=line.SegmentLabel__c;thisTypeColumnsSet[segLabel]=true;var localizedName=segLabel;if(line.isTimeBasedSegment){thisTypeColumns.push(segLabel);if(!line.isCustomDimension){if(line.SegmentIndex__c!=0){var localizedDimName=settings.dimensionValueLabelMap[line.dimType];localizedName=localizedName.replace(line.dimType,localizedDimName);}else{localizedName=getLocalizedSegmentName(line,settings.devPrefix)||localizedName;}}thisTypeColumnsLocalized.push(localizedName);}else{thisTypeColumns.unshift(segLabel);localizedName=getLocalizedSegmentName(line,settings.devPrefix)||localizedName;thisTypeColumnsLocalized.unshift(localizedName);}}});}}return allColumnsMap;}function getLocalizedSegmentName(line,prefix){var dimId=line.Dimension__c;if(dimId!=null){var locByField=LOC_BY_FIELD_BY_DIM[dimId]||null;if(locByField!=null&&locByField['Name']!=null){return getLocalizationValue(locByField['Name'],prefix);}}return null;}function getLocalizationValue(locVo,prefix){if(locVo.record!=null){var rec=locVo.record;return rec[prefix+'Text__c']||rec[prefix+'TextArea__c']||rec[prefix+"LongTextArea__c"]||rec[prefix+"RichTextArea__c"]||null;}return null;}function computeMultiSegmentColumnTotals(lines,columnNames,groupTypesBySegmentKey,settings){var allColumnTotals={};if(lines!=null){for(var dimType in columnNames){var columnList=columnNames[dimType];allColumnTotals[dimType]={};columnList.forEach(function(c){if(allColumnTotals[dimType][c]===undefined){allColumnTotals[dimType][c]=0;}lines.forEach(function(line){if(line.SegmentLabel__c==c&&groupTypesBySegmentKey[line.SegmentKey__c]==dimType){allColumnTotals[dimType][c]+=line.displayedSubtotalField*line.effectiveQuantity;}});});}}for(var k in allColumnTotals){if(allColumnTotals.hasOwnProperty(k)){for(var j in allColumnTotals[k]){if(allColumnTotals[k].hasOwnProperty(j)){allColumnTotals[k][j]=NumberUtils.setScale(allColumnTotals[k][j],settings.unitPriceScale);}}}}return allColumnTotals;}function computeMultiSegmentRowTotals(lines,settings){var allRowTotals={};if(lines!=null){lines.forEach(function(line){if(line.SegmentKey__c!=null&&allRowTotals[line.SegmentKey__c]!==undefined){allRowTotals[line.SegmentKey__c]+=line.NetPrice__c*line.effectiveQuantity;}else if(line.SegmentKey__c!=null){allRowTotals[line.SegmentKey__c]=line.NetPrice__c*line.effectiveQuantity;}});}for(var k in allRowTotals){if(allRowTotals.hasOwnProperty(k)){allRowTotals[k]=NumberUtils.setScale(allRowTotals[k],settings.unitPriceScale);}}return allRowTotals;}function computeMultiSegmentTotal(lines){var multiSegTotalMap={};var groupTypesBySegmentKey={};if(lines!=null){lines.forEach(function(line){if(line.isTimeBasedSegment){groupTypesBySegmentKey[line.SegmentKey__c]=line.dimType;}});lines.forEach(function(line){if(line.SegmentKey__c!=null&&line.NetPrice__c!=null){var thisDimType=groupTypesBySegmentKey[line.SegmentKey__c];if(multiSegTotalMap[thisDimType]===undefined){multiSegTotalMap[thisDimType]=line.displayedSubtotalField*line.effectiveQuantity;}else{multiSegTotalMap[thisDimType]+=line.displayedSubtotalField*line.effectiveQuantity;}}});}return multiSegTotalMap;}function computeNonSegmentTotal(lines){var nonSegTotal=0;if(lines!=null){lines.forEach(function(line){if(line.SegmentKey__c==null&&line.displayedSubtotalField!=null){nonSegTotal+=line.displayedSubtotalField*line.effectiveQuantity;}});}return nonSegTotal;}function computeRowCount(lines){var totalLines=0;if(lines!=null){lines.forEach(function(line){if((line.SegmentIndex__c==null||line.SegmentIndex__c==1)&&line.isVisibleInLineEditor){totalLines++;}});}return totalLines;}},{"../Utils/NumberUtils.js":2,"./Utils/MetaDataUtils.js":33}],26:[function(require,module,exports){var ModelUtils=require("./Utils/ModelUtils.js");var QuoteSummaryModel=function(){function QuoteSummaryModel(quote,data){_classCallCheck2(this,QuoteSummaryModel);this.values=new Object();ModelUtils.copyProperties(data,this);this.quote=quote;}_createClass(QuoteSummaryModel,[{key:"isEditable",value:function isEditable(field){return false;}},{key:"isFieldRendered",value:function isFieldRendered(field){if(this.record!=null){var value=this.record[this.mapPropertyName(field)];return value!=undefined&&value!=null;}return false;}},{key:"mapPropertyName",value:function mapPropertyName(field){return field.name.toLowerCase();}}]);return QuoteSummaryModel;}();module.exports=QuoteSummaryModel;},{"./Utils/ModelUtils.js":34}],27:[function(require,module,exports){"use strict";var SettingsModel=function(){function SettingsModel(settingsVO){_classCallCheck2(this,SettingsModel);this.settings=settingsVO||{};}_createClass(SettingsModel,[{key:"getLabelByKey",value:function getLabelByKey(key){var labels=this.settings['jsqcLabels']||{};if(labels[key]!=null){return labels[key];}else{var noSuchLabelErrorMsg=labels["msg_js_err_no_such_label"];if(noSuchLabelErrorMsg==null){throw new Error("Error: No label exists with the key '"+key+"'. Please contact your Salesforce CPQ administrator.");}throw new Error(noSuchLabelErrorMsg.replace('{0}',key));}}},{key:"isFieldInLineEditor",value:function isFieldInLineEditor(fieldName){return this.settings['fieldsByName'][fieldName]!=null||false;}},{key:"getSummaryFieldsByLineType",value:function getSummaryFieldsByLineType(lineType){if(this.settings){if(lineType===this.devPrefix+"QuoteLine__c"){return this.settings['quoteLineSummaryFields']||[];}else if(lineType===this.devPrefix+"WebQuoteLine__c"){return this.settings['webQuoteLineSummaryFields']||[];}}return[];}},{key:"unitPriceScale",get:function get(){return this.settings['priceScale']!=null?this.settings['priceScale']:2;}},{key:"isMultiCurrencyOrg",get:function get(){return this.settings['isMultiCurrencyOrg']===true;}},{key:"subscriptionTermUnitIsDay",get:function get(){return this.settings['subscriptionTermUnitIsDay']===true;}},{key:"subscriptionProratePrecision",get:function get(){return this.settings['subscriptionProratePrecision']||null;}},{key:"ignoreLeapYearDays",get:function get(){return this.settings['ignoreLeapYearDays']===true;}},{key:"requiredByMessage",get:function get(){return this.settings['msgRequiredBy']||"";}},{key:"quantityScale",get:function get(){return this.settings['quantityScale']!=null?this.settings['quantityScale']:2;}},{key:"hasQuotePriceRules",get:function get(){return this.settings['hasQuotePriceRules']===true;}},{key:"quoteMagicFieldApiNamesByAlias",get:function get(){return this.settings['quoteMagicFieldApiNamesByAlias'];}},{key:"devPrefix",get:function get(){return this.settings['developerPrefix']||'';}},{key:"discountsUseCustomExclusionField",get:function get(){return this.settings['discountsUseCustomExclusionField']===true;}},{key:"currencySymbol",get:function get(){return this.settings['currencySymbol']||"$";}},{key:"currencyIsoCodes",get:function get(){return this.settings['currencyIsoCodes']||[];}},{key:"isRenewedAssetsHiddenWhenEditing",get:function get(){return this.settings['isRenewedAssetsHiddenWhenEditing']===true;}},{key:"plugin",get:function get(){return this.settings['jsqcPlugin']||null;}},{key:"displayedLookupMap",get:function get(){return this.settings['displayedLookupMap']||{};}},{key:"nameFieldsByObjectType",get:function get(){return this.settings['nameFieldsByObjectType']||{};}},{key:"isIncludeNetNewInMaintenanceEnabled",get:function get(){return this.settings['includeNetNewInMaintenanceEnabled']===true;}},{key:"isIncludePriorBPAssetRenewal",get:function get(){return this.settings['blockPriceAssetBehavior']=='IncludePriorPurchases'||false;}},{key:"dimensionValueLabelMap",get:function get(){return this.settings['dimensionValueLabelMap']||{};}},{key:"prorateAmountDiscountFieldName",get:function get(){return this.settings['prorateAmountDiscountFieldName']||null;}},{key:"defaultAdditionalDiscountFieldName",get:function get(){return this.settings['defaultAdditionalDiscountFieldName']||null;}},{key:"overageRateFieldName",get:function get(){return this.settings['overageRateFieldName']||null;}},{key:"referencedFieldMap",get:function get(){return this.settings['referencedFieldMap']||{};}},{key:"quoteLookups",get:function get(){return this.settings['quoteLookups']||{};}},{key:"groupLookups",get:function get(){return this.settings['groupLookups']||{};}},{key:"allLineLookups",get:function get(){return this.settings['lineLookups']||{};}},{key:"nonstandardLineLookups",get:function get(){var original=this.allLineLookups;var result={};for(var key in original){if(key!=='Product__c'&&key!=='SBQQ__Product__c'&&key!=='ProductOption__c'&&key!=='SBQQ__ProductOption__c'){result[key]=original[key];}}return result;}},{key:"lineEditorSubtotalsField",get:function get(){return this.settings['lineEditorSubtotalsField']||null;}},{key:"jsqcLabels",get:function get(){return this.settings['jsqcLabels']||{};}}]);return SettingsModel;}();module.exports=SettingsModel;},{}],28:[function(require,module,exports){"use strict";var OperatorsUtils=require("./Utils/OperatorsUtils.js");var MetaDataUtils=require("./Utils/MetaDataUtils.js");var DateUtils=require('../Utils/DateUtils.js');var SummaryVariableCalculator=function(){function SummaryVariableCalculator(variablesMap,settings){_classCallCheck2(this,SummaryVariableCalculator);this.variablesById=variablesMap;this.variables=[];this.settings=settings;for(var property in variablesMap){if(variablesMap.hasOwnProperty(property)){this.variables.push(variablesMap[property]);}}this.results={};this.aggregateValues={};}_createClass(SummaryVariableCalculator,[{key:"calculate",value:function calculate(quote,targetRecords){this.variables.forEach(function(v){this.aggregateValues[v["Id"]]=this.calculateAggregateValue(v,quote,targetRecords);},this);this.variables.forEach(function(v){this.results[v["Id"]]=this.calculateCompositeValue(v,v["Id"]);},this);}},{key:"getResult",value:function getResult(id){return this.results[id];}},{key:"calculateAggregateValue",value:function calculateAggregateValue(variable,quote,records){var cnt=0;var sum=0;var min=null;var minDate=null;var max=null;var maxDate=null;var prefix=this.settings.devPrefix;if(variable[prefix+"TargetObject__c"]==null){variable[prefix+"TargetObject__c"]="Quote Line";}var aggregateField=variable[prefix+"AggregateField__c"];aggregateField=MetaDataUtils.getField(variable[prefix+"TargetObject__c"],aggregateField,prefix);var op=OperatorsUtils.getInstance(variable[prefix+"Operator__c"]);if(op==null&&variable[prefix+"FilterField__c"]!=null){var invalidSumVarOp=this.settings.getLabelByKey("msg_js_err_sv_invalid_op").replace("{0}",variable["Id"]).replace("{1}",variable[prefix+"Operator__c"]);throw new Error(invalidSumVarOp);}var recordSetEmpty=true;records.forEach(function(rec){if(getSObjectType(rec,prefix)===variable[prefix+"TargetObject__c"]){recordSetEmpty=false;if(variable[prefix+"FilterField__c"]!=null){var field=variable[prefix+"FilterField__c"];field=MetaDataUtils.getField(MetaDataUtils.getRecordType(rec),field,prefix);if(field!=null&&!op.evaluate(rec[field],variable[prefix+"FilterValue__c"])){return;}if(variable[prefix+"ConstraintField__c"]!=null&&!this.isConstraintMet(variable,quote,rec)){return;}}var aggregateValue=rec[aggregateField];if(aggregateValue!=null){if(variable[prefix+"AggregateFunction__c"].toLowerCase()!=="count"){var aggregateDecimal=Number(aggregateValue);if(aggregateDecimal===aggregateDecimal){sum+=aggregateDecimal;min=min==null?aggregateDecimal:Math.min(min,aggregateDecimal);max=max==null?aggregateDecimal:Math.max(max,aggregateDecimal);}else if(typeof aggregateValue=='string'){var msTime=Date.parse(aggregateValue);if(msTime===msTime){var aggregateDate=new Date(msTime);if(min==null||minDate>aggregateDate){min=aggregateValue;minDate=aggregateDate;}if(max==null||maxDate<aggregateDate){max=aggregateValue;maxDate=aggregateDate;}}}}cnt++;}}},this);if(variable[prefix+"AggregateFunction__c"]==null){var missingAggregateMsg=this.settings.getLabelByKey("msg_js_err_sv_missing_aggregate").replace("{0}",variable["Id"]);throw new Error(missingAggregateMsg);}else if(variable[prefix+"AggregateFunction__c"].toLowerCase()==="count"){return cnt;}else if(variable[prefix+"AggregateFunction__c"].toLowerCase()==="sum"){return sum;}else if(variable[prefix+"AggregateFunction__c"].toLowerCase()==="average"){return cnt>0?sum/cnt:0;}else if(variable[prefix+"AggregateFunction__c"].toLowerCase()==="min"){return min;}else if(variable[prefix+"AggregateFunction__c"].toLowerCase()==="max"){return max;}else{var unsupportedAggregateMsg=this.settings.getLabelByKey("msg_js_err_sv_unsupported_aggregate").replace("{0}",variable["Id"]).replace("{1}",variable[prefix+"AggregateFunction__c"]);throw new Error(unsupportedAggregateMsg);}}},{key:"isConstraintMet",value:function isConstraintMet(variable,quote,rec){var prefix=this.settings.devPrefix;var constraintFieldName=variable[prefix+"ConstraintField__c"];var recField=MetaDataUtils.getField(MetaDataUtils.getRecordType(rec),constraintFieldName,prefix);var quoteField=MetaDataUtils.getField(MetaDataUtils.getObjectType(quote),constraintFieldName,prefix);if(recField!=null){return OperatorsUtils.getInstance("equals").evaluate(rec[recField],quote["record"][quoteField]);}return false;}},{key:"calculateCompositeValue",value:function calculateCompositeValue(v,originalVarId){var prefix=this.settings.devPrefix;var aggValue=this.aggregateValues[v["Id"]];var combineField=v[prefix+"CombineWith__c"];var compositeOp=v[prefix+"CompositeOperator__c"];if(combineField!=null||compositeOp!=null){if(combineField===originalVarId){var circularRefMsg=this.settings.getLabelByKey("msg_js_err_sv_circular_reference").replace("{0}",originalVarId);throw new Error(circularRefMsg);}var anotherVar=this.variablesById[combineField];var anotherVal=combineField!=null?this.calculateCompositeValue(anotherVar,originalVarId):v[prefix+"ValueElement__c"];if(aggValue==null||anotherVal==null){return null;}try{return this.applyCompositeOperator(aggValue,anotherVal,compositeOp);}catch(e){var msg;if(e.problem=='bad op'){msg=this.settings.getLabelByKey("msg_js_err_sv_unrecognized_comp_op").replace("{0}",v["Id"]).replace("{1}",compositeOp);}else if(e.problem=='bad compose'){msg=this.settings.getLabelByKey("msg_sumvar_composition_err").replace("{0}",v["Id"]).replace("{1}",combineField);}else if(e.problem=='mult-div-date'){msg=this.settings.getLabelByKey("msg_sv_date_op_conflict_err").replace("{0}",v["Id"]).replace("{1}",compositeOp);}throw new Error(msg);}}return aggValue;}},{key:"applyCompositeOperator",value:function applyCompositeOperator(base,augment,operator){var convertedBase=typeof base=='string'?new Date(Date.parse(base)):base;var convertedAugment=typeof augment=='string'?new Date(Date.parse(augment)):augment;var baseType;var augmentType;var err;switch(operator){case null:case undefined:case'Add':if(typeof convertedAugment=='number'||convertedAugment instanceof Number){if(convertedBase instanceof Date){convertedBase.setUTCDate(convertedBase.getUTCDate()+convertedAugment);baseType=DateUtils.distinguishDateFromDateTime(base);if(baseType=='date'){return DateUtils.toApexDate(convertedBase);}else if(baseType=='datetime'){return DateUtils.toApexDateTime(convertedBase);}}else{return convertedBase+convertedAugment;}}err=new Error();err.problem='bad compose';throw err;case'Subtract':if(typeof convertedBase=='number'||convertedBase instanceof Number){if(typeof convertedAugment=='number'||convertedAugment instanceof Number){return convertedBase-convertedAugment;}}else if(convertedBase instanceof Date){baseType=DateUtils.distinguishDateFromDateTime(base);if(typeof convertedAugment=='number'||convertedAugment instanceof Number){convertedBase.setUTCDate(convertedBase.getUTCDate()-convertedAugment);if(baseType=='date'){return DateUtils.toApexDate(convertedBase);}else if(stringType=='datetime'){return DateUtils.toApexDateTime(convertedBase);}}else{augmentType=DateUtils.distinguishDateFromDateTime(augment);if(baseType==augmentType&&baseType=='date'){return DateUtils.daysBetween(convertedAugment,convertedBase);}}}err=new Error();err.problem='bad compose';throw err;case'Multiply':case'Divide':var baseIsNum=typeof convertedBase=='number'||convertedBase instanceof Number;var augIsNum=typeof convertedAugment=='number'||convertedAugment instanceof Number;if(baseIsNum&&augIsNum){if(operator=='Multiply'){return base*augment;}else if(operator=='Divide'){return augment==0?null:base/augment;}}err=new Error();err.problem='mult-div-date';throw err;default:err=new Error();err.problem="bad op";throw err;}}}]);return SummaryVariableCalculator;}();function getSObjectType(obj,prefix){var t=obj["attributes"]["type"];switch(t){case prefix+"QuoteLine__c":return"Quote Line";case"Asset":return"Asset";case prefix+"ProductOption__c":return"Product Option";case prefix+"Subscription__c":return"Subscription";case"ContractLineItem":return"Subscription";default:return t;}}module.exports=SummaryVariableCalculator;},{"../Utils/DateUtils.js":1,"./Utils/MetaDataUtils.js":33,"./Utils/OperatorsUtils.js":36}],29:[function(require,module,exports){"use strict";var numberUtils=require("../Utils/NumberUtils.js");var TargetCalculator2=function(){function TargetCalculator2(settings){_classCallCheck2(this,TargetCalculator2);this.settings=settings;}_createClass(TargetCalculator2,[{key:"resetDiscounts",value:function resetDiscounts(quote,group){var targetLines=group!=null&&group.TargetCustomerAmount__c!=null?group.lineItems:quote.targetLineItems;var lineCount=targetLines.length;for(var i=0;i<lineCount;i++){var line=targetLines[i];if(line.isTargetDiscountable){line.Discount__c=null;line.AdditionalDiscountAmount__c=null;}}}},{key:"calculate",value:function calculate(quote,group){var targetAmount=group!=null&&group.TargetCustomerAmount__c!=null?group.TargetCustomerAmount__c:quote.TargetCustomerAmount__c;if(targetAmount==null){return;}var targetLines=group!=null&&group.TargetCustomerAmount__c!=null?group.lineItems:quote.targetLineItems;var discountableAmount=0;var regularAmount=0;targetLines.forEach(function(line){if(!line.Optional__c){regularAmount+=line.regularTotal;if(line.isTargetDiscountable||line.isDynamicSubscription){discountableAmount+=line.regularTotal;}}});if(discountableAmount!=0){var discount=regularAmount-targetAmount;var discountRate=discount/discountableAmount;var accumulatedDiscount=0;var ups=this.settings.unitPriceScale;targetLines.forEach(function(line){if(line.isTargetDiscountable||line.isDynamicSubscription){var ada=numberUtils.setScale(line.RegularPrice__c*discountRate,ups);if(!line.isDynamicSubscription){if(line.amountDiscountProrated&&line.ProrateMultiplier__c!=0){line.AdditionalDiscountAmount__c=ada/line.ProrateMultiplier__c;}else{line.AdditionalDiscountAmount__c=ada;}}accumulatedDiscount+=ada*line.effectiveQuantity;}});if(discount!=accumulatedDiscount){var item1=findLineWithQuantity1(targetLines);if(item1!=null){var addDisc=numberUtils.setScale(item1.AdditionalDiscountAmount__c+discount-accumulatedDiscount,ups);if(item1.amountDiscountProrated&&item1.ProrateMultiplier__c!=0){item1.AdditionalDiscountAmount__c=addDisc/item1.ProrateMultiplier__c;}else{item1.AdditionalDiscountAmount__c=addDisc;}}}}}},{key:"adjustDynamicItems",value:function adjustDynamicItems(quote,group){var targetAmount=group!=null&&group.TargetCustomerAmount__c!=null?group.TargetCustomerAmount__c:quote.TargetCustomerAmount__c;var noAmount=targetAmount==null;var quoteTotalReached=group==null&&targetAmount===quote.customerTotal;var groupTotalReached=group!=null&&targetAmount==group.record[this.settings.devPrefix+"CustomerTotal__c"];if(noAmount||quoteTotalReached||groupTotalReached){return;}var targetLines=group!=null&&group.TargetCustomerAmount__c!=null?group.lineItems:quote.targetLineItems;var discountableAmount=0;targetLines.forEach(function(line){if(line.isTargetDiscountable&&line.isDynamicSubscription){discountableAmount+=line.regularTotal;}});if(discountableAmount!==0){var discount=group==null?quote.customerTotal-targetAmount:group.record[this.settings.devPrefix+"CustomerTotal__c"]-targetAmount;var discountRate=discount/discountableAmount;var accumulatedDiscount=0;var ups=this.settings.unitPriceScale;targetLines.forEach(function(line){if(line.isTargetDiscountable&&line.isDynamicSubscription){if(line.amountDiscountProrated&&line.ProrateMultiplier__c!=0){line.AdditionalDiscountAmount__c=numberUtils.setScale(line.RegularPrice__c*discountRate/line.ProrateMultiplier__c,ups);}else{line.AdditionalDiscountAmount__c=numberUtils.setScale(line.RegularPrice__c*discountRate,ups);}accumulatedDiscount+=line.AdditionalDiscountAmount__c*line.effectiveQuantity;}});if(discount!=accumulatedDiscount){var item1=findDynamicLineWithQuantity1(targetLines);if(item1!=null){var addDisc=numberUtils.setScale(item1.AdditionalDiscountAmount__c+discount-accumulatedDiscount,ups);if(item1.amountDiscountProrated&&item1.ProrateMultiplier__c!=0){item1.AdditionalDiscountAmount__c=addDisc/item1.ProrateMultiplier__c;}else{item1.AdditionalDiscountAmount__c=addDisc;}}}}}}]);return TargetCalculator2;}();function findLineWithQuantity1(lines){var res=null;lines.forEach(function(line){if(res==null){if(line.effectiveQuantity===1&&line.isTargetDiscountable&&!line.isDynamicSubscription&&!line.isTimeBasedSegment){res=line;}}});return res;}function findDynamicLineWithQuantity1(lines){var res=null;lines.forEach(function(line){if(res==null){if(line.effectiveQuantity===1&&line.isTargetDiscountable&&line.isDynamicSubscription&&!line.isTimeBasedSegment){res=line;}}});return res;}module.exports=TargetCalculator2;},{"../Utils/NumberUtils.js":2}],30:[function(require,module,exports){var RestClient=require('../data/RestClient.js');var RemoteClient=require('../data/RemoteClient.js');var RestProxy=require('../data/RestProxy.js');var cache=require('../data/Cache.js')();module.exports=function(conn,orgUrl,forceRest){var inBrowser=typeof window!=='undefined';if(!inBrowser){cache=require('../data/Cache.js')();}if(inBrowser&&conn===undefined&&orgUrl===undefined&&forceRest===undefined){var precache=function precache(provider,uid,res){var obj=cache.get(provider,uid);if(!obj){cache.put(provider,uid,res);}};return{precache:precache};}var useRest=forceRest||typeof Visualforce==='undefined';var client=useRest?new RestClient(inBrowser?new RestProxy(conn,orgUrl):{get:conn.apex.get.bind(conn.apex),patch:conn.apex.patch.bind(conn.apex),post:conn.apex.post.bind(conn.apex),md:conn.metadata.read.bind(conn.metadata),query:conn.query.bind(conn),queryMore:conn.queryMore.bind(conn),oik:conn.oik}):new RemoteClient(conn!=='ajax'?conn:null);function read(prefix,provider,uid){var obj=cache.get(provider,uid);return obj?Promise.resolve(obj):new Promise(function(resolve,reject){client.read(prefix,provider,uid).then(function(res){cache.put(provider,uid,res);resolve(res);},function(err){reject(err.message||err);});});}function load(prefix,provider,uid,context){var obj=cache.get(provider,uid);return obj?Promise.resolve(obj):new Promise(function(resolve,reject){client.load(prefix,provider,uid||'',context).then(function(res){cache.put(provider,uid,res);resolve(res);},function(err){reject(err.message||err);});});}function loadLookupTables(prefix,tableMap){var tableMapForUncachedRows;var cachedConstraintsByTableName=cache.get('LookupTables','constraints')||{};var cachedRowMapsByTableName=cache.get('LookupTables','rows')||{};if(Object.keys(cachedConstraintsByTableName).length===0){tableMapForUncachedRows=tableMap;}else{tableMapForUncachedRows=tableMap.returnTablesWithConstraintsNotCoveredBy(cachedConstraintsByTableName);}return queryAndCacheRowsIfNeeded(tableMapForUncachedRows);function queryAndCacheRowsIfNeeded(uncachedTableMap){if(uncachedTableMap.containsSatisfiableTables){return new Promise(function(resolve,reject){client.load(prefix,'LookupTableServiceProvider.LookupTableLoader','',uncachedTableMap.toJson()).then(function(results){combineUncachedRowsWithCachedRowMaps(results);cache.put('LookupTables','rows',cachedRowMapsByTableName);updateCachedConstraints(uncachedTableMap);cache.put('LookupTables','constraints',cachedConstraintsByTableName);resolve(cachedRowMapsByTableName);},function(err){reject(err.message||err);});});}else{return Promise.resolve(cachedRowMapsByTableName);}}function combineUncachedRowsWithCachedRowMaps(uncachedRows){for(var tableName in uncachedRows){var rowList=uncachedRows[tableName];if(rowList==null){continue;}var cachedMap=cachedRowMapsByTableName[tableName]||{};var rowCount=rowList.length;for(var i=0;i<rowCount;i++){var uncachedRow=rowList[i];var uncachedRowId=uncachedRow['Id'];cachedMap[uncachedRowId]=uncachedRow;}cachedRowMapsByTableName[tableName]=cachedMap;}}function updateCachedConstraints(uncachedTableMap){for(var tableName in uncachedTableMap.tableInfoByName){var cachedConstraintList=cachedConstraintsByTableName[tableName]||[];cachedConstraintList=cachedConstraintList.concat(uncachedTableMap.tableInfoByName[tableName]._constraintSetList);cachedConstraintsByTableName[tableName]=cachedConstraintList;}}}function clear(provider,uid){cache.clear(provider,uid);}function setOptions(opts){client.setOptions(opts);}function save(prefix,provider,obj,cacheToPurge,keepNulls){return new Promise(function(resolve,reject){client.save(prefix,provider,obj,keepNulls).then(function(res){purge(cacheToPurge);resolve(res);},function(err){reject(err);});});}function md(mdType,fields,prefix){var uid=fields.join(',');var obj=cache.get(mdType,uid);if(obj){return Promise.resolve(obj);}else{return load(prefix,'MetaDataServiceProvider.FieldMetaDataLoader',null,{fields:fields}).then(function(response){cache.put(mdType,uid,response);return response;});}}function query(soql){var obj=cache.get('SOQL',soql);return obj?Promise.resolve(obj):new Promise(function(resolve,reject){client.query(soql).then(function(results){cache.put('SOQL',soql,results);resolve(results);},function(err){reject(err.message||err);});});}function queryMore(queryLocator){return new Promise(function(resolve,reject){client.queryMore(queryLocator).then(function(results){resolve(results);},function(err){reject(err.message||err);});});}function purge(cacheToPurge){if(!cacheToPurge)return;if(!cacheToPurge.provider||!cacheToPurge.uid)return;var providers=cacheToPurge.provider.constructor===Array?cacheToPurge.provider:[cacheToPurge.provider];var ids=cacheToPurge.uid.constructor===Array?cacheToPurge.uid:[cacheToPurge.uid];var numProviders=providers.length;for(var i=0;i<numProviders;i++){var provider=providers[i];var id=ids.length>i?ids[length]:undefined;cache.clear(provider,id);}}return{read:read,load:load,loadLookupTables:loadLookupTables,save:save,md:md,query:query,queryMore:queryMore,clear:clear,setOptions:setOptions};};},{"../data/Cache.js":37,"../data/RemoteClient.js":38,"../data/RestClient.js":39,"../data/RestProxy.js":40}],31:[function(require,module,exports){"use strict";var CONVERSION_TABLE={"00000":"A","00001":"B","00010":"C","00011":"D","00100":"E","00101":"F","00110":"G","00111":"H","01000":"I","01001":"J","01010":"K","01011":"L","01100":"M","01101":"N","01110":"O","01111":"P","10000":"Q","10001":"R","10010":"S","10011":"T","10100":"U","10101":"V","10110":"W","10111":"X","11000":"Y","11001":"Z","11010":"0","11011":"1","11100":"2","11101":"3","11110":"4","11111":"5"};module.exports.compareIds=compareIds;module.exports.convertTo18=convertTo18;function compareIds(id1,id2,settings){if(id1==null&&id2==null){return true;}else if(id1==null||id2==null){return false;}return convertTo18(id1,settings).toUpperCase()===convertTo18(id2,settings).toUpperCase();}function convertTo18(id,settings){if(!id){return null;}else if(id.length===18){return id;}else if(id.length===15){var part1=convertToDigit(id.slice(0,5));var part2=convertToDigit(id.slice(5,10));var part3=convertToDigit(id.slice(10,15));return id+part1+part2+part3;}else{var idConversionErrString=settings.getLabelByKey("msg_js_err_id_conversion").replace("{0}",id);throw Error(idConversionErrString);}}function reverseString(str){return str.split("").reverse().join("");}function replaceWithBinary(string){var res=string.replace(/[^A-Z]/g,"0");return res.replace(/[A-Z]/g,"1");}function convertToDigit(seg){return CONVERSION_TABLE[replaceWithBinary(reverseString(seg))];}},{}],32:[function(require,module,exports){module.exports.TYPE_RENEWAL="Renewal";module.exports.TYPE_AMENDMENT="Amendment";module.exports.TYPE_CHANGEQUOTE="Re-Quote";module.exports.TYPE_SINGLE_DIMENSION="One-time";module.exports.TYPE_YEARLY_DIMENSION="Year";module.exports.TYPE_QUARTERLY_DIMENSION="Quarter";module.exports.TYPE_MONTHLY_DIMENSION="Month";module.exports.TYPE_CUSTOM_DIMENSION="Custom";module.exports.PRICING_METHOD_CUSTOM="Custom";module.exports.PRICING_METHOD_COST="Cost";module.exports.PRICING_METHOD_BLOCK="Block";module.exports.PRICING_METHOD_LIST="List";module.exports.PRICING_METHOD_PERCENT_OF_TOTAL="percent of total";module.exports.OP_EQ="equals";module.exports.OP_NEQ="not equals";module.exports.OP_LT="less than";module.exports.OP_LTE="less or equals";module.exports.OP_GT="greater than";module.exports.OP_GTE="greater or equals";module.exports.OP_SW="starts with";module.exports.OP_EW="ends with";module.exports.OP_CONT="contains";},{}],33:[function(require,module,exports){var UNIVERSAL_STANDARD_FIELDS={'id':true,'createddate':true,'lastmodifieddate':true,'name':true,'ownerid':true,'createdbyid':true,'lastmodifiedbyid':true,'currencyisocode':true};var QUOTE_LINE_STANDARD_FIELDS={"quantity":"Quantity__c","list price":"ListPrice__c","net total":"NetTotal__c","customer total":"CustomerTotal__c","regular total":"RegularTotal__c","list total":"ListTotal__c","product family":"ProductFamily__c","product code":"ProductCode__c","product":"Product__c","markup (%)":"MarkupRate__c","markup (amt)":"MarkupAmount__c","discount (%)":"Discount__c","discount (amt)":"AdditionalDiscountAmount__c","partner discount":"PartnerDiscount__c","subscription category":"SubscriptionCategory__c","total discount (amt)":"TotalDiscountAmount__c","optional":"Optional__c","number":"Number__c"};var QUOTE_STANDARD_FIELDS={'type':"Type__c",'status':"Status__c","primary":"Primary__c","list amount":"ListAmount__c","regular amount":"RegularAmount__c","customer amount":"CustomerAmount__c","net amount":"NetAmount__c","total customer disc. amount":"TotalCustomerDiscountAmount__c","addl. disc. amount":"AdditionalDiscountAmount__c","bill to country":"BillingCountry__c","ship to country":"ShippingCountry__c","group line items":"LineItemsGrouped__c"};var ASSET_STANDARD_FIELDS={'AccountId':'AccountId','ContactId':'ContactId','Description':'Description','InstallDate':'InstallDate','IsCompetitorProduct':'IsCompetitorProduct','LastReferencedDate':'LastReferencedDate','LastViewedDate':'LastViewedDate','Name':'Name','OwnerId':'OwnerId','ParentId':'ParentId','Price':'Price','PurchaseDate':'PurchaseDate','Quantity':'Quantity','RootAssetId':'RootAssetId','SerialNumber':'SerialNumber','Status':'Status','UsageEndDate':'UsageEndDate'};var SUBSCRIPTION_STANDARD_FIELDS={'quantity':'Quantity__c'};module.exports.getRecordType=function(object){if(object==null){return null;}else if(object.hasOwnProperty("attributes")&&object["attributes"]!=null){return object["attributes"]["type"];}return null;};module.exports.getObjectType=function(obj){var record=obj["record"];if(record==null){return null;}else if(record.hasOwnProperty("attributes")&&record["attributes"]!=null){return record["attributes"]["type"];}return null;};module.exports.getField=function(type,name,prefix){if(name==null){return null;}if(UNIVERSAL_STANDARD_FIELDS[name.toLowerCase()]!=null){return name;}var lcPrefix=prefix.toLowerCase();var convType=type.toLowerCase();switch(convType){case lcPrefix+"quoteline__c":case'quote line':return getFieldFromMap(QUOTE_LINE_STANDARD_FIELDS,name,prefix);case lcPrefix+'quote__c':case'quote':return getFieldFromMap(QUOTE_STANDARD_FIELDS,name,prefix);case'asset':return ASSET_STANDARD_FIELDS[name]||name;case lcPrefix+'subscription__c':case'subscription':return getFieldFromMap(SUBSCRIPTION_STANDARD_FIELDS,name,prefix);default:return name;}};module.exports.getAliasTargetType=function(targetType){switch(targetType){case'SBQQ__Quote__c':case'Quote__c':return'Quote';case'SBQQ__QuoteLineGroup__c':case'QuoteLineGroup__c':return'Group';case'SBQQ__QuoteLine__c':case'QuoteLine__c':return'Quote Line';default:return targetType;}};function getFieldFromMap(fieldMap,field,prefix){var trueField=fieldMap[field.toLowerCase()];if(trueField!=null){return prefix+trueField;}else{if(field.lastIndexOf('__c')===field.length-3&&field.indexOf(' ')===-1){return field;}else{return null;}}}},{}],34:[function(require,module,exports){var DateUtils=require('../../Utils/DateUtils.js');var IdUtils=require("./IdUtils");module.exports.copyProperties=copyProperties;module.exports.dateGetter=dateGetter;module.exports.standardGetter=standardGetter;module.exports.idGetter=idGetter;module.exports.opportunityLookupGetter=opportunityLookupGetter;module.exports.dateSetter=dateSetter;module.exports.standardSetter=standardSetter;module.exports.invalidSetter=invalidSetter;module.exports.deleteGettersAndSetters=deleteGettersAndSetters;function copyProperties(src,target){for(var attr in src){if(!(src[attr]instanceof Function)){target[attr]=src[attr];}}}function deleteGettersAndSetters(obj){for(var attr in obj){var protoDescr=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(obj),attr);if(protoDescr!=null&&(protoDescr.get!=null||protoDescr.set!=null)){delete Object.getPrototypeOf(obj)[attr];}}}function dateGetter(field,record){var res=record[field];if(res!=null){return new Date(res);}else{return null;}}function standardGetter(field,record){return record[field];}function idGetter(field,record,settings){var res=record[field];if(res!=null){return IdUtils.convertTo18(res,settings);}else{return null;}}function opportunityLookupGetter(field,record,settings){var res=record[field];if(res!=null){return res;}var prefix=settings.devPrefix;var opp=record[prefix+'Opportunity2__r'];if(opp!=null){switch(field){case'Account__c':case"SBQQ__Account__c":res=opp.AccountId;break;case"PricebookId__c":case"SBQQ__PricebookId__c":res=opp.Pricebook2Id;}}if(res!=null){return IdUtils.convertTo18(res,settings);}return null;}function dateSetter(value,field,record){if(value instanceof Date){value=DateUtils.toApexDate(value);}standardSetter(value,field,record);}function standardSetter(value,field,record){record[field]=value;}function invalidSetter(v,f,r){throw Error("You cannot modify '"+f+"', as it is read-only");}},{"../../Utils/DateUtils.js":1,"./IdUtils":31}],35:[function(require,module,exports){var jsforce=require('jsforce');var oauth_utils=function oauth_utils(accessToken,orgPrefix){var remoteAction='QuoteLineEditorController.refreshAccessToken';if(orgPrefix)remoteAction=orgPrefix+remoteAction;jsforce.OAuth2.prototype.refreshToken=function(refreshToken,callback){Visualforce.remoting.Manager.invokeAction(remoteAction,function(accessToken,event){cacheToken(accessToken);callback(!accessToken?{message:event.message}:false,{access_token:accessToken,id:''});});};function getConnection(){return new jsforce.Connection({oauth2:new jsforce.OAuth2({clientId:true,clientSecret:true}),accessToken:accessToken||getCachedToken(),refreshToken:'',instanceUrl:sb.common.core.AppContext.org.orgUrl});}function getCachedToken(){if(typeof sessionStorage==='undefined')return'';return sessionStorage.getItem(remoteAction);}function cacheToken(accessToken){if(typeof sessionStorage==='undefined')return;sessionStorage.setItem(remoteAction,accessToken);}return{getConnection:getConnection};};module.exports=oauth_utils;},{"jsforce":112}],36:[function(require,module,exports){var constants=require("./JSQCConstants.js");module.exports.getInstance=getInstance;module.exports.getInverseInstance=getInverseInstance;function getInstance(key){switch(key){case constants.OP_EQ:return new OpEquals();case constants.OP_NEQ:return new OpNotEquals();case constants.OP_LT:return new OpLessThan();case constants.OP_LTE:return new OpLessThanEquals();case constants.OP_GT:return new OpGreaterThan();case constants.OP_GTE:return new OpGreaterThanEquals();case constants.OP_SW:return new OpStartsWith();case constants.OP_EW:return new OpEndsWith();case constants.OP_CONT:return new OpContains();default:return null;}}function getInverseInstance(key){switch(key){case constants.OP_EQ:return new OpEquals();case constants.OP_NEQ:return new OpNotEquals();case constants.OP_LT:return new OpGreaterThan();case constants.OP_LTE:return new OpGreaterThanEquals();case constants.OP_GT:return new OpLessThan();case constants.OP_GTE:return new OpLessThanEquals();case constants.OP_SW:return new OpStartsWith();case constants.OP_EW:return new OpEndsWith();case constants.OP_CONT:return new OpContains();default:return null;}}function OpEquals(){return{testValueCache:{},fieldValueCache:{},opType:constants.OP_EQ,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return fieldValue==testValue;}if(fieldValue instanceof Date){return fieldValue.getTime()===new Date(testValue).getTime();}else if(typeof fieldValue==="boolean"){return fieldValue===(String(testValue).toLowerCase()==="true");}else if(typeof fieldValue==="string"&&typeof testValue==="string"){var lowerCaseTest=testValue.toLowerCase();var lowerCaseField=fieldValue.toLowerCase();if(this.testValueCache[lowerCaseTest]==null){this.testValueCache[lowerCaseTest]=valueFor(lowerCaseTest);}if(this.fieldValueCache[lowerCaseField]==null){this.fieldValueCache[lowerCaseField]=valueFor(lowerCaseField);}return this.testValueCache[lowerCaseTest].equals(this.fieldValueCache[lowerCaseField]);}else if(typeof fieldValue==="number"||fieldValue instanceof Number){return fieldValue.valueOf()==testValue;}return false;}};}function OpNotEquals(){return{opType:constants.OP_NEQ,equals:new OpEquals(),evaluate:function evaluate(fieldValue,testValue){return!this.equals.evaluate(fieldValue,testValue);}};}function OpGreaterThan(){return{opType:constants.OP_GT,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}if(typeof fieldValue==="number"||fieldValue instanceof Number){return fieldValue.valueOf()>testValue;}else if(fieldValue instanceof Date){return fieldValue>new Date(testValue);}else if(typeof fieldValue=='string'){var fieldTime=Date.parse(fieldValue);var testTime=Date.parse(testValue);if(fieldTime===fieldTime&&testTime===testTime){return fieldTime>testTime;}return fieldValue.toLowerCase()>testValue.toLowerCase();}return false;}};}function OpGreaterThanEquals(){return{opType:constants.OP_GTE,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}if(typeof fieldValue==="number"||fieldValue instanceof Number){return fieldValue.valueOf()>=testValue;}else if(fieldValue instanceof Date){return fieldValue>=new Date(testValue);}else if(typeof fieldValue=='string'){var fieldTime=Date.parse(fieldValue);var testTime=Date.parse(testValue);if(fieldTime===fieldTime&&testTime===testTime){return fieldTime>=testTime;}return fieldValue>=testValue;}return false;}};}function OpLessThan(){return{opType:constants.OP_LT,gte:new OpGreaterThanEquals(),evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null||typeof fieldValue!=="number"&&typeof fieldValue!=='string'&&!(fieldValue instanceof Date||fieldValue instanceof Number)){return false;}return!this.gte.evaluate(fieldValue,testValue);}};}function OpLessThanEquals(){return{opType:constants.OP_LTE,gt:new OpGreaterThan(),evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null||typeof fieldValue!=="number"&&typeof fieldValue!=='string'&&!(fieldValue instanceof Date||fieldValue instanceof Number)){return false;}return!this.gt.evaluate(fieldValue,testValue);}};}function OpStartsWith(){return{opType:constants.OP_SW,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}return String(fieldValue).toLowerCase().indexOf(String(testValue).toLowerCase())===0;}};}function OpEndsWith(){return{opType:constants.OP_EW,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}var fStr=String(fieldValue).toLowerCase();var tStr=String(testValue).toLowerCase();return fStr.indexOf(tStr,fStr.length-tStr.length)!==-1;}};}function OpContains(){return{opType:constants.OP_CONT,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}var fStr=String(fieldValue).toLowerCase();var tStr=String(testValue).toLowerCase();return fStr.indexOf(tStr)!==-1;}};}function valueFor(value){if(value.indexOf(',')>-1&&value.indexOf('"')!=0&&value.lastIndexOf('"')!=value.length-1){return{valueType:'Multi',valueSet:value.split(',').map(function(v){return v.trim();}),equals:function equals(otherValue){if(otherValue.valueType==='Multi'){var otherVals=otherValue.valueSet;return otherVals.some(function(v){return this.valueSet.indexOf(v)!=-1;},this);}else{return this.valueSet.indexOf(otherValue.value)!=-1;}}};}else{return{valueType:'Single',value:value,equals:function equals(otherValue){return this.value===otherValue.value;}};}}},{"./JSQCConstants.js":32}],37:[function(require,module,exports){module.exports=function(conn){var cache={};function get(provider,id){if(!provider||!id)return null;return getCache(provider)[id];}function put(provider,id,obj){if(!provider||!id||!obj)return;getCache(provider)[id]=obj;}function clear(provider,id){if(!provider||!id)return;delete getCache(provider)[id];}function getCache(provider){if(!cache[provider])cache[provider]={};return cache[provider];}return{get:get,put:put,clear:clear};};},{}],38:[function(require,module,exports){module.exports=function(conn){function read(prefix,provider,uid){return send(prefix,provider,'read',uid);}function load(prefix,provider,uid,context){return send(prefix,provider,'load',uid,context?JSON.stringify(context,function(key,value){return value===null?undefined:value;}):null);}function save(prefix,provider,obj,keepNulls){var replacer=keepNulls?undefined:function(key,value){return value===null?undefined:value;};return send(prefix,provider,'save',obj?JSON.stringify(obj,replacer):null);}function send(prefix,provider,method,input,context){return System.import('perfMetrics/MetricsService.js').then(function(ms){var metricsService=new ms.MetricsService();var endpoint=getEndpoint(prefix)+'.'+method;if(context)return new Promise(function(resolve,reject){var id=metricsService.startServiceRequest(provider);Visualforce.remoting.Manager.invokeAction(endpoint,provider,input,context,metricsService.canGatherMetrics(),function(obj,event){callback(resolve,reject,obj,event,metricsService,id);},options||{timeout:120000});});return new Promise(function(resolve,reject){var id=metricsService.startServiceRequest(provider);Visualforce.remoting.Manager.invokeAction(endpoint,provider,input,metricsService.canGatherMetrics(),function(obj,event){callback(resolve,reject,obj,event,metricsService,id);},options||{timeout:120000});});});}function query(soql){if(!conn){return Promise.resolve();}else{return conn.query(soql);}}function queryMore(queryLocator){if(!conn){return Promise.resolve();}else{return conn.queryMore(queryLocator);}}var options;function setOptions(opts){options=opts;}function callback(resolve,reject,obj,event,metricsService,id){if(!event.status){metricsService.stopServiceRequest(id);reject(event.message);return;}var response=parse(obj);var spt=Object.keys(response).indexOf('spt')!=-1?response.spt:undefined;response=spt||spt===0?parse(response.response):response;metricsService.stopServiceRequest(id,spt);resolve(response);}function getEndpoint(prefix){var endpoint='ServiceRouter';return prefix?prefix+'.'+endpoint:endpoint;}function parse(obj){if(!options||options.escape!==false)obj=obj.replace(/&quot;/g,'"');try{return JSON.parse(obj);}catch(e){return obj;}}return{read:read,load:load,save:save,query:query,queryMore:queryMore,setOptions:setOptions};};},{}],39:[function(require,module,exports){module.exports=function(proxy){function read(prefix,provider,uid){var endpoint=getEndpoint(prefix);return new Promise(function(resolve,reject){proxy.get(endpoint+'&reader='+provider+'&uid='+uid).then(function(res){resolve(parse(res));},function(err){reject(err);});});}function load(prefix,provider,uid,context){var endpoint=getEndpoint(prefix);var body={context:JSON.stringify(context)};return new Promise(function(resolve,reject){proxy.patch(endpoint+'&loader='+provider+'&uid='+uid,body).then(function(res){resolve(parse(res));},function(err){reject(err);});});}function save(prefix,provider,obj){var endpoint=getEndpoint(prefix);var body={saver:provider,model:JSON.stringify(obj)};return new Promise(function(resolve,reject){proxy.post(endpoint,body).then(function(res){resolve(parse(res));},function(err){reject(err);});});}function query(soql){return new Promise(function(resolve,reject){proxy.query(soql).then(function(res){resolve(res);},function(err){reject(err);});});}function queryMore(queryLocator){return new Promise(function(resolve,reject){proxy.queryMore(queryLocator).then(function(res){resolve(res);},function(err){reject(err);});});}function setOptions(opts){}function getEndpoint(prefix){var endpoint='/ServiceRouter?'+(proxy.oik===undefined?'':'oik='+proxy.oik);return prefix?'/'+prefix+endpoint:endpoint;}function parse(obj){try{return JSON.parse(obj);}catch(e){return obj;}}return{read:read,load:load,save:save,query:query,queryMore:queryMore,setOptions:setOptions};};},{}],40:[function(require,module,exports){module.exports=function(conn){function get(endpoint){return new Promise(function(resolve,reject){conn.apex.get(endpoint).then(function(res){resolve(res);},function(err){reject(err);});});}function patch(endpoint,body){return new Promise(function(resolve,reject){conn.apex.patch(endpoint,body).then(function(res){resolve(res);},function(err){reject(err);});});}function post(endpoint,body){return new Promise(function(resolve,reject){conn.apex.post(endpoint,body).then(function(res){resolve(res);},function(err){reject(err);});});}function query(soql){return conn.query(soql);}function queryMore(queryLocator){return conn.queryMore(queryLocator);}return{get:get,patch:patch,post:post,query:query,queryMore:queryMore,oik:conn.oik};};},{}],41:[function(require,module,exports){var QuoteModel=require("./QuoteModel2.js");var LineCalculator=require("./LineCalculator.js");var QuoteCalculator=require("./QuoteCalculator.js");var ModelUtils=require('./Utils/ModelUtils.js');var SettingsModel=require("./SettingsModel.js");var DateUtils=require('../Utils/DateUtils.js');var NumberUtils=require("../Utils/NumberUtils.js");var ApexUtils=require('./Utils/ApexUtils.js');var QuoteDAO=require('./DAO/QuoteDAO.js');var QuoteOpportunitySynchronizer=require('./QuoteOpportunitySynchronizer.js');var JSQCPrecacher=require('./JSQCPrecacher.js');var ModelNotifierManager=require('./ModelNotifierManager.js');var JSQC=function(){function JSQC(settings,copiedQuote,notifier){_classCallCheck2(this,JSQC);this.settings=new SettingsModel(settings);this.quote=new QuoteModel(this.settings,copiedQuote,notifier);if(typeof Proxy==='undefined'&&notifier){this.notifierManager=new ModelNotifierManager(notifier);this.notifierManager.recordOriginalValues(this.quote);}this.qc=new QuoteCalculator(this.quote,this.settings);}_createClass(JSQC,[{key:"initConnection",value:function initConnection(accessToken,orgPrefix){this.qc.initConnection(accessToken,orgPrefix);}},{key:"initConnections",value:function initConnections(accessToken,orgPrefix){this.qc.initConnections(accessToken,orgPrefix);}},{key:"setConnection",value:function setConnection(conn){this.qc.setConnection(conn);}},{key:"setCustomerOnlyConnection",value:function setCustomerOnlyConnection(conn){this.qc.setCustomerOnlyConnection(conn);}},{key:"setApex",value:function setApex(apex){this.qc.setApex(apex);}},{key:"newApex",value:function newApex(conn){return this.qc.newApex(conn);}},{key:"setOrgId",value:function setOrgId(orgId){this.qc.orgId=orgId;}},{key:"onCalc",value:function onCalc(){var self=this;return this.qc.calculate().then(function(success){if(self.notifierManager){self.notifierManager.recordCurrentValues(self.qc.quote);}postProcessQuote(self.qc.quote);return self.qc.quote._unproxiedModel;},function(err){postProcessQuote(self.qc.quote);throw err;});}},{key:"onLoad",value:function onLoad(){var self=this;return this.qc.secureFields().then(function(success){if(self.notifierManager){self.notifierManager.recordCurrentValues(self.qc.quote);}postProcessQuote(self.qc.quote);return self.qc.quote._unproxiedModel;},function(err){postProcessQuote(self.qc.quote);throw err;});}}]);return JSQC;}();function postProcessQuote(quote){var settings=quote.settings;var prefix=quote.prefix;var displayedLookupMap=settings.displayedLookupMap;var nameFieldsByObjectType=settings.nameFieldsByObjectType;var quoteLookups=settings.quoteLookups;var displayedQuoteLookups=displayedLookupMap.quote;processLookups([quote.record],quoteLookups,displayedQuoteLookups);var groupLookups=settings.groupLookups;var displayedGroupLookups=displayedLookupMap.group;var groupRecords=[];quote.groups.forEach(function(group){group.record[prefix+'Quote__r']=null;groupRecords.push(group.record);});processLookups(groupRecords,groupLookups,displayedGroupLookups);var lineLookups=settings.allLineLookups;var displayedLineLookups=displayedLookupMap.line;var lineRecords=[];quote.lineItems.forEach(function(line){line.Group__r=null;line.Quote__r=null;line.RequiredBy__r=null;line.Product__r=null;line.ProductOption__r=null;lineRecords.push(line.record);});processLookups(lineRecords,lineLookups,displayedLineLookups);function processLookups(records,lookups,displayedLookups){var nameField;for(var key in lookups){var relationshipName=key.substring(0,key.length-1)+'r';var relationshipIsDisplayed=displayedLookups&&displayedLookups.indexOf(relationshipName)!=-1;var objectType=lookups[key];nameField=nameFieldsByObjectType[objectType];var lookupProcessingMethod=relationshipIsDisplayed?minimizeDisplayedLookup:stripUndisplayedLookup;records.forEach(function(record){lookupProcessingMethod(record,relationshipName);});}function minimizeDisplayedLookup(record,relationship){var lookupRecord=record[relationship];if(lookupRecord){var minimizedLookup={'Id':lookupRecord['Id']};minimizedLookup[nameField]=lookupRecord[nameField];record[relationship]=minimizedLookup;}else{record[relationship]=null;}}function stripUndisplayedLookup(record,relationship){record[relationship]=null;}}}function evaluate(operator,operand1,operand2){return require("./Utils/OperatorsUtils.js").getInstance(operator).evaluate(operand1,operand2);}if(typeof window!=='undefined'&&window){window.SB=window.SB||{};window.SB.JSQC=JSQC;window.SB.JSQCPrecacher=JSQCPrecacher;window.SB.evaluate=evaluate;window.SB.QuoteDAO=QuoteDAO;window.SB.QuoteOpportunitySynchronizer=QuoteOpportunitySynchronizer;window.SB.LineCalculator=LineCalculator;window.SB.ajax=require("./Utils/ApexUtils.js");window.SB.monthsBetween=DateUtils.monthsBetween;window.SB.daysBetween=DateUtils.daysBetween;window.SB.daysBetweenIgnoringLeapYearDays=DateUtils.daysBetweenIgnoringLeapYearDays;window.SB.monthsBetweenRoundPartialUp=DateUtils.monthsBetweenRoundPartialUp;window.SB.addMonths=DateUtils.addMonths;window.SB.setScale=NumberUtils.setScale;}else{module.exports=JSQC;}},{"../Utils/DateUtils.js":1,"../Utils/NumberUtils.js":2,"./DAO/QuoteDAO.js":4,"./JSQCPrecacher.js":9,"./LineCalculator.js":10,"./ModelNotifierManager.js":13,"./QuoteCalculator.js":16,"./QuoteModel2.js":22,"./QuoteOpportunitySynchronizer.js":23,"./SettingsModel.js":27,"./Utils/ApexUtils.js":30,"./Utils/ModelUtils.js":34,"./Utils/OperatorsUtils.js":36}],42:[function(require,module,exports){var JSQC=require("./jsqc.js");var QuoteDAO=require('./DAO/QuoteDAO.js');var QuoteChangesProcessor=require('./QuoteChangesProcessor.js');var QuoteOpportunitySynchronizer=require('./QuoteOpportunitySynchronizer.js');var logger=require("js-logger").logger.getLogger();var Main=function(){function Main(connection,customerOnlyConnection,prefix){_classCallCheck2(this,Main);this.conn=connection;this.customerOnlyConn=customerOnlyConnection;this.prefix=prefix;}_createClass(Main,[{key:"updateJobStatus",value:function updateJobStatus(recordId,jobType,jobStatus,jobDetails,stacktrace){var baseUrl='/ServiceRouter';if(this.prefix)baseUrl='/'+this.prefix+baseUrl;if(this.conn.oik)baseUrl+='?oik='+this.conn.oik;var details=typeof jobDetails==='string'?jobDetails:jobDetails?jobDetails.toString():'';var context={saver:"JobCheckerServiceProvider.SetJobStatus",model:JSON.stringify({recordId:recordId,jobType:jobType,jobStatus:jobStatus,jobDetails:details,stacktrace:stacktrace})};console.log('Processing '+jobType+' - '+jobStatus);return this.conn.apex.post(baseUrl,context).then(function(result){return Promise.resolve(result);},function(err){throw'Failed to update status at '+baseUrl+': '+(err.message||err);});}},{key:"calcAndSave",value:function calcAndSave(quoteId,quoteChanges,settings,orgId){var quoteDAO=new QuoteDAO(this.prefix,this.conn,settings);var editorModel;var self=this;var changesProcessor;return quoteDAO.loadQuote(quoteId).then(function(model){editorModel=model;if(quoteChanges){changesProcessor=new QuoteChangesProcessor(editorModel.settings,self.conn,self.prefix);return changesProcessor.process(model.quote,quoteChanges);}return Promise.resolve();}).then(function(){if(changesProcessor&&!changesProcessor.needsRecalc){return Promise.resolve(editorModel.quote);}console.log('Processing - calculate');var calculator=new JSQC(editorModel.settings,editorModel.quote);calculator.setOrgId(orgId);calculator.setConnection(self.conn);calculator.setApex(calculator.newApex?calculator.newApex(self.conn):self.conn.apex);if(calculator.setCustomerOnlyConnection){calculator.setCustomerOnlyConnection(self.customerOnlyConn);}return calculator.onCalc().then(function(calculatedQuote){var quote=fixCircularDependencies(calculatedQuote,'^record$|__r$');return Promise.resolve(quote);});}).then(function(quote){console.log('Processing - saving quote');return quoteDAO.saveQuote(quote);}).then(function(quote){if(changesProcessor&&!changesProcessor.needsRecalc&&!changesProcessor.isNewlyPrimary){return Promise.resolve();}console.log('Processing - synchronize opportunity');return new QuoteOpportunitySynchronizer(editorModel.settings,self.conn,self.prefix).updateOpportunityProducts(quote);}).then(function(){console.log('Processing - complete');return Promise.resolve('Completed');});}}]);return Main;}();function fixCircularDependencies(obj,keep){var cache=[];return JSON.parse(JSON.stringify(obj,function(key,value){if((typeof value==="undefined"?"undefined":_typeof(value))==='object'&&value!==null){if(cache.indexOf(value)!==-1){if(keep&&new RegExp(keep).test(key))return value;return;}cache.push(value);}return value;}));}module.exports=Main;},{"./DAO/QuoteDAO.js":4,"./QuoteChangesProcessor.js":17,"./QuoteOpportunitySynchronizer.js":23,"./jsqc.js":41,"js-logger":96}],43:[function(require,module,exports){'use strict';exports.path=require('path').dirname(require.main.filename);exports.resolve=function(pathToModule){return exports.path+pathToModule;};exports.require=function(pathToModule){var r='function'===typeof __webpack_require__?__non_webpack_require__:require;return r(exports.resolve(pathToModule));};exports.toString=function(){return exports.path;};exports.setPath=function(explicitlySetPath){exports.path=explicitlySetPath;};},{"path":168}],44:[function(require,module,exports){"use strict";var rawAsap=require("./raw");var freeTasks=[];var pendingErrors=[];var requestErrorThrow=rawAsap.makeRequestCallFromTimer(throwFirstError);function throwFirstError(){if(pendingErrors.length){throw pendingErrors.shift();}}module.exports=asap;function asap(task){var rawTask;if(freeTasks.length){rawTask=freeTasks.pop();}else{rawTask=new RawTask();}rawTask.task=task;rawAsap(rawTask);}function RawTask(){this.task=null;}RawTask.prototype.call=function(){try{this.task.call();}catch(error){if(asap.onerror){asap.onerror(error);}else{pendingErrors.push(error);requestErrorThrow();}}finally{this.task=null;freeTasks[freeTasks.length]=this;}};},{"./raw":45}],45:[function(require,module,exports){(function(global){"use strict";module.exports=rawAsap;function rawAsap(task){if(!queue.length){requestFlush();flushing=true;}queue[queue.length]=task;}var queue=[];var flushing=false;var requestFlush;var index=0;var capacity=1024;function flush(){while(index<queue.length){var currentIndex=index;index=index+1;queue[currentIndex].call();if(index>capacity){for(var scan=0,newLength=queue.length-index;scan<newLength;scan++){queue[scan]=queue[scan+index];}queue.length-=index;index=0;}}queue.length=0;index=0;flushing=false;}var scope=typeof global!=="undefined"?global:self;var BrowserMutationObserver=scope.MutationObserver||scope.WebKitMutationObserver;if(typeof BrowserMutationObserver==="function"){requestFlush=makeRequestCallFromMutationObserver(flush);}else{requestFlush=makeRequestCallFromTimer(flush);}rawAsap.requestFlush=requestFlush;function makeRequestCallFromMutationObserver(callback){var toggle=1;var observer=new BrowserMutationObserver(callback);var node=document.createTextNode("");observer.observe(node,{characterData:true});return function requestCall(){toggle=-toggle;node.data=toggle;};}function makeRequestCallFromTimer(callback){return function requestCall(){var timeoutHandle=setTimeout(handleTimer,0);var intervalHandle=setInterval(handleTimer,50);function handleTimer(){clearTimeout(timeoutHandle);clearInterval(intervalHandle);callback();}};}rawAsap.makeRequestCallFromTimer=makeRequestCallFromTimer;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],46:[function(require,module,exports){'use strict';exports.byteLength=byteLength;exports.toByteArray=toByteArray;exports.fromByteArray=fromByteArray;var lookup=[];var revLookup=[];var Arr=typeof Uint8Array!=='undefined'?Uint8Array:Array;var code='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';for(var i=0,len=code.length;i<len;++i){lookup[i]=code[i];revLookup[code.charCodeAt(i)]=i;}revLookup['-'.charCodeAt(0)]=62;revLookup['_'.charCodeAt(0)]=63;function getLens(b64){var len=b64.length;if(len%4>0){throw new Error('Invalid string. Length must be a multiple of 4');}var validLen=b64.indexOf('=');if(validLen===-1)validLen=len;var placeHoldersLen=validLen===len?0:4-validLen%4;return[validLen,placeHoldersLen];}function byteLength(b64){var lens=getLens(b64);var validLen=lens[0];var placeHoldersLen=lens[1];return(validLen+placeHoldersLen)*3/4-placeHoldersLen;}function _byteLength(b64,validLen,placeHoldersLen){return(validLen+placeHoldersLen)*3/4-placeHoldersLen;}function toByteArray(b64){var tmp;var lens=getLens(b64);var validLen=lens[0];var placeHoldersLen=lens[1];var arr=new Arr(_byteLength(b64,validLen,placeHoldersLen));var curByte=0;var len=placeHoldersLen>0?validLen-4:validLen;for(var i=0;i<len;i+=4){tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)];arr[curByte++]=tmp>>16&0xFF;arr[curByte++]=tmp>>8&0xFF;arr[curByte++]=tmp&0xFF;}if(placeHoldersLen===2){tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4;arr[curByte++]=tmp&0xFF;}if(placeHoldersLen===1){tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2;arr[curByte++]=tmp>>8&0xFF;arr[curByte++]=tmp&0xFF;}return arr;}function tripletToBase64(num){return lookup[num>>18&0x3F]+lookup[num>>12&0x3F]+lookup[num>>6&0x3F]+lookup[num&0x3F];}function encodeChunk(uint8,start,end){var tmp;var output=[];for(var i=start;i<end;i+=3){tmp=(uint8[i]<<16&0xFF0000)+(uint8[i+1]<<8&0xFF00)+(uint8[i+2]&0xFF);output.push(tripletToBase64(tmp));}return output.join('');}function fromByteArray(uint8){var tmp;var len=uint8.length;var extraBytes=len%3;var parts=[];var maxChunkLength=16383;for(var i=0,len2=len-extraBytes;i<len2;i+=maxChunkLength){parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength));}if(extraBytes===1){tmp=uint8[len-1];parts.push(lookup[tmp>>2]+lookup[tmp<<4&0x3F]+'==');}else if(extraBytes===2){tmp=(uint8[len-2]<<8)+uint8[len-1];parts.push(lookup[tmp>>10]+lookup[tmp>>4&0x3F]+lookup[tmp<<2&0x3F]+'=');}return parts.join('');}},{}],47:[function(require,module,exports){},{}],48:[function(require,module,exports){arguments[4][47][0].apply(exports,arguments);},{"dup":47}],49:[function(require,module,exports){(function(global,Buffer){/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */'use strict';var base64=require('base64-js');var ieee754=require('ieee754');var isArray=require('isarray');exports.Buffer=Buffer;exports.SlowBuffer=SlowBuffer;exports.INSPECT_MAX_BYTES=50;Buffer.TYPED_ARRAY_SUPPORT=global.TYPED_ARRAY_SUPPORT!==undefined?global.TYPED_ARRAY_SUPPORT:typedArraySupport();exports.kMaxLength=kMaxLength();function typedArraySupport(){try{var arr=new Uint8Array(1);arr.__proto__={__proto__:Uint8Array.prototype,foo:function foo(){return 42;}};return arr.foo()===42&&typeof arr.subarray==='function'&&arr.subarray(1,1).byteLength===0;}catch(e){return false;}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?0x7fffffff:0x3fffffff;}function createBuffer(that,length){if(kMaxLength()<length){throw new RangeError('Invalid typed array length');}if(Buffer.TYPED_ARRAY_SUPPORT){that=new Uint8Array(length);that.__proto__=Buffer.prototype;}else{if(that===null){that=new Buffer(length);}that.length=length;}return that;}function Buffer(arg,encodingOrOffset,length){if(!Buffer.TYPED_ARRAY_SUPPORT&&!(this instanceof Buffer)){return new Buffer(arg,encodingOrOffset,length);}if(typeof arg==='number'){if(typeof encodingOrOffset==='string'){throw new Error('If encoding is specified then the first argument must be a string');}return allocUnsafe(this,arg);}return from(this,arg,encodingOrOffset,length);}Buffer.poolSize=8192;Buffer._augment=function(arr){arr.__proto__=Buffer.prototype;return arr;};function from(that,value,encodingOrOffset,length){if(typeof value==='number'){throw new TypeError('"value" argument must not be a number');}if(typeof ArrayBuffer!=='undefined'&&value instanceof ArrayBuffer){return fromArrayBuffer(that,value,encodingOrOffset,length);}if(typeof value==='string'){return fromString(that,value,encodingOrOffset);}return fromObject(that,value);}Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length);};if(Buffer.TYPED_ARRAY_SUPPORT){Buffer.prototype.__proto__=Uint8Array.prototype;Buffer.__proto__=Uint8Array;if(typeof Symbol!=='undefined'&&Symbol.species&&Buffer[Symbol.species]===Buffer){Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:true});}}function assertSize(size){if(typeof size!=='number'){throw new TypeError('"size" argument must be a number');}else if(size<0){throw new RangeError('"size" argument must not be negative');}}function alloc(that,size,fill,encoding){assertSize(size);if(size<=0){return createBuffer(that,size);}if(fill!==undefined){return typeof encoding==='string'?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill);}return createBuffer(that,size);}Buffer.alloc=function(size,fill,encoding){return alloc(null,size,fill,encoding);};function allocUnsafe(that,size){assertSize(size);that=createBuffer(that,size<0?0:checked(size)|0);if(!Buffer.TYPED_ARRAY_SUPPORT){for(var i=0;i<size;++i){that[i]=0;}}return that;}Buffer.allocUnsafe=function(size){return allocUnsafe(null,size);};Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size);};function fromString(that,string,encoding){if(typeof encoding!=='string'||encoding===''){encoding='utf8';}if(!Buffer.isEncoding(encoding)){throw new TypeError('"encoding" must be a valid string encoding');}var length=byteLength(string,encoding)|0;that=createBuffer(that,length);var actual=that.write(string,encoding);if(actual!==length){that=that.slice(0,actual);}return that;}function fromArrayLike(that,array){var length=array.length<0?0:checked(array.length)|0;that=createBuffer(that,length);for(var i=0;i<length;i+=1){that[i]=array[i]&255;}return that;}function fromArrayBuffer(that,array,byteOffset,length){array.byteLength;if(byteOffset<0||array.byteLength<byteOffset){throw new RangeError('\'offset\' is out of bounds');}if(array.byteLength<byteOffset+(length||0)){throw new RangeError('\'length\' is out of bounds');}if(byteOffset===undefined&&length===undefined){array=new Uint8Array(array);}else if(length===undefined){array=new Uint8Array(array,byteOffset);}else{array=new Uint8Array(array,byteOffset,length);}if(Buffer.TYPED_ARRAY_SUPPORT){that=array;that.__proto__=Buffer.prototype;}else{that=fromArrayLike(that,array);}return that;}function fromObject(that,obj){if(Buffer.isBuffer(obj)){var len=checked(obj.length)|0;that=createBuffer(that,len);if(that.length===0){return that;}obj.copy(that,0,0,len);return that;}if(obj){if(typeof ArrayBuffer!=='undefined'&&obj.buffer instanceof ArrayBuffer||'length'in obj){if(typeof obj.length!=='number'||isnan(obj.length)){return createBuffer(that,0);}return fromArrayLike(that,obj);}if(obj.type==='Buffer'&&isArray(obj.data)){return fromArrayLike(that,obj.data);}}throw new TypeError('First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.');}function checked(length){if(length>=kMaxLength()){throw new RangeError('Attempt to allocate Buffer larger than maximum '+'size: 0x'+kMaxLength().toString(16)+' bytes');}return length|0;}function SlowBuffer(length){if(+length!=length){length=0;}return Buffer.alloc(+length);}Buffer.isBuffer=function isBuffer(b){return!!(b!=null&&b._isBuffer);};Buffer.compare=function compare(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b)){throw new TypeError('Arguments must be Buffers');}if(a===b)return 0;var x=a.length;var y=b.length;for(var i=0,len=Math.min(x,y);i<len;++i){if(a[i]!==b[i]){x=a[i];y=b[i];break;}}if(x<y)return-1;if(y<x)return 1;return 0;};Buffer.isEncoding=function isEncoding(encoding){switch(String(encoding).toLowerCase()){case'hex':case'utf8':case'utf-8':case'ascii':case'latin1':case'binary':case'base64':case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return true;default:return false;}};Buffer.concat=function concat(list,length){if(!isArray(list)){throw new TypeError('"list" argument must be an Array of Buffers');}if(list.length===0){return Buffer.alloc(0);}var i;if(length===undefined){length=0;for(i=0;i<list.length;++i){length+=list[i].length;}}var buffer=Buffer.allocUnsafe(length);var pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(!Buffer.isBuffer(buf)){throw new TypeError('"list" argument must be an Array of Buffers');}buf.copy(buffer,pos);pos+=buf.length;}return buffer;};function byteLength(string,encoding){if(Buffer.isBuffer(string)){return string.length;}if(typeof ArrayBuffer!=='undefined'&&typeof ArrayBuffer.isView==='function'&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer)){return string.byteLength;}if(typeof string!=='string'){string=''+string;}var len=string.length;if(len===0)return 0;var loweredCase=false;for(;;){switch(encoding){case'ascii':case'latin1':case'binary':return len;case'utf8':case'utf-8':case undefined:return utf8ToBytes(string).length;case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return len*2;case'hex':return len>>>1;case'base64':return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(''+encoding).toLowerCase();loweredCase=true;}}}Buffer.byteLength=byteLength;function slowToString(encoding,start,end){var loweredCase=false;if(start===undefined||start<0){start=0;}if(start>this.length){return'';}if(end===undefined||end>this.length){end=this.length;}if(end<=0){return'';}end>>>=0;start>>>=0;if(end<=start){return'';}if(!encoding)encoding='utf8';while(true){switch(encoding){case'hex':return hexSlice(this,start,end);case'utf8':case'utf-8':return utf8Slice(this,start,end);case'ascii':return asciiSlice(this,start,end);case'latin1':case'binary':return latin1Slice(this,start,end);case'base64':return base64Slice(this,start,end);case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError('Unknown encoding: '+encoding);encoding=(encoding+'').toLowerCase();loweredCase=true;}}}Buffer.prototype._isBuffer=true;function swap(b,n,m){var i=b[n];b[n]=b[m];b[m]=i;}Buffer.prototype.swap16=function swap16(){var len=this.length;if(len%2!==0){throw new RangeError('Buffer size must be a multiple of 16-bits');}for(var i=0;i<len;i+=2){swap(this,i,i+1);}return this;};Buffer.prototype.swap32=function swap32(){var len=this.length;if(len%4!==0){throw new RangeError('Buffer size must be a multiple of 32-bits');}for(var i=0;i<len;i+=4){swap(this,i,i+3);swap(this,i+1,i+2);}return this;};Buffer.prototype.swap64=function swap64(){var len=this.length;if(len%8!==0){throw new RangeError('Buffer size must be a multiple of 64-bits');}for(var i=0;i<len;i+=8){swap(this,i,i+7);swap(this,i+1,i+6);swap(this,i+2,i+5);swap(this,i+3,i+4);}return this;};Buffer.prototype.toString=function toString(){var length=this.length|0;if(length===0)return'';if(arguments.length===0)return utf8Slice(this,0,length);return slowToString.apply(this,arguments);};Buffer.prototype.equals=function equals(b){if(!Buffer.isBuffer(b))throw new TypeError('Argument must be a Buffer');if(this===b)return true;return Buffer.compare(this,b)===0;};Buffer.prototype.inspect=function inspect(){var str='';var max=exports.INSPECT_MAX_BYTES;if(this.length>0){str=this.toString('hex',0,max).match(/.{2}/g).join(' ');if(this.length>max)str+=' ... ';}return'<Buffer '+str+'>';};Buffer.prototype.compare=function compare(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target)){throw new TypeError('Argument must be a Buffer');}if(start===undefined){start=0;}if(end===undefined){end=target?target.length:0;}if(thisStart===undefined){thisStart=0;}if(thisEnd===undefined){thisEnd=this.length;}if(start<0||end>target.length||thisStart<0||thisEnd>this.length){throw new RangeError('out of range index');}if(thisStart>=thisEnd&&start>=end){return 0;}if(thisStart>=thisEnd){return-1;}if(start>=end){return 1;}start>>>=0;end>>>=0;thisStart>>>=0;thisEnd>>>=0;if(this===target)return 0;var x=thisEnd-thisStart;var y=end-start;var len=Math.min(x,y);var thisCopy=this.slice(thisStart,thisEnd);var targetCopy=target.slice(start,end);for(var i=0;i<len;++i){if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i];y=targetCopy[i];break;}}if(x<y)return-1;if(y<x)return 1;return 0;};function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(buffer.length===0)return-1;if(typeof byteOffset==='string'){encoding=byteOffset;byteOffset=0;}else if(byteOffset>0x7fffffff){byteOffset=0x7fffffff;}else if(byteOffset<-0x80000000){byteOffset=-0x80000000;}byteOffset=+byteOffset;if(isNaN(byteOffset)){byteOffset=dir?0:buffer.length-1;}if(byteOffset<0)byteOffset=buffer.length+byteOffset;if(byteOffset>=buffer.length){if(dir)return-1;else byteOffset=buffer.length-1;}else if(byteOffset<0){if(dir)byteOffset=0;else return-1;}if(typeof val==='string'){val=Buffer.from(val,encoding);}if(Buffer.isBuffer(val)){if(val.length===0){return-1;}return arrayIndexOf(buffer,val,byteOffset,encoding,dir);}else if(typeof val==='number'){val=val&0xFF;if(Buffer.TYPED_ARRAY_SUPPORT&&typeof Uint8Array.prototype.indexOf==='function'){if(dir){return Uint8Array.prototype.indexOf.call(buffer,val,byteOffset);}else{return Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset);}}return arrayIndexOf(buffer,[val],byteOffset,encoding,dir);}throw new TypeError('val must be string, number or Buffer');}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var indexSize=1;var arrLength=arr.length;var valLength=val.length;if(encoding!==undefined){encoding=String(encoding).toLowerCase();if(encoding==='ucs2'||encoding==='ucs-2'||encoding==='utf16le'||encoding==='utf-16le'){if(arr.length<2||val.length<2){return-1;}indexSize=2;arrLength/=2;valLength/=2;byteOffset/=2;}}function read(buf,i){if(indexSize===1){return buf[i];}else{return buf.readUInt16BE(i*indexSize);}}var i;if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++){if(read(arr,i)===read(val,foundIndex===-1?0:i-foundIndex)){if(foundIndex===-1)foundIndex=i;if(i-foundIndex+1===valLength)return foundIndex*indexSize;}else{if(foundIndex!==-1)i-=i-foundIndex;foundIndex=-1;}}}else{if(byteOffset+valLength>arrLength)byteOffset=arrLength-valLength;for(i=byteOffset;i>=0;i--){var found=true;for(var j=0;j<valLength;j++){if(read(arr,i+j)!==read(val,j)){found=false;break;}}if(found)return i;}}return-1;}Buffer.prototype.includes=function includes(val,byteOffset,encoding){return this.indexOf(val,byteOffset,encoding)!==-1;};Buffer.prototype.indexOf=function indexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,true);};Buffer.prototype.lastIndexOf=function lastIndexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,false);};function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining;}else{length=Number(length);if(length>remaining){length=remaining;}}var strLen=string.length;if(strLen%2!==0)throw new TypeError('Invalid hex string');if(length>strLen/2){length=strLen/2;}for(var i=0;i<length;++i){var parsed=parseInt(string.substr(i*2,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed;}return i;}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length);}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length);}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length);}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length);}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length);}Buffer.prototype.write=function write(string,offset,length,encoding){if(offset===undefined){encoding='utf8';length=this.length;offset=0;}else if(length===undefined&&typeof offset==='string'){encoding=offset;length=this.length;offset=0;}else if(isFinite(offset)){offset=offset|0;if(isFinite(length)){length=length|0;if(encoding===undefined)encoding='utf8';}else{encoding=length;length=undefined;}}else{throw new Error('Buffer.write(string, encoding, offset[, length]) is no longer supported');}var remaining=this.length-offset;if(length===undefined||length>remaining)length=remaining;if(string.length>0&&(length<0||offset<0)||offset>this.length){throw new RangeError('Attempt to write outside buffer bounds');}if(!encoding)encoding='utf8';var loweredCase=false;for(;;){switch(encoding){case'hex':return hexWrite(this,string,offset,length);case'utf8':case'utf-8':return utf8Write(this,string,offset,length);case'ascii':return asciiWrite(this,string,offset,length);case'latin1':case'binary':return latin1Write(this,string,offset,length);case'base64':return base64Write(this,string,offset,length);case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError('Unknown encoding: '+encoding);encoding=(''+encoding).toLowerCase();loweredCase=true;}}};Buffer.prototype.toJSON=function toJSON(){return{type:'Buffer',data:Array.prototype.slice.call(this._arr||this,0)};};function base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf);}else{return base64.fromByteArray(buf.slice(start,end));}}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);var res=[];var i=start;while(i<end){var firstByte=buf[i];var codePoint=null;var bytesPerSequence=firstByte>0xEF?4:firstByte>0xDF?3:firstByte>0xBF?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:if(firstByte<0x80){codePoint=firstByte;}break;case 2:secondByte=buf[i+1];if((secondByte&0xC0)===0x80){tempCodePoint=(firstByte&0x1F)<<0x6|secondByte&0x3F;if(tempCodePoint>0x7F){codePoint=tempCodePoint;}}break;case 3:secondByte=buf[i+1];thirdByte=buf[i+2];if((secondByte&0xC0)===0x80&&(thirdByte&0xC0)===0x80){tempCodePoint=(firstByte&0xF)<<0xC|(secondByte&0x3F)<<0x6|thirdByte&0x3F;if(tempCodePoint>0x7FF&&(tempCodePoint<0xD800||tempCodePoint>0xDFFF)){codePoint=tempCodePoint;}}break;case 4:secondByte=buf[i+1];thirdByte=buf[i+2];fourthByte=buf[i+3];if((secondByte&0xC0)===0x80&&(thirdByte&0xC0)===0x80&&(fourthByte&0xC0)===0x80){tempCodePoint=(firstByte&0xF)<<0x12|(secondByte&0x3F)<<0xC|(thirdByte&0x3F)<<0x6|fourthByte&0x3F;if(tempCodePoint>0xFFFF&&tempCodePoint<0x110000){codePoint=tempCodePoint;}}}}if(codePoint===null){codePoint=0xFFFD;bytesPerSequence=1;}else if(codePoint>0xFFFF){codePoint-=0x10000;res.push(codePoint>>>10&0x3FF|0xD800);codePoint=0xDC00|codePoint&0x3FF;}res.push(codePoint);i+=bytesPerSequence;}return decodeCodePointsArray(res);}var MAX_ARGUMENTS_LENGTH=0x1000;function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH){return String.fromCharCode.apply(String,codePoints);}var res='';var i=0;while(i<len){res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));}return res;}function asciiSlice(buf,start,end){var ret='';end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i]&0x7F);}return ret;}function latin1Slice(buf,start,end){var ret='';end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i]);}return ret;}function hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out='';for(var i=start;i<end;++i){out+=toHex(buf[i]);}return out;}function utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res='';for(var i=0;i<bytes.length;i+=2){res+=String.fromCharCode(bytes[i]+bytes[i+1]*256);}return res;}Buffer.prototype.slice=function slice(start,end){var len=this.length;start=~~start;end=end===undefined?len:~~end;if(start<0){start+=len;if(start<0)start=0;}else if(start>len){start=len;}if(end<0){end+=len;if(end<0)end=0;}else if(end>len){end=len;}if(end<start)end=start;var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT){newBuf=this.subarray(start,end);newBuf.__proto__=Buffer.prototype;}else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,undefined);for(var i=0;i<sliceLen;++i){newBuf[i]=this[i+start];}}return newBuf;};function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError('offset is not uint');if(offset+ext>length)throw new RangeError('Trying to access beyond buffer length');}Buffer.prototype.readUIntLE=function readUIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=0x100)){val+=this[offset+i]*mul;}return val;};Buffer.prototype.readUIntBE=function readUIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert){checkOffset(offset,byteLength,this.length);}var val=this[offset+--byteLength];var mul=1;while(byteLength>0&&(mul*=0x100)){val+=this[offset+--byteLength]*mul;}return val;};Buffer.prototype.readUInt8=function readUInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);return this[offset];};Buffer.prototype.readUInt16LE=function readUInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]|this[offset+1]<<8;};Buffer.prototype.readUInt16BE=function readUInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]<<8|this[offset+1];};Buffer.prototype.readUInt32LE=function readUInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+this[offset+3]*0x1000000;};Buffer.prototype.readUInt32BE=function readUInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]*0x1000000+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3]);};Buffer.prototype.readIntLE=function readIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=0x100)){val+=this[offset+i]*mul;}mul*=0x80;if(val>=mul)val-=Math.pow(2,8*byteLength);return val;};Buffer.prototype.readIntBE=function readIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var i=byteLength;var mul=1;var val=this[offset+--i];while(i>0&&(mul*=0x100)){val+=this[offset+--i]*mul;}mul*=0x80;if(val>=mul)val-=Math.pow(2,8*byteLength);return val;};Buffer.prototype.readInt8=function readInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);if(!(this[offset]&0x80))return this[offset];return(0xff-this[offset]+1)*-1;};Buffer.prototype.readInt16LE=function readInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return val&0x8000?val|0xFFFF0000:val;};Buffer.prototype.readInt16BE=function readInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return val&0x8000?val|0xFFFF0000:val;};Buffer.prototype.readInt32LE=function readInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24;};Buffer.prototype.readInt32BE=function readInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3];};Buffer.prototype.readFloatLE=function readFloatLE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,true,23,4);};Buffer.prototype.readFloatBE=function readFloatBE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,false,23,4);};Buffer.prototype.readDoubleLE=function readDoubleLE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,true,52,8);};Buffer.prototype.readDoubleBE=function readDoubleBE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,false,52,8);};function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError('Index out of range');}Buffer.prototype.writeUIntLE=function writeUIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0);}var mul=1;var i=0;this[offset]=value&0xFF;while(++i<byteLength&&(mul*=0x100)){this[offset+i]=value/mul&0xFF;}return offset+byteLength;};Buffer.prototype.writeUIntBE=function writeUIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0);}var i=byteLength-1;var mul=1;this[offset+i]=value&0xFF;while(--i>=0&&(mul*=0x100)){this[offset+i]=value/mul&0xFF;}return offset+byteLength;};Buffer.prototype.writeUInt8=function writeUInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,0xff,0);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);this[offset]=value&0xff;return offset+1;};function objectWriteUInt16(buf,value,offset,littleEndian){if(value<0)value=0xffff+value+1;for(var i=0,j=Math.min(buf.length-offset,2);i<j;++i){buf[offset+i]=(value&0xff<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8;}}Buffer.prototype.writeUInt16LE=function writeUInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,0xffff,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&0xff;this[offset+1]=value>>>8;}else{objectWriteUInt16(this,value,offset,true);}return offset+2;};Buffer.prototype.writeUInt16BE=function writeUInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,0xffff,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&0xff;}else{objectWriteUInt16(this,value,offset,false);}return offset+2;};function objectWriteUInt32(buf,value,offset,littleEndian){if(value<0)value=0xffffffff+value+1;for(var i=0,j=Math.min(buf.length-offset,4);i<j;++i){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&0xff;}}Buffer.prototype.writeUInt32LE=function writeUInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,0xffffffff,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset+3]=value>>>24;this[offset+2]=value>>>16;this[offset+1]=value>>>8;this[offset]=value&0xff;}else{objectWriteUInt32(this,value,offset,true);}return offset+4;};Buffer.prototype.writeUInt32BE=function writeUInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,0xffffffff,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&0xff;}else{objectWriteUInt32(this,value,offset,false);}return offset+4;};Buffer.prototype.writeIntLE=function writeIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit);}var i=0;var mul=1;var sub=0;this[offset]=value&0xFF;while(++i<byteLength&&(mul*=0x100)){if(value<0&&sub===0&&this[offset+i-1]!==0){sub=1;}this[offset+i]=(value/mul>>0)-sub&0xFF;}return offset+byteLength;};Buffer.prototype.writeIntBE=function writeIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit);}var i=byteLength-1;var mul=1;var sub=0;this[offset+i]=value&0xFF;while(--i>=0&&(mul*=0x100)){if(value<0&&sub===0&&this[offset+i+1]!==0){sub=1;}this[offset+i]=(value/mul>>0)-sub&0xFF;}return offset+byteLength;};Buffer.prototype.writeInt8=function writeInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,0x7f,-0x80);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);if(value<0)value=0xff+value+1;this[offset]=value&0xff;return offset+1;};Buffer.prototype.writeInt16LE=function writeInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,0x7fff,-0x8000);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&0xff;this[offset+1]=value>>>8;}else{objectWriteUInt16(this,value,offset,true);}return offset+2;};Buffer.prototype.writeInt16BE=function writeInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,0x7fff,-0x8000);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&0xff;}else{objectWriteUInt16(this,value,offset,false);}return offset+2;};Buffer.prototype.writeInt32LE=function writeInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,0x7fffffff,-0x80000000);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&0xff;this[offset+1]=value>>>8;this[offset+2]=value>>>16;this[offset+3]=value>>>24;}else{objectWriteUInt32(this,value,offset,true);}return offset+4;};Buffer.prototype.writeInt32BE=function writeInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,0x7fffffff,-0x80000000);if(value<0)value=0xffffffff+value+1;if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&0xff;}else{objectWriteUInt32(this,value,offset,false);}return offset+4;};function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError('Index out of range');if(offset<0)throw new RangeError('Index out of range');}function writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,4,3.4028234663852886e+38,-3.4028234663852886e+38);}ieee754.write(buf,value,offset,littleEndian,23,4);return offset+4;}Buffer.prototype.writeFloatLE=function writeFloatLE(value,offset,noAssert){return writeFloat(this,value,offset,true,noAssert);};Buffer.prototype.writeFloatBE=function writeFloatBE(value,offset,noAssert){return writeFloat(this,value,offset,false,noAssert);};function writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,8,1.7976931348623157E+308,-1.7976931348623157E+308);}ieee754.write(buf,value,offset,littleEndian,52,8);return offset+8;}Buffer.prototype.writeDoubleLE=function writeDoubleLE(value,offset,noAssert){return writeDouble(this,value,offset,true,noAssert);};Buffer.prototype.writeDoubleBE=function writeDoubleBE(value,offset,noAssert){return writeDouble(this,value,offset,false,noAssert);};Buffer.prototype.copy=function copy(target,targetStart,start,end){if(!start)start=0;if(!end&&end!==0)end=this.length;if(targetStart>=target.length)targetStart=target.length;if(!targetStart)targetStart=0;if(end>0&&end<start)end=start;if(end===start)return 0;if(target.length===0||this.length===0)return 0;if(targetStart<0){throw new RangeError('targetStart out of bounds');}if(start<0||start>=this.length)throw new RangeError('sourceStart out of bounds');if(end<0)throw new RangeError('sourceEnd out of bounds');if(end>this.length)end=this.length;if(target.length-targetStart<end-start){end=target.length-targetStart+start;}var len=end-start;var i;if(this===target&&start<targetStart&&targetStart<end){for(i=len-1;i>=0;--i){target[i+targetStart]=this[i+start];}}else if(len<1000||!Buffer.TYPED_ARRAY_SUPPORT){for(i=0;i<len;++i){target[i+targetStart]=this[i+start];}}else{Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart);}return len;};Buffer.prototype.fill=function fill(val,start,end,encoding){if(typeof val==='string'){if(typeof start==='string'){encoding=start;start=0;end=this.length;}else if(typeof end==='string'){encoding=end;end=this.length;}if(val.length===1){var code=val.charCodeAt(0);if(code<256){val=code;}}if(encoding!==undefined&&typeof encoding!=='string'){throw new TypeError('encoding must be a string');}if(typeof encoding==='string'&&!Buffer.isEncoding(encoding)){throw new TypeError('Unknown encoding: '+encoding);}}else if(typeof val==='number'){val=val&255;}if(start<0||this.length<start||this.length<end){throw new RangeError('Out of range index');}if(end<=start){return this;}start=start>>>0;end=end===undefined?this.length:end>>>0;if(!val)val=0;var i;if(typeof val==='number'){for(i=start;i<end;++i){this[i]=val;}}else{var bytes=Buffer.isBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString());var len=bytes.length;for(i=0;i<end-start;++i){this[i+start]=bytes[i%len];}}return this;};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function base64clean(str){str=stringtrim(str).replace(INVALID_BASE64_RE,'');if(str.length<2)return'';while(str.length%4!==0){str=str+'=';}return str;}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,'');}function toHex(n){if(n<16)return'0'+n.toString(16);return n.toString(16);}function utf8ToBytes(string,units){units=units||Infinity;var codePoint;var length=string.length;var leadSurrogate=null;var bytes=[];for(var i=0;i<length;++i){codePoint=string.charCodeAt(i);if(codePoint>0xD7FF&&codePoint<0xE000){if(!leadSurrogate){if(codePoint>0xDBFF){if((units-=3)>-1)bytes.push(0xEF,0xBF,0xBD);continue;}else if(i+1===length){if((units-=3)>-1)bytes.push(0xEF,0xBF,0xBD);continue;}leadSurrogate=codePoint;continue;}if(codePoint<0xDC00){if((units-=3)>-1)bytes.push(0xEF,0xBF,0xBD);leadSurrogate=codePoint;continue;}codePoint=(leadSurrogate-0xD800<<10|codePoint-0xDC00)+0x10000;}else if(leadSurrogate){if((units-=3)>-1)bytes.push(0xEF,0xBF,0xBD);}leadSurrogate=null;if(codePoint<0x80){if((units-=1)<0)break;bytes.push(codePoint);}else if(codePoint<0x800){if((units-=2)<0)break;bytes.push(codePoint>>0x6|0xC0,codePoint&0x3F|0x80);}else if(codePoint<0x10000){if((units-=3)<0)break;bytes.push(codePoint>>0xC|0xE0,codePoint>>0x6&0x3F|0x80,codePoint&0x3F|0x80);}else if(codePoint<0x110000){if((units-=4)<0)break;bytes.push(codePoint>>0x12|0xF0,codePoint>>0xC&0x3F|0x80,codePoint>>0x6&0x3F|0x80,codePoint&0x3F|0x80);}else{throw new Error('Invalid code point');}}return bytes;}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;++i){byteArray.push(str.charCodeAt(i)&0xFF);}return byteArray;}function utf16leToBytes(str,units){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length;++i){if((units-=2)<0)break;c=str.charCodeAt(i);hi=c>>8;lo=c%256;byteArray.push(lo);byteArray.push(hi);}return byteArray;}function base64ToBytes(str){return base64.toByteArray(base64clean(str));}function blitBuffer(src,dst,offset,length){for(var i=0;i<length;++i){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i];}return i;}function isnan(val){return val!==val;}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{},require("buffer").Buffer);},{"base64-js":46,"buffer":49,"ieee754":93,"isarray":50}],50:[function(require,module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return toString.call(arr)=='[object Array]';};},{}],51:[function(require,module,exports){(function(Buffer){function isArray(arg){if(Array.isArray){return Array.isArray(arg);}return objectToString(arg)==='[object Array]';}exports.isArray=isArray;function isBoolean(arg){return typeof arg==='boolean';}exports.isBoolean=isBoolean;function isNull(arg){return arg===null;}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null;}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==='number';}exports.isNumber=isNumber;function isString(arg){return typeof arg==='string';}exports.isString=isString;function isSymbol(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='symbol';}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0;}exports.isUndefined=isUndefined;function isRegExp(re){return objectToString(re)==='[object RegExp]';}exports.isRegExp=isRegExp;function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&arg!==null;}exports.isObject=isObject;function isDate(d){return objectToString(d)==='[object Date]';}exports.isDate=isDate;function isError(e){return objectToString(e)==='[object Error]'||e instanceof Error;}exports.isError=isError;function isFunction(arg){return typeof arg==='function';}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==='boolean'||typeof arg==='number'||typeof arg==='string'||(typeof arg==="undefined"?"undefined":_typeof(arg))==='symbol'||typeof arg==='undefined';}exports.isPrimitive=isPrimitive;exports.isBuffer=Buffer.isBuffer;function objectToString(o){return Object.prototype.toString.call(o);}}).call(this,{"isBuffer":require("../../is-buffer/index.js")});},{"../../is-buffer/index.js":95}],52:[function(require,module,exports){(function(process,Buffer){var Parser,StringDecoder,isObjLiteral,stream,util;stream=require('stream');util=require('util');StringDecoder=require('string_decoder').StringDecoder;module.exports=function(){var callback,called,chunks,data,err,options,parser;if(arguments.length===3){data=arguments[0];options=arguments[1];callback=arguments[2];if(typeof callback!=='function'){throw Error("Invalid callback argument: "+JSON.stringify(callback));}if(!(typeof data==='string'||Buffer.isBuffer(arguments[0]))){return callback(Error("Invalid data argument: "+JSON.stringify(data)));}}else if(arguments.length===2){if(typeof arguments[0]==='string'||Buffer.isBuffer(arguments[0])){data=arguments[0];}else if(isObjLiteral(arguments[0])){options=arguments[0];}else{err="Invalid first argument: "+JSON.stringify(arguments[0]);}if(typeof arguments[1]==='function'){callback=arguments[1];}else if(isObjLiteral(arguments[1])){if(options){err='Invalid arguments: got options twice as first and second arguments';}else{options=arguments[1];}}else{err="Invalid first argument: "+JSON.stringify(arguments[1]);}if(err){if(!callback){throw Error(err);}else{return callback(Error(err));}}}else if(arguments.length===1){if(typeof arguments[0]==='function'){callback=arguments[0];}else{options=arguments[0];}}if(options==null){options={};}parser=new Parser(options);if(data!=null){process.nextTick(function(){parser.write(data);return parser.end();});}if(callback){called=false;chunks=options.objname?{}:[];parser.on('readable',function(){var chunk,results;results=[];while(chunk=parser.read()){if(options.objname){results.push(chunks[chunk[0]]=chunk[1]);}else{results.push(chunks.push(chunk));}}return results;});parser.on('error',function(err){called=true;return callback(err);});parser.on('end',function(){if(!called){return callback(null,chunks);}});}return parser;};Parser=function Parser(options){var base,base1,base10,base11,base12,base13,base14,base15,base16,base2,base3,base4,base5,base6,base7,base8,base9,k,v;if(options==null){options={};}this.options={};for(k in options){v=options[k];this.options[k]=v;}this.options.objectMode=true;stream.Transform.call(this,this.options);if((base=this.options).rowDelimiter==null){base.rowDelimiter=null;}if(typeof this.options.rowDelimiter==='string'){this.options.rowDelimiter=[this.options.rowDelimiter];}if((base1=this.options).delimiter==null){base1.delimiter=',';}if(this.options.quote!==void 0&&!this.options.quote){this.options.quote='';}if((base2=this.options).quote==null){base2.quote='"';}if((base3=this.options).escape==null){base3.escape='"';}if((base4=this.options).columns==null){base4.columns=null;}if((base5=this.options).comment==null){base5.comment='';}if((base6=this.options).objname==null){base6.objname=false;}if((base7=this.options).trim==null){base7.trim=false;}if((base8=this.options).ltrim==null){base8.ltrim=false;}if((base9=this.options).rtrim==null){base9.rtrim=false;}if((base10=this.options).auto_parse==null){base10.auto_parse=false;}if((base11=this.options).auto_parse_date==null){base11.auto_parse_date=false;}if(this.options.auto_parse_date===true){this.options.auto_parse_date=function(value){var m;m=Date.parse(value);if(!isNaN(m)){value=new Date(m);}return value;};}if((base12=this.options).relax==null){base12.relax=false;}if((base13=this.options).relax_column_count==null){base13.relax_column_count=false;}if((base14=this.options).skip_empty_lines==null){base14.skip_empty_lines=false;}if((base15=this.options).max_limit_on_data_read==null){base15.max_limit_on_data_read=128000;}if((base16=this.options).skip_lines_with_empty_values==null){base16.skip_lines_with_empty_values=false;}this.lines=0;this.count=0;this.skipped_line_count=0;this.empty_line_count=0;this.is_int=/^(\-|\+)?([1-9]+[0-9]*)$/;this.is_float=function(value){return value-parseFloat(value)+1>=0;};this._={decoder:new StringDecoder(),quoting:false,commenting:false,field:null,nextChar:null,closingQuote:0,line:[],chunks:[],rawBuf:'',buf:'',rowDelimiterLength:this.options.rowDelimiter?Math.max.apply(Math,this.options.rowDelimiter.map(function(v){return v.length;})):void 0};return this;};util.inherits(Parser,stream.Transform);module.exports.Parser=Parser;Parser.prototype._transform=function(chunk,encoding,callback){var err;if(chunk instanceof Buffer){chunk=this._.decoder.write(chunk);}err=this.__write(chunk,false);if(err){return this.emit('error',err);}return callback();};Parser.prototype._flush=function(callback){var err;err=this.__write(this._.decoder.end(),true);if(err){return this.emit('error',err);}if(this._.quoting){this.emit('error',new Error("Quoted field not terminated at line "+(this.lines+1)));return;}if(this._.line.length>0){err=this.__push(this._.line);if(err){return callback(err);}}return callback();};Parser.prototype.__push=function(line){var call_column_udf,columns,err,field,i,j,len,lineAsColumns,rawBuf,ref,row;if(this.options.skip_lines_with_empty_values&&line.join('').trim()===''){return;}row=null;if(this.options.columns===true){this.options.columns=line;rawBuf='';return;}else if(typeof this.options.columns==='function'){call_column_udf=function call_column_udf(fn,line){var columns,err;try{columns=fn.call(null,line);return[null,columns];}catch(error){err=error;return[err];}};ref=call_column_udf(this.options.columns,line),err=ref[0],columns=ref[1];if(err){return err;}this.options.columns=columns;rawBuf='';return;}if(!this._.line_length&&line.length>0){this._.line_length=this.options.columns?this.options.columns.length:line.length;}if(line.length===1&&line[0]===''){this.empty_line_count++;}else if(line.length!==this._.line_length){if(this.options.relax_column_count){this.count++;this.skipped_line_count++;}else if(this.options.columns!=null){return Error("Number of columns on line "+this.lines+" does not match header");}else{return Error("Number of columns is inconsistent on line "+this.lines);}}else{this.count++;}if(this.options.columns!=null){lineAsColumns={};for(i=j=0,len=line.length;j<len;i=++j){field=line[i];if(this.options.columns[i]===false){continue;}lineAsColumns[this.options.columns[i]]=field;}if(this.options.objname){row=[lineAsColumns[this.options.objname],lineAsColumns];}else{row=lineAsColumns;}}else{row=line;}if(this.count<this.options.from){return;}if(this.count>this.options.to){return;}if(this.options.raw){this.push({raw:this._.rawBuf,row:row});this._.rawBuf='';}else{this.push(row);}return null;};Parser.prototype.__write=function(chars,end){var areNextCharsDelimiter,areNextCharsRowDelimiters,auto_parse,char,err,escapeIsQuote,i,isDelimiter,isEscape,isNextCharAComment,isQuote,isRowDelimiter,isRowDelimiterLength,is_float,is_int,l,ltrim,nextCharPos,ref,ref1,ref2,ref3,ref4,ref5,remainingBuffer,rowDelimiter,rtrim,wasCommenting;is_int=function(_this){return function(value){if(typeof _this.is_int==='function'){return _this.is_int(value);}else{return _this.is_int.test(value);}};}(this);is_float=function(_this){return function(value){if(typeof _this.is_float==='function'){return _this.is_float(value);}else{return _this.is_float.test(value);}};}(this);auto_parse=function(_this){return function(value){if(!_this.options.auto_parse){return value;}if(typeof _this.options.auto_parse==='function'){return _this.options.auto_parse(value);}if(is_int(value)){value=parseInt(value);}else if(is_float(value)){value=parseFloat(value);}else if(_this.options.auto_parse_date){value=_this.options.auto_parse_date(value);}return value;};}(this);ltrim=this.options.trim||this.options.ltrim;rtrim=this.options.trim||this.options.rtrim;chars=this._.buf+chars;l=chars.length;i=0;if(this.lines===0&&0xFEFF===chars.charCodeAt(0)){i++;}while(i<l){if(!end){remainingBuffer=chars.substr(i,l-i);if(!this.options.rowDelimiter&&i+3>l||!this._.commenting&&l-i<this.options.comment.length&&this.options.comment.substr(0,l-i)===remainingBuffer||this.options.rowDelimiter&&l-i<this._.rowDelimiterLength&&this.options.rowDelimiter.some(function(rd){return rd.substr(0,l-i)===remainingBuffer;})||this.options.rowDelimiter&&this._.quoting&&l-i<this.options.quote.length+this._.rowDelimiterLength&&this.options.rowDelimiter.some(function(_this){return function(rd){return(_this.options.quote+rd).substr(0,l-i)===remainingBuffer;};}(this))||l-i<=this.options.delimiter.length&&this.options.delimiter.substr(0,l-i)===remainingBuffer||l-i<=this.options.escape.length&&this.options.escape.substr(0,l-i)===remainingBuffer){break;}}char=this._.nextChar?this._.nextChar:chars.charAt(i);this._.nextChar=l>i+1?chars.charAt(i+1):'';if(this.options.raw){this._.rawBuf+=char;}if(this.options.rowDelimiter==null){nextCharPos=i;rowDelimiter=null;if(!this._.quoting&&(char==='\n'||char==='\r')){rowDelimiter=char;nextCharPos+=1;}else if(this._.quoting&&char===this.options.quote&&((ref=this._.nextChar)==='\n'||ref==='\r')){rowDelimiter=this._.nextChar;nextCharPos+=2;if(this.raw){rawBuf+=this._.nextChar;}}if(rowDelimiter){if(rowDelimiter==='\r'&&chars.charAt(nextCharPos)==='\n'){rowDelimiter+='\n';}this.options.rowDelimiter=[rowDelimiter];this._.rowDelimiterLength=rowDelimiter.length;}}if(!this._.commenting&&char===this.options.escape){escapeIsQuote=this.options.escape===this.options.quote;isEscape=this._.nextChar===this.options.escape;isQuote=this._.nextChar===this.options.quote;if(!(escapeIsQuote&&this._.field==null&&!this._.quoting)&&(isEscape||isQuote)){i++;char=this._.nextChar;this._.nextChar=chars.charAt(i+1);if(this._.field==null){this._.field='';}this._.field+=char;if(this.options.raw){this._.rawBuf+=char;}i++;continue;}}if(!this._.commenting&&char===this.options.quote){if(this._.quoting){areNextCharsRowDelimiters=this.options.rowDelimiter&&this.options.rowDelimiter.some(function(rd){return chars.substr(i+1,rd.length)===rd;});areNextCharsDelimiter=chars.substr(i+1,this.options.delimiter.length)===this.options.delimiter;isNextCharAComment=this._.nextChar===this.options.comment;if(this._.nextChar&&!areNextCharsRowDelimiters&&!areNextCharsDelimiter&&!isNextCharAComment){if(this.options.relax){this._.quoting=false;if(this._.field){this._.field=""+this.options.quote+this._.field;}}else{return Error("Invalid closing quote at line "+(this.lines+1)+"; found "+JSON.stringify(this._.nextChar)+" instead of delimiter "+JSON.stringify(this.options.delimiter));}}else{this._.quoting=false;this._.closingQuote=this.options.quote.length;i++;if(end&&i===l){this._.line.push(auto_parse(this._.field||''));this._.field=null;}continue;}}else if(!this._.field){this._.quoting=true;i++;continue;}else if(this._.field!=null&&!this.options.relax){return Error("Invalid opening quote at line "+(this.lines+1));}}isRowDelimiter=this.options.rowDelimiter&&this.options.rowDelimiter.some(function(rd){return chars.substr(i,rd.length)===rd;});if(isRowDelimiter||end&&i===l-1){this.lines++;}wasCommenting=false;if(!this._.commenting&&!this._.quoting&&this.options.comment&&chars.substr(i,this.options.comment.length)===this.options.comment){this._.commenting=true;}else if(this._.commenting&&isRowDelimiter){wasCommenting=true;this._.commenting=false;}isDelimiter=chars.substr(i,this.options.delimiter.length)===this.options.delimiter;if(!this._.commenting&&!this._.quoting&&(isDelimiter||isRowDelimiter)){if(isRowDelimiter){isRowDelimiterLength=this.options.rowDelimiter.filter(function(rd){return chars.substr(i,rd.length)===rd;})[0].length;}if(isRowDelimiter&&this._.line.length===0&&this._.field==null){if(wasCommenting||this.options.skip_empty_lines){i+=isRowDelimiterLength;this._.nextChar=chars.charAt(i);continue;}}if(rtrim){if(!this._.closingQuote){this._.field=(ref1=this._.field)!=null?ref1.trimRight():void 0;}}this._.line.push(auto_parse(this._.field||''));this._.closingQuote=0;this._.field=null;if(isDelimiter){i+=this.options.delimiter.length;this._.nextChar=chars.charAt(i);if(end&&!this._.nextChar){isRowDelimiter=true;this._.line.push('');}}if(isRowDelimiter){err=this.__push(this._.line);if(err){return err;}this._.line=[];i+=isRowDelimiterLength;this._.nextChar=chars.charAt(i);continue;}}else if(!this._.commenting&&!this._.quoting&&(char===' '||char==='\t')){if(this._.field==null){this._.field='';}if(!(ltrim&&!this._.field)){this._.field+=char;}i++;}else if(!this._.commenting){if(this._.field==null){this._.field='';}this._.field+=char;i++;}else{i++;}if(!this._.commenting&&((ref2=this._.field)!=null?ref2.length:void 0)>this.options.max_limit_on_data_read){return Error("Field exceeds max_limit_on_data_read setting ("+this.options.max_limit_on_data_read+") "+JSON.stringify(this.options.delimiter));}if(!this._.commenting&&((ref3=this._.line)!=null?ref3.length:void 0)>this.options.max_limit_on_data_read){return Error("Row delimiter not found in the file "+JSON.stringify(this.options.rowDelimiter));}}if(end){if(this._.field!=null){if(rtrim){if(!this._.closingQuote){this._.field=(ref4=this._.field)!=null?ref4.trimRight():void 0;}}this._.line.push(auto_parse(this._.field||''));this._.field=null;}if(((ref5=this._.field)!=null?ref5.length:void 0)>this.options.max_limit_on_data_read){return Error("Delimiter not found in the file "+JSON.stringify(this.options.delimiter));}if(l===0){this.lines++;}if(this._.line.length>this.options.max_limit_on_data_read){return Error("Row delimiter not found in the file "+JSON.stringify(this.options.rowDelimiter));}}this._.buf=chars.substr(i);return null;};isObjLiteral=function isObjLiteral(_obj){var _test;_test=_obj;if((typeof _obj==="undefined"?"undefined":_typeof(_obj))!=='object'||_obj===null||Array.isArray(_obj)){return false;}else{return function(){while(!false){if(Object.getPrototypeOf(_test=Object.getPrototypeOf(_test))===null){break;}}return Object.getPrototypeOf(_obj===_test);}();}};}).call(this,require('_process'),require("buffer").Buffer);},{"_process":170,"buffer":49,"stream":187,"string_decoder":203,"util":208}],53:[function(require,module,exports){(function(Buffer){var StringDecoder,parse;StringDecoder=require('string_decoder').StringDecoder;parse=require('./index');module.exports=function(data,options){var decoder,err,parser,records;if(options==null){options={};}records=options.objname?{}:[];if(data instanceof Buffer){decoder=new StringDecoder();data=decoder.write(data);}parser=new parse.Parser(options);parser.push=function(record){if(options.objname){return records[record[0]]=record[1];}else{return records.push(record);}};err=parser.__write(data,false);if(err){throw err;}if(data instanceof Buffer){err=parser.__write(data.end(),true);if(err){throw err;}}parser._flush(function(){});return records;};}).call(this,require("buffer").Buffer);},{"./index":52,"buffer":49,"string_decoder":203}],54:[function(require,module,exports){(function(process){var Stringifier,get,stream,util;stream=require('stream');util=require('util');get=require('lodash.get');module.exports=function(){var callback,chunks,data,options,stringifier;if(arguments.length===3){data=arguments[0];options=arguments[1];callback=arguments[2];}else if(arguments.length===2){if(Array.isArray(arguments[0])){data=arguments[0];}else{options=arguments[0];}if(typeof arguments[1]==='function'){callback=arguments[1];}else{options=arguments[1];}}else if(arguments.length===1){if(typeof arguments[0]==='function'){callback=arguments[0];}else if(Array.isArray(arguments[0])){data=arguments[0];}else{options=arguments[0];}}if(options==null){options={};}stringifier=new Stringifier(options);if(data){process.nextTick(function(){var d,j,len;for(j=0,len=data.length;j<len;j++){d=data[j];stringifier.write(d);}return stringifier.end();});}if(callback){chunks=[];stringifier.on('readable',function(){var chunk,results;results=[];while(chunk=stringifier.read()){results.push(chunks.push(chunk));}return results;});stringifier.on('error',function(err){return callback(err);});stringifier.on('end',function(){return callback(null,chunks.join(''));});}return stringifier;};Stringifier=function Stringifier(opts){var base,base1,base10,base11,base12,base13,base2,base3,base4,base5,base6,base7,base8,base9,k,options,v;if(opts==null){opts={};}options={};for(k in opts){v=opts[k];options[k]=v;}stream.Transform.call(this,options);this.options=options;if((base=this.options).delimiter==null){base.delimiter=',';}if((base1=this.options).quote==null){base1.quote='"';}if((base2=this.options).quoted==null){base2.quoted=false;}if((base3=this.options).quotedEmpty==null){base3.quotedEmpty=void 0;}if((base4=this.options).quotedString==null){base4.quotedString=false;}if((base5=this.options).eof==null){base5.eof=true;}if((base6=this.options).escape==null){base6.escape='"';}if((base7=this.options).columns==null){base7.columns=null;}if((base8=this.options).header==null){base8.header=false;}if((base9=this.options).formatters==null){base9.formatters={};}if((base10=this.options.formatters).date==null){base10.date=function(value){return''+value.getTime();};}if((base11=this.options.formatters).bool==null){base11.bool=function(value){if(value){return'1';}else{return'';}};}if((base12=this.options.formatters).object==null){base12.object=function(value){return JSON.stringify(value);};}if((base13=this.options).rowDelimiter==null){base13.rowDelimiter='\n';}if(this.countWriten==null){this.countWriten=0;}switch(this.options.rowDelimiter){case'auto':this.options.rowDelimiter=null;break;case'unix':this.options.rowDelimiter="\n";break;case'mac':this.options.rowDelimiter="\r";break;case'windows':this.options.rowDelimiter="\r\n";break;case'unicode':this.options.rowDelimiter="\u2028";}return this;};util.inherits(Stringifier,stream.Transform);module.exports.Stringifier=Stringifier;Stringifier.prototype.headers=function(){var k,label,labels;if(!this.options.header){return;}if(!this.options.columns){return;}labels=this.options.columns;if((typeof labels==="undefined"?"undefined":_typeof(labels))==='object'){labels=function(){var results;results=[];for(k in labels){label=labels[k];results.push(label);}return results;}();}if(this.options.eof){labels=this.stringify(labels)+this.options.rowDelimiter;}else{labels=this.stringify(labels);}return stream.Transform.prototype.write.call(this,labels);};Stringifier.prototype.end=function(chunk,encoding,callback){if(this.countWriten===0){this.headers();}return stream.Transform.prototype.end.apply(this,arguments);};Stringifier.prototype.write=function(chunk,encoding,callback){var base,e,preserve;if(chunk==null){return;}preserve=(typeof chunk==="undefined"?"undefined":_typeof(chunk))!=='object';if(!preserve){if(this.countWriten===0&&!Array.isArray(chunk)){if((base=this.options).columns==null){base.columns=Object.keys(chunk);}}try{this.emit('record',chunk,this.countWriten);}catch(error){e=error;return this.emit('error',e);}if(this.options.eof){chunk=this.stringify(chunk)+this.options.rowDelimiter;}else{chunk=this.stringify(chunk);if(this.options.header||this.countWriten){chunk=this.options.rowDelimiter+chunk;}}}if(typeof chunk==='number'){chunk=""+chunk;}if(this.countWriten===0){this.headers();}if(!preserve){this.countWriten++;}return stream.Transform.prototype.write.call(this,chunk,encoding,callback);};Stringifier.prototype._transform=function(chunk,encoding,callback){this.push(chunk);return callback();};Stringifier.prototype.stringify=function(line){var _line,column,columns,containsEscape,containsLinebreak,containsQuote,containsdelimiter,delimiter,escape,field,i,j,l,newLine,quote,ref,ref1,regexp,shouldQuote,value;if((typeof line==="undefined"?"undefined":_typeof(line))!=='object'){return line;}columns=this.options.columns;if((typeof columns==="undefined"?"undefined":_typeof(columns))==='object'&&columns!==null&&!Array.isArray(columns)){columns=Object.keys(columns);}delimiter=this.options.delimiter;quote=this.options.quote;escape=this.options.escape;if(!Array.isArray(line)){_line=[];if(columns){for(i=j=0,ref=columns.length;0<=ref?j<ref:j>ref;i=0<=ref?++j:--j){column=columns[i];value=get(line,column);_line[i]=typeof value==='undefined'||value===null?'':value;}}else{for(column in line){_line.push(line[column]);}}line=_line;_line=null;}else if(columns){line.splice(columns.length);}if(Array.isArray(line)){newLine='';for(i=l=0,ref1=line.length;0<=ref1?l<ref1:l>ref1;i=0<=ref1?++l:--l){field=line[i];if(typeof field==='string'){}else if(typeof field==='number'){field=''+field;}else if(typeof field==='boolean'){field=this.options.formatters.bool(field);}else if(field instanceof Date){field=this.options.formatters.date(field);}else if((typeof field==="undefined"?"undefined":_typeof(field))==='object'&&field!==null){field=this.options.formatters.object(field);}if(field){containsdelimiter=field.indexOf(delimiter)>=0;containsQuote=field.indexOf(quote)>=0;containsEscape=field.indexOf(escape)>=0&&escape!==quote;containsLinebreak=field.indexOf('\r')>=0||field.indexOf('\n')>=0;shouldQuote=containsQuote||containsdelimiter||containsLinebreak||this.options.quoted||this.options.quotedString&&typeof line[i]==='string';if(shouldQuote&&containsEscape){regexp=escape==='\\'?new RegExp(escape+escape,'g'):new RegExp(escape,'g');field=field.replace(regexp,escape+escape);}if(containsQuote){regexp=new RegExp(quote,'g');field=field.replace(regexp,escape+quote);}if(shouldQuote){field=quote+field+quote;}newLine+=field;}else if(this.options.quotedEmpty||this.options.quotedEmpty==null&&line[i]===''&&this.options.quotedString){newLine+=quote+quote;}if(i!==line.length-1){newLine+=delimiter;}}line=newLine;}return line;};}).call(this,require('_process'));},{"_process":170,"lodash.get":145,"stream":187,"util":208}],55:[function(require,module,exports){(function(Buffer){var StringDecoder,stringify;StringDecoder=require('string_decoder').StringDecoder;stringify=require('./index');module.exports=function(records,options){var data,decoder,i,len,record,stringifier;if(options==null){options={};}data=[];if(records instanceof Buffer){decoder=new StringDecoder();records=decoder.write(records);}stringifier=new stringify.Stringifier(options);stringifier.push=function(record){if(record){return data.push(record.toString());}};for(i=0,len=records.length;i<len;i++){record=records[i];stringifier.write(record);}stringifier.end();return data.join('');};}).call(this,require("buffer").Buffer);},{"./index":54,"buffer":49,"string_decoder":203}],56:[function(require,module,exports){(function(root,factory){'use strict';if(typeof define==='function'&&define.amd){define(['exports'],factory);}else if(typeof exports!=='undefined'){factory(exports);}else{factory(root.esprima={});}})(this,function(exports){'use strict';var Token,TokenName,FnExprTokens,Syntax,PlaceHolders,Messages,Regex,source,strict,index,lineNumber,lineStart,hasLineTerminator,lastIndex,lastLineNumber,lastLineStart,startIndex,startLineNumber,startLineStart,scanning,length,lookahead,state,extra,isBindingElement,isAssignmentTarget,firstCoverInitializedNameError;Token={BooleanLiteral:1,EOF:2,Identifier:3,Keyword:4,NullLiteral:5,NumericLiteral:6,Punctuator:7,StringLiteral:8,RegularExpression:9,Template:10};TokenName={};TokenName[Token.BooleanLiteral]='Boolean';TokenName[Token.EOF]='<end>';TokenName[Token.Identifier]='Identifier';TokenName[Token.Keyword]='Keyword';TokenName[Token.NullLiteral]='Null';TokenName[Token.NumericLiteral]='Numeric';TokenName[Token.Punctuator]='Punctuator';TokenName[Token.StringLiteral]='String';TokenName[Token.RegularExpression]='RegularExpression';TokenName[Token.Template]='Template';FnExprTokens=['(','{','[','in','typeof','instanceof','new','return','case','delete','throw','void','=','+=','-=','*=','/=','%=','<<=','>>=','>>>=','&=','|=','^=',',','+','-','*','/','%','++','--','<<','>>','>>>','&','|','^','!','~','&&','||','?',':','===','==','>=','<=','<','>','!=','!=='];Syntax={AssignmentExpression:'AssignmentExpression',AssignmentPattern:'AssignmentPattern',ArrayExpression:'ArrayExpression',ArrayPattern:'ArrayPattern',ArrowFunctionExpression:'ArrowFunctionExpression',BlockStatement:'BlockStatement',BinaryExpression:'BinaryExpression',BreakStatement:'BreakStatement',CallExpression:'CallExpression',CatchClause:'CatchClause',ClassBody:'ClassBody',ClassDeclaration:'ClassDeclaration',ClassExpression:'ClassExpression',ConditionalExpression:'ConditionalExpression',ContinueStatement:'ContinueStatement',DoWhileStatement:'DoWhileStatement',DebuggerStatement:'DebuggerStatement',EmptyStatement:'EmptyStatement',ExportAllDeclaration:'ExportAllDeclaration',ExportDefaultDeclaration:'ExportDefaultDeclaration',ExportNamedDeclaration:'ExportNamedDeclaration',ExportSpecifier:'ExportSpecifier',ExpressionStatement:'ExpressionStatement',ForStatement:'ForStatement',ForOfStatement:'ForOfStatement',ForInStatement:'ForInStatement',FunctionDeclaration:'FunctionDeclaration',FunctionExpression:'FunctionExpression',Identifier:'Identifier',IfStatement:'IfStatement',ImportDeclaration:'ImportDeclaration',ImportDefaultSpecifier:'ImportDefaultSpecifier',ImportNamespaceSpecifier:'ImportNamespaceSpecifier',ImportSpecifier:'ImportSpecifier',Literal:'Literal',LabeledStatement:'LabeledStatement',LogicalExpression:'LogicalExpression',MemberExpression:'MemberExpression',MetaProperty:'MetaProperty',MethodDefinition:'MethodDefinition',NewExpression:'NewExpression',ObjectExpression:'ObjectExpression',ObjectPattern:'ObjectPattern',Program:'Program',Property:'Property',RestElement:'RestElement',ReturnStatement:'ReturnStatement',SequenceExpression:'SequenceExpression',SpreadElement:'SpreadElement',Super:'Super',SwitchCase:'SwitchCase',SwitchStatement:'SwitchStatement',TaggedTemplateExpression:'TaggedTemplateExpression',TemplateElement:'TemplateElement',TemplateLiteral:'TemplateLiteral',ThisExpression:'ThisExpression',ThrowStatement:'ThrowStatement',TryStatement:'TryStatement',UnaryExpression:'UnaryExpression',UpdateExpression:'UpdateExpression',VariableDeclaration:'VariableDeclaration',VariableDeclarator:'VariableDeclarator',WhileStatement:'WhileStatement',WithStatement:'WithStatement',YieldExpression:'YieldExpression'};PlaceHolders={ArrowParameterPlaceHolder:'ArrowParameterPlaceHolder'};Messages={UnexpectedToken:'Unexpected token %0',UnexpectedNumber:'Unexpected number',UnexpectedString:'Unexpected string',UnexpectedIdentifier:'Unexpected identifier',UnexpectedReserved:'Unexpected reserved word',UnexpectedTemplate:'Unexpected quasi %0',UnexpectedEOS:'Unexpected end of input',NewlineAfterThrow:'Illegal newline after throw',InvalidRegExp:'Invalid regular expression',UnterminatedRegExp:'Invalid regular expression: missing /',InvalidLHSInAssignment:'Invalid left-hand side in assignment',InvalidLHSInForIn:'Invalid left-hand side in for-in',InvalidLHSInForLoop:'Invalid left-hand side in for-loop',MultipleDefaultsInSwitch:'More than one default clause in switch statement',NoCatchOrFinally:'Missing catch or finally after try',UnknownLabel:'Undefined label \'%0\'',Redeclaration:'%0 \'%1\' has already been declared',IllegalContinue:'Illegal continue statement',IllegalBreak:'Illegal break statement',IllegalReturn:'Illegal return statement',StrictModeWith:'Strict mode code may not include a with statement',StrictCatchVariable:'Catch variable may not be eval or arguments in strict mode',StrictVarName:'Variable name may not be eval or arguments in strict mode',StrictParamName:'Parameter name eval or arguments is not allowed in strict mode',StrictParamDupe:'Strict mode function may not have duplicate parameter names',StrictFunctionName:'Function name may not be eval or arguments in strict mode',StrictOctalLiteral:'Octal literals are not allowed in strict mode.',StrictDelete:'Delete of an unqualified identifier in strict mode.',StrictLHSAssignment:'Assignment to eval or arguments is not allowed in strict mode',StrictLHSPostfix:'Postfix increment/decrement may not have eval or arguments operand in strict mode',StrictLHSPrefix:'Prefix increment/decrement may not have eval or arguments operand in strict mode',StrictReservedWord:'Use of future reserved word in strict mode',TemplateOctalLiteral:'Octal literals are not allowed in template strings.',ParameterAfterRestParameter:'Rest parameter must be last formal parameter',DefaultRestParameter:'Unexpected token =',ObjectPatternAsRestParameter:'Unexpected token {',DuplicateProtoProperty:'Duplicate __proto__ fields are not allowed in object literals',ConstructorSpecialMethod:'Class constructor may not be an accessor',DuplicateConstructor:'A class may only have one constructor',StaticPrototype:'Classes may not have static property named prototype',MissingFromClause:'Unexpected token',NoAsAfterImportNamespace:'Unexpected token',InvalidModuleSpecifier:'Unexpected token',IllegalImportDeclaration:'Unexpected token',IllegalExportDeclaration:'Unexpected token',DuplicateBinding:'Duplicate binding %0'};Regex={NonAsciiIdentifierStart:/[\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0-\u08B2\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309B-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uAB65\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDE80-\uDE9C\uDEA0-\uDED0\uDF00-\uDF1F\uDF30-\uDF4A\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE33\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE4\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48]|\uD804[\uDC03-\uDC37\uDC83-\uDCAF\uDCD0-\uDCE8\uDD03-\uDD26\uDD50-\uDD72\uDD76\uDD83-\uDDB2\uDDC1-\uDDC4\uDDDA\uDE00-\uDE11\uDE13-\uDE2B\uDEB0-\uDEDE\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3D\uDF5D-\uDF61]|\uD805[\uDC80-\uDCAF\uDCC4\uDCC5\uDCC7\uDD80-\uDDAE\uDE00-\uDE2F\uDE44\uDE80-\uDEAA]|\uD806[\uDCA0-\uDCDF\uDCFF\uDEC0-\uDEF8]|\uD808[\uDC00-\uDF98]|\uD809[\uDC00-\uDC6E]|[\uD80C\uD840-\uD868\uD86A-\uD86C][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDED0-\uDEED\uDF00-\uDF2F\uDF40-\uDF43\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDF00-\uDF44\uDF50\uDF93-\uDF9F]|\uD82C[\uDC00\uDC01]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB]|\uD83A[\uDC00-\uDCC4]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D]|\uD87E[\uDC00-\uDE1D]/,NonAsciiIdentifierPart:/[\xAA\xB5\xB7\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0300-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u05D0-\u05EA\u05F0-\u05F2\u0610-\u061A\u0620-\u0669\u066E-\u06D3\u06D5-\u06DC\u06DF-\u06E8\u06EA-\u06FC\u06FF\u0710-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u0800-\u082D\u0840-\u085B\u08A0-\u08B2\u08E4-\u0963\u0966-\u096F\u0971-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09F1\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AEF\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B6F\u0B71\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BEF\u0C00-\u0C03\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58\u0C59\u0C60-\u0C63\u0C66-\u0C6F\u0C81-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2\u0D01-\u0D03\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D57\u0D60-\u0D63\u0D66-\u0D6F\u0D7A-\u0D7F\u0D82\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E01-\u0E3A\u0E40-\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB9\u0EBB-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F71-\u0F84\u0F86-\u0F97\u0F99-\u0FBC\u0FC6\u1000-\u1049\u1050-\u109D\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1369-\u1371\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1714\u1720-\u1734\u1740-\u1753\u1760-\u176C\u176E-\u1770\u1772\u1773\u1780-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u180B-\u180D\u1810-\u1819\u1820-\u1877\u1880-\u18AA\u18B0-\u18F5\u1900-\u191E\u1920-\u192B\u1930-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A1B\u1A20-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1B00-\u1B4B\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1BF3\u1C00-\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1CD0-\u1CD2\u1CD4-\u1CF6\u1CF8\u1CF9\u1D00-\u1DF5\u1DFC-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u200C\u200D\u203F\u2040\u2054\u2071\u207F\u2090-\u209C\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D7F-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2DE0-\u2DFF\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA674-\uA67D\uA67F-\uA69D\uA69F-\uA6F1\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA827\uA840-\uA873\uA880-\uA8C4\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA900-\uA92D\uA930-\uA953\uA960-\uA97C\uA980-\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA36\uAA40-\uAA4D\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEF\uAAF2-\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uAB65\uABC0-\uABEA\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE00-\uFE0F\uFE20-\uFE2D\uFE33\uFE34\uFE4D-\uFE4F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3F\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDDFD\uDE80-\uDE9C\uDEA0-\uDED0\uDEE0\uDF00-\uDF1F\uDF30-\uDF4A\uDF50-\uDF7A\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00-\uDE03\uDE05\uDE06\uDE0C-\uDE13\uDE15-\uDE17\uDE19-\uDE33\uDE38-\uDE3A\uDE3F\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE6\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48]|\uD804[\uDC00-\uDC46\uDC66-\uDC6F\uDC7F-\uDCBA\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD00-\uDD34\uDD36-\uDD3F\uDD50-\uDD73\uDD76\uDD80-\uDDC4\uDDD0-\uDDDA\uDE00-\uDE11\uDE13-\uDE37\uDEB0-\uDEEA\uDEF0-\uDEF9\uDF01-\uDF03\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3C-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF57\uDF5D-\uDF63\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC80-\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDB5\uDDB8-\uDDC0\uDE00-\uDE40\uDE44\uDE50-\uDE59\uDE80-\uDEB7\uDEC0-\uDEC9]|\uD806[\uDCA0-\uDCE9\uDCFF\uDEC0-\uDEF8]|\uD808[\uDC00-\uDF98]|\uD809[\uDC00-\uDC6E]|[\uD80C\uD840-\uD868\uD86A-\uD86C][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDED0-\uDEED\uDEF0-\uDEF4\uDF00-\uDF36\uDF40-\uDF43\uDF50-\uDF59\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDF00-\uDF44\uDF50-\uDF7E\uDF8F-\uDF9F]|\uD82C[\uDC00\uDC01]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99\uDC9D\uDC9E]|\uD834[\uDD65-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD83A[\uDC00-\uDCC4\uDCD0-\uDCD6]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D]|\uD87E[\uDC00-\uDE1D]|\uDB40[\uDD00-\uDDEF]/};function assert(condition,message){if(!condition){throw new Error('ASSERT: '+message);}}function isDecimalDigit(ch){return ch>=0x30&&ch<=0x39;}function isHexDigit(ch){return'0123456789abcdefABCDEF'.indexOf(ch)>=0;}function isOctalDigit(ch){return'01234567'.indexOf(ch)>=0;}function octalToDecimal(ch){var octal=ch!=='0',code='01234567'.indexOf(ch);if(index<length&&isOctalDigit(source[index])){octal=true;code=code*8+'01234567'.indexOf(source[index++]);if('0123'.indexOf(ch)>=0&&index<length&&isOctalDigit(source[index])){code=code*8+'01234567'.indexOf(source[index++]);}}return{code:code,octal:octal};}function isWhiteSpace(ch){return ch===0x20||ch===0x09||ch===0x0B||ch===0x0C||ch===0xA0||ch>=0x1680&&[0x1680,0x180E,0x2000,0x2001,0x2002,0x2003,0x2004,0x2005,0x2006,0x2007,0x2008,0x2009,0x200A,0x202F,0x205F,0x3000,0xFEFF].indexOf(ch)>=0;}function isLineTerminator(ch){return ch===0x0A||ch===0x0D||ch===0x2028||ch===0x2029;}function fromCodePoint(cp){return cp<0x10000?String.fromCharCode(cp):String.fromCharCode(0xD800+(cp-0x10000>>10))+String.fromCharCode(0xDC00+(cp-0x10000&1023));}function isIdentifierStart(ch){return ch===0x24||ch===0x5F||ch>=0x41&&ch<=0x5A||ch>=0x61&&ch<=0x7A||ch===0x5C||ch>=0x80&&Regex.NonAsciiIdentifierStart.test(fromCodePoint(ch));}function isIdentifierPart(ch){return ch===0x24||ch===0x5F||ch>=0x41&&ch<=0x5A||ch>=0x61&&ch<=0x7A||ch>=0x30&&ch<=0x39||ch===0x5C||ch>=0x80&&Regex.NonAsciiIdentifierPart.test(fromCodePoint(ch));}function isFutureReservedWord(id){switch(id){case'enum':case'export':case'import':case'super':return true;default:return false;}}function isStrictModeReservedWord(id){switch(id){case'implements':case'interface':case'package':case'private':case'protected':case'public':case'static':case'yield':case'let':return true;default:return false;}}function isRestrictedWord(id){return id==='eval'||id==='arguments';}function isKeyword(id){switch(id.length){case 2:return id==='if'||id==='in'||id==='do';case 3:return id==='var'||id==='for'||id==='new'||id==='try'||id==='let';case 4:return id==='this'||id==='else'||id==='case'||id==='void'||id==='with'||id==='enum';case 5:return id==='while'||id==='break'||id==='catch'||id==='throw'||id==='const'||id==='yield'||id==='class'||id==='super';case 6:return id==='return'||id==='typeof'||id==='delete'||id==='switch'||id==='export'||id==='import';case 7:return id==='default'||id==='finally'||id==='extends';case 8:return id==='function'||id==='continue'||id==='debugger';case 10:return id==='instanceof';default:return false;}}function addComment(type,value,start,end,loc){var comment;assert(typeof start==='number','Comment must have valid position');state.lastCommentStart=start;comment={type:type,value:value};if(extra.range){comment.range=[start,end];}if(extra.loc){comment.loc=loc;}extra.comments.push(comment);if(extra.attachComment){extra.leadingComments.push(comment);extra.trailingComments.push(comment);}if(extra.tokenize){comment.type=comment.type+'Comment';if(extra.delegate){comment=extra.delegate(comment);}extra.tokens.push(comment);}}function skipSingleLineComment(offset){var start,loc,ch,comment;start=index-offset;loc={start:{line:lineNumber,column:index-lineStart-offset}};while(index<length){ch=source.charCodeAt(index);++index;if(isLineTerminator(ch)){hasLineTerminator=true;if(extra.comments){comment=source.slice(start+offset,index-1);loc.end={line:lineNumber,column:index-lineStart-1};addComment('Line',comment,start,index-1,loc);}if(ch===13&&source.charCodeAt(index)===10){++index;}++lineNumber;lineStart=index;return;}}if(extra.comments){comment=source.slice(start+offset,index);loc.end={line:lineNumber,column:index-lineStart};addComment('Line',comment,start,index,loc);}}function skipMultiLineComment(){var start,loc,ch,comment;if(extra.comments){start=index-2;loc={start:{line:lineNumber,column:index-lineStart-2}};}while(index<length){ch=source.charCodeAt(index);if(isLineTerminator(ch)){if(ch===0x0D&&source.charCodeAt(index+1)===0x0A){++index;}hasLineTerminator=true;++lineNumber;++index;lineStart=index;}else if(ch===0x2A){if(source.charCodeAt(index+1)===0x2F){++index;++index;if(extra.comments){comment=source.slice(start+2,index-2);loc.end={line:lineNumber,column:index-lineStart};addComment('Block',comment,start,index,loc);}return;}++index;}else{++index;}}if(extra.comments){loc.end={line:lineNumber,column:index-lineStart};comment=source.slice(start+2,index);addComment('Block',comment,start,index,loc);}tolerateUnexpectedToken();}function skipComment(){var ch,start;hasLineTerminator=false;start=index===0;while(index<length){ch=source.charCodeAt(index);if(isWhiteSpace(ch)){++index;}else if(isLineTerminator(ch)){hasLineTerminator=true;++index;if(ch===0x0D&&source.charCodeAt(index)===0x0A){++index;}++lineNumber;lineStart=index;start=true;}else if(ch===0x2F){ch=source.charCodeAt(index+1);if(ch===0x2F){++index;++index;skipSingleLineComment(2);start=true;}else if(ch===0x2A){++index;++index;skipMultiLineComment();}else{break;}}else if(start&&ch===0x2D){if(source.charCodeAt(index+1)===0x2D&&source.charCodeAt(index+2)===0x3E){index+=3;skipSingleLineComment(3);}else{break;}}else if(ch===0x3C){if(source.slice(index+1,index+4)==='!--'){++index;++index;++index;++index;skipSingleLineComment(4);}else{break;}}else{break;}}}function scanHexEscape(prefix){var i,len,ch,code=0;len=prefix==='u'?4:2;for(i=0;i<len;++i){if(index<length&&isHexDigit(source[index])){ch=source[index++];code=code*16+'0123456789abcdef'.indexOf(ch.toLowerCase());}else{return'';}}return String.fromCharCode(code);}function scanUnicodeCodePointEscape(){var ch,code;ch=source[index];code=0;if(ch==='}'){throwUnexpectedToken();}while(index<length){ch=source[index++];if(!isHexDigit(ch)){break;}code=code*16+'0123456789abcdef'.indexOf(ch.toLowerCase());}if(code>0x10FFFF||ch!=='}'){throwUnexpectedToken();}return fromCodePoint(code);}function codePointAt(i){var cp,first,second;cp=source.charCodeAt(i);if(cp>=0xD800&&cp<=0xDBFF){second=source.charCodeAt(i+1);if(second>=0xDC00&&second<=0xDFFF){first=cp;cp=(first-0xD800)*0x400+second-0xDC00+0x10000;}}return cp;}function getComplexIdentifier(){var cp,ch,id;cp=codePointAt(index);id=fromCodePoint(cp);index+=id.length;if(cp===0x5C){if(source.charCodeAt(index)!==0x75){throwUnexpectedToken();}++index;if(source[index]==='{'){++index;ch=scanUnicodeCodePointEscape();}else{ch=scanHexEscape('u');cp=ch.charCodeAt(0);if(!ch||ch==='\\'||!isIdentifierStart(cp)){throwUnexpectedToken();}}id=ch;}while(index<length){cp=codePointAt(index);if(!isIdentifierPart(cp)){break;}ch=fromCodePoint(cp);id+=ch;index+=ch.length;if(cp===0x5C){id=id.substr(0,id.length-1);if(source.charCodeAt(index)!==0x75){throwUnexpectedToken();}++index;if(source[index]==='{'){++index;ch=scanUnicodeCodePointEscape();}else{ch=scanHexEscape('u');cp=ch.charCodeAt(0);if(!ch||ch==='\\'||!isIdentifierPart(cp)){throwUnexpectedToken();}}id+=ch;}}return id;}function getIdentifier(){var start,ch;start=index++;while(index<length){ch=source.charCodeAt(index);if(ch===0x5C){index=start;return getComplexIdentifier();}else if(ch>=0xD800&&ch<0xDFFF){index=start;return getComplexIdentifier();}if(isIdentifierPart(ch)){++index;}else{break;}}return source.slice(start,index);}function scanIdentifier(){var start,id,type;start=index;id=source.charCodeAt(index)===0x5C?getComplexIdentifier():getIdentifier();if(id.length===1){type=Token.Identifier;}else if(isKeyword(id)){type=Token.Keyword;}else if(id==='null'){type=Token.NullLiteral;}else if(id==='true'||id==='false'){type=Token.BooleanLiteral;}else{type=Token.Identifier;}return{type:type,value:id,lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}function scanPunctuator(){var token,str;token={type:Token.Punctuator,value:'',lineNumber:lineNumber,lineStart:lineStart,start:index,end:index};str=source[index];switch(str){case'(':if(extra.tokenize){extra.openParenToken=extra.tokenValues.length;}++index;break;case'{':if(extra.tokenize){extra.openCurlyToken=extra.tokenValues.length;}state.curlyStack.push('{');++index;break;case'.':++index;if(source[index]==='.'&&source[index+1]==='.'){index+=2;str='...';}break;case'}':++index;state.curlyStack.pop();break;case')':case';':case',':case'[':case']':case':':case'?':case'~':++index;break;default:str=source.substr(index,4);if(str==='>>>='){index+=4;}else{str=str.substr(0,3);if(str==='==='||str==='!=='||str==='>>>'||str==='<<='||str==='>>='){index+=3;}else{str=str.substr(0,2);if(str==='&&'||str==='||'||str==='=='||str==='!='||str==='+='||str==='-='||str==='*='||str==='/='||str==='++'||str==='--'||str==='<<'||str==='>>'||str==='&='||str==='|='||str==='^='||str==='%='||str==='<='||str==='>='||str==='=>'){index+=2;}else{str=source[index];if('<>=!+-*%&|^/'.indexOf(str)>=0){++index;}}}}}if(index===token.start){throwUnexpectedToken();}token.end=index;token.value=str;return token;}function scanHexLiteral(start){var number='';while(index<length){if(!isHexDigit(source[index])){break;}number+=source[index++];}if(number.length===0){throwUnexpectedToken();}if(isIdentifierStart(source.charCodeAt(index))){throwUnexpectedToken();}return{type:Token.NumericLiteral,value:parseInt('0x'+number,16),lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}function scanBinaryLiteral(start){var ch,number;number='';while(index<length){ch=source[index];if(ch!=='0'&&ch!=='1'){break;}number+=source[index++];}if(number.length===0){throwUnexpectedToken();}if(index<length){ch=source.charCodeAt(index);if(isIdentifierStart(ch)||isDecimalDigit(ch)){throwUnexpectedToken();}}return{type:Token.NumericLiteral,value:parseInt(number,2),lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}function scanOctalLiteral(prefix,start){var number,octal;if(isOctalDigit(prefix)){octal=true;number='0'+source[index++];}else{octal=false;++index;number='';}while(index<length){if(!isOctalDigit(source[index])){break;}number+=source[index++];}if(!octal&&number.length===0){throwUnexpectedToken();}if(isIdentifierStart(source.charCodeAt(index))||isDecimalDigit(source.charCodeAt(index))){throwUnexpectedToken();}return{type:Token.NumericLiteral,value:parseInt(number,8),octal:octal,lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}function isImplicitOctalLiteral(){var i,ch;for(i=index+1;i<length;++i){ch=source[i];if(ch==='8'||ch==='9'){return false;}if(!isOctalDigit(ch)){return true;}}return true;}function scanNumericLiteral(){var number,start,ch;ch=source[index];assert(isDecimalDigit(ch.charCodeAt(0))||ch==='.','Numeric literal must start with a decimal digit or a decimal point');start=index;number='';if(ch!=='.'){number=source[index++];ch=source[index];if(number==='0'){if(ch==='x'||ch==='X'){++index;return scanHexLiteral(start);}if(ch==='b'||ch==='B'){++index;return scanBinaryLiteral(start);}if(ch==='o'||ch==='O'){return scanOctalLiteral(ch,start);}if(isOctalDigit(ch)){if(isImplicitOctalLiteral()){return scanOctalLiteral(ch,start);}}}while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++];}ch=source[index];}if(ch==='.'){number+=source[index++];while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++];}ch=source[index];}if(ch==='e'||ch==='E'){number+=source[index++];ch=source[index];if(ch==='+'||ch==='-'){number+=source[index++];}if(isDecimalDigit(source.charCodeAt(index))){while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++];}}else{throwUnexpectedToken();}}if(isIdentifierStart(source.charCodeAt(index))){throwUnexpectedToken();}return{type:Token.NumericLiteral,value:parseFloat(number),lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}function scanStringLiteral(){var str='',quote,start,ch,unescaped,octToDec,octal=false;quote=source[index];assert(quote==='\''||quote==='"','String literal must starts with a quote');start=index;++index;while(index<length){ch=source[index++];if(ch===quote){quote='';break;}else if(ch==='\\'){ch=source[index++];if(!ch||!isLineTerminator(ch.charCodeAt(0))){switch(ch){case'u':case'x':if(source[index]==='{'){++index;str+=scanUnicodeCodePointEscape();}else{unescaped=scanHexEscape(ch);if(!unescaped){throw throwUnexpectedToken();}str+=unescaped;}break;case'n':str+='\n';break;case'r':str+='\r';break;case't':str+='\t';break;case'b':str+='\b';break;case'f':str+='\f';break;case'v':str+='\x0B';break;case'8':case'9':str+=ch;tolerateUnexpectedToken();break;default:if(isOctalDigit(ch)){octToDec=octalToDecimal(ch);octal=octToDec.octal||octal;str+=String.fromCharCode(octToDec.code);}else{str+=ch;}break;}}else{++lineNumber;if(ch==='\r'&&source[index]==='\n'){++index;}lineStart=index;}}else if(isLineTerminator(ch.charCodeAt(0))){break;}else{str+=ch;}}if(quote!==''){index=start;throwUnexpectedToken();}return{type:Token.StringLiteral,value:str,octal:octal,lineNumber:startLineNumber,lineStart:startLineStart,start:start,end:index};}function scanTemplate(){var cooked='',ch,start,rawOffset,terminated,head,tail,restore,unescaped;terminated=false;tail=false;start=index;head=source[index]==='`';rawOffset=2;++index;while(index<length){ch=source[index++];if(ch==='`'){rawOffset=1;tail=true;terminated=true;break;}else if(ch==='$'){if(source[index]==='{'){state.curlyStack.push('${');++index;terminated=true;break;}cooked+=ch;}else if(ch==='\\'){ch=source[index++];if(!isLineTerminator(ch.charCodeAt(0))){switch(ch){case'n':cooked+='\n';break;case'r':cooked+='\r';break;case't':cooked+='\t';break;case'u':case'x':if(source[index]==='{'){++index;cooked+=scanUnicodeCodePointEscape();}else{restore=index;unescaped=scanHexEscape(ch);if(unescaped){cooked+=unescaped;}else{index=restore;cooked+=ch;}}break;case'b':cooked+='\b';break;case'f':cooked+='\f';break;case'v':cooked+='\v';break;default:if(ch==='0'){if(isDecimalDigit(source.charCodeAt(index))){throwError(Messages.TemplateOctalLiteral);}cooked+='\0';}else if(isOctalDigit(ch)){throwError(Messages.TemplateOctalLiteral);}else{cooked+=ch;}break;}}else{++lineNumber;if(ch==='\r'&&source[index]==='\n'){++index;}lineStart=index;}}else if(isLineTerminator(ch.charCodeAt(0))){++lineNumber;if(ch==='\r'&&source[index]==='\n'){++index;}lineStart=index;cooked+='\n';}else{cooked+=ch;}}if(!terminated){throwUnexpectedToken();}if(!head){state.curlyStack.pop();}return{type:Token.Template,value:{cooked:cooked,raw:source.slice(start+1,index-rawOffset)},head:head,tail:tail,lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}function testRegExp(pattern,flags){var astralSubstitute="\uFFFF",tmp=pattern;if(flags.indexOf('u')>=0){tmp=tmp.replace(/\\u\{([0-9a-fA-F]+)\}|\\u([a-fA-F0-9]{4})/g,function($0,$1,$2){var codePoint=parseInt($1||$2,16);if(codePoint>0x10FFFF){throwUnexpectedToken(null,Messages.InvalidRegExp);}if(codePoint<=0xFFFF){return String.fromCharCode(codePoint);}return astralSubstitute;}).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,astralSubstitute);}try{RegExp(tmp);}catch(e){throwUnexpectedToken(null,Messages.InvalidRegExp);}try{return new RegExp(pattern,flags);}catch(exception){return null;}}function scanRegExpBody(){var ch,str,classMarker,terminated,body;ch=source[index];assert(ch==='/','Regular expression literal must start with a slash');str=source[index++];classMarker=false;terminated=false;while(index<length){ch=source[index++];str+=ch;if(ch==='\\'){ch=source[index++];if(isLineTerminator(ch.charCodeAt(0))){throwUnexpectedToken(null,Messages.UnterminatedRegExp);}str+=ch;}else if(isLineTerminator(ch.charCodeAt(0))){throwUnexpectedToken(null,Messages.UnterminatedRegExp);}else if(classMarker){if(ch===']'){classMarker=false;}}else{if(ch==='/'){terminated=true;break;}else if(ch==='['){classMarker=true;}}}if(!terminated){throwUnexpectedToken(null,Messages.UnterminatedRegExp);}body=str.substr(1,str.length-2);return{value:body,literal:str};}function scanRegExpFlags(){var ch,str,flags,restore;str='';flags='';while(index<length){ch=source[index];if(!isIdentifierPart(ch.charCodeAt(0))){break;}++index;if(ch==='\\'&&index<length){ch=source[index];if(ch==='u'){++index;restore=index;ch=scanHexEscape('u');if(ch){flags+=ch;for(str+="\\u";restore<index;++restore){str+=source[restore];}}else{index=restore;flags+='u';str+="\\u";}tolerateUnexpectedToken();}else{str+='\\';tolerateUnexpectedToken();}}else{flags+=ch;str+=ch;}}return{value:flags,literal:str};}function scanRegExp(){var start,body,flags,value;scanning=true;lookahead=null;skipComment();start=index;body=scanRegExpBody();flags=scanRegExpFlags();value=testRegExp(body.value,flags.value);scanning=false;if(extra.tokenize){return{type:Token.RegularExpression,value:value,regex:{pattern:body.value,flags:flags.value},lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}return{literal:body.literal+flags.literal,value:value,regex:{pattern:body.value,flags:flags.value},start:start,end:index};}function collectRegex(){var pos,loc,regex,token;skipComment();pos=index;loc={start:{line:lineNumber,column:index-lineStart}};regex=scanRegExp();loc.end={line:lineNumber,column:index-lineStart};if(!extra.tokenize){if(extra.tokens.length>0){token=extra.tokens[extra.tokens.length-1];if(token.range[0]===pos&&token.type==='Punctuator'){if(token.value==='/'||token.value==='/='){extra.tokens.pop();}}}extra.tokens.push({type:'RegularExpression',value:regex.literal,regex:regex.regex,range:[pos,index],loc:loc});}return regex;}function isIdentifierName(token){return token.type===Token.Identifier||token.type===Token.Keyword||token.type===Token.BooleanLiteral||token.type===Token.NullLiteral;}function advanceSlash(){var regex,previous,check;function testKeyword(value){return value&&value.length>1&&value[0]>='a'&&value[0]<='z';}previous=extra.tokenValues[extra.tokenValues.length-1];regex=previous!==null;switch(previous){case'this':case']':regex=false;break;case')':check=extra.tokenValues[extra.openParenToken-1];regex=check==='if'||check==='while'||check==='for'||check==='with';break;case'}':regex=false;if(testKeyword(extra.tokenValues[extra.openCurlyToken-3])){check=extra.tokenValues[extra.openCurlyToken-4];regex=check?FnExprTokens.indexOf(check)<0:false;}else if(testKeyword(extra.tokenValues[extra.openCurlyToken-4])){check=extra.tokenValues[extra.openCurlyToken-5];regex=check?FnExprTokens.indexOf(check)<0:true;}}return regex?collectRegex():scanPunctuator();}function advance(){var cp,token;if(index>=length){return{type:Token.EOF,lineNumber:lineNumber,lineStart:lineStart,start:index,end:index};}cp=source.charCodeAt(index);if(isIdentifierStart(cp)){token=scanIdentifier();if(strict&&isStrictModeReservedWord(token.value)){token.type=Token.Keyword;}return token;}if(cp===0x28||cp===0x29||cp===0x3B){return scanPunctuator();}if(cp===0x27||cp===0x22){return scanStringLiteral();}if(cp===0x2E){if(isDecimalDigit(source.charCodeAt(index+1))){return scanNumericLiteral();}return scanPunctuator();}if(isDecimalDigit(cp)){return scanNumericLiteral();}if(extra.tokenize&&cp===0x2F){return advanceSlash();}if(cp===0x60||cp===0x7D&&state.curlyStack[state.curlyStack.length-1]==='${'){return scanTemplate();}if(cp>=0xD800&&cp<0xDFFF){cp=codePointAt(index);if(isIdentifierStart(cp)){return scanIdentifier();}}return scanPunctuator();}function collectToken(){var loc,token,value,entry;loc={start:{line:lineNumber,column:index-lineStart}};token=advance();loc.end={line:lineNumber,column:index-lineStart};if(token.type!==Token.EOF){value=source.slice(token.start,token.end);entry={type:TokenName[token.type],value:value,range:[token.start,token.end],loc:loc};if(token.regex){entry.regex={pattern:token.regex.pattern,flags:token.regex.flags};}if(extra.tokenValues){extra.tokenValues.push(entry.type==='Punctuator'||entry.type==='Keyword'?entry.value:null);}if(extra.tokenize){if(!extra.range){delete entry.range;}if(!extra.loc){delete entry.loc;}if(extra.delegate){entry=extra.delegate(entry);}}extra.tokens.push(entry);}return token;}function lex(){var token;scanning=true;lastIndex=index;lastLineNumber=lineNumber;lastLineStart=lineStart;skipComment();token=lookahead;startIndex=index;startLineNumber=lineNumber;startLineStart=lineStart;lookahead=typeof extra.tokens!=='undefined'?collectToken():advance();scanning=false;return token;}function peek(){scanning=true;skipComment();lastIndex=index;lastLineNumber=lineNumber;lastLineStart=lineStart;startIndex=index;startLineNumber=lineNumber;startLineStart=lineStart;lookahead=typeof extra.tokens!=='undefined'?collectToken():advance();scanning=false;}function Position(){this.line=startLineNumber;this.column=startIndex-startLineStart;}function SourceLocation(){this.start=new Position();this.end=null;}function WrappingSourceLocation(startToken){this.start={line:startToken.lineNumber,column:startToken.start-startToken.lineStart};this.end=null;}function Node(){if(extra.range){this.range=[startIndex,0];}if(extra.loc){this.loc=new SourceLocation();}}function WrappingNode(startToken){if(extra.range){this.range=[startToken.start,0];}if(extra.loc){this.loc=new WrappingSourceLocation(startToken);}}WrappingNode.prototype=Node.prototype={processComment:function processComment(){var lastChild,innerComments,leadingComments,trailingComments,bottomRight=extra.bottomRightStack,i,comment,last=bottomRight[bottomRight.length-1];if(this.type===Syntax.Program){if(this.body.length>0){return;}}if(this.type===Syntax.BlockStatement&&this.body.length===0){innerComments=[];for(i=extra.leadingComments.length-1;i>=0;--i){comment=extra.leadingComments[i];if(this.range[1]>=comment.range[1]){innerComments.unshift(comment);extra.leadingComments.splice(i,1);extra.trailingComments.splice(i,1);}}if(innerComments.length){this.innerComments=innerComments;return;}}if(extra.trailingComments.length>0){trailingComments=[];for(i=extra.trailingComments.length-1;i>=0;--i){comment=extra.trailingComments[i];if(comment.range[0]>=this.range[1]){trailingComments.unshift(comment);extra.trailingComments.splice(i,1);}}extra.trailingComments=[];}else{if(last&&last.trailingComments&&last.trailingComments[0].range[0]>=this.range[1]){trailingComments=last.trailingComments;delete last.trailingComments;}}while(last&&last.range[0]>=this.range[0]){lastChild=bottomRight.pop();last=bottomRight[bottomRight.length-1];}if(lastChild){if(lastChild.leadingComments){leadingComments=[];for(i=lastChild.leadingComments.length-1;i>=0;--i){comment=lastChild.leadingComments[i];if(comment.range[1]<=this.range[0]){leadingComments.unshift(comment);lastChild.leadingComments.splice(i,1);}}if(!lastChild.leadingComments.length){lastChild.leadingComments=undefined;}}}else if(extra.leadingComments.length>0){leadingComments=[];for(i=extra.leadingComments.length-1;i>=0;--i){comment=extra.leadingComments[i];if(comment.range[1]<=this.range[0]){leadingComments.unshift(comment);extra.leadingComments.splice(i,1);}}}if(leadingComments&&leadingComments.length>0){this.leadingComments=leadingComments;}if(trailingComments&&trailingComments.length>0){this.trailingComments=trailingComments;}bottomRight.push(this);},finish:function finish(){if(extra.range){this.range[1]=lastIndex;}if(extra.loc){this.loc.end={line:lastLineNumber,column:lastIndex-lastLineStart};if(extra.source){this.loc.source=extra.source;}}if(extra.attachComment){this.processComment();}},finishArrayExpression:function finishArrayExpression(elements){this.type=Syntax.ArrayExpression;this.elements=elements;this.finish();return this;},finishArrayPattern:function finishArrayPattern(elements){this.type=Syntax.ArrayPattern;this.elements=elements;this.finish();return this;},finishArrowFunctionExpression:function finishArrowFunctionExpression(params,defaults,body,expression){this.type=Syntax.ArrowFunctionExpression;this.id=null;this.params=params;this.defaults=defaults;this.body=body;this.generator=false;this.expression=expression;this.finish();return this;},finishAssignmentExpression:function finishAssignmentExpression(operator,left,right){this.type=Syntax.AssignmentExpression;this.operator=operator;this.left=left;this.right=right;this.finish();return this;},finishAssignmentPattern:function finishAssignmentPattern(left,right){this.type=Syntax.AssignmentPattern;this.left=left;this.right=right;this.finish();return this;},finishBinaryExpression:function finishBinaryExpression(operator,left,right){this.type=operator==='||'||operator==='&&'?Syntax.LogicalExpression:Syntax.BinaryExpression;this.operator=operator;this.left=left;this.right=right;this.finish();return this;},finishBlockStatement:function finishBlockStatement(body){this.type=Syntax.BlockStatement;this.body=body;this.finish();return this;},finishBreakStatement:function finishBreakStatement(label){this.type=Syntax.BreakStatement;this.label=label;this.finish();return this;},finishCallExpression:function finishCallExpression(callee,args){this.type=Syntax.CallExpression;this.callee=callee;this.arguments=args;this.finish();return this;},finishCatchClause:function finishCatchClause(param,body){this.type=Syntax.CatchClause;this.param=param;this.body=body;this.finish();return this;},finishClassBody:function finishClassBody(body){this.type=Syntax.ClassBody;this.body=body;this.finish();return this;},finishClassDeclaration:function finishClassDeclaration(id,superClass,body){this.type=Syntax.ClassDeclaration;this.id=id;this.superClass=superClass;this.body=body;this.finish();return this;},finishClassExpression:function finishClassExpression(id,superClass,body){this.type=Syntax.ClassExpression;this.id=id;this.superClass=superClass;this.body=body;this.finish();return this;},finishConditionalExpression:function finishConditionalExpression(test,consequent,alternate){this.type=Syntax.ConditionalExpression;this.test=test;this.consequent=consequent;this.alternate=alternate;this.finish();return this;},finishContinueStatement:function finishContinueStatement(label){this.type=Syntax.ContinueStatement;this.label=label;this.finish();return this;},finishDebuggerStatement:function finishDebuggerStatement(){this.type=Syntax.DebuggerStatement;this.finish();return this;},finishDoWhileStatement:function finishDoWhileStatement(body,test){this.type=Syntax.DoWhileStatement;this.body=body;this.test=test;this.finish();return this;},finishEmptyStatement:function finishEmptyStatement(){this.type=Syntax.EmptyStatement;this.finish();return this;},finishExpressionStatement:function finishExpressionStatement(expression){this.type=Syntax.ExpressionStatement;this.expression=expression;this.finish();return this;},finishForStatement:function finishForStatement(init,test,update,body){this.type=Syntax.ForStatement;this.init=init;this.test=test;this.update=update;this.body=body;this.finish();return this;},finishForOfStatement:function finishForOfStatement(left,right,body){this.type=Syntax.ForOfStatement;this.left=left;this.right=right;this.body=body;this.finish();return this;},finishForInStatement:function finishForInStatement(left,right,body){this.type=Syntax.ForInStatement;this.left=left;this.right=right;this.body=body;this.each=false;this.finish();return this;},finishFunctionDeclaration:function finishFunctionDeclaration(id,params,defaults,body,generator){this.type=Syntax.FunctionDeclaration;this.id=id;this.params=params;this.defaults=defaults;this.body=body;this.generator=generator;this.expression=false;this.finish();return this;},finishFunctionExpression:function finishFunctionExpression(id,params,defaults,body,generator){this.type=Syntax.FunctionExpression;this.id=id;this.params=params;this.defaults=defaults;this.body=body;this.generator=generator;this.expression=false;this.finish();return this;},finishIdentifier:function finishIdentifier(name){this.type=Syntax.Identifier;this.name=name;this.finish();return this;},finishIfStatement:function finishIfStatement(test,consequent,alternate){this.type=Syntax.IfStatement;this.test=test;this.consequent=consequent;this.alternate=alternate;this.finish();return this;},finishLabeledStatement:function finishLabeledStatement(label,body){this.type=Syntax.LabeledStatement;this.label=label;this.body=body;this.finish();return this;},finishLiteral:function finishLiteral(token){this.type=Syntax.Literal;this.value=token.value;this.raw=source.slice(token.start,token.end);if(token.regex){this.regex=token.regex;}this.finish();return this;},finishMemberExpression:function finishMemberExpression(accessor,object,property){this.type=Syntax.MemberExpression;this.computed=accessor==='[';this.object=object;this.property=property;this.finish();return this;},finishMetaProperty:function finishMetaProperty(meta,property){this.type=Syntax.MetaProperty;this.meta=meta;this.property=property;this.finish();return this;},finishNewExpression:function finishNewExpression(callee,args){this.type=Syntax.NewExpression;this.callee=callee;this.arguments=args;this.finish();return this;},finishObjectExpression:function finishObjectExpression(properties){this.type=Syntax.ObjectExpression;this.properties=properties;this.finish();return this;},finishObjectPattern:function finishObjectPattern(properties){this.type=Syntax.ObjectPattern;this.properties=properties;this.finish();return this;},finishPostfixExpression:function finishPostfixExpression(operator,argument){this.type=Syntax.UpdateExpression;this.operator=operator;this.argument=argument;this.prefix=false;this.finish();return this;},finishProgram:function finishProgram(body,sourceType){this.type=Syntax.Program;this.body=body;this.sourceType=sourceType;this.finish();return this;},finishProperty:function finishProperty(kind,key,computed,value,method,shorthand){this.type=Syntax.Property;this.key=key;this.computed=computed;this.value=value;this.kind=kind;this.method=method;this.shorthand=shorthand;this.finish();return this;},finishRestElement:function finishRestElement(argument){this.type=Syntax.RestElement;this.argument=argument;this.finish();return this;},finishReturnStatement:function finishReturnStatement(argument){this.type=Syntax.ReturnStatement;this.argument=argument;this.finish();return this;},finishSequenceExpression:function finishSequenceExpression(expressions){this.type=Syntax.SequenceExpression;this.expressions=expressions;this.finish();return this;},finishSpreadElement:function finishSpreadElement(argument){this.type=Syntax.SpreadElement;this.argument=argument;this.finish();return this;},finishSwitchCase:function finishSwitchCase(test,consequent){this.type=Syntax.SwitchCase;this.test=test;this.consequent=consequent;this.finish();return this;},finishSuper:function finishSuper(){this.type=Syntax.Super;this.finish();return this;},finishSwitchStatement:function finishSwitchStatement(discriminant,cases){this.type=Syntax.SwitchStatement;this.discriminant=discriminant;this.cases=cases;this.finish();return this;},finishTaggedTemplateExpression:function finishTaggedTemplateExpression(tag,quasi){this.type=Syntax.TaggedTemplateExpression;this.tag=tag;this.quasi=quasi;this.finish();return this;},finishTemplateElement:function finishTemplateElement(value,tail){this.type=Syntax.TemplateElement;this.value=value;this.tail=tail;this.finish();return this;},finishTemplateLiteral:function finishTemplateLiteral(quasis,expressions){this.type=Syntax.TemplateLiteral;this.quasis=quasis;this.expressions=expressions;this.finish();return this;},finishThisExpression:function finishThisExpression(){this.type=Syntax.ThisExpression;this.finish();return this;},finishThrowStatement:function finishThrowStatement(argument){this.type=Syntax.ThrowStatement;this.argument=argument;this.finish();return this;},finishTryStatement:function finishTryStatement(block,handler,finalizer){this.type=Syntax.TryStatement;this.block=block;this.guardedHandlers=[];this.handlers=handler?[handler]:[];this.handler=handler;this.finalizer=finalizer;this.finish();return this;},finishUnaryExpression:function finishUnaryExpression(operator,argument){this.type=operator==='++'||operator==='--'?Syntax.UpdateExpression:Syntax.UnaryExpression;this.operator=operator;this.argument=argument;this.prefix=true;this.finish();return this;},finishVariableDeclaration:function finishVariableDeclaration(declarations){this.type=Syntax.VariableDeclaration;this.declarations=declarations;this.kind='var';this.finish();return this;},finishLexicalDeclaration:function finishLexicalDeclaration(declarations,kind){this.type=Syntax.VariableDeclaration;this.declarations=declarations;this.kind=kind;this.finish();return this;},finishVariableDeclarator:function finishVariableDeclarator(id,init){this.type=Syntax.VariableDeclarator;this.id=id;this.init=init;this.finish();return this;},finishWhileStatement:function finishWhileStatement(test,body){this.type=Syntax.WhileStatement;this.test=test;this.body=body;this.finish();return this;},finishWithStatement:function finishWithStatement(object,body){this.type=Syntax.WithStatement;this.object=object;this.body=body;this.finish();return this;},finishExportSpecifier:function finishExportSpecifier(local,exported){this.type=Syntax.ExportSpecifier;this.exported=exported||local;this.local=local;this.finish();return this;},finishImportDefaultSpecifier:function finishImportDefaultSpecifier(local){this.type=Syntax.ImportDefaultSpecifier;this.local=local;this.finish();return this;},finishImportNamespaceSpecifier:function finishImportNamespaceSpecifier(local){this.type=Syntax.ImportNamespaceSpecifier;this.local=local;this.finish();return this;},finishExportNamedDeclaration:function finishExportNamedDeclaration(declaration,specifiers,src){this.type=Syntax.ExportNamedDeclaration;this.declaration=declaration;this.specifiers=specifiers;this.source=src;this.finish();return this;},finishExportDefaultDeclaration:function finishExportDefaultDeclaration(declaration){this.type=Syntax.ExportDefaultDeclaration;this.declaration=declaration;this.finish();return this;},finishExportAllDeclaration:function finishExportAllDeclaration(src){this.type=Syntax.ExportAllDeclaration;this.source=src;this.finish();return this;},finishImportSpecifier:function finishImportSpecifier(local,imported){this.type=Syntax.ImportSpecifier;this.local=local||imported;this.imported=imported;this.finish();return this;},finishImportDeclaration:function finishImportDeclaration(specifiers,src){this.type=Syntax.ImportDeclaration;this.specifiers=specifiers;this.source=src;this.finish();return this;},finishYieldExpression:function finishYieldExpression(argument,delegate){this.type=Syntax.YieldExpression;this.argument=argument;this.delegate=delegate;this.finish();return this;}};function recordError(error){var e,existing;for(e=0;e<extra.errors.length;e++){existing=extra.errors[e];if(existing.index===error.index&&existing.message===error.message){return;}}extra.errors.push(error);}function constructError(msg,column){var error=new Error(msg);try{throw error;}catch(base){if(Object.create&&Object.defineProperty){error=Object.create(base);Object.defineProperty(error,'column',{value:column});}}finally{return error;}}function createError(line,pos,description){var msg,column,error;msg='Line '+line+': '+description;column=pos-(scanning?lineStart:lastLineStart)+1;error=constructError(msg,column);error.lineNumber=line;error.description=description;error.index=pos;return error;}function throwError(messageFormat){var args,msg;args=Array.prototype.slice.call(arguments,1);msg=messageFormat.replace(/%(\d)/g,function(whole,idx){assert(idx<args.length,'Message reference must be in range');return args[idx];});throw createError(lastLineNumber,lastIndex,msg);}function tolerateError(messageFormat){var args,msg,error;args=Array.prototype.slice.call(arguments,1);msg=messageFormat.replace(/%(\d)/g,function(whole,idx){assert(idx<args.length,'Message reference must be in range');return args[idx];});error=createError(lineNumber,lastIndex,msg);if(extra.errors){recordError(error);}else{throw error;}}function unexpectedTokenError(token,message){var value,msg=message||Messages.UnexpectedToken;if(token){if(!message){msg=token.type===Token.EOF?Messages.UnexpectedEOS:token.type===Token.Identifier?Messages.UnexpectedIdentifier:token.type===Token.NumericLiteral?Messages.UnexpectedNumber:token.type===Token.StringLiteral?Messages.UnexpectedString:token.type===Token.Template?Messages.UnexpectedTemplate:Messages.UnexpectedToken;if(token.type===Token.Keyword){if(isFutureReservedWord(token.value)){msg=Messages.UnexpectedReserved;}else if(strict&&isStrictModeReservedWord(token.value)){msg=Messages.StrictReservedWord;}}}value=token.type===Token.Template?token.value.raw:token.value;}else{value='ILLEGAL';}msg=msg.replace('%0',value);return token&&typeof token.lineNumber==='number'?createError(token.lineNumber,token.start,msg):createError(scanning?lineNumber:lastLineNumber,scanning?index:lastIndex,msg);}function throwUnexpectedToken(token,message){throw unexpectedTokenError(token,message);}function tolerateUnexpectedToken(token,message){var error=unexpectedTokenError(token,message);if(extra.errors){recordError(error);}else{throw error;}}function expect(value){var token=lex();if(token.type!==Token.Punctuator||token.value!==value){throwUnexpectedToken(token);}}function expectCommaSeparator(){var token;if(extra.errors){token=lookahead;if(token.type===Token.Punctuator&&token.value===','){lex();}else if(token.type===Token.Punctuator&&token.value===';'){lex();tolerateUnexpectedToken(token);}else{tolerateUnexpectedToken(token,Messages.UnexpectedToken);}}else{expect(',');}}function expectKeyword(keyword){var token=lex();if(token.type!==Token.Keyword||token.value!==keyword){throwUnexpectedToken(token);}}function match(value){return lookahead.type===Token.Punctuator&&lookahead.value===value;}function matchKeyword(keyword){return lookahead.type===Token.Keyword&&lookahead.value===keyword;}function matchContextualKeyword(keyword){return lookahead.type===Token.Identifier&&lookahead.value===keyword;}function matchAssign(){var op;if(lookahead.type!==Token.Punctuator){return false;}op=lookahead.value;return op==='='||op==='*='||op==='/='||op==='%='||op==='+='||op==='-='||op==='<<='||op==='>>='||op==='>>>='||op==='&='||op==='^='||op==='|=';}function consumeSemicolon(){if(source.charCodeAt(startIndex)===0x3B||match(';')){lex();return;}if(hasLineTerminator){return;}lastIndex=startIndex;lastLineNumber=startLineNumber;lastLineStart=startLineStart;if(lookahead.type!==Token.EOF&&!match('}')){throwUnexpectedToken(lookahead);}}function isolateCoverGrammar(parser){var oldIsBindingElement=isBindingElement,oldIsAssignmentTarget=isAssignmentTarget,oldFirstCoverInitializedNameError=firstCoverInitializedNameError,result;isBindingElement=true;isAssignmentTarget=true;firstCoverInitializedNameError=null;result=parser();if(firstCoverInitializedNameError!==null){throwUnexpectedToken(firstCoverInitializedNameError);}isBindingElement=oldIsBindingElement;isAssignmentTarget=oldIsAssignmentTarget;firstCoverInitializedNameError=oldFirstCoverInitializedNameError;return result;}function inheritCoverGrammar(parser){var oldIsBindingElement=isBindingElement,oldIsAssignmentTarget=isAssignmentTarget,oldFirstCoverInitializedNameError=firstCoverInitializedNameError,result;isBindingElement=true;isAssignmentTarget=true;firstCoverInitializedNameError=null;result=parser();isBindingElement=isBindingElement&&oldIsBindingElement;isAssignmentTarget=isAssignmentTarget&&oldIsAssignmentTarget;firstCoverInitializedNameError=oldFirstCoverInitializedNameError||firstCoverInitializedNameError;return result;}function parseArrayPattern(params,kind){var node=new Node(),elements=[],rest,restNode;expect('[');while(!match(']')){if(match(',')){lex();elements.push(null);}else{if(match('...')){restNode=new Node();lex();params.push(lookahead);rest=parseVariableIdentifier(kind);elements.push(restNode.finishRestElement(rest));break;}else{elements.push(parsePatternWithDefault(params,kind));}if(!match(']')){expect(',');}}}expect(']');return node.finishArrayPattern(elements);}function parsePropertyPattern(params,kind){var node=new Node(),key,keyToken,computed=match('['),init;if(lookahead.type===Token.Identifier){keyToken=lookahead;key=parseVariableIdentifier();if(match('=')){params.push(keyToken);lex();init=parseAssignmentExpression();return node.finishProperty('init',key,false,new WrappingNode(keyToken).finishAssignmentPattern(key,init),false,true);}else if(!match(':')){params.push(keyToken);return node.finishProperty('init',key,false,key,false,true);}}else{key=parseObjectPropertyKey();}expect(':');init=parsePatternWithDefault(params,kind);return node.finishProperty('init',key,computed,init,false,false);}function parseObjectPattern(params,kind){var node=new Node(),properties=[];expect('{');while(!match('}')){properties.push(parsePropertyPattern(params,kind));if(!match('}')){expect(',');}}lex();return node.finishObjectPattern(properties);}function parsePattern(params,kind){if(match('[')){return parseArrayPattern(params,kind);}else if(match('{')){return parseObjectPattern(params,kind);}else if(matchKeyword('let')){if(kind==='const'||kind==='let'){tolerateUnexpectedToken(lookahead,Messages.UnexpectedToken);}}params.push(lookahead);return parseVariableIdentifier(kind);}function parsePatternWithDefault(params,kind){var startToken=lookahead,pattern,previousAllowYield,right;pattern=parsePattern(params,kind);if(match('=')){lex();previousAllowYield=state.allowYield;state.allowYield=true;right=isolateCoverGrammar(parseAssignmentExpression);state.allowYield=previousAllowYield;pattern=new WrappingNode(startToken).finishAssignmentPattern(pattern,right);}return pattern;}function parseArrayInitializer(){var elements=[],node=new Node(),restSpread;expect('[');while(!match(']')){if(match(',')){lex();elements.push(null);}else if(match('...')){restSpread=new Node();lex();restSpread.finishSpreadElement(inheritCoverGrammar(parseAssignmentExpression));if(!match(']')){isAssignmentTarget=isBindingElement=false;expect(',');}elements.push(restSpread);}else{elements.push(inheritCoverGrammar(parseAssignmentExpression));if(!match(']')){expect(',');}}}lex();return node.finishArrayExpression(elements);}function parsePropertyFunction(node,paramInfo,isGenerator){var previousStrict,body;isAssignmentTarget=isBindingElement=false;previousStrict=strict;body=isolateCoverGrammar(parseFunctionSourceElements);if(strict&&paramInfo.firstRestricted){tolerateUnexpectedToken(paramInfo.firstRestricted,paramInfo.message);}if(strict&&paramInfo.stricted){tolerateUnexpectedToken(paramInfo.stricted,paramInfo.message);}strict=previousStrict;return node.finishFunctionExpression(null,paramInfo.params,paramInfo.defaults,body,isGenerator);}function parsePropertyMethodFunction(){var params,method,node=new Node(),previousAllowYield=state.allowYield;state.allowYield=false;params=parseParams();state.allowYield=previousAllowYield;state.allowYield=false;method=parsePropertyFunction(node,params,false);state.allowYield=previousAllowYield;return method;}function parseObjectPropertyKey(){var token,node=new Node(),expr;token=lex();switch(token.type){case Token.StringLiteral:case Token.NumericLiteral:if(strict&&token.octal){tolerateUnexpectedToken(token,Messages.StrictOctalLiteral);}return node.finishLiteral(token);case Token.Identifier:case Token.BooleanLiteral:case Token.NullLiteral:case Token.Keyword:return node.finishIdentifier(token.value);case Token.Punctuator:if(token.value==='['){expr=isolateCoverGrammar(parseAssignmentExpression);expect(']');return expr;}break;}throwUnexpectedToken(token);}function lookaheadPropertyName(){switch(lookahead.type){case Token.Identifier:case Token.StringLiteral:case Token.BooleanLiteral:case Token.NullLiteral:case Token.NumericLiteral:case Token.Keyword:return true;case Token.Punctuator:return lookahead.value==='[';}return false;}function tryParseMethodDefinition(token,key,computed,node){var value,options,methodNode,params,previousAllowYield=state.allowYield;if(token.type===Token.Identifier){if(token.value==='get'&&lookaheadPropertyName()){computed=match('[');key=parseObjectPropertyKey();methodNode=new Node();expect('(');expect(')');state.allowYield=false;value=parsePropertyFunction(methodNode,{params:[],defaults:[],stricted:null,firstRestricted:null,message:null},false);state.allowYield=previousAllowYield;return node.finishProperty('get',key,computed,value,false,false);}else if(token.value==='set'&&lookaheadPropertyName()){computed=match('[');key=parseObjectPropertyKey();methodNode=new Node();expect('(');options={params:[],defaultCount:0,defaults:[],firstRestricted:null,paramSet:{}};if(match(')')){tolerateUnexpectedToken(lookahead);}else{state.allowYield=false;parseParam(options);state.allowYield=previousAllowYield;if(options.defaultCount===0){options.defaults=[];}}expect(')');state.allowYield=false;value=parsePropertyFunction(methodNode,options,false);state.allowYield=previousAllowYield;return node.finishProperty('set',key,computed,value,false,false);}}else if(token.type===Token.Punctuator&&token.value==='*'&&lookaheadPropertyName()){computed=match('[');key=parseObjectPropertyKey();methodNode=new Node();state.allowYield=true;params=parseParams();state.allowYield=previousAllowYield;state.allowYield=false;value=parsePropertyFunction(methodNode,params,true);state.allowYield=previousAllowYield;return node.finishProperty('init',key,computed,value,true,false);}if(key&&match('(')){value=parsePropertyMethodFunction();return node.finishProperty('init',key,computed,value,true,false);}return null;}function parseObjectProperty(hasProto){var token=lookahead,node=new Node(),computed,key,maybeMethod,proto,value;computed=match('[');if(match('*')){lex();}else{key=parseObjectPropertyKey();}maybeMethod=tryParseMethodDefinition(token,key,computed,node);if(maybeMethod){return maybeMethod;}if(!key){throwUnexpectedToken(lookahead);}if(!computed){proto=key.type===Syntax.Identifier&&key.name==='__proto__'||key.type===Syntax.Literal&&key.value==='__proto__';if(hasProto.value&&proto){tolerateError(Messages.DuplicateProtoProperty);}hasProto.value|=proto;}if(match(':')){lex();value=inheritCoverGrammar(parseAssignmentExpression);return node.finishProperty('init',key,computed,value,false,false);}if(token.type===Token.Identifier){if(match('=')){firstCoverInitializedNameError=lookahead;lex();value=isolateCoverGrammar(parseAssignmentExpression);return node.finishProperty('init',key,computed,new WrappingNode(token).finishAssignmentPattern(key,value),false,true);}return node.finishProperty('init',key,computed,key,false,true);}throwUnexpectedToken(lookahead);}function parseObjectInitializer(){var properties=[],hasProto={value:false},node=new Node();expect('{');while(!match('}')){properties.push(parseObjectProperty(hasProto));if(!match('}')){expectCommaSeparator();}}expect('}');return node.finishObjectExpression(properties);}function reinterpretExpressionAsPattern(expr){var i;switch(expr.type){case Syntax.Identifier:case Syntax.MemberExpression:case Syntax.RestElement:case Syntax.AssignmentPattern:break;case Syntax.SpreadElement:expr.type=Syntax.RestElement;reinterpretExpressionAsPattern(expr.argument);break;case Syntax.ArrayExpression:expr.type=Syntax.ArrayPattern;for(i=0;i<expr.elements.length;i++){if(expr.elements[i]!==null){reinterpretExpressionAsPattern(expr.elements[i]);}}break;case Syntax.ObjectExpression:expr.type=Syntax.ObjectPattern;for(i=0;i<expr.properties.length;i++){reinterpretExpressionAsPattern(expr.properties[i].value);}break;case Syntax.AssignmentExpression:expr.type=Syntax.AssignmentPattern;reinterpretExpressionAsPattern(expr.left);break;default:break;}}function parseTemplateElement(option){var node,token;if(lookahead.type!==Token.Template||option.head&&!lookahead.head){throwUnexpectedToken();}node=new Node();token=lex();return node.finishTemplateElement({raw:token.value.raw,cooked:token.value.cooked},token.tail);}function parseTemplateLiteral(){var quasi,quasis,expressions,node=new Node();quasi=parseTemplateElement({head:true});quasis=[quasi];expressions=[];while(!quasi.tail){expressions.push(parseExpression());quasi=parseTemplateElement({head:false});quasis.push(quasi);}return node.finishTemplateLiteral(quasis,expressions);}function parseGroupExpression(){var expr,expressions,startToken,i,params=[];expect('(');if(match(')')){lex();if(!match('=>')){expect('=>');}return{type:PlaceHolders.ArrowParameterPlaceHolder,params:[],rawParams:[]};}startToken=lookahead;if(match('...')){expr=parseRestElement(params);expect(')');if(!match('=>')){expect('=>');}return{type:PlaceHolders.ArrowParameterPlaceHolder,params:[expr]};}isBindingElement=true;expr=inheritCoverGrammar(parseAssignmentExpression);if(match(',')){isAssignmentTarget=false;expressions=[expr];while(startIndex<length){if(!match(',')){break;}lex();if(match('...')){if(!isBindingElement){throwUnexpectedToken(lookahead);}expressions.push(parseRestElement(params));expect(')');if(!match('=>')){expect('=>');}isBindingElement=false;for(i=0;i<expressions.length;i++){reinterpretExpressionAsPattern(expressions[i]);}return{type:PlaceHolders.ArrowParameterPlaceHolder,params:expressions};}expressions.push(inheritCoverGrammar(parseAssignmentExpression));}expr=new WrappingNode(startToken).finishSequenceExpression(expressions);}expect(')');if(match('=>')){if(expr.type===Syntax.Identifier&&expr.name==='yield'){return{type:PlaceHolders.ArrowParameterPlaceHolder,params:[expr]};}if(!isBindingElement){throwUnexpectedToken(lookahead);}if(expr.type===Syntax.SequenceExpression){for(i=0;i<expr.expressions.length;i++){reinterpretExpressionAsPattern(expr.expressions[i]);}}else{reinterpretExpressionAsPattern(expr);}expr={type:PlaceHolders.ArrowParameterPlaceHolder,params:expr.type===Syntax.SequenceExpression?expr.expressions:[expr]};}isBindingElement=false;return expr;}function parsePrimaryExpression(){var type,token,expr,node;if(match('(')){isBindingElement=false;return inheritCoverGrammar(parseGroupExpression);}if(match('[')){return inheritCoverGrammar(parseArrayInitializer);}if(match('{')){return inheritCoverGrammar(parseObjectInitializer);}type=lookahead.type;node=new Node();if(type===Token.Identifier){if(state.sourceType==='module'&&lookahead.value==='await'){tolerateUnexpectedToken(lookahead);}expr=node.finishIdentifier(lex().value);}else if(type===Token.StringLiteral||type===Token.NumericLiteral){isAssignmentTarget=isBindingElement=false;if(strict&&lookahead.octal){tolerateUnexpectedToken(lookahead,Messages.StrictOctalLiteral);}expr=node.finishLiteral(lex());}else if(type===Token.Keyword){if(!strict&&state.allowYield&&matchKeyword('yield')){return parseNonComputedProperty();}if(!strict&&matchKeyword('let')){return node.finishIdentifier(lex().value);}isAssignmentTarget=isBindingElement=false;if(matchKeyword('function')){return parseFunctionExpression();}if(matchKeyword('this')){lex();return node.finishThisExpression();}if(matchKeyword('class')){return parseClassExpression();}throwUnexpectedToken(lex());}else if(type===Token.BooleanLiteral){isAssignmentTarget=isBindingElement=false;token=lex();token.value=token.value==='true';expr=node.finishLiteral(token);}else if(type===Token.NullLiteral){isAssignmentTarget=isBindingElement=false;token=lex();token.value=null;expr=node.finishLiteral(token);}else if(match('/')||match('/=')){isAssignmentTarget=isBindingElement=false;index=startIndex;if(typeof extra.tokens!=='undefined'){token=collectRegex();}else{token=scanRegExp();}lex();expr=node.finishLiteral(token);}else if(type===Token.Template){expr=parseTemplateLiteral();}else{throwUnexpectedToken(lex());}return expr;}function parseArguments(){var args=[],expr;expect('(');if(!match(')')){while(startIndex<length){if(match('...')){expr=new Node();lex();expr.finishSpreadElement(isolateCoverGrammar(parseAssignmentExpression));}else{expr=isolateCoverGrammar(parseAssignmentExpression);}args.push(expr);if(match(')')){break;}expectCommaSeparator();}}expect(')');return args;}function parseNonComputedProperty(){var token,node=new Node();token=lex();if(!isIdentifierName(token)){throwUnexpectedToken(token);}return node.finishIdentifier(token.value);}function parseNonComputedMember(){expect('.');return parseNonComputedProperty();}function parseComputedMember(){var expr;expect('[');expr=isolateCoverGrammar(parseExpression);expect(']');return expr;}function parseNewExpression(){var callee,args,node=new Node();expectKeyword('new');if(match('.')){lex();if(lookahead.type===Token.Identifier&&lookahead.value==='target'){if(state.inFunctionBody){lex();return node.finishMetaProperty('new','target');}}throwUnexpectedToken(lookahead);}callee=isolateCoverGrammar(parseLeftHandSideExpression);args=match('(')?parseArguments():[];isAssignmentTarget=isBindingElement=false;return node.finishNewExpression(callee,args);}function parseLeftHandSideExpressionAllowCall(){var quasi,expr,args,property,startToken,previousAllowIn=state.allowIn;startToken=lookahead;state.allowIn=true;if(matchKeyword('super')&&state.inFunctionBody){expr=new Node();lex();expr=expr.finishSuper();if(!match('(')&&!match('.')&&!match('[')){throwUnexpectedToken(lookahead);}}else{expr=inheritCoverGrammar(matchKeyword('new')?parseNewExpression:parsePrimaryExpression);}for(;;){if(match('.')){isBindingElement=false;isAssignmentTarget=true;property=parseNonComputedMember();expr=new WrappingNode(startToken).finishMemberExpression('.',expr,property);}else if(match('(')){isBindingElement=false;isAssignmentTarget=false;args=parseArguments();expr=new WrappingNode(startToken).finishCallExpression(expr,args);}else if(match('[')){isBindingElement=false;isAssignmentTarget=true;property=parseComputedMember();expr=new WrappingNode(startToken).finishMemberExpression('[',expr,property);}else if(lookahead.type===Token.Template&&lookahead.head){quasi=parseTemplateLiteral();expr=new WrappingNode(startToken).finishTaggedTemplateExpression(expr,quasi);}else{break;}}state.allowIn=previousAllowIn;return expr;}function parseLeftHandSideExpression(){var quasi,expr,property,startToken;assert(state.allowIn,'callee of new expression always allow in keyword.');startToken=lookahead;if(matchKeyword('super')&&state.inFunctionBody){expr=new Node();lex();expr=expr.finishSuper();if(!match('[')&&!match('.')){throwUnexpectedToken(lookahead);}}else{expr=inheritCoverGrammar(matchKeyword('new')?parseNewExpression:parsePrimaryExpression);}for(;;){if(match('[')){isBindingElement=false;isAssignmentTarget=true;property=parseComputedMember();expr=new WrappingNode(startToken).finishMemberExpression('[',expr,property);}else if(match('.')){isBindingElement=false;isAssignmentTarget=true;property=parseNonComputedMember();expr=new WrappingNode(startToken).finishMemberExpression('.',expr,property);}else if(lookahead.type===Token.Template&&lookahead.head){quasi=parseTemplateLiteral();expr=new WrappingNode(startToken).finishTaggedTemplateExpression(expr,quasi);}else{break;}}return expr;}function parsePostfixExpression(){var expr,token,startToken=lookahead;expr=inheritCoverGrammar(parseLeftHandSideExpressionAllowCall);if(!hasLineTerminator&&lookahead.type===Token.Punctuator){if(match('++')||match('--')){if(strict&&expr.type===Syntax.Identifier&&isRestrictedWord(expr.name)){tolerateError(Messages.StrictLHSPostfix);}if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInAssignment);}isAssignmentTarget=isBindingElement=false;token=lex();expr=new WrappingNode(startToken).finishPostfixExpression(token.value,expr);}}return expr;}function parseUnaryExpression(){var token,expr,startToken;if(lookahead.type!==Token.Punctuator&&lookahead.type!==Token.Keyword){expr=parsePostfixExpression();}else if(match('++')||match('--')){startToken=lookahead;token=lex();expr=inheritCoverGrammar(parseUnaryExpression);if(strict&&expr.type===Syntax.Identifier&&isRestrictedWord(expr.name)){tolerateError(Messages.StrictLHSPrefix);}if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInAssignment);}expr=new WrappingNode(startToken).finishUnaryExpression(token.value,expr);isAssignmentTarget=isBindingElement=false;}else if(match('+')||match('-')||match('~')||match('!')){startToken=lookahead;token=lex();expr=inheritCoverGrammar(parseUnaryExpression);expr=new WrappingNode(startToken).finishUnaryExpression(token.value,expr);isAssignmentTarget=isBindingElement=false;}else if(matchKeyword('delete')||matchKeyword('void')||matchKeyword('typeof')){startToken=lookahead;token=lex();expr=inheritCoverGrammar(parseUnaryExpression);expr=new WrappingNode(startToken).finishUnaryExpression(token.value,expr);if(strict&&expr.operator==='delete'&&expr.argument.type===Syntax.Identifier){tolerateError(Messages.StrictDelete);}isAssignmentTarget=isBindingElement=false;}else{expr=parsePostfixExpression();}return expr;}function binaryPrecedence(token,allowIn){var prec=0;if(token.type!==Token.Punctuator&&token.type!==Token.Keyword){return 0;}switch(token.value){case'||':prec=1;break;case'&&':prec=2;break;case'|':prec=3;break;case'^':prec=4;break;case'&':prec=5;break;case'==':case'!=':case'===':case'!==':prec=6;break;case'<':case'>':case'<=':case'>=':case'instanceof':prec=7;break;case'in':prec=allowIn?7:0;break;case'<<':case'>>':case'>>>':prec=8;break;case'+':case'-':prec=9;break;case'*':case'/':case'%':prec=11;break;default:break;}return prec;}function parseBinaryExpression(){var marker,markers,expr,token,prec,stack,right,operator,left,i;marker=lookahead;left=inheritCoverGrammar(parseUnaryExpression);token=lookahead;prec=binaryPrecedence(token,state.allowIn);if(prec===0){return left;}isAssignmentTarget=isBindingElement=false;token.prec=prec;lex();markers=[marker,lookahead];right=isolateCoverGrammar(parseUnaryExpression);stack=[left,token,right];while((prec=binaryPrecedence(lookahead,state.allowIn))>0){while(stack.length>2&&prec<=stack[stack.length-2].prec){right=stack.pop();operator=stack.pop().value;left=stack.pop();markers.pop();expr=new WrappingNode(markers[markers.length-1]).finishBinaryExpression(operator,left,right);stack.push(expr);}token=lex();token.prec=prec;stack.push(token);markers.push(lookahead);expr=isolateCoverGrammar(parseUnaryExpression);stack.push(expr);}i=stack.length-1;expr=stack[i];markers.pop();while(i>1){expr=new WrappingNode(markers.pop()).finishBinaryExpression(stack[i-1].value,stack[i-2],expr);i-=2;}return expr;}function parseConditionalExpression(){var expr,previousAllowIn,consequent,alternate,startToken;startToken=lookahead;expr=inheritCoverGrammar(parseBinaryExpression);if(match('?')){lex();previousAllowIn=state.allowIn;state.allowIn=true;consequent=isolateCoverGrammar(parseAssignmentExpression);state.allowIn=previousAllowIn;expect(':');alternate=isolateCoverGrammar(parseAssignmentExpression);expr=new WrappingNode(startToken).finishConditionalExpression(expr,consequent,alternate);isAssignmentTarget=isBindingElement=false;}return expr;}function parseConciseBody(){if(match('{')){return parseFunctionSourceElements();}return isolateCoverGrammar(parseAssignmentExpression);}function checkPatternParam(options,param){var i;switch(param.type){case Syntax.Identifier:validateParam(options,param,param.name);break;case Syntax.RestElement:checkPatternParam(options,param.argument);break;case Syntax.AssignmentPattern:checkPatternParam(options,param.left);break;case Syntax.ArrayPattern:for(i=0;i<param.elements.length;i++){if(param.elements[i]!==null){checkPatternParam(options,param.elements[i]);}}break;case Syntax.YieldExpression:break;default:assert(param.type===Syntax.ObjectPattern,'Invalid type');for(i=0;i<param.properties.length;i++){checkPatternParam(options,param.properties[i].value);}break;}}function reinterpretAsCoverFormalsList(expr){var i,len,param,params,defaults,defaultCount,options,token;defaults=[];defaultCount=0;params=[expr];switch(expr.type){case Syntax.Identifier:break;case PlaceHolders.ArrowParameterPlaceHolder:params=expr.params;break;default:return null;}options={paramSet:{}};for(i=0,len=params.length;i<len;i+=1){param=params[i];switch(param.type){case Syntax.AssignmentPattern:params[i]=param.left;if(param.right.type===Syntax.YieldExpression){if(param.right.argument){throwUnexpectedToken(lookahead);}param.right.type=Syntax.Identifier;param.right.name='yield';delete param.right.argument;delete param.right.delegate;}defaults.push(param.right);++defaultCount;checkPatternParam(options,param.left);break;default:checkPatternParam(options,param);params[i]=param;defaults.push(null);break;}}if(strict||!state.allowYield){for(i=0,len=params.length;i<len;i+=1){param=params[i];if(param.type===Syntax.YieldExpression){throwUnexpectedToken(lookahead);}}}if(options.message===Messages.StrictParamDupe){token=strict?options.stricted:options.firstRestricted;throwUnexpectedToken(token,options.message);}if(defaultCount===0){defaults=[];}return{params:params,defaults:defaults,stricted:options.stricted,firstRestricted:options.firstRestricted,message:options.message};}function parseArrowFunctionExpression(options,node){var previousStrict,previousAllowYield,body;if(hasLineTerminator){tolerateUnexpectedToken(lookahead);}expect('=>');previousStrict=strict;previousAllowYield=state.allowYield;state.allowYield=true;body=parseConciseBody();if(strict&&options.firstRestricted){throwUnexpectedToken(options.firstRestricted,options.message);}if(strict&&options.stricted){tolerateUnexpectedToken(options.stricted,options.message);}strict=previousStrict;state.allowYield=previousAllowYield;return node.finishArrowFunctionExpression(options.params,options.defaults,body,body.type!==Syntax.BlockStatement);}function parseYieldExpression(){var argument,expr,delegate,previousAllowYield;argument=null;expr=new Node();delegate=false;expectKeyword('yield');if(!hasLineTerminator){previousAllowYield=state.allowYield;state.allowYield=false;delegate=match('*');if(delegate){lex();argument=parseAssignmentExpression();}else{if(!match(';')&&!match('}')&&!match(')')&&lookahead.type!==Token.EOF){argument=parseAssignmentExpression();}}state.allowYield=previousAllowYield;}return expr.finishYieldExpression(argument,delegate);}function parseAssignmentExpression(){var token,expr,right,list,startToken;startToken=lookahead;token=lookahead;if(!state.allowYield&&matchKeyword('yield')){return parseYieldExpression();}expr=parseConditionalExpression();if(expr.type===PlaceHolders.ArrowParameterPlaceHolder||match('=>')){isAssignmentTarget=isBindingElement=false;list=reinterpretAsCoverFormalsList(expr);if(list){firstCoverInitializedNameError=null;return parseArrowFunctionExpression(list,new WrappingNode(startToken));}return expr;}if(matchAssign()){if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInAssignment);}if(strict&&expr.type===Syntax.Identifier){if(isRestrictedWord(expr.name)){tolerateUnexpectedToken(token,Messages.StrictLHSAssignment);}if(isStrictModeReservedWord(expr.name)){tolerateUnexpectedToken(token,Messages.StrictReservedWord);}}if(!match('=')){isAssignmentTarget=isBindingElement=false;}else{reinterpretExpressionAsPattern(expr);}token=lex();right=isolateCoverGrammar(parseAssignmentExpression);expr=new WrappingNode(startToken).finishAssignmentExpression(token.value,expr,right);firstCoverInitializedNameError=null;}return expr;}function parseExpression(){var expr,startToken=lookahead,expressions;expr=isolateCoverGrammar(parseAssignmentExpression);if(match(',')){expressions=[expr];while(startIndex<length){if(!match(',')){break;}lex();expressions.push(isolateCoverGrammar(parseAssignmentExpression));}expr=new WrappingNode(startToken).finishSequenceExpression(expressions);}return expr;}function parseStatementListItem(){if(lookahead.type===Token.Keyword){switch(lookahead.value){case'export':if(state.sourceType!=='module'){tolerateUnexpectedToken(lookahead,Messages.IllegalExportDeclaration);}return parseExportDeclaration();case'import':if(state.sourceType!=='module'){tolerateUnexpectedToken(lookahead,Messages.IllegalImportDeclaration);}return parseImportDeclaration();case'const':return parseLexicalDeclaration({inFor:false});case'function':return parseFunctionDeclaration(new Node());case'class':return parseClassDeclaration();}}if(matchKeyword('let')&&isLexicalDeclaration()){return parseLexicalDeclaration({inFor:false});}return parseStatement();}function parseStatementList(){var list=[];while(startIndex<length){if(match('}')){break;}list.push(parseStatementListItem());}return list;}function parseBlock(){var block,node=new Node();expect('{');block=parseStatementList();expect('}');return node.finishBlockStatement(block);}function parseVariableIdentifier(kind){var token,node=new Node();token=lex();if(token.type===Token.Keyword&&token.value==='yield'){if(strict){tolerateUnexpectedToken(token,Messages.StrictReservedWord);}if(!state.allowYield){throwUnexpectedToken(token);}}else if(token.type!==Token.Identifier){if(strict&&token.type===Token.Keyword&&isStrictModeReservedWord(token.value)){tolerateUnexpectedToken(token,Messages.StrictReservedWord);}else{if(strict||token.value!=='let'||kind!=='var'){throwUnexpectedToken(token);}}}else if(state.sourceType==='module'&&token.type===Token.Identifier&&token.value==='await'){tolerateUnexpectedToken(token);}return node.finishIdentifier(token.value);}function parseVariableDeclaration(options){var init=null,id,node=new Node(),params=[];id=parsePattern(params,'var');if(strict&&isRestrictedWord(id.name)){tolerateError(Messages.StrictVarName);}if(match('=')){lex();init=isolateCoverGrammar(parseAssignmentExpression);}else if(id.type!==Syntax.Identifier&&!options.inFor){expect('=');}return node.finishVariableDeclarator(id,init);}function parseVariableDeclarationList(options){var opt,list;opt={inFor:options.inFor};list=[parseVariableDeclaration(opt)];while(match(',')){lex();list.push(parseVariableDeclaration(opt));}return list;}function parseVariableStatement(node){var declarations;expectKeyword('var');declarations=parseVariableDeclarationList({inFor:false});consumeSemicolon();return node.finishVariableDeclaration(declarations);}function parseLexicalBinding(kind,options){var init=null,id,node=new Node(),params=[];id=parsePattern(params,kind);if(strict&&id.type===Syntax.Identifier&&isRestrictedWord(id.name)){tolerateError(Messages.StrictVarName);}if(kind==='const'){if(!matchKeyword('in')&&!matchContextualKeyword('of')){expect('=');init=isolateCoverGrammar(parseAssignmentExpression);}}else if(!options.inFor&&id.type!==Syntax.Identifier||match('=')){expect('=');init=isolateCoverGrammar(parseAssignmentExpression);}return node.finishVariableDeclarator(id,init);}function parseBindingList(kind,options){var list=[parseLexicalBinding(kind,options)];while(match(',')){lex();list.push(parseLexicalBinding(kind,options));}return list;}function tokenizerState(){return{index:index,lineNumber:lineNumber,lineStart:lineStart,hasLineTerminator:hasLineTerminator,lastIndex:lastIndex,lastLineNumber:lastLineNumber,lastLineStart:lastLineStart,startIndex:startIndex,startLineNumber:startLineNumber,startLineStart:startLineStart,lookahead:lookahead,tokenCount:extra.tokens?extra.tokens.length:0};}function resetTokenizerState(ts){index=ts.index;lineNumber=ts.lineNumber;lineStart=ts.lineStart;hasLineTerminator=ts.hasLineTerminator;lastIndex=ts.lastIndex;lastLineNumber=ts.lastLineNumber;lastLineStart=ts.lastLineStart;startIndex=ts.startIndex;startLineNumber=ts.startLineNumber;startLineStart=ts.startLineStart;lookahead=ts.lookahead;if(extra.tokens){extra.tokens.splice(ts.tokenCount,extra.tokens.length);}}function isLexicalDeclaration(){var lexical,ts;ts=tokenizerState();lex();lexical=lookahead.type===Token.Identifier||match('[')||match('{')||matchKeyword('let')||matchKeyword('yield');resetTokenizerState(ts);return lexical;}function parseLexicalDeclaration(options){var kind,declarations,node=new Node();kind=lex().value;assert(kind==='let'||kind==='const','Lexical declaration must be either let or const');declarations=parseBindingList(kind,options);consumeSemicolon();return node.finishLexicalDeclaration(declarations,kind);}function parseRestElement(params){var param,node=new Node();lex();if(match('{')){throwError(Messages.ObjectPatternAsRestParameter);}params.push(lookahead);param=parseVariableIdentifier();if(match('=')){throwError(Messages.DefaultRestParameter);}if(!match(')')){throwError(Messages.ParameterAfterRestParameter);}return node.finishRestElement(param);}function parseEmptyStatement(node){expect(';');return node.finishEmptyStatement();}function parseExpressionStatement(node){var expr=parseExpression();consumeSemicolon();return node.finishExpressionStatement(expr);}function parseIfStatement(node){var test,consequent,alternate;expectKeyword('if');expect('(');test=parseExpression();expect(')');consequent=parseStatement();if(matchKeyword('else')){lex();alternate=parseStatement();}else{alternate=null;}return node.finishIfStatement(test,consequent,alternate);}function parseDoWhileStatement(node){var body,test,oldInIteration;expectKeyword('do');oldInIteration=state.inIteration;state.inIteration=true;body=parseStatement();state.inIteration=oldInIteration;expectKeyword('while');expect('(');test=parseExpression();expect(')');if(match(';')){lex();}return node.finishDoWhileStatement(body,test);}function parseWhileStatement(node){var test,body,oldInIteration;expectKeyword('while');expect('(');test=parseExpression();expect(')');oldInIteration=state.inIteration;state.inIteration=true;body=parseStatement();state.inIteration=oldInIteration;return node.finishWhileStatement(test,body);}function parseForStatement(node){var init,forIn,initSeq,initStartToken,test,update,left,right,kind,declarations,body,oldInIteration,previousAllowIn=state.allowIn;init=test=update=null;forIn=true;expectKeyword('for');expect('(');if(match(';')){lex();}else{if(matchKeyword('var')){init=new Node();lex();state.allowIn=false;declarations=parseVariableDeclarationList({inFor:true});state.allowIn=previousAllowIn;if(declarations.length===1&&matchKeyword('in')){init=init.finishVariableDeclaration(declarations);lex();left=init;right=parseExpression();init=null;}else if(declarations.length===1&&declarations[0].init===null&&matchContextualKeyword('of')){init=init.finishVariableDeclaration(declarations);lex();left=init;right=parseAssignmentExpression();init=null;forIn=false;}else{init=init.finishVariableDeclaration(declarations);expect(';');}}else if(matchKeyword('const')||matchKeyword('let')){init=new Node();kind=lex().value;if(!strict&&lookahead.value==='in'){init=init.finishIdentifier(kind);lex();left=init;right=parseExpression();init=null;}else{state.allowIn=false;declarations=parseBindingList(kind,{inFor:true});state.allowIn=previousAllowIn;if(declarations.length===1&&declarations[0].init===null&&matchKeyword('in')){init=init.finishLexicalDeclaration(declarations,kind);lex();left=init;right=parseExpression();init=null;}else if(declarations.length===1&&declarations[0].init===null&&matchContextualKeyword('of')){init=init.finishLexicalDeclaration(declarations,kind);lex();left=init;right=parseAssignmentExpression();init=null;forIn=false;}else{consumeSemicolon();init=init.finishLexicalDeclaration(declarations,kind);}}}else{initStartToken=lookahead;state.allowIn=false;init=inheritCoverGrammar(parseAssignmentExpression);state.allowIn=previousAllowIn;if(matchKeyword('in')){if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInForIn);}lex();reinterpretExpressionAsPattern(init);left=init;right=parseExpression();init=null;}else if(matchContextualKeyword('of')){if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInForLoop);}lex();reinterpretExpressionAsPattern(init);left=init;right=parseAssignmentExpression();init=null;forIn=false;}else{if(match(',')){initSeq=[init];while(match(',')){lex();initSeq.push(isolateCoverGrammar(parseAssignmentExpression));}init=new WrappingNode(initStartToken).finishSequenceExpression(initSeq);}expect(';');}}}if(typeof left==='undefined'){if(!match(';')){test=parseExpression();}expect(';');if(!match(')')){update=parseExpression();}}expect(')');oldInIteration=state.inIteration;state.inIteration=true;body=isolateCoverGrammar(parseStatement);state.inIteration=oldInIteration;return typeof left==='undefined'?node.finishForStatement(init,test,update,body):forIn?node.finishForInStatement(left,right,body):node.finishForOfStatement(left,right,body);}function parseContinueStatement(node){var label=null,key;expectKeyword('continue');if(source.charCodeAt(startIndex)===0x3B){lex();if(!state.inIteration){throwError(Messages.IllegalContinue);}return node.finishContinueStatement(null);}if(hasLineTerminator){if(!state.inIteration){throwError(Messages.IllegalContinue);}return node.finishContinueStatement(null);}if(lookahead.type===Token.Identifier){label=parseVariableIdentifier();key='$'+label.name;if(!Object.prototype.hasOwnProperty.call(state.labelSet,key)){throwError(Messages.UnknownLabel,label.name);}}consumeSemicolon();if(label===null&&!state.inIteration){throwError(Messages.IllegalContinue);}return node.finishContinueStatement(label);}function parseBreakStatement(node){var label=null,key;expectKeyword('break');if(source.charCodeAt(lastIndex)===0x3B){lex();if(!(state.inIteration||state.inSwitch)){throwError(Messages.IllegalBreak);}return node.finishBreakStatement(null);}if(hasLineTerminator){if(!(state.inIteration||state.inSwitch)){throwError(Messages.IllegalBreak);}}else if(lookahead.type===Token.Identifier){label=parseVariableIdentifier();key='$'+label.name;if(!Object.prototype.hasOwnProperty.call(state.labelSet,key)){throwError(Messages.UnknownLabel,label.name);}}consumeSemicolon();if(label===null&&!(state.inIteration||state.inSwitch)){throwError(Messages.IllegalBreak);}return node.finishBreakStatement(label);}function parseReturnStatement(node){var argument=null;expectKeyword('return');if(!state.inFunctionBody){tolerateError(Messages.IllegalReturn);}if(source.charCodeAt(lastIndex)===0x20){if(isIdentifierStart(source.charCodeAt(lastIndex+1))){argument=parseExpression();consumeSemicolon();return node.finishReturnStatement(argument);}}if(hasLineTerminator){return node.finishReturnStatement(null);}if(!match(';')){if(!match('}')&&lookahead.type!==Token.EOF){argument=parseExpression();}}consumeSemicolon();return node.finishReturnStatement(argument);}function parseWithStatement(node){var object,body;if(strict){tolerateError(Messages.StrictModeWith);}expectKeyword('with');expect('(');object=parseExpression();expect(')');body=parseStatement();return node.finishWithStatement(object,body);}function parseSwitchCase(){var test,consequent=[],statement,node=new Node();if(matchKeyword('default')){lex();test=null;}else{expectKeyword('case');test=parseExpression();}expect(':');while(startIndex<length){if(match('}')||matchKeyword('default')||matchKeyword('case')){break;}statement=parseStatementListItem();consequent.push(statement);}return node.finishSwitchCase(test,consequent);}function parseSwitchStatement(node){var discriminant,cases,clause,oldInSwitch,defaultFound;expectKeyword('switch');expect('(');discriminant=parseExpression();expect(')');expect('{');cases=[];if(match('}')){lex();return node.finishSwitchStatement(discriminant,cases);}oldInSwitch=state.inSwitch;state.inSwitch=true;defaultFound=false;while(startIndex<length){if(match('}')){break;}clause=parseSwitchCase();if(clause.test===null){if(defaultFound){throwError(Messages.MultipleDefaultsInSwitch);}defaultFound=true;}cases.push(clause);}state.inSwitch=oldInSwitch;expect('}');return node.finishSwitchStatement(discriminant,cases);}function parseThrowStatement(node){var argument;expectKeyword('throw');if(hasLineTerminator){throwError(Messages.NewlineAfterThrow);}argument=parseExpression();consumeSemicolon();return node.finishThrowStatement(argument);}function parseCatchClause(){var param,params=[],paramMap={},key,i,body,node=new Node();expectKeyword('catch');expect('(');if(match(')')){throwUnexpectedToken(lookahead);}param=parsePattern(params);for(i=0;i<params.length;i++){key='$'+params[i].value;if(Object.prototype.hasOwnProperty.call(paramMap,key)){tolerateError(Messages.DuplicateBinding,params[i].value);}paramMap[key]=true;}if(strict&&isRestrictedWord(param.name)){tolerateError(Messages.StrictCatchVariable);}expect(')');body=parseBlock();return node.finishCatchClause(param,body);}function parseTryStatement(node){var block,handler=null,finalizer=null;expectKeyword('try');block=parseBlock();if(matchKeyword('catch')){handler=parseCatchClause();}if(matchKeyword('finally')){lex();finalizer=parseBlock();}if(!handler&&!finalizer){throwError(Messages.NoCatchOrFinally);}return node.finishTryStatement(block,handler,finalizer);}function parseDebuggerStatement(node){expectKeyword('debugger');consumeSemicolon();return node.finishDebuggerStatement();}function parseStatement(){var type=lookahead.type,expr,labeledBody,key,node;if(type===Token.EOF){throwUnexpectedToken(lookahead);}if(type===Token.Punctuator&&lookahead.value==='{'){return parseBlock();}isAssignmentTarget=isBindingElement=true;node=new Node();if(type===Token.Punctuator){switch(lookahead.value){case';':return parseEmptyStatement(node);case'(':return parseExpressionStatement(node);default:break;}}else if(type===Token.Keyword){switch(lookahead.value){case'break':return parseBreakStatement(node);case'continue':return parseContinueStatement(node);case'debugger':return parseDebuggerStatement(node);case'do':return parseDoWhileStatement(node);case'for':return parseForStatement(node);case'function':return parseFunctionDeclaration(node);case'if':return parseIfStatement(node);case'return':return parseReturnStatement(node);case'switch':return parseSwitchStatement(node);case'throw':return parseThrowStatement(node);case'try':return parseTryStatement(node);case'var':return parseVariableStatement(node);case'while':return parseWhileStatement(node);case'with':return parseWithStatement(node);default:break;}}expr=parseExpression();if(expr.type===Syntax.Identifier&&match(':')){lex();key='$'+expr.name;if(Object.prototype.hasOwnProperty.call(state.labelSet,key)){throwError(Messages.Redeclaration,'Label',expr.name);}state.labelSet[key]=true;labeledBody=parseStatement();delete state.labelSet[key];return node.finishLabeledStatement(expr,labeledBody);}consumeSemicolon();return node.finishExpressionStatement(expr);}function parseFunctionSourceElements(){var statement,body=[],token,directive,firstRestricted,oldLabelSet,oldInIteration,oldInSwitch,oldInFunctionBody,node=new Node();expect('{');while(startIndex<length){if(lookahead.type!==Token.StringLiteral){break;}token=lookahead;statement=parseStatementListItem();body.push(statement);if(statement.expression.type!==Syntax.Literal){break;}directive=source.slice(token.start+1,token.end-1);if(directive==='use strict'){strict=true;if(firstRestricted){tolerateUnexpectedToken(firstRestricted,Messages.StrictOctalLiteral);}}else{if(!firstRestricted&&token.octal){firstRestricted=token;}}}oldLabelSet=state.labelSet;oldInIteration=state.inIteration;oldInSwitch=state.inSwitch;oldInFunctionBody=state.inFunctionBody;state.labelSet={};state.inIteration=false;state.inSwitch=false;state.inFunctionBody=true;while(startIndex<length){if(match('}')){break;}body.push(parseStatementListItem());}expect('}');state.labelSet=oldLabelSet;state.inIteration=oldInIteration;state.inSwitch=oldInSwitch;state.inFunctionBody=oldInFunctionBody;return node.finishBlockStatement(body);}function validateParam(options,param,name){var key='$'+name;if(strict){if(isRestrictedWord(name)){options.stricted=param;options.message=Messages.StrictParamName;}if(Object.prototype.hasOwnProperty.call(options.paramSet,key)){options.stricted=param;options.message=Messages.StrictParamDupe;}}else if(!options.firstRestricted){if(isRestrictedWord(name)){options.firstRestricted=param;options.message=Messages.StrictParamName;}else if(isStrictModeReservedWord(name)){options.firstRestricted=param;options.message=Messages.StrictReservedWord;}else if(Object.prototype.hasOwnProperty.call(options.paramSet,key)){options.stricted=param;options.message=Messages.StrictParamDupe;}}options.paramSet[key]=true;}function parseParam(options){var token,param,params=[],i,def;token=lookahead;if(token.value==='...'){param=parseRestElement(params);validateParam(options,param.argument,param.argument.name);options.params.push(param);options.defaults.push(null);return false;}param=parsePatternWithDefault(params);for(i=0;i<params.length;i++){validateParam(options,params[i],params[i].value);}if(param.type===Syntax.AssignmentPattern){def=param.right;param=param.left;++options.defaultCount;}options.params.push(param);options.defaults.push(def);return!match(')');}function parseParams(firstRestricted){var options;options={params:[],defaultCount:0,defaults:[],firstRestricted:firstRestricted};expect('(');if(!match(')')){options.paramSet={};while(startIndex<length){if(!parseParam(options)){break;}expect(',');}}expect(')');if(options.defaultCount===0){options.defaults=[];}return{params:options.params,defaults:options.defaults,stricted:options.stricted,firstRestricted:options.firstRestricted,message:options.message};}function parseFunctionDeclaration(node,identifierIsOptional){var id=null,params=[],defaults=[],body,token,stricted,tmp,firstRestricted,message,previousStrict,isGenerator,previousAllowYield;previousAllowYield=state.allowYield;expectKeyword('function');isGenerator=match('*');if(isGenerator){lex();}if(!identifierIsOptional||!match('(')){token=lookahead;id=parseVariableIdentifier();if(strict){if(isRestrictedWord(token.value)){tolerateUnexpectedToken(token,Messages.StrictFunctionName);}}else{if(isRestrictedWord(token.value)){firstRestricted=token;message=Messages.StrictFunctionName;}else if(isStrictModeReservedWord(token.value)){firstRestricted=token;message=Messages.StrictReservedWord;}}}state.allowYield=!isGenerator;tmp=parseParams(firstRestricted);params=tmp.params;defaults=tmp.defaults;stricted=tmp.stricted;firstRestricted=tmp.firstRestricted;if(tmp.message){message=tmp.message;}previousStrict=strict;body=parseFunctionSourceElements();if(strict&&firstRestricted){throwUnexpectedToken(firstRestricted,message);}if(strict&&stricted){tolerateUnexpectedToken(stricted,message);}strict=previousStrict;state.allowYield=previousAllowYield;return node.finishFunctionDeclaration(id,params,defaults,body,isGenerator);}function parseFunctionExpression(){var token,id=null,stricted,firstRestricted,message,tmp,params=[],defaults=[],body,previousStrict,node=new Node(),isGenerator,previousAllowYield;previousAllowYield=state.allowYield;expectKeyword('function');isGenerator=match('*');if(isGenerator){lex();}state.allowYield=!isGenerator;if(!match('(')){token=lookahead;id=!strict&&!isGenerator&&matchKeyword('yield')?parseNonComputedProperty():parseVariableIdentifier();if(strict){if(isRestrictedWord(token.value)){tolerateUnexpectedToken(token,Messages.StrictFunctionName);}}else{if(isRestrictedWord(token.value)){firstRestricted=token;message=Messages.StrictFunctionName;}else if(isStrictModeReservedWord(token.value)){firstRestricted=token;message=Messages.StrictReservedWord;}}}tmp=parseParams(firstRestricted);params=tmp.params;defaults=tmp.defaults;stricted=tmp.stricted;firstRestricted=tmp.firstRestricted;if(tmp.message){message=tmp.message;}previousStrict=strict;body=parseFunctionSourceElements();if(strict&&firstRestricted){throwUnexpectedToken(firstRestricted,message);}if(strict&&stricted){tolerateUnexpectedToken(stricted,message);}strict=previousStrict;state.allowYield=previousAllowYield;return node.finishFunctionExpression(id,params,defaults,body,isGenerator);}function parseClassBody(){var classBody,token,isStatic,hasConstructor=false,body,method,computed,key;classBody=new Node();expect('{');body=[];while(!match('}')){if(match(';')){lex();}else{method=new Node();token=lookahead;isStatic=false;computed=match('[');if(match('*')){lex();}else{key=parseObjectPropertyKey();if(key.name==='static'&&(lookaheadPropertyName()||match('*'))){token=lookahead;isStatic=true;computed=match('[');if(match('*')){lex();}else{key=parseObjectPropertyKey();}}}method=tryParseMethodDefinition(token,key,computed,method);if(method){method['static']=isStatic;if(method.kind==='init'){method.kind='method';}if(!isStatic){if(!method.computed&&(method.key.name||method.key.value.toString())==='constructor'){if(method.kind!=='method'||!method.method||method.value.generator){throwUnexpectedToken(token,Messages.ConstructorSpecialMethod);}if(hasConstructor){throwUnexpectedToken(token,Messages.DuplicateConstructor);}else{hasConstructor=true;}method.kind='constructor';}}else{if(!method.computed&&(method.key.name||method.key.value.toString())==='prototype'){throwUnexpectedToken(token,Messages.StaticPrototype);}}method.type=Syntax.MethodDefinition;delete method.method;delete method.shorthand;body.push(method);}else{throwUnexpectedToken(lookahead);}}}lex();return classBody.finishClassBody(body);}function parseClassDeclaration(identifierIsOptional){var id=null,superClass=null,classNode=new Node(),classBody,previousStrict=strict;strict=true;expectKeyword('class');if(!identifierIsOptional||lookahead.type===Token.Identifier){id=parseVariableIdentifier();}if(matchKeyword('extends')){lex();superClass=isolateCoverGrammar(parseLeftHandSideExpressionAllowCall);}classBody=parseClassBody();strict=previousStrict;return classNode.finishClassDeclaration(id,superClass,classBody);}function parseClassExpression(){var id=null,superClass=null,classNode=new Node(),classBody,previousStrict=strict;strict=true;expectKeyword('class');if(lookahead.type===Token.Identifier){id=parseVariableIdentifier();}if(matchKeyword('extends')){lex();superClass=isolateCoverGrammar(parseLeftHandSideExpressionAllowCall);}classBody=parseClassBody();strict=previousStrict;return classNode.finishClassExpression(id,superClass,classBody);}function parseModuleSpecifier(){var node=new Node();if(lookahead.type!==Token.StringLiteral){throwError(Messages.InvalidModuleSpecifier);}return node.finishLiteral(lex());}function parseExportSpecifier(){var exported,local,node=new Node(),def;if(matchKeyword('default')){def=new Node();lex();local=def.finishIdentifier('default');}else{local=parseVariableIdentifier();}if(matchContextualKeyword('as')){lex();exported=parseNonComputedProperty();}return node.finishExportSpecifier(local,exported);}function parseExportNamedDeclaration(node){var declaration=null,isExportFromIdentifier,src=null,specifiers=[];if(lookahead.type===Token.Keyword){switch(lookahead.value){case'let':case'const':declaration=parseLexicalDeclaration({inFor:false});return node.finishExportNamedDeclaration(declaration,specifiers,null);case'var':case'class':case'function':declaration=parseStatementListItem();return node.finishExportNamedDeclaration(declaration,specifiers,null);}}expect('{');while(!match('}')){isExportFromIdentifier=isExportFromIdentifier||matchKeyword('default');specifiers.push(parseExportSpecifier());if(!match('}')){expect(',');if(match('}')){break;}}}expect('}');if(matchContextualKeyword('from')){lex();src=parseModuleSpecifier();consumeSemicolon();}else if(isExportFromIdentifier){throwError(lookahead.value?Messages.UnexpectedToken:Messages.MissingFromClause,lookahead.value);}else{consumeSemicolon();}return node.finishExportNamedDeclaration(declaration,specifiers,src);}function parseExportDefaultDeclaration(node){var declaration=null,expression=null;expectKeyword('default');if(matchKeyword('function')){declaration=parseFunctionDeclaration(new Node(),true);return node.finishExportDefaultDeclaration(declaration);}if(matchKeyword('class')){declaration=parseClassDeclaration(true);return node.finishExportDefaultDeclaration(declaration);}if(matchContextualKeyword('from')){throwError(Messages.UnexpectedToken,lookahead.value);}if(match('{')){expression=parseObjectInitializer();}else if(match('[')){expression=parseArrayInitializer();}else{expression=parseAssignmentExpression();}consumeSemicolon();return node.finishExportDefaultDeclaration(expression);}function parseExportAllDeclaration(node){var src;expect('*');if(!matchContextualKeyword('from')){throwError(lookahead.value?Messages.UnexpectedToken:Messages.MissingFromClause,lookahead.value);}lex();src=parseModuleSpecifier();consumeSemicolon();return node.finishExportAllDeclaration(src);}function parseExportDeclaration(){var node=new Node();if(state.inFunctionBody){throwError(Messages.IllegalExportDeclaration);}expectKeyword('export');if(matchKeyword('default')){return parseExportDefaultDeclaration(node);}if(match('*')){return parseExportAllDeclaration(node);}return parseExportNamedDeclaration(node);}function parseImportSpecifier(){var local,imported,node=new Node();imported=parseNonComputedProperty();if(matchContextualKeyword('as')){lex();local=parseVariableIdentifier();}return node.finishImportSpecifier(local,imported);}function parseNamedImports(){var specifiers=[];expect('{');while(!match('}')){specifiers.push(parseImportSpecifier());if(!match('}')){expect(',');if(match('}')){break;}}}expect('}');return specifiers;}function parseImportDefaultSpecifier(){var local,node=new Node();local=parseNonComputedProperty();return node.finishImportDefaultSpecifier(local);}function parseImportNamespaceSpecifier(){var local,node=new Node();expect('*');if(!matchContextualKeyword('as')){throwError(Messages.NoAsAfterImportNamespace);}lex();local=parseNonComputedProperty();return node.finishImportNamespaceSpecifier(local);}function parseImportDeclaration(){var specifiers=[],src,node=new Node();if(state.inFunctionBody){throwError(Messages.IllegalImportDeclaration);}expectKeyword('import');if(lookahead.type===Token.StringLiteral){src=parseModuleSpecifier();}else{if(match('{')){specifiers=specifiers.concat(parseNamedImports());}else if(match('*')){specifiers.push(parseImportNamespaceSpecifier());}else if(isIdentifierName(lookahead)&&!matchKeyword('default')){specifiers.push(parseImportDefaultSpecifier());if(match(',')){lex();if(match('*')){specifiers.push(parseImportNamespaceSpecifier());}else if(match('{')){specifiers=specifiers.concat(parseNamedImports());}else{throwUnexpectedToken(lookahead);}}}else{throwUnexpectedToken(lex());}if(!matchContextualKeyword('from')){throwError(lookahead.value?Messages.UnexpectedToken:Messages.MissingFromClause,lookahead.value);}lex();src=parseModuleSpecifier();}consumeSemicolon();return node.finishImportDeclaration(specifiers,src);}function parseScriptBody(){var statement,body=[],token,directive,firstRestricted;while(startIndex<length){token=lookahead;if(token.type!==Token.StringLiteral){break;}statement=parseStatementListItem();body.push(statement);if(statement.expression.type!==Syntax.Literal){break;}directive=source.slice(token.start+1,token.end-1);if(directive==='use strict'){strict=true;if(firstRestricted){tolerateUnexpectedToken(firstRestricted,Messages.StrictOctalLiteral);}}else{if(!firstRestricted&&token.octal){firstRestricted=token;}}}while(startIndex<length){statement=parseStatementListItem();if(typeof statement==='undefined'){break;}body.push(statement);}return body;}function parseProgram(){var body,node;peek();node=new Node();body=parseScriptBody();return node.finishProgram(body,state.sourceType);}function filterTokenLocation(){var i,entry,token,tokens=[];for(i=0;i<extra.tokens.length;++i){entry=extra.tokens[i];token={type:entry.type,value:entry.value};if(entry.regex){token.regex={pattern:entry.regex.pattern,flags:entry.regex.flags};}if(extra.range){token.range=entry.range;}if(extra.loc){token.loc=entry.loc;}tokens.push(token);}extra.tokens=tokens;}function tokenize(code,options,delegate){var toString,tokens;toString=String;if(typeof code!=='string'&&!(code instanceof String)){code=toString(code);}source=code;index=0;lineNumber=source.length>0?1:0;lineStart=0;startIndex=index;startLineNumber=lineNumber;startLineStart=lineStart;length=source.length;lookahead=null;state={allowIn:true,allowYield:true,labelSet:{},inFunctionBody:false,inIteration:false,inSwitch:false,lastCommentStart:-1,curlyStack:[]};extra={};options=options||{};options.tokens=true;extra.tokens=[];extra.tokenValues=[];extra.tokenize=true;extra.delegate=delegate;extra.openParenToken=-1;extra.openCurlyToken=-1;extra.range=typeof options.range==='boolean'&&options.range;extra.loc=typeof options.loc==='boolean'&&options.loc;if(typeof options.comment==='boolean'&&options.comment){extra.comments=[];}if(typeof options.tolerant==='boolean'&&options.tolerant){extra.errors=[];}try{peek();if(lookahead.type===Token.EOF){return extra.tokens;}lex();while(lookahead.type!==Token.EOF){try{lex();}catch(lexError){if(extra.errors){recordError(lexError);break;}else{throw lexError;}}}tokens=extra.tokens;if(typeof extra.errors!=='undefined'){tokens.errors=extra.errors;}}catch(e){throw e;}finally{extra={};}return tokens;}function parse(code,options){var program,toString;toString=String;if(typeof code!=='string'&&!(code instanceof String)){code=toString(code);}source=code;index=0;lineNumber=source.length>0?1:0;lineStart=0;startIndex=index;startLineNumber=lineNumber;startLineStart=lineStart;length=source.length;lookahead=null;state={allowIn:true,allowYield:true,labelSet:{},inFunctionBody:false,inIteration:false,inSwitch:false,lastCommentStart:-1,curlyStack:[],sourceType:'script'};strict=false;extra={};if(typeof options!=='undefined'){extra.range=typeof options.range==='boolean'&&options.range;extra.loc=typeof options.loc==='boolean'&&options.loc;extra.attachComment=typeof options.attachComment==='boolean'&&options.attachComment;if(extra.loc&&options.source!==null&&options.source!==undefined){extra.source=toString(options.source);}if(typeof options.tokens==='boolean'&&options.tokens){extra.tokens=[];}if(typeof options.comment==='boolean'&&options.comment){extra.comments=[];}if(typeof options.tolerant==='boolean'&&options.tolerant){extra.errors=[];}if(extra.attachComment){extra.range=true;extra.comments=[];extra.bottomRightStack=[];extra.trailingComments=[];extra.leadingComments=[];}if(options.sourceType==='module'){state.sourceType=options.sourceType;strict=true;}}try{program=parseProgram();if(typeof extra.comments!=='undefined'){program.comments=extra.comments;}if(typeof extra.tokens!=='undefined'){filterTokenLocation();program.tokens=extra.tokens;}if(typeof extra.errors!=='undefined'){program.errors=extra.errors;}}catch(e){throw e;}finally{extra={};}return program;}exports.version='2.7.3';exports.tokenize=tokenize;exports.parse=parse;exports.Syntax=function(){var name,types={};if(typeof Object.create==='function'){types=Object.create(null);}for(name in Syntax){if(Syntax.hasOwnProperty(name)){types[name]=Syntax[name];}}if(typeof Object.freeze==='function'){Object.freeze(types);}return types;}();});},{}],57:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined;}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError('n must be a positive number');this._maxListeners=n;return this;};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==='error'){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er;}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+')');err.context=er;throw err;}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args);}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++){listeners[i].apply(this,args);}}return true;};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError('listener must be a function');if(!this._events)this._events={};if(this._events.newListener)this.emit('newListener',type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners;}else{m=EventEmitter.defaultMaxListeners;}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error('(node) warning: possible EventEmitter memory '+'leak detected. %d listeners added. '+'Use emitter.setMaxListeners() to increase limit.',this._events[type].length);if(typeof console.trace==='function'){console.trace();}}}return this;};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError('listener must be a function');var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments);}}g.listener=listener;this.on(type,g);return this;};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError('listener must be a function');if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit('removeListener',type,listener);}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break;}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type];}else{list.splice(position,1);}if(this._events.removeListener)this.emit('removeListener',type,listener);}return this;};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this;}if(arguments.length===0){for(key in this._events){if(key==='removeListener')continue;this.removeAllListeners(key);}this.removeAllListeners('removeListener');this._events={};return this;}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners);}else if(listeners){while(listeners.length){this.removeListener(type,listeners[listeners.length-1]);}}delete this._events[type];return this;};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret;};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;else if(evlistener)return evlistener.length;}return 0;};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type);};function isFunction(arg){return typeof arg==='function';}function isNumber(arg){return typeof arg==='number';}function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&arg!==null;}function isUndefined(arg){return arg===void 0;}},{}],58:[function(require,module,exports){'use strict';var constants=require('./util/constants'),Logging=require('./mixins/logging');var Faye={VERSION:constants.VERSION,Client:require('./protocol/client'),Scheduler:require('./protocol/scheduler')};Logging.wrapper=Faye;module.exports=Faye;},{"./mixins/logging":60,"./protocol/client":64,"./protocol/scheduler":70,"./util/constants":82}],59:[function(require,module,exports){(function(global){'use strict';var Promise=require('../util/promise');module.exports={then:function then(callback,errback){var self=this;if(!this._promise)this._promise=new Promise(function(resolve,reject){self._resolve=resolve;self._reject=reject;});if(arguments.length===0)return this._promise;else return this._promise.then(callback,errback);},callback:function callback(_callback,context){return this.then(function(value){_callback.call(context,value);});},errback:function errback(callback,context){return this.then(null,function(reason){callback.call(context,reason);});},timeout:function timeout(seconds,message){this.then();var self=this;this._timer=global.setTimeout(function(){self._reject(message);},seconds*1000);},setDeferredStatus:function setDeferredStatus(status,value){if(this._timer)global.clearTimeout(this._timer);this.then();if(status==='succeeded')this._resolve(value);else if(status==='failed')this._reject(value);else delete this._promise;}};}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../util/promise":87}],60:[function(require,module,exports){'use strict';var toJSON=require('../util/to_json');var Logging={LOG_LEVELS:{fatal:4,error:3,warn:2,info:1,debug:0},writeLog:function writeLog(messageArgs,level){var logger=Logging.logger||(Logging.wrapper||Logging).logger;if(!logger)return;var args=Array.prototype.slice.apply(messageArgs),banner='[Faye',klass=this.className,message=args.shift().replace(/\?/g,function(){try{return toJSON(args.shift());}catch(error){return'[Object]';}});if(klass)banner+='.'+klass;banner+='] ';if(typeof logger[level]==='function')logger[level](banner+message);else if(typeof logger==='function')logger(banner+message);}};for(var key in Logging.LOG_LEVELS){(function(level){Logging[level]=function(){this.writeLog(arguments,level);};})(key);}module.exports=Logging;},{"../util/to_json":89}],61:[function(require,module,exports){'use strict';var extend=require('../util/extend'),EventEmitter=require('../util/event_emitter');var Publisher={countListeners:function countListeners(eventType){return this.listeners(eventType).length;},bind:function bind(eventType,listener,context){var slice=Array.prototype.slice,handler=function handler(){listener.apply(context,slice.call(arguments));};this._listeners=this._listeners||[];this._listeners.push([eventType,listener,context,handler]);return this.on(eventType,handler);},unbind:function unbind(eventType,listener,context){this._listeners=this._listeners||[];var n=this._listeners.length,tuple;while(n--){tuple=this._listeners[n];if(tuple[0]!==eventType)continue;if(listener&&(tuple[1]!==listener||tuple[2]!==context))continue;this._listeners.splice(n,1);this.removeListener(eventType,tuple[3]);}}};extend(Publisher,EventEmitter.prototype);Publisher.trigger=Publisher.emit;module.exports=Publisher;},{"../util/event_emitter":85,"../util/extend":86}],62:[function(require,module,exports){(function(global){'use strict';module.exports={addTimeout:function addTimeout(name,delay,callback,context){this._timeouts=this._timeouts||{};if(this._timeouts.hasOwnProperty(name))return;var self=this;this._timeouts[name]=global.setTimeout(function(){delete self._timeouts[name];callback.call(context);},1000*delay);},removeTimeout:function removeTimeout(name){this._timeouts=this._timeouts||{};var timeout=this._timeouts[name];if(!timeout)return;global.clearTimeout(timeout);delete this._timeouts[name];},removeAllTimeouts:function removeAllTimeouts(){this._timeouts=this._timeouts||{};for(var name in this._timeouts){this.removeTimeout(name);}}};}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],63:[function(require,module,exports){'use strict';var Class=require('../util/class'),extend=require('../util/extend'),Publisher=require('../mixins/publisher'),Grammar=require('./grammar');var Channel=Class({initialize:function initialize(name){this.id=this.name=name;},push:function push(message){this.trigger('message',message);},isUnused:function isUnused(){return this.countListeners('message')===0;}});extend(Channel.prototype,Publisher);extend(Channel,{HANDSHAKE:'/meta/handshake',CONNECT:'/meta/connect',SUBSCRIBE:'/meta/subscribe',UNSUBSCRIBE:'/meta/unsubscribe',DISCONNECT:'/meta/disconnect',META:'meta',SERVICE:'service',expand:function expand(name){var segments=this.parse(name),channels=['/**',name];var copy=segments.slice();copy[copy.length-1]='*';channels.push(this.unparse(copy));for(var i=1,n=segments.length;i<n;i++){copy=segments.slice(0,i);copy.push('**');channels.push(this.unparse(copy));}return channels;},isValid:function isValid(name){return Grammar.CHANNEL_NAME.test(name)||Grammar.CHANNEL_PATTERN.test(name);},parse:function parse(name){if(!this.isValid(name))return null;return name.split('/').slice(1);},unparse:function unparse(segments){return'/'+segments.join('/');},isMeta:function isMeta(name){var segments=this.parse(name);return segments?segments[0]===this.META:null;},isService:function isService(name){var segments=this.parse(name);return segments?segments[0]===this.SERVICE:null;},isSubscribable:function isSubscribable(name){if(!this.isValid(name))return null;return!this.isMeta(name)&&!this.isService(name);},Set:Class({initialize:function initialize(){this._channels={};},getKeys:function getKeys(){var keys=[];for(var key in this._channels){keys.push(key);}return keys;},remove:function remove(name){delete this._channels[name];},hasSubscription:function hasSubscription(name){return this._channels.hasOwnProperty(name);},subscribe:function subscribe(names,subscription){var name;for(var i=0,n=names.length;i<n;i++){name=names[i];var channel=this._channels[name]=this._channels[name]||new Channel(name);channel.bind('message',subscription);}},unsubscribe:function unsubscribe(name,subscription){var channel=this._channels[name];if(!channel)return false;channel.unbind('message',subscription);if(channel.isUnused()){this.remove(name);return true;}else{return false;}},distributeMessage:function distributeMessage(message){var channels=Channel.expand(message.channel);for(var i=0,n=channels.length;i<n;i++){var channel=this._channels[channels[i]];if(channel)channel.trigger('message',message);}}})});module.exports=Channel;},{"../mixins/publisher":61,"../util/class":81,"../util/extend":86,"./grammar":68}],64:[function(require,module,exports){(function(global){'use strict';var asap=require('asap'),Class=require('../util/class'),Promise=require('../util/promise'),URI=require('../util/uri'),array=require('../util/array'),browser=require('../util/browser'),constants=require('../util/constants'),extend=require('../util/extend'),validateOptions=require('../util/validate_options'),Deferrable=require('../mixins/deferrable'),Logging=require('../mixins/logging'),Publisher=require('../mixins/publisher'),Channel=require('./channel'),Dispatcher=require('./dispatcher'),Error=require('./error'),Extensible=require('./extensible'),Publication=require('./publication'),Subscription=require('./subscription');var Client=Class({className:'Client',UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:'handshake',RETRY:'retry',NONE:'none',CONNECTION_TIMEOUT:60,DEFAULT_ENDPOINT:'/bayeux',INTERVAL:0,initialize:function initialize(endpoint,options){this.info('New client created for ?',endpoint);options=options||{};validateOptions(options,['interval','timeout','endpoints','proxy','retry','scheduler','websocketExtensions','tls','ca']);this._channels=new Channel.Set();this._dispatcher=Dispatcher.create(this,endpoint||this.DEFAULT_ENDPOINT,options);this._messageId=0;this._state=this.UNCONNECTED;this._responseCallbacks={};this._advice={reconnect:this.RETRY,interval:1000*(options.interval||this.INTERVAL),timeout:1000*(options.timeout||this.CONNECTION_TIMEOUT)};this._dispatcher.timeout=this._advice.timeout/1000;this._dispatcher.bind('message',this._receiveMessage,this);if(browser.Event&&global.onbeforeunload!==undefined)browser.Event.on(global,'beforeunload',function(){if(array.indexOf(this._dispatcher._disabled,'autodisconnect')<0)this.disconnect();},this);},addWebsocketExtension:function addWebsocketExtension(extension){return this._dispatcher.addWebsocketExtension(extension);},disable:function disable(feature){return this._dispatcher.disable(feature);},setHeader:function setHeader(name,value){return this._dispatcher.setHeader(name,value);},handshake:function handshake(callback,context){if(this._advice.reconnect===this.NONE)return;if(this._state!==this.UNCONNECTED)return;this._state=this.CONNECTING;var self=this;this.info('Initiating handshake with ?',URI.stringify(this._dispatcher.endpoint));this._dispatcher.selectTransport(constants.MANDATORY_CONNECTION_TYPES);this._sendMessage({channel:Channel.HANDSHAKE,version:constants.BAYEUX_VERSION,supportedConnectionTypes:this._dispatcher.getConnectionTypes()},{},function(response){if(response.successful){this._state=this.CONNECTED;this._dispatcher.clientId=response.clientId;this._dispatcher.selectTransport(response.supportedConnectionTypes);this.info('Handshake successful: ?',this._dispatcher.clientId);this.subscribe(this._channels.getKeys(),true);if(callback)asap(function(){callback.call(context);});}else{this.info('Handshake unsuccessful');global.setTimeout(function(){self.handshake(callback,context);},this._dispatcher.retry*1000);this._state=this.UNCONNECTED;}},this);},connect:function connect(callback,context){if(this._advice.reconnect===this.NONE)return;if(this._state===this.DISCONNECTED)return;if(this._state===this.UNCONNECTED)return this.handshake(function(){this.connect(callback,context);},this);this.callback(callback,context);if(this._state!==this.CONNECTED)return;this.info('Calling deferred actions for ?',this._dispatcher.clientId);this.setDeferredStatus('succeeded');this.setDeferredStatus('unknown');if(this._connectRequest)return;this._connectRequest=true;this.info('Initiating connection for ?',this._dispatcher.clientId);this._sendMessage({channel:Channel.CONNECT,clientId:this._dispatcher.clientId,connectionType:this._dispatcher.connectionType},{},this._cycleConnection,this);},disconnect:function disconnect(){if(this._state!==this.CONNECTED)return;this._state=this.DISCONNECTED;this.info('Disconnecting ?',this._dispatcher.clientId);var promise=new Publication();this._sendMessage({channel:Channel.DISCONNECT,clientId:this._dispatcher.clientId},{},function(response){if(response.successful){this._dispatcher.close();promise.setDeferredStatus('succeeded');}else{promise.setDeferredStatus('failed',Error.parse(response.error));}},this);this.info('Clearing channel listeners for ?',this._dispatcher.clientId);this._channels=new Channel.Set();return promise;},subscribe:function subscribe(channel,callback,context){if(channel instanceof Array)return array.map(channel,function(c){return this.subscribe(c,callback,context);},this);var subscription=new Subscription(this,channel,callback,context),force=callback===true,hasSubscribe=this._channels.hasSubscription(channel);if(hasSubscribe&&!force){this._channels.subscribe([channel],subscription);subscription.setDeferredStatus('succeeded');return subscription;}this.connect(function(){this.info('Client ? attempting to subscribe to ?',this._dispatcher.clientId,channel);if(!force)this._channels.subscribe([channel],subscription);this._sendMessage({channel:Channel.SUBSCRIBE,clientId:this._dispatcher.clientId,subscription:channel},{},function(response){if(!response.successful){subscription.setDeferredStatus('failed',Error.parse(response.error));return this._channels.unsubscribe(channel,subscription);}var channels=[].concat(response.subscription);this.info('Subscription acknowledged for ? to ?',this._dispatcher.clientId,channels);subscription.setDeferredStatus('succeeded');},this);},this);return subscription;},unsubscribe:function unsubscribe(channel,subscription){if(channel instanceof Array)return array.map(channel,function(c){return this.unsubscribe(c,subscription);},this);var dead=this._channels.unsubscribe(channel,subscription);if(!dead)return;this.connect(function(){this.info('Client ? attempting to unsubscribe from ?',this._dispatcher.clientId,channel);this._sendMessage({channel:Channel.UNSUBSCRIBE,clientId:this._dispatcher.clientId,subscription:channel},{},function(response){if(!response.successful)return;var channels=[].concat(response.subscription);this.info('Unsubscription acknowledged for ? from ?',this._dispatcher.clientId,channels);},this);},this);},publish:function publish(channel,data,options){validateOptions(options||{},['attempts','deadline']);var publication=new Publication();this.connect(function(){this.info('Client ? queueing published message to ?: ?',this._dispatcher.clientId,channel,data);this._sendMessage({channel:channel,data:data,clientId:this._dispatcher.clientId},options,function(response){if(response.successful)publication.setDeferredStatus('succeeded');else publication.setDeferredStatus('failed',Error.parse(response.error));},this);},this);return publication;},_sendMessage:function _sendMessage(message,options,callback,context){message.id=this._generateMessageId();var timeout=this._advice.timeout?1.2*this._advice.timeout/1000:1.2*this._dispatcher.retry;this.pipeThroughExtensions('outgoing',message,null,function(message){if(!message)return;if(callback)this._responseCallbacks[message.id]=[callback,context];this._dispatcher.sendMessage(message,timeout,options||{});},this);},_generateMessageId:function _generateMessageId(){this._messageId+=1;if(this._messageId>=Math.pow(2,32))this._messageId=0;return this._messageId.toString(36);},_receiveMessage:function _receiveMessage(message){var id=message.id,callback;if(message.successful!==undefined){callback=this._responseCallbacks[id];delete this._responseCallbacks[id];}this.pipeThroughExtensions('incoming',message,null,function(message){if(!message)return;if(message.advice)this._handleAdvice(message.advice);this._deliverMessage(message);if(callback)callback[0].call(callback[1],message);},this);},_handleAdvice:function _handleAdvice(advice){extend(this._advice,advice);this._dispatcher.timeout=this._advice.timeout/1000;if(this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED){this._state=this.UNCONNECTED;this._dispatcher.clientId=null;this._cycleConnection();}},_deliverMessage:function _deliverMessage(message){if(!message.channel||message.data===undefined)return;this.info('Client ? calling listeners for ? with ?',this._dispatcher.clientId,message.channel,message.data);this._channels.distributeMessage(message);},_cycleConnection:function _cycleConnection(){if(this._connectRequest){this._connectRequest=null;this.info('Closed connection for ?',this._dispatcher.clientId);}var self=this;global.setTimeout(function(){self.connect();},this._advice.interval);}});extend(Client.prototype,Deferrable);extend(Client.prototype,Publisher);extend(Client.prototype,Logging);extend(Client.prototype,Extensible);module.exports=Client;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../mixins/deferrable":59,"../mixins/logging":60,"../mixins/publisher":61,"../util/array":79,"../util/browser":80,"../util/class":81,"../util/constants":82,"../util/extend":86,"../util/promise":87,"../util/uri":90,"../util/validate_options":91,"./channel":63,"./dispatcher":65,"./error":66,"./extensible":67,"./publication":69,"./subscription":71,"asap":44}],65:[function(require,module,exports){(function(global){'use strict';var Class=require('../util/class'),URI=require('../util/uri'),cookies=require('../util/cookies'),extend=require('../util/extend'),Logging=require('../mixins/logging'),Publisher=require('../mixins/publisher'),Transport=require('../transport'),Scheduler=require('./scheduler');var Dispatcher=Class({className:'Dispatcher',MAX_REQUEST_SIZE:2048,DEFAULT_RETRY:5,UP:1,DOWN:2,initialize:function initialize(client,endpoint,options){this._client=client;this.endpoint=URI.parse(endpoint);this._alternates=options.endpoints||{};this.cookies=cookies.CookieJar&&new cookies.CookieJar();this._disabled=[];this._envelopes={};this.headers={};this.retry=options.retry||this.DEFAULT_RETRY;this._scheduler=options.scheduler||Scheduler;this._state=0;this.transports={};this.wsExtensions=[];this.proxy=options.proxy||{};if(typeof this._proxy==='string')this._proxy={origin:this._proxy};var exts=options.websocketExtensions;if(exts){exts=[].concat(exts);for(var i=0,n=exts.length;i<n;i++){this.addWebsocketExtension(exts[i]);}}this.tls=options.tls||{};this.tls.ca=this.tls.ca||options.ca;for(var type in this._alternates){this._alternates[type]=URI.parse(this._alternates[type]);}this.maxRequestSize=this.MAX_REQUEST_SIZE;},endpointFor:function endpointFor(connectionType){return this._alternates[connectionType]||this.endpoint;},addWebsocketExtension:function addWebsocketExtension(extension){this.wsExtensions.push(extension);},disable:function disable(feature){this._disabled.push(feature);},setHeader:function setHeader(name,value){this.headers[name]=value;},close:function close(){var transport=this._transport;delete this._transport;if(transport)transport.close();},getConnectionTypes:function getConnectionTypes(){return Transport.getConnectionTypes();},selectTransport:function selectTransport(transportTypes){Transport.get(this,transportTypes,this._disabled,function(transport){this.debug('Selected ? transport for ?',transport.connectionType,URI.stringify(transport.endpoint));if(transport===this._transport)return;if(this._transport)this._transport.close();this._transport=transport;this.connectionType=transport.connectionType;},this);},sendMessage:function sendMessage(message,timeout,options){options=options||{};var id=message.id,attempts=options.attempts,deadline=options.deadline&&new Date().getTime()+options.deadline*1000,envelope=this._envelopes[id],scheduler;if(!envelope){scheduler=new this._scheduler(message,{timeout:timeout,interval:this.retry,attempts:attempts,deadline:deadline});envelope=this._envelopes[id]={message:message,scheduler:scheduler};}this._sendEnvelope(envelope);},_sendEnvelope:function _sendEnvelope(envelope){if(!this._transport)return;if(envelope.request||envelope.timer)return;var message=envelope.message,scheduler=envelope.scheduler,self=this;if(!scheduler.isDeliverable()){scheduler.abort();delete this._envelopes[message.id];return;}envelope.timer=global.setTimeout(function(){self.handleError(message);},scheduler.getTimeout()*1000);scheduler.send();envelope.request=this._transport.sendMessage(message);},handleResponse:function handleResponse(reply){var envelope=this._envelopes[reply.id];if(reply.successful!==undefined&&envelope){envelope.scheduler.succeed();delete this._envelopes[reply.id];global.clearTimeout(envelope.timer);}this.trigger('message',reply);if(this._state===this.UP)return;this._state=this.UP;this._client.trigger('transport:up');},handleError:function handleError(message,immediate){var envelope=this._envelopes[message.id],request=envelope&&envelope.request,self=this;if(!request)return;request.then(function(req){if(req&&req.abort)req.abort();});var scheduler=envelope.scheduler;scheduler.fail();global.clearTimeout(envelope.timer);envelope.request=envelope.timer=null;if(immediate){this._sendEnvelope(envelope);}else{envelope.timer=global.setTimeout(function(){envelope.timer=null;self._sendEnvelope(envelope);},scheduler.getInterval()*1000);}if(this._state===this.DOWN)return;this._state=this.DOWN;this._client.trigger('transport:down');}});Dispatcher.create=function(client,endpoint,options){return new Dispatcher(client,endpoint,options);};extend(Dispatcher.prototype,Publisher);extend(Dispatcher.prototype,Logging);module.exports=Dispatcher;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../mixins/logging":60,"../mixins/publisher":61,"../transport":72,"../util/class":81,"../util/cookies":83,"../util/extend":86,"../util/uri":90,"./scheduler":70}],66:[function(require,module,exports){'use strict';var Class=require('../util/class'),Grammar=require('./grammar');var Error=Class({initialize:function initialize(code,params,message){this.code=code;this.params=Array.prototype.slice.call(params);this.message=message;},toString:function toString(){return this.code+':'+this.params.join(',')+':'+this.message;}});Error.parse=function(message){message=message||'';if(!Grammar.ERROR.test(message))return new Error(null,[],message);var parts=message.split(':'),code=parseInt(parts[0]),params=parts[1].split(','),message=parts[2];return new Error(code,params,message);};var errors={versionMismatch:[300,'Version mismatch'],conntypeMismatch:[301,'Connection types not supported'],extMismatch:[302,'Extension mismatch'],badRequest:[400,'Bad request'],clientUnknown:[401,'Unknown client'],parameterMissing:[402,'Missing required parameter'],channelForbidden:[403,'Forbidden channel'],channelUnknown:[404,'Unknown channel'],channelInvalid:[405,'Invalid channel'],extUnknown:[406,'Unknown extension'],publishFailed:[407,'Failed to publish'],serverError:[500,'Internal server error']};for(var name in errors){(function(name){Error[name]=function(){return new Error(errors[name][0],arguments,errors[name][1]).toString();};})(name);}module.exports=Error;},{"../util/class":81,"./grammar":68}],67:[function(require,module,exports){'use strict';var extend=require('../util/extend'),Logging=require('../mixins/logging');var Extensible={addExtension:function addExtension(extension){this._extensions=this._extensions||[];this._extensions.push(extension);if(extension.added)extension.added(this);},removeExtension:function removeExtension(extension){if(!this._extensions)return;var i=this._extensions.length;while(i--){if(this._extensions[i]!==extension)continue;this._extensions.splice(i,1);if(extension.removed)extension.removed(this);}},pipeThroughExtensions:function pipeThroughExtensions(stage,message,request,callback,context){this.debug('Passing through ? extensions: ?',stage,message);if(!this._extensions)return callback.call(context,message);var extensions=this._extensions.slice();var pipe=function pipe(message){if(!message)return callback.call(context,message);var extension=extensions.shift();if(!extension)return callback.call(context,message);var fn=extension[stage];if(!fn)return pipe(message);if(fn.length>=3)extension[stage](message,request,pipe);else extension[stage](message,pipe);};pipe(message);}};extend(Extensible,Logging);module.exports=Extensible;},{"../mixins/logging":60,"../util/extend":86}],68:[function(require,module,exports){'use strict';module.exports={CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/};},{}],69:[function(require,module,exports){'use strict';var Class=require('../util/class'),Deferrable=require('../mixins/deferrable');module.exports=Class(Deferrable);},{"../mixins/deferrable":59,"../util/class":81}],70:[function(require,module,exports){'use strict';var extend=require('../util/extend');var Scheduler=function Scheduler(message,options){this.message=message;this.options=options;this.attempts=0;};extend(Scheduler.prototype,{getTimeout:function getTimeout(){return this.options.timeout;},getInterval:function getInterval(){return this.options.interval;},isDeliverable:function isDeliverable(){var attempts=this.options.attempts,made=this.attempts,deadline=this.options.deadline,now=new Date().getTime();if(attempts!==undefined&&made>=attempts)return false;if(deadline!==undefined&&now>deadline)return false;return true;},send:function send(){this.attempts+=1;},succeed:function succeed(){},fail:function fail(){},abort:function abort(){}});module.exports=Scheduler;},{"../util/extend":86}],71:[function(require,module,exports){'use strict';var Class=require('../util/class'),extend=require('../util/extend'),Deferrable=require('../mixins/deferrable');var Subscription=Class({initialize:function initialize(client,channels,callback,context){this._client=client;this._channels=channels;this._callback=callback;this._context=context;this._cancelled=false;},withChannel:function withChannel(callback,context){this._withChannel=[callback,context];return this;},apply:function apply(context,args){var message=args[0];if(this._callback)this._callback.call(this._context,message.data);if(this._withChannel)this._withChannel[0].call(this._withChannel[1],message.channel,message.data);},cancel:function cancel(){if(this._cancelled)return;this._client.unsubscribe(this._channels,this);this._cancelled=true;},unsubscribe:function unsubscribe(){this.cancel();}});extend(Subscription.prototype,Deferrable);module.exports=Subscription;},{"../mixins/deferrable":59,"../util/class":81,"../util/extend":86}],72:[function(require,module,exports){'use strict';var Transport=require('./transport');Transport.register('websocket',require('./web_socket'));Transport.register('eventsource',require('./event_source'));Transport.register('long-polling',require('./xhr'));Transport.register('cross-origin-long-polling',require('./cors'));Transport.register('callback-polling',require('./jsonp'));module.exports=Transport;},{"./cors":73,"./event_source":74,"./jsonp":75,"./transport":76,"./web_socket":77,"./xhr":78}],73:[function(require,module,exports){(function(global){'use strict';var Class=require('../util/class'),Set=require('../util/set'),URI=require('../util/uri'),extend=require('../util/extend'),toJSON=require('../util/to_json'),Transport=require('./transport');var CORS=extend(Class(Transport,{encode:function encode(messages){return'message='+encodeURIComponent(toJSON(messages));},request:function request(messages){var xhrClass=global.XDomainRequest?XDomainRequest:XMLHttpRequest,xhr=new xhrClass(),id=++CORS._id,headers=this._dispatcher.headers,self=this,key;xhr.open('POST',URI.stringify(this.endpoint),true);if(xhr.setRequestHeader){xhr.setRequestHeader('Pragma','no-cache');for(key in headers){if(!headers.hasOwnProperty(key))continue;xhr.setRequestHeader(key,headers[key]);}}var cleanUp=function cleanUp(){if(!xhr)return false;CORS._pending.remove(id);xhr.onload=xhr.onerror=xhr.ontimeout=xhr.onprogress=null;xhr=null;};xhr.onload=function(){var replies;try{replies=JSON.parse(xhr.responseText);}catch(error){}cleanUp();if(replies)self._receive(replies);else self._handleError(messages);};xhr.onerror=xhr.ontimeout=function(){cleanUp();self._handleError(messages);};xhr.onprogress=function(){};if(xhrClass===global.XDomainRequest)CORS._pending.add({id:id,xhr:xhr});xhr.send(this.encode(messages));return xhr;}}),{_id:0,_pending:new Set(),isUsable:function isUsable(dispatcher,endpoint,callback,context){if(URI.isSameOrigin(endpoint))return callback.call(context,false);if(global.XDomainRequest)return callback.call(context,endpoint.protocol===location.protocol);if(global.XMLHttpRequest){var xhr=new XMLHttpRequest();return callback.call(context,xhr.withCredentials!==undefined);}return callback.call(context,false);}});module.exports=CORS;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../util/class":81,"../util/extend":86,"../util/set":88,"../util/to_json":89,"../util/uri":90,"./transport":76}],74:[function(require,module,exports){(function(global){'use strict';var Class=require('../util/class'),URI=require('../util/uri'),copyObject=require('../util/copy_object'),extend=require('../util/extend'),Deferrable=require('../mixins/deferrable'),Transport=require('./transport'),XHR=require('./xhr');var EventSource=extend(Class(Transport,{initialize:function initialize(dispatcher,endpoint){Transport.prototype.initialize.call(this,dispatcher,endpoint);if(!global.EventSource)return this.setDeferredStatus('failed');this._xhr=new XHR(dispatcher,endpoint);endpoint=copyObject(endpoint);endpoint.pathname+='/'+dispatcher.clientId;var socket=new global.EventSource(URI.stringify(endpoint)),self=this;socket.onopen=function(){self._everConnected=true;self.setDeferredStatus('succeeded');};socket.onerror=function(){if(self._everConnected){self._handleError([]);}else{self.setDeferredStatus('failed');socket.close();}};socket.onmessage=function(event){var replies;try{replies=JSON.parse(event.data);}catch(error){}if(replies)self._receive(replies);else self._handleError([]);};this._socket=socket;},close:function close(){if(!this._socket)return;this._socket.onopen=this._socket.onerror=this._socket.onmessage=null;this._socket.close();delete this._socket;},isUsable:function isUsable(callback,context){this.callback(function(){callback.call(context,true);});this.errback(function(){callback.call(context,false);});},encode:function encode(messages){return this._xhr.encode(messages);},request:function request(messages){return this._xhr.request(messages);}}),{isUsable:function isUsable(dispatcher,endpoint,callback,context){var id=dispatcher.clientId;if(!id)return callback.call(context,false);XHR.isUsable(dispatcher,endpoint,function(usable){if(!usable)return callback.call(context,false);this.create(dispatcher,endpoint).isUsable(callback,context);},this);},create:function create(dispatcher,endpoint){var sockets=dispatcher.transports.eventsource=dispatcher.transports.eventsource||{},id=dispatcher.clientId;var url=copyObject(endpoint);url.pathname+='/'+(id||'');url=URI.stringify(url);sockets[url]=sockets[url]||new this(dispatcher,endpoint);return sockets[url];}});extend(EventSource.prototype,Deferrable);module.exports=EventSource;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../mixins/deferrable":59,"../util/class":81,"../util/copy_object":84,"../util/extend":86,"../util/uri":90,"./transport":76,"./xhr":78}],75:[function(require,module,exports){(function(global){'use strict';var Class=require('../util/class'),URI=require('../util/uri'),copyObject=require('../util/copy_object'),extend=require('../util/extend'),toJSON=require('../util/to_json'),Transport=require('./transport');var JSONP=extend(Class(Transport,{encode:function encode(messages){var url=copyObject(this.endpoint);url.query.message=toJSON(messages);url.query.jsonp='__jsonp'+JSONP._cbCount+'__';return URI.stringify(url);},request:function request(messages){var head=document.getElementsByTagName('head')[0],script=document.createElement('script'),callbackName=JSONP.getCallbackName(),endpoint=copyObject(this.endpoint),self=this;endpoint.query.message=toJSON(messages);endpoint.query.jsonp=callbackName;var cleanup=function cleanup(){if(!global[callbackName])return false;global[callbackName]=undefined;try{delete global[callbackName];}catch(error){}script.parentNode.removeChild(script);};global[callbackName]=function(replies){cleanup();self._receive(replies);};script.type='text/javascript';script.src=URI.stringify(endpoint);head.appendChild(script);script.onerror=function(){cleanup();self._handleError(messages);};return{abort:cleanup};}}),{_cbCount:0,getCallbackName:function getCallbackName(){this._cbCount+=1;return'__jsonp'+this._cbCount+'__';},isUsable:function isUsable(dispatcher,endpoint,callback,context){callback.call(context,true);}});module.exports=JSONP;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../util/class":81,"../util/copy_object":84,"../util/extend":86,"../util/to_json":89,"../util/uri":90,"./transport":76}],76:[function(require,module,exports){(function(process){'use strict';var Class=require('../util/class'),Cookie=require('../util/cookies').Cookie,Promise=require('../util/promise'),URI=require('../util/uri'),array=require('../util/array'),extend=require('../util/extend'),Logging=require('../mixins/logging'),Timeouts=require('../mixins/timeouts'),Channel=require('../protocol/channel');var Transport=extend(Class({className:'Transport',DEFAULT_PORTS:{'http:':80,'https:':443,'ws:':80,'wss:':443},MAX_DELAY:0,batching:true,initialize:function initialize(dispatcher,endpoint){this._dispatcher=dispatcher;this.endpoint=endpoint;this._outbox=[];this._proxy=extend({},this._dispatcher.proxy);if(!this._proxy.origin)this._proxy.origin=this._findProxy();},close:function close(){},encode:function encode(messages){return'';},sendMessage:function sendMessage(message){this.debug('Client ? sending message to ?: ?',this._dispatcher.clientId,URI.stringify(this.endpoint),message);if(!this.batching)return Promise.resolve(this.request([message]));this._outbox.push(message);this._flushLargeBatch();if(message.channel===Channel.HANDSHAKE)return this._publish(0.01);if(message.channel===Channel.CONNECT)this._connectMessage=message;return this._publish(this.MAX_DELAY);},_makePromise:function _makePromise(){var self=this;this._requestPromise=this._requestPromise||new Promise(function(resolve){self._resolvePromise=resolve;});},_publish:function _publish(delay){this._makePromise();this.addTimeout('publish',delay,function(){this._flush();delete this._requestPromise;},this);return this._requestPromise;},_flush:function _flush(){this.removeTimeout('publish');if(this._outbox.length>1&&this._connectMessage)this._connectMessage.advice={timeout:0};this._resolvePromise(this.request(this._outbox));this._connectMessage=null;this._outbox=[];},_flushLargeBatch:function _flushLargeBatch(){var string=this.encode(this._outbox);if(string.length<this._dispatcher.maxRequestSize)return;var last=this._outbox.pop();this._makePromise();this._flush();if(last)this._outbox.push(last);},_receive:function _receive(replies){if(!replies)return;replies=[].concat(replies);this.debug('Client ? received from ? via ?: ?',this._dispatcher.clientId,URI.stringify(this.endpoint),this.connectionType,replies);for(var i=0,n=replies.length;i<n;i++){this._dispatcher.handleResponse(replies[i]);}},_handleError:function _handleError(messages,immediate){messages=[].concat(messages);this.debug('Client ? failed to send to ? via ?: ?',this._dispatcher.clientId,URI.stringify(this.endpoint),this.connectionType,messages);for(var i=0,n=messages.length;i<n;i++){this._dispatcher.handleError(messages[i]);}},_getCookies:function _getCookies(){var cookies=this._dispatcher.cookies,url=URI.stringify(this.endpoint);if(!cookies)return'';return array.map(cookies.getCookiesSync(url),function(cookie){return cookie.cookieString();}).join('; ');},_storeCookies:function _storeCookies(setCookie){var cookies=this._dispatcher.cookies,url=URI.stringify(this.endpoint),cookie;if(!setCookie||!cookies)return;setCookie=[].concat(setCookie);for(var i=0,n=setCookie.length;i<n;i++){cookie=Cookie.parse(setCookie[i]);cookies.setCookieSync(cookie,url);}},_findProxy:function _findProxy(){if(typeof process==='undefined')return undefined;var protocol=this.endpoint.protocol;if(!protocol)return undefined;var name=protocol.replace(/:$/,'').toLowerCase()+'_proxy',upcase=name.toUpperCase(),env=process.env,keys,proxy;if(name==='http_proxy'&&env.REQUEST_METHOD){keys=Object.keys(env).filter(function(k){return /^http_proxy$/i.test(k);});if(keys.length===1){if(keys[0]===name&&env[upcase]===undefined)proxy=env[name];}else if(keys.length>1){proxy=env[name];}proxy=proxy||env['CGI_'+upcase];}else{proxy=env[name]||env[upcase];if(proxy&&!env[name])console.warn('The environment variable '+upcase+' is discouraged. Use '+name+'.');}return proxy;}}),{get:function get(dispatcher,allowed,disabled,callback,context){var endpoint=dispatcher.endpoint;array.asyncEach(this._transports,function(pair,resume){var connType=pair[0],klass=pair[1],connEndpoint=dispatcher.endpointFor(connType);if(array.indexOf(disabled,connType)>=0)return resume();if(array.indexOf(allowed,connType)<0){klass.isUsable(dispatcher,connEndpoint,function(){});return resume();}klass.isUsable(dispatcher,connEndpoint,function(isUsable){if(!isUsable)return resume();var transport=klass.hasOwnProperty('create')?klass.create(dispatcher,connEndpoint):new klass(dispatcher,connEndpoint);callback.call(context,transport);});},function(){throw new Error('Could not find a usable connection type for '+URI.stringify(endpoint));});},register:function register(type,klass){this._transports.push([type,klass]);klass.prototype.connectionType=type;},getConnectionTypes:function getConnectionTypes(){return array.map(this._transports,function(t){return t[0];});},_transports:[]});extend(Transport.prototype,Logging);extend(Transport.prototype,Timeouts);module.exports=Transport;}).call(this,require('_process'));},{"../mixins/logging":60,"../mixins/timeouts":62,"../protocol/channel":63,"../util/array":79,"../util/class":81,"../util/cookies":83,"../util/extend":86,"../util/promise":87,"../util/uri":90,"_process":170}],77:[function(require,module,exports){(function(global){'use strict';var Class=require('../util/class'),Promise=require('../util/promise'),Set=require('../util/set'),URI=require('../util/uri'),browser=require('../util/browser'),copyObject=require('../util/copy_object'),extend=require('../util/extend'),toJSON=require('../util/to_json'),ws=require('../util/websocket'),Deferrable=require('../mixins/deferrable'),Transport=require('./transport');var WebSocket=extend(Class(Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:false,isUsable:function isUsable(callback,context){this.callback(function(){callback.call(context,true);});this.errback(function(){callback.call(context,false);});this.connect();},request:function request(messages){this._pending=this._pending||new Set();for(var i=0,n=messages.length;i<n;i++){this._pending.add(messages[i]);}var self=this;var promise=new Promise(function(resolve,reject){self.callback(function(socket){if(!socket||socket.readyState!==1)return;socket.send(toJSON(messages));resolve(socket);});self.connect();});return{abort:function abort(){promise.then(function(ws){ws.close();});}};},connect:function connect(){if(WebSocket._unloaded)return;this._state=this._state||this.UNCONNECTED;if(this._state!==this.UNCONNECTED)return;this._state=this.CONNECTING;var socket=this._createSocket();if(!socket)return this.setDeferredStatus('failed');var self=this;socket.onopen=function(){if(socket.headers)self._storeCookies(socket.headers['set-cookie']);self._socket=socket;self._state=self.CONNECTED;self._everConnected=true;self._ping();self.setDeferredStatus('succeeded',socket);};var closed=false;socket.onclose=socket.onerror=function(){if(closed)return;closed=true;var wasConnected=self._state===self.CONNECTED;socket.onopen=socket.onclose=socket.onerror=socket.onmessage=null;delete self._socket;self._state=self.UNCONNECTED;self.removeTimeout('ping');var pending=self._pending?self._pending.toArray():[];delete self._pending;if(wasConnected||self._everConnected){self.setDeferredStatus('unknown');self._handleError(pending,wasConnected);}else{self.setDeferredStatus('failed');}};socket.onmessage=function(event){var replies;try{replies=JSON.parse(event.data);}catch(error){}if(!replies)return;replies=[].concat(replies);for(var i=0,n=replies.length;i<n;i++){if(replies[i].successful===undefined)continue;self._pending.remove(replies[i]);}self._receive(replies);};},close:function close(){if(!this._socket)return;this._socket.close();},_createSocket:function _createSocket(){var url=WebSocket.getSocketUrl(this.endpoint),headers=this._dispatcher.headers,extensions=this._dispatcher.wsExtensions,cookie=this._getCookies(),tls=this._dispatcher.tls,options={extensions:extensions,headers:headers,proxy:this._proxy,tls:tls};if(cookie!=='')options.headers['Cookie']=cookie;return ws.create(url,[],options);},_ping:function _ping(){if(!this._socket||this._socket.readyState!==1)return;this._socket.send('[]');this.addTimeout('ping',this._dispatcher.timeout/2,this._ping,this);}}),{PROTOCOLS:{'http:':'ws:','https:':'wss:'},create:function create(dispatcher,endpoint){var sockets=dispatcher.transports.websocket=dispatcher.transports.websocket||{};sockets[endpoint.href]=sockets[endpoint.href]||new this(dispatcher,endpoint);return sockets[endpoint.href];},getSocketUrl:function getSocketUrl(endpoint){endpoint=copyObject(endpoint);endpoint.protocol=this.PROTOCOLS[endpoint.protocol];return URI.stringify(endpoint);},isUsable:function isUsable(dispatcher,endpoint,callback,context){this.create(dispatcher,endpoint).isUsable(callback,context);}});extend(WebSocket.prototype,Deferrable);if(browser.Event&&global.onbeforeunload!==undefined)browser.Event.on(global,'beforeunload',function(){WebSocket._unloaded=true;});module.exports=WebSocket;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../mixins/deferrable":59,"../util/browser":80,"../util/class":81,"../util/copy_object":84,"../util/extend":86,"../util/promise":87,"../util/set":88,"../util/to_json":89,"../util/uri":90,"../util/websocket":92,"./transport":76}],78:[function(require,module,exports){(function(global){'use strict';var Class=require('../util/class'),URI=require('../util/uri'),browser=require('../util/browser'),extend=require('../util/extend'),toJSON=require('../util/to_json'),Transport=require('./transport');var XHR=extend(Class(Transport,{encode:function encode(messages){return toJSON(messages);},request:function request(messages){var href=this.endpoint.href,self=this,xhr;if(global.XMLHttpRequest){xhr=new XMLHttpRequest();}else if(global.ActiveXObject){xhr=new ActiveXObject('Microsoft.XMLHTTP');}else{return this._handleError(messages);}xhr.open('POST',href,true);xhr.setRequestHeader('Content-Type','application/json');xhr.setRequestHeader('Pragma','no-cache');xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');var headers=this._dispatcher.headers;for(var key in headers){if(!headers.hasOwnProperty(key))continue;xhr.setRequestHeader(key,headers[key]);}var abort=function abort(){xhr.abort();};if(global.onbeforeunload!==undefined)browser.Event.on(global,'beforeunload',abort);xhr.onreadystatechange=function(){if(!xhr||xhr.readyState!==4)return;var replies=null,status=xhr.status,text=xhr.responseText,successful=status>=200&&status<300||status===304||status===1223;if(global.onbeforeunload!==undefined)browser.Event.detach(global,'beforeunload',abort);xhr.onreadystatechange=function(){};xhr=null;if(!successful)return self._handleError(messages);try{replies=JSON.parse(text);}catch(error){}if(replies)self._receive(replies);else self._handleError(messages);};xhr.send(this.encode(messages));return xhr;}}),{isUsable:function isUsable(dispatcher,endpoint,callback,context){var usable=navigator.product==='ReactNative'||URI.isSameOrigin(endpoint);callback.call(context,usable);}});module.exports=XHR;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../util/browser":80,"../util/class":81,"../util/extend":86,"../util/to_json":89,"../util/uri":90,"./transport":76}],79:[function(require,module,exports){'use strict';module.exports={commonElement:function commonElement(lista,listb){for(var i=0,n=lista.length;i<n;i++){if(this.indexOf(listb,lista[i])!==-1)return lista[i];}return null;},indexOf:function indexOf(list,needle){if(list.indexOf)return list.indexOf(needle);for(var i=0,n=list.length;i<n;i++){if(list[i]===needle)return i;}return-1;},map:function map(object,callback,context){if(object.map)return object.map(callback,context);var result=[];if(object instanceof Array){for(var i=0,n=object.length;i<n;i++){result.push(callback.call(context||null,object[i],i));}}else{for(var key in object){if(!object.hasOwnProperty(key))continue;result.push(callback.call(context||null,key,object[key]));}}return result;},filter:function filter(array,callback,context){if(array.filter)return array.filter(callback,context);var result=[];for(var i=0,n=array.length;i<n;i++){if(callback.call(context||null,array[i],i))result.push(array[i]);}return result;},asyncEach:function asyncEach(list,iterator,callback,context){var n=list.length,i=-1,calls=0,looping=false;var iterate=function iterate(){calls-=1;i+=1;if(i===n)return callback&&callback.call(context);iterator(list[i],resume);};var loop=function loop(){if(looping)return;looping=true;while(calls>0){iterate();}looping=false;};var resume=function resume(){calls+=1;loop();};resume();}};},{}],80:[function(require,module,exports){(function(global){'use strict';var Event={_registry:[],on:function on(element,eventName,callback,context){var wrapped=function wrapped(){callback.call(context);};if(element.addEventListener)element.addEventListener(eventName,wrapped,false);else element.attachEvent('on'+eventName,wrapped);this._registry.push({_element:element,_type:eventName,_callback:callback,_context:context,_handler:wrapped});},detach:function detach(element,eventName,callback,context){var i=this._registry.length,register;while(i--){register=this._registry[i];if(element&&element!==register._element||eventName&&eventName!==register._type||callback&&callback!==register._callback||context&&context!==register._context)continue;if(register._element.removeEventListener)register._element.removeEventListener(register._type,register._handler,false);else register._element.detachEvent('on'+register._type,register._handler);this._registry.splice(i,1);register=null;}}};if(global.onunload!==undefined)Event.on(global,'unload',Event.detach,Event);module.exports={Event:Event};}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],81:[function(require,module,exports){'use strict';var extend=require('./extend');module.exports=function(parent,methods){if(typeof parent!=='function'){methods=parent;parent=Object;}var klass=function klass(){if(!this.initialize)return this;return this.initialize.apply(this,arguments)||this;};var bridge=function bridge(){};bridge.prototype=parent.prototype;klass.prototype=new bridge();extend(klass.prototype,methods);return klass;};},{"./extend":86}],82:[function(require,module,exports){module.exports={VERSION:'1.2.4',BAYEUX_VERSION:'1.0',ID_LENGTH:160,JSONP_CALLBACK:'jsonpcallback',CONNECTION_TYPES:['long-polling','cross-origin-long-polling','callback-polling','websocket','eventsource','in-process'],MANDATORY_CONNECTION_TYPES:['long-polling','callback-polling','in-process']};},{}],83:[function(require,module,exports){'use strict';module.exports={};},{}],84:[function(require,module,exports){'use strict';var copyObject=function copyObject(object){var clone,i,key;if(object instanceof Array){clone=[];i=object.length;while(i--){clone[i]=copyObject(object[i]);}return clone;}else if((typeof object==="undefined"?"undefined":_typeof(object))==='object'){clone=object===null?null:{};for(key in object){clone[key]=copyObject(object[key]);}return clone;}else{return object;}};module.exports=copyObject;},{}],85:[function(require,module,exports){var isArray=typeof Array.isArray==='function'?Array.isArray:function(xs){return Object.prototype.toString.call(xs)==='[object Array]';};function indexOf(xs,x){if(xs.indexOf)return xs.indexOf(x);for(var i=0;i<xs.length;i++){if(x===xs[i])return i;}return-1;}function EventEmitter(){}module.exports=EventEmitter;EventEmitter.prototype.emit=function(type){if(type==='error'){if(!this._events||!this._events.error||isArray(this._events.error)&&!this._events.error.length){if(arguments[1]instanceof Error){throw arguments[1];}else{throw new Error("Uncaught, unspecified 'error' event.");}return false;}}if(!this._events)return false;var handler=this._events[type];if(!handler)return false;if(typeof handler=='function'){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:var args=Array.prototype.slice.call(arguments,1);handler.apply(this,args);}return true;}else if(isArray(handler)){var args=Array.prototype.slice.call(arguments,1);var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++){listeners[i].apply(this,args);}return true;}else{return false;}};EventEmitter.prototype.addListener=function(type,listener){if('function'!==typeof listener){throw new Error('addListener only takes instances of Function');}if(!this._events)this._events={};this.emit('newListener',type,listener);if(!this._events[type]){this._events[type]=listener;}else if(isArray(this._events[type])){this._events[type].push(listener);}else{this._events[type]=[this._events[type],listener];}return this;};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){var self=this;self.on(type,function g(){self.removeListener(type,g);listener.apply(this,arguments);});return this;};EventEmitter.prototype.removeListener=function(type,listener){if('function'!==typeof listener){throw new Error('removeListener only takes instances of Function');}if(!this._events||!this._events[type])return this;var list=this._events[type];if(isArray(list)){var i=indexOf(list,listener);if(i<0)return this;list.splice(i,1);if(list.length==0)delete this._events[type];}else if(this._events[type]===listener){delete this._events[type];}return this;};EventEmitter.prototype.removeAllListeners=function(type){if(arguments.length===0){this._events={};return this;}if(type&&this._events&&this._events[type])this._events[type]=null;return this;};EventEmitter.prototype.listeners=function(type){if(!this._events)this._events={};if(!this._events[type])this._events[type]=[];if(!isArray(this._events[type])){this._events[type]=[this._events[type]];}return this._events[type];};},{}],86:[function(require,module,exports){'use strict';module.exports=function(dest,source,overwrite){if(!source)return dest;for(var key in source){if(!source.hasOwnProperty(key))continue;if(dest.hasOwnProperty(key)&&overwrite===false)continue;if(dest[key]!==source[key])dest[key]=source[key];}return dest;};},{}],87:[function(require,module,exports){'use strict';var asap=require('asap');var PENDING=0,FULFILLED=1,REJECTED=2;var RETURN=function RETURN(x){return x;},THROW=function THROW(x){throw x;};var Promise=function Promise(task){this._state=PENDING;this._onFulfilled=[];this._onRejected=[];if(typeof task!=='function')return;var self=this;task(function(value){resolve(self,value);},function(reason){reject(self,reason);});};Promise.prototype.then=function(onFulfilled,onRejected){var next=new Promise();registerOnFulfilled(this,onFulfilled,next);registerOnRejected(this,onRejected,next);return next;};Promise.prototype['catch']=function(onRejected){return this.then(null,onRejected);};var registerOnFulfilled=function registerOnFulfilled(promise,onFulfilled,next){if(typeof onFulfilled!=='function')onFulfilled=RETURN;var handler=function handler(value){invoke(onFulfilled,value,next);};if(promise._state===PENDING){promise._onFulfilled.push(handler);}else if(promise._state===FULFILLED){handler(promise._value);}};var registerOnRejected=function registerOnRejected(promise,onRejected,next){if(typeof onRejected!=='function')onRejected=THROW;var handler=function handler(reason){invoke(onRejected,reason,next);};if(promise._state===PENDING){promise._onRejected.push(handler);}else if(promise._state===REJECTED){handler(promise._reason);}};var invoke=function invoke(fn,value,next){asap(function(){_invoke(fn,value,next);});};var _invoke=function _invoke(fn,value,next){var outcome;try{outcome=fn(value);}catch(error){return reject(next,error);}if(outcome===next){reject(next,new TypeError('Recursive promise chain detected'));}else{resolve(next,outcome);}};var resolve=function resolve(promise,value){var called=false,type,then;try{type=typeof value==="undefined"?"undefined":_typeof(value);then=value!==null&&(type==='function'||type==='object')&&value.then;if(typeof then!=='function')return fulfill(promise,value);then.call(value,function(v){if(!(called^(called=true)))return;resolve(promise,v);},function(r){if(!(called^(called=true)))return;reject(promise,r);});}catch(error){if(!(called^(called=true)))return;reject(promise,error);}};var fulfill=function fulfill(promise,value){if(promise._state!==PENDING)return;promise._state=FULFILLED;promise._value=value;promise._onRejected=[];var onFulfilled=promise._onFulfilled,fn;while(fn=onFulfilled.shift()){fn(value);}};var reject=function reject(promise,reason){if(promise._state!==PENDING)return;promise._state=REJECTED;promise._reason=reason;promise._onFulfilled=[];var onRejected=promise._onRejected,fn;while(fn=onRejected.shift()){fn(reason);}};Promise.resolve=function(value){return new Promise(function(resolve,reject){resolve(value);});};Promise.reject=function(reason){return new Promise(function(resolve,reject){reject(reason);});};Promise.all=function(promises){return new Promise(function(resolve,reject){var list=[],n=promises.length,i;if(n===0)return resolve(list);for(i=0;i<n;i++){(function(promise,i){Promise.resolve(promise).then(function(value){list[i]=value;if(--n===0)resolve(list);},reject);})(promises[i],i);}});};Promise.race=function(promises){return new Promise(function(resolve,reject){for(var i=0,n=promises.length;i<n;i++){Promise.resolve(promises[i]).then(resolve,reject);}});};Promise.deferred=Promise.pending=function(){var tuple={};tuple.promise=new Promise(function(resolve,reject){tuple.resolve=resolve;tuple.reject=reject;});return tuple;};module.exports=Promise;},{"asap":44}],88:[function(require,module,exports){'use strict';var Class=require('./class');module.exports=Class({initialize:function initialize(){this._index={};},add:function add(item){var key=item.id!==undefined?item.id:item;if(this._index.hasOwnProperty(key))return false;this._index[key]=item;return true;},forEach:function forEach(block,context){for(var key in this._index){if(this._index.hasOwnProperty(key))block.call(context,this._index[key]);}},isEmpty:function isEmpty(){for(var key in this._index){if(this._index.hasOwnProperty(key))return false;}return true;},member:function member(item){for(var key in this._index){if(this._index[key]===item)return true;}return false;},remove:function remove(item){var key=item.id!==undefined?item.id:item;var removed=this._index[key];delete this._index[key];return removed;},toArray:function toArray(){var array=[];this.forEach(function(item){array.push(item);});return array;}});},{"./class":81}],89:[function(require,module,exports){'use strict';module.exports=function(object){return JSON.stringify(object,function(key,value){return this[key]instanceof Array?this[key]:value;});};},{}],90:[function(require,module,exports){'use strict';module.exports={isURI:function isURI(uri){return uri&&uri.protocol&&uri.host&&uri.path;},isSameOrigin:function isSameOrigin(uri){return uri.protocol===location.protocol&&uri.hostname===location.hostname&&uri.port===location.port;},parse:function parse(url){if(typeof url!=='string')return url;var uri={},parts,query,pairs,i,n,data;var consume=function consume(name,pattern){url=url.replace(pattern,function(match){uri[name]=match;return'';});uri[name]=uri[name]||'';};consume('protocol',/^[a-z]+\:/i);consume('host',/^\/\/[^\/\?#]+/);if(!/^\//.test(url)&&!uri.host)url=location.pathname.replace(/[^\/]*$/,'')+url;consume('pathname',/^[^\?#]*/);consume('search',/^\?[^#]*/);consume('hash',/^#.*/);uri.protocol=uri.protocol||location.protocol;if(uri.host){uri.host=uri.host.substr(2);parts=uri.host.split(':');uri.hostname=parts[0];uri.port=parts[1]||'';}else{uri.host=location.host;uri.hostname=location.hostname;uri.port=location.port;}uri.pathname=uri.pathname||'/';uri.path=uri.pathname+uri.search;query=uri.search.replace(/^\?/,'');pairs=query?query.split('&'):[];data={};for(i=0,n=pairs.length;i<n;i++){parts=pairs[i].split('=');data[decodeURIComponent(parts[0]||'')]=decodeURIComponent(parts[1]||'');}uri.query=data;uri.href=this.stringify(uri);return uri;},stringify:function stringify(uri){var string=uri.protocol+'//'+uri.hostname;if(uri.port)string+=':'+uri.port;string+=uri.pathname+this.queryString(uri.query)+(uri.hash||'');return string;},queryString:function queryString(query){var pairs=[];for(var key in query){if(!query.hasOwnProperty(key))continue;pairs.push(encodeURIComponent(key)+'='+encodeURIComponent(query[key]));}if(pairs.length===0)return'';return'?'+pairs.join('&');}};},{}],91:[function(require,module,exports){'use strict';var array=require('./array');module.exports=function(options,validKeys){for(var key in options){if(array.indexOf(validKeys,key)<0)throw new Error('Unrecognized option: '+key);}};},{"./array":79}],92:[function(require,module,exports){(function(global){'use strict';var WS=global.MozWebSocket||global.WebSocket;module.exports={create:function create(url,protocols,options){if(typeof WS!=='function')return null;return new WS(url);}};}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],93:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var nBits=-7;var i=isLE?nBytes-1:0;var d=isLE?-1:1;var s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8){}m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8){}if(e===0){e=1-eBias;}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity;}else{m=m+Math.pow(2,mLen);e=e-eBias;}return(s?-1:1)*m*Math.pow(2,e-mLen);};exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0;var i=isLE?0:nBytes-1;var d=isLE?1:-1;var s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax;}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2;}if(e+eBias>=1){value+=rt/c;}else{value+=rt*Math.pow(2,1-eBias);}if(value*c>=2){e++;c/=2;}if(e+eBias>=eMax){m=0;e=eMax;}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias;}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0;}}for(;mLen>=8;buffer[offset+i]=m&0xff,i+=d,m/=256,mLen-=8){}e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&0xff,i+=d,e/=256,eLen-=8){}buffer[offset+i-d]|=s*128;};},{}],94:[function(require,module,exports){if(typeof Object.create==='function'){module.exports=function inherits(ctor,superCtor){if(superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}});}};}else{module.exports=function inherits(ctor,superCtor){if(superCtor){ctor.super_=superCtor;var TempCtor=function TempCtor(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor();ctor.prototype.constructor=ctor;}};}},{}],95:[function(require,module,exports){/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */module.exports=function(obj){return obj!=null&&(isBuffer(obj)||isSlowBuffer(obj)||!!obj._isBuffer);};function isBuffer(obj){return!!obj.constructor&&typeof obj.constructor.isBuffer==='function'&&obj.constructor.isBuffer(obj);}function isSlowBuffer(obj){return typeof obj.readFloatLE==='function'&&typeof obj.slice==='function'&&isBuffer(obj.slice(0,0));}},{}],96:[function(require,module,exports){module.exports.logger=require('./logger.js').instance;module.exports.newLoggerInstance=require('./logger.js').newInstance;},{"./logger.js":97}],97:[function(require,module,exports){(function(process,global,__filename){'use strict';var fs=require('fs');var log4js=require('log4js');var path=require('path');var loggers={};var logCtxNS={};if(typeof window==='undefined'){var cls=require('continuation-local-storage');logCtxNS=cls.getNamespace('app-log-ctx');}function decorateLogMethod(logMethod){return function(){var args=Array.prototype.slice.call(arguments);var ctx=undefined;if(typeof logCtxNS!=='undefined'){ctx=logCtxNS.get('logCtx');}if(typeof ctx==='undefined'){ctx='{}';}args.unshift(ctx);return logMethod.apply(undefined,args);};}function _Logger(log4jsLogger){for(var key in log4jsLogger){var attribute=log4jsLogger[key];if(typeof attribute==='function'){var originalMethod=attribute.bind(log4jsLogger);if(['trace','debug','info','warn','error','fatal'].indexOf(key)!==-1){this[key]=decorateLogMethod(originalMethod);}else{this[key]=originalMethod;}}else{this[key]=attribute;}}}var configurationFileOrObject=process.env.JS_LOGGER_CONFIG;var defaultConfig={"appenders":[{"type":"console","layout":{"type":"basic"}}],"levels":{"[all]":"INFO"}};function Logger(){this._initialized=false;}Logger.prototype.init=function(configurationFileOrObject){if(!this._initialized){if(configurationFileOrObject){try{if(typeof window!=='undefined'){log4js.configure(JSON.parse(configurationFileOrObject));}else{if(fs.existsSync(configurationFileOrObject)){log4js.configure(configurationFileOrObject);}else{log4js.configure(JSON.parse(configurationFileOrObject));}}}catch(err){console.error("Loading default config as Configuration File or Object is not valid.",err);log4js.configure(defaultConfig);}}else{log4js.configure(defaultConfig);}this._initialized=true;}return this;};Logger.prototype.getLogger=function(category,prefix){if(!this._initialized){this.init(configurationFileOrObject);}var name;if(category&&prefix){name=prefix+'#'+category;}else if(category){name=category;}else{name=this._getCallerFile();}if(typeof window!=='undefined'){loggers[name]=log4js.getLogger(name);}else{if(!loggers.hasOwnProperty(name)){loggers[name]=new _Logger(log4js.getLogger(name));}}return loggers[name];};Logger.prototype._getCallerFile=function(){var originalFunc=Error.prepareStackTrace;var classPath=null;try{if(typeof window!=='undefined'){return path.basename(__filename);}else{var appRoot=require('app-root-path');var error=new Error();var callerFile;var currentFile;Error.prepareStackTrace=function(err,stack){return stack;};currentFile=error.stack.shift().getFileName();while(error.stack.length){callerFile=error.stack.shift().getFileName();if(currentFile!==callerFile){var pathFromRoot=callerFile.replace(appRoot+"/","");classPath=pathFromRoot.substring(0,pathFromRoot.lastIndexOf('.')).replace(/\//g,".");break;}}}}catch(err){console.error("Error while getting caller file name: ",err);}finally{Error.prepareStackTrace=originalFunc;return classPath!=null?classPath:'default';}};var LOGGER=Symbol.for('logger');var globalRef=typeof global!=='undefined'?global:typeof self!=='undefined'?self:typeof window!='undefined'?window:{};var globalSymbols=Object.getOwnPropertySymbols(globalRef);var hasLogger=globalSymbols.indexOf(LOGGER)>-1;if(!hasLogger){var _logger=new Logger();globalRef[LOGGER]=_logger;}function newInstance(){return new Logger();}module.exports={instance:globalRef[LOGGER],newInstance:newInstance};}).call(this,require('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{},"/node_modules/js-logger/logger.js");},{"_process":170,"app-root-path":43,"continuation-local-storage":undefined,"fs":48,"log4js":152,"path":168}],98:[function(require,module,exports){'use strict';module.exports='1.9.2';},{}],99:[function(require,module,exports){"use strict";module.exports={'inherits':require('inherits'),'util':require('util'),'events':require('events'),'lodash/core':require('lodash/core'),'readable-stream':require('readable-stream'),'multistream':require('multistream'),'./VERSION':require('./VERSION'),'./cache':require('./cache'),'./connection':require('./connection'),'./core':require('./core'),'./csv':require('./csv'),'./date':require('./date'),'./http-api':require('./http-api'),'./logger':require('./logger'),'./oauth2':require('./oauth2'),'./process':require('./process'),'./promise':require('./promise'),'./query':require('./query'),'./quick-action':require('./quick-action'),'./record-stream':require('./record-stream'),'./record':require('./record'),'./soap':require('./soap'),'./sobject':require('./sobject'),'./soql-builder':require('./soql-builder'),'./transport':require('./transport')};},{"./VERSION":98,"./cache":115,"./connection":116,"./core":117,"./csv":118,"./date":119,"./http-api":120,"./logger":121,"./oauth2":122,"./process":123,"./promise":124,"./query":125,"./quick-action":126,"./record":128,"./record-stream":127,"./soap":130,"./sobject":131,"./soql-builder":132,"./transport":133,"events":57,"inherits":94,"lodash/core":146,"multistream":155,"readable-stream":143,"util":208}],100:[function(require,module,exports){'use strict';var _=require('lodash/core'),jsforce=require('../core'),Promise=require('../promise');var ReportInstance=function ReportInstance(report,id){this._report=report;this._conn=report._conn;this.id=id;};ReportInstance.prototype.retrieve=function(callback){var conn=this._conn,report=this._report;var url=[conn._baseUrl(),"analytics","reports",report.id,"instances",this.id].join('/');return conn.request(url).thenCall(callback);};var Report=function Report(conn,id){this._conn=conn;this.id=id;};Report.prototype.describe=function(callback){var url=[this._conn._baseUrl(),"analytics","reports",this.id,"describe"].join('/');return this._conn.request(url).thenCall(callback);};Report.prototype["delete"]=Report.prototype.del=Report.prototype.destroy=function(callback){var url=[this._conn._baseUrl(),"analytics","reports",this.id].join('/');return this._conn.request({method:'DELETE',url:url}).thenCall(callback);};Report.prototype.clone=function(name,callback){var url=[this._conn._baseUrl(),"analytics","reports"].join('/');url+="?cloneId="+this.id;var data={reportMetadata:{name:name}};var params={method:'POST',url:url,headers:{"Content-Type":"application/json"},body:JSON.stringify(data)};return this._conn.request(params).thenCall(callback);};Report.prototype.explain=function(callback){var url="/query/?explain="+this.id;return this._conn.request(url).thenCall(callback);};Report.prototype.run=Report.prototype.exec=Report.prototype.execute=function(options,callback){options=options||{};if(_.isFunction(options)){callback=options;options={};}var url=[this._conn._baseUrl(),"analytics","reports",this.id].join('/');url+="?includeDetails="+(options.details?"true":"false");var params={method:options.metadata?'POST':'GET',url:url};if(options.metadata){params.headers={"Content-Type":"application/json"};params.body=JSON.stringify(options.metadata);}return this._conn.request(params).thenCall(callback);};Report.prototype.executeAsync=function(options,callback){options=options||{};if(_.isFunction(options)){callback=options;options={};}var url=[this._conn._baseUrl(),"analytics","reports",this.id,"instances"].join('/');if(options.details){url+="?includeDetails=true";}var params={method:'POST',url:url,body:""};if(options.metadata){params.headers={"Content-Type":"application/json"};params.body=JSON.stringify(options.metadata);}return this._conn.request(params).thenCall(callback);};Report.prototype.instance=function(id){return new ReportInstance(this,id);};Report.prototype.instances=function(callback){var url=[this._conn._baseUrl(),"analytics","reports",this.id,"instances"].join('/');return this._conn.request(url).thenCall(callback);};var Dashboard=function Dashboard(conn,id){this._conn=conn;this.id=id;};Dashboard.prototype.describe=function(callback){var url=[this._conn._baseUrl(),"analytics","dashboards",this.id,"describe"].join('/');return this._conn.request(url).thenCall(callback);};Dashboard.prototype.components=function(componentIds,callback){var url=[this._conn._baseUrl(),"analytics","dashboards",this.id].join('/');var data={};if(_.isFunction(componentIds)){callback=componentIds;}else if(_.isArray(componentIds)){data.componentIds=componentIds;}else if(_.isString(componentIds)){data.componentIds=[componentIds];}var params={method:'POST',url:url,headers:{"Content-Type":"application/json"},body:JSON.stringify(data)};return this._conn.request(params).thenCall(callback);};Dashboard.prototype.status=function(callback){var url=[this._conn._baseUrl(),"analytics","dashboards",this.id,"status"].join('/');return this._conn.request(url).thenCall(callback);};Dashboard.prototype.refresh=function(callback){var url=[this._conn._baseUrl(),"analytics","dashboards",this.id].join('/');var params={method:'PUT',url:url,body:''};return this._conn.request(params).thenCall(callback);};Dashboard.prototype.clone=function(name,folderid,callback){var url=[this._conn._baseUrl(),"analytics","dashboards"].join('/');url+="?cloneId="+this.id;var data={};if(_.isObject(name)){data=name;callback=folderid;}else{data.name=name;data.folderId=folderid;}var params={method:'POST',url:url,headers:{"Content-Type":"application/json"},body:JSON.stringify(data)};return this._conn.request(params).thenCall(callback);};Dashboard.prototype["delete"]=Dashboard.prototype.del=Dashboard.prototype.destroy=function(callback){var url=[this._conn._baseUrl(),"analytics","dashboards",this.id].join('/');return this._conn.request({method:'DELETE',url:url}).thenCall(callback);};var Analytics=function Analytics(conn){this._conn=conn;};Analytics.prototype.report=function(id){return new Report(this._conn,id);};Analytics.prototype.reports=function(callback){var url=[this._conn._baseUrl(),"analytics","reports"].join('/');return this._conn.request(url).thenCall(callback);};Analytics.prototype.dashboard=function(id){return new Dashboard(this._conn,id);};Analytics.prototype.dashboards=function(callback){var url=[this._conn._baseUrl(),"analytics","dashboards"].join('/');return this._conn.request(url).thenCall(callback);};jsforce.on('connection:new',function(conn){conn.analytics=new Analytics(conn);});module.exports=Analytics;},{"../core":117,"../promise":124,"lodash/core":146}],101:[function(require,module,exports){'use strict';var jsforce=require('../core');var Apex=function Apex(conn){this._conn=conn;};Apex.prototype._baseUrl=function(){return this._conn.instanceUrl+"/services/apexrest";};Apex.prototype._createRequestParams=function(method,path,body,options){var params={method:method,url:this._baseUrl()+path},_headers={};if(options&&'object'===_typeof(options['headers'])){_headers=options['headers'];}if(!/^(GET|DELETE)$/i.test(method)){_headers["Content-Type"]="application/json";}params.headers=_headers;if(body){params.body=JSON.stringify(body);}return params;};Apex.prototype.get=function(path,options,callback){if(typeof options==='function'){callback=options;options=undefined;}return this._conn.request(this._createRequestParams('GET',path,undefined,options)).thenCall(callback);};Apex.prototype.post=function(path,body,options,callback){if(typeof body==='function'){callback=body;body=undefined;options=undefined;}if(typeof options==='function'){callback=options;options=undefined;}var params=this._createRequestParams('POST',path,body,options);return this._conn.request(params).thenCall(callback);};Apex.prototype.put=function(path,body,options,callback){if(typeof body==='function'){callback=body;body=undefined;options=undefined;}if(typeof options==='function'){callback=options;options=undefined;}var params=this._createRequestParams('PUT',path,body,options);return this._conn.request(params).thenCall(callback);};Apex.prototype.patch=function(path,body,options,callback){if(typeof body==='function'){callback=body;body=undefined;options=undefined;}if(typeof options==='function'){callback=options;options=undefined;}var params=this._createRequestParams('PATCH',path,body,options);return this._conn.request(params).thenCall(callback);};Apex.prototype.del=Apex.prototype["delete"]=function(path,options,callback){if(typeof options==='function'){callback=options;options=undefined;}return this._conn.request(this._createRequestParams('DELETE',path,undefined,options)).thenCall(callback);};jsforce.on('connection:new',function(conn){conn.apex=new Apex(conn);});module.exports=Apex;},{"../core":117}],102:[function(require,module,exports){(function(process){'use strict';var inherits=require('inherits'),stream=require('readable-stream'),Duplex=stream.Duplex,events=require('events'),_=require('lodash/core'),joinStreams=require('multistream'),jsforce=require('../core'),RecordStream=require('../record-stream'),Promise=require('../promise'),HttpApi=require('../http-api');var Job=function Job(bulk,type,operation,options,jobId){this._bulk=bulk;this.type=type;this.operation=operation;this.options=options||{};this.id=jobId;this.state=this.id?'Open':'Unknown';this._batches={};};inherits(Job,events.EventEmitter);Job.prototype.info=function(callback){var self=this;if(!this._jobInfo){this._jobInfo=this.check();}return this._jobInfo.thenCall(callback);};Job.prototype.open=function(callback){var self=this;var bulk=this._bulk;var logger=bulk._logger;if(!this._jobInfo){var operation=this.operation.toLowerCase();if(operation==='harddelete'){operation='hardDelete';}var body=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo  xmlns="http://www.force.com/2009/06/asyncapi/dataload">','<operation>'+operation+'</operation>','<object>'+this.type+'</object>',this.options.extIdField?'<externalIdFieldName>'+this.options.extIdField+'</externalIdFieldName>':'',this.options.concurrencyMode?'<concurrencyMode>'+this.options.concurrencyMode+'</concurrencyMode>':'',this.options.assignmentRuleId?'<assignmentRuleId>'+this.options.assignmentRuleId+'</assignmentRuleId>':'','<contentType>CSV</contentType>','</jobInfo>'].join('');this._jobInfo=bulk._request({method:'POST',path:"/job",body:body,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"}).then(function(res){self.emit("open",res.jobInfo);self.id=res.jobInfo.id;self.state=res.jobInfo.state;return res.jobInfo;},function(err){self.emit("error",err);throw err;});}return this._jobInfo.thenCall(callback);};Job.prototype.createBatch=function(){var batch=new Batch(this);var self=this;batch.on('queue',function(){self._batches[batch.id]=batch;});return batch;};Job.prototype.batch=function(batchId){var batch=this._batches[batchId];if(!batch){batch=new Batch(this,batchId);this._batches[batchId]=batch;}return batch;};Job.prototype.check=function(callback){var self=this;var bulk=this._bulk;var logger=bulk._logger;this._jobInfo=this._waitAssign().then(function(){return bulk._request({method:'GET',path:"/job/"+self.id,responseType:"application/xml"});}).then(function(res){logger.debug(res.jobInfo);self.id=res.jobInfo.id;self.type=res.jobInfo.object;self.operation=res.jobInfo.operation;self.state=res.jobInfo.state;return res.jobInfo;});return this._jobInfo.thenCall(callback);};Job.prototype._waitAssign=function(callback){return(this.id?Promise.resolve({id:this.id}):this.open()).thenCall(callback);};Job.prototype.list=function(callback){var self=this;var bulk=this._bulk;var logger=bulk._logger;return this._waitAssign().then(function(){return bulk._request({method:'GET',path:"/job/"+self.id+"/batch",responseType:"application/xml"});}).then(function(res){logger.debug(res.batchInfoList.batchInfo);var batchInfoList=res.batchInfoList;batchInfoList=_.isArray(batchInfoList.batchInfo)?batchInfoList.batchInfo:[batchInfoList.batchInfo];return batchInfoList;}).thenCall(callback);};Job.prototype.close=function(){var self=this;return this._changeState("Closed").then(function(jobInfo){self.id=null;self.emit("close",jobInfo);return jobInfo;},function(err){self.emit("error",err);throw err;});};Job.prototype.abort=function(){var self=this;return this._changeState("Aborted").then(function(jobInfo){self.id=null;self.emit("abort",jobInfo);return jobInfo;},function(err){self.emit("error",err);throw err;});};Job.prototype._changeState=function(state,callback){var self=this;var bulk=this._bulk;var logger=bulk._logger;this._jobInfo=this._waitAssign().then(function(){var body=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo xmlns="http://www.force.com/2009/06/asyncapi/dataload">','<state>'+state+'</state>','</jobInfo>'].join('');return bulk._request({method:'POST',path:"/job/"+self.id,body:body,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"});}).then(function(res){logger.debug(res.jobInfo);self.state=res.jobInfo.state;return res.jobInfo;});return this._jobInfo.thenCall(callback);};var Batch=function Batch(job,batchId){Batch.super_.call(this,{objectMode:true});this.job=job;this.id=batchId;this._bulk=job._bulk;this._deferred=Promise.defer();this._setupDataStreams();};inherits(Batch,stream.Writable);Batch.prototype._setupDataStreams=function(){var batch=this;var converterOptions={nullValue:'#N/A'};this._uploadStream=new RecordStream.Serializable();this._uploadDataStream=this._uploadStream.stream('csv',converterOptions);this._downloadStream=new RecordStream.Parsable();this._downloadDataStream=this._downloadStream.stream('csv',converterOptions);this.on('finish',function(){batch._uploadStream.end();});this._uploadDataStream.once('readable',function(){batch.job.open().then(function(){batch._uploadDataStream.pipe(batch._createRequestStream());});});var dataStream=this._dataStream=new Duplex();dataStream._write=function(data,enc,cb){batch._uploadDataStream.write(data,enc,cb);};dataStream.on('finish',function(){batch._uploadDataStream.end();});this._downloadDataStream.on('readable',function(){dataStream.read(0);});this._downloadDataStream.on('end',function(){dataStream.push(null);});dataStream._read=function(size){var chunk;while((chunk=batch._downloadDataStream.read())!==null){dataStream.push(chunk);}};};Batch.prototype._createRequestStream=function(){var batch=this;var bulk=batch._bulk;var logger=bulk._logger;return bulk._request({method:'POST',path:"/job/"+batch.job.id+"/batch",headers:{"Content-Type":"text/csv"},responseType:"application/xml"},function(err,res){if(err){batch.emit('error',err);}else{logger.debug(res.batchInfo);batch.id=res.batchInfo.id;batch.emit('queue',res.batchInfo);}}).stream();};Batch.prototype._write=function(record,enc,cb){record=_.clone(record);if(this.job.operation==="insert"){delete record.Id;}else if(this.job.operation==="delete"){record={Id:record.Id};}delete record.type;delete record.attributes;this._uploadStream.write(record,enc,cb);};Batch.prototype.stream=function(){return this._dataStream;};Batch.prototype.run=Batch.prototype.exec=Batch.prototype.execute=function(input,callback){var self=this;if(typeof input==='function'){callback=input;input=null;}if(this._result){throw new Error("Batch already executed.");}var rdeferred=Promise.defer();this._result=rdeferred.promise;this._result.then(function(res){self._deferred.resolve(res);},function(err){self._deferred.reject(err);});this.once('response',function(res){rdeferred.resolve(res);});this.once('error',function(err){rdeferred.reject(err);});if(_.isObject(input)&&_.isFunction(input.pipe)){input.pipe(this._dataStream);}else{var data;if(_.isArray(input)){_.forEach(input,function(record){Object.keys(record).forEach(function(key){if(typeof record[key]==='boolean'){record[key]=String(record[key]);}});self.write(record);});self.end();}else if(_.isString(input)){data=input;this._dataStream.write(data,'utf8');this._dataStream.end();}}return this.thenCall(callback);};Batch.prototype.then=function(onResolved,onReject,onProgress){return this._deferred.promise.then(onResolved,onReject,onProgress);};Batch.prototype.thenCall=function(callback){if(_.isFunction(callback)){this.then(function(res){process.nextTick(function(){callback(null,res);});},function(err){process.nextTick(function(){callback(err);});});}return this;};Batch.prototype.check=function(callback){var self=this;var bulk=this._bulk;var logger=bulk._logger;var jobId=this.job.id;var batchId=this.id;if(!jobId||!batchId){throw new Error("Batch not started.");}return bulk._request({method:'GET',path:"/job/"+jobId+"/batch/"+batchId,responseType:"application/xml"}).then(function(res){logger.debug(res.batchInfo);return res.batchInfo;}).thenCall(callback);};Batch.prototype.poll=function(interval,timeout){var self=this;var jobId=this.job.id;var batchId=this.id;if(!jobId||!batchId){throw new Error("Batch not started.");}var startTime=new Date().getTime();var poll=function poll(){var now=new Date().getTime();if(startTime+timeout<now){var err=new Error("Polling time out. Job Id = "+jobId+" , batch Id = "+batchId);err.name='PollingTimeout';err.jobId=jobId;err.batchId=batchId;self.emit('error',err);return;}self.check(function(err,res){if(err){self.emit('error',err);}else{if(res.state==="Failed"){if(parseInt(res.numberRecordsProcessed,10)>0){self.retrieve();}else{self.emit('error',new Error(res.stateMessage));}}else if(res.state==="Completed"){self.retrieve();}else{self.emit('progress',res);setTimeout(poll,interval);}}});};setTimeout(poll,interval);};Batch.prototype.retrieve=function(callback){var self=this;var bulk=this._bulk;var jobId=this.job.id;var job=this.job;var batchId=this.id;if(!jobId||!batchId){throw new Error("Batch not started.");}return job.info().then(function(jobInfo){return bulk._request({method:'GET',path:"/job/"+jobId+"/batch/"+batchId+"/result"});}).then(function(res){var results;if(job.operation==='query'){var conn=bulk._conn;var resultIds=res['result-list'].result;results=res['result-list'].result;results=_.map(_.isArray(results)?results:[results],function(id){return{id:id,batchId:batchId,jobId:jobId};});}else{results=_.map(res,function(ret){return{id:ret.Id||null,success:ret.Success==="true",errors:ret.Error?[ret.Error]:[]};});}self.emit('response',results);return results;}).fail(function(err){self.emit('error',err);throw err;}).thenCall(callback);};Batch.prototype.result=function(resultId){var jobId=this.job.id;var batchId=this.id;if(!jobId||!batchId){throw new Error("Batch not started.");}var resultStream=new RecordStream.Parsable();var resultDataStream=resultStream.stream('csv');var reqStream=this._bulk._request({method:'GET',path:"/job/"+jobId+"/batch/"+batchId+"/result/"+resultId,responseType:"application/octet-stream"}).stream().pipe(resultDataStream);return resultStream;};var BulkApi=function BulkApi(){BulkApi.super_.apply(this,arguments);};inherits(BulkApi,HttpApi);BulkApi.prototype.beforeSend=function(request){request.headers=request.headers||{};request.headers["X-SFDC-SESSION"]=this._conn.accessToken;};BulkApi.prototype.isSessionExpired=function(response){return response.statusCode===400&&/<exceptionCode>InvalidSessionId<\/exceptionCode>/.test(response.body);};BulkApi.prototype.hasErrorInResponseBody=function(body){return!!body.error;};BulkApi.prototype.parseError=function(body){return{errorCode:body.error.exceptionCode,message:body.error.exceptionMessage};};var Bulk=function Bulk(conn){this._conn=conn;this._logger=conn._logger;};Bulk.prototype.pollInterval=1000;Bulk.prototype.pollTimeout=10000;Bulk.prototype._request=function(request,callback){var conn=this._conn;request=_.clone(request);var baseUrl=[conn.instanceUrl,"services/async",conn.version].join('/');request.url=baseUrl+request.path;var options={responseType:request.responseType};delete request.path;delete request.responseType;return new BulkApi(this._conn,options).request(request).thenCall(callback);};Bulk.prototype.load=function(type,operation,options,input,callback){var self=this;if(!type||!operation){throw new Error("Insufficient arguments. At least, 'type' and 'operation' are required.");}if(!_.isObject(options)||options.constructor!==Object){callback=input;input=options;options=null;}var job=this.createJob(type,operation,options);job.once('error',function(error){if(batch){batch.emit('error',error);}});var batch=job.createBatch();var cleanup=function cleanup(){batch=null;job.close();};var cleanupOnError=function cleanupOnError(err){if(err.name!=='PollingTimeout'){cleanup();}};batch.on('response',cleanup);batch.on('error',cleanupOnError);batch.on('queue',function(){batch.poll(self.pollInterval,self.pollTimeout);});return batch.execute(input,callback);};Bulk.prototype.query=function(soql){var m=soql.replace(/\([\s\S]+\)/g,'').match(/FROM\s+(\w+)/i);if(!m){throw new Error("No sobject type found in query, maybe caused by invalid SOQL.");}var type=m[1];var self=this;var recordStream=new RecordStream.Parsable();var dataStream=recordStream.stream('csv');this.load(type,"query",soql).then(function(results){var streams=results.map(function(result){return self.job(result.jobId).batch(result.batchId).result(result.id).stream();});joinStreams(streams).pipe(dataStream);}).fail(function(err){recordStream.emit('error',err);});return recordStream;};Bulk.prototype.createJob=function(type,operation,options){return new Job(this,type,operation,options);};Bulk.prototype.job=function(jobId){return new Job(this,null,null,null,jobId);};jsforce.on('connection:new',function(conn){conn.bulk=new Bulk(conn);});module.exports=Bulk;}).call(this,require('_process'));},{"../core":117,"../http-api":120,"../promise":124,"../record-stream":127,"_process":170,"events":57,"inherits":94,"lodash/core":146,"multistream":155,"readable-stream":143}],103:[function(require,module,exports){'use strict';var inherits=require('inherits'),_=require('lodash/core'),jsforce=require('../core'),Promise=require('../promise');var Chatter=module.exports=function(conn){this._conn=conn;};Chatter.prototype._request=function(params,callback){if(/^(put|post|patch)$/i.test(params.method)){if(_.isObject(params.body)){params.headers={"Content-Type":"application/json"};params.body=JSON.stringify(params.body);}}params.url=this._normalizeUrl(params.url);return this._conn.request(params,callback);};Chatter.prototype._normalizeUrl=function(url){if(url.indexOf('/chatter/')===0||url.indexOf('/connect/')===0){return'/services/data/v'+this._conn.version+url;}else if(/^\/v[\d]+\.[\d]+\//.test(url)){return'/services/data'+url;}else if(url.indexOf('/services/')!==0&&url[0]==='/'){return'/services/data/v'+this._conn.version+'/chatter'+url;}else{return url;}};Chatter.prototype.request=function(params,callback){return new Request(this,params).thenCall(callback);};Chatter.prototype.resource=function(url,queryParams){return new Resource(this,url,queryParams);};Chatter.prototype.batch=function(requests,callback){var self=this;var batchRequests=[],batchDeferreds=[];_.forEach(requests,function(request){var deferred=Promise.defer();request._promise=deferred.promise;batchRequests.push(request.batchParams());batchDeferreds.push(deferred);});var params={method:'POST',url:this._normalizeUrl('/connect/batch'),body:{batchRequests:batchRequests}};return this.request(params).then(function(res){_.forEach(res.results,function(result,i){var deferred=batchDeferreds[i];if(result.statusCode>=400){deferred.reject(result.result);}else{deferred.resolve(result.result);}});return res;}).thenCall(callback);};var Request=function Request(chatter,params){this._chatter=chatter;this._params=params;this._promise=null;};Request.prototype.batchParams=function(){var params=this._params;var batchParams={method:params.method,url:this._chatter._normalizeUrl(params.url)};if(this._params.body){batchParams.richInput=this._params.body;}return batchParams;};Request.prototype.promise=function(){return this._promise||this._chatter._request(this._params);};Request.prototype.stream=function(){return this._chatter._request(this._params).stream();};Request.prototype.then=function(onResolve,onReject){return this.promise().then(onResolve,onReject);};Request.prototype.thenCall=function(callback){return _.isFunction(callback)?this.promise().thenCall(callback):this;};var Resource=function Resource(chatter,url,queryParams){if(queryParams){var qstring=_.map(_.keys(queryParams),function(name){return name+"="+encodeURIComponent(queryParams[name]);}).join('&');url+=(url.indexOf('?')>0?'&':'?')+qstring;}Resource.super_.call(this,chatter,{method:'GET',url:url});this._url=url;};inherits(Resource,Request);Resource.prototype.create=function(data,callback){return this._chatter.request({method:'POST',url:this._url,body:data}).thenCall(callback);};Resource.prototype.retrieve=function(callback){return this.thenCall(callback);};Resource.prototype.update=function(data,callback){return this._chatter.request({method:'POST',url:this._url,body:data}).thenCall(callback);};Resource.prototype.del=Resource.prototype["delete"]=function(callback){return this._chatter.request({method:'DELETE',url:this._url}).thenCall(callback);};jsforce.on('connection:new',function(conn){conn.chatter=new Chatter(conn);});},{"../core":117,"../promise":124,"inherits":94,"lodash/core":146}],104:[function(require,module,exports){require('./analytics');require('./apex');require('./bulk');require('./chatter');require('./metadata');require('./soap');require('./streaming');require('./tooling');},{"./analytics":100,"./apex":101,"./bulk":102,"./chatter":103,"./metadata":105,"./soap":106,"./streaming":108,"./tooling":109}],105:[function(require,module,exports){(function(process,Buffer){'use strict';var inherits=require('inherits'),events=require('events'),stream=require('readable-stream'),_=require('lodash/core'),jsforce=require('../core'),Promise=require('../promise'),SOAP=require('../soap');var Metadata=module.exports=function(conn){this._conn=conn;};Metadata.prototype.pollInterval=1000;Metadata.prototype.pollTimeout=10000;Metadata.prototype._invoke=function(method,message,callback){var soapEndpoint=new SOAP(this._conn,{xmlns:"http://soap.sforce.com/2006/04/metadata",endpointUrl:this._conn.instanceUrl+"/services/Soap/m/"+this._conn.version});return soapEndpoint.invoke(method,message).then(function(res){return res.result;}).thenCall(callback);};Metadata.prototype.createAsync=function(type,metadata,callback){if(Number(this._conn.version)>30){throw new Error("Async metadata CRUD calls are not supported on ver 31.0 or later.");}var convert=function convert(md){md["@xsi:type"]=type;return md;};var isArray=_.isArray(metadata);metadata=isArray?_.map(metadata,convert):convert(metadata);var res=this._invoke("create",{metadata:metadata});return new AsyncResultLocator(this,res,isArray).thenCall(callback);};function convertToSaveResult(result){var saveResult=_.clone(result);saveResult.success=saveResult.success==='true';return saveResult;}function convertToUpsertResult(result){var upsertResult=convertToSaveResult(result);upsertResult.created=upsertResult.created==='true';return upsertResult;}Metadata.prototype.createSync=Metadata.prototype.create=function(type,metadata,callback){var convert=function convert(md){md["@xsi:type"]=type;return md;};var isArray=_.isArray(metadata);metadata=isArray?_.map(metadata,convert):convert(metadata);return this._invoke("createMetadata",{metadata:metadata}).then(function(results){return _.isArray(results)?_.map(results,convertToSaveResult):convertToSaveResult(results);}).thenCall(callback);};function convertToMetadataInfo(rec){var metadataInfo=_.clone(rec);delete metadataInfo.$;return metadataInfo;}Metadata.prototype.readSync=Metadata.prototype.read=function(type,fullNames,callback){return this._invoke("readMetadata",{type:type,fullNames:fullNames}).then(function(res){return _.isArray(res.records)?_.map(res.records,convertToMetadataInfo):convertToMetadataInfo(res.records);}).thenCall(callback);};Metadata.prototype.updateAsync=function(type,updateMetadata,callback){if(Number(this._conn.version)>30){throw new Error("Async metadata CRUD calls are not supported on ver 31.0 or later.");}var convert=function convert(umd){umd.metadata["@xsi:type"]=type;return umd;};var isArray=_.isArray(updateMetadata);updateMetadata=isArray?_.map(updateMetadata,convert):convert(updateMetadata);var res=this._invoke("update",{updateMetadata:updateMetadata});return new AsyncResultLocator(this,res,isArray).thenCall(callback);};Metadata.prototype.updateSync=Metadata.prototype.update=function(type,metadata,callback){var convert=function convert(md){md["@xsi:type"]=type;return md;};var isArray=_.isArray(metadata);metadata=isArray?_.map(metadata,convert):convert(metadata);return this._invoke("updateMetadata",{metadata:metadata}).then(function(results){return _.isArray(results)?_.map(results,convertToSaveResult):convertToSaveResult(results);}).thenCall(callback);};Metadata.prototype.upsertSync=Metadata.prototype.upsert=function(type,metadata,callback){var convert=function convert(md){md["@xsi:type"]=type;return md;};var isArray=_.isArray(metadata);metadata=isArray?_.map(metadata,convert):convert(metadata);return this._invoke("upsertMetadata",{metadata:metadata}).then(function(results){return _.isArray(results)?_.map(results,convertToUpsertResult):convertToUpsertResult(results);}).thenCall(callback);};Metadata.prototype.deleteAsync=function(type,metadata,callback){if(Number(this._conn.version)>30){throw new Error("Async metadata CRUD calls are not supported on ver 31.0 or later.");}var convert=function convert(md){if(_.isString(md)){md={fullName:md};}md["@xsi:type"]=type;return md;};var isArray=_.isArray(metadata);metadata=isArray?_.map(metadata,convert):convert(metadata);var res=this._invoke("delete",{metadata:metadata});return new AsyncResultLocator(this,res,isArray).thenCall(callback);};Metadata.prototype.del=Metadata.prototype.deleteSync=Metadata.prototype["delete"]=function(type,fullNames,callback){return this._invoke("deleteMetadata",{type:type,fullNames:fullNames}).then(function(results){return _.isArray(results)?_.map(results,convertToSaveResult):convertToSaveResult(results);}).thenCall(callback);};Metadata.prototype.rename=function(type,oldFullName,newFullName,callback){return this._invoke("renameMetadata",{type:type,oldFullName:oldFullName,newFullName:newFullName}).then(function(result){return convertToSaveResult(result);}).thenCall(callback);};Metadata.prototype.checkStatus=function(ids,callback){var isArray=_.isArray(ids);var res=this._invoke("checkStatus",{asyncProcessId:ids});return new AsyncResultLocator(this,res,isArray).thenCall(callback);};Metadata.prototype.describe=function(version,callback){if(!_.isString(version)){callback=version;version=this._conn.version;}return this._invoke("describeMetadata",{asOfVersion:version}).then(function(res){res.metadataObjects=_.isArray(res.metadataObjects)?res.metadataObjects:[res.metadataObjects];res.metadataObjects=_.map(res.metadataObjects,function(mo){if(mo.childXmlNames){mo.childXmlNames=_.isArray(mo.childXmlNames)?mo.childXmlNames:[mo.childXmlNames];}mo.inFolder=mo.inFolder==='true';mo.metaFile=mo.metaFile==='true';return mo;});res.partialSaveAllowed=res.partialSaveAllowed==='true';res.testRequired=res.testRequired==='true';return res;}).thenCall(callback);};Metadata.prototype.list=function(queries,version,callback){if(!_.isString(version)){callback=version;version=this._conn.version;}if(!_.isArray(queries)){queries=[queries];}return this._invoke("listMetadata",{queries:queries,asOfVersion:version},callback);};Metadata.prototype.retrieve=function(request,callback){var res=this._invoke("retrieve",{request:request});return new RetrieveResultLocator(this,res).thenCall(callback);};Metadata.prototype.checkRetrieveStatus=function(id,callback){return this._invoke("checkRetrieveStatus",{asyncProcessId:id},callback);};Metadata.prototype.deploy=function(zipInput,options,callback){if(!options||_.isFunction(options)){callback=options;options={};}var deferred=Promise.defer();if(_.isObject(zipInput)&&_.isFunction(zipInput.pipe)){var bufs=[];zipInput.on('data',function(d){bufs.push(d);});zipInput.on('end',function(){deferred.resolve(Buffer.concat(bufs).toString('base64'));});}else if(zipInput instanceof Buffer){deferred.resolve(zipInput.toString('base64'));}else if(zipInput instanceof String||typeof zipInput==='string'){deferred.resolve(zipInput);}else{throw"Unexpected zipInput type";}var self=this;var res=deferred.promise.then(function(zipContentB64){return self._invoke("deploy",{ZipFile:zipContentB64,DeployOptions:options},callback);});return new DeployResultLocator(this,res).thenCall(callback);};Metadata.prototype.checkDeployStatus=function(id,includeDetails,callback){if(_.isObject(includeDetails)||_.isBoolean(includeDetails)){includeDetails=!!includeDetails;}else{callback=includeDetails;includeDetails=false;}return this._invoke("checkDeployStatus",{asyncProcessId:id,includeDetails:includeDetails}).then(function(res){res.done=res.done==='true';res.success=res.success==='true';res.checkOnly=res.checkOnly==='true';res.runTestsEnabled=res.runTestsEnabled==='true';if(res.ignoreWarnings){res.ignoreWarnings=res.ignoreWarnings==='true';}if(res.rollbackOnError){res.rollbackOnError=res.rollbackOnError==='true';}res.numberComponentErrors=Number(res.numberComponentErrors);res.numberComponentsDeployed=Number(res.numberComponentsDeployed);res.numberComponentsTotal=Number(res.numberComponentsTotal);res.numberTestErrors=Number(res.numberTestErrors);res.numberTestsCompleted=Number(res.numberTestsCompleted);res.numberTestsTotal=Number(res.numberTestsTotal);return res;}).thenCall(callback);};var AsyncResultLocator=function AsyncResultLocator(meta,results,isArray){this._meta=meta;this._results=results;this._isArray=isArray;};inherits(AsyncResultLocator,events.EventEmitter);AsyncResultLocator.prototype.then=function(onResolve,onReject){var self=this;return this._results.then(function(results){var convertType=function convertType(res){if(res.$&&res.$["xsi:nil"]==='true'){return null;}res.done=res.done==='true';return res;};results=_.isArray(results)?_.map(results,convertType):convertType(results);if(self._isArray&&!_.isArray(results)){results=[results];}return onResolve(results);},onReject);};AsyncResultLocator.prototype.thenCall=function(callback){return _.isFunction(callback)?this.then(function(res){process.nextTick(function(){callback(null,res);});},function(err){process.nextTick(function(){callback(err);});}):this;};AsyncResultLocator.prototype.check=function(callback){var self=this;var meta=this._meta;return this.then(function(results){var ids=_.isArray(results)?_.map(results,function(res){return res.id;}):results.id;self._ids=ids;return meta.checkStatus(ids);}).thenCall(callback);};AsyncResultLocator.prototype.poll=function(interval,timeout){var self=this;var startTime=new Date().getTime();var poll=function poll(){var now=new Date().getTime();if(startTime+timeout<now){var errMsg="Polling time out.";if(self._ids){errMsg+=" Process Id = "+self._ids;}self.emit('error',new Error(errMsg));return;}self.check().then(function(results){var done=true;var resultArr=_.isArray(results)?results:[results];for(var i=0,len=resultArr.length;i<len;i++){var result=resultArr[i];if(result&&!result.done){self.emit('progress',result);done=false;}}if(done){self.emit('complete',results);}else{setTimeout(poll,interval);}},function(err){self.emit('error',err);});};setTimeout(poll,interval);};AsyncResultLocator.prototype.complete=function(callback){var deferred=Promise.defer();this.on('complete',function(results){deferred.resolve(results);});this.on('error',function(err){deferred.reject(err);});var meta=this._meta;this.poll(meta.pollInterval,meta.pollTimeout);return deferred.promise.thenCall(callback);};var RetrieveResultLocator=function RetrieveResultLocator(meta,result){RetrieveResultLocator.super_.call(this,meta,result);};inherits(RetrieveResultLocator,AsyncResultLocator);RetrieveResultLocator.prototype.complete=function(callback){var meta=this._meta;return RetrieveResultLocator.super_.prototype.complete.call(this).then(function(result){return meta.checkRetrieveStatus(result.id);}).thenCall(callback);};RetrieveResultLocator.prototype.stream=function(){var self=this;var resultStream=new stream.Readable();var reading=false;resultStream._read=function(){if(reading){return;}reading=true;self.complete(function(err,result){if(err){resultStream.emit('error',err);}else{resultStream.push(new Buffer(result.zipFile,'base64'));resultStream.push(null);}});};return resultStream;};var DeployResultLocator=function DeployResultLocator(meta,result){DeployResultLocator.super_.call(this,meta,result);};inherits(DeployResultLocator,AsyncResultLocator);DeployResultLocator.prototype.complete=function(includeDetails,callback){if(_.isFunction(includeDetails)){callback=includeDetails;includeDetails=false;}var meta=this._meta;return DeployResultLocator.super_.prototype.complete.call(this).then(function(result){return meta.checkDeployStatus(result.id,includeDetails);}).thenCall(callback);};jsforce.on('connection:new',function(conn){conn.metadata=new Metadata(conn);});}).call(this,require('_process'),require("buffer").Buffer);},{"../core":117,"../promise":124,"../soap":130,"_process":170,"buffer":49,"events":57,"inherits":94,"lodash/core":146,"readable-stream":143}],106:[function(require,module,exports){'use strict';var _=require('lodash/core');var jsforce=require('../core');var SOAP=require('../soap');var SoapApi=module.exports=function(conn){this._conn=conn;};SoapApi.prototype._invoke=function(method,message,schema,callback){var soapEndpoint=new SOAP(this._conn,{xmlns:"urn:partner.soap.sforce.com",endpointUrl:this._conn.instanceUrl+"/services/Soap/u/"+this._conn.version});return soapEndpoint.invoke(method,message,{result:schema}).then(function(res){return res.result;}).thenCall(callback);};var Schemas={};SoapApi.prototype.convertLead=function(leadConverts,callback){var schema=_.isArray(leadConverts)?[Schemas.LeadConvertResult]:Schemas.LeadConvertResult;return this._invoke("convertLead",{leadConverts:leadConverts},schema,callback);};Schemas.LeadConvertResult={success:'boolean',errors:[],leadId:'string',accountId:'string',contactId:'string',opportunityId:'string'};SoapApi.prototype.merge=function(mergeRequests,callback){var schema=_.isArray(mergeRequests)?[Schemas.MergeResult]:Schemas.MergeResult;return this._invoke("merge",{mergeRequests:mergeRequests},schema,callback);};Schemas.MergeResult={success:'boolean',errors:[],id:'string',mergedRecordIds:['string'],updatedRelatedIds:['string']};SoapApi.prototype.emptyRecycleBin=function(ids,callback){return this._invoke("emptyRecycleBin",{ids:ids},[Schemas.EmptyRecycleBinResult],callback);};Schemas.EmptyRecycleBinResult={id:'string',success:'boolean',errors:[]};SoapApi.prototype.describeTabs=function(callback){return this._invoke("describeTabs",{},[Schemas.DescribeTabSetResult],callback);};Schemas.DescribeTabSetResult={label:'string',logoUrl:'string',namespace:'string',selected:'boolean',tabs:[{colors:[{theme:'string',color:'string',context:'string'}],iconUrl:'string',icons:[{theme:'string',height:'number',width:'number',url:'string',contentType:'string'}],label:'string',custom:'boolean',miniIconUrl:'string',name:'string',sobjectName:'string',url:'string'}]};SoapApi.prototype.getServerTimestamp=function(callback){return this._invoke("getServerTimestamp",{},Schemas.GetServerTimestampResult,callback);};Schemas.GetServerTimestampResult={timestamp:'string'};SoapApi.prototype.getUserInfo=function(callback){return this._invoke("getUserInfo",{},Schemas.GetUserInfoResult,callback);};Schemas.GetUserInfoResult={accessibilityMode:'boolean',currencySymbol:'string',orgAttachmentFileSizeLimit:'number',orgDefaultCurrencyIsoCode:'string',orgDisallowHtmlAttachments:'boolean',orgHasPersonAccounts:'boolean',organizationId:'string',organizationMultiCurrency:'boolean',organizationName:'string',profileId:'string',roleId:'string',sessionSecondsValid:'number',userDefaultCurrencyIsoCode:'string',userEmail:'string',userFullName:'string',userId:'string',userLanguage:'string',userLocale:'string',userName:'string',userTimeZone:'string',userType:'string',userUiSkin:'string'};SoapApi.prototype.setPassword=function(userId,password,callback){return this._invoke("setPassword",{userId:userId,password:password},callback);};SoapApi.prototype.resetPassword=function(userId,callback){return this._invoke("resetPassword",{userId:userId},callback);};SoapApi.prototype.create=function(sObjects,callback){var schema=_.isArray(sObjects)?[Schemas.SaveResult]:Schemas.SaveResult;var args={'@xmlns':'urn:partner.soap.sforce.com','@xmlns:ns1':'sobject.partner.soap.sforce.com','ns1:sObjects':sObjects};return this._invoke("create",args,schema,callback);};SoapApi.prototype.update=function(sObjects,callback){var schema=_.isArray(sObjects)?[Schemas.SaveResult]:Schemas.SaveResult;var args={'@xmlns':'urn:partner.soap.sforce.com','@xmlns:ns1':'sobject.partner.soap.sforce.com','ns1:sObjects':sObjects};return this._invoke("update",args,schema,callback);};Schemas.SaveResult={success:'boolean',errors:[],id:'string'};SoapApi.prototype.upsert=function(externalIdFieldName,sObjects,callback){var schema=_.isArray(sObjects)?[Schemas.UpsertResult]:Schemas.UpsertResult;var args={'@xmlns':'urn:partner.soap.sforce.com','@xmlns:ns1':'sobject.partner.soap.sforce.com','ns1:externalIDFieldName':externalIdFieldName,'ns1:sObjects':sObjects};return this._invoke("upsert",args,schema,callback);};Schemas.UpsertResult={created:'boolean',success:'boolean',errors:[],id:'string'};SoapApi.prototype.delete=function(ids,callback){var schema=_.isArray(ids)?[Schemas.DeleteResult]:Schemas.DeleteResult;var args={'@xmlns':'urn:partner.soap.sforce.com','@xmlns:ns1':'sobject.partner.soap.sforce.com','ns1:ids':ids};return this._invoke("delete",args,schema,callback);};Schemas.DeleteResult={success:'boolean',errors:[],id:'string'};jsforce.on('connection:new',function(conn){conn.soap=new SoapApi(conn);});module.exports=SoapApi;},{"../core":117,"../soap":130,"lodash/core":146}],107:[function(require,module,exports){var StreamingExtension={};StreamingExtension.AuthFailure=function(failureCallback){this.incoming=function(message,callback){if((message.channel==='/meta/connect'||message.channel==='/meta/handshake')&&message.advice&&message.advice.reconnect=='none'){failureCallback(message);}else{callback(message);}};};StreamingExtension.Replay=function(channel,replayId){var REPLAY_FROM_KEY="replay";var _extensionEnabled=replayId!=null?true:false;var _replay=replayId;var _channel=channel;this.setExtensionEnabled=function(extensionEnabled){_extensionEnabled=extensionEnabled;};this.setReplay=function(replay){_replay=parseInt(replay,10);};this.setChannel=function(channel){_channel=channel;};this.incoming=function(message,callback){if(message.channel==='/meta/handshake'){if(message.ext&&message.ext[REPLAY_FROM_KEY]==true){_extensionEnabled=true;}}else if(message.channel===_channel&&message.data&&message.data.event&&message.data.event.replayId){_replay=message.data.event.replayId;}callback(message);};this.outgoing=function(message,callback){if(message.channel==='/meta/subscribe'&&message.subscription===_channel){if(_extensionEnabled){if(!message.ext){message.ext={};}var replayFromMap={};replayFromMap[_channel]=_replay;message.ext[REPLAY_FROM_KEY]=replayFromMap;}}callback(message);};};module.exports=StreamingExtension;},{}],108:[function(require,module,exports){'use strict';var events=require('events'),inherits=require('inherits'),_=require('lodash/core'),Faye=require('faye'),StreamingExtension=require('./streaming-extension'),jsforce=require('../core');var Topic=function Topic(streaming,name){this._streaming=streaming;this.name=name;};Topic.prototype.subscribe=function(listener){return this._streaming.subscribe(this.name,listener);};Topic.prototype.unsubscribe=function(listener){this._streaming.unsubscribe(this.name,listener);return this;};var Channel=function Channel(streaming,name){this._streaming=streaming;this._name=name;};Channel.prototype.subscribe=function(listener){return this._streaming.subscribe(this._name,listener);};Channel.prototype.unsubscribe=function(listener){this._streaming.unsubscribe(this._name,listener);return this;};Channel.prototype.push=function(events,callback){var isArray=_.isArray(events);events=isArray?events:[events];var conn=this._streaming._conn;if(!this._id){this._id=conn.sobject('StreamingChannel').findOne({Name:this._name},'Id').then(function(rec){return rec.Id;});}return this._id.then(function(id){var channelUrl='/sobjects/StreamingChannel/'+id+'/push';return conn.requestPost(channelUrl,{pushEvents:events});}).then(function(rets){return isArray?rets:rets[0];}).thenCall(callback);};var Streaming=function Streaming(conn){this._conn=conn;};inherits(Streaming,events.EventEmitter);Streaming.prototype._createClient=function(forChannelName,extensions){var needsReplayFix=typeof forChannelName==='string'&&forChannelName.indexOf('/u/')===0;var endpointUrl=[this._conn.instanceUrl,"cometd"+(needsReplayFix===true&&this._conn.version==="36.0"?"/replay":""),this._conn.version].join('/');var fayeClient=new Faye.Client(endpointUrl,{});fayeClient.setHeader('Authorization','OAuth '+this._conn.accessToken);if(extensions instanceof Array){extensions.forEach(function(extension){fayeClient.addExtension(extension);});}if(fayeClient._dispatcher.getConnectionTypes().indexOf('callback-polling')===-1){fayeClient._dispatcher.selectTransport('long-polling');fayeClient._dispatcher._transport.batching=false;}return fayeClient;};Streaming.prototype._getFayeClient=function(channelName){var isGeneric=channelName.indexOf('/u/')===0;var clientType=isGeneric?'generic':'pushTopic';if(!this._fayeClients||!this._fayeClients[clientType]){this._fayeClients=this._fayeClients||{};this._fayeClients[clientType]=this._createClient(channelName);}return this._fayeClients[clientType];};Streaming.prototype.topic=function(name){this._topics=this._topics||{};var topic=this._topics[name]=this._topics[name]||new Topic(this,name);return topic;};Streaming.prototype.channel=function(channelId){return new Channel(this,channelId);};Streaming.prototype.subscribe=function(name,listener){var channelName=name.indexOf('/')===0?name:'/topic/'+name;var fayeClient=this._getFayeClient(channelName);return fayeClient.subscribe(channelName,listener);};Streaming.prototype.unsubscribe=function(name,listener){var channelName=name.indexOf('/')===0?name:'/topic/'+name;var fayeClient=this._getFayeClient(channelName);fayeClient.unsubscribe(channelName,listener);return this;};Streaming.prototype.createClient=function(extensions){return this._createClient(null,extensions);};jsforce.on('connection:new',function(conn){conn.streaming=new Streaming(conn);});jsforce.StreamingExtension=StreamingExtension;module.exports=Streaming;},{"../core":117,"./streaming-extension":107,"events":57,"faye":58,"inherits":94,"lodash/core":146}],109:[function(require,module,exports){'use strict';var jsforce=require('../core'),_=require('lodash/core'),Cache=require('../cache');var Tooling=function Tooling(conn){this._conn=conn;this._logger=conn._logger;var delegates=["query","queryMore","_toRecordResult","create","_createSingle","_createParallel","_createMany","insert","retrieve","_retrieveSingle","_retrieveParallel","_retrieveMany","update","_updateSingle","_updateParallel","_updateMany","upsert","del","delete","destroy","_destroySingle","_destroyParallel","_destroyMany","describe","describeGlobal","sobject"];delegates.forEach(function(method){this[method]=conn.constructor.prototype[method];},this);this.cache=new Cache();var cacheOptions={key:function key(type){return type?"describe."+type:"describe";}};this.describe$=this.cache.makeCacheable(this.describe,this,cacheOptions);this.describe=this.cache.makeResponseCacheable(this.describe,this,cacheOptions);this.describeSObject$=this.describe$;this.describeSObject=this.describe;cacheOptions={key:'describeGlobal'};this.describeGlobal$=this.cache.makeCacheable(this.describeGlobal,this,cacheOptions);this.describeGlobal=this.cache.makeResponseCacheable(this.describeGlobal,this,cacheOptions);this.initialize();};Tooling.prototype.initialize=function(){this.sobjects={};this.cache.clear();this.cache.get('describeGlobal').removeAllListeners('value');this.cache.get('describeGlobal').on('value',_.bind(function(res){if(res.result){var types=_.map(res.result.sobjects,function(so){return so.name;});types.forEach(this.sobject,this);}},this));};Tooling.prototype._baseUrl=function(){return this._conn._baseUrl()+"/tooling";};Tooling.prototype._supports=function(feature){if(feature==='sobject-collection'){return false;}return this._conn._supports.apply(this._conn,arguments);};Tooling.prototype.request=function(){return this._conn.request.apply(this._conn,arguments);};Tooling.prototype.executeAnonymous=function(body,callback){var url=this._baseUrl()+"/executeAnonymous?anonymousBody="+encodeURIComponent(body);return this.request(url).thenCall(callback);};Tooling.prototype.runTestsAsynchronous=function(classids,callback){var url=this._baseUrl()+"/runTestsAsynchronous/";return this._conn.requestPost(url,{classids:classids.join(',')},undefined,callback);};Tooling.prototype.runTestsSynchronous=function(classnames,callback){var url=this._baseUrl()+"/runTestsSynchronous/";return this._conn.requestPost(url,{classnames:classnames.join(',')},undefined,callback);};Tooling.prototype.completions=function(type,callback){if(!_.isString(type)){callback=type;type='apex';}var url=this._baseUrl()+"/completions?type="+encodeURIComponent(type);return this.request(url).thenCall(callback);};jsforce.on('connection:new',function(conn){conn.tooling=new Tooling(conn);});module.exports=Tooling;},{"../cache":115,"../core":117,"lodash/core":146}],110:[function(require,module,exports){'use strict';var Duplex=require('readable-stream').Duplex,_=require('lodash/core');function parseHeaders(hs){var headers={};hs.split(/\n/).forEach(function(line){var pair=line.split(/\s*:\s*/);var name=pair[0].toLowerCase();var value=pair[1];headers[name]=value;});return headers;}module.exports={supported:(typeof Sfdc==="undefined"?"undefined":_typeof(Sfdc))==='object'&&typeof Sfdc.canvas!=='undefined',createRequest:function createRequest(signedRequest){return function(params,callback){var response;var str=new Duplex();str._read=function(size){if(response){str.push(response.body);}};var bufs=[];var sent=false;str._write=function(chunk,encoding,callback){bufs.push(chunk.toString(encoding));callback();};str.on('finish',function(){if(!sent){send(bufs.join(''));sent=true;}});if(params.body||params.body===""||!/^(put|post|patch)$/i.test(params.method)){send(params.body);sent=true;}function send(body){var settings={client:signedRequest.client,method:params.method,data:body};if(params.headers){settings.headers={};for(var name in params.headers){if(name.toLowerCase()==='content-type'){settings.contentType=params.headers[name];}else{settings.headers[name]=params.headers[name];}}}settings.success=function(data){var headers=parseHeaders(data.responseHeaders);var body=data.payload;if(!_.isString(body)){body=JSON.stringify(body);}response={statusCode:data.status,headers:headers,body:body};if(callback){callback(null,response,response.body);}str.end();};settings.failure=function(err){if(callback){callback(err);}};Sfdc.canvas.client.ajax(params.url,settings);}return str;};}};},{"lodash/core":146,"readable-stream":143}],111:[function(require,module,exports){'use strict';var events=require('events'),inherits=require('inherits'),qs=require('querystring'),_=require('lodash/core'),Connection=require('../connection'),OAuth2=require('../oauth2');function popupWin(url,w,h){var left=screen.width/2-w/2;var top=screen.height/2-h/2;return window.open(url,null,'location=yes,toolbar=no,status=no,menubar=no,width='+w+',height='+h+',top='+top+',left='+left);}function handleCallbackResponse(){var res=checkCallbackResponse();var state=localStorage.getItem('jsforce_state');if(res&&state&&res.body.state===state){localStorage.removeItem('jsforce_state');var states=state.split('.');var prefix=states[0],promptType=states[1];var cli=new Client(prefix);if(res.success){cli._storeTokens(res.body);location.hash='';}else{cli._storeError(res.body);}if(promptType==='popup'){window.close();}return true;}}function checkCallbackResponse(){var params;if(window.location.hash){params=qs.parse(window.location.hash.substring(1));if(params.access_token){return{success:true,body:params};}}else if(window.location.search){params=qs.parse(window.location.search.substring(1));if(params.error){return{success:false,body:params};}}}var clientIdx=0;var Client=function Client(prefix){this._prefix=prefix||'jsforce'+clientIdx++;this.connection=null;};inherits(Client,events.EventEmitter);Client.prototype.init=function(config){if(handleCallbackResponse()){return;}this.config=config;this.connection=new Connection(config);var tokens=this._getTokens();if(tokens){this.connection.initialize(tokens);var self=this;setTimeout(function(){self.emit('connect',self.connection);},10);}};Client.prototype.login=function(options,callback){if(_.isFunction(options)){callback=options;options={};}options=options||{};callback=callback||function(){};_.extend(options,this.config);var self=this;this._prompt(options,callback);};Client.prototype._prompt=function(options,callback){var self=this;var oauth2=new OAuth2(options);var rand=Math.random().toString(36).substring(2);var state=[this._prefix,"popup",rand].join('.');localStorage.setItem("jsforce_state",state);var authzUrl=oauth2.getAuthorizationUrl({response_type:'token',scope:options.scope,state:state});var size=options.size||{};var pw=popupWin(authzUrl,size.width||912,size.height||513);if(!pw){state=[this._prefix,"redirect",rand].join('.');localStorage.setItem("jsforce_state",state);authzUrl=oauth2.getAuthorizationUrl({response_type:'token',scope:options.scope,state:state});location.href=authzUrl;return;}self._removeTokens();var pid=setInterval(function(){try{if(!pw||pw.closed){clearInterval(pid);var tokens=self._getTokens();if(tokens){self.connection.initialize(tokens);self.emit('connect',self.connection);callback(null,{status:'connect'});}else{var err=self._getError();if(err){callback(new Error(err.error+": "+err.error_description));}else{callback(null,{status:'cancel'});}}}}catch(e){}},1000);};Client.prototype.isLoggedIn=function(){return!!(this.connection&&this.connection.accessToken);};Client.prototype.logout=function(){this.connection.logout();this._removeTokens();this.emit('disconnect');};Client.prototype._getTokens=function(){var regexp=new RegExp("(^|;\\s*)"+this._prefix+"_loggedin=true(;|$)");if(document.cookie.match(regexp)){var issuedAt=Number(localStorage.getItem(this._prefix+'_issued_at'));if(Date.now()<issuedAt+2*60*60*1000){var userInfo;var idUrl=localStorage.getItem(this._prefix+'_id');if(idUrl){var ids=idUrl.split('/');userInfo={id:ids.pop(),organizationId:ids.pop(),url:idUrl};}return{accessToken:localStorage.getItem(this._prefix+'_access_token'),instanceUrl:localStorage.getItem(this._prefix+'_instance_url'),userInfo:userInfo};}}return null;};Client.prototype._storeTokens=function(params){localStorage.setItem(this._prefix+'_access_token',params.access_token);localStorage.setItem(this._prefix+'_instance_url',params.instance_url);localStorage.setItem(this._prefix+'_issued_at',params.issued_at);localStorage.setItem(this._prefix+'_id',params.id);document.cookie=this._prefix+'_loggedin=true;';};Client.prototype._removeTokens=function(){localStorage.removeItem(this._prefix+'_access_token');localStorage.removeItem(this._prefix+'_instance_url');localStorage.removeItem(this._prefix+'_issued_at');localStorage.removeItem(this._prefix+'_id');document.cookie=this._prefix+'_loggedin=';};Client.prototype._getError=function(){try{var err=JSON.parse(localStorage.getItem(this._prefix+'_error'));localStorage.removeItem(this._prefix+'_error');return err;}catch(e){}};Client.prototype._storeError=function(err){localStorage.setItem(this._prefix+'_error',JSON.stringify(err));};module.exports=new Client();module.exports.Client=Client;},{"../connection":116,"../oauth2":122,"events":57,"inherits":94,"lodash/core":146,"querystring":175}],112:[function(require,module,exports){'use strict';var jsforce=require('../core');jsforce.browser=require('./client');require('../api');module.exports=jsforce;},{"../api":104,"../core":117,"./client":111}],113:[function(require,module,exports){'use strict';var _index=0;module.exports={supported:typeof window!=='undefined'&&typeof document!=='undefined',createRequest:function createRequest(jsonpParam,timeout){jsonpParam=jsonpParam||'callback';timeout=timeout||10000;return function(params,callback){if(params.method.toUpperCase()!=='GET'){return callback(new Error('JSONP only supports GET request.'));}var cbFuncName='_jsforce_jsonpCallback_'+ ++_index;var callbacks=window;var url=params.url;url+=url.indexOf('?')>0?'&':'?';url+=jsonpParam+'='+cbFuncName;var script=document.createElement('script');script.type='text/javascript';script.src=url;document.documentElement.appendChild(script);var pid=setTimeout(function(){cleanup();callback(new Error("JSONP call time out."));},timeout);callbacks[cbFuncName]=function(res){cleanup();callback(null,{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify(res)});};var cleanup=function cleanup(){clearTimeout(pid);document.documentElement.removeChild(script);delete callbacks[cbFuncName];};};}};},{}],114:[function(require,module,exports){'use strict';var Duplex=require('readable-stream').Duplex;var _=require('lodash/core');module.exports=function(params,callback){var xhr=new XMLHttpRequest();xhr.open(params.method,params.url);if(params.headers){for(var header in params.headers){xhr.setRequestHeader(header,params.headers[header]);}}xhr.setRequestHeader("Accept","*/*");var response;var str=new Duplex();str._read=function(size){if(response){str.push(response.body);}};var bufs=[];var sent=false;str._write=function(chunk,encoding,callback){bufs.push(chunk.toString(encoding==="buffer"?"binary":encoding));callback();};str.on('finish',function(){if(!sent){xhr.send(bufs.join(''));sent=true;}});if(params.body||params.body===""||!/^(put|post|patch)$/i.test(params.method)){xhr.send(params.body);sent=true;}xhr.onreadystatechange=function(){if(xhr.readyState===4){var headerNames=getResponseHeaderNames(xhr);var headers={};_.forEach(headerNames,function(headerName){if(headerName){headers[headerName]=xhr.getResponseHeader(headerName);}});response={statusCode:xhr.status,headers:headers,body:xhr.response};if(!response.statusCode){response.statusCode=400;response.body="Access Declined";}if(callback){callback(null,response,response.body);}str.end();}};return str;};function getResponseHeaderNames(xhr){var headerLines=(xhr.getAllResponseHeaders()||"").split(/[\r\n]+/);return _.map(headerLines,function(headerLine){return headerLine.split(/\s*:/)[0].toLowerCase();});}},{"lodash/core":146,"readable-stream":143}],115:[function(require,module,exports){'use strict';var events=require('events'),inherits=require('inherits'),_=require('lodash/core');var CacheEntry=function CacheEntry(){this.fetching=false;};inherits(CacheEntry,events.EventEmitter);CacheEntry.prototype.get=function(callback){if(!callback){return this._value;}else{this.once('value',callback);if(!_.isUndefined(this._value)){this.emit('value',this._value);}}};CacheEntry.prototype.set=function(value){this._value=value;this.emit('value',this._value);};CacheEntry.prototype.clear=function(){this.fetching=false;delete this._value;};var Cache=function Cache(){this._entries={};};Cache.prototype.get=function(key){if(key&&this._entries[key]){return this._entries[key];}else{var entry=new CacheEntry();this._entries[key]=entry;return entry;}};Cache.prototype.clear=function(key){for(var k in this._entries){if(!key||k.indexOf(key)===0){this._entries[k].clear();}}};function createCacheKey(namespace,args){args=Array.prototype.slice.apply(args);return namespace+'('+_.map(args,function(a){return JSON.stringify(a);}).join(',')+')';}Cache.prototype.makeResponseCacheable=function(fn,scope,options){var cache=this;options=options||{};return function(){var args=Array.prototype.slice.apply(arguments);var callback=args.pop();if(!_.isFunction(callback)){args.push(callback);callback=null;}var key=_.isString(options.key)?options.key:_.isFunction(options.key)?options.key.apply(scope,args):createCacheKey(options.namespace,args);var entry=cache.get(key);entry.fetching=true;if(callback){args.push(function(err,result){entry.set({error:err,result:result});callback(err,result);});}var ret,error;try{ret=fn.apply(scope||this,args);}catch(e){error=e;}if(ret&&_.isFunction(ret.then)){if(!callback){return ret.then(function(result){entry.set({error:undefined,result:result});return result;},function(err){entry.set({error:err,result:undefined});throw err;});}else{return ret;}}else{entry.set({error:error,result:ret});if(error){throw error;}return ret;}};};Cache.prototype.makeCacheable=function(fn,scope,options){var cache=this;options=options||{};var $fn=function $fn(){var args=Array.prototype.slice.apply(arguments);var callback=args.pop();if(!_.isFunction(callback)){args.push(callback);}var key=_.isString(options.key)?options.key:_.isFunction(options.key)?options.key.apply(scope,args):createCacheKey(options.namespace,args);var entry=cache.get(key);if(!_.isFunction(callback)){var value=entry.get();if(!value){throw new Error('Function call result is not cached yet.');}if(value.error){throw value.error;}return value.result;}entry.get(function(value){callback(value.error,value.result);});if(!entry.fetching){entry.fetching=true;args.push(function(err,result){entry.set({error:err,result:result});});fn.apply(scope||this,args);}};$fn.clear=function(){var key=_.isString(options.key)?options.key:_.isFunction(options.key)?options.key.apply(scope,arguments):createCacheKey(options.namespace,arguments);cache.clear(key);};return $fn;};module.exports=Cache;},{"events":57,"inherits":94,"lodash/core":146}],116:[function(require,module,exports){(function(Buffer){'use strict';var events=require('events'),inherits=require('inherits'),_=require('lodash/core'),Promise=require('./promise'),Logger=require('./logger'),OAuth2=require('./oauth2'),Query=require('./query'),SObject=require('./sobject'),QuickAction=require('./quick-action'),HttpApi=require('./http-api'),Transport=require('./transport'),Process=require('./process'),Cache=require('./cache');var defaults={loginUrl:"https://login.salesforce.com",instanceUrl:"",version:"42.0"};var MAX_DML_COUNT=200;var Connection=module.exports=function(options){options=options||{};this._logger=new Logger(options.logLevel);var oauth2=options.oauth2||{loginUrl:options.loginUrl,clientId:options.clientId,clientSecret:options.clientSecret,redirectUri:options.redirectUri,proxyUrl:options.proxyUrl,httpProxy:options.httpProxy};this.oauth2=oauth2=oauth2 instanceof OAuth2?oauth2:new OAuth2(oauth2);this.loginUrl=options.loginUrl||oauth2.loginUrl||defaults.loginUrl;this.version=options.version||defaults.version;this.maxRequest=options.maxRequest||this.maxRequest||10;if(options.proxyUrl){this._transport=new Transport.ProxyTransport(options.proxyUrl);}else if(options.httpProxy){this._transport=new Transport.HttpProxyTransport(options.httpProxy);}else{this._transport=new Transport();}this.callOptions=options.callOptions;var jsforce=require('./core');jsforce.emit('connection:new',this);this.process=new Process(this);this.cache=new Cache();var self=this;var refreshFn=options.refreshFn;if(!refreshFn&&this.oauth2.clientId){refreshFn=oauthRefreshFn;}if(refreshFn){this._refreshDelegate=new HttpApi.SessionRefreshDelegate(this,refreshFn);}var cacheOptions={key:function key(type){return type?"describe."+type:"describe";}};this.describe$=this.cache.makeCacheable(this.describe,this,cacheOptions);this.describe=this.cache.makeResponseCacheable(this.describe,this,cacheOptions);this.describeSObject$=this.describe$;this.describeSObject=this.describe;cacheOptions={key:'describeGlobal'};this.describeGlobal$=this.cache.makeCacheable(this.describeGlobal,this,cacheOptions);this.describeGlobal=this.cache.makeResponseCacheable(this.describeGlobal,this,cacheOptions);this.initialize(options);};inherits(Connection,events.EventEmitter);Connection.prototype.initialize=function(options){if(!options.instanceUrl&&options.serverUrl){options.instanceUrl=options.serverUrl.split('/').slice(0,3).join('/');}this.instanceUrl=options.instanceUrl||options.serverUrl||this.instanceUrl||defaults.instanceUrl;this.accessToken=options.sessionId||options.accessToken||this.accessToken;this.refreshToken=options.refreshToken||this.refreshToken;if(this.refreshToken&&!this._refreshDelegate){throw new Error("Refresh token is specified without oauth2 client information or refresh function");}this.signedRequest=options.signedRequest&&parseSignedRequest(options.signedRequest);if(this.signedRequest){this.accessToken=this.signedRequest.client.oauthToken;if(Transport.CanvasTransport.supported){this._transport=new Transport.CanvasTransport(this.signedRequest);}}if(options.userInfo){this.userInfo=options.userInfo;}this.limitInfo={};this.sobjects={};this.cache.clear();this.cache.get('describeGlobal').removeAllListeners('value');this.cache.get('describeGlobal').on('value',_.bind(function(res){if(res.result){var types=_.map(res.result.sobjects,function(so){return so.name;});types.forEach(this.sobject,this);}},this));if(this.tooling){this.tooling.initialize();}this._sessionType=options.sessionId?"soap":"oauth2";};function oauthRefreshFn(conn,callback){conn.oauth2.refreshToken(conn.refreshToken,function(err,res){if(err){return callback(err);}var userInfo=parseIdUrl(res.id);conn.initialize({instanceUrl:res.instance_url,accessToken:res.access_token,userInfo:userInfo});callback(null,res.access_token,res);});}function parseSignedRequest(sr){if(_.isString(sr)){if(sr[0]==='{'){return JSON.parse(sr);}else{var msg=sr.split('.').pop();var json=Buffer.from(msg,'base64').toString('utf-8');return JSON.parse(json);}return null;}return sr;}Connection.prototype._baseUrl=function(){return[this.instanceUrl,"services/data","v"+this.version].join('/');};Connection.prototype._normalizeUrl=function(url){if(url[0]==='/'){if(url.indexOf('/services/')===0){return this.instanceUrl+url;}else{return this._baseUrl()+url;}}else{return url;}};Connection.prototype.request=function(request,options,callback){if(typeof options==='function'){callback=options;options=null;}options=options||{};var self=this;if(_.isString(request)){request={method:'GET',url:request};}request.url=this._normalizeUrl(request.url);var httpApi=new HttpApi(this,options);httpApi.on('response',function(response){if(response.headers&&response.headers["sforce-limit-info"]){var apiUsage=response.headers["sforce-limit-info"].match(/api\-usage=(\d+)\/(\d+)/);if(apiUsage){self.limitInfo={apiUsage:{used:parseInt(apiUsage[1],10),limit:parseInt(apiUsage[2],10)}};}}});return httpApi.request(request).thenCall(callback);};Connection.prototype.requestGet=function(url,options,callback){var request={method:"GET",url:url};return this.request(request,options,callback);};Connection.prototype.requestPost=function(url,body,options,callback){var request={method:"POST",url:url,body:JSON.stringify(body),headers:{"content-type":"application/json"}};return this.request(request,options,callback);};Connection.prototype.requestPut=function(url,body,options,callback){var request={method:"PUT",url:url,body:JSON.stringify(body),headers:{"content-type":"application/json"}};return this.request(request,options,callback);};Connection.prototype.requestPatch=function(url,body,options,callback){var request={method:"PATCH",url:url,body:JSON.stringify(body),headers:{"content-type":"application/json"}};return this.request(request,options,callback);};Connection.prototype.requestDelete=function(url,options,callback){var request={method:"DELETE",url:url};return this.request(request,options,callback);};function formatDate(date){function pad(number){if(number<10){return'0'+number;}return number;}return date.getUTCFullYear()+'-'+pad(date.getUTCMonth()+1)+'-'+pad(date.getUTCDate())+'T'+pad(date.getUTCHours())+':'+pad(date.getUTCMinutes())+':'+pad(date.getUTCSeconds())+'+00:00';}function parseIdUrl(idUrl){var idUrls=idUrl.split("/");var userId=idUrls.pop(),orgId=idUrls.pop();return{id:userId,organizationId:orgId,url:idUrl};}Connection.prototype.query=function(soql,options,callback){if(typeof options==='function'){callback=options;options=undefined;}var query=new Query(this,soql,options);if(callback){query.run(callback);}return query;};Connection.prototype.queryAll=function(soql,options,callback){if(typeof options==='function'){callback=options;options=undefined;}var query=new Query(this,soql,options);query.scanAll(true);if(callback){query.run(callback);}return query;};Connection.prototype.queryMore=function(locator,options,callback){if(typeof options==='function'){callback=options;options=undefined;}var query=new Query(this,{locator:locator},options);if(callback){query.run(callback);}return query;};Connection.prototype._ensureVersion=function(majorVersion){var versions=this.version.split('.');return parseInt(versions[0],10)>=majorVersion;};Connection.prototype._supports=function(feature){switch(feature){case'sobject-collection':return this._ensureVersion(42);default:return false;}};Connection.prototype.retrieve=function(type,ids,options,callback){if(typeof options==='function'){callback=options;options={};}options=options||{};return(_.isArray(ids)?this._supports('sobject-collection')?this._retrieveMany(type,ids,options):this._retrieveParallel(type,ids,options):this._retrieveSingle(type,ids,options)).thenCall(callback);};Connection.prototype._retrieveSingle=function(type,id,options){if(!id){return Promise.reject(new Error('Invalid record ID. Specify valid record ID value'));}var url=[this._baseUrl(),"sobjects",type,id].join('/');if(options.fields){url+='?fields='+options.fields.join(',');}return this.request({method:'GET',url:url,headers:options.headers});};Connection.prototype._retrieveParallel=function(type,ids,options){if(ids.length>this.maxRequest){return Promise.reject(new Error("Exceeded max limit of concurrent call"));}var self=this;return Promise.all(ids.map(function(id){return self._retrieveSingle(type,id,options).catch(function(err){if(options.allOrNone||err.errorCode!=='NOT_FOUND'){throw err;}return null;});}));};Connection.prototype._retrieveMany=function(type,ids,options){if(ids.length===0){return Promise.resolve([]);}var url=[this._baseUrl(),"composite","sobjects",type].join('/');var self=this;return(options.fields?Promise.resolve(options.fields):new Promise(function(resolve,reject){self.describe$(type,function(err,so){if(err){reject(err);}else{var fields=so.fields.map(function(field){return field.name;});resolve(fields);}});})).then(function(fields){return self.request({method:'POST',url:url,body:JSON.stringify({ids:ids,fields:fields}),headers:_.defaults(options.headers||{},{"Content-Type":"application/json"})});});};Connection.prototype._toRecordResult=function(id,err){var error={statusCode:err.errorCode,message:err.message};if(err.content){error.content=err.content;}if(err.fields){error.fields=err.fields;}var result={success:false,errors:[error]};if(id){result.id=id;}return result;};Connection.prototype.insert=Connection.prototype.create=function(type,records,options,callback){if(!_.isString(type)){callback=options;options=records;records=type;type=null;}if(typeof options==='function'){callback=options;options={};}options=options||{};return(_.isArray(records)?this._supports('sobject-collection')?this._createMany(type,records,options):this._createParallel(type,records,options):this._createSingle(type,records,options)).thenCall(callback);};Connection.prototype._createSingle=function(type,record,options){var sobjectType=type||record.attributes&&record.attributes.type||record.type;if(!sobjectType){return Promise.reject(new Error('No SObject Type defined in record'));}record=_.clone(record);delete record.Id;delete record.type;delete record.attributes;var url=[this._baseUrl(),"sobjects",sobjectType].join('/');return this.request({method:'POST',url:url,body:JSON.stringify(record),headers:_.defaults(options.headers||{},{"Content-Type":"application/json"})});};Connection.prototype._createParallel=function(type,records,options){if(records.length>this.maxRequest){return Promise.reject(new Error("Exceeded max limit of concurrent call"));}var self=this;return Promise.all(records.map(function(record){return self._createSingle(type,record,options).catch(function(err){if(options.allOrNone||!err.errorCode){throw err;}return this._toRecordResult(null,err);});}));};Connection.prototype._createMany=function(type,records,options){if(records.length===0){return Promise.resolve([]);}if(records.length>MAX_DML_COUNT&&options.allowRecursive){var self=this;return self._createMany(type,records.slice(0,MAX_DML_COUNT),options).then(function(rets1){return self._createMany(type,records.slice(MAX_DML_COUNT),options).then(function(rets2){return rets1.concat(rets2);});});}records=_.map(records,function(record){var sobjectType=type||record.attributes&&record.attributes.type||record.type;if(!sobjectType){return Promise.reject(new Error('No SObject Type defined in record'));}record=_.clone(record);delete record.Id;delete record.type;record.attributes={type:sobjectType};return record;});var url=[this._baseUrl(),"composite","sobjects"].join('/');return this.request({method:'POST',url:url,body:JSON.stringify({allOrNone:options.allOrNone||false,records:records}),headers:_.defaults(options.headers||{},{"Content-Type":"application/json"})});};Connection.prototype.update=function(type,records,options,callback){if(!_.isString(type)){callback=options;options=records;records=type;type=null;}if(typeof options==='function'){callback=options;options={};}options=options||{};return(_.isArray(records)?this._supports('sobject-collection')?this._updateMany(type,records,options):this._updateParallel(type,records,options):this._updateSingle(type,records,options)).thenCall(callback);};Connection.prototype._updateSingle=function(type,record,options){var id=record.Id;if(!id){return Promise.reject(new Error('Record id is not found in record.'));}var sobjectType=type||record.attributes&&record.attributes.type||record.type;if(!sobjectType){return Promise.reject(new Error('No SObject Type defined in record'));}record=_.clone(record);delete record.Id;delete record.type;delete record.attributes;var url=[this._baseUrl(),"sobjects",sobjectType,id].join('/');return this.request({method:'PATCH',url:url,body:JSON.stringify(record),headers:_.defaults(options.headers||{},{"Content-Type":"application/json"})},{noContentResponse:{id:id,success:true,errors:[]}});};Connection.prototype._updateParallel=function(type,records,options){if(records.length>this.maxRequest){return Promise.reject(new Error("Exceeded max limit of concurrent call"));}var self=this;return Promise.all(records.map(function(record){return self._updateSingle(type,record,options).catch(function(err){if(options.allOrNone||!err.errorCode){throw err;}return this._toRecordResult(record.Id,err);});}));};Connection.prototype._updateMany=function(type,records,options){if(records.length===0){return Promise.resolve([]);}if(records.length>MAX_DML_COUNT&&options.allowRecursive){var self=this;return self._updateMany(type,records.slice(0,MAX_DML_COUNT),options).then(function(rets1){return self._updateMany(type,records.slice(MAX_DML_COUNT),options).then(function(rets2){return rets1.concat(rets2);});});}records=_.map(records,function(record){var id=record.Id;if(!id){throw new Error('Record id is not found in record.');}var sobjectType=type||record.attributes&&record.attributes.type||record.type;if(!sobjectType){throw new Error('No SObject Type defined in record');}record=_.clone(record);delete record.Id;record.id=id;delete record.type;record.attributes={type:sobjectType};return record;});var url=[this._baseUrl(),"composite","sobjects"].join('/');return this.request({method:'PATCH',url:url,body:JSON.stringify({allOrNone:options.allOrNone||false,records:records}),headers:_.defaults(options.headers||{},{"Content-Type":"application/json"})});};Connection.prototype.upsert=function(type,records,extIdField,options,callback){if(!_.isString(type)){callback=options;options=extIdField;extIdField=records;records=type;type=null;}if(typeof options==='function'){callback=options;options={};}options=options||{};var self=this;var isArray=_.isArray(records);records=isArray?records:[records];if(records.length>this.maxRequest){return Promise.reject(new Error("Exceeded max limit of concurrent call")).thenCall(callback);}return Promise.all(_.map(records,function(record){var sobjectType=type||record.attributes&&record.attributes.type||record.type;var extId=record[extIdField];record=_.clone(record);delete record[extIdField];delete record.type;delete record.attributes;var url=[self._baseUrl(),"sobjects",sobjectType,extIdField,extId].join('/');return self.request({method:'PATCH',url:url,body:JSON.stringify(record),headers:_.defaults(options.headers||{},{"Content-Type":"application/json"})},{noContentResponse:{success:true,errors:[]}}).catch(function(err){if(!isArray||options.allOrNone||!err.errorCode){throw err;}return self._toRecordResult(null,err);});})).then(function(results){return!isArray&&_.isArray(results)?results[0]:results;}).thenCall(callback);};Connection.prototype["delete"]=Connection.prototype.del=Connection.prototype.destroy=function(type,ids,options,callback){if(typeof options==='function'){callback=options;options={};}options=options||{};return(_.isArray(ids)?this._supports('sobject-collection')?this._destroyMany(type,ids,options):this._destroyParallel(type,ids,options):this._destroySingle(type,ids,options)).thenCall(callback);};Connection.prototype._destroySingle=function(type,id,options){var url=[this._baseUrl(),"sobjects",type,id].join('/');return this.request({method:'DELETE',url:url,headers:options.headers||null},{noContentResponse:{id:id,success:true,errors:[]}});};Connection.prototype._destroyParallel=function(type,ids,options){if(ids.length>this.maxRequest){return Promise.reject(new Error("Exceeded max limit of concurrent call"));}var self=this;return Promise.all(ids.map(function(id){return self._destroySingle(type,id,options).catch(function(err){if(options.allOrNone||!err.errorCode){throw err;}return this._toRecordResult(id,err);});}));};Connection.prototype._destroyMany=function(type,ids,options){if(ids.length===0){return Promise.resolve([]);}if(ids.length>MAX_DML_COUNT&&options.allowRecursive){var self=this;return self._destroyMany(type,ids.slice(0,MAX_DML_COUNT),options).then(function(rets1){return self._destroyMany(type,ids.slice(MAX_DML_COUNT),options).then(function(rets2){return rets1.concat(rets2);});});}var url=[this._baseUrl(),"composite","sobjects?ids="].join('/')+ids.join(',');if(options.allOrNone){url+='&allOrNone=true';}return this.request({method:'DELETE',url:url,headers:options.headers||null});};Connection.prototype.search=function(sosl,callback){var url=this._baseUrl()+"/search?q="+encodeURIComponent(sosl);return this.request(url).thenCall(callback);};Connection.prototype.describe=Connection.prototype.describeSObject=function(type,callback){var url=[this._baseUrl(),"sobjects",type,"describe"].join('/');return this.request(url).thenCall(callback);};Connection.prototype.describeGlobal=function(callback){var url=this._baseUrl()+"/sobjects";return this.request(url).thenCall(callback);};Connection.prototype.sobject=function(type){this.sobjects=this.sobjects||{};var sobject=this.sobjects[type]=this.sobjects[type]||new SObject(this,type);return sobject;};Connection.prototype.identity=function(options,callback){if(typeof options==='function'){callback=options;options={};}options=options||{};var self=this;var idUrl=this.userInfo&&this.userInfo.url;return Promise.resolve(idUrl?{identity:idUrl}:this.request({method:'GET',url:this._baseUrl(),headers:options.headers})).then(function(res){var url=res.identity;return self.request({method:'GET',url:url});}).then(function(res){self.userInfo={id:res.user_id,organizationId:res.organization_id,url:res.id};return res;}).thenCall(callback);};Connection.prototype.authorize=function(code,params,callback){if(typeof params==='function'){callback=params;params={};}var self=this;var logger=this._logger;return this.oauth2.requestToken(code,params).then(function(res){var userInfo=parseIdUrl(res.id);self.initialize({instanceUrl:res.instance_url,accessToken:res.access_token,refreshToken:res.refresh_token,userInfo:userInfo});logger.debug("<login> completed. user id = "+userInfo.id+", org id = "+userInfo.organizationId);return userInfo;}).thenCall(callback);};Connection.prototype.login=function(username,password,callback){this._refreshDelegate=new HttpApi.SessionRefreshDelegate(this,createUsernamePasswordRefreshFn(username,password));if(this.oauth2&&this.oauth2.clientId&&this.oauth2.clientSecret){return this.loginByOAuth2(username,password,callback);}else{return this.loginBySoap(username,password,callback);}};function createUsernamePasswordRefreshFn(username,password){return function(conn,callback){conn.login(username,password,function(err){if(err){return callback(err);}callback(null,conn.accessToken);});};}Connection.prototype.loginByOAuth2=function(username,password,callback){var self=this;var logger=this._logger;return this.oauth2.authenticate(username,password).then(function(res){var userInfo=parseIdUrl(res.id);self.initialize({instanceUrl:res.instance_url,accessToken:res.access_token,userInfo:userInfo});logger.debug("<login> completed. user id = "+userInfo.id+", org id = "+userInfo.organizationId);return userInfo;}).thenCall(callback);};function esc(str){return str&&String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}Connection.prototype.loginBySoap=function(username,password,callback){var self=this;var logger=this._logger;var body=['<se:Envelope xmlns:se="http://schemas.xmlsoap.org/soap/envelope/">','<se:Header/>','<se:Body>','<login xmlns="urn:partner.soap.sforce.com">','<username>'+esc(username)+'</username>','<password>'+esc(password)+'</password>','</login>','</se:Body>','</se:Envelope>'].join('');var soapLoginEndpoint=[this.loginUrl,"services/Soap/u",this.version].join('/');return this._transport.httpRequest({method:'POST',url:soapLoginEndpoint,body:body,headers:{"Content-Type":"text/xml","SOAPAction":'""'}}).then(function(response){var m;if(response.statusCode>=400){m=response.body.match(/<faultstring>([^<]+)<\/faultstring>/);var faultstring=m&&m[1];throw new Error(faultstring||response.body);}logger.debug("SOAP response = "+response.body);m=response.body.match(/<serverUrl>([^<]+)<\/serverUrl>/);var serverUrl=m&&m[1];m=response.body.match(/<sessionId>([^<]+)<\/sessionId>/);var sessionId=m&&m[1];m=response.body.match(/<userId>([^<]+)<\/userId>/);var userId=m&&m[1];m=response.body.match(/<organizationId>([^<]+)<\/organizationId>/);var orgId=m&&m[1];var idUrl=soapLoginEndpoint.split('/').slice(0,3).join('/');idUrl+="/id/"+orgId+"/"+userId;var userInfo={id:userId,organizationId:orgId,url:idUrl};self.initialize({serverUrl:serverUrl.split('/').slice(0,3).join('/'),sessionId:sessionId,userInfo:userInfo});logger.debug("<login> completed. user id = "+userId+", org id = "+orgId);return userInfo;}).thenCall(callback);};Connection.prototype.logout=function(revoke,callback){if(typeof revoke==='function'){callback=revoke;revoke=false;}if(this._sessionType==="oauth2"){return this.logoutByOAuth2(revoke,callback);}else{return this.logoutBySoap(revoke,callback);}};Connection.prototype.logoutByOAuth2=function(revoke,callback){if(typeof revoke==='function'){callback=revoke;revoke=false;}var self=this;var logger=this._logger;return this.oauth2.revokeToken(revoke?this.refreshToken:this.accessToken).then(function(){self.accessToken=null;self.userInfo=null;self.refreshToken=null;self.instanceUrl=null;self.cache.clear();return undefined;}).thenCall(callback);};Connection.prototype.logoutBySoap=function(revoke,callback){if(typeof revoke==='function'){callback=revoke;revoke=false;}var self=this;var logger=this._logger;var body=['<se:Envelope xmlns:se="http://schemas.xmlsoap.org/soap/envelope/">','<se:Header>','<SessionHeader xmlns="urn:partner.soap.sforce.com">','<sessionId>'+esc(revoke?this.refreshToken:this.accessToken)+'</sessionId>','</SessionHeader>','</se:Header>','<se:Body>','<logout xmlns="urn:partner.soap.sforce.com"/>','</se:Body>','</se:Envelope>'].join('');return this._transport.httpRequest({method:'POST',url:[this.instanceUrl,"services/Soap/u",this.version].join('/'),body:body,headers:{"Content-Type":"text/xml","SOAPAction":'""'}}).then(function(response){logger.debug("SOAP statusCode = "+response.statusCode+", response = "+response.body);if(response.statusCode>=400){var m=response.body.match(/<faultstring>([^<]+)<\/faultstring>/);var faultstring=m&&m[1];throw new Error(faultstring||response.body);}self.accessToken=null;self.userInfo=null;self.refreshToken=null;self.instanceUrl=null;self.cache.clear();return undefined;}).thenCall(callback);};Connection.prototype.recent=function(type,limit,callback){if(!_.isString(type)){callback=limit;limit=type;type=undefined;}if(!_.isNumber(limit)){callback=limit;limit=undefined;}var url;if(type){url=[this._baseUrl(),"sobjects",type].join('/');return this.request(url).then(function(res){return limit?res.recentItems.slice(0,limit):res.recentItems;}).thenCall(callback);}else{url=this._baseUrl()+"/recent";if(limit){url+="?limit="+limit;}return this.request(url).thenCall(callback);}};Connection.prototype.updated=function(type,start,end,callback){var url=[this._baseUrl(),"sobjects",type,"updated"].join('/');if(typeof start==='string'){start=new Date(start);}if(start instanceof Date){start=formatDate(start);}if(start){url+="?start="+encodeURIComponent(start);}if(typeof end==='string'){end=new Date(end);}if(end instanceof Date){end=formatDate(end);}if(end){url+="&end="+encodeURIComponent(end);}return this.request(url).thenCall(callback);};Connection.prototype.deleted=function(type,start,end,callback){var url=[this._baseUrl(),"sobjects",type,"deleted"].join('/');if(typeof start==='string'){start=new Date(start);}if(start instanceof Date){start=formatDate(start);}if(start){url+="?start="+encodeURIComponent(start);}if(typeof end==='string'){end=new Date(end);}if(end instanceof Date){end=formatDate(end);}if(end){url+="&end="+encodeURIComponent(end);}return this.request(url).thenCall(callback);};Connection.prototype.tabs=function(callback){var url=[this._baseUrl(),"tabs"].join('/');return this.request(url).thenCall(callback);};Connection.prototype.limits=function(callback){var url=[this._baseUrl(),"limits"].join('/');return this.request(url).thenCall(callback);};Connection.prototype.theme=function(callback){var url=[this._baseUrl(),"theme"].join('/');return this.request(url).thenCall(callback);};Connection.prototype.quickActions=function(callback){return this.request("/quickActions").thenCall(callback);};Connection.prototype.quickAction=function(actionName){return new QuickAction(this,"/quickActions/"+actionName);};}).call(this,require("buffer").Buffer);},{"./cache":115,"./core":117,"./http-api":120,"./logger":121,"./oauth2":122,"./process":123,"./promise":124,"./query":125,"./quick-action":126,"./sobject":131,"./transport":133,"buffer":49,"events":57,"inherits":94,"lodash/core":146}],117:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;var jsforce=module.exports=new EventEmitter();jsforce.VERSION=require('./VERSION');jsforce.Connection=require('./connection');jsforce.OAuth2=require('./oauth2');jsforce.Date=jsforce.SfDate=require("./date");jsforce.RecordStream=require('./record-stream');jsforce.Promise=require('./promise');jsforce.require=require('./require');},{"./VERSION":98,"./connection":116,"./date":119,"./oauth2":122,"./promise":124,"./record-stream":127,"./require":129,"events":57}],118:[function(require,module,exports){'use strict';var _=require('lodash/core'),csvParse=require('csv-parse'),csvParseSync=require('csv-parse/lib/sync'),csvStringify=require('csv-stringify'),csvStringifySync=require('csv-stringify/lib/sync');function parseCSV(str,options){options=_.extend({},options,{columns:true});return csvParseSync(str,options);}function toCSV(records,options){options=_.extend({},options,{header:true});return csvStringifySync(records,options);}function parseCSVStream(options){options=_.extend({},options,{columns:true});return csvParse(options);}function serializeCSVStream(options){options=_.extend({},options,{header:true});return csvStringify(options);}module.exports={parseCSV:parseCSV,toCSV:toCSV,parseCSVStream:parseCSVStream,serializeCSVStream:serializeCSVStream};},{"csv-parse":52,"csv-parse/lib/sync":53,"csv-stringify":54,"csv-stringify/lib/sync":55,"lodash/core":146}],119:[function(require,module,exports){'use strict';var _=require('lodash/core');var SfDate=module.exports=function(literal){this._literal=literal;};SfDate.prototype.toString=SfDate.prototype.toJSON=function(){return this._literal;};function zeropad(n){return(n<10?"0":"")+n;}SfDate.toDateLiteral=function(date){if(_.isNumber(date)){date=new Date(date);}else if(_.isString(date)){date=SfDate.parseDate(date);}var yy=date.getFullYear();var mm=date.getMonth()+1;var dd=date.getDate();var dstr=[yy,zeropad(mm),zeropad(dd)].join("-");return new SfDate(dstr);};SfDate.toDateTimeLiteral=function(date){if(_.isNumber(date)){date=new Date(date);}else if(_.isString(date)){date=SfDate.parseDate(date);}var yy=date.getUTCFullYear();var mm=date.getUTCMonth()+1;var dd=date.getUTCDate();var hh=date.getUTCHours();var mi=date.getUTCMinutes();var ss=date.getUTCSeconds();var dtstr=[yy,zeropad(mm),zeropad(dd)].join("-")+"T"+[zeropad(hh),zeropad(mi),zeropad(ss)].join(":")+"Z";return new SfDate(dtstr);};SfDate.parseDate=function(str){var d=new Date();var regexp=/^([\d]{4})-?([\d]{2})-?([\d]{2})(T([\d]{2}):?([\d]{2}):?([\d]{2})(.([\d]{3}))?(Z|([\+\-])([\d]{2}):?([\d]{2})))?$/;var m=str.match(regexp);if(m){d=new Date(0);if(!m[4]){d.setFullYear(parseInt(m[1],10));d.setDate(parseInt(m[3],10));d.setMonth(parseInt(m[2],10)-1);d.setHours(0);d.setMinutes(0);d.setSeconds(0);d.setMilliseconds(0);}else{d.setUTCFullYear(parseInt(m[1],10));d.setUTCDate(parseInt(m[3],10));d.setUTCMonth(parseInt(m[2],10)-1);d.setUTCHours(parseInt(m[5],10));d.setUTCMinutes(parseInt(m[6],10));d.setUTCSeconds(parseInt(m[7],10));d.setUTCMilliseconds(parseInt(m[9]||'0',10));if(m[10]&&m[10]!=='Z'){var offset=parseInt(m[12],10)*60+parseInt(m[13],10);d.setTime((m[11]==='+'?-1:1)*offset*60*1000+d.getTime());}}return d;}else{throw new Error("Invalid date format is specified : "+str);}};var SfDateLiterals={YESTERDAY:1,TODAY:1,TOMORROW:1,LAST_WEEK:1,THIS_WEEK:1,NEXT_WEEK:1,LAST_MONTH:1,THIS_MONTH:1,NEXT_MONTH:1,LAST_90_DAYS:1,NEXT_90_DAYS:1,LAST_N_DAYS:2,NEXT_N_DAYS:2,NEXT_N_WEEKS:2,LAST_N_WEEKS:2,NEXT_N_MONTHS:2,LAST_N_MONTHS:2,THIS_QUARTER:1,LAST_QUARTER:1,NEXT_QUARTER:1,NEXT_N_QUARTERS:2,LAST_N_QUARTERS:2,THIS_YEAR:1,LAST_YEAR:1,NEXT_YEAR:1,NEXT_N_YEARS:2,LAST_N_YEARS:2,THIS_FISCAL_QUARTER:1,LAST_FISCAL_QUARTER:1,NEXT_FISCAL_QUARTER:1,NEXT_N_FISCAL_QUARTERS:2,LAST_N_FISCAL_QUARTERS:2,THIS_FISCAL_YEAR:1,LAST_FISCAL_YEAR:1,NEXT_FISCAL_YEAR:1,NEXT_N_FISCAL_YEARS:2,LAST_N_FISCAL_YEARS:2};for(var literal in SfDateLiterals){var type=SfDateLiterals[literal];SfDate[literal]=type===1?new SfDate(literal):createLiteralBuilder(literal);}function createLiteralBuilder(literal){return function(num){return new SfDate(literal+":"+num);};}},{"lodash/core":146}],120:[function(require,module,exports){'use strict';var inherits=require('inherits'),events=require('events'),_=require('lodash/core'),Promise=require('./promise');var HttpApi=function HttpApi(conn,options){options=options||{};this._conn=conn;this.on('resume',function(err){conn.emit('resume',err);});this._responseType=options.responseType;this._transport=options.transport||conn._transport;this._noContentResponse=options.noContentResponse;};inherits(HttpApi,events.EventEmitter);HttpApi.prototype.request=function(request,callback){var self=this;var conn=this._conn;var logger=conn._logger;var refreshDelegate=this.getRefreshDelegate();var lastInstanceUrl=conn.instanceUrl;var deferred=Promise.defer();var onResume=function onResume(err){if(err){deferred.reject(err);return;}if(lastInstanceUrl!==conn.instanceUrl){request.url=request.url.replace(lastInstanceUrl,conn.instanceUrl);}self.request(request).then(function(response){deferred.resolve(response);},function(err){deferred.reject(err);});};if(refreshDelegate&&refreshDelegate._refreshing){refreshDelegate.once('resume',onResume);return deferred.promise.thenCall(callback);}self.beforeSend(request);self.emit('request',request);logger.debug("<request> method="+request.method+", url="+request.url);var requestTime=Date.now();return this._transport.httpRequest(request).then(function(response){var responseTime=Date.now();logger.debug("elappsed time : "+(responseTime-requestTime)+"msec");logger.debug("<response> status="+response.statusCode+", url="+request.url);self.emit('response',response);if(self.isSessionExpired(response)&&refreshDelegate){refreshDelegate.refresh(requestTime,onResume);return deferred.promise;}if(self.isErrorResponse(response)){var err=self.getError(response);throw err;}return self.getResponseBody(response);},function(err){var responseTime=Date.now();logger.debug("elappsed time : "+(responseTime-requestTime)+"msec");logger.error(err);throw err;}).thenCall(callback);};HttpApi.prototype.getRefreshDelegate=function(){return this._conn._refreshDelegate;};HttpApi.prototype.beforeSend=function(request){request.headers=request.headers||{};if(this._conn.accessToken){request.headers.Authorization="Bearer "+this._conn.accessToken;}if(this._conn.callOptions){var callOptions=[];for(var name in this._conn.callOptions){callOptions.push(name+"="+this._conn.callOptions[name]);}request.headers["Sforce-Call-Options"]=callOptions.join(', ');}};HttpApi.prototype.getResponseContentType=function(response){return this._responseType||response.headers&&response.headers["content-type"];};HttpApi.prototype.parseResponseBody=function(response){var contentType=this.getResponseContentType(response);var parseBody=/^(text|application)\/xml(;|$)/.test(contentType)?parseXML:/^application\/json(;|$)/.test(contentType)?parseJSON:/^text\/csv(;|$)/.test(contentType)?parseCSV:parseText;try{return parseBody(response.body);}catch(e){return response.body;}};HttpApi.prototype.getResponseBody=function(response){if(response.statusCode===204){return this._noContentResponse;}var body=this.parseResponseBody(response);var err;if(this.hasErrorInResponseBody(body)){err=this.getError(response,body);throw err;}if(response.statusCode===300){err=new Error('Multiple records found');err.name="MULTIPLE_CHOICES";err.content=body;throw err;}return body;};function parseJSON(str){return JSON.parse(str);}function parseXML(str){var ret={};require('xml2js').parseString(str,{explicitArray:false},function(err,result){ret={error:err,result:result};});if(ret.error){throw ret.error;}return ret.result;}function parseCSV(str){return require('./csv').parseCSV(str);}function parseText(str){return str;}HttpApi.prototype.isSessionExpired=function(response){return response.statusCode===401;};HttpApi.prototype.isErrorResponse=function(response){return response.statusCode>=400;};HttpApi.prototype.hasErrorInResponseBody=function(body){return false;};HttpApi.prototype.parseError=function(body){var errors=body;return _.isArray(errors)?errors[0]:errors;};HttpApi.prototype.getError=function(response,body){var error;try{error=this.parseError(body||this.parseResponseBody(response));}catch(e){}error=_.isObject(error)&&_.isString(error.message)?error:{errorCode:'ERROR_HTTP_'+response.statusCode,message:response.body};var err=new Error(error.message);err.name=error.errorCode;for(var key in error){err[key]=error[key];}return err;};var SessionRefreshDelegate=function SessionRefreshDelegate(conn,refreshFn){this._conn=conn;this._refreshFn=refreshFn;this._refreshing=false;};inherits(SessionRefreshDelegate,events.EventEmitter);SessionRefreshDelegate.prototype.refresh=function(since,callback){if(this._lastRefreshedAt>since){return callback();}var self=this;var conn=this._conn;var logger=conn._logger;self.once('resume',callback);if(self._refreshing){return;}logger.debug("<refresh token>");self._refreshing=true;return self._refreshFn(conn,function(err,accessToken,res){if(!err){logger.debug("Connection refresh completed.");conn.accessToken=accessToken;conn.emit("refresh",accessToken,res);}self._lastRefreshedAt=Date.now();self._refreshing=false;self.emit('resume',err);});};HttpApi.SessionRefreshDelegate=SessionRefreshDelegate;module.exports=HttpApi;},{"./csv":118,"./promise":124,"events":57,"inherits":94,"lodash/core":146,"xml2js":214}],121:[function(require,module,exports){'use strict';var Logger=module.exports=function(logLevel){if(typeof logLevel==='string'){logLevel=LogLevels[logLevel];}if(!logLevel){logLevel=LogLevels.INFO;}this._logLevel=logLevel;};var LogLevels=Logger.LogLevels={"DEBUG":1,"INFO":2,"WARN":3,"ERROR":4,"FATAL":5};Logger.prototype.log=function(level,message){if(this._logLevel<=level){if(level<LogLevels.ERROR){console.log(message);}else{console.error(message);}}};for(var level in LogLevels){Logger.prototype[level.toLowerCase()]=createLoggerFunction(LogLevels[level]);}function createLoggerFunction(level){return function(message){this.log(level,message);};}},{}],122:[function(require,module,exports){'use strict';var querystring=require('querystring'),_=require('lodash/core'),Transport=require('./transport');var defaults={loginUrl:"https://login.salesforce.com"};var OAuth2=module.exports=function(options){if(options.authzServiceUrl&&options.tokenServiceUrl){this.loginUrl=options.authzServiceUrl.split('/').slice(0,3).join('/');this.authzServiceUrl=options.authzServiceUrl;this.tokenServiceUrl=options.tokenServiceUrl;this.revokeServiceUrl=options.revokeServiceUrl;}else{this.loginUrl=options.loginUrl||defaults.loginUrl;this.authzServiceUrl=this.loginUrl+"/services/oauth2/authorize";this.tokenServiceUrl=this.loginUrl+"/services/oauth2/token";this.revokeServiceUrl=this.loginUrl+"/services/oauth2/revoke";}this.clientId=options.clientId;this.clientSecret=options.clientSecret;this.redirectUri=options.redirectUri;if(options.proxyUrl){this._transport=new Transport.ProxyTransport(options.proxyUrl);}else if(options.httpProxy){this._transport=new Transport.HttpProxyTransport(options.httpProxy);}else{this._transport=new Transport();}};_.extend(OAuth2.prototype,{getAuthorizationUrl:function getAuthorizationUrl(params){params=_.extend({response_type:"code",client_id:this.clientId,redirect_uri:this.redirectUri},params||{});return this.authzServiceUrl+(this.authzServiceUrl.indexOf('?')>=0?"&":"?")+querystring.stringify(params);},refreshToken:function refreshToken(_refreshToken,callback){var params={grant_type:"refresh_token",refresh_token:_refreshToken,client_id:this.clientId};if(this.clientSecret){params.client_secret=this.clientSecret;}return this._postParams(params,callback);},requestToken:function requestToken(code,params,callback){if(typeof params==='function'){callback=params;params={};}params=_.extend({grant_type:"authorization_code",code:code,client_id:this.clientId,redirect_uri:this.redirectUri},params||{});if(this.clientSecret){params.client_secret=this.clientSecret;}return this._postParams(params,callback);},authenticate:function authenticate(username,password,callback){return this._postParams({grant_type:"password",username:username,password:password,client_id:this.clientId,client_secret:this.clientSecret,redirect_uri:this.redirectUri},callback);},revokeToken:function revokeToken(token,callback){return this._transport.httpRequest({method:'POST',url:this.revokeServiceUrl,body:querystring.stringify({token:token}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(response){if(response.statusCode>=400){var res=querystring.parse(response.body);if(!res||!res.error){res={error:"ERROR_HTTP_"+response.statusCode,error_description:response.body};}var err=new Error(res.error_description);err.name=res.error;throw err;}}).thenCall(callback);},_postParams:function _postParams(params,callback){return this._transport.httpRequest({method:'POST',url:this.tokenServiceUrl,body:querystring.stringify(params),headers:{"content-type":"application/x-www-form-urlencoded"}}).then(function(response){var res;try{res=JSON.parse(response.body);}catch(e){}if(response.statusCode>=400){res=res||{error:"ERROR_HTTP_"+response.statusCode,error_description:response.body};var err=new Error(res.error_description);err.name=res.error;throw err;}return res;}).thenCall(callback);}});},{"./transport":133,"lodash/core":146,"querystring":175}],123:[function(require,module,exports){'use strict';var _=require('lodash/core'),Promise=require('./promise'),Conneciton=require('./connection');var Process=module.exports=function(conn){this.rule=new ProcessRule(conn);this.approval=new ApprovalProcess(conn);};var ProcessRule=function ProcessRule(conn){this._conn=conn;};ProcessRule.prototype.list=function(callback){return this._conn.request("/process/rules").then(function(res){return res.rules;}).thenCall(callback);};ProcessRule.prototype.trigger=function(contextIds,callback){contextIds=_.isArray(contextIds)?contextIds:[contextIds];return this._conn.request({method:"POST",url:"/process/rules/",body:JSON.stringify({contextIds:contextIds}),headers:{"content-type":"application/json"}}).thenCall(callback);};var ApprovalProcess=function ApprovalProcess(conn){this._conn=conn;};ApprovalProcess.prototype.list=function(callback){return this._conn.request("/process/approvals").then(function(res){return res.approvals;}).thenCall(callback);};ApprovalProcess.prototype.request=function(requests,callback){requests=requests.map(function(req){return req._request?req._request:req;});return this._conn.request({method:'POST',url:'/process/approvals',headers:{"content-type":"application/json"},body:JSON.stringify({requests:requests})}).thenCall(callback);};ApprovalProcess.prototype._createRequest=function(actionType,contextId,comments,options,callback){if(typeof comments==="function"){callback=comments;options=null;comments=null;}if(typeof options==="function"){callback=options;options=null;}options=options||{};var request={actionType:actionType,contextId:contextId,comments:comments};_.extend(request,options);return new ApprovalProcessRequest(this,request).thenCall(callback);};ApprovalProcess.prototype.submit=function(contextId,comments,options,callback){return this._createRequest("Submit",contextId,comments,options,callback);};ApprovalProcess.prototype.approve=function(workitemId,comments,options,callback){return this._createRequest("Approve",workitemId,comments,options,callback);};ApprovalProcess.prototype.reject=function(workitemId,comments,options,callback){return this._createRequest("Reject",workitemId,comments,options,callback);};var ApprovalProcessRequest=function ApprovalProcessRequest(process,request){this._process=process;this._request=request;};ApprovalProcessRequest.prototype.then=function(onResolve,onReject){if(!this._promise){this._promise=this._process.request([this]).then(function(rets){return rets[0];});}this._promise.then(onResolve,onReject);};ApprovalProcessRequest.prototype.thenCall=function(callback){return callback?this.then(function(res){callback(null,res);},function(err){callback(err);}):this;};},{"./connection":116,"./promise":124,"lodash/core":146}],124:[function(require,module,exports){(function(process){'use strict';var _=require('lodash/core');var Promise=require('promise/lib/es6-extensions');Promise.prototype.thenCall=function(callback){if(_.isFunction(callback)){this.then(function(res){process.nextTick(function(){callback(null,res);});},function(err){process.nextTick(function(){callback(err);});});}return this;};Promise.prototype.fail=Promise.prototype['catch'];Promise.defer=function(){return new Deferred();};var Deferred=function Deferred(){var self=this;this.promise=new Promise(function(resolve,reject){self.resolve=resolve;self.reject=reject;});};module.exports=Promise;}).call(this,require('_process'));},{"_process":170,"lodash/core":146,"promise/lib/es6-extensions":172}],125:[function(require,module,exports){(function(process){'use strict';var inherits=require('inherits'),events=require('events'),stream=require('readable-stream'),_=require('lodash/core'),Promise=require('./promise'),SfDate=require("./date"),SOQLBuilder=require("./soql-builder"),RecordStream=require("./record-stream");var Query=module.exports=function(conn,config,options){Query.super_.call(this,{objectMode:true});this._conn=conn;if(_.isString(config)){this._soql=config;}else if(config.locator&&config.locator.indexOf("/")>=0){this._locator=config.locator.split("/").pop();}else{this._config=config;this.select(config.fields);if(config.includes){this.include(config.includes);}if(config.sort){this.sort(config.sort);}}this._options=_.defaults(options||{},{maxFetch:10000,autoFetch:false,scanAll:false,responseTarget:ResponseTargets.QueryResult});this._executed=false;this._finished=false;this._chaining=false;this._deferred=Promise.defer();var self=this;};inherits(Query,stream.Readable);Query.prototype.select=function(fields){if(this._soql){throw Error("Cannot set select fields for the query which has already built SOQL.");}fields=fields||'*';if(_.isString(fields)){fields=fields.split(/\s*,\s*/);}else if(_.isObject(fields)&&!_.isArray(fields)){var _fields=[];for(var k in fields){if(fields[k]){_fields.push(k);}}fields=_fields;}this._config.fields=fields;return this;};Query.prototype.where=function(conditions){if(this._soql){throw Error("Cannot set where conditions for the query which has already built SOQL.");}this._config.conditions=conditions;return this;};Query.prototype.limit=function(limit){if(this._soql){throw Error("Cannot set limit for the query which has already built SOQL.");}this._config.limit=limit;return this;};Query.prototype.skip=Query.prototype.offset=function(offset){if(this._soql){throw Error("Cannot set skip/offset for the query which has already built SOQL.");}this._config.offset=offset;return this;};Query.prototype.sort=Query.prototype.orderby=function(sort,dir){if(this._soql){throw Error("Cannot set sort for the query which has already built SOQL.");}if(_.isString(sort)&&_.isString(dir)){sort=[[sort,dir]];}this._config.sort=sort;return this;};Query.prototype.include=function(childRelName,conditions,fields,options){if(this._soql){throw Error("Cannot include child relationship into the query which has already built SOQL.");}if(_.isObject(childRelName)){var includes=childRelName;for(var crname in includes){var config=includes[crname];this.include(crname,config.conditions,config.fields,config);}return;}var childConfig={table:childRelName,conditions:conditions,fields:fields,limit:options&&options.limit,offset:options&&(options.offset||options.skip),sort:options&&options.sort};if(!_.isArray(this._config.includes))this._config.includes=[];this._config.includes.push(childConfig);var childQuery=new SubQuery(this._conn,this,childConfig);this._children=this._children||[];this._children.push(childQuery);return childQuery;};Query.prototype.maxFetch=function(maxFetch){this._options.maxFetch=maxFetch;return this;};Query.prototype.autoFetch=function(autoFetch){this._options.autoFetch=autoFetch;return this;};Query.prototype.scanAll=function(scanAll){this._options.scanAll=scanAll;return this;};var ResponseTargets=Query.ResponseTargets={};["QueryResult","Records","SingleRecord","Count"].forEach(function(f){ResponseTargets[f]=f;});Query.prototype.setResponseTarget=function(responseTarget){if(responseTarget in ResponseTargets){this._options.responseTarget=responseTarget;}return this;};Query.prototype.run=Query.prototype.exec=Query.prototype.execute=function(options,callback){var self=this;var logger=this._conn._logger;var deferred=this._deferred;if(this._executed){deferred.reject(new Error("re-executing already executed query"));return this;}if(this._finished){deferred.reject(new Error("executing already closed query"));return this;}if(typeof options==="function"){callback=options;options={};}options=options||{};options={headers:options.headers||self._options.headers,responseTarget:options.responseTarget||self._options.responseTarget,autoFetch:options.autoFetch||self._options.autoFetch,maxFetch:options.maxFetch||self._options.maxFetch,scanAll:options.scanAll||self._options.scanAll};var promiseCallback=function promiseCallback(err,res){if(_.isFunction(callback)){try{res=callback(err,res);err=null;}catch(e){err=e;}}if(err){deferred.reject(err);}else{deferred.resolve(res);}};this.once('response',function(res){promiseCallback(null,res);});this.once('error',function(err){promiseCallback(err);});this.once('fetch',function(){if(options.responseTarget===ResponseTargets.Records&&(self._chaining||callback)){logger.debug('--- collecting all fetched records ---');var records=[];var onRecord=function onRecord(record){records.push(record);};self.on('record',onRecord);self.once('end',function(){self.removeListener('record',onRecord);self.emit('response',records,self);});}});this._executed=true;logger.debug('>>> Query start >>>');this._execute(options).then(function(){logger.debug('*** Query finished ***');}).fail(function(err){logger.debug('--- Query error ---');self.emit('error',err);});return this;};Query.prototype._execute=function(options){var self=this;var logger=this._conn._logger;var responseTarget=options.responseTarget;var autoFetch=options.autoFetch;var maxFetch=options.maxFetch;var scanAll=options.scanAll;return Promise.resolve(self._locator?self._conn._baseUrl()+"/query/"+self._locator:self.toSOQL().then(function(soql){self.totalFetched=0;logger.debug("SOQL = "+soql);return self._conn._baseUrl()+"/"+(scanAll?"queryAll":"query")+"?q="+encodeURIComponent(soql);})).then(function(url){return self._conn.request({method:'GET',url:url,headers:options.headers});}).then(function(data){self.emit("fetch");self.totalSize=data.totalSize;var res;switch(responseTarget){case ResponseTargets.SingleRecord:res=data.records&&data.records.length>0?data.records[0]:null;break;case ResponseTargets.Records:res=data.records;break;case ResponseTargets.Count:res=data.totalSize;break;default:res=data;}if(responseTarget!==ResponseTargets.Records){self.emit("response",res,self);}var numRecords=data.records&&data.records.length||0;for(var i=0;i<numRecords;i++){if(self.totalFetched>=maxFetch){self._finished=true;break;}var record=data.records[i];self.push(record);self.emit('record',record,self.totalFetched++,self);}if(data.nextRecordsUrl){self._locator=data.nextRecordsUrl.split('/').pop();}self._finished=self._finished||data.done||!autoFetch;if(self._finished){self.push(null);}else{self._execute(options);}return res;});};Query.prototype._read=function(size){if(!this._finished&&!this._executed){this.execute({autoFetch:true});}};Query.prototype.on=function(e,fn){if(e==='record'){var self=this;this.on('readable',function(){while(self.read()!==null){}});}return Query.super_.prototype.on.call(this,e,fn);};Query.prototype.addListener=Query.prototype.on;Query.prototype._expandFields=function(){if(this._soql){return Promise.reject(new Error("Cannot expand fields for the query which has already built SOQL."));}var self=this;var logger=self._conn._logger;var conn=this._conn;var table=this._config.table;var fields=this._config.fields||[];logger.debug('_expandFields: table = '+table+', fields = '+fields.join(', '));return Promise.all([Promise.resolve(self._parent?findRelationTable(table):table).then(function(table){return Promise.all(_.map(fields,function(field){return expandAsteriskField(table,field);})).then(function(expandedFields){self._config.fields=_.flatten(expandedFields);});}),Promise.all(_.map(self._children||[],function(childQuery){return childQuery._expandFields();}))]);function findRelationTable(rname){var ptable=self._parent._config.table;logger.debug('finding table for relation "'+rname+'" in "'+ptable+'"...');return describeCache(ptable).then(function(sobject){var upperRname=rname.toUpperCase();var childRelation=_.find(sobject.childRelationships,function(cr){return(cr.relationshipName||'').toUpperCase()===upperRname;});return childRelation?childRelation.childSObject:Promise.reject(new Error("No child relationship found: "+rname));});}function describeCache(table){logger.debug('describe cache: '+table);var deferred=Promise.defer();conn.describe$(table,function(err,sobject){logger.debug('... done.');if(err){deferred.reject(err);}else{deferred.resolve(sobject);}});return deferred.promise;}function expandAsteriskField(table,field){logger.debug('expanding field "'+field+'" in "'+table+'"...');var fpath=field.split('.');return fpath[fpath.length-1]==='*'?describeCache(table).then(function(sobject){logger.debug('table '+table+'has been described');if(fpath.length>1){var rname=fpath.shift();var rfield=_.find(sobject.fields,function(f){return f.relationshipName&&f.relationshipName.toUpperCase()===rname.toUpperCase();});if(rfield){var rtable=rfield.referenceTo.length===1?rfield.referenceTo[0]:'Name';return expandAsteriskField(rtable,fpath.join('.')).then(function(fpaths){return _.map(fpaths,function(fpath){return rname+'.'+fpath;});});}else{return[];}}else{return _.map(sobject.fields,function(f){return f.name;});}}):Promise.resolve([field]);}};Query.prototype.explain=function(callback){var self=this;var logger=this._conn._logger;return self.toSOQL().then(function(soql){logger.debug("SOQL = "+soql);var url="/query/?explain="+encodeURIComponent(soql);return self._conn.request(url);}).thenCall(callback);};Query.prototype.toSOQL=function(callback){var self=this;return Promise.resolve(self._soql||self._expandFields().then(function(){return SOQLBuilder.createSOQL(self._config);})).thenCall(callback);};Query.prototype.stream=RecordStream.Serializable.prototype.stream;Query.prototype.map=RecordStream.prototype.map;Query.prototype.filter=RecordStream.prototype.map;var DEFAULT_BULK_THRESHOLD=200;Query.prototype["delete"]=Query.prototype.del=Query.prototype.destroy=function(type,options,callback){if(typeof type==='function'){callback=type;options={};type=null;}else if((typeof type==="undefined"?"undefined":_typeof(type))==='object'&&type!==null){callback=options;options=type;type=null;}options=options||{};type=type||this._config&&this._config.table;if(!type){throw new Error("SOQL based query needs SObject type information to bulk delete.");}var thresholdNum=options.allowBulk===false?-1:typeof options.bulkThreshold==='number'?options.bulkThreshold:this._conn._ensureVersion(42)?DEFAULT_BULK_THRESHOLD:this._conn.maxRequest/2;var self=this;return new Promise(function(resolve,reject){var records=[];var batch=null;var handleRecord=function handleRecord(rec){if(!rec.Id){self.emit('error',new Error('Queried record does not include Salesforce record ID.'));return;}var record={Id:rec.Id};if(batch){batch.write(record);}else{records.push(record);if(thresholdNum<0||records.length>thresholdNum){batch=self._conn.sobject(type).deleteBulk().on('response',resolve).on('error',reject);records.forEach(function(record){batch.write(record);});records=[];}}};var handleEnd=function handleEnd(){if(batch){batch.end();}else{var ids=records.map(function(record){return record.Id;});self._conn.sobject(type).destroy(ids,{allowRecursive:true}).then(resolve,reject);}};self.on('data',handleRecord).on('end',handleEnd).on('error',reject);}).thenCall(callback);};Query.prototype.update=function(mapping,type,options,callback){if(typeof type==='function'){callback=type;options={};type=null;}else if((typeof type==="undefined"?"undefined":_typeof(type))==='object'&&type!==null){callback=options;options=type;type=null;}options=options||{};type=type||this._config&&this._config.table;if(!type){throw new Error("SOQL based query needs SObject type information to bulk update.");}var updateStream=_.isFunction(mapping)?RecordStream.map(mapping):RecordStream.recordMapStream(mapping);var thresholdNum=options.allowBulk===false?-1:typeof options.bulkThreshold==='number'?options.bulkThreshold:this._conn._ensureVersion(42)?DEFAULT_BULK_THRESHOLD:this._conn.maxRequest/2;var self=this;return new Promise(function(resolve,reject){var records=[];var batch=null;var handleRecord=function handleRecord(record){if(batch){batch.write(record);}else{records.push(record);if(thresholdNum<0||records.length>thresholdNum){batch=self._conn.sobject(type).updateBulk().on('response',resolve).on('error',reject);records.forEach(function(record){batch.write(record);});records=[];}}};var handleEnd=function handleEnd(){if(batch){batch.end();}else{self._conn.sobject(type).update(records,{allowRecursive:true}).then(resolve,reject);}};self.on('error',reject).pipe(updateStream).on('data',handleRecord).on('end',handleEnd).on('error',reject);}).thenCall(callback);};Query.prototype.then=function(onResolved,onReject){this._chaining=true;if(!this._finished&&!this._executed){this.execute();}return this._deferred.promise.then.apply(this._deferred.promise,arguments);};Query.prototype.thenCall=function(callback){if(_.isFunction(callback)){this.then(function(res){process.nextTick(function(){callback(null,res);});},function(err){process.nextTick(function(){callback(err);});});}return this;};var SubQuery=function SubQuery(conn,parent,config){SubQuery.super_.call(this,conn,config);this._parent=parent;};inherits(SubQuery,Query);SubQuery.prototype.include=function(){throw new Error("Not allowed to include another subquery in subquery.");};SubQuery.prototype.end=function(){return this._parent;};SubQuery.prototype.run=SubQuery.prototype.exec=SubQuery.prototype.execute=function(){return this._parent.execute.apply(this._parent,arguments);};}).call(this,require('_process'));},{"./date":119,"./promise":124,"./record-stream":127,"./soql-builder":132,"_process":170,"events":57,"inherits":94,"lodash/core":146,"readable-stream":143}],126:[function(require,module,exports){'use strict';var QuickAction=module.exports=function(conn,path){this._conn=conn;this._path=path;};QuickAction.prototype.describe=function(callback){var url=this._path+"/describe";return this._conn.request(url).thenCall(callback);};QuickAction.prototype.defaultValues=function(contextId,callback){if(typeof contextId==='function'){callback=contextId;contextId=null;}var url=this._path+"/defaultValues";if(contextId){url+="/"+contextId;}return this._conn.request(url).thenCall(callback);};QuickAction.prototype.execute=function(contextId,record,callback){var body={contextId:contextId,record:record};return this._conn.requestPost(this._path,body).thenCall(callback);};},{}],127:[function(require,module,exports){'use strict';var events=require('events'),stream=require('readable-stream'),Duplex=stream.Duplex,Transform=stream.Transform,PassThrough=stream.PassThrough,inherits=require('inherits'),_=require('lodash/core'),CSV=require('./csv');var RecordStream=module.exports=function(){RecordStream.super_.call(this,{objectMode:true});};inherits(RecordStream,Transform);RecordStream.prototype._transform=function(record,enc,callback){this.emit('record',record);this.push(record);callback();};RecordStream.prototype.map=function(fn){return this.pipe(RecordStream.map(fn));};RecordStream.prototype.filter=function(fn){return this.pipe(RecordStream.filter(fn));};var Serializable=RecordStream.Serializable=function(){Serializable.super_.call(this);this._dataStream=null;};inherits(Serializable,RecordStream);Serializable.prototype.stream=function(type,options){type=type||'csv';var converter=DataStreamConverters[type];if(!converter){throw new Error('Converting ['+type+'] data stream is not supported.');}if(!this._dataStream){this._dataStream=new PassThrough();this.pipe(converter.serialize(options)).pipe(this._dataStream);}return this._dataStream;};var Parsable=RecordStream.Parsable=function(){Parsable.super_.call(this);this._dataStream=null;};inherits(Parsable,RecordStream);Parsable.prototype.stream=function(type,options){type=type||'csv';var converter=DataStreamConverters[type];var self=this;if(!converter){throw new Error('Converting ['+type+'] data stream is not supported.');}if(!this._dataStream){this._dataStream=new PassThrough();this._parserStream=converter.parse(options).on('error',function(error){self.emit('error',error);});this._parserStream.pipe(this).pipe(new PassThrough({objectMode:true,highWaterMark:500*1000}));}return this._dataStream;};Parsable.prototype.on=function(ev,fn){if(ev==='readable'||ev==='record'){this._dataStream.pipe(this._parserStream);}return Parsable.super_.prototype.on.call(this,ev,fn);};Parsable.prototype.addListener=Parsable.prototype.on;RecordStream.map=function(fn){var mapStream=new RecordStream.Serializable();mapStream._transform=function(record,enc,callback){var rec=fn(record)||record;this.push(rec);callback();};return mapStream;};RecordStream.recordMapStream=function(record,noeval){return RecordStream.map(function(rec){var mapped={Id:rec.Id};for(var prop in record){mapped[prop]=noeval?record[prop]:evalMapping(record[prop],rec);}return mapped;});function evalMapping(value,mapping){if(_.isString(value)){var m=/^\$\{(\w+)\}$/.exec(value);if(m){return mapping[m[1]];}return value.replace(/\$\{(\w+)\}/g,function($0,prop){var v=mapping[prop];return _.isNull(v)||_.isUndefined(v)?"":String(v);});}else{return value;}}};RecordStream.filter=function(fn){var filterStream=new RecordStream.Serializable();filterStream._transform=function(record,enc,callback){if(fn(record)){this.push(record);}callback();};return filterStream;};function convertRecordForSerialization(record,options){return Object.keys(record).reduce(function(rec,key){var value=rec[key];var t=typeof value==="undefined"?"undefined":_typeof(value);var urec={};if(key==='attributes'){rec=_.extend({},rec);delete rec[key];}else if(options.nullValue&&value===null){urec[key]=options.nullValue;rec=_.extend({},rec,urec);}else if(value!==null&&(typeof value==="undefined"?"undefined":_typeof(value))==='object'){var precord=convertRecordForSerialization(value,options);rec=Object.keys(precord).reduce(function(prec,pkey){prec[key+'.'+pkey]=precord[pkey];return prec;},_.extend({},rec));}return rec;},record);}function createPipelineStream(s1,s2){var pipeline=new PassThrough();pipeline.on('pipe',function(source){source.unpipe(pipeline);source.pipe(s1).pipe(s2);});pipeline.pipe=function(dest,options){return s2.pipe(dest,options);};return pipeline;}var CSVStreamConverter={serialize:function serialize(options){options=options||{};return createPipelineStream(RecordStream.map(function(record){return convertRecordForSerialization(record,options);}),CSV.serializeCSVStream(options));},parse:function parse(options){return CSV.parseCSVStream(options);}};var DataStreamConverters=RecordStream.DataStreamConverters={csv:CSVStreamConverter};},{"./csv":118,"events":57,"inherits":94,"lodash/core":146,"readable-stream":143}],128:[function(require,module,exports){'use strict';var _=require('lodash/core');var RecordReference=module.exports=function(conn,type,id){this._conn=conn;this.type=type;this.id=id;};RecordReference.prototype.retrieve=function(options,callback){if(typeof options==='function'){callback=options;options={};}return this._conn.retrieve(this.type,this.id,options,callback);};RecordReference.prototype.update=function(record,options,callback){if(typeof options==='function'){callback=options;options={};}record=_.clone(record);record.Id=this.id;return this._conn.update(this.type,record,options,callback);};RecordReference.prototype["delete"]=RecordReference.prototype.del=RecordReference.prototype.destroy=function(options,callback){if(typeof options==='function'){callback=options;options={};}return this._conn.destroy(this.type,this.id,options,callback);};RecordReference.prototype.blob=function(fieldName){var url=[this._conn._baseUrl(),'sobjects',this.type,this.id,fieldName].join('/');return this._conn.request(url).stream();};},{"lodash/core":146}],129:[function(require,module,exports){'use strict';var required=require('./_required');module.exports=function(name){if(name==='./jsforce'||name==='jsforce'){name='./core';}var m=required[name];if(typeof m==='undefined'){throw new Error("Cannot find module '"+name+"'");}return m;};},{"./_required":99}],130:[function(require,module,exports){'use strict';var inherits=require('inherits'),_=require('lodash/core'),xml2js=require('xml2js'),HttpApi=require('./http-api');var SOAP=module.exports=function(conn,options){SOAP.super_.apply(this,arguments);this._endpointUrl=options.endpointUrl;this._xmlns=options.xmlns||'urn:partner.soap.sforce.com';};inherits(SOAP,HttpApi);SOAP.prototype.invoke=function(method,args,schema,callback){if(typeof schema==='function'){callback=schema;schema=null;}var message={};message[method]=args;return this.request({method:'POST',url:this._endpointUrl,headers:{'Content-Type':'text/xml','SOAPAction':'""'},message:message}).then(function(res){return schema?convertType(res,schema):res;}).thenCall(callback);};function convertType(value,schema){if(_.isArray(value)){return value.map(function(v){return convertType(v,schema&&schema[0]);});}else if(_.isObject(value)){if(value.$&&value.$['xsi:nil']==='true'){return null;}else if(_.isArray(schema)){return[convertType(value,schema[0])];}else{var o={};for(var key in value){o[key]=convertType(value[key],schema&&schema[key]);}return o;}}else{if(_.isArray(schema)){return[convertType(value,schema[0])];}else if(_.isObject(schema)){return{};}else{switch(schema){case'string':return String(value);case'number':return Number(value);case'boolean':return value==='true';default:return value;}}}}SOAP.prototype.beforeSend=function(request){request.body=this._createEnvelope(request.message);};SOAP.prototype.isSessionExpired=function(response){return response.statusCode===500&&/<faultcode>[a-zA-Z]+:INVALID_SESSION_ID<\/faultcode>/.test(response.body);};SOAP.prototype.parseError=function(body){var error=lookupValue(body,[/:Envelope$/,/:Body$/,/:Fault$/]);return{errorCode:error.faultcode,message:error.faultstring};};SOAP.prototype.getResponseBody=function(response){var body=SOAP.super_.prototype.getResponseBody.call(this,response);return lookupValue(body,[/:Envelope$/,/:Body$/,/.+/]);};function lookupValue(obj,propRegExps){var regexp=propRegExps.shift();if(!regexp){return obj;}else{for(var prop in obj){if(regexp.test(prop)){return lookupValue(obj[prop],propRegExps);}}return null;}}function toXML(name,value){if(_.isObject(name)){value=name;name=null;}if(_.isArray(value)){return _.map(value,function(v){return toXML(name,v);}).join('');}else{var attrs=[];var elems=[];if(_.isObject(value)){for(var k in value){var v=value[k];if(k[0]==='@'){k=k.substring(1);attrs.push(k+'="'+v+'"');}else{elems.push(toXML(k,v));}}value=elems.join('');}else{value=String(value).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');}var startTag=name?'<'+name+(attrs.length>0?' '+attrs.join(' '):'')+'>':'';var endTag=name?'</'+name+'>':'';return startTag+value+endTag;}}SOAP.prototype._createEnvelope=function(message){var header={};var conn=this._conn;if(conn.accessToken){header.SessionHeader={sessionId:this._conn.accessToken};}if(conn.callOptions){header.CallOptions=conn.callOptions;}return['<?xml version="1.0" encoding="UTF-8"?>','<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"',' xmlns:xsd="http://www.w3.org/2001/XMLSchema"',' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">','<soapenv:Header xmlns="'+this._xmlns+'">',toXML(header),'</soapenv:Header>','<soapenv:Body xmlns="'+this._xmlns+'">',toXML(message),'</soapenv:Body>','</soapenv:Envelope>'].join('');};},{"./http-api":120,"inherits":94,"lodash/core":146,"xml2js":214}],131:[function(require,module,exports){'use strict';var _=require('lodash/core'),Record=require('./record'),Query=require('./query'),Cache=require('./cache'),QuickAction=require('./quick-action');var SObject=module.exports=function(conn,type){this._conn=conn;this.type=type;var cacheOptions={key:"describe."+this.type};this.describe$=conn.cache.makeCacheable(this.describe,this,cacheOptions);this.describe=conn.cache.makeResponseCacheable(this.describe,this,cacheOptions);cacheOptions={key:"layouts."+this.type};this.layouts$=conn.cache.makeCacheable(this.layouts,this,cacheOptions);this.layouts=conn.cache.makeResponseCacheable(this.layouts,this,cacheOptions);cacheOptions={key:"compactLayouts."+this.type};this.compactLayouts$=conn.cache.makeCacheable(this.compactLayouts,this,cacheOptions);this.compactLayouts=conn.cache.makeResponseCacheable(this.compactLayouts,this,cacheOptions);cacheOptions={key:"approvalLayouts."+this.type};this.approvalLayouts$=conn.cache.makeCacheable(this.approvalLayouts,this,cacheOptions);this.approvalLayouts=conn.cache.makeResponseCacheable(this.approvalLayouts,this,cacheOptions);};SObject.prototype.insert=SObject.prototype.create=function(records,options,callback){if(typeof options==='function'){callback=options;options={};}return this._conn.create(this.type,records,options,callback);};SObject.prototype.retrieve=function(ids,options,callback){if(typeof options==='function'){callback=options;options={};}return this._conn.retrieve(this.type,ids,options,callback);};SObject.prototype.update=function(records,options,callback){if(typeof options==='function'){callback=options;options={};}return this._conn.update(this.type,records,options,callback);};SObject.prototype.upsert=function(records,extIdField,options,callback){if(typeof options==='function'){callback=options;options={};}return this._conn.upsert(this.type,records,extIdField,options,callback);};SObject.prototype["delete"]=SObject.prototype.del=SObject.prototype.destroy=function(ids,options,callback){if(typeof options==='function'){callback=options;options={};}return this._conn.destroy(this.type,ids,options,callback);};SObject.prototype.describe=function(callback){return this._conn.describe(this.type,callback);};SObject.prototype.record=function(id){return new Record(this._conn,this.type,id);};SObject.prototype.find=function(conditions,fields,options,callback){if(typeof conditions==='function'){callback=conditions;conditions={};fields=null;options=null;}else if(typeof fields==='function'){callback=fields;fields=null;options=null;}else if(typeof options==='function'){callback=options;options=null;}options=options||{};var config={fields:fields,includes:options.includes,table:this.type,conditions:conditions,limit:options.limit,sort:options.sort,offset:options.offset||options.skip};var query=new Query(this._conn,config,options);query.setResponseTarget(Query.ResponseTargets.Records);if(callback){query.run(callback);}return query;};SObject.prototype.findOne=function(conditions,fields,options,callback){if(typeof conditions==='function'){callback=conditions;conditions={};fields=null;options=null;}else if(typeof fields==='function'){callback=fields;fields=null;options=null;}else if(typeof options==='function'){callback=options;options=null;}options=_.extend(options||{},{limit:1});var query=this.find(conditions,fields,options);query.setResponseTarget(Query.ResponseTargets.SingleRecord);if(callback){query.run(callback);}return query;};SObject.prototype.select=function(fields,callback){return this.find(null,fields,null,callback);};SObject.prototype.count=function(conditions,callback){if(typeof conditions==='function'){callback=conditions;conditions={};}var query=this.find(conditions,{"count()":true});query.setResponseTarget("Count");if(callback){query.run(callback);}return query;};SObject.prototype.bulkload=function(operation,options,input,callback){return this._conn.bulk.load(this.type,operation,options,input,callback);};SObject.prototype.insertBulk=SObject.prototype.createBulk=function(input,callback){return this.bulkload("insert",input,callback);};SObject.prototype.updateBulk=function(input,callback){return this.bulkload("update",input,callback);};SObject.prototype.upsertBulk=function(input,extIdField,callback){return this.bulkload("upsert",{extIdField:extIdField},input,callback);};SObject.prototype.deleteBulk=SObject.prototype.destroyBulk=function(input,callback){return this.bulkload("delete",input,callback);};SObject.prototype.deleteHardBulk=SObject.prototype.destroyHardBulk=function(input,callback){return this.bulkload("hardDelete",input,callback);};SObject.prototype.recent=function(callback){return this._conn.recent(this.type,callback);};SObject.prototype.updated=function(start,end,callback){return this._conn.updated(this.type,start,end,callback);};SObject.prototype.deleted=function(start,end,callback){return this._conn.deleted(this.type,start,end,callback);};SObject.prototype.layouts=function(layoutName,callback){if(typeof layoutName==='function'){callback=layoutName;layoutName=null;}var url="/sobjects/"+this.type+"/describe/"+(layoutName?"namedLayouts/"+layoutName:"layouts");return this._conn.request(url,callback);};SObject.prototype.compactLayouts=function(callback){var url="/sobjects/"+this.type+"/describe/compactLayouts";return this._conn.request(url,callback);};SObject.prototype.approvalLayouts=function(callback){var url="/sobjects/"+this.type+"/describe/approvalLayouts";return this._conn.request(url,callback);};SObject.prototype.listviews=function(callback){var url=this._conn._baseUrl()+'/sobjects/'+this.type+'/listviews';return this._conn.request(url,callback);};SObject.prototype.listview=function(id){return new ListView(this._conn,this.type,id);};SObject.prototype.quickActions=function(callback){return this._conn.request("/sobjects/"+this.type+"/quickActions").thenCall(callback);};SObject.prototype.quickAction=function(actionName){return new QuickAction(this._conn,"/sobjects/"+this.type+"/quickActions/"+actionName);};var ListView=function ListView(conn,type,id){this._conn=conn;this.type=type;this.id=id;};ListView.prototype.results=function(callback){var url=this._conn._baseUrl()+'/sobjects/'+this.type+'/listviews/'+this.id+'/results';return this._conn.request(url,callback);};ListView.prototype.describe=function(options,callback){if(typeof options==='function'){callback=options;options={};}options=options||{};var url=this._conn._baseUrl()+'/sobjects/'+this.type+'/listviews/'+this.id+'/describe';return this._conn.request({method:'GET',url:url,headers:options.headers},callback);};ListView.prototype.explain=function(callback){var url="/query/?explain="+this.id;return this._conn.request(url,callback);};},{"./cache":115,"./query":125,"./quick-action":126,"./record":128,"lodash/core":146}],132:[function(require,module,exports){'use strict';var _=require('lodash/core'),SfDate=require("./date");function createSOQL(query){var soql=["SELECT ",createFieldsClause(query.fields,query.includes)," FROM ",query.table].join("");var cond=createConditionClause(query.conditions);if(cond){soql+=" WHERE "+cond;}var orderby=createOrderByClause(query.sort);if(orderby){soql+=" ORDER BY "+orderby;}if(query.limit){soql+=" LIMIT "+query.limit;}if(query.offset){soql+=" OFFSET "+query.offset;}return soql;}function createFieldsClause(fields,childQueries){childQueries=_.map(_.values(childQueries||{}),function(cquery){return'('+createSOQL(cquery)+')';});return(fields||["Id"]).concat(childQueries).join(', ');}function createConditionClause(conditions,operator,depth){if(_.isString(conditions)){return conditions;}conditions=conditions||[];operator=operator||"AND";depth=depth||0;if(!isArray(conditions)){conditions=_.keys(conditions).map(function(key){return{key:key,value:conditions[key]};});}else{conditions=conditions.map(function(cond){var conds=[];for(var key in cond){conds.push({key:key,value:cond[key]});}return conds.length>1?conds:conds[0];});}conditions=conditions.map(function(cond){var d=depth+1,op;switch(cond.key){case"$or":case"$and":case"$not":if(operator!=="NOT"&&conditions.length===1){d=depth;}op=cond.key==="$or"?"OR":cond.key==="$and"?"AND":"NOT";return createConditionClause(cond.value,op,d);default:return createFieldExpression(cond.key,cond.value);}}).filter(function(expr){return expr;});var paren;if(operator==='NOT'){paren=depth>0;return(paren?"(":"")+"NOT "+conditions[0]+(paren?")":"");}else{paren=depth>0&&conditions.length>1;return(paren?"(":"")+conditions.join(" "+operator+" ")+(paren?")":"");}}var opMap={"=":"=","$eq":"=","!=":"!=","$ne":"!=",">":">","$gt":">","<":"<","$lt":"<",">=":">=","$gte":">=","<=":"<=","$lte":"<=","$like":"LIKE","$nlike":"NOT LIKE","$in":"IN","$nin":"NOT IN","$includes":"INCLUDES","$excludes":"EXCLUDES","$exists":"EXISTS"};function createFieldExpression(field,value){var op="$eq";if(_.isArray(value)){op="$in";}else if(_.isObject(value)){var _value;for(var k in value){if(k[0]==="$"){op=k;value=value[k];break;}}}var sfop=opMap[op];if(!sfop||_.isUndefined(value)){return null;}var valueExpr=createValueExpression(value);if(_.isUndefined(valueExpr)){return null;}switch(sfop){case"NOT LIKE":return"("+["NOT",field,'LIKE',valueExpr].join(" ")+")";case"EXISTS":return[field,value?"!=":"=","null"].join(" ");default:return[field,sfop,valueExpr].join(" ");}}function createValueExpression(value){if(isArray(value)){return value.length>0?"("+value.map(createValueExpression).join(", ")+")":undefined;}if(value instanceof SfDate){return value.toString();}if(_.isString(value)){return"'"+escapeSOQLString(value)+"'";}if(_.isNumber(value)){return value.toString();}if(_.isNull(value)){return"null";}return value;}function escapeSOQLString(str){return String(str||'').replace(/'/g,"\\'");}function isArray(a){return _.isObject(a)&&_.isFunction(a.pop);}function createOrderByClause(sort){sort=sort||[];if(_.isString(sort)){if(/,|\s+(asc|desc)\s*$/.test(sort)){return sort;}sort=sort.split(/\s+/).map(function(field){var dir="ASC";var flag=field[0];if(flag==='-'){dir="DESC";field=field.substring(1);}else if(flag==='+'){field=field.substring(1);}return[field,dir];});}else if(!isArray(sort)){sort=_.keys(sort).map(function(field){var dir=sort[field];return[field,dir];});}return sort.map(function(s){var field=s[0],dir=s[1];switch(String(dir)){case"DESC":case"desc":case"descending":case"-":case"-1":dir="DESC";break;default:dir="ASC";}return field+" "+dir;}).join(", ");}exports.createSOQL=createSOQL;},{"./date":119,"lodash/core":146}],133:[function(require,module,exports){(function(process){'use strict';var inherits=require('inherits'),Promise=require('./promise');var request=require('request'),canvas=require('./browser/canvas'),jsonp=require('./browser/jsonp');if(request.defaults){var defaults={followAllRedirects:true};if(process.env.HTTP_PROXY){defaults.proxy=process.env.HTTP_PROXY;}if(parseInt(process.env.HTTP_TIMEOUT)){defaults.timeout=parseInt(process.env.HTTP_TIMEOUT);}request=request.defaults(defaults);}var baseUrl;if(typeof window==='undefined'){baseUrl=process.env.LOCATION_BASE_URL||"";}else{var apiHost=normalizeApiHost(window.location.host);baseUrl=apiHost?"https://"+apiHost:"";}function streamify(promise,factory){var _then=promise.then;promise.then=function(){factory();var newPromise=_then.apply(promise,arguments);return streamify(newPromise,factory);};promise.stream=factory;return promise;}function normalizeApiHost(apiHost){var m=/(\w+)\.(visual\.force|salesforce)\.com$/.exec(apiHost);if(m){apiHost=m[1]+".salesforce.com";}return apiHost;}var Transport=module.exports=function(){};Transport.prototype.httpRequest=function(params,callback){var deferred=Promise.defer();var req;var httpRequest=this._getHttpRequestModule();var createRequest=function createRequest(){if(!req){req=httpRequest(params,function(err,response){if(err){deferred.reject(err);}else{deferred.resolve(response);}});}return req;};return streamify(deferred.promise,createRequest).thenCall(callback);};Transport.prototype._getHttpRequestModule=function(){return request;};var JsonpTransport=Transport.JsonpTransport=function(jsonpParam){this._jsonpParam=jsonpParam;};inherits(JsonpTransport,Transport);JsonpTransport.prototype._getHttpRequestModule=function(){return jsonp.createRequest(this._jsonpParam);};JsonpTransport.supported=jsonp.supported;var CanvasTransport=Transport.CanvasTransport=function(signedRequest){this._signedRequest=signedRequest;};inherits(CanvasTransport,Transport);CanvasTransport.prototype._getHttpRequestModule=function(){return canvas.createRequest(this._signedRequest);};CanvasTransport.supported=canvas.supported;var ProxyTransport=Transport.ProxyTransport=function(proxyUrl){this._proxyUrl=proxyUrl;};inherits(ProxyTransport,Transport);ProxyTransport.prototype.httpRequest=function(params,callback){var url=params.url;if(url.indexOf("/")===0){url=baseUrl+url;}var proxyParams={method:params.method,url:this._proxyUrl+'?'+Date.now()+"."+(""+Math.random()).substring(2),headers:{'salesforceproxy-endpoint':url}};if(params.body||params.body===""){proxyParams.body=params.body;}if(params.headers){for(var name in params.headers){proxyParams.headers[name]=params.headers[name];}}return ProxyTransport.super_.prototype.httpRequest.call(this,proxyParams,callback);};var HttpProxyTransport=Transport.HttpProxyTransport=function(httpProxy){this._httpProxy=httpProxy;};inherits(HttpProxyTransport,Transport);HttpProxyTransport.prototype.httpRequest=function(params,callback){var url=params.url;if(url.indexOf("/")===0){url=baseUrl+url;}var proxyParams={method:params.method,url:params.url,proxy:this._httpProxy,headers:{}};if(params.body||params.body===""){proxyParams.body=params.body;}if(params.headers){for(var name in params.headers){proxyParams.headers[name]=params.headers[name];}}return HttpProxyTransport.super_.prototype.httpRequest.call(this,proxyParams,callback);};}).call(this,require('_process'));},{"./browser/canvas":110,"./browser/jsonp":113,"./promise":124,"_process":170,"inherits":94,"request":114}],134:[function(require,module,exports){arguments[4][50][0].apply(exports,arguments);},{"dup":50}],135:[function(require,module,exports){'use strict';var pna=require('process-nextick-args');var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj){keys.push(key);}return keys;};module.exports=Duplex;var util=require('core-util-is');util.inherits=require('inherits');var Readable=require('./_stream_readable');var Writable=require('./_stream_writable');util.inherits(Duplex,Readable);{var keys=objectKeys(Writable.prototype);for(var v=0;v<keys.length;v++){var method=keys[v];if(!Duplex.prototype[method])Duplex.prototype[method]=Writable.prototype[method];}}function Duplex(options){if(!(this instanceof Duplex))return new Duplex(options);Readable.call(this,options);Writable.call(this,options);if(options&&options.readable===false)this.readable=false;if(options&&options.writable===false)this.writable=false;this.allowHalfOpen=true;if(options&&options.allowHalfOpen===false)this.allowHalfOpen=false;this.once('end',onend);}Object.defineProperty(Duplex.prototype,'writableHighWaterMark',{enumerable:false,get:function get(){return this._writableState.highWaterMark;}});function onend(){if(this.allowHalfOpen||this._writableState.ended)return;pna.nextTick(onEndNT,this);}function onEndNT(self){self.end();}Object.defineProperty(Duplex.prototype,'destroyed',{get:function get(){if(this._readableState===undefined||this._writableState===undefined){return false;}return this._readableState.destroyed&&this._writableState.destroyed;},set:function set(value){if(this._readableState===undefined||this._writableState===undefined){return;}this._readableState.destroyed=value;this._writableState.destroyed=value;}});Duplex.prototype._destroy=function(err,cb){this.push(null);this.end();pna.nextTick(cb,err);};},{"./_stream_readable":137,"./_stream_writable":139,"core-util-is":51,"inherits":94,"process-nextick-args":169}],136:[function(require,module,exports){'use strict';module.exports=PassThrough;var Transform=require('./_stream_transform');var util=require('core-util-is');util.inherits=require('inherits');util.inherits(PassThrough,Transform);function PassThrough(options){if(!(this instanceof PassThrough))return new PassThrough(options);Transform.call(this,options);}PassThrough.prototype._transform=function(chunk,encoding,cb){cb(null,chunk);};},{"./_stream_transform":138,"core-util-is":51,"inherits":94}],137:[function(require,module,exports){(function(process,global){'use strict';var pna=require('process-nextick-args');module.exports=Readable;var isArray=require('isarray');var Duplex;Readable.ReadableState=ReadableState;var EE=require('events').EventEmitter;var EElistenerCount=function EElistenerCount(emitter,type){return emitter.listeners(type).length;};var Stream=require('./internal/streams/stream');var Buffer=require('safe-buffer').Buffer;var OurUint8Array=global.Uint8Array||function(){};function _uint8ArrayToBuffer(chunk){return Buffer.from(chunk);}function _isUint8Array(obj){return Buffer.isBuffer(obj)||obj instanceof OurUint8Array;}var util=require('core-util-is');util.inherits=require('inherits');var debugUtil=require('util');var debug=void 0;if(debugUtil&&debugUtil.debuglog){debug=debugUtil.debuglog('stream');}else{debug=function debug(){};}var BufferList=require('./internal/streams/BufferList');var destroyImpl=require('./internal/streams/destroy');var StringDecoder;util.inherits(Readable,Stream);var kProxyEvents=['error','close','destroy','pause','resume'];function prependListener(emitter,event,fn){if(typeof emitter.prependListener==='function')return emitter.prependListener(event,fn);if(!emitter._events||!emitter._events[event])emitter.on(event,fn);else if(isArray(emitter._events[event]))emitter._events[event].unshift(fn);else emitter._events[event]=[fn,emitter._events[event]];}function ReadableState(options,stream){Duplex=Duplex||require('./_stream_duplex');options=options||{};var isDuplex=stream instanceof Duplex;this.objectMode=!!options.objectMode;if(isDuplex)this.objectMode=this.objectMode||!!options.readableObjectMode;var hwm=options.highWaterMark;var readableHwm=options.readableHighWaterMark;var defaultHwm=this.objectMode?16:16*1024;if(hwm||hwm===0)this.highWaterMark=hwm;else if(isDuplex&&(readableHwm||readableHwm===0))this.highWaterMark=readableHwm;else this.highWaterMark=defaultHwm;this.highWaterMark=Math.floor(this.highWaterMark);this.buffer=new BufferList();this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=null;this.ended=false;this.endEmitted=false;this.reading=false;this.sync=true;this.needReadable=false;this.emittedReadable=false;this.readableListening=false;this.resumeScheduled=false;this.destroyed=false;this.defaultEncoding=options.defaultEncoding||'utf8';this.awaitDrain=0;this.readingMore=false;this.decoder=null;this.encoding=null;if(options.encoding){if(!StringDecoder)StringDecoder=require('string_decoder/').StringDecoder;this.decoder=new StringDecoder(options.encoding);this.encoding=options.encoding;}}function Readable(options){Duplex=Duplex||require('./_stream_duplex');if(!(this instanceof Readable))return new Readable(options);this._readableState=new ReadableState(options,this);this.readable=true;if(options){if(typeof options.read==='function')this._read=options.read;if(typeof options.destroy==='function')this._destroy=options.destroy;}Stream.call(this);}Object.defineProperty(Readable.prototype,'destroyed',{get:function get(){if(this._readableState===undefined){return false;}return this._readableState.destroyed;},set:function set(value){if(!this._readableState){return;}this._readableState.destroyed=value;}});Readable.prototype.destroy=destroyImpl.destroy;Readable.prototype._undestroy=destroyImpl.undestroy;Readable.prototype._destroy=function(err,cb){this.push(null);cb(err);};Readable.prototype.push=function(chunk,encoding){var state=this._readableState;var skipChunkCheck;if(!state.objectMode){if(typeof chunk==='string'){encoding=encoding||state.defaultEncoding;if(encoding!==state.encoding){chunk=Buffer.from(chunk,encoding);encoding='';}skipChunkCheck=true;}}else{skipChunkCheck=true;}return readableAddChunk(this,chunk,encoding,false,skipChunkCheck);};Readable.prototype.unshift=function(chunk){return readableAddChunk(this,chunk,null,true,false);};function readableAddChunk(stream,chunk,encoding,addToFront,skipChunkCheck){var state=stream._readableState;if(chunk===null){state.reading=false;onEofChunk(stream,state);}else{var er;if(!skipChunkCheck)er=chunkInvalid(state,chunk);if(er){stream.emit('error',er);}else if(state.objectMode||chunk&&chunk.length>0){if(typeof chunk!=='string'&&!state.objectMode&&Object.getPrototypeOf(chunk)!==Buffer.prototype){chunk=_uint8ArrayToBuffer(chunk);}if(addToFront){if(state.endEmitted)stream.emit('error',new Error('stream.unshift() after end event'));else addChunk(stream,state,chunk,true);}else if(state.ended){stream.emit('error',new Error('stream.push() after EOF'));}else{state.reading=false;if(state.decoder&&!encoding){chunk=state.decoder.write(chunk);if(state.objectMode||chunk.length!==0)addChunk(stream,state,chunk,false);else maybeReadMore(stream,state);}else{addChunk(stream,state,chunk,false);}}}else if(!addToFront){state.reading=false;}}return needMoreData(state);}function addChunk(stream,state,chunk,addToFront){if(state.flowing&&state.length===0&&!state.sync){stream.emit('data',chunk);stream.read(0);}else{state.length+=state.objectMode?1:chunk.length;if(addToFront)state.buffer.unshift(chunk);else state.buffer.push(chunk);if(state.needReadable)emitReadable(stream);}maybeReadMore(stream,state);}function chunkInvalid(state,chunk){var er;if(!_isUint8Array(chunk)&&typeof chunk!=='string'&&chunk!==undefined&&!state.objectMode){er=new TypeError('Invalid non-string/buffer chunk');}return er;}function needMoreData(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||state.length===0);}Readable.prototype.isPaused=function(){return this._readableState.flowing===false;};Readable.prototype.setEncoding=function(enc){if(!StringDecoder)StringDecoder=require('string_decoder/').StringDecoder;this._readableState.decoder=new StringDecoder(enc);this._readableState.encoding=enc;return this;};var MAX_HWM=0x800000;function computeNewHighWaterMark(n){if(n>=MAX_HWM){n=MAX_HWM;}else{n--;n|=n>>>1;n|=n>>>2;n|=n>>>4;n|=n>>>8;n|=n>>>16;n++;}return n;}function howMuchToRead(n,state){if(n<=0||state.length===0&&state.ended)return 0;if(state.objectMode)return 1;if(n!==n){if(state.flowing&&state.length)return state.buffer.head.data.length;else return state.length;}if(n>state.highWaterMark)state.highWaterMark=computeNewHighWaterMark(n);if(n<=state.length)return n;if(!state.ended){state.needReadable=true;return 0;}return state.length;}Readable.prototype.read=function(n){debug('read',n);n=parseInt(n,10);var state=this._readableState;var nOrig=n;if(n!==0)state.emittedReadable=false;if(n===0&&state.needReadable&&(state.length>=state.highWaterMark||state.ended)){debug('read: emitReadable',state.length,state.ended);if(state.length===0&&state.ended)endReadable(this);else emitReadable(this);return null;}n=howMuchToRead(n,state);if(n===0&&state.ended){if(state.length===0)endReadable(this);return null;}var doRead=state.needReadable;debug('need readable',doRead);if(state.length===0||state.length-n<state.highWaterMark){doRead=true;debug('length less than watermark',doRead);}if(state.ended||state.reading){doRead=false;debug('reading or ended',doRead);}else if(doRead){debug('do read');state.reading=true;state.sync=true;if(state.length===0)state.needReadable=true;this._read(state.highWaterMark);state.sync=false;if(!state.reading)n=howMuchToRead(nOrig,state);}var ret;if(n>0)ret=fromList(n,state);else ret=null;if(ret===null){state.needReadable=true;n=0;}else{state.length-=n;}if(state.length===0){if(!state.ended)state.needReadable=true;if(nOrig!==n&&state.ended)endReadable(this);}if(ret!==null)this.emit('data',ret);return ret;};function onEofChunk(stream,state){if(state.ended)return;if(state.decoder){var chunk=state.decoder.end();if(chunk&&chunk.length){state.buffer.push(chunk);state.length+=state.objectMode?1:chunk.length;}}state.ended=true;emitReadable(stream);}function emitReadable(stream){var state=stream._readableState;state.needReadable=false;if(!state.emittedReadable){debug('emitReadable',state.flowing);state.emittedReadable=true;if(state.sync)pna.nextTick(emitReadable_,stream);else emitReadable_(stream);}}function emitReadable_(stream){debug('emit readable');stream.emit('readable');flow(stream);}function maybeReadMore(stream,state){if(!state.readingMore){state.readingMore=true;pna.nextTick(maybeReadMore_,stream,state);}}function maybeReadMore_(stream,state){var len=state.length;while(!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark){debug('maybeReadMore read 0');stream.read(0);if(len===state.length)break;else len=state.length;}state.readingMore=false;}Readable.prototype._read=function(n){this.emit('error',new Error('_read() is not implemented'));};Readable.prototype.pipe=function(dest,pipeOpts){var src=this;var state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest);break;}state.pipesCount+=1;debug('pipe count=%d opts=%j',state.pipesCount,pipeOpts);var doEnd=(!pipeOpts||pipeOpts.end!==false)&&dest!==process.stdout&&dest!==process.stderr;var endFn=doEnd?onend:unpipe;if(state.endEmitted)pna.nextTick(endFn);else src.once('end',endFn);dest.on('unpipe',onunpipe);function onunpipe(readable,unpipeInfo){debug('onunpipe');if(readable===src){if(unpipeInfo&&unpipeInfo.hasUnpiped===false){unpipeInfo.hasUnpiped=true;cleanup();}}}function onend(){debug('onend');dest.end();}var ondrain=pipeOnDrain(src);dest.on('drain',ondrain);var cleanedUp=false;function cleanup(){debug('cleanup');dest.removeListener('close',onclose);dest.removeListener('finish',onfinish);dest.removeListener('drain',ondrain);dest.removeListener('error',onerror);dest.removeListener('unpipe',onunpipe);src.removeListener('end',onend);src.removeListener('end',unpipe);src.removeListener('data',ondata);cleanedUp=true;if(state.awaitDrain&&(!dest._writableState||dest._writableState.needDrain))ondrain();}var increasedAwaitDrain=false;src.on('data',ondata);function ondata(chunk){debug('ondata');increasedAwaitDrain=false;var ret=dest.write(chunk);if(false===ret&&!increasedAwaitDrain){if((state.pipesCount===1&&state.pipes===dest||state.pipesCount>1&&indexOf(state.pipes,dest)!==-1)&&!cleanedUp){debug('false write response, pause',src._readableState.awaitDrain);src._readableState.awaitDrain++;increasedAwaitDrain=true;}src.pause();}}function onerror(er){debug('onerror',er);unpipe();dest.removeListener('error',onerror);if(EElistenerCount(dest,'error')===0)dest.emit('error',er);}prependListener(dest,'error',onerror);function onclose(){dest.removeListener('finish',onfinish);unpipe();}dest.once('close',onclose);function onfinish(){debug('onfinish');dest.removeListener('close',onclose);unpipe();}dest.once('finish',onfinish);function unpipe(){debug('unpipe');src.unpipe(dest);}dest.emit('pipe',src);if(!state.flowing){debug('pipe resume');src.resume();}return dest;};function pipeOnDrain(src){return function(){var state=src._readableState;debug('pipeOnDrain',state.awaitDrain);if(state.awaitDrain)state.awaitDrain--;if(state.awaitDrain===0&&EElistenerCount(src,'data')){state.flowing=true;flow(src);}};}Readable.prototype.unpipe=function(dest){var state=this._readableState;var unpipeInfo={hasUnpiped:false};if(state.pipesCount===0)return this;if(state.pipesCount===1){if(dest&&dest!==state.pipes)return this;if(!dest)dest=state.pipes;state.pipes=null;state.pipesCount=0;state.flowing=false;if(dest)dest.emit('unpipe',this,unpipeInfo);return this;}if(!dest){var dests=state.pipes;var len=state.pipesCount;state.pipes=null;state.pipesCount=0;state.flowing=false;for(var i=0;i<len;i++){dests[i].emit('unpipe',this,unpipeInfo);}return this;}var index=indexOf(state.pipes,dest);if(index===-1)return this;state.pipes.splice(index,1);state.pipesCount-=1;if(state.pipesCount===1)state.pipes=state.pipes[0];dest.emit('unpipe',this,unpipeInfo);return this;};Readable.prototype.on=function(ev,fn){var res=Stream.prototype.on.call(this,ev,fn);if(ev==='data'){if(this._readableState.flowing!==false)this.resume();}else if(ev==='readable'){var state=this._readableState;if(!state.endEmitted&&!state.readableListening){state.readableListening=state.needReadable=true;state.emittedReadable=false;if(!state.reading){pna.nextTick(nReadingNextTick,this);}else if(state.length){emitReadable(this);}}}return res;};Readable.prototype.addListener=Readable.prototype.on;function nReadingNextTick(self){debug('readable nexttick read 0');self.read(0);}Readable.prototype.resume=function(){var state=this._readableState;if(!state.flowing){debug('resume');state.flowing=true;resume(this,state);}return this;};function resume(stream,state){if(!state.resumeScheduled){state.resumeScheduled=true;pna.nextTick(resume_,stream,state);}}function resume_(stream,state){if(!state.reading){debug('resume read 0');stream.read(0);}state.resumeScheduled=false;state.awaitDrain=0;stream.emit('resume');flow(stream);if(state.flowing&&!state.reading)stream.read(0);}Readable.prototype.pause=function(){debug('call pause flowing=%j',this._readableState.flowing);if(false!==this._readableState.flowing){debug('pause');this._readableState.flowing=false;this.emit('pause');}return this;};function flow(stream){var state=stream._readableState;debug('flow',state.flowing);while(state.flowing&&stream.read()!==null){}}Readable.prototype.wrap=function(stream){var _this=this;var state=this._readableState;var paused=false;stream.on('end',function(){debug('wrapped end');if(state.decoder&&!state.ended){var chunk=state.decoder.end();if(chunk&&chunk.length)_this.push(chunk);}_this.push(null);});stream.on('data',function(chunk){debug('wrapped data');if(state.decoder)chunk=state.decoder.write(chunk);if(state.objectMode&&(chunk===null||chunk===undefined))return;else if(!state.objectMode&&(!chunk||!chunk.length))return;var ret=_this.push(chunk);if(!ret){paused=true;stream.pause();}});for(var i in stream){if(this[i]===undefined&&typeof stream[i]==='function'){this[i]=function(method){return function(){return stream[method].apply(stream,arguments);};}(i);}}for(var n=0;n<kProxyEvents.length;n++){stream.on(kProxyEvents[n],this.emit.bind(this,kProxyEvents[n]));}this._read=function(n){debug('wrapped _read',n);if(paused){paused=false;stream.resume();}};return this;};Object.defineProperty(Readable.prototype,'readableHighWaterMark',{enumerable:false,get:function get(){return this._readableState.highWaterMark;}});Readable._fromList=fromList;function fromList(n,state){if(state.length===0)return null;var ret;if(state.objectMode)ret=state.buffer.shift();else if(!n||n>=state.length){if(state.decoder)ret=state.buffer.join('');else if(state.buffer.length===1)ret=state.buffer.head.data;else ret=state.buffer.concat(state.length);state.buffer.clear();}else{ret=fromListPartial(n,state.buffer,state.decoder);}return ret;}function fromListPartial(n,list,hasStrings){var ret;if(n<list.head.data.length){ret=list.head.data.slice(0,n);list.head.data=list.head.data.slice(n);}else if(n===list.head.data.length){ret=list.shift();}else{ret=hasStrings?copyFromBufferString(n,list):copyFromBuffer(n,list);}return ret;}function copyFromBufferString(n,list){var p=list.head;var c=1;var ret=p.data;n-=ret.length;while(p=p.next){var str=p.data;var nb=n>str.length?str.length:n;if(nb===str.length)ret+=str;else ret+=str.slice(0,n);n-=nb;if(n===0){if(nb===str.length){++c;if(p.next)list.head=p.next;else list.head=list.tail=null;}else{list.head=p;p.data=str.slice(nb);}break;}++c;}list.length-=c;return ret;}function copyFromBuffer(n,list){var ret=Buffer.allocUnsafe(n);var p=list.head;var c=1;p.data.copy(ret);n-=p.data.length;while(p=p.next){var buf=p.data;var nb=n>buf.length?buf.length:n;buf.copy(ret,ret.length-n,0,nb);n-=nb;if(n===0){if(nb===buf.length){++c;if(p.next)list.head=p.next;else list.head=list.tail=null;}else{list.head=p;p.data=buf.slice(nb);}break;}++c;}list.length-=c;return ret;}function endReadable(stream){var state=stream._readableState;if(state.length>0)throw new Error('"endReadable()" called on non-empty stream');if(!state.endEmitted){state.ended=true;pna.nextTick(endReadableNT,state,stream);}}function endReadableNT(state,stream){if(!state.endEmitted&&state.length===0){state.endEmitted=true;stream.readable=false;stream.emit('end');}}function indexOf(xs,x){for(var i=0,l=xs.length;i<l;i++){if(xs[i]===x)return i;}return-1;}}).call(this,require('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./_stream_duplex":135,"./internal/streams/BufferList":140,"./internal/streams/destroy":141,"./internal/streams/stream":142,"_process":170,"core-util-is":51,"events":57,"inherits":94,"isarray":134,"process-nextick-args":169,"safe-buffer":176,"string_decoder/":144,"util":47}],138:[function(require,module,exports){'use strict';module.exports=Transform;var Duplex=require('./_stream_duplex');var util=require('core-util-is');util.inherits=require('inherits');util.inherits(Transform,Duplex);function afterTransform(er,data){var ts=this._transformState;ts.transforming=false;var cb=ts.writecb;if(!cb){return this.emit('error',new Error('write callback called multiple times'));}ts.writechunk=null;ts.writecb=null;if(data!=null)this.push(data);cb(er);var rs=this._readableState;rs.reading=false;if(rs.needReadable||rs.length<rs.highWaterMark){this._read(rs.highWaterMark);}}function Transform(options){if(!(this instanceof Transform))return new Transform(options);Duplex.call(this,options);this._transformState={afterTransform:afterTransform.bind(this),needTransform:false,transforming:false,writecb:null,writechunk:null,writeencoding:null};this._readableState.needReadable=true;this._readableState.sync=false;if(options){if(typeof options.transform==='function')this._transform=options.transform;if(typeof options.flush==='function')this._flush=options.flush;}this.on('prefinish',prefinish);}function prefinish(){var _this=this;if(typeof this._flush==='function'){this._flush(function(er,data){done(_this,er,data);});}else{done(this,null,null);}}Transform.prototype.push=function(chunk,encoding){this._transformState.needTransform=false;return Duplex.prototype.push.call(this,chunk,encoding);};Transform.prototype._transform=function(chunk,encoding,cb){throw new Error('_transform() is not implemented');};Transform.prototype._write=function(chunk,encoding,cb){var ts=this._transformState;ts.writecb=cb;ts.writechunk=chunk;ts.writeencoding=encoding;if(!ts.transforming){var rs=this._readableState;if(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)this._read(rs.highWaterMark);}};Transform.prototype._read=function(n){var ts=this._transformState;if(ts.writechunk!==null&&ts.writecb&&!ts.transforming){ts.transforming=true;this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform);}else{ts.needTransform=true;}};Transform.prototype._destroy=function(err,cb){var _this2=this;Duplex.prototype._destroy.call(this,err,function(err2){cb(err2);_this2.emit('close');});};function done(stream,er,data){if(er)return stream.emit('error',er);if(data!=null)stream.push(data);if(stream._writableState.length)throw new Error('Calling transform done when ws.length != 0');if(stream._transformState.transforming)throw new Error('Calling transform done when still transforming');return stream.push(null);}},{"./_stream_duplex":135,"core-util-is":51,"inherits":94}],139:[function(require,module,exports){(function(process,global,setImmediate){'use strict';var pna=require('process-nextick-args');module.exports=Writable;function WriteReq(chunk,encoding,cb){this.chunk=chunk;this.encoding=encoding;this.callback=cb;this.next=null;}function CorkedRequest(state){var _this=this;this.next=null;this.entry=null;this.finish=function(){onCorkedFinish(_this,state);};}var asyncWrite=!process.browser&&['v0.10','v0.9.'].indexOf(process.version.slice(0,5))>-1?setImmediate:pna.nextTick;var Duplex;Writable.WritableState=WritableState;var util=require('core-util-is');util.inherits=require('inherits');var internalUtil={deprecate:require('util-deprecate')};var Stream=require('./internal/streams/stream');var Buffer=require('safe-buffer').Buffer;var OurUint8Array=global.Uint8Array||function(){};function _uint8ArrayToBuffer(chunk){return Buffer.from(chunk);}function _isUint8Array(obj){return Buffer.isBuffer(obj)||obj instanceof OurUint8Array;}var destroyImpl=require('./internal/streams/destroy');util.inherits(Writable,Stream);function nop(){}function WritableState(options,stream){Duplex=Duplex||require('./_stream_duplex');options=options||{};var isDuplex=stream instanceof Duplex;this.objectMode=!!options.objectMode;if(isDuplex)this.objectMode=this.objectMode||!!options.writableObjectMode;var hwm=options.highWaterMark;var writableHwm=options.writableHighWaterMark;var defaultHwm=this.objectMode?16:16*1024;if(hwm||hwm===0)this.highWaterMark=hwm;else if(isDuplex&&(writableHwm||writableHwm===0))this.highWaterMark=writableHwm;else this.highWaterMark=defaultHwm;this.highWaterMark=Math.floor(this.highWaterMark);this.finalCalled=false;this.needDrain=false;this.ending=false;this.ended=false;this.finished=false;this.destroyed=false;var noDecode=options.decodeStrings===false;this.decodeStrings=!noDecode;this.defaultEncoding=options.defaultEncoding||'utf8';this.length=0;this.writing=false;this.corked=0;this.sync=true;this.bufferProcessing=false;this.onwrite=function(er){onwrite(stream,er);};this.writecb=null;this.writelen=0;this.bufferedRequest=null;this.lastBufferedRequest=null;this.pendingcb=0;this.prefinished=false;this.errorEmitted=false;this.bufferedRequestCount=0;this.corkedRequestsFree=new CorkedRequest(this);}WritableState.prototype.getBuffer=function getBuffer(){var current=this.bufferedRequest;var out=[];while(current){out.push(current);current=current.next;}return out;};(function(){try{Object.defineProperty(WritableState.prototype,'buffer',{get:internalUtil.deprecate(function(){return this.getBuffer();},'_writableState.buffer is deprecated. Use _writableState.getBuffer '+'instead.','DEP0003')});}catch(_){}})();var realHasInstance;if(typeof Symbol==='function'&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]==='function'){realHasInstance=Function.prototype[Symbol.hasInstance];Object.defineProperty(Writable,Symbol.hasInstance,{value:function value(object){if(realHasInstance.call(this,object))return true;if(this!==Writable)return false;return object&&object._writableState instanceof WritableState;}});}else{realHasInstance=function realHasInstance(object){return object instanceof this;};}function Writable(options){Duplex=Duplex||require('./_stream_duplex');if(!realHasInstance.call(Writable,this)&&!(this instanceof Duplex)){return new Writable(options);}this._writableState=new WritableState(options,this);this.writable=true;if(options){if(typeof options.write==='function')this._write=options.write;if(typeof options.writev==='function')this._writev=options.writev;if(typeof options.destroy==='function')this._destroy=options.destroy;if(typeof options.final==='function')this._final=options.final;}Stream.call(this);}Writable.prototype.pipe=function(){this.emit('error',new Error('Cannot pipe, not readable'));};function writeAfterEnd(stream,cb){var er=new Error('write after end');stream.emit('error',er);pna.nextTick(cb,er);}function validChunk(stream,state,chunk,cb){var valid=true;var er=false;if(chunk===null){er=new TypeError('May not write null values to stream');}else if(typeof chunk!=='string'&&chunk!==undefined&&!state.objectMode){er=new TypeError('Invalid non-string/buffer chunk');}if(er){stream.emit('error',er);pna.nextTick(cb,er);valid=false;}return valid;}Writable.prototype.write=function(chunk,encoding,cb){var state=this._writableState;var ret=false;var isBuf=!state.objectMode&&_isUint8Array(chunk);if(isBuf&&!Buffer.isBuffer(chunk)){chunk=_uint8ArrayToBuffer(chunk);}if(typeof encoding==='function'){cb=encoding;encoding=null;}if(isBuf)encoding='buffer';else if(!encoding)encoding=state.defaultEncoding;if(typeof cb!=='function')cb=nop;if(state.ended)writeAfterEnd(this,cb);else if(isBuf||validChunk(this,state,chunk,cb)){state.pendingcb++;ret=writeOrBuffer(this,state,isBuf,chunk,encoding,cb);}return ret;};Writable.prototype.cork=function(){var state=this._writableState;state.corked++;};Writable.prototype.uncork=function(){var state=this._writableState;if(state.corked){state.corked--;if(!state.writing&&!state.corked&&!state.finished&&!state.bufferProcessing&&state.bufferedRequest)clearBuffer(this,state);}};Writable.prototype.setDefaultEncoding=function setDefaultEncoding(encoding){if(typeof encoding==='string')encoding=encoding.toLowerCase();if(!(['hex','utf8','utf-8','ascii','binary','base64','ucs2','ucs-2','utf16le','utf-16le','raw'].indexOf((encoding+'').toLowerCase())>-1))throw new TypeError('Unknown encoding: '+encoding);this._writableState.defaultEncoding=encoding;return this;};function decodeChunk(state,chunk,encoding){if(!state.objectMode&&state.decodeStrings!==false&&typeof chunk==='string'){chunk=Buffer.from(chunk,encoding);}return chunk;}Object.defineProperty(Writable.prototype,'writableHighWaterMark',{enumerable:false,get:function get(){return this._writableState.highWaterMark;}});function writeOrBuffer(stream,state,isBuf,chunk,encoding,cb){if(!isBuf){var newChunk=decodeChunk(state,chunk,encoding);if(chunk!==newChunk){isBuf=true;encoding='buffer';chunk=newChunk;}}var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;if(!ret)state.needDrain=true;if(state.writing||state.corked){var last=state.lastBufferedRequest;state.lastBufferedRequest={chunk:chunk,encoding:encoding,isBuf:isBuf,callback:cb,next:null};if(last){last.next=state.lastBufferedRequest;}else{state.bufferedRequest=state.lastBufferedRequest;}state.bufferedRequestCount+=1;}else{doWrite(stream,state,false,len,chunk,encoding,cb);}return ret;}function doWrite(stream,state,writev,len,chunk,encoding,cb){state.writelen=len;state.writecb=cb;state.writing=true;state.sync=true;if(writev)stream._writev(chunk,state.onwrite);else stream._write(chunk,encoding,state.onwrite);state.sync=false;}function onwriteError(stream,state,sync,er,cb){--state.pendingcb;if(sync){pna.nextTick(cb,er);pna.nextTick(finishMaybe,stream,state);stream._writableState.errorEmitted=true;stream.emit('error',er);}else{cb(er);stream._writableState.errorEmitted=true;stream.emit('error',er);finishMaybe(stream,state);}}function onwriteStateUpdate(state){state.writing=false;state.writecb=null;state.length-=state.writelen;state.writelen=0;}function onwrite(stream,er){var state=stream._writableState;var sync=state.sync;var cb=state.writecb;onwriteStateUpdate(state);if(er)onwriteError(stream,state,sync,er,cb);else{var finished=needFinish(state);if(!finished&&!state.corked&&!state.bufferProcessing&&state.bufferedRequest){clearBuffer(stream,state);}if(sync){asyncWrite(afterWrite,stream,state,finished,cb);}else{afterWrite(stream,state,finished,cb);}}}function afterWrite(stream,state,finished,cb){if(!finished)onwriteDrain(stream,state);state.pendingcb--;cb();finishMaybe(stream,state);}function onwriteDrain(stream,state){if(state.length===0&&state.needDrain){state.needDrain=false;stream.emit('drain');}}function clearBuffer(stream,state){state.bufferProcessing=true;var entry=state.bufferedRequest;if(stream._writev&&entry&&entry.next){var l=state.bufferedRequestCount;var buffer=new Array(l);var holder=state.corkedRequestsFree;holder.entry=entry;var count=0;var allBuffers=true;while(entry){buffer[count]=entry;if(!entry.isBuf)allBuffers=false;entry=entry.next;count+=1;}buffer.allBuffers=allBuffers;doWrite(stream,state,true,state.length,buffer,'',holder.finish);state.pendingcb++;state.lastBufferedRequest=null;if(holder.next){state.corkedRequestsFree=holder.next;holder.next=null;}else{state.corkedRequestsFree=new CorkedRequest(state);}state.bufferedRequestCount=0;}else{while(entry){var chunk=entry.chunk;var encoding=entry.encoding;var cb=entry.callback;var len=state.objectMode?1:chunk.length;doWrite(stream,state,false,len,chunk,encoding,cb);entry=entry.next;state.bufferedRequestCount--;if(state.writing){break;}}if(entry===null)state.lastBufferedRequest=null;}state.bufferedRequest=entry;state.bufferProcessing=false;}Writable.prototype._write=function(chunk,encoding,cb){cb(new Error('_write() is not implemented'));};Writable.prototype._writev=null;Writable.prototype.end=function(chunk,encoding,cb){var state=this._writableState;if(typeof chunk==='function'){cb=chunk;chunk=null;encoding=null;}else if(typeof encoding==='function'){cb=encoding;encoding=null;}if(chunk!==null&&chunk!==undefined)this.write(chunk,encoding);if(state.corked){state.corked=1;this.uncork();}if(!state.ending&&!state.finished)endWritable(this,state,cb);};function needFinish(state){return state.ending&&state.length===0&&state.bufferedRequest===null&&!state.finished&&!state.writing;}function callFinal(stream,state){stream._final(function(err){state.pendingcb--;if(err){stream.emit('error',err);}state.prefinished=true;stream.emit('prefinish');finishMaybe(stream,state);});}function prefinish(stream,state){if(!state.prefinished&&!state.finalCalled){if(typeof stream._final==='function'){state.pendingcb++;state.finalCalled=true;pna.nextTick(callFinal,stream,state);}else{state.prefinished=true;stream.emit('prefinish');}}}function finishMaybe(stream,state){var need=needFinish(state);if(need){prefinish(stream,state);if(state.pendingcb===0){state.finished=true;stream.emit('finish');}}return need;}function endWritable(stream,state,cb){state.ending=true;finishMaybe(stream,state);if(cb){if(state.finished)pna.nextTick(cb);else stream.once('finish',cb);}state.ended=true;stream.writable=false;}function onCorkedFinish(corkReq,state,err){var entry=corkReq.entry;corkReq.entry=null;while(entry){var cb=entry.callback;state.pendingcb--;cb(err);entry=entry.next;}if(state.corkedRequestsFree){state.corkedRequestsFree.next=corkReq;}else{state.corkedRequestsFree=corkReq;}}Object.defineProperty(Writable.prototype,'destroyed',{get:function get(){if(this._writableState===undefined){return false;}return this._writableState.destroyed;},set:function set(value){if(!this._writableState){return;}this._writableState.destroyed=value;}});Writable.prototype.destroy=destroyImpl.destroy;Writable.prototype._undestroy=destroyImpl.undestroy;Writable.prototype._destroy=function(err,cb){this.end();cb(err);};}).call(this,require('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{},require("timers").setImmediate);},{"./_stream_duplex":135,"./internal/streams/destroy":141,"./internal/streams/stream":142,"_process":170,"core-util-is":51,"inherits":94,"process-nextick-args":169,"safe-buffer":176,"timers":204,"util-deprecate":205}],140:[function(require,module,exports){'use strict';function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var Buffer=require('safe-buffer').Buffer;var util=require('util');function copyBuffer(src,target,offset){src.copy(target,offset);}module.exports=function(){function BufferList(){_classCallCheck(this,BufferList);this.head=null;this.tail=null;this.length=0;}BufferList.prototype.push=function push(v){var entry={data:v,next:null};if(this.length>0)this.tail.next=entry;else this.head=entry;this.tail=entry;++this.length;};BufferList.prototype.unshift=function unshift(v){var entry={data:v,next:this.head};if(this.length===0)this.tail=entry;this.head=entry;++this.length;};BufferList.prototype.shift=function shift(){if(this.length===0)return;var ret=this.head.data;if(this.length===1)this.head=this.tail=null;else this.head=this.head.next;--this.length;return ret;};BufferList.prototype.clear=function clear(){this.head=this.tail=null;this.length=0;};BufferList.prototype.join=function join(s){if(this.length===0)return'';var p=this.head;var ret=''+p.data;while(p=p.next){ret+=s+p.data;}return ret;};BufferList.prototype.concat=function concat(n){if(this.length===0)return Buffer.alloc(0);if(this.length===1)return this.head.data;var ret=Buffer.allocUnsafe(n>>>0);var p=this.head;var i=0;while(p){copyBuffer(p.data,ret,i);i+=p.data.length;p=p.next;}return ret;};return BufferList;}();if(util&&util.inspect&&util.inspect.custom){module.exports.prototype[util.inspect.custom]=function(){var obj=util.inspect({length:this.length});return this.constructor.name+' '+obj;};}},{"safe-buffer":176,"util":47}],141:[function(require,module,exports){'use strict';var pna=require('process-nextick-args');function destroy(err,cb){var _this=this;var readableDestroyed=this._readableState&&this._readableState.destroyed;var writableDestroyed=this._writableState&&this._writableState.destroyed;if(readableDestroyed||writableDestroyed){if(cb){cb(err);}else if(err&&(!this._writableState||!this._writableState.errorEmitted)){pna.nextTick(emitErrorNT,this,err);}return this;}if(this._readableState){this._readableState.destroyed=true;}if(this._writableState){this._writableState.destroyed=true;}this._destroy(err||null,function(err){if(!cb&&err){pna.nextTick(emitErrorNT,_this,err);if(_this._writableState){_this._writableState.errorEmitted=true;}}else if(cb){cb(err);}});return this;}function undestroy(){if(this._readableState){this._readableState.destroyed=false;this._readableState.reading=false;this._readableState.ended=false;this._readableState.endEmitted=false;}if(this._writableState){this._writableState.destroyed=false;this._writableState.ended=false;this._writableState.ending=false;this._writableState.finished=false;this._writableState.errorEmitted=false;}}function emitErrorNT(self,err){self.emit('error',err);}module.exports={destroy:destroy,undestroy:undestroy};},{"process-nextick-args":169}],142:[function(require,module,exports){module.exports=require('events').EventEmitter;},{"events":57}],143:[function(require,module,exports){exports=module.exports=require('./lib/_stream_readable.js');exports.Stream=exports;exports.Readable=exports;exports.Writable=require('./lib/_stream_writable.js');exports.Duplex=require('./lib/_stream_duplex.js');exports.Transform=require('./lib/_stream_transform.js');exports.PassThrough=require('./lib/_stream_passthrough.js');},{"./lib/_stream_duplex.js":135,"./lib/_stream_passthrough.js":136,"./lib/_stream_readable.js":137,"./lib/_stream_transform.js":138,"./lib/_stream_writable.js":139}],144:[function(require,module,exports){'use strict';var Buffer=require('safe-buffer').Buffer;var isEncoding=Buffer.isEncoding||function(encoding){encoding=''+encoding;switch(encoding&&encoding.toLowerCase()){case'hex':case'utf8':case'utf-8':case'ascii':case'binary':case'base64':case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':case'raw':return true;default:return false;}};function _normalizeEncoding(enc){if(!enc)return'utf8';var retried;while(true){switch(enc){case'utf8':case'utf-8':return'utf8';case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return'utf16le';case'latin1':case'binary':return'latin1';case'base64':case'ascii':case'hex':return enc;default:if(retried)return;enc=(''+enc).toLowerCase();retried=true;}}};function normalizeEncoding(enc){var nenc=_normalizeEncoding(enc);if(typeof nenc!=='string'&&(Buffer.isEncoding===isEncoding||!isEncoding(enc)))throw new Error('Unknown encoding: '+enc);return nenc||enc;}exports.StringDecoder=StringDecoder;function StringDecoder(encoding){this.encoding=normalizeEncoding(encoding);var nb;switch(this.encoding){case'utf16le':this.text=utf16Text;this.end=utf16End;nb=4;break;case'utf8':this.fillLast=utf8FillLast;nb=4;break;case'base64':this.text=base64Text;this.end=base64End;nb=3;break;default:this.write=simpleWrite;this.end=simpleEnd;return;}this.lastNeed=0;this.lastTotal=0;this.lastChar=Buffer.allocUnsafe(nb);}StringDecoder.prototype.write=function(buf){if(buf.length===0)return'';var r;var i;if(this.lastNeed){r=this.fillLast(buf);if(r===undefined)return'';i=this.lastNeed;this.lastNeed=0;}else{i=0;}if(i<buf.length)return r?r+this.text(buf,i):this.text(buf,i);return r||'';};StringDecoder.prototype.end=utf8End;StringDecoder.prototype.text=utf8Text;StringDecoder.prototype.fillLast=function(buf){if(this.lastNeed<=buf.length){buf.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed);return this.lastChar.toString(this.encoding,0,this.lastTotal);}buf.copy(this.lastChar,this.lastTotal-this.lastNeed,0,buf.length);this.lastNeed-=buf.length;};function utf8CheckByte(byte){if(byte<=0x7F)return 0;else if(byte>>5===0x06)return 2;else if(byte>>4===0x0E)return 3;else if(byte>>3===0x1E)return 4;return byte>>6===0x02?-1:-2;}function utf8CheckIncomplete(self,buf,i){var j=buf.length-1;if(j<i)return 0;var nb=utf8CheckByte(buf[j]);if(nb>=0){if(nb>0)self.lastNeed=nb-1;return nb;}if(--j<i||nb===-2)return 0;nb=utf8CheckByte(buf[j]);if(nb>=0){if(nb>0)self.lastNeed=nb-2;return nb;}if(--j<i||nb===-2)return 0;nb=utf8CheckByte(buf[j]);if(nb>=0){if(nb>0){if(nb===2)nb=0;else self.lastNeed=nb-3;}return nb;}return 0;}function utf8CheckExtraBytes(self,buf,p){if((buf[0]&0xC0)!==0x80){self.lastNeed=0;return"\uFFFD";}if(self.lastNeed>1&&buf.length>1){if((buf[1]&0xC0)!==0x80){self.lastNeed=1;return"\uFFFD";}if(self.lastNeed>2&&buf.length>2){if((buf[2]&0xC0)!==0x80){self.lastNeed=2;return"\uFFFD";}}}}function utf8FillLast(buf){var p=this.lastTotal-this.lastNeed;var r=utf8CheckExtraBytes(this,buf,p);if(r!==undefined)return r;if(this.lastNeed<=buf.length){buf.copy(this.lastChar,p,0,this.lastNeed);return this.lastChar.toString(this.encoding,0,this.lastTotal);}buf.copy(this.lastChar,p,0,buf.length);this.lastNeed-=buf.length;}function utf8Text(buf,i){var total=utf8CheckIncomplete(this,buf,i);if(!this.lastNeed)return buf.toString('utf8',i);this.lastTotal=total;var end=buf.length-(total-this.lastNeed);buf.copy(this.lastChar,0,end);return buf.toString('utf8',i,end);}function utf8End(buf){var r=buf&&buf.length?this.write(buf):'';if(this.lastNeed)return r+"\uFFFD";return r;}function utf16Text(buf,i){if((buf.length-i)%2===0){var r=buf.toString('utf16le',i);if(r){var c=r.charCodeAt(r.length-1);if(c>=0xD800&&c<=0xDBFF){this.lastNeed=2;this.lastTotal=4;this.lastChar[0]=buf[buf.length-2];this.lastChar[1]=buf[buf.length-1];return r.slice(0,-1);}}return r;}this.lastNeed=1;this.lastTotal=2;this.lastChar[0]=buf[buf.length-1];return buf.toString('utf16le',i,buf.length-1);}function utf16End(buf){var r=buf&&buf.length?this.write(buf):'';if(this.lastNeed){var end=this.lastTotal-this.lastNeed;return r+this.lastChar.toString('utf16le',0,end);}return r;}function base64Text(buf,i){var n=(buf.length-i)%3;if(n===0)return buf.toString('base64',i);this.lastNeed=3-n;this.lastTotal=3;if(n===1){this.lastChar[0]=buf[buf.length-1];}else{this.lastChar[0]=buf[buf.length-2];this.lastChar[1]=buf[buf.length-1];}return buf.toString('base64',i,buf.length-n);}function base64End(buf){var r=buf&&buf.length?this.write(buf):'';if(this.lastNeed)return r+this.lastChar.toString('base64',0,3-this.lastNeed);return r;}function simpleWrite(buf){return buf.toString(this.encoding);}function simpleEnd(buf){return buf&&buf.length?this.write(buf):'';}},{"safe-buffer":176}],145:[function(require,module,exports){(function(global){var FUNC_ERROR_TEXT='Expected a function';var HASH_UNDEFINED='__lodash_hash_undefined__';var INFINITY=1/0;var funcTag='[object Function]',genTag='[object GeneratorFunction]',symbolTag='[object Symbol]';var reIsDeepProp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,reIsPlainProp=/^\w*$/,reLeadingDot=/^\./,rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g;var reRegExpChar=/[\\^$.*+?()[\]{}|]/g;var reEscapeChar=/\\(\\)?/g;var reIsHostCtor=/^\[object .+?Constructor\]$/;var freeGlobal=(typeof global==="undefined"?"undefined":_typeof(global))=='object'&&global&&global.Object===Object&&global;var freeSelf=(typeof self==="undefined"?"undefined":_typeof(self))=='object'&&self&&self.Object===Object&&self;var root=freeGlobal||freeSelf||Function('return this')();function getValue(object,key){return object==null?undefined:object[key];}function isHostObject(value){var result=false;if(value!=null&&typeof value.toString!='function'){try{result=!!(value+'');}catch(e){}}return result;}var arrayProto=Array.prototype,funcProto=Function.prototype,objectProto=Object.prototype;var coreJsData=root['__core-js_shared__'];var maskSrcKey=function(){var uid=/[^.]+$/.exec(coreJsData&&coreJsData.keys&&coreJsData.keys.IE_PROTO||'');return uid?'Symbol(src)_1.'+uid:'';}();var funcToString=funcProto.toString;var hasOwnProperty=objectProto.hasOwnProperty;var objectToString=objectProto.toString;var reIsNative=RegExp('^'+funcToString.call(hasOwnProperty).replace(reRegExpChar,'\\$&').replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,'$1.*?')+'$');var _Symbol=root.Symbol,splice=arrayProto.splice;var Map=getNative(root,'Map'),nativeCreate=getNative(Object,'create');var symbolProto=_Symbol?_Symbol.prototype:undefined,symbolToString=symbolProto?symbolProto.toString:undefined;function Hash(entries){var index=-1,length=entries?entries.length:0;this.clear();while(++index<length){var entry=entries[index];this.set(entry[0],entry[1]);}}function hashClear(){this.__data__=nativeCreate?nativeCreate(null):{};}function hashDelete(key){return this.has(key)&&delete this.__data__[key];}function hashGet(key){var data=this.__data__;if(nativeCreate){var result=data[key];return result===HASH_UNDEFINED?undefined:result;}return hasOwnProperty.call(data,key)?data[key]:undefined;}function hashHas(key){var data=this.__data__;return nativeCreate?data[key]!==undefined:hasOwnProperty.call(data,key);}function hashSet(key,value){var data=this.__data__;data[key]=nativeCreate&&value===undefined?HASH_UNDEFINED:value;return this;}Hash.prototype.clear=hashClear;Hash.prototype['delete']=hashDelete;Hash.prototype.get=hashGet;Hash.prototype.has=hashHas;Hash.prototype.set=hashSet;function ListCache(entries){var index=-1,length=entries?entries.length:0;this.clear();while(++index<length){var entry=entries[index];this.set(entry[0],entry[1]);}}function listCacheClear(){this.__data__=[];}function listCacheDelete(key){var data=this.__data__,index=assocIndexOf(data,key);if(index<0){return false;}var lastIndex=data.length-1;if(index==lastIndex){data.pop();}else{splice.call(data,index,1);}return true;}function listCacheGet(key){var data=this.__data__,index=assocIndexOf(data,key);return index<0?undefined:data[index][1];}function listCacheHas(key){return assocIndexOf(this.__data__,key)>-1;}function listCacheSet(key,value){var data=this.__data__,index=assocIndexOf(data,key);if(index<0){data.push([key,value]);}else{data[index][1]=value;}return this;}ListCache.prototype.clear=listCacheClear;ListCache.prototype['delete']=listCacheDelete;ListCache.prototype.get=listCacheGet;ListCache.prototype.has=listCacheHas;ListCache.prototype.set=listCacheSet;function MapCache(entries){var index=-1,length=entries?entries.length:0;this.clear();while(++index<length){var entry=entries[index];this.set(entry[0],entry[1]);}}function mapCacheClear(){this.__data__={'hash':new Hash(),'map':new(Map||ListCache)(),'string':new Hash()};}function mapCacheDelete(key){return getMapData(this,key)['delete'](key);}function mapCacheGet(key){return getMapData(this,key).get(key);}function mapCacheHas(key){return getMapData(this,key).has(key);}function mapCacheSet(key,value){getMapData(this,key).set(key,value);return this;}MapCache.prototype.clear=mapCacheClear;MapCache.prototype['delete']=mapCacheDelete;MapCache.prototype.get=mapCacheGet;MapCache.prototype.has=mapCacheHas;MapCache.prototype.set=mapCacheSet;function assocIndexOf(array,key){var length=array.length;while(length--){if(eq(array[length][0],key)){return length;}}return-1;}function baseGet(object,path){path=isKey(path,object)?[path]:castPath(path);var index=0,length=path.length;while(object!=null&&index<length){object=object[toKey(path[index++])];}return index&&index==length?object:undefined;}function baseIsNative(value){if(!isObject(value)||isMasked(value)){return false;}var pattern=isFunction(value)||isHostObject(value)?reIsNative:reIsHostCtor;return pattern.test(toSource(value));}function baseToString(value){if(typeof value=='string'){return value;}if(isSymbol(value)){return symbolToString?symbolToString.call(value):'';}var result=value+'';return result=='0'&&1/value==-INFINITY?'-0':result;}function castPath(value){return isArray(value)?value:stringToPath(value);}function getMapData(map,key){var data=map.__data__;return isKeyable(key)?data[typeof key=='string'?'string':'hash']:data.map;}function getNative(object,key){var value=getValue(object,key);return baseIsNative(value)?value:undefined;}function isKey(value,object){if(isArray(value)){return false;}var type=typeof value==="undefined"?"undefined":_typeof(value);if(type=='number'||type=='symbol'||type=='boolean'||value==null||isSymbol(value)){return true;}return reIsPlainProp.test(value)||!reIsDeepProp.test(value)||object!=null&&value in Object(object);}function isKeyable(value){var type=typeof value==="undefined"?"undefined":_typeof(value);return type=='string'||type=='number'||type=='symbol'||type=='boolean'?value!=='__proto__':value===null;}function isMasked(func){return!!maskSrcKey&&maskSrcKey in func;}var stringToPath=memoize(function(string){string=toString(string);var result=[];if(reLeadingDot.test(string)){result.push('');}string.replace(rePropName,function(match,number,quote,string){result.push(quote?string.replace(reEscapeChar,'$1'):number||match);});return result;});function toKey(value){if(typeof value=='string'||isSymbol(value)){return value;}var result=value+'';return result=='0'&&1/value==-INFINITY?'-0':result;}function toSource(func){if(func!=null){try{return funcToString.call(func);}catch(e){}try{return func+'';}catch(e){}}return'';}function memoize(func,resolver){if(typeof func!='function'||resolver&&typeof resolver!='function'){throw new TypeError(FUNC_ERROR_TEXT);}var memoized=function memoized(){var args=arguments,key=resolver?resolver.apply(this,args):args[0],cache=memoized.cache;if(cache.has(key)){return cache.get(key);}var result=func.apply(this,args);memoized.cache=cache.set(key,result);return result;};memoized.cache=new(memoize.Cache||MapCache)();return memoized;}memoize.Cache=MapCache;function eq(value,other){return value===other||value!==value&&other!==other;}var isArray=Array.isArray;function isFunction(value){var tag=isObject(value)?objectToString.call(value):'';return tag==funcTag||tag==genTag;}function isObject(value){var type=typeof value==="undefined"?"undefined":_typeof(value);return!!value&&(type=='object'||type=='function');}function isObjectLike(value){return!!value&&(typeof value==="undefined"?"undefined":_typeof(value))=='object';}function isSymbol(value){return(typeof value==="undefined"?"undefined":_typeof(value))=='symbol'||isObjectLike(value)&&objectToString.call(value)==symbolTag;}function toString(value){return value==null?'':baseToString(value);}function get(object,path,defaultValue){var result=object==null?undefined:baseGet(object,path);return result===undefined?defaultValue:result;}module.exports=get;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],146:[function(require,module,exports){(function(global){/**
 * @license
 * Lodash (Custom Build) <https://lodash.com/>
 * Build: `lodash core -o ./dist/lodash.core.js`
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */;(function(){var undefined;var VERSION='4.17.15';var FUNC_ERROR_TEXT='Expected a function';var COMPARE_PARTIAL_FLAG=1,COMPARE_UNORDERED_FLAG=2;var WRAP_BIND_FLAG=1,WRAP_PARTIAL_FLAG=32;var INFINITY=1/0,MAX_SAFE_INTEGER=9007199254740991;var argsTag='[object Arguments]',arrayTag='[object Array]',asyncTag='[object AsyncFunction]',boolTag='[object Boolean]',dateTag='[object Date]',errorTag='[object Error]',funcTag='[object Function]',genTag='[object GeneratorFunction]',numberTag='[object Number]',objectTag='[object Object]',proxyTag='[object Proxy]',regexpTag='[object RegExp]',stringTag='[object String]';var reUnescapedHtml=/[&<>"']/g,reHasUnescapedHtml=RegExp(reUnescapedHtml.source);var reIsUint=/^(?:0|[1-9]\d*)$/;var htmlEscapes={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};var freeGlobal=(typeof global==="undefined"?"undefined":_typeof(global))=='object'&&global&&global.Object===Object&&global;var freeSelf=(typeof self==="undefined"?"undefined":_typeof(self))=='object'&&self&&self.Object===Object&&self;var root=freeGlobal||freeSelf||Function('return this')();var freeExports=(typeof exports==="undefined"?"undefined":_typeof(exports))=='object'&&exports&&!exports.nodeType&&exports;var freeModule=freeExports&&(typeof module==="undefined"?"undefined":_typeof(module))=='object'&&module&&!module.nodeType&&module;function arrayPush(array,values){array.push.apply(array,values);return array;}function baseFindIndex(array,predicate,fromIndex,fromRight){var length=array.length,index=fromIndex+(fromRight?1:-1);while(fromRight?index--:++index<length){if(predicate(array[index],index,array)){return index;}}return-1;}function baseProperty(key){return function(object){return object==null?undefined:object[key];};}function basePropertyOf(object){return function(key){return object==null?undefined:object[key];};}function baseReduce(collection,iteratee,accumulator,initAccum,eachFunc){eachFunc(collection,function(value,index,collection){accumulator=initAccum?(initAccum=false,value):iteratee(accumulator,value,index,collection);});return accumulator;}function baseValues(object,props){return baseMap(props,function(key){return object[key];});}var escapeHtmlChar=basePropertyOf(htmlEscapes);function overArg(func,transform){return function(arg){return func(transform(arg));};}var arrayProto=Array.prototype,objectProto=Object.prototype;var hasOwnProperty=objectProto.hasOwnProperty;var idCounter=0;var nativeObjectToString=objectProto.toString;var oldDash=root._;var objectCreate=Object.create,propertyIsEnumerable=objectProto.propertyIsEnumerable;var nativeIsFinite=root.isFinite,nativeKeys=overArg(Object.keys,Object),nativeMax=Math.max;function lodash(value){return value instanceof LodashWrapper?value:new LodashWrapper(value);}var baseCreate=function(){function object(){}return function(proto){if(!isObject(proto)){return{};}if(objectCreate){return objectCreate(proto);}object.prototype=proto;var result=new object();object.prototype=undefined;return result;};}();function LodashWrapper(value,chainAll){this.__wrapped__=value;this.__actions__=[];this.__chain__=!!chainAll;}LodashWrapper.prototype=baseCreate(lodash.prototype);LodashWrapper.prototype.constructor=LodashWrapper;function assignValue(object,key,value){var objValue=object[key];if(!(hasOwnProperty.call(object,key)&&eq(objValue,value))||value===undefined&&!(key in object)){baseAssignValue(object,key,value);}}function baseAssignValue(object,key,value){object[key]=value;}function baseDelay(func,wait,args){if(typeof func!='function'){throw new TypeError(FUNC_ERROR_TEXT);}return setTimeout(function(){func.apply(undefined,args);},wait);}var baseEach=createBaseEach(baseForOwn);function baseEvery(collection,predicate){var result=true;baseEach(collection,function(value,index,collection){result=!!predicate(value,index,collection);return result;});return result;}function baseExtremum(array,iteratee,comparator){var index=-1,length=array.length;while(++index<length){var value=array[index],current=iteratee(value);if(current!=null&&(computed===undefined?current===current&&!false:comparator(current,computed))){var computed=current,result=value;}}return result;}function baseFilter(collection,predicate){var result=[];baseEach(collection,function(value,index,collection){if(predicate(value,index,collection)){result.push(value);}});return result;}function baseFlatten(array,depth,predicate,isStrict,result){var index=-1,length=array.length;predicate||(predicate=isFlattenable);result||(result=[]);while(++index<length){var value=array[index];if(depth>0&&predicate(value)){if(depth>1){baseFlatten(value,depth-1,predicate,isStrict,result);}else{arrayPush(result,value);}}else if(!isStrict){result[result.length]=value;}}return result;}var baseFor=createBaseFor();function baseForOwn(object,iteratee){return object&&baseFor(object,iteratee,keys);}function baseFunctions(object,props){return baseFilter(props,function(key){return isFunction(object[key]);});}function baseGetTag(value){return objectToString(value);}function baseGt(value,other){return value>other;}var baseIsArguments=noop;function baseIsDate(value){return isObjectLike(value)&&baseGetTag(value)==dateTag;}function baseIsEqual(value,other,bitmask,customizer,stack){if(value===other){return true;}if(value==null||other==null||!isObjectLike(value)&&!isObjectLike(other)){return value!==value&&other!==other;}return baseIsEqualDeep(value,other,bitmask,customizer,baseIsEqual,stack);}function baseIsEqualDeep(object,other,bitmask,customizer,equalFunc,stack){var objIsArr=isArray(object),othIsArr=isArray(other),objTag=objIsArr?arrayTag:baseGetTag(object),othTag=othIsArr?arrayTag:baseGetTag(other);objTag=objTag==argsTag?objectTag:objTag;othTag=othTag==argsTag?objectTag:othTag;var objIsObj=objTag==objectTag,othIsObj=othTag==objectTag,isSameTag=objTag==othTag;stack||(stack=[]);var objStack=find(stack,function(entry){return entry[0]==object;});var othStack=find(stack,function(entry){return entry[0]==other;});if(objStack&&othStack){return objStack[1]==other;}stack.push([object,other]);stack.push([other,object]);if(isSameTag&&!objIsObj){var result=objIsArr?equalArrays(object,other,bitmask,customizer,equalFunc,stack):equalByTag(object,other,objTag,bitmask,customizer,equalFunc,stack);stack.pop();return result;}if(!(bitmask&COMPARE_PARTIAL_FLAG)){var objIsWrapped=objIsObj&&hasOwnProperty.call(object,'__wrapped__'),othIsWrapped=othIsObj&&hasOwnProperty.call(other,'__wrapped__');if(objIsWrapped||othIsWrapped){var objUnwrapped=objIsWrapped?object.value():object,othUnwrapped=othIsWrapped?other.value():other;var result=equalFunc(objUnwrapped,othUnwrapped,bitmask,customizer,stack);stack.pop();return result;}}if(!isSameTag){return false;}var result=equalObjects(object,other,bitmask,customizer,equalFunc,stack);stack.pop();return result;}function baseIsRegExp(value){return isObjectLike(value)&&baseGetTag(value)==regexpTag;}function baseIteratee(func){if(typeof func=='function'){return func;}if(func==null){return identity;}return((typeof func==="undefined"?"undefined":_typeof(func))=='object'?baseMatches:baseProperty)(func);}function baseLt(value,other){return value<other;}function baseMap(collection,iteratee){var index=-1,result=isArrayLike(collection)?Array(collection.length):[];baseEach(collection,function(value,key,collection){result[++index]=iteratee(value,key,collection);});return result;}function baseMatches(source){var props=nativeKeys(source);return function(object){var length=props.length;if(object==null){return!length;}object=Object(object);while(length--){var key=props[length];if(!(key in object&&baseIsEqual(source[key],object[key],COMPARE_PARTIAL_FLAG|COMPARE_UNORDERED_FLAG))){return false;}}return true;};}function basePick(object,props){object=Object(object);return reduce(props,function(result,key){if(key in object){result[key]=object[key];}return result;},{});}function baseRest(func,start){return setToString(overRest(func,start,identity),func+'');}function baseSlice(array,start,end){var index=-1,length=array.length;if(start<0){start=-start>length?0:length+start;}end=end>length?length:end;if(end<0){end+=length;}length=start>end?0:end-start>>>0;start>>>=0;var result=Array(length);while(++index<length){result[index]=array[index+start];}return result;}function copyArray(source){return baseSlice(source,0,source.length);}function baseSome(collection,predicate){var result;baseEach(collection,function(value,index,collection){result=predicate(value,index,collection);return!result;});return!!result;}function baseWrapperValue(value,actions){var result=value;return reduce(actions,function(result,action){return action.func.apply(action.thisArg,arrayPush([result],action.args));},result);}function compareAscending(value,other){if(value!==other){var valIsDefined=value!==undefined,valIsNull=value===null,valIsReflexive=value===value,valIsSymbol=false;var othIsDefined=other!==undefined,othIsNull=other===null,othIsReflexive=other===other,othIsSymbol=false;if(!othIsNull&&!othIsSymbol&&!valIsSymbol&&value>other||valIsSymbol&&othIsDefined&&othIsReflexive&&!othIsNull&&!othIsSymbol||valIsNull&&othIsDefined&&othIsReflexive||!valIsDefined&&othIsReflexive||!valIsReflexive){return 1;}if(!valIsNull&&!valIsSymbol&&!othIsSymbol&&value<other||othIsSymbol&&valIsDefined&&valIsReflexive&&!valIsNull&&!valIsSymbol||othIsNull&&valIsDefined&&valIsReflexive||!othIsDefined&&valIsReflexive||!othIsReflexive){return-1;}}return 0;}function copyObject(source,props,object,customizer){var isNew=!object;object||(object={});var index=-1,length=props.length;while(++index<length){var key=props[index];var newValue=customizer?customizer(object[key],source[key],key,object,source):undefined;if(newValue===undefined){newValue=source[key];}if(isNew){baseAssignValue(object,key,newValue);}else{assignValue(object,key,newValue);}}return object;}function createAssigner(assigner){return baseRest(function(object,sources){var index=-1,length=sources.length,customizer=length>1?sources[length-1]:undefined;customizer=assigner.length>3&&typeof customizer=='function'?(length--,customizer):undefined;object=Object(object);while(++index<length){var source=sources[index];if(source){assigner(object,source,index,customizer);}}return object;});}function createBaseEach(eachFunc,fromRight){return function(collection,iteratee){if(collection==null){return collection;}if(!isArrayLike(collection)){return eachFunc(collection,iteratee);}var length=collection.length,index=fromRight?length:-1,iterable=Object(collection);while(fromRight?index--:++index<length){if(iteratee(iterable[index],index,iterable)===false){break;}}return collection;};}function createBaseFor(fromRight){return function(object,iteratee,keysFunc){var index=-1,iterable=Object(object),props=keysFunc(object),length=props.length;while(length--){var key=props[fromRight?length:++index];if(iteratee(iterable[key],key,iterable)===false){break;}}return object;};}function createCtor(Ctor){return function(){var args=arguments;var thisBinding=baseCreate(Ctor.prototype),result=Ctor.apply(thisBinding,args);return isObject(result)?result:thisBinding;};}function createFind(findIndexFunc){return function(collection,predicate,fromIndex){var iterable=Object(collection);if(!isArrayLike(collection)){var iteratee=baseIteratee(predicate,3);collection=keys(collection);predicate=function predicate(key){return iteratee(iterable[key],key,iterable);};}var index=findIndexFunc(collection,predicate,fromIndex);return index>-1?iterable[iteratee?collection[index]:index]:undefined;};}function createPartial(func,bitmask,thisArg,partials){if(typeof func!='function'){throw new TypeError(FUNC_ERROR_TEXT);}var isBind=bitmask&WRAP_BIND_FLAG,Ctor=createCtor(func);function wrapper(){var argsIndex=-1,argsLength=arguments.length,leftIndex=-1,leftLength=partials.length,args=Array(leftLength+argsLength),fn=this&&this!==root&&this instanceof wrapper?Ctor:func;while(++leftIndex<leftLength){args[leftIndex]=partials[leftIndex];}while(argsLength--){args[leftIndex++]=arguments[++argsIndex];}return fn.apply(isBind?thisArg:this,args);}return wrapper;}function equalArrays(array,other,bitmask,customizer,equalFunc,stack){var isPartial=bitmask&COMPARE_PARTIAL_FLAG,arrLength=array.length,othLength=other.length;if(arrLength!=othLength&&!(isPartial&&othLength>arrLength)){return false;}var index=-1,result=true,seen=bitmask&COMPARE_UNORDERED_FLAG?[]:undefined;while(++index<arrLength){var arrValue=array[index],othValue=other[index];var compared;if(compared!==undefined){if(compared){continue;}result=false;break;}if(seen){if(!baseSome(other,function(othValue,othIndex){if(!indexOf(seen,othIndex)&&(arrValue===othValue||equalFunc(arrValue,othValue,bitmask,customizer,stack))){return seen.push(othIndex);}})){result=false;break;}}else if(!(arrValue===othValue||equalFunc(arrValue,othValue,bitmask,customizer,stack))){result=false;break;}}return result;}function equalByTag(object,other,tag,bitmask,customizer,equalFunc,stack){switch(tag){case boolTag:case dateTag:case numberTag:return eq(+object,+other);case errorTag:return object.name==other.name&&object.message==other.message;case regexpTag:case stringTag:return object==other+'';}return false;}function equalObjects(object,other,bitmask,customizer,equalFunc,stack){var isPartial=bitmask&COMPARE_PARTIAL_FLAG,objProps=keys(object),objLength=objProps.length,othProps=keys(other),othLength=othProps.length;if(objLength!=othLength&&!isPartial){return false;}var index=objLength;while(index--){var key=objProps[index];if(!(isPartial?key in other:hasOwnProperty.call(other,key))){return false;}}var result=true;var skipCtor=isPartial;while(++index<objLength){key=objProps[index];var objValue=object[key],othValue=other[key];var compared;if(!(compared===undefined?objValue===othValue||equalFunc(objValue,othValue,bitmask,customizer,stack):compared)){result=false;break;}skipCtor||(skipCtor=key=='constructor');}if(result&&!skipCtor){var objCtor=object.constructor,othCtor=other.constructor;if(objCtor!=othCtor&&'constructor'in object&&'constructor'in other&&!(typeof objCtor=='function'&&objCtor instanceof objCtor&&typeof othCtor=='function'&&othCtor instanceof othCtor)){result=false;}}return result;}function flatRest(func){return setToString(overRest(func,undefined,flatten),func+'');}function isFlattenable(value){return isArray(value)||isArguments(value);}function isIndex(value,length){var type=typeof value==="undefined"?"undefined":_typeof(value);length=length==null?MAX_SAFE_INTEGER:length;return!!length&&(type=='number'||type!='symbol'&&reIsUint.test(value))&&value>-1&&value%1==0&&value<length;}function isIterateeCall(value,index,object){if(!isObject(object)){return false;}var type=typeof index==="undefined"?"undefined":_typeof(index);if(type=='number'?isArrayLike(object)&&isIndex(index,object.length):type=='string'&&index in object){return eq(object[index],value);}return false;}function nativeKeysIn(object){var result=[];if(object!=null){for(var key in Object(object)){result.push(key);}}return result;}function objectToString(value){return nativeObjectToString.call(value);}function overRest(func,start,transform){start=nativeMax(start===undefined?func.length-1:start,0);return function(){var args=arguments,index=-1,length=nativeMax(args.length-start,0),array=Array(length);while(++index<length){array[index]=args[start+index];}index=-1;var otherArgs=Array(start+1);while(++index<start){otherArgs[index]=args[index];}otherArgs[start]=transform(array);return func.apply(this,otherArgs);};}var setToString=identity;function compact(array){return baseFilter(array,Boolean);}function concat(){var length=arguments.length;if(!length){return[];}var args=Array(length-1),array=arguments[0],index=length;while(index--){args[index-1]=arguments[index];}return arrayPush(isArray(array)?copyArray(array):[array],baseFlatten(args,1));}function findIndex(array,predicate,fromIndex){var length=array==null?0:array.length;if(!length){return-1;}var index=fromIndex==null?0:toInteger(fromIndex);if(index<0){index=nativeMax(length+index,0);}return baseFindIndex(array,baseIteratee(predicate,3),index);}function flatten(array){var length=array==null?0:array.length;return length?baseFlatten(array,1):[];}function flattenDeep(array){var length=array==null?0:array.length;return length?baseFlatten(array,INFINITY):[];}function head(array){return array&&array.length?array[0]:undefined;}function indexOf(array,value,fromIndex){var length=array==null?0:array.length;if(typeof fromIndex=='number'){fromIndex=fromIndex<0?nativeMax(length+fromIndex,0):fromIndex;}else{fromIndex=0;}var index=(fromIndex||0)-1,isReflexive=value===value;while(++index<length){var other=array[index];if(isReflexive?other===value:other!==other){return index;}}return-1;}function last(array){var length=array==null?0:array.length;return length?array[length-1]:undefined;}function slice(array,start,end){var length=array==null?0:array.length;start=start==null?0:+start;end=end===undefined?length:+end;return length?baseSlice(array,start,end):[];}function chain(value){var result=lodash(value);result.__chain__=true;return result;}function tap(value,interceptor){interceptor(value);return value;}function thru(value,interceptor){return interceptor(value);}function wrapperChain(){return chain(this);}function wrapperValue(){return baseWrapperValue(this.__wrapped__,this.__actions__);}function every(collection,predicate,guard){predicate=guard?undefined:predicate;return baseEvery(collection,baseIteratee(predicate));}function filter(collection,predicate){return baseFilter(collection,baseIteratee(predicate));}var find=createFind(findIndex);function forEach(collection,iteratee){return baseEach(collection,baseIteratee(iteratee));}function map(collection,iteratee){return baseMap(collection,baseIteratee(iteratee));}function reduce(collection,iteratee,accumulator){return baseReduce(collection,baseIteratee(iteratee),accumulator,arguments.length<3,baseEach);}function size(collection){if(collection==null){return 0;}collection=isArrayLike(collection)?collection:nativeKeys(collection);return collection.length;}function some(collection,predicate,guard){predicate=guard?undefined:predicate;return baseSome(collection,baseIteratee(predicate));}function sortBy(collection,iteratee){var index=0;iteratee=baseIteratee(iteratee);return baseMap(baseMap(collection,function(value,key,collection){return{'value':value,'index':index++,'criteria':iteratee(value,key,collection)};}).sort(function(object,other){return compareAscending(object.criteria,other.criteria)||object.index-other.index;}),baseProperty('value'));}function before(n,func){var result;if(typeof func!='function'){throw new TypeError(FUNC_ERROR_TEXT);}n=toInteger(n);return function(){if(--n>0){result=func.apply(this,arguments);}if(n<=1){func=undefined;}return result;};}var bind=baseRest(function(func,thisArg,partials){return createPartial(func,WRAP_BIND_FLAG|WRAP_PARTIAL_FLAG,thisArg,partials);});var defer=baseRest(function(func,args){return baseDelay(func,1,args);});var delay=baseRest(function(func,wait,args){return baseDelay(func,toNumber(wait)||0,args);});function negate(predicate){if(typeof predicate!='function'){throw new TypeError(FUNC_ERROR_TEXT);}return function(){var args=arguments;return!predicate.apply(this,args);};}function once(func){return before(2,func);}function clone(value){if(!isObject(value)){return value;}return isArray(value)?copyArray(value):copyObject(value,nativeKeys(value));}function eq(value,other){return value===other||value!==value&&other!==other;}var isArguments=baseIsArguments(function(){return arguments;}())?baseIsArguments:function(value){return isObjectLike(value)&&hasOwnProperty.call(value,'callee')&&!propertyIsEnumerable.call(value,'callee');};var isArray=Array.isArray;function isArrayLike(value){return value!=null&&isLength(value.length)&&!isFunction(value);}function isBoolean(value){return value===true||value===false||isObjectLike(value)&&baseGetTag(value)==boolTag;}var isDate=baseIsDate;function isEmpty(value){if(isArrayLike(value)&&(isArray(value)||isString(value)||isFunction(value.splice)||isArguments(value))){return!value.length;}return!nativeKeys(value).length;}function isEqual(value,other){return baseIsEqual(value,other);}function isFinite(value){return typeof value=='number'&&nativeIsFinite(value);}function isFunction(value){if(!isObject(value)){return false;}var tag=baseGetTag(value);return tag==funcTag||tag==genTag||tag==asyncTag||tag==proxyTag;}function isLength(value){return typeof value=='number'&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER;}function isObject(value){var type=typeof value==="undefined"?"undefined":_typeof(value);return value!=null&&(type=='object'||type=='function');}function isObjectLike(value){return value!=null&&(typeof value==="undefined"?"undefined":_typeof(value))=='object';}function isNaN(value){return isNumber(value)&&value!=+value;}function isNull(value){return value===null;}function isNumber(value){return typeof value=='number'||isObjectLike(value)&&baseGetTag(value)==numberTag;}var isRegExp=baseIsRegExp;function isString(value){return typeof value=='string'||!isArray(value)&&isObjectLike(value)&&baseGetTag(value)==stringTag;}function isUndefined(value){return value===undefined;}function toArray(value){if(!isArrayLike(value)){return values(value);}return value.length?copyArray(value):[];}var toInteger=Number;var toNumber=Number;function toString(value){if(typeof value=='string'){return value;}return value==null?'':value+'';}var assign=createAssigner(function(object,source){copyObject(source,nativeKeys(source),object);});var assignIn=createAssigner(function(object,source){copyObject(source,nativeKeysIn(source),object);});function create(prototype,properties){var result=baseCreate(prototype);return properties==null?result:assign(result,properties);}var defaults=baseRest(function(object,sources){object=Object(object);var index=-1;var length=sources.length;var guard=length>2?sources[2]:undefined;if(guard&&isIterateeCall(sources[0],sources[1],guard)){length=1;}while(++index<length){var source=sources[index];var props=keysIn(source);var propsIndex=-1;var propsLength=props.length;while(++propsIndex<propsLength){var key=props[propsIndex];var value=object[key];if(value===undefined||eq(value,objectProto[key])&&!hasOwnProperty.call(object,key)){object[key]=source[key];}}}return object;});function has(object,path){return object!=null&&hasOwnProperty.call(object,path);}var keys=nativeKeys;var keysIn=nativeKeysIn;var pick=flatRest(function(object,paths){return object==null?{}:basePick(object,paths);});function result(object,path,defaultValue){var value=object==null?undefined:object[path];if(value===undefined){value=defaultValue;}return isFunction(value)?value.call(object):value;}function values(object){return object==null?[]:baseValues(object,keys(object));}function escape(string){string=toString(string);return string&&reHasUnescapedHtml.test(string)?string.replace(reUnescapedHtml,escapeHtmlChar):string;}function identity(value){return value;}var iteratee=baseIteratee;function matches(source){return baseMatches(assign({},source));}function mixin(object,source,options){var props=keys(source),methodNames=baseFunctions(source,props);if(options==null&&!(isObject(source)&&(methodNames.length||!props.length))){options=source;source=object;object=this;methodNames=baseFunctions(source,keys(source));}var chain=!(isObject(options)&&'chain'in options)||!!options.chain,isFunc=isFunction(object);baseEach(methodNames,function(methodName){var func=source[methodName];object[methodName]=func;if(isFunc){object.prototype[methodName]=function(){var chainAll=this.__chain__;if(chain||chainAll){var result=object(this.__wrapped__),actions=result.__actions__=copyArray(this.__actions__);actions.push({'func':func,'args':arguments,'thisArg':object});result.__chain__=chainAll;return result;}return func.apply(object,arrayPush([this.value()],arguments));};}});return object;}function noConflict(){if(root._===this){root._=oldDash;}return this;}function noop(){}function uniqueId(prefix){var id=++idCounter;return toString(prefix)+id;}function max(array){return array&&array.length?baseExtremum(array,identity,baseGt):undefined;}function min(array){return array&&array.length?baseExtremum(array,identity,baseLt):undefined;}lodash.assignIn=assignIn;lodash.before=before;lodash.bind=bind;lodash.chain=chain;lodash.compact=compact;lodash.concat=concat;lodash.create=create;lodash.defaults=defaults;lodash.defer=defer;lodash.delay=delay;lodash.filter=filter;lodash.flatten=flatten;lodash.flattenDeep=flattenDeep;lodash.iteratee=iteratee;lodash.keys=keys;lodash.map=map;lodash.matches=matches;lodash.mixin=mixin;lodash.negate=negate;lodash.once=once;lodash.pick=pick;lodash.slice=slice;lodash.sortBy=sortBy;lodash.tap=tap;lodash.thru=thru;lodash.toArray=toArray;lodash.values=values;lodash.extend=assignIn;mixin(lodash,lodash);lodash.clone=clone;lodash.escape=escape;lodash.every=every;lodash.find=find;lodash.forEach=forEach;lodash.has=has;lodash.head=head;lodash.identity=identity;lodash.indexOf=indexOf;lodash.isArguments=isArguments;lodash.isArray=isArray;lodash.isBoolean=isBoolean;lodash.isDate=isDate;lodash.isEmpty=isEmpty;lodash.isEqual=isEqual;lodash.isFinite=isFinite;lodash.isFunction=isFunction;lodash.isNaN=isNaN;lodash.isNull=isNull;lodash.isNumber=isNumber;lodash.isObject=isObject;lodash.isRegExp=isRegExp;lodash.isString=isString;lodash.isUndefined=isUndefined;lodash.last=last;lodash.max=max;lodash.min=min;lodash.noConflict=noConflict;lodash.noop=noop;lodash.reduce=reduce;lodash.result=result;lodash.size=size;lodash.some=some;lodash.uniqueId=uniqueId;lodash.each=forEach;lodash.first=head;mixin(lodash,function(){var source={};baseForOwn(lodash,function(func,methodName){if(!hasOwnProperty.call(lodash.prototype,methodName)){source[methodName]=func;}});return source;}(),{'chain':false});lodash.VERSION=VERSION;baseEach(['pop','join','replace','reverse','split','push','shift','sort','splice','unshift'],function(methodName){var func=(/^(?:replace|split)$/.test(methodName)?String.prototype:arrayProto)[methodName],chainName=/^(?:push|sort|unshift)$/.test(methodName)?'tap':'thru',retUnwrapped=/^(?:pop|join|replace|shift)$/.test(methodName);lodash.prototype[methodName]=function(){var args=arguments;if(retUnwrapped&&!this.__chain__){var value=this.value();return func.apply(isArray(value)?value:[],args);}return this[chainName](function(value){return func.apply(isArray(value)?value:[],args);});};});lodash.prototype.toJSON=lodash.prototype.valueOf=lodash.prototype.value=wrapperValue;if(typeof define=='function'&&_typeof(define.amd)=='object'&&define.amd){root._=lodash;define(function(){return lodash;});}else if(freeModule){(freeModule.exports=lodash)._=lodash;freeExports._=lodash;}else{root._=lodash;}}).call(this);}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],147:[function(require,module,exports){"use strict";var layouts=require('../layouts'),consoleLog=console.log.bind(console);function consoleAppender(layout,timezoneOffset){layout=layout||layouts.colouredLayout;return function(loggingEvent){consoleLog(layout(loggingEvent,timezoneOffset));};}function configure(config){var layout;if(config.layout){layout=layouts.layout(config.layout.type,config.layout);}return consoleAppender(layout,config.timezoneOffset);}exports.appender=consoleAppender;exports.configure=configure;},{"../layouts":150}],148:[function(require,module,exports){"use strict";var levels=require("./levels");var DEFAULT_FORMAT=':remote-addr - -'+' ":method :url HTTP/:http-version"'+' :status :content-length ":referrer"'+' ":user-agent"';function getLogger(logger4js,options){if('object'==(typeof options==="undefined"?"undefined":_typeof(options))){options=options||{};}else if(options){options={format:options};}else{options={};}var thislogger=logger4js,level=levels.toLevel(options.level,levels.INFO),fmt=options.format||DEFAULT_FORMAT,nolog=options.nolog?createNoLogCondition(options.nolog):null;return function(req,res,next){if(req._logging)return next();if(nolog&&nolog.test(req.originalUrl))return next();if(thislogger.isLevelEnabled(level)||options.level==='auto'){var start=new Date(),statusCode,writeHead=res.writeHead,url=req.originalUrl;req._logging=true;res.writeHead=function(code,headers){res.writeHead=writeHead;res.writeHead(code,headers);res.__statusCode=statusCode=code;res.__headers=headers||{};if(options.level==='auto'){level=levels.INFO;if(code>=300)level=levels.WARN;if(code>=400)level=levels.ERROR;}else{level=levels.toLevel(options.level,levels.INFO);}};res.on('finish',function(){res.responseTime=new Date()-start;if(res.statusCode&&options.level==='auto'){level=levels.INFO;if(res.statusCode>=300)level=levels.WARN;if(res.statusCode>=400)level=levels.ERROR;}if(thislogger.isLevelEnabled(level)){var combined_tokens=assemble_tokens(req,res,options.tokens||[]);if(typeof fmt==='function'){var line=fmt(req,res,function(str){return format(str,combined_tokens);});if(line)thislogger.log(level,line);}else{thislogger.log(level,format(fmt,combined_tokens));}}});}next();};}function assemble_tokens(req,res,custom_tokens){var array_unique_tokens=function array_unique_tokens(array){var a=array.concat();for(var i=0;i<a.length;++i){for(var j=i+1;j<a.length;++j){if(a[i].token==a[j].token){a.splice(j--,1);}}}return a;};var default_tokens=[];default_tokens.push({token:':url',replacement:getUrl(req)});default_tokens.push({token:':protocol',replacement:req.protocol});default_tokens.push({token:':hostname',replacement:req.hostname});default_tokens.push({token:':method',replacement:req.method});default_tokens.push({token:':status',replacement:res.__statusCode||res.statusCode});default_tokens.push({token:':response-time',replacement:res.responseTime});default_tokens.push({token:':date',replacement:new Date().toUTCString()});default_tokens.push({token:':referrer',replacement:req.headers.referer||req.headers.referrer||''});default_tokens.push({token:':http-version',replacement:req.httpVersionMajor+'.'+req.httpVersionMinor});default_tokens.push({token:':remote-addr',replacement:req.headers['x-forwarded-for']||req.ip||req._remoteAddress||req.socket&&(req.socket.remoteAddress||req.socket.socket&&req.socket.socket.remoteAddress)});default_tokens.push({token:':user-agent',replacement:req.headers['user-agent']});default_tokens.push({token:':content-length',replacement:res._headers&&res._headers['content-length']||res.__headers&&res.__headers['Content-Length']||'-'});default_tokens.push({token:/:req\[([^\]]+)\]/g,replacement:function replacement(_,field){return req.headers[field.toLowerCase()];}});default_tokens.push({token:/:res\[([^\]]+)\]/g,replacement:function replacement(_,field){return res._headers?res._headers[field.toLowerCase()]||res.__headers[field]:res.__headers&&res.__headers[field];}});return array_unique_tokens(custom_tokens.concat(default_tokens));}function getUrl(req){return req.originalUrl||req.url;}function format(str,tokens){for(var i=0;i<tokens.length;i++){str=str.replace(tokens[i].token,tokens[i].replacement);}return str;}function createNoLogCondition(nolog){var regexp=null;if(nolog){if(nolog instanceof RegExp){regexp=nolog;}if(typeof nolog==='string'){regexp=new RegExp(nolog);}if(Array.isArray(nolog)){var regexpsAsStrings=nolog.map(function convertToStrings(o){return o.source?o.source:o;});regexp=new RegExp(regexpsAsStrings.join('|'));}}return regexp;}exports.connectLogger=getLogger;},{"./levels":151}],149:[function(require,module,exports){"use strict";exports.ISO8601_FORMAT="yyyy-MM-dd hh:mm:ss.SSS";exports.ISO8601_WITH_TZ_OFFSET_FORMAT="yyyy-MM-ddThh:mm:ssO";exports.DATETIME_FORMAT="dd MM yyyy hh:mm:ss.SSS";exports.ABSOLUTETIME_FORMAT="hh:mm:ss.SSS";function padWithZeros(vNumber,width){var numAsString=vNumber+"";while(numAsString.length<width){numAsString="0"+numAsString;}return numAsString;}function addZero(vNumber){return padWithZeros(vNumber,2);}function offset(timezoneOffset){var os=Math.abs(timezoneOffset);var h=String(Math.floor(os/60));var m=String(os%60);if(h.length==1){h="0"+h;}if(m.length==1){m="0"+m;}return timezoneOffset<0?"+"+h+m:"-"+h+m;}exports.asString=function(date,timezoneOffset){var format=exports.ISO8601_FORMAT;if(typeof date==="string"){format=arguments[0];date=arguments[1];timezoneOffset=arguments[2];}if(timezoneOffset===undefined){timezoneOffset=date.getTimezoneOffset();}date.setUTCMinutes(date.getUTCMinutes()-timezoneOffset);var vDay=addZero(date.getUTCDate());var vMonth=addZero(date.getUTCMonth()+1);var vYearLong=addZero(date.getUTCFullYear());var vYearShort=addZero(date.getUTCFullYear().toString().substring(2,4));var vYear=format.indexOf("yyyy")>-1?vYearLong:vYearShort;var vHour=addZero(date.getUTCHours());var vMinute=addZero(date.getUTCMinutes());var vSecond=addZero(date.getUTCSeconds());var vMillisecond=padWithZeros(date.getUTCMilliseconds(),3);var vTimeZone=offset(timezoneOffset);date.setUTCMinutes(date.getUTCMinutes()+timezoneOffset);var formatted=format.replace(/dd/g,vDay).replace(/MM/g,vMonth).replace(/y{1,4}/g,vYear).replace(/hh/g,vHour).replace(/mm/g,vMinute).replace(/ss/g,vSecond).replace(/SSS/g,vMillisecond).replace(/O/g,vTimeZone);return formatted;};},{}],150:[function(require,module,exports){(function(process){"use strict";var dateFormat=require('./date_format'),os=require('os'),eol=os.EOL||'\n',util=require('util'),semver=require('semver'),replacementRegExp=/%[sdj]/g,layoutMakers={"messagePassThrough":function messagePassThrough(){return messagePassThroughLayout;},"basic":function basic(){return basicLayout;},"colored":function colored(){return colouredLayout;},"coloured":function coloured(){return colouredLayout;},"pattern":function pattern(config){return patternLayout(config&&config.pattern,config&&config.tokens);},"dummy":function dummy(){return dummyLayout;}},colours={ALL:"grey",TRACE:"blue",DEBUG:"cyan",INFO:"green",WARN:"yellow",ERROR:"red",FATAL:"magenta",OFF:"grey"};function wrapErrorsWithInspect(items){return items.map(function(item){if(item instanceof Error&&item.stack){return{inspect:function inspect(){if(semver.satisfies(process.version,'>=6')){return util.format(item);}else{return util.format(item)+'\n'+item.stack;}}};}else{return item;}});}function formatLogData(logData){var data=Array.isArray(logData)?logData:Array.prototype.slice.call(arguments);return util.format.apply(util,wrapErrorsWithInspect(data));}var styles={'bold':[1,22],'italic':[3,23],'underline':[4,24],'inverse':[7,27],'white':[37,39],'grey':[90,39],'black':[90,39],'blue':[34,39],'cyan':[36,39],'green':[32,39],'magenta':[35,39],'red':[31,39],'yellow':[33,39]};function colorizeStart(style){return style?'\x1B['+styles[style][0]+'m':'';}function colorizeEnd(style){return style?'\x1B['+styles[style][1]+'m':'';}function colorize(str,style){return colorizeStart(style)+str+colorizeEnd(style);}function timestampLevelAndCategory(loggingEvent,colour,timezoneOffest){var output=colorize(formatLogData('[%s] [%s] %s - ',dateFormat.asString(loggingEvent.startTime,timezoneOffest),loggingEvent.level,loggingEvent.categoryName),colour);return output;}function basicLayout(loggingEvent,timezoneOffset){return timestampLevelAndCategory(loggingEvent,undefined,timezoneOffset)+formatLogData(loggingEvent.data);}function colouredLayout(loggingEvent,timezoneOffset){return timestampLevelAndCategory(loggingEvent,colours[loggingEvent.level.toString()],timezoneOffset)+formatLogData(loggingEvent.data);}function messagePassThroughLayout(loggingEvent){return formatLogData(loggingEvent.data);}function dummyLayout(loggingEvent){return loggingEvent.data[0];}function patternLayout(pattern,tokens,timezoneOffset){var TTCC_CONVERSION_PATTERN="%r %p %c - %m%n";var regex=/%(-?[0-9]+)?(\.?[0-9]+)?([\[\]cdhmnprzxy%])(\{([^\}]+)\})?|([^%]+)/;pattern=pattern||TTCC_CONVERSION_PATTERN;function categoryName(loggingEvent,specifier){var loggerName=loggingEvent.categoryName;if(specifier){var precision=parseInt(specifier,10);var loggerNameBits=loggerName.split(".");if(precision<loggerNameBits.length){loggerName=loggerNameBits.slice(loggerNameBits.length-precision).join(".");}}return loggerName;}function formatAsDate(loggingEvent,specifier){var format=dateFormat.ISO8601_FORMAT;if(specifier){format=specifier;if(format=="ISO8601"){format=dateFormat.ISO8601_FORMAT;}else if(format=="ISO8601_WITH_TZ_OFFSET"){format=dateFormat.ISO8601_WITH_TZ_OFFSET_FORMAT;}else if(format=="ABSOLUTE"){format=dateFormat.ABSOLUTETIME_FORMAT;}else if(format=="DATE"){format=dateFormat.DATETIME_FORMAT;}}return dateFormat.asString(format,loggingEvent.startTime,timezoneOffset);}function hostname(){return os.hostname().toString();}function formatMessage(loggingEvent){return formatLogData(loggingEvent.data);}function endOfLine(){return eol;}function logLevel(loggingEvent){return loggingEvent.level.toString();}function startTime(loggingEvent){return dateFormat.asString('hh:mm:ss',loggingEvent.startTime,timezoneOffset);}function startColour(loggingEvent){return colorizeStart(colours[loggingEvent.level.toString()]);}function endColour(loggingEvent){return colorizeEnd(colours[loggingEvent.level.toString()]);}function percent(){return'%';}function pid(loggingEvent){if(loggingEvent&&loggingEvent.pid){return loggingEvent.pid;}else{return process.pid;}}function clusterInfo(loggingEvent,specifier){if(loggingEvent.cluster&&specifier){return specifier.replace('%m',loggingEvent.cluster.master).replace('%w',loggingEvent.cluster.worker).replace('%i',loggingEvent.cluster.workerId);}else if(loggingEvent.cluster){return loggingEvent.cluster.worker+'@'+loggingEvent.cluster.master;}else{return pid();}}function userDefined(loggingEvent,specifier){if(typeof tokens[specifier]!=='undefined'){if(typeof tokens[specifier]==='function'){return tokens[specifier](loggingEvent);}else{return tokens[specifier];}}return null;}var replacers={'c':categoryName,'d':formatAsDate,'h':hostname,'m':formatMessage,'n':endOfLine,'p':logLevel,'r':startTime,'[':startColour,']':endColour,'y':clusterInfo,'z':pid,'%':percent,'x':userDefined};function replaceToken(conversionCharacter,loggingEvent,specifier){return replacers[conversionCharacter](loggingEvent,specifier);}function truncate(truncation,toTruncate){var len;if(truncation){len=parseInt(truncation.substr(1),10);return toTruncate.substring(0,len);}return toTruncate;}function pad(padding,toPad){var len;if(padding){if(padding.charAt(0)=="-"){len=parseInt(padding.substr(1),10);while(toPad.length<len){toPad+=" ";}}else{len=parseInt(padding,10);while(toPad.length<len){toPad=" "+toPad;}}}return toPad;}function truncateAndPad(toTruncAndPad,truncation,padding){var replacement=toTruncAndPad;replacement=truncate(truncation,replacement);replacement=pad(padding,replacement);return replacement;}return function(loggingEvent){var formattedString="";var result;var searchString=pattern;while(result=regex.exec(searchString)){var matchedString=result[0];var padding=result[1];var truncation=result[2];var conversionCharacter=result[3];var specifier=result[5];var text=result[6];if(text){formattedString+=""+text;}else{var replacement=replaceToken(conversionCharacter,loggingEvent,specifier);formattedString+=truncateAndPad(replacement,truncation,padding);}searchString=searchString.substr(result.index+result[0].length);}return formattedString;};}module.exports={basicLayout:basicLayout,messagePassThroughLayout:messagePassThroughLayout,patternLayout:patternLayout,colouredLayout:colouredLayout,coloredLayout:colouredLayout,dummyLayout:dummyLayout,addLayout:function addLayout(name,serializerGenerator){layoutMakers[name]=serializerGenerator;},layout:function layout(name,config){return layoutMakers[name]&&layoutMakers[name](config);}};}).call(this,require('_process'));},{"./date_format":149,"_process":170,"os":47,"semver":154,"util":208}],151:[function(require,module,exports){"use strict";function Level(level,levelStr){this.level=level;this.levelStr=levelStr;}function toLevel(sArg,defaultLevel){if(!sArg){return defaultLevel;}if(sArg instanceof Level){module.exports[sArg.toString()]=sArg;return sArg;}if(typeof sArg==="string"){return module.exports[sArg.toUpperCase()]||defaultLevel;}return toLevel(sArg.toString());}Level.prototype.toString=function(){return this.levelStr;};Level.prototype.isLessThanOrEqualTo=function(otherLevel){if(typeof otherLevel==="string"){otherLevel=toLevel(otherLevel);}return this.level<=otherLevel.level;};Level.prototype.isGreaterThanOrEqualTo=function(otherLevel){if(typeof otherLevel==="string"){otherLevel=toLevel(otherLevel);}return this.level>=otherLevel.level;};Level.prototype.isEqualTo=function(otherLevel){if(typeof otherLevel==="string"){otherLevel=toLevel(otherLevel);}return this.level===otherLevel.level;};module.exports={ALL:new Level(Number.MIN_VALUE,"ALL"),TRACE:new Level(5000,"TRACE"),DEBUG:new Level(10000,"DEBUG"),INFO:new Level(20000,"INFO"),WARN:new Level(30000,"WARN"),ERROR:new Level(40000,"ERROR"),FATAL:new Level(50000,"FATAL"),MARK:new Level(9007199254740992,"MARK"),OFF:new Level(Number.MAX_VALUE,"OFF"),toLevel:toLevel,Level:Level};},{}],152:[function(require,module,exports){(function(process){"use strict";var events=require('events'),fs=require('fs'),path=require('path'),util=require('util'),layouts=require('./layouts'),levels=require('./levels'),loggerModule=require('./logger'),LoggingEvent=loggerModule.LoggingEvent,Logger=loggerModule.Logger,ALL_CATEGORIES='[all]',appenders={},loggers={},appenderMakers={},appenderShutdowns={},defaultConfig={appenders:[{type:"console"}],replaceConsole:false};require('./appenders/console');function hasLogger(logger){return loggers.hasOwnProperty(logger);}levels.forName=function(levelStr,levelVal){var level;if(typeof levelStr==="string"&&typeof levelVal==="number"){var levelUpper=levelStr.toUpperCase();level=new levels.Level(levelVal,levelUpper);loggerModule.addLevelMethods(level);}return level;};levels.getLevel=function(levelStr){var level;if(typeof levelStr==="string"){var levelUpper=levelStr.toUpperCase();level=levels.toLevel(levelStr);}return level;};function getBufferedLogger(categoryName){var base_logger=getLogger(categoryName);var logger={};logger.temp=[];logger.target=base_logger;logger.flush=function(){for(var i=0;i<logger.temp.length;i++){var log=logger.temp[i];logger.target[log.level](log.message);delete logger.temp[i];}};logger.trace=function(message){logger.temp.push({level:'trace',message:message});};logger.debug=function(message){logger.temp.push({level:'debug',message:message});};logger.info=function(message){logger.temp.push({level:'info',message:message});};logger.warn=function(message){logger.temp.push({level:'warn',message:message});};logger.error=function(message){logger.temp.push({level:'error',message:message});};logger.fatal=function(message){logger.temp.push({level:'fatal',message:message});};return logger;}function normalizeCategory(category){return category+'.';}function doesLevelEntryContainsLogger(levelCategory,loggerCategory){var normalizedLevelCategory=normalizeCategory(levelCategory);var normalizedLoggerCategory=normalizeCategory(loggerCategory);return normalizedLoggerCategory.substring(0,normalizedLevelCategory.length)==normalizedLevelCategory;}function doesAppenderContainsLogger(appenderCategory,loggerCategory){var normalizedAppenderCategory=normalizeCategory(appenderCategory);var normalizedLoggerCategory=normalizeCategory(loggerCategory);return normalizedLoggerCategory.substring(0,normalizedAppenderCategory.length)==normalizedAppenderCategory;}function getLogger(loggerCategoryName){if(typeof loggerCategoryName!=="string"){loggerCategoryName=Logger.DEFAULT_CATEGORY;}if(!hasLogger(loggerCategoryName)){var level;if(levels.config){var keys=Object.keys(levels.config).sort();for(var idx=0;idx<keys.length;idx++){var levelCategory=keys[idx];if(doesLevelEntryContainsLogger(levelCategory,loggerCategoryName)){level=levels.config[levelCategory];}}}loggers[loggerCategoryName]=new Logger(loggerCategoryName,level);var appenderList;for(var appenderCategory in appenders){if(doesAppenderContainsLogger(appenderCategory,loggerCategoryName)){appenderList=appenders[appenderCategory];appenderList.forEach(function(appender){loggers[loggerCategoryName].addListener("log",appender);});}}if(appenders[ALL_CATEGORIES]){appenderList=appenders[ALL_CATEGORIES];appenderList.forEach(function(appender){loggers[loggerCategoryName].addListener("log",appender);});}}return loggers[loggerCategoryName];}function addAppender(){var args=Array.prototype.slice.call(arguments);var appender=args.shift();if(args.length===0||args[0]===undefined){args=[ALL_CATEGORIES];}if(Array.isArray(args[0])){args=args[0];}args.forEach(function(appenderCategory){addAppenderToCategory(appender,appenderCategory);if(appenderCategory===ALL_CATEGORIES){addAppenderToAllLoggers(appender);}else{for(var loggerCategory in loggers){if(doesAppenderContainsLogger(appenderCategory,loggerCategory)){loggers[loggerCategory].addListener("log",appender);}}}});}function addAppenderToAllLoggers(appender){for(var logger in loggers){if(hasLogger(logger)){loggers[logger].addListener("log",appender);}}}function addAppenderToCategory(appender,category){if(!appenders[category]){appenders[category]=[];}appenders[category].push(appender);}function clearAppenders(){appenders={};for(var logger in loggers){if(hasLogger(logger)){loggers[logger].removeAllListeners("log");}}}function configureAppenders(appenderList,options){clearAppenders();if(appenderList){appenderList.forEach(function(appenderConfig){loadAppender(appenderConfig.type);var appender;appenderConfig.makers=appenderMakers;try{appender=appenderMakers[appenderConfig.type](appenderConfig,options);addAppender(appender,appenderConfig.category);}catch(e){throw new Error("log4js configuration problem for "+util.inspect(appenderConfig),e);}});}}function configureLevels(_levels){levels.config=_levels;if(_levels){var keys=Object.keys(levels.config).sort();for(var idx in keys){var category=keys[idx];if(category===ALL_CATEGORIES){setGlobalLogLevel(_levels[category]);}for(var loggerCategory in loggers){if(doesLevelEntryContainsLogger(category,loggerCategory)){loggers[loggerCategory].setLevel(_levels[category]);}}}}}function setGlobalLogLevel(level){Logger.prototype.level=levels.toLevel(level,levels.TRACE);}function getDefaultLogger(){return getLogger(Logger.DEFAULT_CATEGORY);}var configState={};function loadConfigurationFile(filename){if(filename){return JSON.parse(fs.readFileSync(filename,"utf8"));}return undefined;}function configureOnceOff(config,options){if(config){try{configureLevels(config.levels);configureAppenders(config.appenders,options);if(config.replaceConsole){replaceConsole();}else{restoreConsole();}}catch(e){throw new Error("Problem reading log4js config "+util.inspect(config)+". Error was \""+e.message+"\" ("+e.stack+")");}}}function reloadConfiguration(options){var mtime=getMTime(configState.filename);if(!mtime)return;if(configState.lastMTime&&mtime.getTime()>configState.lastMTime.getTime()){configureOnceOff(loadConfigurationFile(configState.filename),options);}configState.lastMTime=mtime;}function getMTime(filename){var mtime;try{mtime=fs.statSync(configState.filename).mtime;}catch(e){getLogger('log4js').warn('Failed to load configuration file '+filename);}return mtime;}function initReloadConfiguration(filename,options){if(configState.timerId){clearInterval(configState.timerId);delete configState.timerId;}configState.filename=filename;configState.lastMTime=getMTime(filename);configState.timerId=setInterval(reloadConfiguration,options.reloadSecs*1000,options);}function configure(configurationFileOrObject,options){var config=configurationFileOrObject;config=config||process.env.LOG4JS_CONFIG;options=options||{};if(config===undefined||config===null||typeof config==='string'){if(options.reloadSecs){initReloadConfiguration(config,options);}config=loadConfigurationFile(config)||defaultConfig;}else{if(options.reloadSecs){getLogger('log4js').warn('Ignoring configuration reload parameter for "object" configuration.');}}configureOnceOff(config,options);}var originalConsoleFunctions={log:console.log,debug:console.debug,info:console.info,warn:console.warn,error:console.error};function replaceConsole(logger){function replaceWith(fn){return function(){fn.apply(logger,arguments);};}logger=logger||getLogger("console");['log','debug','info','warn','error'].forEach(function(item){console[item]=replaceWith(item==='log'?logger.info:logger[item]);});}function restoreConsole(){['log','debug','info','warn','error'].forEach(function(item){console[item]=originalConsoleFunctions[item];});}function requireAppender(appender){var appenderModule;try{appenderModule=require('./appenders/'+appender);}catch(e){appenderModule=require(appender);}return appenderModule;}function loadAppender(appender,appenderModule){appenderModule=appenderModule||requireAppender(appender);if(!appenderModule){throw new Error("Invalid log4js appender: "+util.inspect(appender));}module.exports.appenders[appender]=appenderModule.appender.bind(appenderModule);if(appenderModule.shutdown){appenderShutdowns[appender]=appenderModule.shutdown.bind(appenderModule);}appenderMakers[appender]=appenderModule.configure.bind(appenderModule);}function shutdown(cb){loggerModule.disableAllLogWrites();var completed=0;var error;var shutdownFcts=[];var complete=function complete(err){error=error||err;completed++;if(completed>=shutdownFcts.length){cb(error);}};for(var category in appenderShutdowns){if(appenderShutdowns.hasOwnProperty(category)){shutdownFcts.push(appenderShutdowns[category]);}}if(!shutdownFcts.length){return cb();}shutdownFcts.forEach(function(shutdownFct){shutdownFct(complete);});}module.exports={getBufferedLogger:getBufferedLogger,getLogger:getLogger,getDefaultLogger:getDefaultLogger,hasLogger:hasLogger,addAppender:addAppender,loadAppender:loadAppender,clearAppenders:clearAppenders,configure:configure,shutdown:shutdown,replaceConsole:replaceConsole,restoreConsole:restoreConsole,levels:levels,setGlobalLogLevel:setGlobalLogLevel,layouts:layouts,appenders:{},appenderMakers:appenderMakers,connectLogger:require('./connect-logger').connectLogger};configure();}).call(this,require('_process'));},{"./appenders/console":147,"./connect-logger":148,"./layouts":150,"./levels":151,"./logger":153,"_process":170,"events":57,"fs":48,"path":168,"util":208}],153:[function(require,module,exports){"use strict";var levels=require('./levels'),util=require('util'),events=require('events'),DEFAULT_CATEGORY='[default]';var logWritesEnabled=true;function LoggingEvent(categoryName,level,data,logger){this.startTime=new Date();this.categoryName=categoryName;this.data=data;this.level=level;this.logger=logger;}function Logger(name,level){this.category=name||DEFAULT_CATEGORY;if(level){this.setLevel(level);}}util.inherits(Logger,events.EventEmitter);Logger.DEFAULT_CATEGORY=DEFAULT_CATEGORY;Logger.prototype.level=levels.TRACE;Logger.prototype.setLevel=function(level){this.level=levels.toLevel(level,this.level||levels.TRACE);};Logger.prototype.removeLevel=function(){delete this.level;};Logger.prototype.log=function(){var logLevel=levels.toLevel(arguments[0],levels.INFO);if(!this.isLevelEnabled(logLevel)){return;}var numArgs=arguments.length-1;var args=new Array(numArgs);for(var i=0;i<numArgs;i++){args[i]=arguments[i+1];}this._log(logLevel,args);};Logger.prototype.isLevelEnabled=function(otherLevel){return this.level.isLessThanOrEqualTo(otherLevel);};['Trace','Debug','Info','Warn','Error','Fatal','Mark'].forEach(function(levelString){addLevelMethods(levelString);});function addLevelMethods(level){level=levels.toLevel(level);var levelStrLower=level.toString().toLowerCase();var levelMethod=levelStrLower.replace(/_([a-z])/g,function(g){return g[1].toUpperCase();});var isLevelMethod=levelMethod[0].toUpperCase()+levelMethod.slice(1);Logger.prototype['is'+isLevelMethod+'Enabled']=function(){return this.isLevelEnabled(level.toString());};Logger.prototype[levelMethod]=function(){if(logWritesEnabled&&this.isLevelEnabled(level)){var numArgs=arguments.length;var args=new Array(numArgs);for(var i=0;i<numArgs;i++){args[i]=arguments[i];}this._log(level,args);}};}Logger.prototype._log=function(level,data){var loggingEvent=new LoggingEvent(this.category,level,data,this);this.emit('log',loggingEvent);};function disableAllLogWrites(){logWritesEnabled=false;}function enableAllLogWrites(){logWritesEnabled=true;}exports.LoggingEvent=LoggingEvent;exports.Logger=Logger;exports.disableAllLogWrites=disableAllLogWrites;exports.enableAllLogWrites=enableAllLogWrites;exports.addLevelMethods=addLevelMethods;},{"./levels":151,"events":57,"util":208}],154:[function(require,module,exports){;(function(exports){if((typeof module==="undefined"?"undefined":_typeof(module))==='object'&&module.exports===exports)exports=module.exports=SemVer;exports.SEMVER_SPEC_VERSION='2.0.0';var MAX_LENGTH=256;var MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991;var re=exports.re=[];var src=exports.src=[];var R=0;var NUMERICIDENTIFIER=R++;src[NUMERICIDENTIFIER]='0|[1-9]\\d*';var NUMERICIDENTIFIERLOOSE=R++;src[NUMERICIDENTIFIERLOOSE]='[0-9]+';var NONNUMERICIDENTIFIER=R++;src[NONNUMERICIDENTIFIER]='\\d*[a-zA-Z-][a-zA-Z0-9-]*';var MAINVERSION=R++;src[MAINVERSION]='('+src[NUMERICIDENTIFIER]+')\\.'+'('+src[NUMERICIDENTIFIER]+')\\.'+'('+src[NUMERICIDENTIFIER]+')';var MAINVERSIONLOOSE=R++;src[MAINVERSIONLOOSE]='('+src[NUMERICIDENTIFIERLOOSE]+')\\.'+'('+src[NUMERICIDENTIFIERLOOSE]+')\\.'+'('+src[NUMERICIDENTIFIERLOOSE]+')';var PRERELEASEIDENTIFIER=R++;src[PRERELEASEIDENTIFIER]='(?:'+src[NUMERICIDENTIFIER]+'|'+src[NONNUMERICIDENTIFIER]+')';var PRERELEASEIDENTIFIERLOOSE=R++;src[PRERELEASEIDENTIFIERLOOSE]='(?:'+src[NUMERICIDENTIFIERLOOSE]+'|'+src[NONNUMERICIDENTIFIER]+')';var PRERELEASE=R++;src[PRERELEASE]='(?:-('+src[PRERELEASEIDENTIFIER]+'(?:\\.'+src[PRERELEASEIDENTIFIER]+')*))';var PRERELEASELOOSE=R++;src[PRERELEASELOOSE]='(?:-?('+src[PRERELEASEIDENTIFIERLOOSE]+'(?:\\.'+src[PRERELEASEIDENTIFIERLOOSE]+')*))';var BUILDIDENTIFIER=R++;src[BUILDIDENTIFIER]='[0-9A-Za-z-]+';var BUILD=R++;src[BUILD]='(?:\\+('+src[BUILDIDENTIFIER]+'(?:\\.'+src[BUILDIDENTIFIER]+')*))';var FULL=R++;var FULLPLAIN='v?'+src[MAINVERSION]+src[PRERELEASE]+'?'+src[BUILD]+'?';src[FULL]='^'+FULLPLAIN+'$';var LOOSEPLAIN='[v=\\s]*'+src[MAINVERSIONLOOSE]+src[PRERELEASELOOSE]+'?'+src[BUILD]+'?';var LOOSE=R++;src[LOOSE]='^'+LOOSEPLAIN+'$';var GTLT=R++;src[GTLT]='((?:<|>)?=?)';var XRANGEIDENTIFIERLOOSE=R++;src[XRANGEIDENTIFIERLOOSE]=src[NUMERICIDENTIFIERLOOSE]+'|x|X|\\*';var XRANGEIDENTIFIER=R++;src[XRANGEIDENTIFIER]=src[NUMERICIDENTIFIER]+'|x|X|\\*';var XRANGEPLAIN=R++;src[XRANGEPLAIN]='[v=\\s]*('+src[XRANGEIDENTIFIER]+')'+'(?:\\.('+src[XRANGEIDENTIFIER]+')'+'(?:\\.('+src[XRANGEIDENTIFIER]+')'+'(?:'+src[PRERELEASE]+')?'+src[BUILD]+'?'+')?)?';var XRANGEPLAINLOOSE=R++;src[XRANGEPLAINLOOSE]='[v=\\s]*('+src[XRANGEIDENTIFIERLOOSE]+')'+'(?:\\.('+src[XRANGEIDENTIFIERLOOSE]+')'+'(?:\\.('+src[XRANGEIDENTIFIERLOOSE]+')'+'(?:'+src[PRERELEASELOOSE]+')?'+src[BUILD]+'?'+')?)?';var XRANGE=R++;src[XRANGE]='^'+src[GTLT]+'\\s*'+src[XRANGEPLAIN]+'$';var XRANGELOOSE=R++;src[XRANGELOOSE]='^'+src[GTLT]+'\\s*'+src[XRANGEPLAINLOOSE]+'$';var LONETILDE=R++;src[LONETILDE]='(?:~>?)';var TILDETRIM=R++;src[TILDETRIM]='(\\s*)'+src[LONETILDE]+'\\s+';re[TILDETRIM]=new RegExp(src[TILDETRIM],'g');var tildeTrimReplace='$1~';var TILDE=R++;src[TILDE]='^'+src[LONETILDE]+src[XRANGEPLAIN]+'$';var TILDELOOSE=R++;src[TILDELOOSE]='^'+src[LONETILDE]+src[XRANGEPLAINLOOSE]+'$';var LONECARET=R++;src[LONECARET]='(?:\\^)';var CARETTRIM=R++;src[CARETTRIM]='(\\s*)'+src[LONECARET]+'\\s+';re[CARETTRIM]=new RegExp(src[CARETTRIM],'g');var caretTrimReplace='$1^';var CARET=R++;src[CARET]='^'+src[LONECARET]+src[XRANGEPLAIN]+'$';var CARETLOOSE=R++;src[CARETLOOSE]='^'+src[LONECARET]+src[XRANGEPLAINLOOSE]+'$';var COMPARATORLOOSE=R++;src[COMPARATORLOOSE]='^'+src[GTLT]+'\\s*('+LOOSEPLAIN+')$|^$';var COMPARATOR=R++;src[COMPARATOR]='^'+src[GTLT]+'\\s*('+FULLPLAIN+')$|^$';var COMPARATORTRIM=R++;src[COMPARATORTRIM]='(\\s*)'+src[GTLT]+'\\s*('+LOOSEPLAIN+'|'+src[XRANGEPLAIN]+')';re[COMPARATORTRIM]=new RegExp(src[COMPARATORTRIM],'g');var comparatorTrimReplace='$1$2$3';var HYPHENRANGE=R++;src[HYPHENRANGE]='^\\s*('+src[XRANGEPLAIN]+')'+'\\s+-\\s+'+'('+src[XRANGEPLAIN]+')'+'\\s*$';var HYPHENRANGELOOSE=R++;src[HYPHENRANGELOOSE]='^\\s*('+src[XRANGEPLAINLOOSE]+')'+'\\s+-\\s+'+'('+src[XRANGEPLAINLOOSE]+')'+'\\s*$';var STAR=R++;src[STAR]='(<|>)?=?\\s*\\*';for(var i=0;i<R;i++){;if(!re[i])re[i]=new RegExp(src[i]);}exports.parse=parse;function parse(version,loose){if(version instanceof SemVer)return version;if(typeof version!=='string')return null;if(version.length>MAX_LENGTH)return null;var r=loose?re[LOOSE]:re[FULL];if(!r.test(version))return null;try{return new SemVer(version,loose);}catch(er){return null;}}exports.valid=valid;function valid(version,loose){var v=parse(version,loose);return v?v.version:null;}exports.clean=clean;function clean(version,loose){var s=parse(version.trim().replace(/^[=v]+/,''),loose);return s?s.version:null;}exports.SemVer=SemVer;function SemVer(version,loose){if(version instanceof SemVer){if(version.loose===loose)return version;else version=version.version;}else if(typeof version!=='string'){throw new TypeError('Invalid Version: '+version);}if(version.length>MAX_LENGTH)throw new TypeError('version is longer than '+MAX_LENGTH+' characters');if(!(this instanceof SemVer))return new SemVer(version,loose);;this.loose=loose;var m=version.trim().match(loose?re[LOOSE]:re[FULL]);if(!m)throw new TypeError('Invalid Version: '+version);this.raw=version;this.major=+m[1];this.minor=+m[2];this.patch=+m[3];if(this.major>MAX_SAFE_INTEGER||this.major<0)throw new TypeError('Invalid major version');if(this.minor>MAX_SAFE_INTEGER||this.minor<0)throw new TypeError('Invalid minor version');if(this.patch>MAX_SAFE_INTEGER||this.patch<0)throw new TypeError('Invalid patch version');if(!m[4])this.prerelease=[];else this.prerelease=m[4].split('.').map(function(id){if(/^[0-9]+$/.test(id)){var num=+id;if(num>=0&&num<MAX_SAFE_INTEGER)return num;}return id;});this.build=m[5]?m[5].split('.'):[];this.format();}SemVer.prototype.format=function(){this.version=this.major+'.'+this.minor+'.'+this.patch;if(this.prerelease.length)this.version+='-'+this.prerelease.join('.');return this.version;};SemVer.prototype.inspect=function(){return'<SemVer "'+this+'">';};SemVer.prototype.toString=function(){return this.version;};SemVer.prototype.compare=function(other){;if(!(other instanceof SemVer))other=new SemVer(other,this.loose);return this.compareMain(other)||this.comparePre(other);};SemVer.prototype.compareMain=function(other){if(!(other instanceof SemVer))other=new SemVer(other,this.loose);return compareIdentifiers(this.major,other.major)||compareIdentifiers(this.minor,other.minor)||compareIdentifiers(this.patch,other.patch);};SemVer.prototype.comparePre=function(other){if(!(other instanceof SemVer))other=new SemVer(other,this.loose);if(this.prerelease.length&&!other.prerelease.length)return-1;else if(!this.prerelease.length&&other.prerelease.length)return 1;else if(!this.prerelease.length&&!other.prerelease.length)return 0;var i=0;do{var a=this.prerelease[i];var b=other.prerelease[i];;if(a===undefined&&b===undefined)return 0;else if(b===undefined)return 1;else if(a===undefined)return-1;else if(a===b)continue;else return compareIdentifiers(a,b);}while(++i);};SemVer.prototype.inc=function(release,identifier){switch(release){case'premajor':this.prerelease.length=0;this.patch=0;this.minor=0;this.major++;this.inc('pre',identifier);break;case'preminor':this.prerelease.length=0;this.patch=0;this.minor++;this.inc('pre',identifier);break;case'prepatch':this.prerelease.length=0;this.inc('patch',identifier);this.inc('pre',identifier);break;case'prerelease':if(this.prerelease.length===0)this.inc('patch',identifier);this.inc('pre',identifier);break;case'major':if(this.minor!==0||this.patch!==0||this.prerelease.length===0)this.major++;this.minor=0;this.patch=0;this.prerelease=[];break;case'minor':if(this.patch!==0||this.prerelease.length===0)this.minor++;this.patch=0;this.prerelease=[];break;case'patch':if(this.prerelease.length===0)this.patch++;this.prerelease=[];break;case'pre':if(this.prerelease.length===0)this.prerelease=[0];else{var i=this.prerelease.length;while(--i>=0){if(typeof this.prerelease[i]==='number'){this.prerelease[i]++;i=-2;}}if(i===-1)this.prerelease.push(0);}if(identifier){if(this.prerelease[0]===identifier){if(isNaN(this.prerelease[1]))this.prerelease=[identifier,0];}else this.prerelease=[identifier,0];}break;default:throw new Error('invalid increment argument: '+release);}this.format();return this;};exports.inc=inc;function inc(version,release,loose,identifier){if(typeof loose==='string'){identifier=loose;loose=undefined;}try{return new SemVer(version,loose).inc(release,identifier).version;}catch(er){return null;}}exports.diff=diff;function diff(version1,version2){if(eq(version1,version2)){return null;}else{var v1=parse(version1);var v2=parse(version2);if(v1.prerelease.length||v2.prerelease.length){for(var key in v1){if(key==='major'||key==='minor'||key==='patch'){if(v1[key]!==v2[key]){return'pre'+key;}}}return'prerelease';}for(var key in v1){if(key==='major'||key==='minor'||key==='patch'){if(v1[key]!==v2[key]){return key;}}}}}exports.compareIdentifiers=compareIdentifiers;var numeric=/^[0-9]+$/;function compareIdentifiers(a,b){var anum=numeric.test(a);var bnum=numeric.test(b);if(anum&&bnum){a=+a;b=+b;}return anum&&!bnum?-1:bnum&&!anum?1:a<b?-1:a>b?1:0;}exports.rcompareIdentifiers=rcompareIdentifiers;function rcompareIdentifiers(a,b){return compareIdentifiers(b,a);}exports.major=major;function major(a,loose){return new SemVer(a,loose).major;}exports.minor=minor;function minor(a,loose){return new SemVer(a,loose).minor;}exports.patch=patch;function patch(a,loose){return new SemVer(a,loose).patch;}exports.compare=compare;function compare(a,b,loose){return new SemVer(a,loose).compare(b);}exports.compareLoose=compareLoose;function compareLoose(a,b){return compare(a,b,true);}exports.rcompare=rcompare;function rcompare(a,b,loose){return compare(b,a,loose);}exports.sort=sort;function sort(list,loose){return list.sort(function(a,b){return exports.compare(a,b,loose);});}exports.rsort=rsort;function rsort(list,loose){return list.sort(function(a,b){return exports.rcompare(a,b,loose);});}exports.gt=gt;function gt(a,b,loose){return compare(a,b,loose)>0;}exports.lt=lt;function lt(a,b,loose){return compare(a,b,loose)<0;}exports.eq=eq;function eq(a,b,loose){return compare(a,b,loose)===0;}exports.neq=neq;function neq(a,b,loose){return compare(a,b,loose)!==0;}exports.gte=gte;function gte(a,b,loose){return compare(a,b,loose)>=0;}exports.lte=lte;function lte(a,b,loose){return compare(a,b,loose)<=0;}exports.cmp=cmp;function cmp(a,op,b,loose){var ret;switch(op){case'===':if((typeof a==="undefined"?"undefined":_typeof(a))==='object')a=a.version;if((typeof b==="undefined"?"undefined":_typeof(b))==='object')b=b.version;ret=a===b;break;case'!==':if((typeof a==="undefined"?"undefined":_typeof(a))==='object')a=a.version;if((typeof b==="undefined"?"undefined":_typeof(b))==='object')b=b.version;ret=a!==b;break;case'':case'=':case'==':ret=eq(a,b,loose);break;case'!=':ret=neq(a,b,loose);break;case'>':ret=gt(a,b,loose);break;case'>=':ret=gte(a,b,loose);break;case'<':ret=lt(a,b,loose);break;case'<=':ret=lte(a,b,loose);break;default:throw new TypeError('Invalid operator: '+op);}return ret;}exports.Comparator=Comparator;function Comparator(comp,loose){if(comp instanceof Comparator){if(comp.loose===loose)return comp;else comp=comp.value;}if(!(this instanceof Comparator))return new Comparator(comp,loose);;this.loose=loose;this.parse(comp);if(this.semver===ANY)this.value='';else this.value=this.operator+this.semver.version;;}var ANY={};Comparator.prototype.parse=function(comp){var r=this.loose?re[COMPARATORLOOSE]:re[COMPARATOR];var m=comp.match(r);if(!m)throw new TypeError('Invalid comparator: '+comp);this.operator=m[1];if(this.operator==='=')this.operator='';if(!m[2])this.semver=ANY;else this.semver=new SemVer(m[2],this.loose);};Comparator.prototype.inspect=function(){return'<SemVer Comparator "'+this+'">';};Comparator.prototype.toString=function(){return this.value;};Comparator.prototype.test=function(version){;if(this.semver===ANY)return true;if(typeof version==='string')version=new SemVer(version,this.loose);return cmp(version,this.operator,this.semver,this.loose);};exports.Range=Range;function Range(range,loose){if(range instanceof Range&&range.loose===loose)return range;if(!(this instanceof Range))return new Range(range,loose);this.loose=loose;this.raw=range;this.set=range.split(/\s*\|\|\s*/).map(function(range){return this.parseRange(range.trim());},this).filter(function(c){return c.length;});if(!this.set.length){throw new TypeError('Invalid SemVer Range: '+range);}this.format();}Range.prototype.inspect=function(){return'<SemVer Range "'+this.range+'">';};Range.prototype.format=function(){this.range=this.set.map(function(comps){return comps.join(' ').trim();}).join('||').trim();return this.range;};Range.prototype.toString=function(){return this.range;};Range.prototype.parseRange=function(range){var loose=this.loose;range=range.trim();;var hr=loose?re[HYPHENRANGELOOSE]:re[HYPHENRANGE];range=range.replace(hr,hyphenReplace);;range=range.replace(re[COMPARATORTRIM],comparatorTrimReplace);;range=range.replace(re[TILDETRIM],tildeTrimReplace);range=range.replace(re[CARETTRIM],caretTrimReplace);range=range.split(/\s+/).join(' ');var compRe=loose?re[COMPARATORLOOSE]:re[COMPARATOR];var set=range.split(' ').map(function(comp){return parseComparator(comp,loose);}).join(' ').split(/\s+/);if(this.loose){set=set.filter(function(comp){return!!comp.match(compRe);});}set=set.map(function(comp){return new Comparator(comp,loose);});return set;};exports.toComparators=toComparators;function toComparators(range,loose){return new Range(range,loose).set.map(function(comp){return comp.map(function(c){return c.value;}).join(' ').trim().split(' ');});}function parseComparator(comp,loose){;comp=replaceCarets(comp,loose);;comp=replaceTildes(comp,loose);;comp=replaceXRanges(comp,loose);;comp=replaceStars(comp,loose);;return comp;}function isX(id){return!id||id.toLowerCase()==='x'||id==='*';}function replaceTildes(comp,loose){return comp.trim().split(/\s+/).map(function(comp){return replaceTilde(comp,loose);}).join(' ');}function replaceTilde(comp,loose){var r=loose?re[TILDELOOSE]:re[TILDE];return comp.replace(r,function(_,M,m,p,pr){;var ret;if(isX(M))ret='';else if(isX(m))ret='>='+M+'.0.0 <'+(+M+1)+'.0.0';else if(isX(p))ret='>='+M+'.'+m+'.0 <'+M+'.'+(+m+1)+'.0';else if(pr){;if(pr.charAt(0)!=='-')pr='-'+pr;ret='>='+M+'.'+m+'.'+p+pr+' <'+M+'.'+(+m+1)+'.0';}else ret='>='+M+'.'+m+'.'+p+' <'+M+'.'+(+m+1)+'.0';;return ret;});}function replaceCarets(comp,loose){return comp.trim().split(/\s+/).map(function(comp){return replaceCaret(comp,loose);}).join(' ');}function replaceCaret(comp,loose){;var r=loose?re[CARETLOOSE]:re[CARET];return comp.replace(r,function(_,M,m,p,pr){;var ret;if(isX(M))ret='';else if(isX(m))ret='>='+M+'.0.0 <'+(+M+1)+'.0.0';else if(isX(p)){if(M==='0')ret='>='+M+'.'+m+'.0 <'+M+'.'+(+m+1)+'.0';else ret='>='+M+'.'+m+'.0 <'+(+M+1)+'.0.0';}else if(pr){;if(pr.charAt(0)!=='-')pr='-'+pr;if(M==='0'){if(m==='0')ret='>='+M+'.'+m+'.'+p+pr+' <'+M+'.'+m+'.'+(+p+1);else ret='>='+M+'.'+m+'.'+p+pr+' <'+M+'.'+(+m+1)+'.0';}else ret='>='+M+'.'+m+'.'+p+pr+' <'+(+M+1)+'.0.0';}else{;if(M==='0'){if(m==='0')ret='>='+M+'.'+m+'.'+p+' <'+M+'.'+m+'.'+(+p+1);else ret='>='+M+'.'+m+'.'+p+' <'+M+'.'+(+m+1)+'.0';}else ret='>='+M+'.'+m+'.'+p+' <'+(+M+1)+'.0.0';};return ret;});}function replaceXRanges(comp,loose){;return comp.split(/\s+/).map(function(comp){return replaceXRange(comp,loose);}).join(' ');}function replaceXRange(comp,loose){comp=comp.trim();var r=loose?re[XRANGELOOSE]:re[XRANGE];return comp.replace(r,function(ret,gtlt,M,m,p,pr){;var xM=isX(M);var xm=xM||isX(m);var xp=xm||isX(p);var anyX=xp;if(gtlt==='='&&anyX)gtlt='';if(xM){if(gtlt==='>'||gtlt==='<'){ret='<0.0.0';}else{ret='*';}}else if(gtlt&&anyX){if(xm)m=0;if(xp)p=0;if(gtlt==='>'){gtlt='>=';if(xm){M=+M+1;m=0;p=0;}else if(xp){m=+m+1;p=0;}}else if(gtlt==='<='){gtlt='<';if(xm)M=+M+1;else m=+m+1;}ret=gtlt+M+'.'+m+'.'+p;}else if(xm){ret='>='+M+'.0.0 <'+(+M+1)+'.0.0';}else if(xp){ret='>='+M+'.'+m+'.0 <'+M+'.'+(+m+1)+'.0';};return ret;});}function replaceStars(comp,loose){;return comp.trim().replace(re[STAR],'');}function hyphenReplace($0,from,fM,fm,fp,fpr,fb,to,tM,tm,tp,tpr,tb){if(isX(fM))from='';else if(isX(fm))from='>='+fM+'.0.0';else if(isX(fp))from='>='+fM+'.'+fm+'.0';else from='>='+from;if(isX(tM))to='';else if(isX(tm))to='<'+(+tM+1)+'.0.0';else if(isX(tp))to='<'+tM+'.'+(+tm+1)+'.0';else if(tpr)to='<='+tM+'.'+tm+'.'+tp+'-'+tpr;else to='<='+to;return(from+' '+to).trim();}Range.prototype.test=function(version){if(!version)return false;if(typeof version==='string')version=new SemVer(version,this.loose);for(var i=0;i<this.set.length;i++){if(testSet(this.set[i],version))return true;}return false;};function testSet(set,version){for(var i=0;i<set.length;i++){if(!set[i].test(version))return false;}if(version.prerelease.length){for(var i=0;i<set.length;i++){;if(set[i].semver===ANY)continue;if(set[i].semver.prerelease.length>0){var allowed=set[i].semver;if(allowed.major===version.major&&allowed.minor===version.minor&&allowed.patch===version.patch)return true;}}return false;}return true;}exports.satisfies=satisfies;function satisfies(version,range,loose){try{range=new Range(range,loose);}catch(er){return false;}return range.test(version);}exports.maxSatisfying=maxSatisfying;function maxSatisfying(versions,range,loose){return versions.filter(function(version){return satisfies(version,range,loose);}).sort(function(a,b){return rcompare(a,b,loose);})[0]||null;}exports.validRange=validRange;function validRange(range,loose){try{return new Range(range,loose).range||'*';}catch(er){return null;}}exports.ltr=ltr;function ltr(version,range,loose){return outside(version,range,'<',loose);}exports.gtr=gtr;function gtr(version,range,loose){return outside(version,range,'>',loose);}exports.outside=outside;function outside(version,range,hilo,loose){version=new SemVer(version,loose);range=new Range(range,loose);var gtfn,ltefn,ltfn,comp,ecomp;switch(hilo){case'>':gtfn=gt;ltefn=lte;ltfn=lt;comp='>';ecomp='>=';break;case'<':gtfn=lt;ltefn=gte;ltfn=gt;comp='<';ecomp='<=';break;default:throw new TypeError('Must provide a hilo val of "<" or ">"');}if(satisfies(version,range,loose)){return false;}for(var i=0;i<range.set.length;++i){var comparators=range.set[i];var high=null;var low=null;comparators.forEach(function(comparator){if(comparator.semver===ANY){comparator=new Comparator('>=0.0.0');}high=high||comparator;low=low||comparator;if(gtfn(comparator.semver,high.semver,loose)){high=comparator;}else if(ltfn(comparator.semver,low.semver,loose)){low=comparator;}});if(high.operator===comp||high.operator===ecomp){return false;}if((!low.operator||low.operator===comp)&&ltefn(version,low.semver)){return false;}else if(low.operator===ecomp&&ltfn(version,low.semver)){return false;}}return true;}if(typeof define==='function'&&define.amd)define(exports);})((typeof exports==="undefined"?"undefined":_typeof(exports))==='object'?exports:typeof define==='function'&&define.amd?{}:semver={});},{}],155:[function(require,module,exports){module.exports=MultiStream;var inherits=require('inherits');var stream=require('readable-stream');inherits(MultiStream,stream.Readable);function MultiStream(streams,opts){var self=this;if(!(self instanceof MultiStream))return new MultiStream(streams,opts);stream.Readable.call(self,opts);self.destroyed=false;self._drained=false;self._forwarding=false;self._current=null;self._toStreams2=opts&&opts.objectMode?toStreams2Obj:toStreams2Buf;if(typeof streams==='function'){self._queue=streams;}else{self._queue=streams.map(self._toStreams2);self._queue.forEach(function(stream){if(typeof stream!=='function')self._attachErrorListener(stream);});}self._next();}MultiStream.obj=function(streams){return new MultiStream(streams,{objectMode:true,highWaterMark:16});};MultiStream.prototype._read=function(){this._drained=true;this._forward();};MultiStream.prototype._forward=function(){if(this._forwarding||!this._drained||!this._current)return;this._forwarding=true;var chunk;while((chunk=this._current.read())!==null){this._drained=this.push(chunk);}this._forwarding=false;};MultiStream.prototype.destroy=function(err){if(this.destroyed)return;this.destroyed=true;if(this._current&&this._current.destroy)this._current.destroy();if(typeof this._queue!=='function'){this._queue.forEach(function(stream){if(stream.destroy)stream.destroy();});}if(err)this.emit('error',err);this.emit('close');};MultiStream.prototype._next=function(){var self=this;self._current=null;if(typeof self._queue==='function'){self._queue(function(err,stream){if(err)return self.destroy(err);stream=self._toStreams2(stream);self._attachErrorListener(stream);self._gotNextStream(stream);});}else{var stream=self._queue.shift();if(typeof stream==='function'){stream=self._toStreams2(stream());self._attachErrorListener(stream);}self._gotNextStream(stream);}};MultiStream.prototype._gotNextStream=function(stream){var self=this;if(!stream){self.push(null);self.destroy();return;}self._current=stream;self._forward();stream.on('readable',onReadable);stream.once('end',onEnd);stream.once('close',onClose);function onReadable(){self._forward();}function onClose(){if(!stream._readableState.ended){self.destroy();}}function onEnd(){self._current=null;stream.removeListener('readable',onReadable);stream.removeListener('end',onEnd);stream.removeListener('close',onClose);self._next();}};MultiStream.prototype._attachErrorListener=function(stream){var self=this;if(!stream)return;stream.once('error',onError);function onError(err){stream.removeListener('error',onError);self.destroy(err);}};function toStreams2Obj(s){return toStreams2(s,{objectMode:true,highWaterMark:16});}function toStreams2Buf(s){return toStreams2(s);}function toStreams2(s,opts){if(!s||typeof s==='function'||s._readableState)return s;var wrap=new stream.Readable(opts).wrap(s);if(s.destroy){wrap.destroy=s.destroy.bind(s);}return wrap;}},{"inherits":94,"readable-stream":165}],156:[function(require,module,exports){arguments[4][50][0].apply(exports,arguments);},{"dup":50}],157:[function(require,module,exports){arguments[4][135][0].apply(exports,arguments);},{"./_stream_readable":159,"./_stream_writable":161,"core-util-is":51,"dup":135,"inherits":94,"process-nextick-args":169}],158:[function(require,module,exports){arguments[4][136][0].apply(exports,arguments);},{"./_stream_transform":160,"core-util-is":51,"dup":136,"inherits":94}],159:[function(require,module,exports){arguments[4][137][0].apply(exports,arguments);},{"./_stream_duplex":157,"./internal/streams/BufferList":162,"./internal/streams/destroy":163,"./internal/streams/stream":164,"_process":170,"core-util-is":51,"dup":137,"events":57,"inherits":94,"isarray":156,"process-nextick-args":169,"safe-buffer":176,"string_decoder/":166,"util":47}],160:[function(require,module,exports){arguments[4][138][0].apply(exports,arguments);},{"./_stream_duplex":157,"core-util-is":51,"dup":138,"inherits":94}],161:[function(require,module,exports){arguments[4][139][0].apply(exports,arguments);},{"./_stream_duplex":157,"./internal/streams/destroy":163,"./internal/streams/stream":164,"_process":170,"core-util-is":51,"dup":139,"inherits":94,"process-nextick-args":169,"safe-buffer":176,"timers":204,"util-deprecate":205}],162:[function(require,module,exports){arguments[4][140][0].apply(exports,arguments);},{"dup":140,"safe-buffer":176,"util":47}],163:[function(require,module,exports){arguments[4][141][0].apply(exports,arguments);},{"dup":141,"process-nextick-args":169}],164:[function(require,module,exports){arguments[4][142][0].apply(exports,arguments);},{"dup":142,"events":57}],165:[function(require,module,exports){arguments[4][143][0].apply(exports,arguments);},{"./lib/_stream_duplex.js":157,"./lib/_stream_passthrough.js":158,"./lib/_stream_readable.js":159,"./lib/_stream_transform.js":160,"./lib/_stream_writable.js":161,"dup":143}],166:[function(require,module,exports){arguments[4][144][0].apply(exports,arguments);},{"dup":144,"safe-buffer":176}],167:[function(require,module,exports){module.exports=function(random,alphabet,size){var mask=(2<<Math.log(alphabet.length-1)/Math.LN2)-1;var step=Math.ceil(1.6*mask*size/alphabet.length);size=+size;var id='';while(true){var bytes=random(step);for(var i=0;i<step;i++){var byte=bytes[i]&mask;if(alphabet[byte]){id+=alphabet[byte];if(id.length===size)return id;}}}};},{}],168:[function(require,module,exports){(function(process){function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==='.'){parts.splice(i,1);}else if(last==='..'){parts.splice(i,1);up++;}else if(up){parts.splice(i,1);up--;}}if(allowAboveRoot){for(;up--;up){parts.unshift('..');}}return parts;}exports.resolve=function(){var resolvedPath='',resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:process.cwd();if(typeof path!=='string'){throw new TypeError('Arguments to path.resolve must be strings');}else if(!path){continue;}resolvedPath=path+'/'+resolvedPath;resolvedAbsolute=path.charAt(0)==='/';}resolvedPath=normalizeArray(filter(resolvedPath.split('/'),function(p){return!!p;}),!resolvedAbsolute).join('/');return(resolvedAbsolute?'/':'')+resolvedPath||'.';};exports.normalize=function(path){var isAbsolute=exports.isAbsolute(path),trailingSlash=substr(path,-1)==='/';path=normalizeArray(filter(path.split('/'),function(p){return!!p;}),!isAbsolute).join('/');if(!path&&!isAbsolute){path='.';}if(path&&trailingSlash){path+='/';}return(isAbsolute?'/':'')+path;};exports.isAbsolute=function(path){return path.charAt(0)==='/';};exports.join=function(){var paths=Array.prototype.slice.call(arguments,0);return exports.normalize(filter(paths,function(p,index){if(typeof p!=='string'){throw new TypeError('Arguments to path.join must be strings');}return p;}).join('/'));};exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=='')break;}var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=='')break;}if(start>end)return[];return arr.slice(start,end-start+1);}var fromParts=trim(from.split('/'));var toParts=trim(to.split('/'));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break;}}var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push('..');}outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join('/');};exports.sep='/';exports.delimiter=':';exports.dirname=function(path){if(typeof path!=='string')path=path+'';if(path.length===0)return'.';var code=path.charCodeAt(0);var hasRoot=code===47;var end=-1;var matchedSlash=true;for(var i=path.length-1;i>=1;--i){code=path.charCodeAt(i);if(code===47){if(!matchedSlash){end=i;break;}}else{matchedSlash=false;}}if(end===-1)return hasRoot?'/':'.';if(hasRoot&&end===1){return'/';}return path.slice(0,end);};function basename(path){if(typeof path!=='string')path=path+'';var start=0;var end=-1;var matchedSlash=true;var i;for(i=path.length-1;i>=0;--i){if(path.charCodeAt(i)===47){if(!matchedSlash){start=i+1;break;}}else if(end===-1){matchedSlash=false;end=i+1;}}if(end===-1)return'';return path.slice(start,end);}exports.basename=function(path,ext){var f=basename(path);if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length);}return f;};exports.extname=function(path){if(typeof path!=='string')path=path+'';var startDot=-1;var startPart=0;var end=-1;var matchedSlash=true;var preDotState=0;for(var i=path.length-1;i>=0;--i){var code=path.charCodeAt(i);if(code===47){if(!matchedSlash){startPart=i+1;break;}continue;}if(end===-1){matchedSlash=false;end=i+1;}if(code===46){if(startDot===-1)startDot=i;else if(preDotState!==1)preDotState=1;}else if(startDot!==-1){preDotState=-1;}}if(startDot===-1||end===-1||preDotState===0||preDotState===1&&startDot===end-1&&startDot===startPart+1){return'';}return path.slice(startDot,end);};function filter(xs,f){if(xs.filter)return xs.filter(f);var res=[];for(var i=0;i<xs.length;i++){if(f(xs[i],i,xs))res.push(xs[i]);}return res;}var substr='ab'.substr(-1)==='b'?function(str,start,len){return str.substr(start,len);}:function(str,start,len){if(start<0)start=str.length+start;return str.substr(start,len);};}).call(this,require('_process'));},{"_process":170}],169:[function(require,module,exports){(function(process){'use strict';if(typeof process==='undefined'||!process.version||process.version.indexOf('v0.')===0||process.version.indexOf('v1.')===0&&process.version.indexOf('v1.8.')!==0){module.exports={nextTick:nextTick};}else{module.exports=process;}function nextTick(fn,arg1,arg2,arg3){if(typeof fn!=='function'){throw new TypeError('"callback" argument must be a function');}var len=arguments.length;var args,i;switch(len){case 0:case 1:return process.nextTick(fn);case 2:return process.nextTick(function afterTickOne(){fn.call(null,arg1);});case 3:return process.nextTick(function afterTickTwo(){fn.call(null,arg1,arg2);});case 4:return process.nextTick(function afterTickThree(){fn.call(null,arg1,arg2,arg3);});default:args=new Array(len-1);i=0;while(i<args.length){args[i++]=arguments[i];}return process.nextTick(function afterTick(){fn.apply(null,args);});}}}).call(this,require('_process'));},{"_process":170}],170:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error('setTimeout has not been defined');}function defaultClearTimeout(){throw new Error('clearTimeout has not been defined');}(function(){try{if(typeof setTimeout==='function'){cachedSetTimeout=setTimeout;}else{cachedSetTimeout=defaultSetTimout;}}catch(e){cachedSetTimeout=defaultSetTimout;}try{if(typeof clearTimeout==='function'){cachedClearTimeout=clearTimeout;}else{cachedClearTimeout=defaultClearTimeout;}}catch(e){cachedClearTimeout=defaultClearTimeout;}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0);}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0);}try{return cachedSetTimeout(fun,0);}catch(e){try{return cachedSetTimeout.call(null,fun,0);}catch(e){return cachedSetTimeout.call(this,fun,0);}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker);}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker);}try{return cachedClearTimeout(marker);}catch(e){try{return cachedClearTimeout.call(null,marker);}catch(e){return cachedClearTimeout.call(this,marker);}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return;}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue);}else{queueIndex=-1;}if(queue.length){drainQueue();}}function drainQueue(){if(draining){return;}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run();}}queueIndex=-1;len=queue.length;}currentQueue=null;draining=false;runClearTimeout(timeout);}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i];}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue);}};function Item(fun,array){this.fun=fun;this.array=array;}Item.prototype.run=function(){this.fun.apply(null,this.array);};process.title='browser';process.browser=true;process.env={};process.argv=[];process.version='';process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[];};process.binding=function(name){throw new Error('process.binding is not supported');};process.cwd=function(){return'/';};process.chdir=function(dir){throw new Error('process.chdir is not supported');};process.umask=function(){return 0;};},{}],171:[function(require,module,exports){'use strict';var asap=require('asap/raw');function noop(){}var LAST_ERROR=null;var IS_ERROR={};function getThen(obj){try{return obj.then;}catch(ex){LAST_ERROR=ex;return IS_ERROR;}}function tryCallOne(fn,a){try{return fn(a);}catch(ex){LAST_ERROR=ex;return IS_ERROR;}}function tryCallTwo(fn,a,b){try{fn(a,b);}catch(ex){LAST_ERROR=ex;return IS_ERROR;}}module.exports=Promise;function Promise(fn){if(_typeof(this)!=='object'){throw new TypeError('Promises must be constructed via new');}if(typeof fn!=='function'){throw new TypeError('Promise constructor\'s argument is not a function');}this._40=0;this._65=0;this._55=null;this._72=null;if(fn===noop)return;doResolve(fn,this);}Promise._37=null;Promise._87=null;Promise._61=noop;Promise.prototype.then=function(onFulfilled,onRejected){if(this.constructor!==Promise){return safeThen(this,onFulfilled,onRejected);}var res=new Promise(noop);handle(this,new Handler(onFulfilled,onRejected,res));return res;};function safeThen(self,onFulfilled,onRejected){return new self.constructor(function(resolve,reject){var res=new Promise(noop);res.then(resolve,reject);handle(self,new Handler(onFulfilled,onRejected,res));});}function handle(self,deferred){while(self._65===3){self=self._55;}if(Promise._37){Promise._37(self);}if(self._65===0){if(self._40===0){self._40=1;self._72=deferred;return;}if(self._40===1){self._40=2;self._72=[self._72,deferred];return;}self._72.push(deferred);return;}handleResolved(self,deferred);}function handleResolved(self,deferred){asap(function(){var cb=self._65===1?deferred.onFulfilled:deferred.onRejected;if(cb===null){if(self._65===1){resolve(deferred.promise,self._55);}else{reject(deferred.promise,self._55);}return;}var ret=tryCallOne(cb,self._55);if(ret===IS_ERROR){reject(deferred.promise,LAST_ERROR);}else{resolve(deferred.promise,ret);}});}function resolve(self,newValue){if(newValue===self){return reject(self,new TypeError('A promise cannot be resolved with itself.'));}if(newValue&&((typeof newValue==="undefined"?"undefined":_typeof(newValue))==='object'||typeof newValue==='function')){var then=getThen(newValue);if(then===IS_ERROR){return reject(self,LAST_ERROR);}if(then===self.then&&newValue instanceof Promise){self._65=3;self._55=newValue;finale(self);return;}else if(typeof then==='function'){doResolve(then.bind(newValue),self);return;}}self._65=1;self._55=newValue;finale(self);}function reject(self,newValue){self._65=2;self._55=newValue;if(Promise._87){Promise._87(self,newValue);}finale(self);}function finale(self){if(self._40===1){handle(self,self._72);self._72=null;}if(self._40===2){for(var i=0;i<self._72.length;i++){handle(self,self._72[i]);}self._72=null;}}function Handler(onFulfilled,onRejected,promise){this.onFulfilled=typeof onFulfilled==='function'?onFulfilled:null;this.onRejected=typeof onRejected==='function'?onRejected:null;this.promise=promise;}function doResolve(fn,promise){var done=false;var res=tryCallTwo(fn,function(value){if(done)return;done=true;resolve(promise,value);},function(reason){if(done)return;done=true;reject(promise,reason);});if(!done&&res===IS_ERROR){done=true;reject(promise,LAST_ERROR);}}},{"asap/raw":45}],172:[function(require,module,exports){'use strict';var Promise=require('./core.js');module.exports=Promise;var TRUE=valuePromise(true);var FALSE=valuePromise(false);var NULL=valuePromise(null);var UNDEFINED=valuePromise(undefined);var ZERO=valuePromise(0);var EMPTYSTRING=valuePromise('');function valuePromise(value){var p=new Promise(Promise._61);p._65=1;p._55=value;return p;}Promise.resolve=function(value){if(value instanceof Promise)return value;if(value===null)return NULL;if(value===undefined)return UNDEFINED;if(value===true)return TRUE;if(value===false)return FALSE;if(value===0)return ZERO;if(value==='')return EMPTYSTRING;if((typeof value==="undefined"?"undefined":_typeof(value))==='object'||typeof value==='function'){try{var then=value.then;if(typeof then==='function'){return new Promise(then.bind(value));}}catch(ex){return new Promise(function(resolve,reject){reject(ex);});}}return valuePromise(value);};Promise.all=function(arr){var args=Array.prototype.slice.call(arr);return new Promise(function(resolve,reject){if(args.length===0)return resolve([]);var remaining=args.length;function res(i,val){if(val&&((typeof val==="undefined"?"undefined":_typeof(val))==='object'||typeof val==='function')){if(val instanceof Promise&&val.then===Promise.prototype.then){while(val._65===3){val=val._55;}if(val._65===1)return res(i,val._55);if(val._65===2)reject(val._55);val.then(function(val){res(i,val);},reject);return;}else{var then=val.then;if(typeof then==='function'){var p=new Promise(then.bind(val));p.then(function(val){res(i,val);},reject);return;}}}args[i]=val;if(--remaining===0){resolve(args);}}for(var i=0;i<args.length;i++){res(i,args[i]);}});};Promise.reject=function(value){return new Promise(function(resolve,reject){reject(value);});};Promise.race=function(values){return new Promise(function(resolve,reject){values.forEach(function(value){Promise.resolve(value).then(resolve,reject);});});};Promise.prototype['catch']=function(onRejected){return this.then(null,onRejected);};},{"./core.js":171}],173:[function(require,module,exports){'use strict';function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}module.exports=function(qs,sep,eq,options){sep=sep||'&';eq=eq||'=';var obj={};if(typeof qs!=='string'||qs.length===0){return obj;}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1000;if(options&&typeof options.maxKeys==='number'){maxKeys=options.maxKeys;}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys;}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,'%20'),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1);}else{kstr=x;vstr='';}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v;}else if(isArray(obj[k])){obj[k].push(v);}else{obj[k]=[obj[k],v];}}return obj;};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==='[object Array]';};},{}],174:[function(require,module,exports){'use strict';var stringifyPrimitive=function stringifyPrimitive(v){switch(typeof v==="undefined"?"undefined":_typeof(v)){case'string':return v;case'boolean':return v?'true':'false';case'number':return isFinite(v)?v:'';default:return'';}};module.exports=function(obj,sep,eq,name){sep=sep||'&';eq=eq||'=';if(obj===null){obj=undefined;}if((typeof obj==="undefined"?"undefined":_typeof(obj))==='object'){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v));}).join(sep);}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]));}}).join(sep);}if(!name)return'';return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj));};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==='[object Array]';};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i));}return res;}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key);}return res;};},{}],175:[function(require,module,exports){'use strict';exports.decode=exports.parse=require('./decode');exports.encode=exports.stringify=require('./encode');},{"./decode":173,"./encode":174}],176:[function(require,module,exports){var buffer=require('buffer');var Buffer=buffer.Buffer;function copyProps(src,dst){for(var key in src){dst[key]=src[key];}}if(Buffer.from&&Buffer.alloc&&Buffer.allocUnsafe&&Buffer.allocUnsafeSlow){module.exports=buffer;}else{copyProps(buffer,exports);exports.Buffer=SafeBuffer;}function SafeBuffer(arg,encodingOrOffset,length){return Buffer(arg,encodingOrOffset,length);}copyProps(Buffer,SafeBuffer);SafeBuffer.from=function(arg,encodingOrOffset,length){if(typeof arg==='number'){throw new TypeError('Argument must not be a number');}return Buffer(arg,encodingOrOffset,length);};SafeBuffer.alloc=function(size,fill,encoding){if(typeof size!=='number'){throw new TypeError('Argument must be a number');}var buf=Buffer(size);if(fill!==undefined){if(typeof encoding==='string'){buf.fill(fill,encoding);}else{buf.fill(fill);}}else{buf.fill(0);}return buf;};SafeBuffer.allocUnsafe=function(size){if(typeof size!=='number'){throw new TypeError('Argument must be a number');}return Buffer(size);};SafeBuffer.allocUnsafeSlow=function(size){if(typeof size!=='number'){throw new TypeError('Argument must be a number');}return buffer.SlowBuffer(size);};},{"buffer":49}],177:[function(require,module,exports){(function(Buffer){;(function(sax){sax.parser=function(strict,opt){return new SAXParser(strict,opt);};sax.SAXParser=SAXParser;sax.SAXStream=SAXStream;sax.createStream=createStream;sax.MAX_BUFFER_LENGTH=64*1024;var buffers=['comment','sgmlDecl','textNode','tagName','doctype','procInstName','procInstBody','entity','attribName','attribValue','cdata','script'];sax.EVENTS=['text','processinginstruction','sgmldeclaration','doctype','comment','opentagstart','attribute','opentag','closetag','opencdata','cdata','closecdata','error','end','ready','script','opennamespace','closenamespace'];function SAXParser(strict,opt){if(!(this instanceof SAXParser)){return new SAXParser(strict,opt);}var parser=this;clearBuffers(parser);parser.q=parser.c='';parser.bufferCheckPosition=sax.MAX_BUFFER_LENGTH;parser.opt=opt||{};parser.opt.lowercase=parser.opt.lowercase||parser.opt.lowercasetags;parser.looseCase=parser.opt.lowercase?'toLowerCase':'toUpperCase';parser.tags=[];parser.closed=parser.closedRoot=parser.sawRoot=false;parser.tag=parser.error=null;parser.strict=!!strict;parser.noscript=!!(strict||parser.opt.noscript);parser.state=S.BEGIN;parser.strictEntities=parser.opt.strictEntities;parser.ENTITIES=parser.strictEntities?Object.create(sax.XML_ENTITIES):Object.create(sax.ENTITIES);parser.attribList=[];if(parser.opt.xmlns){parser.ns=Object.create(rootNS);}parser.trackPosition=parser.opt.position!==false;if(parser.trackPosition){parser.position=parser.line=parser.column=0;}emit(parser,'onready');}if(!Object.create){Object.create=function(o){function F(){}F.prototype=o;var newf=new F();return newf;};}if(!Object.keys){Object.keys=function(o){var a=[];for(var i in o){if(o.hasOwnProperty(i))a.push(i);}return a;};}function checkBufferLength(parser){var maxAllowed=Math.max(sax.MAX_BUFFER_LENGTH,10);var maxActual=0;for(var i=0,l=buffers.length;i<l;i++){var len=parser[buffers[i]].length;if(len>maxAllowed){switch(buffers[i]){case'textNode':closeText(parser);break;case'cdata':emitNode(parser,'oncdata',parser.cdata);parser.cdata='';break;case'script':emitNode(parser,'onscript',parser.script);parser.script='';break;default:error(parser,'Max buffer length exceeded: '+buffers[i]);}}maxActual=Math.max(maxActual,len);}var m=sax.MAX_BUFFER_LENGTH-maxActual;parser.bufferCheckPosition=m+parser.position;}function clearBuffers(parser){for(var i=0,l=buffers.length;i<l;i++){parser[buffers[i]]='';}}function flushBuffers(parser){closeText(parser);if(parser.cdata!==''){emitNode(parser,'oncdata',parser.cdata);parser.cdata='';}if(parser.script!==''){emitNode(parser,'onscript',parser.script);parser.script='';}}SAXParser.prototype={end:function end(){_end(this);},write:write,resume:function resume(){this.error=null;return this;},close:function close(){return this.write(null);},flush:function flush(){flushBuffers(this);}};var Stream;try{Stream=require('stream').Stream;}catch(ex){Stream=function Stream(){};}var streamWraps=sax.EVENTS.filter(function(ev){return ev!=='error'&&ev!=='end';});function createStream(strict,opt){return new SAXStream(strict,opt);}function SAXStream(strict,opt){if(!(this instanceof SAXStream)){return new SAXStream(strict,opt);}Stream.apply(this);this._parser=new SAXParser(strict,opt);this.writable=true;this.readable=true;var me=this;this._parser.onend=function(){me.emit('end');};this._parser.onerror=function(er){me.emit('error',er);me._parser.error=null;};this._decoder=null;streamWraps.forEach(function(ev){Object.defineProperty(me,'on'+ev,{get:function get(){return me._parser['on'+ev];},set:function set(h){if(!h){me.removeAllListeners(ev);me._parser['on'+ev]=h;return h;}me.on(ev,h);},enumerable:true,configurable:false});});}SAXStream.prototype=Object.create(Stream.prototype,{constructor:{value:SAXStream}});SAXStream.prototype.write=function(data){if(typeof Buffer==='function'&&typeof Buffer.isBuffer==='function'&&Buffer.isBuffer(data)){if(!this._decoder){var SD=require('string_decoder').StringDecoder;this._decoder=new SD('utf8');}data=this._decoder.write(data);}this._parser.write(data.toString());this.emit('data',data);return true;};SAXStream.prototype.end=function(chunk){if(chunk&&chunk.length){this.write(chunk);}this._parser.end();return true;};SAXStream.prototype.on=function(ev,handler){var me=this;if(!me._parser['on'+ev]&&streamWraps.indexOf(ev)!==-1){me._parser['on'+ev]=function(){var args=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);args.splice(0,0,ev);me.emit.apply(me,args);};}return Stream.prototype.on.call(me,ev,handler);};var CDATA='[CDATA[';var DOCTYPE='DOCTYPE';var XML_NAMESPACE='http://www.w3.org/XML/1998/namespace';var XMLNS_NAMESPACE='http://www.w3.org/2000/xmlns/';var rootNS={xml:XML_NAMESPACE,xmlns:XMLNS_NAMESPACE};var nameStart=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/;var nameBody=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;var entityStart=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/;var entityBody=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function isWhitespace(c){return c===' '||c==='\n'||c==='\r'||c==='\t';}function isQuote(c){return c==='"'||c==='\'';}function isAttribEnd(c){return c==='>'||isWhitespace(c);}function isMatch(regex,c){return regex.test(c);}function notMatch(regex,c){return!isMatch(regex,c);}var S=0;sax.STATE={BEGIN:S++,BEGIN_WHITESPACE:S++,TEXT:S++,TEXT_ENTITY:S++,OPEN_WAKA:S++,SGML_DECL:S++,SGML_DECL_QUOTED:S++,DOCTYPE:S++,DOCTYPE_QUOTED:S++,DOCTYPE_DTD:S++,DOCTYPE_DTD_QUOTED:S++,COMMENT_STARTING:S++,COMMENT:S++,COMMENT_ENDING:S++,COMMENT_ENDED:S++,CDATA:S++,CDATA_ENDING:S++,CDATA_ENDING_2:S++,PROC_INST:S++,PROC_INST_BODY:S++,PROC_INST_ENDING:S++,OPEN_TAG:S++,OPEN_TAG_SLASH:S++,ATTRIB:S++,ATTRIB_NAME:S++,ATTRIB_NAME_SAW_WHITE:S++,ATTRIB_VALUE:S++,ATTRIB_VALUE_QUOTED:S++,ATTRIB_VALUE_CLOSED:S++,ATTRIB_VALUE_UNQUOTED:S++,ATTRIB_VALUE_ENTITY_Q:S++,ATTRIB_VALUE_ENTITY_U:S++,CLOSE_TAG:S++,CLOSE_TAG_SAW_WHITE:S++,SCRIPT:S++,SCRIPT_ENDING:S++};sax.XML_ENTITIES={'amp':'&','gt':'>','lt':'<','quot':'"','apos':"'"};sax.ENTITIES={'amp':'&','gt':'>','lt':'<','quot':'"','apos':"'",'AElig':198,'Aacute':193,'Acirc':194,'Agrave':192,'Aring':197,'Atilde':195,'Auml':196,'Ccedil':199,'ETH':208,'Eacute':201,'Ecirc':202,'Egrave':200,'Euml':203,'Iacute':205,'Icirc':206,'Igrave':204,'Iuml':207,'Ntilde':209,'Oacute':211,'Ocirc':212,'Ograve':210,'Oslash':216,'Otilde':213,'Ouml':214,'THORN':222,'Uacute':218,'Ucirc':219,'Ugrave':217,'Uuml':220,'Yacute':221,'aacute':225,'acirc':226,'aelig':230,'agrave':224,'aring':229,'atilde':227,'auml':228,'ccedil':231,'eacute':233,'ecirc':234,'egrave':232,'eth':240,'euml':235,'iacute':237,'icirc':238,'igrave':236,'iuml':239,'ntilde':241,'oacute':243,'ocirc':244,'ograve':242,'oslash':248,'otilde':245,'ouml':246,'szlig':223,'thorn':254,'uacute':250,'ucirc':251,'ugrave':249,'uuml':252,'yacute':253,'yuml':255,'copy':169,'reg':174,'nbsp':160,'iexcl':161,'cent':162,'pound':163,'curren':164,'yen':165,'brvbar':166,'sect':167,'uml':168,'ordf':170,'laquo':171,'not':172,'shy':173,'macr':175,'deg':176,'plusmn':177,'sup1':185,'sup2':178,'sup3':179,'acute':180,'micro':181,'para':182,'middot':183,'cedil':184,'ordm':186,'raquo':187,'frac14':188,'frac12':189,'frac34':190,'iquest':191,'times':215,'divide':247,'OElig':338,'oelig':339,'Scaron':352,'scaron':353,'Yuml':376,'fnof':402,'circ':710,'tilde':732,'Alpha':913,'Beta':914,'Gamma':915,'Delta':916,'Epsilon':917,'Zeta':918,'Eta':919,'Theta':920,'Iota':921,'Kappa':922,'Lambda':923,'Mu':924,'Nu':925,'Xi':926,'Omicron':927,'Pi':928,'Rho':929,'Sigma':931,'Tau':932,'Upsilon':933,'Phi':934,'Chi':935,'Psi':936,'Omega':937,'alpha':945,'beta':946,'gamma':947,'delta':948,'epsilon':949,'zeta':950,'eta':951,'theta':952,'iota':953,'kappa':954,'lambda':955,'mu':956,'nu':957,'xi':958,'omicron':959,'pi':960,'rho':961,'sigmaf':962,'sigma':963,'tau':964,'upsilon':965,'phi':966,'chi':967,'psi':968,'omega':969,'thetasym':977,'upsih':978,'piv':982,'ensp':8194,'emsp':8195,'thinsp':8201,'zwnj':8204,'zwj':8205,'lrm':8206,'rlm':8207,'ndash':8211,'mdash':8212,'lsquo':8216,'rsquo':8217,'sbquo':8218,'ldquo':8220,'rdquo':8221,'bdquo':8222,'dagger':8224,'Dagger':8225,'bull':8226,'hellip':8230,'permil':8240,'prime':8242,'Prime':8243,'lsaquo':8249,'rsaquo':8250,'oline':8254,'frasl':8260,'euro':8364,'image':8465,'weierp':8472,'real':8476,'trade':8482,'alefsym':8501,'larr':8592,'uarr':8593,'rarr':8594,'darr':8595,'harr':8596,'crarr':8629,'lArr':8656,'uArr':8657,'rArr':8658,'dArr':8659,'hArr':8660,'forall':8704,'part':8706,'exist':8707,'empty':8709,'nabla':8711,'isin':8712,'notin':8713,'ni':8715,'prod':8719,'sum':8721,'minus':8722,'lowast':8727,'radic':8730,'prop':8733,'infin':8734,'ang':8736,'and':8743,'or':8744,'cap':8745,'cup':8746,'int':8747,'there4':8756,'sim':8764,'cong':8773,'asymp':8776,'ne':8800,'equiv':8801,'le':8804,'ge':8805,'sub':8834,'sup':8835,'nsub':8836,'sube':8838,'supe':8839,'oplus':8853,'otimes':8855,'perp':8869,'sdot':8901,'lceil':8968,'rceil':8969,'lfloor':8970,'rfloor':8971,'lang':9001,'rang':9002,'loz':9674,'spades':9824,'clubs':9827,'hearts':9829,'diams':9830};Object.keys(sax.ENTITIES).forEach(function(key){var e=sax.ENTITIES[key];var s=typeof e==='number'?String.fromCharCode(e):e;sax.ENTITIES[key]=s;});for(var s in sax.STATE){sax.STATE[sax.STATE[s]]=s;}S=sax.STATE;function emit(parser,event,data){parser[event]&&parser[event](data);}function emitNode(parser,nodeType,data){if(parser.textNode)closeText(parser);emit(parser,nodeType,data);}function closeText(parser){parser.textNode=textopts(parser.opt,parser.textNode);if(parser.textNode)emit(parser,'ontext',parser.textNode);parser.textNode='';}function textopts(opt,text){if(opt.trim)text=text.trim();if(opt.normalize)text=text.replace(/\s+/g,' ');return text;}function error(parser,er){closeText(parser);if(parser.trackPosition){er+='\nLine: '+parser.line+'\nColumn: '+parser.column+'\nChar: '+parser.c;}er=new Error(er);parser.error=er;emit(parser,'onerror',er);return parser;}function _end(parser){if(parser.sawRoot&&!parser.closedRoot)strictFail(parser,'Unclosed root tag');if(parser.state!==S.BEGIN&&parser.state!==S.BEGIN_WHITESPACE&&parser.state!==S.TEXT){error(parser,'Unexpected end');}closeText(parser);parser.c='';parser.closed=true;emit(parser,'onend');SAXParser.call(parser,parser.strict,parser.opt);return parser;}function strictFail(parser,message){if((typeof parser==="undefined"?"undefined":_typeof(parser))!=='object'||!(parser instanceof SAXParser)){throw new Error('bad call to strictFail');}if(parser.strict){error(parser,message);}}function newTag(parser){if(!parser.strict)parser.tagName=parser.tagName[parser.looseCase]();var parent=parser.tags[parser.tags.length-1]||parser;var tag=parser.tag={name:parser.tagName,attributes:{}};if(parser.opt.xmlns){tag.ns=parent.ns;}parser.attribList.length=0;emitNode(parser,'onopentagstart',tag);}function qname(name,attribute){var i=name.indexOf(':');var qualName=i<0?['',name]:name.split(':');var prefix=qualName[0];var local=qualName[1];if(attribute&&name==='xmlns'){prefix='xmlns';local='';}return{prefix:prefix,local:local};}function attrib(parser){if(!parser.strict){parser.attribName=parser.attribName[parser.looseCase]();}if(parser.attribList.indexOf(parser.attribName)!==-1||parser.tag.attributes.hasOwnProperty(parser.attribName)){parser.attribName=parser.attribValue='';return;}if(parser.opt.xmlns){var qn=qname(parser.attribName,true);var prefix=qn.prefix;var local=qn.local;if(prefix==='xmlns'){if(local==='xml'&&parser.attribValue!==XML_NAMESPACE){strictFail(parser,'xml: prefix must be bound to '+XML_NAMESPACE+'\n'+'Actual: '+parser.attribValue);}else if(local==='xmlns'&&parser.attribValue!==XMLNS_NAMESPACE){strictFail(parser,'xmlns: prefix must be bound to '+XMLNS_NAMESPACE+'\n'+'Actual: '+parser.attribValue);}else{var tag=parser.tag;var parent=parser.tags[parser.tags.length-1]||parser;if(tag.ns===parent.ns){tag.ns=Object.create(parent.ns);}tag.ns[local]=parser.attribValue;}}parser.attribList.push([parser.attribName,parser.attribValue]);}else{parser.tag.attributes[parser.attribName]=parser.attribValue;emitNode(parser,'onattribute',{name:parser.attribName,value:parser.attribValue});}parser.attribName=parser.attribValue='';}function openTag(parser,selfClosing){if(parser.opt.xmlns){var tag=parser.tag;var qn=qname(parser.tagName);tag.prefix=qn.prefix;tag.local=qn.local;tag.uri=tag.ns[qn.prefix]||'';if(tag.prefix&&!tag.uri){strictFail(parser,'Unbound namespace prefix: '+JSON.stringify(parser.tagName));tag.uri=qn.prefix;}var parent=parser.tags[parser.tags.length-1]||parser;if(tag.ns&&parent.ns!==tag.ns){Object.keys(tag.ns).forEach(function(p){emitNode(parser,'onopennamespace',{prefix:p,uri:tag.ns[p]});});}for(var i=0,l=parser.attribList.length;i<l;i++){var nv=parser.attribList[i];var name=nv[0];var value=nv[1];var qualName=qname(name,true);var prefix=qualName.prefix;var local=qualName.local;var uri=prefix===''?'':tag.ns[prefix]||'';var a={name:name,value:value,prefix:prefix,local:local,uri:uri};if(prefix&&prefix!=='xmlns'&&!uri){strictFail(parser,'Unbound namespace prefix: '+JSON.stringify(prefix));a.uri=prefix;}parser.tag.attributes[name]=a;emitNode(parser,'onattribute',a);}parser.attribList.length=0;}parser.tag.isSelfClosing=!!selfClosing;parser.sawRoot=true;parser.tags.push(parser.tag);emitNode(parser,'onopentag',parser.tag);if(!selfClosing){if(!parser.noscript&&parser.tagName.toLowerCase()==='script'){parser.state=S.SCRIPT;}else{parser.state=S.TEXT;}parser.tag=null;parser.tagName='';}parser.attribName=parser.attribValue='';parser.attribList.length=0;}function closeTag(parser){if(!parser.tagName){strictFail(parser,'Weird empty close tag.');parser.textNode+='</>';parser.state=S.TEXT;return;}if(parser.script){if(parser.tagName!=='script'){parser.script+='</'+parser.tagName+'>';parser.tagName='';parser.state=S.SCRIPT;return;}emitNode(parser,'onscript',parser.script);parser.script='';}var t=parser.tags.length;var tagName=parser.tagName;if(!parser.strict){tagName=tagName[parser.looseCase]();}var closeTo=tagName;while(t--){var close=parser.tags[t];if(close.name!==closeTo){strictFail(parser,'Unexpected close tag');}else{break;}}if(t<0){strictFail(parser,'Unmatched closing tag: '+parser.tagName);parser.textNode+='</'+parser.tagName+'>';parser.state=S.TEXT;return;}parser.tagName=tagName;var s=parser.tags.length;while(s-->t){var tag=parser.tag=parser.tags.pop();parser.tagName=parser.tag.name;emitNode(parser,'onclosetag',parser.tagName);var x={};for(var i in tag.ns){x[i]=tag.ns[i];}var parent=parser.tags[parser.tags.length-1]||parser;if(parser.opt.xmlns&&tag.ns!==parent.ns){Object.keys(tag.ns).forEach(function(p){var n=tag.ns[p];emitNode(parser,'onclosenamespace',{prefix:p,uri:n});});}}if(t===0)parser.closedRoot=true;parser.tagName=parser.attribValue=parser.attribName='';parser.attribList.length=0;parser.state=S.TEXT;}function parseEntity(parser){var entity=parser.entity;var entityLC=entity.toLowerCase();var num;var numStr='';if(parser.ENTITIES[entity]){return parser.ENTITIES[entity];}if(parser.ENTITIES[entityLC]){return parser.ENTITIES[entityLC];}entity=entityLC;if(entity.charAt(0)==='#'){if(entity.charAt(1)==='x'){entity=entity.slice(2);num=parseInt(entity,16);numStr=num.toString(16);}else{entity=entity.slice(1);num=parseInt(entity,10);numStr=num.toString(10);}}entity=entity.replace(/^0+/,'');if(isNaN(num)||numStr.toLowerCase()!==entity){strictFail(parser,'Invalid character entity');return'&'+parser.entity+';';}return String.fromCodePoint(num);}function beginWhiteSpace(parser,c){if(c==='<'){parser.state=S.OPEN_WAKA;parser.startTagPosition=parser.position;}else if(!isWhitespace(c)){strictFail(parser,'Non-whitespace before first tag.');parser.textNode=c;parser.state=S.TEXT;}}function charAt(chunk,i){var result='';if(i<chunk.length){result=chunk.charAt(i);}return result;}function write(chunk){var parser=this;if(this.error){throw this.error;}if(parser.closed){return error(parser,'Cannot write after close. Assign an onready handler.');}if(chunk===null){return _end(parser);}if((typeof chunk==="undefined"?"undefined":_typeof(chunk))==='object'){chunk=chunk.toString();}var i=0;var c='';while(true){c=charAt(chunk,i++);parser.c=c;if(!c){break;}if(parser.trackPosition){parser.position++;if(c==='\n'){parser.line++;parser.column=0;}else{parser.column++;}}switch(parser.state){case S.BEGIN:parser.state=S.BEGIN_WHITESPACE;if(c==="\uFEFF"){continue;}beginWhiteSpace(parser,c);continue;case S.BEGIN_WHITESPACE:beginWhiteSpace(parser,c);continue;case S.TEXT:if(parser.sawRoot&&!parser.closedRoot){var starti=i-1;while(c&&c!=='<'&&c!=='&'){c=charAt(chunk,i++);if(c&&parser.trackPosition){parser.position++;if(c==='\n'){parser.line++;parser.column=0;}else{parser.column++;}}}parser.textNode+=chunk.substring(starti,i-1);}if(c==='<'&&!(parser.sawRoot&&parser.closedRoot&&!parser.strict)){parser.state=S.OPEN_WAKA;parser.startTagPosition=parser.position;}else{if(!isWhitespace(c)&&(!parser.sawRoot||parser.closedRoot)){strictFail(parser,'Text data outside of root node.');}if(c==='&'){parser.state=S.TEXT_ENTITY;}else{parser.textNode+=c;}}continue;case S.SCRIPT:if(c==='<'){parser.state=S.SCRIPT_ENDING;}else{parser.script+=c;}continue;case S.SCRIPT_ENDING:if(c==='/'){parser.state=S.CLOSE_TAG;}else{parser.script+='<'+c;parser.state=S.SCRIPT;}continue;case S.OPEN_WAKA:if(c==='!'){parser.state=S.SGML_DECL;parser.sgmlDecl='';}else if(isWhitespace(c)){}else if(isMatch(nameStart,c)){parser.state=S.OPEN_TAG;parser.tagName=c;}else if(c==='/'){parser.state=S.CLOSE_TAG;parser.tagName='';}else if(c==='?'){parser.state=S.PROC_INST;parser.procInstName=parser.procInstBody='';}else{strictFail(parser,'Unencoded <');if(parser.startTagPosition+1<parser.position){var pad=parser.position-parser.startTagPosition;c=new Array(pad).join(' ')+c;}parser.textNode+='<'+c;parser.state=S.TEXT;}continue;case S.SGML_DECL:if((parser.sgmlDecl+c).toUpperCase()===CDATA){emitNode(parser,'onopencdata');parser.state=S.CDATA;parser.sgmlDecl='';parser.cdata='';}else if(parser.sgmlDecl+c==='--'){parser.state=S.COMMENT;parser.comment='';parser.sgmlDecl='';}else if((parser.sgmlDecl+c).toUpperCase()===DOCTYPE){parser.state=S.DOCTYPE;if(parser.doctype||parser.sawRoot){strictFail(parser,'Inappropriately located doctype declaration');}parser.doctype='';parser.sgmlDecl='';}else if(c==='>'){emitNode(parser,'onsgmldeclaration',parser.sgmlDecl);parser.sgmlDecl='';parser.state=S.TEXT;}else if(isQuote(c)){parser.state=S.SGML_DECL_QUOTED;parser.sgmlDecl+=c;}else{parser.sgmlDecl+=c;}continue;case S.SGML_DECL_QUOTED:if(c===parser.q){parser.state=S.SGML_DECL;parser.q='';}parser.sgmlDecl+=c;continue;case S.DOCTYPE:if(c==='>'){parser.state=S.TEXT;emitNode(parser,'ondoctype',parser.doctype);parser.doctype=true;}else{parser.doctype+=c;if(c==='['){parser.state=S.DOCTYPE_DTD;}else if(isQuote(c)){parser.state=S.DOCTYPE_QUOTED;parser.q=c;}}continue;case S.DOCTYPE_QUOTED:parser.doctype+=c;if(c===parser.q){parser.q='';parser.state=S.DOCTYPE;}continue;case S.DOCTYPE_DTD:parser.doctype+=c;if(c===']'){parser.state=S.DOCTYPE;}else if(isQuote(c)){parser.state=S.DOCTYPE_DTD_QUOTED;parser.q=c;}continue;case S.DOCTYPE_DTD_QUOTED:parser.doctype+=c;if(c===parser.q){parser.state=S.DOCTYPE_DTD;parser.q='';}continue;case S.COMMENT:if(c==='-'){parser.state=S.COMMENT_ENDING;}else{parser.comment+=c;}continue;case S.COMMENT_ENDING:if(c==='-'){parser.state=S.COMMENT_ENDED;parser.comment=textopts(parser.opt,parser.comment);if(parser.comment){emitNode(parser,'oncomment',parser.comment);}parser.comment='';}else{parser.comment+='-'+c;parser.state=S.COMMENT;}continue;case S.COMMENT_ENDED:if(c!=='>'){strictFail(parser,'Malformed comment');parser.comment+='--'+c;parser.state=S.COMMENT;}else{parser.state=S.TEXT;}continue;case S.CDATA:if(c===']'){parser.state=S.CDATA_ENDING;}else{parser.cdata+=c;}continue;case S.CDATA_ENDING:if(c===']'){parser.state=S.CDATA_ENDING_2;}else{parser.cdata+=']'+c;parser.state=S.CDATA;}continue;case S.CDATA_ENDING_2:if(c==='>'){if(parser.cdata){emitNode(parser,'oncdata',parser.cdata);}emitNode(parser,'onclosecdata');parser.cdata='';parser.state=S.TEXT;}else if(c===']'){parser.cdata+=']';}else{parser.cdata+=']]'+c;parser.state=S.CDATA;}continue;case S.PROC_INST:if(c==='?'){parser.state=S.PROC_INST_ENDING;}else if(isWhitespace(c)){parser.state=S.PROC_INST_BODY;}else{parser.procInstName+=c;}continue;case S.PROC_INST_BODY:if(!parser.procInstBody&&isWhitespace(c)){continue;}else if(c==='?'){parser.state=S.PROC_INST_ENDING;}else{parser.procInstBody+=c;}continue;case S.PROC_INST_ENDING:if(c==='>'){emitNode(parser,'onprocessinginstruction',{name:parser.procInstName,body:parser.procInstBody});parser.procInstName=parser.procInstBody='';parser.state=S.TEXT;}else{parser.procInstBody+='?'+c;parser.state=S.PROC_INST_BODY;}continue;case S.OPEN_TAG:if(isMatch(nameBody,c)){parser.tagName+=c;}else{newTag(parser);if(c==='>'){openTag(parser);}else if(c==='/'){parser.state=S.OPEN_TAG_SLASH;}else{if(!isWhitespace(c)){strictFail(parser,'Invalid character in tag name');}parser.state=S.ATTRIB;}}continue;case S.OPEN_TAG_SLASH:if(c==='>'){openTag(parser,true);closeTag(parser);}else{strictFail(parser,'Forward-slash in opening tag not followed by >');parser.state=S.ATTRIB;}continue;case S.ATTRIB:if(isWhitespace(c)){continue;}else if(c==='>'){openTag(parser);}else if(c==='/'){parser.state=S.OPEN_TAG_SLASH;}else if(isMatch(nameStart,c)){parser.attribName=c;parser.attribValue='';parser.state=S.ATTRIB_NAME;}else{strictFail(parser,'Invalid attribute name');}continue;case S.ATTRIB_NAME:if(c==='='){parser.state=S.ATTRIB_VALUE;}else if(c==='>'){strictFail(parser,'Attribute without value');parser.attribValue=parser.attribName;attrib(parser);openTag(parser);}else if(isWhitespace(c)){parser.state=S.ATTRIB_NAME_SAW_WHITE;}else if(isMatch(nameBody,c)){parser.attribName+=c;}else{strictFail(parser,'Invalid attribute name');}continue;case S.ATTRIB_NAME_SAW_WHITE:if(c==='='){parser.state=S.ATTRIB_VALUE;}else if(isWhitespace(c)){continue;}else{strictFail(parser,'Attribute without value');parser.tag.attributes[parser.attribName]='';parser.attribValue='';emitNode(parser,'onattribute',{name:parser.attribName,value:''});parser.attribName='';if(c==='>'){openTag(parser);}else if(isMatch(nameStart,c)){parser.attribName=c;parser.state=S.ATTRIB_NAME;}else{strictFail(parser,'Invalid attribute name');parser.state=S.ATTRIB;}}continue;case S.ATTRIB_VALUE:if(isWhitespace(c)){continue;}else if(isQuote(c)){parser.q=c;parser.state=S.ATTRIB_VALUE_QUOTED;}else{strictFail(parser,'Unquoted attribute value');parser.state=S.ATTRIB_VALUE_UNQUOTED;parser.attribValue=c;}continue;case S.ATTRIB_VALUE_QUOTED:if(c!==parser.q){if(c==='&'){parser.state=S.ATTRIB_VALUE_ENTITY_Q;}else{parser.attribValue+=c;}continue;}attrib(parser);parser.q='';parser.state=S.ATTRIB_VALUE_CLOSED;continue;case S.ATTRIB_VALUE_CLOSED:if(isWhitespace(c)){parser.state=S.ATTRIB;}else if(c==='>'){openTag(parser);}else if(c==='/'){parser.state=S.OPEN_TAG_SLASH;}else if(isMatch(nameStart,c)){strictFail(parser,'No whitespace between attributes');parser.attribName=c;parser.attribValue='';parser.state=S.ATTRIB_NAME;}else{strictFail(parser,'Invalid attribute name');}continue;case S.ATTRIB_VALUE_UNQUOTED:if(!isAttribEnd(c)){if(c==='&'){parser.state=S.ATTRIB_VALUE_ENTITY_U;}else{parser.attribValue+=c;}continue;}attrib(parser);if(c==='>'){openTag(parser);}else{parser.state=S.ATTRIB;}continue;case S.CLOSE_TAG:if(!parser.tagName){if(isWhitespace(c)){continue;}else if(notMatch(nameStart,c)){if(parser.script){parser.script+='</'+c;parser.state=S.SCRIPT;}else{strictFail(parser,'Invalid tagname in closing tag.');}}else{parser.tagName=c;}}else if(c==='>'){closeTag(parser);}else if(isMatch(nameBody,c)){parser.tagName+=c;}else if(parser.script){parser.script+='</'+parser.tagName;parser.tagName='';parser.state=S.SCRIPT;}else{if(!isWhitespace(c)){strictFail(parser,'Invalid tagname in closing tag');}parser.state=S.CLOSE_TAG_SAW_WHITE;}continue;case S.CLOSE_TAG_SAW_WHITE:if(isWhitespace(c)){continue;}if(c==='>'){closeTag(parser);}else{strictFail(parser,'Invalid characters in closing tag');}continue;case S.TEXT_ENTITY:case S.ATTRIB_VALUE_ENTITY_Q:case S.ATTRIB_VALUE_ENTITY_U:var returnState;var buffer;switch(parser.state){case S.TEXT_ENTITY:returnState=S.TEXT;buffer='textNode';break;case S.ATTRIB_VALUE_ENTITY_Q:returnState=S.ATTRIB_VALUE_QUOTED;buffer='attribValue';break;case S.ATTRIB_VALUE_ENTITY_U:returnState=S.ATTRIB_VALUE_UNQUOTED;buffer='attribValue';break;}if(c===';'){parser[buffer]+=parseEntity(parser);parser.entity='';parser.state=returnState;}else if(isMatch(parser.entity.length?entityBody:entityStart,c)){parser.entity+=c;}else{strictFail(parser,'Invalid character in entity name');parser[buffer]+='&'+parser.entity+c;parser.entity='';parser.state=returnState;}continue;default:throw new Error(parser,'Unknown state: '+parser.state);}}if(parser.position>=parser.bufferCheckPosition){checkBufferLength(parser);}return parser;}if(!String.fromCodePoint){(function(){var stringFromCharCode=String.fromCharCode;var floor=Math.floor;var fromCodePoint=function fromCodePoint(){var MAX_SIZE=0x4000;var codeUnits=[];var highSurrogate;var lowSurrogate;var index=-1;var length=arguments.length;if(!length){return'';}var result='';while(++index<length){var codePoint=Number(arguments[index]);if(!isFinite(codePoint)||codePoint<0||codePoint>0x10FFFF||floor(codePoint)!==codePoint){throw RangeError('Invalid code point: '+codePoint);}if(codePoint<=0xFFFF){codeUnits.push(codePoint);}else{codePoint-=0x10000;highSurrogate=(codePoint>>10)+0xD800;lowSurrogate=codePoint%0x400+0xDC00;codeUnits.push(highSurrogate,lowSurrogate);}if(index+1===length||codeUnits.length>MAX_SIZE){result+=stringFromCharCode.apply(null,codeUnits);codeUnits.length=0;}}return result;};if(Object.defineProperty){Object.defineProperty(String,'fromCodePoint',{value:fromCodePoint,configurable:true,writable:true});}else{String.fromCodePoint=fromCodePoint;}})();}})(typeof exports==='undefined'?this.sax={}:exports);}).call(this,require("buffer").Buffer);},{"buffer":49,"stream":187,"string_decoder":203}],178:[function(require,module,exports){'use strict';module.exports=require('./lib/index');},{"./lib/index":182}],179:[function(require,module,exports){'use strict';var randomFromSeed=require('./random/random-from-seed');var ORIGINAL='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-';var alphabet;var previousSeed;var shuffled;function reset(){shuffled=false;}function setCharacters(_alphabet_){if(!_alphabet_){if(alphabet!==ORIGINAL){alphabet=ORIGINAL;reset();}return;}if(_alphabet_===alphabet){return;}if(_alphabet_.length!==ORIGINAL.length){throw new Error('Custom alphabet for shortid must be '+ORIGINAL.length+' unique characters. You submitted '+_alphabet_.length+' characters: '+_alphabet_);}var unique=_alphabet_.split('').filter(function(item,ind,arr){return ind!==arr.lastIndexOf(item);});if(unique.length){throw new Error('Custom alphabet for shortid must be '+ORIGINAL.length+' unique characters. These characters were not unique: '+unique.join(', '));}alphabet=_alphabet_;reset();}function characters(_alphabet_){setCharacters(_alphabet_);return alphabet;}function setSeed(seed){randomFromSeed.seed(seed);if(previousSeed!==seed){reset();previousSeed=seed;}}function shuffle(){if(!alphabet){setCharacters(ORIGINAL);}var sourceArray=alphabet.split('');var targetArray=[];var r=randomFromSeed.nextValue();var characterIndex;while(sourceArray.length>0){r=randomFromSeed.nextValue();characterIndex=Math.floor(r*sourceArray.length);targetArray.push(sourceArray.splice(characterIndex,1)[0]);}return targetArray.join('');}function getShuffled(){if(shuffled){return shuffled;}shuffled=shuffle();return shuffled;}function lookup(index){var alphabetShuffled=getShuffled();return alphabetShuffled[index];}function get(){return alphabet||ORIGINAL;}module.exports={get:get,characters:characters,seed:setSeed,lookup:lookup,shuffled:getShuffled};},{"./random/random-from-seed":185}],180:[function(require,module,exports){'use strict';var generate=require('./generate');var alphabet=require('./alphabet');var REDUCE_TIME=1459707606518;var version=6;var counter;var previousSeconds;function build(clusterWorkerId){var str='';var seconds=Math.floor((Date.now()-REDUCE_TIME)*0.001);if(seconds===previousSeconds){counter++;}else{counter=0;previousSeconds=seconds;}str=str+generate(version);str=str+generate(clusterWorkerId);if(counter>0){str=str+generate(counter);}str=str+generate(seconds);return str;}module.exports=build;},{"./alphabet":179,"./generate":181}],181:[function(require,module,exports){'use strict';var alphabet=require('./alphabet');var random=require('./random/random-byte');var format=require('nanoid/format');function generate(number){var loopCounter=0;var done;var str='';while(!done){str=str+format(random,alphabet.get(),1);done=number<Math.pow(16,loopCounter+1);loopCounter++;}return str;}module.exports=generate;},{"./alphabet":179,"./random/random-byte":184,"nanoid/format":167}],182:[function(require,module,exports){'use strict';var alphabet=require('./alphabet');var build=require('./build');var isValid=require('./is-valid');var clusterWorkerId=require('./util/cluster-worker-id')||0;function seed(seedValue){alphabet.seed(seedValue);return module.exports;}function worker(workerId){clusterWorkerId=workerId;return module.exports;}function characters(newCharacters){if(newCharacters!==undefined){alphabet.characters(newCharacters);}return alphabet.shuffled();}function generate(){return build(clusterWorkerId);}module.exports=generate;module.exports.generate=generate;module.exports.seed=seed;module.exports.worker=worker;module.exports.characters=characters;module.exports.isValid=isValid;},{"./alphabet":179,"./build":180,"./is-valid":183,"./util/cluster-worker-id":186}],183:[function(require,module,exports){'use strict';var alphabet=require('./alphabet');function isShortId(id){if(!id||typeof id!=='string'||id.length<6){return false;}var nonAlphabetic=new RegExp('[^'+alphabet.get().replace(/[|\\{}()[\]^$+*?.-]/g,'\\$&')+']');return!nonAlphabetic.test(id);}module.exports=isShortId;},{"./alphabet":179}],184:[function(require,module,exports){'use strict';var crypto=(typeof window==="undefined"?"undefined":_typeof(window))==='object'&&(window.crypto||window.msCrypto);var randomByte;if(!crypto||!crypto.getRandomValues){randomByte=function randomByte(size){var bytes=[];for(var i=0;i<size;i++){bytes.push(Math.floor(Math.random()*256));}return bytes;};}else{randomByte=function randomByte(size){return crypto.getRandomValues(new Uint8Array(size));};}module.exports=randomByte;},{}],185:[function(require,module,exports){'use strict';var seed=1;function getNextValue(){seed=(seed*9301+49297)%233280;return seed/233280.0;}function setSeed(_seed_){seed=_seed_;}module.exports={nextValue:getNextValue,seed:setSeed};},{}],186:[function(require,module,exports){'use strict';module.exports=0;},{}],187:[function(require,module,exports){module.exports=Stream;var EE=require('events').EventEmitter;var inherits=require('inherits');inherits(Stream,EE);Stream.Readable=require('readable-stream/readable.js');Stream.Writable=require('readable-stream/writable.js');Stream.Duplex=require('readable-stream/duplex.js');Stream.Transform=require('readable-stream/transform.js');Stream.PassThrough=require('readable-stream/passthrough.js');Stream.Stream=Stream;function Stream(){EE.call(this);}Stream.prototype.pipe=function(dest,options){var source=this;function ondata(chunk){if(dest.writable){if(false===dest.write(chunk)&&source.pause){source.pause();}}}source.on('data',ondata);function ondrain(){if(source.readable&&source.resume){source.resume();}}dest.on('drain',ondrain);if(!dest._isStdio&&(!options||options.end!==false)){source.on('end',onend);source.on('close',onclose);}var didOnEnd=false;function onend(){if(didOnEnd)return;didOnEnd=true;dest.end();}function onclose(){if(didOnEnd)return;didOnEnd=true;if(typeof dest.destroy==='function')dest.destroy();}function onerror(er){cleanup();if(EE.listenerCount(this,'error')===0){throw er;}}source.on('error',onerror);dest.on('error',onerror);function cleanup(){source.removeListener('data',ondata);dest.removeListener('drain',ondrain);source.removeListener('end',onend);source.removeListener('close',onclose);source.removeListener('error',onerror);dest.removeListener('error',onerror);source.removeListener('end',cleanup);source.removeListener('close',cleanup);dest.removeListener('close',cleanup);}source.on('end',cleanup);source.on('close',cleanup);dest.on('close',cleanup);dest.emit('pipe',source);return dest;};},{"events":57,"inherits":94,"readable-stream/duplex.js":189,"readable-stream/passthrough.js":198,"readable-stream/readable.js":199,"readable-stream/transform.js":200,"readable-stream/writable.js":201}],188:[function(require,module,exports){arguments[4][50][0].apply(exports,arguments);},{"dup":50}],189:[function(require,module,exports){module.exports=require('./lib/_stream_duplex.js');},{"./lib/_stream_duplex.js":190}],190:[function(require,module,exports){arguments[4][135][0].apply(exports,arguments);},{"./_stream_readable":192,"./_stream_writable":194,"core-util-is":51,"dup":135,"inherits":94,"process-nextick-args":169}],191:[function(require,module,exports){arguments[4][136][0].apply(exports,arguments);},{"./_stream_transform":193,"core-util-is":51,"dup":136,"inherits":94}],192:[function(require,module,exports){arguments[4][137][0].apply(exports,arguments);},{"./_stream_duplex":190,"./internal/streams/BufferList":195,"./internal/streams/destroy":196,"./internal/streams/stream":197,"_process":170,"core-util-is":51,"dup":137,"events":57,"inherits":94,"isarray":188,"process-nextick-args":169,"safe-buffer":176,"string_decoder/":202,"util":47}],193:[function(require,module,exports){arguments[4][138][0].apply(exports,arguments);},{"./_stream_duplex":190,"core-util-is":51,"dup":138,"inherits":94}],194:[function(require,module,exports){arguments[4][139][0].apply(exports,arguments);},{"./_stream_duplex":190,"./internal/streams/destroy":196,"./internal/streams/stream":197,"_process":170,"core-util-is":51,"dup":139,"inherits":94,"process-nextick-args":169,"safe-buffer":176,"timers":204,"util-deprecate":205}],195:[function(require,module,exports){arguments[4][140][0].apply(exports,arguments);},{"dup":140,"safe-buffer":176,"util":47}],196:[function(require,module,exports){arguments[4][141][0].apply(exports,arguments);},{"dup":141,"process-nextick-args":169}],197:[function(require,module,exports){arguments[4][142][0].apply(exports,arguments);},{"dup":142,"events":57}],198:[function(require,module,exports){module.exports=require('./readable').PassThrough;},{"./readable":199}],199:[function(require,module,exports){arguments[4][143][0].apply(exports,arguments);},{"./lib/_stream_duplex.js":190,"./lib/_stream_passthrough.js":191,"./lib/_stream_readable.js":192,"./lib/_stream_transform.js":193,"./lib/_stream_writable.js":194,"dup":143}],200:[function(require,module,exports){module.exports=require('./readable').Transform;},{"./readable":199}],201:[function(require,module,exports){module.exports=require('./lib/_stream_writable.js');},{"./lib/_stream_writable.js":194}],202:[function(require,module,exports){arguments[4][144][0].apply(exports,arguments);},{"dup":144,"safe-buffer":176}],203:[function(require,module,exports){var Buffer=require('buffer').Buffer;var isBufferEncoding=Buffer.isEncoding||function(encoding){switch(encoding&&encoding.toLowerCase()){case'hex':case'utf8':case'utf-8':case'ascii':case'binary':case'base64':case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':case'raw':return true;default:return false;}};function assertEncoding(encoding){if(encoding&&!isBufferEncoding(encoding)){throw new Error('Unknown encoding: '+encoding);}}var StringDecoder=exports.StringDecoder=function(encoding){this.encoding=(encoding||'utf8').toLowerCase().replace(/[-_]/,'');assertEncoding(encoding);switch(this.encoding){case'utf8':this.surrogateSize=3;break;case'ucs2':case'utf16le':this.surrogateSize=2;this.detectIncompleteChar=utf16DetectIncompleteChar;break;case'base64':this.surrogateSize=3;this.detectIncompleteChar=base64DetectIncompleteChar;break;default:this.write=passThroughWrite;return;}this.charBuffer=new Buffer(6);this.charReceived=0;this.charLength=0;};StringDecoder.prototype.write=function(buffer){var charStr='';while(this.charLength){var available=buffer.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:buffer.length;buffer.copy(this.charBuffer,this.charReceived,0,available);this.charReceived+=available;if(this.charReceived<this.charLength){return'';}buffer=buffer.slice(available,buffer.length);charStr=this.charBuffer.slice(0,this.charLength).toString(this.encoding);var charCode=charStr.charCodeAt(charStr.length-1);if(charCode>=0xD800&&charCode<=0xDBFF){this.charLength+=this.surrogateSize;charStr='';continue;}this.charReceived=this.charLength=0;if(buffer.length===0){return charStr;}break;}this.detectIncompleteChar(buffer);var end=buffer.length;if(this.charLength){buffer.copy(this.charBuffer,0,buffer.length-this.charReceived,end);end-=this.charReceived;}charStr+=buffer.toString(this.encoding,0,end);var end=charStr.length-1;var charCode=charStr.charCodeAt(end);if(charCode>=0xD800&&charCode<=0xDBFF){var size=this.surrogateSize;this.charLength+=size;this.charReceived+=size;this.charBuffer.copy(this.charBuffer,size,0,size);buffer.copy(this.charBuffer,0,0,size);return charStr.substring(0,end);}return charStr;};StringDecoder.prototype.detectIncompleteChar=function(buffer){var i=buffer.length>=3?3:buffer.length;for(;i>0;i--){var c=buffer[buffer.length-i];if(i==1&&c>>5==0x06){this.charLength=2;break;}if(i<=2&&c>>4==0x0E){this.charLength=3;break;}if(i<=3&&c>>3==0x1E){this.charLength=4;break;}}this.charReceived=i;};StringDecoder.prototype.end=function(buffer){var res='';if(buffer&&buffer.length)res=this.write(buffer);if(this.charReceived){var cr=this.charReceived;var buf=this.charBuffer;var enc=this.encoding;res+=buf.slice(0,cr).toString(enc);}return res;};function passThroughWrite(buffer){return buffer.toString(this.encoding);}function utf16DetectIncompleteChar(buffer){this.charReceived=buffer.length%2;this.charLength=this.charReceived?2:0;}function base64DetectIncompleteChar(buffer){this.charReceived=buffer.length%3;this.charLength=this.charReceived?3:0;}},{"buffer":49}],204:[function(require,module,exports){(function(setImmediate,clearImmediate){var nextTick=require('process/browser.js').nextTick;var apply=Function.prototype.apply;var slice=Array.prototype.slice;var immediateIds={};var nextImmediateId=0;exports.setTimeout=function(){return new Timeout(apply.call(setTimeout,window,arguments),clearTimeout);};exports.setInterval=function(){return new Timeout(apply.call(setInterval,window,arguments),clearInterval);};exports.clearTimeout=exports.clearInterval=function(timeout){timeout.close();};function Timeout(id,clearFn){this._id=id;this._clearFn=clearFn;}Timeout.prototype.unref=Timeout.prototype.ref=function(){};Timeout.prototype.close=function(){this._clearFn.call(window,this._id);};exports.enroll=function(item,msecs){clearTimeout(item._idleTimeoutId);item._idleTimeout=msecs;};exports.unenroll=function(item){clearTimeout(item._idleTimeoutId);item._idleTimeout=-1;};exports._unrefActive=exports.active=function(item){clearTimeout(item._idleTimeoutId);var msecs=item._idleTimeout;if(msecs>=0){item._idleTimeoutId=setTimeout(function onTimeout(){if(item._onTimeout)item._onTimeout();},msecs);}};exports.setImmediate=typeof setImmediate==="function"?setImmediate:function(fn){var id=nextImmediateId++;var args=arguments.length<2?false:slice.call(arguments,1);immediateIds[id]=true;nextTick(function onNextTick(){if(immediateIds[id]){if(args){fn.apply(null,args);}else{fn.call(null);}exports.clearImmediate(id);}});return id;};exports.clearImmediate=typeof clearImmediate==="function"?clearImmediate:function(id){delete immediateIds[id];};}).call(this,require("timers").setImmediate,require("timers").clearImmediate);},{"process/browser.js":170,"timers":204}],205:[function(require,module,exports){(function(global){module.exports=deprecate;function deprecate(fn,msg){if(config('noDeprecation')){return fn;}var warned=false;function deprecated(){if(!warned){if(config('throwDeprecation')){throw new Error(msg);}else if(config('traceDeprecation')){console.trace(msg);}else{console.warn(msg);}warned=true;}return fn.apply(this,arguments);}return deprecated;}function config(name){try{if(!global.localStorage)return false;}catch(_){return false;}var val=global.localStorage[name];if(null==val)return false;return String(val).toLowerCase()==='true';}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],206:[function(require,module,exports){if(typeof Object.create==='function'){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}});};}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function TempCtor(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor();ctor.prototype.constructor=ctor;};}},{}],207:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&typeof arg.copy==='function'&&typeof arg.fill==='function'&&typeof arg.readUInt8==='function';};},{}],208:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]));}return objects.join(' ');}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==='%%')return'%';if(i>=len)return x;switch(x){case'%s':return String(args[i++]);case'%d':return Number(args[i++]);case'%j':try{return JSON.stringify(args[i++]);}catch(_){return'[Circular]';}default:return x;}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=' '+x;}else{str+=' '+inspect(x);}}return str;};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments);};}if(process.noDeprecation===true){return fn;}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg);}else if(process.traceDeprecation){console.trace(msg);}else{console.error(msg);}warned=true;}return fn.apply(this,arguments);}return deprecated;};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||'';set=set.toUpperCase();if(!debugs[set]){if(new RegExp('\\b'+set+'\\b','i').test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error('%s %d: %s',set,pid,msg);};}else{debugs[set]=function(){};}}return debugs[set];};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts;}else if(opts){exports._extend(ctx,opts);}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth);}exports.inspect=inspect;inspect.colors={'bold':[1,22],'italic':[3,23],'underline':[4,24],'inverse':[7,27],'white':[37,39],'grey':[90,39],'black':[30,39],'blue':[34,39],'cyan':[36,39],'green':[32,39],'magenta':[35,39],'red':[31,39],'yellow':[33,39]};inspect.styles={'special':'cyan','number':'yellow','boolean':'yellow','undefined':'grey','null':'bold','string':'green','date':'magenta','regexp':'red'};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"\x1B["+inspect.colors[style][0]+'m'+str+"\x1B["+inspect.colors[style][1]+'m';}else{return str;}}function stylizeNoColor(str,styleType){return str;}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true;});return hash;}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes);}return ret;}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive;}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value);}if(isError(value)&&(keys.indexOf('message')>=0||keys.indexOf('description')>=0)){return formatError(value);}if(keys.length===0){if(isFunction(value)){var name=value.name?': '+value.name:'';return ctx.stylize('[Function'+name+']','special');}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),'date');}if(isError(value)){return formatError(value);}}var base='',array=false,braces=['{','}'];if(isArray(value)){array=true;braces=['[',']'];}if(isFunction(value)){var n=value.name?': '+value.name:'';base=' [Function'+n+']';}if(isRegExp(value)){base=' '+RegExp.prototype.toString.call(value);}if(isDate(value)){base=' '+Date.prototype.toUTCString.call(value);}if(isError(value)){base=' '+formatError(value);}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1];}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}else{return ctx.stylize('[Object]','special');}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys);}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array);});}ctx.seen.pop();return reduceToSingleString(output,base,braces);}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize('undefined','undefined');if(isString(value)){var simple='\''+JSON.stringify(value).replace(/^"|"$/g,'').replace(/'/g,"\\'").replace(/\\"/g,'"')+'\'';return ctx.stylize(simple,'string');}if(isNumber(value))return ctx.stylize(''+value,'number');if(isBoolean(value))return ctx.stylize(''+value,'boolean');if(isNull(value))return ctx.stylize('null','null');}function formatError(value){return'['+Error.prototype.toString.call(value)+']';}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true));}else{output.push('');}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true));}});return output;}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize('[Getter/Setter]','special');}else{str=ctx.stylize('[Getter]','special');}}else{if(desc.set){str=ctx.stylize('[Setter]','special');}}if(!hasOwnProperty(visibleKeys,key)){name='['+key+']';}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null);}else{str=formatValue(ctx,desc.value,recurseTimes-1);}if(str.indexOf('\n')>-1){if(array){str=str.split('\n').map(function(line){return'  '+line;}).join('\n').substr(2);}else{str='\n'+str.split('\n').map(function(line){return'   '+line;}).join('\n');}}}else{str=ctx.stylize('[Circular]','special');}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str;}name=JSON.stringify(''+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,'name');}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,'string');}}return name+': '+str;}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf('\n')>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,'').length+1;},0);if(length>60){return braces[0]+(base===''?'':base+'\n ')+' '+output.join(',\n  ')+' '+braces[1];}return braces[0]+base+' '+output.join(', ')+' '+braces[1];}function isArray(ar){return Array.isArray(ar);}exports.isArray=isArray;function isBoolean(arg){return typeof arg==='boolean';}exports.isBoolean=isBoolean;function isNull(arg){return arg===null;}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null;}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==='number';}exports.isNumber=isNumber;function isString(arg){return typeof arg==='string';}exports.isString=isString;function isSymbol(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='symbol';}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0;}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==='[object RegExp]';}exports.isRegExp=isRegExp;function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&arg!==null;}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==='[object Date]';}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==='[object Error]'||e instanceof Error);}exports.isError=isError;function isFunction(arg){return typeof arg==='function';}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==='boolean'||typeof arg==='number'||typeof arg==='string'||(typeof arg==="undefined"?"undefined":_typeof(arg))==='symbol'||typeof arg==='undefined';}exports.isPrimitive=isPrimitive;exports.isBuffer=require('./support/isBuffer');function objectToString(o){return Object.prototype.toString.call(o);}function pad(n){return n<10?'0'+n.toString(10):n.toString(10);}var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];function timestamp(){var d=new Date();var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(':');return[d.getDate(),months[d.getMonth()],time].join(' ');}exports.log=function(){console.log('%s - %s',timestamp(),exports.format.apply(exports,arguments));};exports.inherits=require('inherits');exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]];}return origin;};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}}).call(this,require('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./support/isBuffer":207,"_process":170,"inherits":206}],209:[function(require,module,exports){(function(){"use strict";exports.stripBOM=function(str){if(str[0]==="\uFEFF"){return str.substring(1);}else{return str;}};}).call(this);},{}],210:[function(require,module,exports){(function(){"use strict";var builder,defaults,escapeCDATA,requiresCDATA,wrapCDATA,hasProp={}.hasOwnProperty;builder=require('xmlbuilder');defaults=require('./defaults').defaults;requiresCDATA=function requiresCDATA(entry){return typeof entry==="string"&&(entry.indexOf('&')>=0||entry.indexOf('>')>=0||entry.indexOf('<')>=0);};wrapCDATA=function wrapCDATA(entry){return"<![CDATA["+escapeCDATA(entry)+"]]>";};escapeCDATA=function escapeCDATA(entry){return entry.replace(']]>',']]]]><![CDATA[>');};exports.Builder=function(){function Builder(opts){var key,ref,value;this.options={};ref=defaults["0.2"];for(key in ref){if(!hasProp.call(ref,key))continue;value=ref[key];this.options[key]=value;}for(key in opts){if(!hasProp.call(opts,key))continue;value=opts[key];this.options[key]=value;}}Builder.prototype.buildObject=function(rootObj){var attrkey,charkey,render,rootElement,rootName;attrkey=this.options.attrkey;charkey=this.options.charkey;if(Object.keys(rootObj).length===1&&this.options.rootName===defaults['0.2'].rootName){rootName=Object.keys(rootObj)[0];rootObj=rootObj[rootName];}else{rootName=this.options.rootName;}render=function(_this){return function(element,obj){var attr,child,entry,index,key,value;if((typeof obj==="undefined"?"undefined":_typeof(obj))!=='object'){if(_this.options.cdata&&requiresCDATA(obj)){element.raw(wrapCDATA(obj));}else{element.txt(obj);}}else if(Array.isArray(obj)){for(index in obj){if(!hasProp.call(obj,index))continue;child=obj[index];for(key in child){entry=child[key];element=render(element.ele(key),entry).up();}}}else{for(key in obj){if(!hasProp.call(obj,key))continue;child=obj[key];if(key===attrkey){if((typeof child==="undefined"?"undefined":_typeof(child))==="object"){for(attr in child){value=child[attr];element=element.att(attr,value);}}}else if(key===charkey){if(_this.options.cdata&&requiresCDATA(child)){element=element.raw(wrapCDATA(child));}else{element=element.txt(child);}}else if(Array.isArray(child)){for(index in child){if(!hasProp.call(child,index))continue;entry=child[index];if(typeof entry==='string'){if(_this.options.cdata&&requiresCDATA(entry)){element=element.ele(key).raw(wrapCDATA(entry)).up();}else{element=element.ele(key,entry).up();}}else{element=render(element.ele(key),entry).up();}}}else if((typeof child==="undefined"?"undefined":_typeof(child))==="object"){element=render(element.ele(key),child).up();}else{if(typeof child==='string'&&_this.options.cdata&&requiresCDATA(child)){element=element.ele(key).raw(wrapCDATA(child)).up();}else{if(child==null){child='';}element=element.ele(key,child.toString()).up();}}}}return element;};}(this);rootElement=builder.create(rootName,this.options.xmldec,this.options.doctype,{headless:this.options.headless,allowSurrogateChars:this.options.allowSurrogateChars});return render(rootElement,rootObj).end(this.options.renderOpts);};return Builder;}();}).call(this);},{"./defaults":211,"xmlbuilder":236}],211:[function(require,module,exports){(function(){exports.defaults={"0.1":{explicitCharkey:false,trim:true,normalize:true,normalizeTags:false,attrkey:"@",charkey:"#",explicitArray:false,ignoreAttrs:false,mergeAttrs:false,explicitRoot:false,validator:null,xmlns:false,explicitChildren:false,childkey:'@@',charsAsChildren:false,includeWhiteChars:false,async:false,strict:true,attrNameProcessors:null,attrValueProcessors:null,tagNameProcessors:null,valueProcessors:null,emptyTag:''},"0.2":{explicitCharkey:false,trim:false,normalize:false,normalizeTags:false,attrkey:"$",charkey:"_",explicitArray:true,ignoreAttrs:false,mergeAttrs:false,explicitRoot:true,validator:null,xmlns:false,explicitChildren:false,preserveChildrenOrder:false,childkey:'$$',charsAsChildren:false,includeWhiteChars:false,async:false,strict:true,attrNameProcessors:null,attrValueProcessors:null,tagNameProcessors:null,valueProcessors:null,rootName:'root',xmldec:{'version':'1.0','encoding':'UTF-8','standalone':true},doctype:null,renderOpts:{'pretty':true,'indent':'  ','newline':'\n'},headless:false,chunkSize:10000,emptyTag:'',cdata:false}};}).call(this);},{}],212:[function(require,module,exports){(function(){"use strict";var bom,defaults,events,isEmpty,processItem,processors,sax,setImmediate,bind=function bind(fn,me){return function(){return fn.apply(me,arguments);};},extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;sax=require('sax');events=require('events');bom=require('./bom');processors=require('./processors');setImmediate=require('timers').setImmediate;defaults=require('./defaults').defaults;isEmpty=function isEmpty(thing){return(typeof thing==="undefined"?"undefined":_typeof(thing))==="object"&&thing!=null&&Object.keys(thing).length===0;};processItem=function processItem(processors,item,key){var i,len,process;for(i=0,len=processors.length;i<len;i++){process=processors[i];item=process(item,key);}return item;};exports.Parser=function(superClass){extend(Parser,superClass);function Parser(opts){this.parseString=bind(this.parseString,this);this.reset=bind(this.reset,this);this.assignOrPush=bind(this.assignOrPush,this);this.processAsync=bind(this.processAsync,this);var key,ref,value;if(!(this instanceof exports.Parser)){return new exports.Parser(opts);}this.options={};ref=defaults["0.2"];for(key in ref){if(!hasProp.call(ref,key))continue;value=ref[key];this.options[key]=value;}for(key in opts){if(!hasProp.call(opts,key))continue;value=opts[key];this.options[key]=value;}if(this.options.xmlns){this.options.xmlnskey=this.options.attrkey+"ns";}if(this.options.normalizeTags){if(!this.options.tagNameProcessors){this.options.tagNameProcessors=[];}this.options.tagNameProcessors.unshift(processors.normalize);}this.reset();}Parser.prototype.processAsync=function(){var chunk,err;try{if(this.remaining.length<=this.options.chunkSize){chunk=this.remaining;this.remaining='';this.saxParser=this.saxParser.write(chunk);return this.saxParser.close();}else{chunk=this.remaining.substr(0,this.options.chunkSize);this.remaining=this.remaining.substr(this.options.chunkSize,this.remaining.length);this.saxParser=this.saxParser.write(chunk);return setImmediate(this.processAsync);}}catch(error1){err=error1;if(!this.saxParser.errThrown){this.saxParser.errThrown=true;return this.emit(err);}}};Parser.prototype.assignOrPush=function(obj,key,newValue){if(!(key in obj)){if(!this.options.explicitArray){return obj[key]=newValue;}else{return obj[key]=[newValue];}}else{if(!(obj[key]instanceof Array)){obj[key]=[obj[key]];}return obj[key].push(newValue);}};Parser.prototype.reset=function(){var attrkey,charkey,ontext,stack;this.removeAllListeners();this.saxParser=sax.parser(this.options.strict,{trim:false,normalize:false,xmlns:this.options.xmlns});this.saxParser.errThrown=false;this.saxParser.onerror=function(_this){return function(error){_this.saxParser.resume();if(!_this.saxParser.errThrown){_this.saxParser.errThrown=true;return _this.emit("error",error);}};}(this);this.saxParser.onend=function(_this){return function(){if(!_this.saxParser.ended){_this.saxParser.ended=true;return _this.emit("end",_this.resultObject);}};}(this);this.saxParser.ended=false;this.EXPLICIT_CHARKEY=this.options.explicitCharkey;this.resultObject=null;stack=[];attrkey=this.options.attrkey;charkey=this.options.charkey;this.saxParser.onopentag=function(_this){return function(node){var key,newValue,obj,processedKey,ref;obj={};obj[charkey]="";if(!_this.options.ignoreAttrs){ref=node.attributes;for(key in ref){if(!hasProp.call(ref,key))continue;if(!(attrkey in obj)&&!_this.options.mergeAttrs){obj[attrkey]={};}newValue=_this.options.attrValueProcessors?processItem(_this.options.attrValueProcessors,node.attributes[key],key):node.attributes[key];processedKey=_this.options.attrNameProcessors?processItem(_this.options.attrNameProcessors,key):key;if(_this.options.mergeAttrs){_this.assignOrPush(obj,processedKey,newValue);}else{obj[attrkey][processedKey]=newValue;}}}obj["#name"]=_this.options.tagNameProcessors?processItem(_this.options.tagNameProcessors,node.name):node.name;if(_this.options.xmlns){obj[_this.options.xmlnskey]={uri:node.uri,local:node.local};}return stack.push(obj);};}(this);this.saxParser.onclosetag=function(_this){return function(){var cdata,emptyStr,key,node,nodeName,obj,objClone,old,s,xpath;obj=stack.pop();nodeName=obj["#name"];if(!_this.options.explicitChildren||!_this.options.preserveChildrenOrder){delete obj["#name"];}if(obj.cdata===true){cdata=obj.cdata;delete obj.cdata;}s=stack[stack.length-1];if(obj[charkey].match(/^\s*$/)&&!cdata){emptyStr=obj[charkey];delete obj[charkey];}else{if(_this.options.trim){obj[charkey]=obj[charkey].trim();}if(_this.options.normalize){obj[charkey]=obj[charkey].replace(/\s{2,}/g," ").trim();}obj[charkey]=_this.options.valueProcessors?processItem(_this.options.valueProcessors,obj[charkey],nodeName):obj[charkey];if(Object.keys(obj).length===1&&charkey in obj&&!_this.EXPLICIT_CHARKEY){obj=obj[charkey];}}if(isEmpty(obj)){obj=_this.options.emptyTag!==''?_this.options.emptyTag:emptyStr;}if(_this.options.validator!=null){xpath="/"+function(){var i,len,results;results=[];for(i=0,len=stack.length;i<len;i++){node=stack[i];results.push(node["#name"]);}return results;}().concat(nodeName).join("/");(function(){var err;try{return obj=_this.options.validator(xpath,s&&s[nodeName],obj);}catch(error1){err=error1;return _this.emit("error",err);}})();}if(_this.options.explicitChildren&&!_this.options.mergeAttrs&&(typeof obj==="undefined"?"undefined":_typeof(obj))==='object'){if(!_this.options.preserveChildrenOrder){node={};if(_this.options.attrkey in obj){node[_this.options.attrkey]=obj[_this.options.attrkey];delete obj[_this.options.attrkey];}if(!_this.options.charsAsChildren&&_this.options.charkey in obj){node[_this.options.charkey]=obj[_this.options.charkey];delete obj[_this.options.charkey];}if(Object.getOwnPropertyNames(obj).length>0){node[_this.options.childkey]=obj;}obj=node;}else if(s){s[_this.options.childkey]=s[_this.options.childkey]||[];objClone={};for(key in obj){if(!hasProp.call(obj,key))continue;objClone[key]=obj[key];}s[_this.options.childkey].push(objClone);delete obj["#name"];if(Object.keys(obj).length===1&&charkey in obj&&!_this.EXPLICIT_CHARKEY){obj=obj[charkey];}}}if(stack.length>0){return _this.assignOrPush(s,nodeName,obj);}else{if(_this.options.explicitRoot){old=obj;obj={};obj[nodeName]=old;}_this.resultObject=obj;_this.saxParser.ended=true;return _this.emit("end",_this.resultObject);}};}(this);ontext=function(_this){return function(text){var charChild,s;s=stack[stack.length-1];if(s){s[charkey]+=text;if(_this.options.explicitChildren&&_this.options.preserveChildrenOrder&&_this.options.charsAsChildren&&(_this.options.includeWhiteChars||text.replace(/\\n/g,'').trim()!=='')){s[_this.options.childkey]=s[_this.options.childkey]||[];charChild={'#name':'__text__'};charChild[charkey]=text;if(_this.options.normalize){charChild[charkey]=charChild[charkey].replace(/\s{2,}/g," ").trim();}s[_this.options.childkey].push(charChild);}return s;}};}(this);this.saxParser.ontext=ontext;return this.saxParser.oncdata=function(_this){return function(text){var s;s=ontext(text);if(s){return s.cdata=true;}};}(this);};Parser.prototype.parseString=function(str,cb){var err;if(cb!=null&&typeof cb==="function"){this.on("end",function(result){this.reset();return cb(null,result);});this.on("error",function(err){this.reset();return cb(err);});}try{str=str.toString();if(str.trim()===''){this.emit("end",null);return true;}str=bom.stripBOM(str);if(this.options.async){this.remaining=str;setImmediate(this.processAsync);return this.saxParser;}return this.saxParser.write(str).close();}catch(error1){err=error1;if(!(this.saxParser.errThrown||this.saxParser.ended)){this.emit('error',err);return this.saxParser.errThrown=true;}else if(this.saxParser.ended){throw err;}}};return Parser;}(events.EventEmitter);exports.parseString=function(str,a,b){var cb,options,parser;if(b!=null){if(typeof b==='function'){cb=b;}if((typeof a==="undefined"?"undefined":_typeof(a))==='object'){options=a;}}else{if(typeof a==='function'){cb=a;}options={};}parser=new exports.Parser(options);return parser.parseString(str,cb);};}).call(this);},{"./bom":209,"./defaults":211,"./processors":213,"events":57,"sax":177,"timers":204}],213:[function(require,module,exports){(function(){"use strict";var prefixMatch;prefixMatch=new RegExp(/(?!xmlns)^.*:/);exports.normalize=function(str){return str.toLowerCase();};exports.firstCharLowerCase=function(str){return str.charAt(0).toLowerCase()+str.slice(1);};exports.stripPrefix=function(str){return str.replace(prefixMatch,'');};exports.parseNumbers=function(str){if(!isNaN(str)){str=str%1===0?parseInt(str,10):parseFloat(str);}return str;};exports.parseBooleans=function(str){if(/^(?:true|false)$/i.test(str)){str=str.toLowerCase()==='true';}return str;};}).call(this);},{}],214:[function(require,module,exports){(function(){"use strict";var builder,defaults,parser,processors,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;defaults=require('./defaults');builder=require('./builder');parser=require('./parser');processors=require('./processors');exports.defaults=defaults.defaults;exports.processors=processors;exports.ValidationError=function(superClass){extend(ValidationError,superClass);function ValidationError(message){this.message=message;}return ValidationError;}(Error);exports.Builder=builder.Builder;exports.Parser=parser.Parser;exports.parseString=parser.parseString;}).call(this);},{"./builder":210,"./defaults":211,"./parser":212,"./processors":213}],215:[function(require,module,exports){(function(){var assign,isArray,isEmpty,isFunction,isObject,isPlainObject,slice=[].slice,hasProp={}.hasOwnProperty;assign=function assign(){var i,key,len,source,sources,target;target=arguments[0],sources=2<=arguments.length?slice.call(arguments,1):[];if(isFunction(Object.assign)){Object.assign.apply(null,arguments);}else{for(i=0,len=sources.length;i<len;i++){source=sources[i];if(source!=null){for(key in source){if(!hasProp.call(source,key))continue;target[key]=source[key];}}}}return target;};isFunction=function isFunction(val){return!!val&&Object.prototype.toString.call(val)==='[object Function]';};isObject=function isObject(val){var ref;return!!val&&((ref=typeof val==="undefined"?"undefined":_typeof(val))==='function'||ref==='object');};isArray=function isArray(val){if(isFunction(Array.isArray)){return Array.isArray(val);}else{return Object.prototype.toString.call(val)==='[object Array]';}};isEmpty=function isEmpty(val){var key;if(isArray(val)){return!val.length;}else{for(key in val){if(!hasProp.call(val,key))continue;return false;}return true;}};isPlainObject=function isPlainObject(val){var ctor,proto;return isObject(val)&&(proto=Object.getPrototypeOf(val))&&(ctor=proto.constructor)&&typeof ctor==='function'&&ctor instanceof ctor&&Function.prototype.toString.call(ctor)===Function.prototype.toString.call(Object);};module.exports.assign=assign;module.exports.isFunction=isFunction;module.exports.isObject=isObject;module.exports.isArray=isArray;module.exports.isEmpty=isEmpty;module.exports.isPlainObject=isPlainObject;}).call(this);},{}],216:[function(require,module,exports){(function(){var XMLAttribute;module.exports=XMLAttribute=function(){function XMLAttribute(parent,name,value){this.options=parent.options;this.stringify=parent.stringify;if(name==null){throw new Error("Missing attribute name of element "+parent.name);}if(value==null){throw new Error("Missing attribute value for attribute "+name+" of element "+parent.name);}this.name=this.stringify.attName(name);this.value=this.stringify.attValue(value);}XMLAttribute.prototype.clone=function(){return Object.create(this);};XMLAttribute.prototype.toString=function(options){return this.options.writer.set(options).attribute(this);};return XMLAttribute;}();}).call(this);},{}],217:[function(require,module,exports){(function(){var XMLCData,XMLNode,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLNode=require('./XMLNode');module.exports=XMLCData=function(superClass){extend(XMLCData,superClass);function XMLCData(parent,text){XMLCData.__super__.constructor.call(this,parent);if(text==null){throw new Error("Missing CDATA text");}this.text=this.stringify.cdata(text);}XMLCData.prototype.clone=function(){return Object.create(this);};XMLCData.prototype.toString=function(options){return this.options.writer.set(options).cdata(this);};return XMLCData;}(XMLNode);}).call(this);},{"./XMLNode":228}],218:[function(require,module,exports){(function(){var XMLComment,XMLNode,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLNode=require('./XMLNode');module.exports=XMLComment=function(superClass){extend(XMLComment,superClass);function XMLComment(parent,text){XMLComment.__super__.constructor.call(this,parent);if(text==null){throw new Error("Missing comment text");}this.text=this.stringify.comment(text);}XMLComment.prototype.clone=function(){return Object.create(this);};XMLComment.prototype.toString=function(options){return this.options.writer.set(options).comment(this);};return XMLComment;}(XMLNode);}).call(this);},{"./XMLNode":228}],219:[function(require,module,exports){(function(){var XMLDTDAttList,XMLNode,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLNode=require('./XMLNode');module.exports=XMLDTDAttList=function(superClass){extend(XMLDTDAttList,superClass);function XMLDTDAttList(parent,elementName,attributeName,attributeType,defaultValueType,defaultValue){XMLDTDAttList.__super__.constructor.call(this,parent);if(elementName==null){throw new Error("Missing DTD element name");}if(attributeName==null){throw new Error("Missing DTD attribute name");}if(!attributeType){throw new Error("Missing DTD attribute type");}if(!defaultValueType){throw new Error("Missing DTD attribute default");}if(defaultValueType.indexOf('#')!==0){defaultValueType='#'+defaultValueType;}if(!defaultValueType.match(/^(#REQUIRED|#IMPLIED|#FIXED|#DEFAULT)$/)){throw new Error("Invalid default value type; expected: #REQUIRED, #IMPLIED, #FIXED or #DEFAULT");}if(defaultValue&&!defaultValueType.match(/^(#FIXED|#DEFAULT)$/)){throw new Error("Default value only applies to #FIXED or #DEFAULT");}this.elementName=this.stringify.eleName(elementName);this.attributeName=this.stringify.attName(attributeName);this.attributeType=this.stringify.dtdAttType(attributeType);this.defaultValue=this.stringify.dtdAttDefault(defaultValue);this.defaultValueType=defaultValueType;}XMLDTDAttList.prototype.toString=function(options){return this.options.writer.set(options).dtdAttList(this);};return XMLDTDAttList;}(XMLNode);}).call(this);},{"./XMLNode":228}],220:[function(require,module,exports){(function(){var XMLDTDElement,XMLNode,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLNode=require('./XMLNode');module.exports=XMLDTDElement=function(superClass){extend(XMLDTDElement,superClass);function XMLDTDElement(parent,name,value){XMLDTDElement.__super__.constructor.call(this,parent);if(name==null){throw new Error("Missing DTD element name");}if(!value){value='(#PCDATA)';}if(Array.isArray(value)){value='('+value.join(',')+')';}this.name=this.stringify.eleName(name);this.value=this.stringify.dtdElementValue(value);}XMLDTDElement.prototype.toString=function(options){return this.options.writer.set(options).dtdElement(this);};return XMLDTDElement;}(XMLNode);}).call(this);},{"./XMLNode":228}],221:[function(require,module,exports){(function(){var XMLDTDEntity,XMLNode,isObject,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;isObject=require('./Utility').isObject;XMLNode=require('./XMLNode');module.exports=XMLDTDEntity=function(superClass){extend(XMLDTDEntity,superClass);function XMLDTDEntity(parent,pe,name,value){XMLDTDEntity.__super__.constructor.call(this,parent);if(name==null){throw new Error("Missing entity name");}if(value==null){throw new Error("Missing entity value");}this.pe=!!pe;this.name=this.stringify.eleName(name);if(!isObject(value)){this.value=this.stringify.dtdEntityValue(value);}else{if(!value.pubID&&!value.sysID){throw new Error("Public and/or system identifiers are required for an external entity");}if(value.pubID&&!value.sysID){throw new Error("System identifier is required for a public external entity");}if(value.pubID!=null){this.pubID=this.stringify.dtdPubID(value.pubID);}if(value.sysID!=null){this.sysID=this.stringify.dtdSysID(value.sysID);}if(value.nData!=null){this.nData=this.stringify.dtdNData(value.nData);}if(this.pe&&this.nData){throw new Error("Notation declaration is not allowed in a parameter entity");}}}XMLDTDEntity.prototype.toString=function(options){return this.options.writer.set(options).dtdEntity(this);};return XMLDTDEntity;}(XMLNode);}).call(this);},{"./Utility":215,"./XMLNode":228}],222:[function(require,module,exports){(function(){var XMLDTDNotation,XMLNode,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLNode=require('./XMLNode');module.exports=XMLDTDNotation=function(superClass){extend(XMLDTDNotation,superClass);function XMLDTDNotation(parent,name,value){XMLDTDNotation.__super__.constructor.call(this,parent);if(name==null){throw new Error("Missing notation name");}if(!value.pubID&&!value.sysID){throw new Error("Public or system identifiers are required for an external entity");}this.name=this.stringify.eleName(name);if(value.pubID!=null){this.pubID=this.stringify.dtdPubID(value.pubID);}if(value.sysID!=null){this.sysID=this.stringify.dtdSysID(value.sysID);}}XMLDTDNotation.prototype.toString=function(options){return this.options.writer.set(options).dtdNotation(this);};return XMLDTDNotation;}(XMLNode);}).call(this);},{"./XMLNode":228}],223:[function(require,module,exports){(function(){var XMLDeclaration,XMLNode,isObject,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;isObject=require('./Utility').isObject;XMLNode=require('./XMLNode');module.exports=XMLDeclaration=function(superClass){extend(XMLDeclaration,superClass);function XMLDeclaration(parent,version,encoding,standalone){var ref;XMLDeclaration.__super__.constructor.call(this,parent);if(isObject(version)){ref=version,version=ref.version,encoding=ref.encoding,standalone=ref.standalone;}if(!version){version='1.0';}this.version=this.stringify.xmlVersion(version);if(encoding!=null){this.encoding=this.stringify.xmlEncoding(encoding);}if(standalone!=null){this.standalone=this.stringify.xmlStandalone(standalone);}}XMLDeclaration.prototype.toString=function(options){return this.options.writer.set(options).declaration(this);};return XMLDeclaration;}(XMLNode);}).call(this);},{"./Utility":215,"./XMLNode":228}],224:[function(require,module,exports){(function(){var XMLDTDAttList,XMLDTDElement,XMLDTDEntity,XMLDTDNotation,XMLDocType,XMLNode,isObject,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;isObject=require('./Utility').isObject;XMLNode=require('./XMLNode');XMLDTDAttList=require('./XMLDTDAttList');XMLDTDEntity=require('./XMLDTDEntity');XMLDTDElement=require('./XMLDTDElement');XMLDTDNotation=require('./XMLDTDNotation');module.exports=XMLDocType=function(superClass){extend(XMLDocType,superClass);function XMLDocType(parent,pubID,sysID){var ref,ref1;XMLDocType.__super__.constructor.call(this,parent);this.documentObject=parent;if(isObject(pubID)){ref=pubID,pubID=ref.pubID,sysID=ref.sysID;}if(sysID==null){ref1=[pubID,sysID],sysID=ref1[0],pubID=ref1[1];}if(pubID!=null){this.pubID=this.stringify.dtdPubID(pubID);}if(sysID!=null){this.sysID=this.stringify.dtdSysID(sysID);}}XMLDocType.prototype.element=function(name,value){var child;child=new XMLDTDElement(this,name,value);this.children.push(child);return this;};XMLDocType.prototype.attList=function(elementName,attributeName,attributeType,defaultValueType,defaultValue){var child;child=new XMLDTDAttList(this,elementName,attributeName,attributeType,defaultValueType,defaultValue);this.children.push(child);return this;};XMLDocType.prototype.entity=function(name,value){var child;child=new XMLDTDEntity(this,false,name,value);this.children.push(child);return this;};XMLDocType.prototype.pEntity=function(name,value){var child;child=new XMLDTDEntity(this,true,name,value);this.children.push(child);return this;};XMLDocType.prototype.notation=function(name,value){var child;child=new XMLDTDNotation(this,name,value);this.children.push(child);return this;};XMLDocType.prototype.toString=function(options){return this.options.writer.set(options).docType(this);};XMLDocType.prototype.ele=function(name,value){return this.element(name,value);};XMLDocType.prototype.att=function(elementName,attributeName,attributeType,defaultValueType,defaultValue){return this.attList(elementName,attributeName,attributeType,defaultValueType,defaultValue);};XMLDocType.prototype.ent=function(name,value){return this.entity(name,value);};XMLDocType.prototype.pent=function(name,value){return this.pEntity(name,value);};XMLDocType.prototype.not=function(name,value){return this.notation(name,value);};XMLDocType.prototype.up=function(){return this.root()||this.documentObject;};return XMLDocType;}(XMLNode);}).call(this);},{"./Utility":215,"./XMLDTDAttList":219,"./XMLDTDElement":220,"./XMLDTDEntity":221,"./XMLDTDNotation":222,"./XMLNode":228}],225:[function(require,module,exports){(function(){var XMLDocument,XMLNode,XMLStringWriter,XMLStringifier,isPlainObject,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;isPlainObject=require('./Utility').isPlainObject;XMLNode=require('./XMLNode');XMLStringifier=require('./XMLStringifier');XMLStringWriter=require('./XMLStringWriter');module.exports=XMLDocument=function(superClass){extend(XMLDocument,superClass);function XMLDocument(options){XMLDocument.__super__.constructor.call(this,null);options||(options={});if(!options.writer){options.writer=new XMLStringWriter();}this.options=options;this.stringify=new XMLStringifier(options);this.isDocument=true;}XMLDocument.prototype.end=function(writer){var writerOptions;if(!writer){writer=this.options.writer;}else if(isPlainObject(writer)){writerOptions=writer;writer=this.options.writer.set(writerOptions);}return writer.document(this);};XMLDocument.prototype.toString=function(options){return this.options.writer.set(options).document(this);};return XMLDocument;}(XMLNode);}).call(this);},{"./Utility":215,"./XMLNode":228,"./XMLStringWriter":232,"./XMLStringifier":233}],226:[function(require,module,exports){(function(){var XMLAttribute,XMLCData,XMLComment,XMLDTDAttList,XMLDTDElement,XMLDTDEntity,XMLDTDNotation,XMLDeclaration,XMLDocType,XMLDocumentCB,XMLElement,XMLProcessingInstruction,XMLRaw,XMLStringWriter,XMLStringifier,XMLText,isFunction,isObject,isPlainObject,ref,hasProp={}.hasOwnProperty;ref=require('./Utility'),isObject=ref.isObject,isFunction=ref.isFunction,isPlainObject=ref.isPlainObject;XMLElement=require('./XMLElement');XMLCData=require('./XMLCData');XMLComment=require('./XMLComment');XMLRaw=require('./XMLRaw');XMLText=require('./XMLText');XMLProcessingInstruction=require('./XMLProcessingInstruction');XMLDeclaration=require('./XMLDeclaration');XMLDocType=require('./XMLDocType');XMLDTDAttList=require('./XMLDTDAttList');XMLDTDEntity=require('./XMLDTDEntity');XMLDTDElement=require('./XMLDTDElement');XMLDTDNotation=require('./XMLDTDNotation');XMLAttribute=require('./XMLAttribute');XMLStringifier=require('./XMLStringifier');XMLStringWriter=require('./XMLStringWriter');module.exports=XMLDocumentCB=function(){function XMLDocumentCB(options,onData,onEnd){var writerOptions;options||(options={});if(!options.writer){options.writer=new XMLStringWriter(options);}else if(isPlainObject(options.writer)){writerOptions=options.writer;options.writer=new XMLStringWriter(writerOptions);}this.options=options;this.writer=options.writer;this.stringify=new XMLStringifier(options);this.onDataCallback=onData||function(){};this.onEndCallback=onEnd||function(){};this.currentNode=null;this.currentLevel=-1;this.openTags={};this.documentStarted=false;this.documentCompleted=false;this.root=null;}XMLDocumentCB.prototype.node=function(name,attributes,text){var ref1;if(name==null){throw new Error("Missing node name");}if(this.root&&this.currentLevel===-1){throw new Error("Document can only have one root node");}this.openCurrent();name=name.valueOf();if(attributes==null){attributes={};}attributes=attributes.valueOf();if(!isObject(attributes)){ref1=[attributes,text],text=ref1[0],attributes=ref1[1];}this.currentNode=new XMLElement(this,name,attributes);this.currentNode.children=false;this.currentLevel++;this.openTags[this.currentLevel]=this.currentNode;if(text!=null){this.text(text);}return this;};XMLDocumentCB.prototype.element=function(name,attributes,text){if(this.currentNode&&this.currentNode instanceof XMLDocType){return this.dtdElement.apply(this,arguments);}else{return this.node(name,attributes,text);}};XMLDocumentCB.prototype.attribute=function(name,value){var attName,attValue;if(!this.currentNode||this.currentNode.children){throw new Error("att() can only be used immediately after an ele() call in callback mode");}if(name!=null){name=name.valueOf();}if(isObject(name)){for(attName in name){if(!hasProp.call(name,attName))continue;attValue=name[attName];this.attribute(attName,attValue);}}else{if(isFunction(value)){value=value.apply();}if(!this.options.skipNullAttributes||value!=null){this.currentNode.attributes[name]=new XMLAttribute(this,name,value);}}return this;};XMLDocumentCB.prototype.text=function(value){var node;this.openCurrent();node=new XMLText(this,value);this.onData(this.writer.text(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.cdata=function(value){var node;this.openCurrent();node=new XMLCData(this,value);this.onData(this.writer.cdata(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.comment=function(value){var node;this.openCurrent();node=new XMLComment(this,value);this.onData(this.writer.comment(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.raw=function(value){var node;this.openCurrent();node=new XMLRaw(this,value);this.onData(this.writer.raw(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.instruction=function(target,value){var i,insTarget,insValue,len,node;this.openCurrent();if(target!=null){target=target.valueOf();}if(value!=null){value=value.valueOf();}if(Array.isArray(target)){for(i=0,len=target.length;i<len;i++){insTarget=target[i];this.instruction(insTarget);}}else if(isObject(target)){for(insTarget in target){if(!hasProp.call(target,insTarget))continue;insValue=target[insTarget];this.instruction(insTarget,insValue);}}else{if(isFunction(value)){value=value.apply();}node=new XMLProcessingInstruction(this,target,value);this.onData(this.writer.processingInstruction(node,this.currentLevel+1));}return this;};XMLDocumentCB.prototype.declaration=function(version,encoding,standalone){var node;this.openCurrent();if(this.documentStarted){throw new Error("declaration() must be the first node");}node=new XMLDeclaration(this,version,encoding,standalone);this.onData(this.writer.declaration(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.doctype=function(root,pubID,sysID){this.openCurrent();if(root==null){throw new Error("Missing root node name");}if(this.root){throw new Error("dtd() must come before the root node");}this.currentNode=new XMLDocType(this,pubID,sysID);this.currentNode.rootNodeName=root;this.currentNode.children=false;this.currentLevel++;this.openTags[this.currentLevel]=this.currentNode;return this;};XMLDocumentCB.prototype.dtdElement=function(name,value){var node;this.openCurrent();node=new XMLDTDElement(this,name,value);this.onData(this.writer.dtdElement(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.attList=function(elementName,attributeName,attributeType,defaultValueType,defaultValue){var node;this.openCurrent();node=new XMLDTDAttList(this,elementName,attributeName,attributeType,defaultValueType,defaultValue);this.onData(this.writer.dtdAttList(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.entity=function(name,value){var node;this.openCurrent();node=new XMLDTDEntity(this,false,name,value);this.onData(this.writer.dtdEntity(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.pEntity=function(name,value){var node;this.openCurrent();node=new XMLDTDEntity(this,true,name,value);this.onData(this.writer.dtdEntity(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.notation=function(name,value){var node;this.openCurrent();node=new XMLDTDNotation(this,name,value);this.onData(this.writer.dtdNotation(node,this.currentLevel+1));return this;};XMLDocumentCB.prototype.up=function(){if(this.currentLevel<0){throw new Error("The document node has no parent");}if(this.currentNode){if(this.currentNode.children){this.closeNode(this.currentNode);}else{this.openNode(this.currentNode);}this.currentNode=null;}else{this.closeNode(this.openTags[this.currentLevel]);}delete this.openTags[this.currentLevel];this.currentLevel--;return this;};XMLDocumentCB.prototype.end=function(){while(this.currentLevel>=0){this.up();}return this.onEnd();};XMLDocumentCB.prototype.openCurrent=function(){if(this.currentNode){this.currentNode.children=true;return this.openNode(this.currentNode);}};XMLDocumentCB.prototype.openNode=function(node){if(!node.isOpen){if(!this.root&&this.currentLevel===0&&node instanceof XMLElement){this.root=node;}this.onData(this.writer.openNode(node,this.currentLevel));return node.isOpen=true;}};XMLDocumentCB.prototype.closeNode=function(node){if(!node.isClosed){this.onData(this.writer.closeNode(node,this.currentLevel));return node.isClosed=true;}};XMLDocumentCB.prototype.onData=function(chunk){this.documentStarted=true;return this.onDataCallback(chunk);};XMLDocumentCB.prototype.onEnd=function(){this.documentCompleted=true;return this.onEndCallback();};XMLDocumentCB.prototype.ele=function(){return this.element.apply(this,arguments);};XMLDocumentCB.prototype.nod=function(name,attributes,text){return this.node(name,attributes,text);};XMLDocumentCB.prototype.txt=function(value){return this.text(value);};XMLDocumentCB.prototype.dat=function(value){return this.cdata(value);};XMLDocumentCB.prototype.com=function(value){return this.comment(value);};XMLDocumentCB.prototype.ins=function(target,value){return this.instruction(target,value);};XMLDocumentCB.prototype.dec=function(version,encoding,standalone){return this.declaration(version,encoding,standalone);};XMLDocumentCB.prototype.dtd=function(root,pubID,sysID){return this.doctype(root,pubID,sysID);};XMLDocumentCB.prototype.e=function(name,attributes,text){return this.element(name,attributes,text);};XMLDocumentCB.prototype.n=function(name,attributes,text){return this.node(name,attributes,text);};XMLDocumentCB.prototype.t=function(value){return this.text(value);};XMLDocumentCB.prototype.d=function(value){return this.cdata(value);};XMLDocumentCB.prototype.c=function(value){return this.comment(value);};XMLDocumentCB.prototype.r=function(value){return this.raw(value);};XMLDocumentCB.prototype.i=function(target,value){return this.instruction(target,value);};XMLDocumentCB.prototype.att=function(){if(this.currentNode&&this.currentNode instanceof XMLDocType){return this.attList.apply(this,arguments);}else{return this.attribute.apply(this,arguments);}};XMLDocumentCB.prototype.a=function(){if(this.currentNode&&this.currentNode instanceof XMLDocType){return this.attList.apply(this,arguments);}else{return this.attribute.apply(this,arguments);}};XMLDocumentCB.prototype.ent=function(name,value){return this.entity(name,value);};XMLDocumentCB.prototype.pent=function(name,value){return this.pEntity(name,value);};XMLDocumentCB.prototype.not=function(name,value){return this.notation(name,value);};return XMLDocumentCB;}();}).call(this);},{"./Utility":215,"./XMLAttribute":216,"./XMLCData":217,"./XMLComment":218,"./XMLDTDAttList":219,"./XMLDTDElement":220,"./XMLDTDEntity":221,"./XMLDTDNotation":222,"./XMLDeclaration":223,"./XMLDocType":224,"./XMLElement":227,"./XMLProcessingInstruction":229,"./XMLRaw":230,"./XMLStringWriter":232,"./XMLStringifier":233,"./XMLText":234}],227:[function(require,module,exports){(function(){var XMLAttribute,XMLElement,XMLNode,isFunction,isObject,ref,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;ref=require('./Utility'),isObject=ref.isObject,isFunction=ref.isFunction;XMLNode=require('./XMLNode');XMLAttribute=require('./XMLAttribute');module.exports=XMLElement=function(superClass){extend(XMLElement,superClass);function XMLElement(parent,name,attributes){XMLElement.__super__.constructor.call(this,parent);if(name==null){throw new Error("Missing element name");}this.name=this.stringify.eleName(name);this.attributes={};if(attributes!=null){this.attribute(attributes);}if(parent.isDocument){this.isRoot=true;this.documentObject=parent;parent.rootObject=this;}}XMLElement.prototype.clone=function(){var att,attName,clonedSelf,ref1;clonedSelf=Object.create(this);if(clonedSelf.isRoot){clonedSelf.documentObject=null;}clonedSelf.attributes={};ref1=this.attributes;for(attName in ref1){if(!hasProp.call(ref1,attName))continue;att=ref1[attName];clonedSelf.attributes[attName]=att.clone();}clonedSelf.children=[];this.children.forEach(function(child){var clonedChild;clonedChild=child.clone();clonedChild.parent=clonedSelf;return clonedSelf.children.push(clonedChild);});return clonedSelf;};XMLElement.prototype.attribute=function(name,value){var attName,attValue;if(name!=null){name=name.valueOf();}if(isObject(name)){for(attName in name){if(!hasProp.call(name,attName))continue;attValue=name[attName];this.attribute(attName,attValue);}}else{if(isFunction(value)){value=value.apply();}if(!this.options.skipNullAttributes||value!=null){this.attributes[name]=new XMLAttribute(this,name,value);}}return this;};XMLElement.prototype.removeAttribute=function(name){var attName,i,len;if(name==null){throw new Error("Missing attribute name");}name=name.valueOf();if(Array.isArray(name)){for(i=0,len=name.length;i<len;i++){attName=name[i];delete this.attributes[attName];}}else{delete this.attributes[name];}return this;};XMLElement.prototype.toString=function(options){return this.options.writer.set(options).element(this);};XMLElement.prototype.att=function(name,value){return this.attribute(name,value);};XMLElement.prototype.a=function(name,value){return this.attribute(name,value);};return XMLElement;}(XMLNode);}).call(this);},{"./Utility":215,"./XMLAttribute":216,"./XMLNode":228}],228:[function(require,module,exports){(function(){var XMLCData,XMLComment,XMLDeclaration,XMLDocType,XMLElement,XMLNode,XMLProcessingInstruction,XMLRaw,XMLText,isEmpty,isFunction,isObject,ref,hasProp={}.hasOwnProperty;ref=require('./Utility'),isObject=ref.isObject,isFunction=ref.isFunction,isEmpty=ref.isEmpty;XMLElement=null;XMLCData=null;XMLComment=null;XMLDeclaration=null;XMLDocType=null;XMLRaw=null;XMLText=null;XMLProcessingInstruction=null;module.exports=XMLNode=function(){function XMLNode(parent){this.parent=parent;if(this.parent){this.options=this.parent.options;this.stringify=this.parent.stringify;}this.children=[];if(!XMLElement){XMLElement=require('./XMLElement');XMLCData=require('./XMLCData');XMLComment=require('./XMLComment');XMLDeclaration=require('./XMLDeclaration');XMLDocType=require('./XMLDocType');XMLRaw=require('./XMLRaw');XMLText=require('./XMLText');XMLProcessingInstruction=require('./XMLProcessingInstruction');}}XMLNode.prototype.element=function(name,attributes,text){var childNode,item,j,k,key,lastChild,len,len1,ref1,val;lastChild=null;if(attributes==null){attributes={};}attributes=attributes.valueOf();if(!isObject(attributes)){ref1=[attributes,text],text=ref1[0],attributes=ref1[1];}if(name!=null){name=name.valueOf();}if(Array.isArray(name)){for(j=0,len=name.length;j<len;j++){item=name[j];lastChild=this.element(item);}}else if(isFunction(name)){lastChild=this.element(name.apply());}else if(isObject(name)){for(key in name){if(!hasProp.call(name,key))continue;val=name[key];if(isFunction(val)){val=val.apply();}if(isObject(val)&&isEmpty(val)){val=null;}if(!this.options.ignoreDecorators&&this.stringify.convertAttKey&&key.indexOf(this.stringify.convertAttKey)===0){lastChild=this.attribute(key.substr(this.stringify.convertAttKey.length),val);}else if(!this.options.separateArrayItems&&Array.isArray(val)){for(k=0,len1=val.length;k<len1;k++){item=val[k];childNode={};childNode[key]=item;lastChild=this.element(childNode);}}else if(isObject(val)){lastChild=this.element(key);lastChild.element(val);}else{lastChild=this.element(key,val);}}}else{if(!this.options.ignoreDecorators&&this.stringify.convertTextKey&&name.indexOf(this.stringify.convertTextKey)===0){lastChild=this.text(text);}else if(!this.options.ignoreDecorators&&this.stringify.convertCDataKey&&name.indexOf(this.stringify.convertCDataKey)===0){lastChild=this.cdata(text);}else if(!this.options.ignoreDecorators&&this.stringify.convertCommentKey&&name.indexOf(this.stringify.convertCommentKey)===0){lastChild=this.comment(text);}else if(!this.options.ignoreDecorators&&this.stringify.convertRawKey&&name.indexOf(this.stringify.convertRawKey)===0){lastChild=this.raw(text);}else if(!this.options.ignoreDecorators&&this.stringify.convertPIKey&&name.indexOf(this.stringify.convertPIKey)===0){lastChild=this.instruction(name.substr(this.stringify.convertPIKey.length),text);}else{lastChild=this.node(name,attributes,text);}}if(lastChild==null){throw new Error("Could not create any elements with: "+name);}return lastChild;};XMLNode.prototype.insertBefore=function(name,attributes,text){var child,i,removed;if(this.isRoot){throw new Error("Cannot insert elements at root level");}i=this.parent.children.indexOf(this);removed=this.parent.children.splice(i);child=this.parent.element(name,attributes,text);Array.prototype.push.apply(this.parent.children,removed);return child;};XMLNode.prototype.insertAfter=function(name,attributes,text){var child,i,removed;if(this.isRoot){throw new Error("Cannot insert elements at root level");}i=this.parent.children.indexOf(this);removed=this.parent.children.splice(i+1);child=this.parent.element(name,attributes,text);Array.prototype.push.apply(this.parent.children,removed);return child;};XMLNode.prototype.remove=function(){var i,ref1;if(this.isRoot){throw new Error("Cannot remove the root element");}i=this.parent.children.indexOf(this);[].splice.apply(this.parent.children,[i,i-i+1].concat(ref1=[])),ref1;return this.parent;};XMLNode.prototype.node=function(name,attributes,text){var child,ref1;if(name!=null){name=name.valueOf();}attributes||(attributes={});attributes=attributes.valueOf();if(!isObject(attributes)){ref1=[attributes,text],text=ref1[0],attributes=ref1[1];}child=new XMLElement(this,name,attributes);if(text!=null){child.text(text);}this.children.push(child);return child;};XMLNode.prototype.text=function(value){var child;child=new XMLText(this,value);this.children.push(child);return this;};XMLNode.prototype.cdata=function(value){var child;child=new XMLCData(this,value);this.children.push(child);return this;};XMLNode.prototype.comment=function(value){var child;child=new XMLComment(this,value);this.children.push(child);return this;};XMLNode.prototype.commentBefore=function(value){var child,i,removed;i=this.parent.children.indexOf(this);removed=this.parent.children.splice(i);child=this.parent.comment(value);Array.prototype.push.apply(this.parent.children,removed);return this;};XMLNode.prototype.commentAfter=function(value){var child,i,removed;i=this.parent.children.indexOf(this);removed=this.parent.children.splice(i+1);child=this.parent.comment(value);Array.prototype.push.apply(this.parent.children,removed);return this;};XMLNode.prototype.raw=function(value){var child;child=new XMLRaw(this,value);this.children.push(child);return this;};XMLNode.prototype.instruction=function(target,value){var insTarget,insValue,instruction,j,len;if(target!=null){target=target.valueOf();}if(value!=null){value=value.valueOf();}if(Array.isArray(target)){for(j=0,len=target.length;j<len;j++){insTarget=target[j];this.instruction(insTarget);}}else if(isObject(target)){for(insTarget in target){if(!hasProp.call(target,insTarget))continue;insValue=target[insTarget];this.instruction(insTarget,insValue);}}else{if(isFunction(value)){value=value.apply();}instruction=new XMLProcessingInstruction(this,target,value);this.children.push(instruction);}return this;};XMLNode.prototype.instructionBefore=function(target,value){var child,i,removed;i=this.parent.children.indexOf(this);removed=this.parent.children.splice(i);child=this.parent.instruction(target,value);Array.prototype.push.apply(this.parent.children,removed);return this;};XMLNode.prototype.instructionAfter=function(target,value){var child,i,removed;i=this.parent.children.indexOf(this);removed=this.parent.children.splice(i+1);child=this.parent.instruction(target,value);Array.prototype.push.apply(this.parent.children,removed);return this;};XMLNode.prototype.declaration=function(version,encoding,standalone){var doc,xmldec;doc=this.document();xmldec=new XMLDeclaration(doc,version,encoding,standalone);if(doc.children[0]instanceof XMLDeclaration){doc.children[0]=xmldec;}else{doc.children.unshift(xmldec);}return doc.root()||doc;};XMLNode.prototype.doctype=function(pubID,sysID){var child,doc,doctype,i,j,k,len,len1,ref1,ref2;doc=this.document();doctype=new XMLDocType(doc,pubID,sysID);ref1=doc.children;for(i=j=0,len=ref1.length;j<len;i=++j){child=ref1[i];if(child instanceof XMLDocType){doc.children[i]=doctype;return doctype;}}ref2=doc.children;for(i=k=0,len1=ref2.length;k<len1;i=++k){child=ref2[i];if(child.isRoot){doc.children.splice(i,0,doctype);return doctype;}}doc.children.push(doctype);return doctype;};XMLNode.prototype.up=function(){if(this.isRoot){throw new Error("The root node has no parent. Use doc() if you need to get the document object.");}return this.parent;};XMLNode.prototype.root=function(){var node;node=this;while(node){if(node.isDocument){return node.rootObject;}else if(node.isRoot){return node;}else{node=node.parent;}}};XMLNode.prototype.document=function(){var node;node=this;while(node){if(node.isDocument){return node;}else{node=node.parent;}}};XMLNode.prototype.end=function(options){return this.document().end(options);};XMLNode.prototype.prev=function(){var i;i=this.parent.children.indexOf(this);if(i<1){throw new Error("Already at the first node");}return this.parent.children[i-1];};XMLNode.prototype.next=function(){var i;i=this.parent.children.indexOf(this);if(i===-1||i===this.parent.children.length-1){throw new Error("Already at the last node");}return this.parent.children[i+1];};XMLNode.prototype.importDocument=function(doc){var clonedRoot;clonedRoot=doc.root().clone();clonedRoot.parent=this;clonedRoot.isRoot=false;this.children.push(clonedRoot);return this;};XMLNode.prototype.ele=function(name,attributes,text){return this.element(name,attributes,text);};XMLNode.prototype.nod=function(name,attributes,text){return this.node(name,attributes,text);};XMLNode.prototype.txt=function(value){return this.text(value);};XMLNode.prototype.dat=function(value){return this.cdata(value);};XMLNode.prototype.com=function(value){return this.comment(value);};XMLNode.prototype.ins=function(target,value){return this.instruction(target,value);};XMLNode.prototype.doc=function(){return this.document();};XMLNode.prototype.dec=function(version,encoding,standalone){return this.declaration(version,encoding,standalone);};XMLNode.prototype.dtd=function(pubID,sysID){return this.doctype(pubID,sysID);};XMLNode.prototype.e=function(name,attributes,text){return this.element(name,attributes,text);};XMLNode.prototype.n=function(name,attributes,text){return this.node(name,attributes,text);};XMLNode.prototype.t=function(value){return this.text(value);};XMLNode.prototype.d=function(value){return this.cdata(value);};XMLNode.prototype.c=function(value){return this.comment(value);};XMLNode.prototype.r=function(value){return this.raw(value);};XMLNode.prototype.i=function(target,value){return this.instruction(target,value);};XMLNode.prototype.u=function(){return this.up();};XMLNode.prototype.importXMLBuilder=function(doc){return this.importDocument(doc);};return XMLNode;}();}).call(this);},{"./Utility":215,"./XMLCData":217,"./XMLComment":218,"./XMLDeclaration":223,"./XMLDocType":224,"./XMLElement":227,"./XMLProcessingInstruction":229,"./XMLRaw":230,"./XMLText":234}],229:[function(require,module,exports){(function(){var XMLNode,XMLProcessingInstruction,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLNode=require('./XMLNode');module.exports=XMLProcessingInstruction=function(superClass){extend(XMLProcessingInstruction,superClass);function XMLProcessingInstruction(parent,target,value){XMLProcessingInstruction.__super__.constructor.call(this,parent);if(target==null){throw new Error("Missing instruction target");}this.target=this.stringify.insTarget(target);if(value){this.value=this.stringify.insValue(value);}}XMLProcessingInstruction.prototype.clone=function(){return Object.create(this);};XMLProcessingInstruction.prototype.toString=function(options){return this.options.writer.set(options).processingInstruction(this);};return XMLProcessingInstruction;}(XMLNode);}).call(this);},{"./XMLNode":228}],230:[function(require,module,exports){(function(){var XMLNode,XMLRaw,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLNode=require('./XMLNode');module.exports=XMLRaw=function(superClass){extend(XMLRaw,superClass);function XMLRaw(parent,text){XMLRaw.__super__.constructor.call(this,parent);if(text==null){throw new Error("Missing raw text");}this.value=this.stringify.raw(text);}XMLRaw.prototype.clone=function(){return Object.create(this);};XMLRaw.prototype.toString=function(options){return this.options.writer.set(options).raw(this);};return XMLRaw;}(XMLNode);}).call(this);},{"./XMLNode":228}],231:[function(require,module,exports){(function(){var XMLCData,XMLComment,XMLDTDAttList,XMLDTDElement,XMLDTDEntity,XMLDTDNotation,XMLDeclaration,XMLDocType,XMLElement,XMLProcessingInstruction,XMLRaw,XMLStreamWriter,XMLText,XMLWriterBase,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLDeclaration=require('./XMLDeclaration');XMLDocType=require('./XMLDocType');XMLCData=require('./XMLCData');XMLComment=require('./XMLComment');XMLElement=require('./XMLElement');XMLRaw=require('./XMLRaw');XMLText=require('./XMLText');XMLProcessingInstruction=require('./XMLProcessingInstruction');XMLDTDAttList=require('./XMLDTDAttList');XMLDTDElement=require('./XMLDTDElement');XMLDTDEntity=require('./XMLDTDEntity');XMLDTDNotation=require('./XMLDTDNotation');XMLWriterBase=require('./XMLWriterBase');module.exports=XMLStreamWriter=function(superClass){extend(XMLStreamWriter,superClass);function XMLStreamWriter(stream,options){XMLStreamWriter.__super__.constructor.call(this,options);this.stream=stream;}XMLStreamWriter.prototype.document=function(doc){var child,i,j,len,len1,ref,ref1,results;ref=doc.children;for(i=0,len=ref.length;i<len;i++){child=ref[i];child.isLastRootNode=false;}doc.children[doc.children.length-1].isLastRootNode=true;ref1=doc.children;results=[];for(j=0,len1=ref1.length;j<len1;j++){child=ref1[j];switch(false){case!(child instanceof XMLDeclaration):results.push(this.declaration(child));break;case!(child instanceof XMLDocType):results.push(this.docType(child));break;case!(child instanceof XMLComment):results.push(this.comment(child));break;case!(child instanceof XMLProcessingInstruction):results.push(this.processingInstruction(child));break;default:results.push(this.element(child));}}return results;};XMLStreamWriter.prototype.attribute=function(att){return this.stream.write(' '+att.name+'="'+att.value+'"');};XMLStreamWriter.prototype.cdata=function(node,level){return this.stream.write(this.space(level)+'<![CDATA['+node.text+']]>'+this.endline(node));};XMLStreamWriter.prototype.comment=function(node,level){return this.stream.write(this.space(level)+'<!-- '+node.text+' -->'+this.endline(node));};XMLStreamWriter.prototype.declaration=function(node,level){this.stream.write(this.space(level));this.stream.write('<?xml version="'+node.version+'"');if(node.encoding!=null){this.stream.write(' encoding="'+node.encoding+'"');}if(node.standalone!=null){this.stream.write(' standalone="'+node.standalone+'"');}this.stream.write(this.spacebeforeslash+'?>');return this.stream.write(this.endline(node));};XMLStreamWriter.prototype.docType=function(node,level){var child,i,len,ref;level||(level=0);this.stream.write(this.space(level));this.stream.write('<!DOCTYPE '+node.root().name);if(node.pubID&&node.sysID){this.stream.write(' PUBLIC "'+node.pubID+'" "'+node.sysID+'"');}else if(node.sysID){this.stream.write(' SYSTEM "'+node.sysID+'"');}if(node.children.length>0){this.stream.write(' [');this.stream.write(this.endline(node));ref=node.children;for(i=0,len=ref.length;i<len;i++){child=ref[i];switch(false){case!(child instanceof XMLDTDAttList):this.dtdAttList(child,level+1);break;case!(child instanceof XMLDTDElement):this.dtdElement(child,level+1);break;case!(child instanceof XMLDTDEntity):this.dtdEntity(child,level+1);break;case!(child instanceof XMLDTDNotation):this.dtdNotation(child,level+1);break;case!(child instanceof XMLCData):this.cdata(child,level+1);break;case!(child instanceof XMLComment):this.comment(child,level+1);break;case!(child instanceof XMLProcessingInstruction):this.processingInstruction(child,level+1);break;default:throw new Error("Unknown DTD node type: "+child.constructor.name);}}this.stream.write(']');}this.stream.write(this.spacebeforeslash+'>');return this.stream.write(this.endline(node));};XMLStreamWriter.prototype.element=function(node,level){var att,child,i,len,name,ref,ref1,space;level||(level=0);space=this.space(level);this.stream.write(space+'<'+node.name);ref=node.attributes;for(name in ref){if(!hasProp.call(ref,name))continue;att=ref[name];this.attribute(att);}if(node.children.length===0||node.children.every(function(e){return e.value==='';})){if(this.allowEmpty){this.stream.write('></'+node.name+'>');}else{this.stream.write(this.spacebeforeslash+'/>');}}else if(this.pretty&&node.children.length===1&&node.children[0].value!=null){this.stream.write('>');this.stream.write(node.children[0].value);this.stream.write('</'+node.name+'>');}else{this.stream.write('>'+this.newline);ref1=node.children;for(i=0,len=ref1.length;i<len;i++){child=ref1[i];switch(false){case!(child instanceof XMLCData):this.cdata(child,level+1);break;case!(child instanceof XMLComment):this.comment(child,level+1);break;case!(child instanceof XMLElement):this.element(child,level+1);break;case!(child instanceof XMLRaw):this.raw(child,level+1);break;case!(child instanceof XMLText):this.text(child,level+1);break;case!(child instanceof XMLProcessingInstruction):this.processingInstruction(child,level+1);break;default:throw new Error("Unknown XML node type: "+child.constructor.name);}}this.stream.write(space+'</'+node.name+'>');}return this.stream.write(this.endline(node));};XMLStreamWriter.prototype.processingInstruction=function(node,level){this.stream.write(this.space(level)+'<?'+node.target);if(node.value){this.stream.write(' '+node.value);}return this.stream.write(this.spacebeforeslash+'?>'+this.endline(node));};XMLStreamWriter.prototype.raw=function(node,level){return this.stream.write(this.space(level)+node.value+this.endline(node));};XMLStreamWriter.prototype.text=function(node,level){return this.stream.write(this.space(level)+node.value+this.endline(node));};XMLStreamWriter.prototype.dtdAttList=function(node,level){this.stream.write(this.space(level)+'<!ATTLIST '+node.elementName+' '+node.attributeName+' '+node.attributeType);if(node.defaultValueType!=='#DEFAULT'){this.stream.write(' '+node.defaultValueType);}if(node.defaultValue){this.stream.write(' "'+node.defaultValue+'"');}return this.stream.write(this.spacebeforeslash+'>'+this.endline(node));};XMLStreamWriter.prototype.dtdElement=function(node,level){this.stream.write(this.space(level)+'<!ELEMENT '+node.name+' '+node.value);return this.stream.write(this.spacebeforeslash+'>'+this.endline(node));};XMLStreamWriter.prototype.dtdEntity=function(node,level){this.stream.write(this.space(level)+'<!ENTITY');if(node.pe){this.stream.write(' %');}this.stream.write(' '+node.name);if(node.value){this.stream.write(' "'+node.value+'"');}else{if(node.pubID&&node.sysID){this.stream.write(' PUBLIC "'+node.pubID+'" "'+node.sysID+'"');}else if(node.sysID){this.stream.write(' SYSTEM "'+node.sysID+'"');}if(node.nData){this.stream.write(' NDATA '+node.nData);}}return this.stream.write(this.spacebeforeslash+'>'+this.endline(node));};XMLStreamWriter.prototype.dtdNotation=function(node,level){this.stream.write(this.space(level)+'<!NOTATION '+node.name);if(node.pubID&&node.sysID){this.stream.write(' PUBLIC "'+node.pubID+'" "'+node.sysID+'"');}else if(node.pubID){this.stream.write(' PUBLIC "'+node.pubID+'"');}else if(node.sysID){this.stream.write(' SYSTEM "'+node.sysID+'"');}return this.stream.write(this.spacebeforeslash+'>'+this.endline(node));};XMLStreamWriter.prototype.endline=function(node){if(!node.isLastRootNode){return this.newline;}else{return'';}};return XMLStreamWriter;}(XMLWriterBase);}).call(this);},{"./XMLCData":217,"./XMLComment":218,"./XMLDTDAttList":219,"./XMLDTDElement":220,"./XMLDTDEntity":221,"./XMLDTDNotation":222,"./XMLDeclaration":223,"./XMLDocType":224,"./XMLElement":227,"./XMLProcessingInstruction":229,"./XMLRaw":230,"./XMLText":234,"./XMLWriterBase":235}],232:[function(require,module,exports){(function(){var XMLCData,XMLComment,XMLDTDAttList,XMLDTDElement,XMLDTDEntity,XMLDTDNotation,XMLDeclaration,XMLDocType,XMLElement,XMLProcessingInstruction,XMLRaw,XMLStringWriter,XMLText,XMLWriterBase,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLDeclaration=require('./XMLDeclaration');XMLDocType=require('./XMLDocType');XMLCData=require('./XMLCData');XMLComment=require('./XMLComment');XMLElement=require('./XMLElement');XMLRaw=require('./XMLRaw');XMLText=require('./XMLText');XMLProcessingInstruction=require('./XMLProcessingInstruction');XMLDTDAttList=require('./XMLDTDAttList');XMLDTDElement=require('./XMLDTDElement');XMLDTDEntity=require('./XMLDTDEntity');XMLDTDNotation=require('./XMLDTDNotation');XMLWriterBase=require('./XMLWriterBase');module.exports=XMLStringWriter=function(superClass){extend(XMLStringWriter,superClass);function XMLStringWriter(options){XMLStringWriter.__super__.constructor.call(this,options);}XMLStringWriter.prototype.document=function(doc){var child,i,len,r,ref;this.textispresent=false;r='';ref=doc.children;for(i=0,len=ref.length;i<len;i++){child=ref[i];r+=function(){switch(false){case!(child instanceof XMLDeclaration):return this.declaration(child);case!(child instanceof XMLDocType):return this.docType(child);case!(child instanceof XMLComment):return this.comment(child);case!(child instanceof XMLProcessingInstruction):return this.processingInstruction(child);default:return this.element(child,0);}}.call(this);}if(this.pretty&&r.slice(-this.newline.length)===this.newline){r=r.slice(0,-this.newline.length);}return r;};XMLStringWriter.prototype.attribute=function(att){return' '+att.name+'="'+att.value+'"';};XMLStringWriter.prototype.cdata=function(node,level){return this.space(level)+'<![CDATA['+node.text+']]>'+this.newline;};XMLStringWriter.prototype.comment=function(node,level){return this.space(level)+'<!-- '+node.text+' -->'+this.newline;};XMLStringWriter.prototype.declaration=function(node,level){var r;r=this.space(level);r+='<?xml version="'+node.version+'"';if(node.encoding!=null){r+=' encoding="'+node.encoding+'"';}if(node.standalone!=null){r+=' standalone="'+node.standalone+'"';}r+=this.spacebeforeslash+'?>';r+=this.newline;return r;};XMLStringWriter.prototype.docType=function(node,level){var child,i,len,r,ref;level||(level=0);r=this.space(level);r+='<!DOCTYPE '+node.root().name;if(node.pubID&&node.sysID){r+=' PUBLIC "'+node.pubID+'" "'+node.sysID+'"';}else if(node.sysID){r+=' SYSTEM "'+node.sysID+'"';}if(node.children.length>0){r+=' [';r+=this.newline;ref=node.children;for(i=0,len=ref.length;i<len;i++){child=ref[i];r+=function(){switch(false){case!(child instanceof XMLDTDAttList):return this.dtdAttList(child,level+1);case!(child instanceof XMLDTDElement):return this.dtdElement(child,level+1);case!(child instanceof XMLDTDEntity):return this.dtdEntity(child,level+1);case!(child instanceof XMLDTDNotation):return this.dtdNotation(child,level+1);case!(child instanceof XMLCData):return this.cdata(child,level+1);case!(child instanceof XMLComment):return this.comment(child,level+1);case!(child instanceof XMLProcessingInstruction):return this.processingInstruction(child,level+1);default:throw new Error("Unknown DTD node type: "+child.constructor.name);}}.call(this);}r+=']';}r+=this.spacebeforeslash+'>';r+=this.newline;return r;};XMLStringWriter.prototype.element=function(node,level){var att,child,i,j,len,len1,name,r,ref,ref1,ref2,space,textispresentwasset;level||(level=0);textispresentwasset=false;if(this.textispresent){this.newline='';this.pretty=false;}else{this.newline=this.newlinedefault;this.pretty=this.prettydefault;}space=this.space(level);r='';r+=space+'<'+node.name;ref=node.attributes;for(name in ref){if(!hasProp.call(ref,name))continue;att=ref[name];r+=this.attribute(att);}if(node.children.length===0||node.children.every(function(e){return e.value==='';})){if(this.allowEmpty){r+='></'+node.name+'>'+this.newline;}else{r+=this.spacebeforeslash+'/>'+this.newline;}}else if(this.pretty&&node.children.length===1&&node.children[0].value!=null){r+='>';r+=node.children[0].value;r+='</'+node.name+'>'+this.newline;}else{if(this.dontprettytextnodes){ref1=node.children;for(i=0,len=ref1.length;i<len;i++){child=ref1[i];if(child.value!=null){this.textispresent++;textispresentwasset=true;break;}}}if(this.textispresent){this.newline='';this.pretty=false;space=this.space(level);}r+='>'+this.newline;ref2=node.children;for(j=0,len1=ref2.length;j<len1;j++){child=ref2[j];r+=function(){switch(false){case!(child instanceof XMLCData):return this.cdata(child,level+1);case!(child instanceof XMLComment):return this.comment(child,level+1);case!(child instanceof XMLElement):return this.element(child,level+1);case!(child instanceof XMLRaw):return this.raw(child,level+1);case!(child instanceof XMLText):return this.text(child,level+1);case!(child instanceof XMLProcessingInstruction):return this.processingInstruction(child,level+1);default:throw new Error("Unknown XML node type: "+child.constructor.name);}}.call(this);}if(textispresentwasset){this.textispresent--;}if(!this.textispresent){this.newline=this.newlinedefault;this.pretty=this.prettydefault;}r+=space+'</'+node.name+'>'+this.newline;}return r;};XMLStringWriter.prototype.processingInstruction=function(node,level){var r;r=this.space(level)+'<?'+node.target;if(node.value){r+=' '+node.value;}r+=this.spacebeforeslash+'?>'+this.newline;return r;};XMLStringWriter.prototype.raw=function(node,level){return this.space(level)+node.value+this.newline;};XMLStringWriter.prototype.text=function(node,level){return this.space(level)+node.value+this.newline;};XMLStringWriter.prototype.dtdAttList=function(node,level){var r;r=this.space(level)+'<!ATTLIST '+node.elementName+' '+node.attributeName+' '+node.attributeType;if(node.defaultValueType!=='#DEFAULT'){r+=' '+node.defaultValueType;}if(node.defaultValue){r+=' "'+node.defaultValue+'"';}r+=this.spacebeforeslash+'>'+this.newline;return r;};XMLStringWriter.prototype.dtdElement=function(node,level){return this.space(level)+'<!ELEMENT '+node.name+' '+node.value+this.spacebeforeslash+'>'+this.newline;};XMLStringWriter.prototype.dtdEntity=function(node,level){var r;r=this.space(level)+'<!ENTITY';if(node.pe){r+=' %';}r+=' '+node.name;if(node.value){r+=' "'+node.value+'"';}else{if(node.pubID&&node.sysID){r+=' PUBLIC "'+node.pubID+'" "'+node.sysID+'"';}else if(node.sysID){r+=' SYSTEM "'+node.sysID+'"';}if(node.nData){r+=' NDATA '+node.nData;}}r+=this.spacebeforeslash+'>'+this.newline;return r;};XMLStringWriter.prototype.dtdNotation=function(node,level){var r;r=this.space(level)+'<!NOTATION '+node.name;if(node.pubID&&node.sysID){r+=' PUBLIC "'+node.pubID+'" "'+node.sysID+'"';}else if(node.pubID){r+=' PUBLIC "'+node.pubID+'"';}else if(node.sysID){r+=' SYSTEM "'+node.sysID+'"';}r+=this.spacebeforeslash+'>'+this.newline;return r;};XMLStringWriter.prototype.openNode=function(node,level){var att,name,r,ref;level||(level=0);if(node instanceof XMLElement){r=this.space(level)+'<'+node.name;ref=node.attributes;for(name in ref){if(!hasProp.call(ref,name))continue;att=ref[name];r+=this.attribute(att);}r+=(node.children?'>':'/>')+this.newline;return r;}else{r=this.space(level)+'<!DOCTYPE '+node.rootNodeName;if(node.pubID&&node.sysID){r+=' PUBLIC "'+node.pubID+'" "'+node.sysID+'"';}else if(node.sysID){r+=' SYSTEM "'+node.sysID+'"';}r+=(node.children?' [':'>')+this.newline;return r;}};XMLStringWriter.prototype.closeNode=function(node,level){level||(level=0);switch(false){case!(node instanceof XMLElement):return this.space(level)+'</'+node.name+'>'+this.newline;case!(node instanceof XMLDocType):return this.space(level)+']>'+this.newline;}};return XMLStringWriter;}(XMLWriterBase);}).call(this);},{"./XMLCData":217,"./XMLComment":218,"./XMLDTDAttList":219,"./XMLDTDElement":220,"./XMLDTDEntity":221,"./XMLDTDNotation":222,"./XMLDeclaration":223,"./XMLDocType":224,"./XMLElement":227,"./XMLProcessingInstruction":229,"./XMLRaw":230,"./XMLText":234,"./XMLWriterBase":235}],233:[function(require,module,exports){(function(){var XMLStringifier,bind=function bind(fn,me){return function(){return fn.apply(me,arguments);};},hasProp={}.hasOwnProperty;module.exports=XMLStringifier=function(){function XMLStringifier(options){this.assertLegalChar=bind(this.assertLegalChar,this);var key,ref,value;options||(options={});this.noDoubleEncoding=options.noDoubleEncoding;ref=options.stringify||{};for(key in ref){if(!hasProp.call(ref,key))continue;value=ref[key];this[key]=value;}}XMLStringifier.prototype.eleName=function(val){val=''+val||'';return this.assertLegalChar(val);};XMLStringifier.prototype.eleText=function(val){val=''+val||'';return this.assertLegalChar(this.elEscape(val));};XMLStringifier.prototype.cdata=function(val){val=''+val||'';val=val.replace(']]>',']]]]><![CDATA[>');return this.assertLegalChar(val);};XMLStringifier.prototype.comment=function(val){val=''+val||'';if(val.match(/--/)){throw new Error("Comment text cannot contain double-hypen: "+val);}return this.assertLegalChar(val);};XMLStringifier.prototype.raw=function(val){return''+val||'';};XMLStringifier.prototype.attName=function(val){return val=''+val||'';};XMLStringifier.prototype.attValue=function(val){val=''+val||'';return this.attEscape(val);};XMLStringifier.prototype.insTarget=function(val){return''+val||'';};XMLStringifier.prototype.insValue=function(val){val=''+val||'';if(val.match(/\?>/)){throw new Error("Invalid processing instruction value: "+val);}return val;};XMLStringifier.prototype.xmlVersion=function(val){val=''+val||'';if(!val.match(/1\.[0-9]+/)){throw new Error("Invalid version number: "+val);}return val;};XMLStringifier.prototype.xmlEncoding=function(val){val=''+val||'';if(!val.match(/^[A-Za-z](?:[A-Za-z0-9._-])*$/)){throw new Error("Invalid encoding: "+val);}return val;};XMLStringifier.prototype.xmlStandalone=function(val){if(val){return"yes";}else{return"no";}};XMLStringifier.prototype.dtdPubID=function(val){return''+val||'';};XMLStringifier.prototype.dtdSysID=function(val){return''+val||'';};XMLStringifier.prototype.dtdElementValue=function(val){return''+val||'';};XMLStringifier.prototype.dtdAttType=function(val){return''+val||'';};XMLStringifier.prototype.dtdAttDefault=function(val){if(val!=null){return''+val||'';}else{return val;}};XMLStringifier.prototype.dtdEntityValue=function(val){return''+val||'';};XMLStringifier.prototype.dtdNData=function(val){return''+val||'';};XMLStringifier.prototype.convertAttKey='@';XMLStringifier.prototype.convertPIKey='?';XMLStringifier.prototype.convertTextKey='#text';XMLStringifier.prototype.convertCDataKey='#cdata';XMLStringifier.prototype.convertCommentKey='#comment';XMLStringifier.prototype.convertRawKey='#raw';XMLStringifier.prototype.assertLegalChar=function(str){var res;res=str.match(/[\0\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/);if(res){throw new Error("Invalid character in string: "+str+" at index "+res.index);}return str;};XMLStringifier.prototype.elEscape=function(str){var ampregex;ampregex=this.noDoubleEncoding?/(?!&\S+;)&/g:/&/g;return str.replace(ampregex,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\r/g,'&#xD;');};XMLStringifier.prototype.attEscape=function(str){var ampregex;ampregex=this.noDoubleEncoding?/(?!&\S+;)&/g:/&/g;return str.replace(ampregex,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/\t/g,'&#x9;').replace(/\n/g,'&#xA;').replace(/\r/g,'&#xD;');};return XMLStringifier;}();}).call(this);},{}],234:[function(require,module,exports){(function(){var XMLNode,XMLText,extend=function extend(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;XMLNode=require('./XMLNode');module.exports=XMLText=function(superClass){extend(XMLText,superClass);function XMLText(parent,text){XMLText.__super__.constructor.call(this,parent);if(text==null){throw new Error("Missing element text");}this.value=this.stringify.eleText(text);}XMLText.prototype.clone=function(){return Object.create(this);};XMLText.prototype.toString=function(options){return this.options.writer.set(options).text(this);};return XMLText;}(XMLNode);}).call(this);},{"./XMLNode":228}],235:[function(require,module,exports){(function(){var XMLWriterBase,hasProp={}.hasOwnProperty;module.exports=XMLWriterBase=function(){function XMLWriterBase(options){var key,ref,ref1,ref2,ref3,ref4,ref5,ref6,value;options||(options={});this.pretty=options.pretty||false;this.allowEmpty=(ref=options.allowEmpty)!=null?ref:false;if(this.pretty){this.indent=(ref1=options.indent)!=null?ref1:'  ';this.newline=(ref2=options.newline)!=null?ref2:'\n';this.offset=(ref3=options.offset)!=null?ref3:0;this.dontprettytextnodes=(ref4=options.dontprettytextnodes)!=null?ref4:0;}else{this.indent='';this.newline='';this.offset=0;this.dontprettytextnodes=0;}this.spacebeforeslash=(ref5=options.spacebeforeslash)!=null?ref5:'';if(this.spacebeforeslash===true){this.spacebeforeslash=' ';}this.newlinedefault=this.newline;this.prettydefault=this.pretty;ref6=options.writer||{};for(key in ref6){if(!hasProp.call(ref6,key))continue;value=ref6[key];this[key]=value;}}XMLWriterBase.prototype.set=function(options){var key,ref,value;options||(options={});if("pretty"in options){this.pretty=options.pretty;}if("allowEmpty"in options){this.allowEmpty=options.allowEmpty;}if(this.pretty){this.indent="indent"in options?options.indent:'  ';this.newline="newline"in options?options.newline:'\n';this.offset="offset"in options?options.offset:0;this.dontprettytextnodes="dontprettytextnodes"in options?options.dontprettytextnodes:0;}else{this.indent='';this.newline='';this.offset=0;this.dontprettytextnodes=0;}this.spacebeforeslash="spacebeforeslash"in options?options.spacebeforeslash:'';if(this.spacebeforeslash===true){this.spacebeforeslash=' ';}this.newlinedefault=this.newline;this.prettydefault=this.pretty;ref=options.writer||{};for(key in ref){if(!hasProp.call(ref,key))continue;value=ref[key];this[key]=value;}return this;};XMLWriterBase.prototype.space=function(level){var indent;if(this.pretty){indent=(level||0)+this.offset+1;if(indent>0){return new Array(indent).join(this.indent);}else{return'';}}else{return'';}};return XMLWriterBase;}();}).call(this);},{}],236:[function(require,module,exports){(function(){var XMLDocument,XMLDocumentCB,XMLStreamWriter,XMLStringWriter,assign,isFunction,ref;ref=require('./Utility'),assign=ref.assign,isFunction=ref.isFunction;XMLDocument=require('./XMLDocument');XMLDocumentCB=require('./XMLDocumentCB');XMLStringWriter=require('./XMLStringWriter');XMLStreamWriter=require('./XMLStreamWriter');module.exports.create=function(name,xmldec,doctype,options){var doc,root;if(name==null){throw new Error("Root element needs a name");}options=assign({},xmldec,doctype,options);doc=new XMLDocument(options);root=doc.element(name);if(!options.headless){doc.declaration(options);if(options.pubID!=null||options.sysID!=null){doc.doctype(options);}}return root;};module.exports.begin=function(options,onData,onEnd){var ref1;if(isFunction(options)){ref1=[options,onData],onData=ref1[0],onEnd=ref1[1];options={};}if(onData){return new XMLDocumentCB(options,onData,onEnd);}else{return new XMLDocument(options);}};module.exports.stringWriter=function(options){return new XMLStringWriter(options);};module.exports.streamWriter=function(stream,options){return new XMLStreamWriter(stream,options);};}).call(this);},{"./Utility":215,"./XMLDocument":225,"./XMLDocumentCB":226,"./XMLStreamWriter":231,"./XMLStringWriter":232}]},{},[42]);